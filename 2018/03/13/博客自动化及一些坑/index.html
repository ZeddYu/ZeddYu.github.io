<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="迁了一下服务器，顺便弄了一下Git hook，把两个仓库给实现本地修改触发git hook实现服务器自动部署。 什么是git hooks 在git上是这么介绍"><title>博客自动化及一些坑</title>
<link rel=canonical href=https://blog.zeddyu.info/2018/03/13/%E5%8D%9A%E5%AE%A2%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%8A%E4%B8%80%E4%BA%9B%E5%9D%91/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="博客自动化及一些坑">
<meta property="og:description" content="迁了一下服务器，顺便弄了一下Git hook，把两个仓库给实现本地修改触发git hook实现服务器自动部署。 什么是git hooks 在git上是这么介绍">
<meta property="og:url" content="https://blog.zeddyu.info/2018/03/13/%E5%8D%9A%E5%AE%A2%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%8A%E4%B8%80%E4%BA%9B%E5%9D%91/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="Dev"><meta property="article:published_time" content="2018-03-13T09:29:00+00:00"><meta property="article:modified_time" content="2018-03-13T09:29:00+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="博客自动化及一些坑">
<meta name=twitter:description content="迁了一下服务器，顺便弄了一下Git hook，把两个仓库给实现本地修改触发git hook实现服务器自动部署。 什么是git hooks 在git上是这么介绍">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/Dev/ style=background-color:#06c;color:#fff>
Dev
</a>
</header>
<h2 class=article-title>
<a href=/2018/03/13/%E5%8D%9A%E5%AE%A2%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%8A%E4%B8%80%E4%BA%9B%E5%9D%91/>博客自动化及一些坑</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 13, 2018</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
4 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>迁了一下服务器，顺便弄了一下Git hook，把两个仓库给实现本地修改触发git hook实现服务器自动部署。</p>
<h2 id=什么是git-hooks>什么是git hooks</h2>
<p>在git上是这么介绍的：</p>
<blockquote>
<p>和其它版本控制系统一样，Git能在特定的重要动作发生时触发自定义脚本。有两组这样的钩子：客户端的和服务器端的。客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。 你可以随心所欲地运用这些钩子。</p>
</blockquote>
<p>个人理解的git hook其实就像一个触发器吧，当远程服务器收到本地的命令之后就执行某些操作。</p>
<p><figure>
<a href=/Users/zedd/Desktop/demo/BlogMd/img/AutoDeploy/githook.png>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//Users/zedd/Desktop/demo/BlogMd/img/AutoDeploy/githook.png loading=lazy>
</a>
</figure></p>
<h2 id=git-hooks的种类>git hooks的种类</h2>
<p>git中，有两种类型的钩子：客户端的和服务器端的。</p>
<p>客户端的钩子有：</p>
<ol>
<li><code>pre-commit</code> 钩子在键入提交信息前运行。</li>
<li><code>prepare-commit-msg</code> 钩子在启动提交信息编辑器之前，默认信息被创建之后运行。</li>
<li><code>post-commit</code> 钩子在整个提交过程完成后运行。</li>
<li><code>applypatch-msg</code> 你可以用该脚本来确保提交信息符合格式，或直接用脚本修正格式错误。</li>
<li><code>pre-applypatch</code> 在 <code>git am</code> 运行期间被调用</li>
<li><code>post-applypatch</code> 运行于提交产生之后，是在 <code>git am</code> 运行期间最后被调用的钩子。</li>
<li><code>pre-rebase</code> 钩子运行于变基之前，以非零值退出可以中止变基的过程。</li>
<li><code>post-rewrite</code> 钩子被那些会替换提交记录的命令调用。</li>
<li><code>post-checkout</code> 在 <code>git checkout</code> 成功运行后调用。</li>
<li><code>post-merge</code> 在 <code>git merge</code> 成功运行后调用。</li>
<li><code>pre-push</code> 在 <code>git push</code> 运行期间， 更新了远程引用但尚未传送对象时被调用。</li>
<li><code>pre-auto-gc</code> 会在垃圾回收开始之前被调用，可以用它来提醒你现在要回收垃圾了，或者依情形判断是否要中断回收。</li>
</ol>
<p>服务器端的钩子有：</p>
<ol>
<li><code>pre-receive</code> 处理来自客户端的推送操作时最先被调用。</li>
<li><code>update</code> 它会为每一个准备更新的分支各运行一次。</li>
<li><code>post-receive</code> 在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。</li>
</ol>
<h2 id=如何使用git-hooks>如何使用git hooks</h2>
<p>所有的钩子脚本都存放在 .git/hooks 文件夹中。当使用 <code>git init</code> 初始化一个新版本库时，Git 默认会在这个目录中放置一些示例脚本。这些示例的名字都是以 .sample 结尾，如果你想启用它们，得先移除这个后缀。</p>
<h2 id=简单的自动部署>简单的自动部署</h2>
<p>既然要在服务器上进行操作，肯定得登录服务器了咯。</p>
<h3 id=服务器登录>服务器登录</h3>
<p>要实现ssh免密码登录，大家也可以具体参考一下<a class=link href=https://my.oschina.net/aiguozhe/blog/33994 target=_blank rel=noopener>这篇文章</a></p>
<blockquote>
<p>A为本地主机(即用于控制其他主机的机器) ;
B为远程主机(即被控制的机器Server), 假如ip为172.24.253.2 ;
A和B的系统都是Linux</p>
<p>在A上的命令:</p>
<p>$ ssh-keygen -t rsa (连续三次回车,即在本地生成了公钥和私钥,不设置密码)</p>
<p>$ ssh <a class=link href=mailto:root@172.24.253.2>root@172.24.253.2</a> &ldquo;mkdir .ssh;chmod 0700 .ssh&rdquo; (需要输入密码， 注:必须将.ssh的权限设为700)</p>
<p>$ scp ~/.ssh/id_rsa.pub <a class=link href=mailto:root@172.24.253.2>root@172.24.253.2</a>:.ssh/id_rsa.pub (需要输入密码)</p>
<p>在B上的命令:
$ touch /root/.ssh/authorized_keys (如果已经存在这个文件, 跳过这条)</p>
<p>$ chmod 600 ~/.ssh/authorized_keys (# 注意： 必须将~/.ssh/authorized_keys的权限改为600, 该文件用于保存ssh客户端生成的公钥，可以修改服务器的ssh服务端配置文件/etc/ssh/sshd_config来指定其他文件名）</p>
<p>$ cat /root/.ssh/id_rsa.pub &#187; /root/.ssh/authorized_keys (将id_rsa.pub的内容追加到 authorized_keys 中, 注意不要用 > ，否则会清空原有的内容，使其他人无法使用原有的密钥登录)</p>
<p>回到A机器:</p>
<p>$ ssh <a class=link href=mailto:root@172.24.253.2>root@172.24.253.2</a> (不需要密码, 登录成功)</p>
</blockquote>
<p>这样就轻松实现了ssh免密登录</p>
<h3 id=初始化>初始化</h3>
<h4 id=git-init-和-git-init---bare-的区别>git init 和 git init &ndash;bare 的区别</h4>
<p>初始化出来的仓库是不一样的，前者初始化的是一个普通的仓库，其中 .git 文件夹是隐藏的，并且能看见该仓库下所有的源码。而后者初始化出来的仓库中的文件，就是 .git 中的文件夹，但不能像前者那样直接浏览或修改仓库中的代码。</p>
<p></p>
<h4 id=使用-git-init---bare-初始化一个远程仓库>使用 <code>git init --bare</code> 初始化一个远程仓库</h4>
<p>该仓库是用于项目部署的。在我们本地开发完成后，将项目push至该仓库后，将自动部署网站。</p>
<p>这里就拿nginx来举个例子，按照nginx默认目录来进行操作
建立一个xxx-bare.git（bare repository）和一个xxx（repository）目录，Git远程库的命名一般使用.git和其他目录区分，但并非强制。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$   <span class=nb>cd</span> /usr/share/nginx/html
$   git init --bare xxx-bare.git
$   <span class=nb>cd</span> /usr/share/nginx/html
$   git clone xxx-bare.git xxx
</code></pre></div><h3 id=配置git-hook>配置Git Hook</h3>
<p>将目录切换至 <code>/usr/share/nginx/html/xxx-bare.git/hooks</code>，如果目录下没有<code>post-receive</code>这个文件，可以使用<code>touch post-receive</code>直接创建，当仓库收到push请求后，就会自动执行该钩子中的脚本。根据自身需求编辑脚本内容：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=nb>unset</span> GIT_DIR
<span class=nb>cd</span> /var/www/html/project
git pull origin master
</code></pre></div><p>编辑完成后，给该脚本添加可执行权限</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$   chmod +x post-receive
</code></pre></div><h3 id=测试及使用>测试及使用</h3>
<h4 id=为开发的本地仓库添加remote源>为开发的本地仓库添加remote源</h4>
<p>这个客户端本地仓库，即开发的机子的本地仓库，添加remote源，以后往这个remote push代码时，就会自动触发上面的脚本。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$   git remote add deploy user@ip:/gitrepo_dir
$   git push deploy master
</code></pre></div><p><code>gitrepo_dir</code>就是服务器上的xxx-bare.git的文件夹位置</p>
<p>以后就可以通过<code>git push deploy master</code>来自动更新服务器上的代码咯。</p>
<h4 id=最后再写一个typecho的小坑>最后再写一个typecho的小坑</h4>
<p>博客上传图片失败的问题，要把typecho里的usr文件权限修改为777，就可以了。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$   sudo chmod -R <span class=m>777</span> usr
</code></pre></div><p>然后可以上传本地图片了。</p>
<h2 id=happy-coding>Happy Coding!</h2>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/Dev/>Dev</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2019/02/27/Hexo-issue/>
<div class=article-details>
<h2 class=article-title>Hexo Template render error 解决方案</h2>
</div>
</a>
</article>
<article>
<a href=/2019/02/25/Flutter-424%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/>
<div class=article-details>
<h2 class=article-title>Flutter packages get 424问题解决方法</h2>
</div>
</a>
</article>
<article>
<a href=/2018/08/26/Mac-idea-%E5%90%AF%E5%8A%A8tomcat%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8%E5%A5%87%E5%BC%82%E9%97%AE%E9%A2%98/>
<div class=article-details>
<h2 class=article-title>Mac idea 启动tomcat端口占用奇异问题</h2>
</div>
</a>
</article>
<article>
<a href=/2018/03/04/MacOS-X-%E4%B8%8B%E9%85%8D%E7%BD%AENginx-amp-PHP/>
<div class=article-details>
<h2 class=article-title>MacOS X 下配置Nginx &amp;amp; PHP</h2>
</div>
</a>
</article>
<article>
<a href=/2018/03/03/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%9F%BA%E4%BA%8ELNMP/>
<div class=article-details>
<h2 class=article-title>服务器配置的那些事--基于LNMP</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2021 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#什么是git-hooks>什么是git hooks</a></li>
<li><a href=#git-hooks的种类>git hooks的种类</a></li>
<li><a href=#如何使用git-hooks>如何使用git hooks</a></li>
<li><a href=#简单的自动部署>简单的自动部署</a>
<ol>
<li><a href=#服务器登录>服务器登录</a></li>
<li><a href=#初始化>初始化</a>
<ol>
<li><a href=#git-init-和-git-init---bare-的区别>git init 和 git init &ndash;bare 的区别</a></li>
<li><a href=#使用-git-init---bare-初始化一个远程仓库>使用 <code>git init --bare</code> 初始化一个远程仓库</a></li>
</ol>
</li>
<li><a href=#配置git-hook>配置Git Hook</a></li>
<li><a href=#测试及使用>测试及使用</a>
<ol>
<li><a href=#为开发的本地仓库添加remote源>为开发的本地仓库添加remote源</a></li>
<li><a href=#最后再写一个typecho的小坑>最后再写一个typecho的小坑</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#happy-coding>Happy Coding!</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>