<!DOCTYPE html><html class="has-navbar-fixed-top" lang="zh-cmn-Hans"><head><meta charset="utf-8"><title>Web安全从零开始 XSS IV - Zedd&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="ZeddYu's Blog"><meta name="description" content="这是自己写的 Web 安全从零开始系列之 XSS 篇。第四篇讲 XSS 防御。"><meta property="og:type" content="article"><meta property="og:title" content="Web安全从零开始 XSS IV"><meta property="og:url" content="https://blog.zeddyu.info/2019/03/14/Web%E5%AE%89%E5%85%A8%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B-XSS-IV/index.html"><meta property="og:site_name" content="Zedd&#39;s Blog"><meta property="og:description" content="这是自己写的 Web 安全从零开始系列之 XSS 篇。第四篇讲 XSS 防御。"><meta property="og:locale" content="en_US"><meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg=="><meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg=="><meta property="article:published_time" content="2019-03-14T15:11:58.000Z"><meta property="article:modified_time" content="2021-09-27T17:45:58.720Z"><meta property="article:author" content="Zedd"><meta property="article:tag" content="Sec"><meta property="article:tag" content="xss"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg=="><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.8.1/css/bulma.min.css"><script defer="defer" src="https://at.alicdn.com/t/font_1780077_0ad2sbnz4nz.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga_tid="UA-112937997-1",window.ga_api="https://blog.zeddyu.info/ga_api/*"</script><script src="https://cdn.jsdelivr.net/npm/cfga@1.0.3" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Zedd's Blog" type="application/atom+xml"></head><body><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><div class="navbar-item navbar-logo"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://s.gravatar.com/avatar/204a0c779acdb62f9084826396f6dccb?s=80" alt="" height="28"></div><div class="navbar-burger"><span></span><span></span><span></span></div></div><div class="navbar-menu navbar-start"> <a class="navbar-item" href="/">Index</a> <a class="navbar-item" href="/archives">Archives</a> <a class="navbar-item" href="/categories">Categories</a> <a class="navbar-item" href="/tags">Tags</a> <a class="navbar-item" href="/friends">Friends</a> <a class="navbar-item" href="/about">About</a> <a class="navbar-item" href="/advertisement">Ads</a></div><div class="navbar-menu navbar-end"> <a class="navbar-item search" title="Search" href="javascript:;"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></a><div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc"> <a class="navbar-item" title="Table of Contents"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-list"></use></svg></a><div class="navbar-dropdown is-right"> <a class="navbar-item" href="#Defend">1&nbsp;&nbsp;<b>Defend</b></a> <a class="navbar-item" href="#Seven-Principles">1.1&nbsp;&nbsp;Seven Principles</a> <a class="navbar-item" href="#原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码">1.1.1&nbsp;&nbsp;原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码</a> <a class="navbar-item" href="#原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML-Entity编码">1.1.2&nbsp;&nbsp;原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML Entity编码</a> <a class="navbar-item" href="#原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码">1.1.3&nbsp;&nbsp;原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码</a> <a class="navbar-item" href="#原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码">1.1.4&nbsp;&nbsp;原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码</a> <a class="navbar-item" href="#原则6：在将不可信数据插入到HTML-URL里时，对这些数据进行URL编码">1.1.5&nbsp;&nbsp;原则6：在将不可信数据插入到HTML URL里时，对这些数据进行URL编码</a> <a class="navbar-item" href="#原则7：使用富文本时，使用XSS规则引擎进行编码过滤">1.1.6&nbsp;&nbsp;原则7：使用富文本时，使用XSS规则引擎进行编码过滤</a> <a class="navbar-item" href="#Summary">1.1.7&nbsp;&nbsp;Summary</a> <a class="navbar-item" href="#Escape">1.2&nbsp;&nbsp;Escape</a> <a class="navbar-item" href="#htmlspecialchars-php">1.2.1&nbsp;&nbsp;htmlspecialchars - php</a> <a class="navbar-item" href="#htmlentities-php">1.2.2&nbsp;&nbsp;htmlentities - php</a> <a class="navbar-item" href="#Front-end">1.2.3&nbsp;&nbsp;Front end</a> <a class="navbar-item" href="#HTTP-Header">1.3&nbsp;&nbsp;HTTP Header</a> <a class="navbar-item" href="#X-XSS-Protection">1.3.1&nbsp;&nbsp;X-XSS-Protection</a> <a class="navbar-item" href="#Content-Security-Policy">1.3.2&nbsp;&nbsp;Content Security Policy</a> <a class="navbar-item" href="#X-Frame-Options">1.3.3&nbsp;&nbsp;X-Frame-Options</a> <a class="navbar-item" href="#HttpOnly">1.3.4&nbsp;&nbsp;HttpOnly</a> <a class="navbar-item" href="#X-Content-Type-Options">1.3.5&nbsp;&nbsp;X-Content-Type-Options</a><hr class="navbar-divider"> <a class="navbar-item" href="#Reference">2&nbsp;&nbsp;<b>Reference</b></a></div></div> <a class="navbar-item" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a> <a class="navbar-item" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-twitter"></use></svg></a> <a class="navbar-item" title="RSS" href="https://blog.zeddyu.info/atom.xml"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name"> Web安全从零开始 XSS IV</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"> <span class="column is-narrow"><span>Mar 14 2019</span> <span class="second-date-block">(<time datetime="2019-03-14T15:11:58.000Z" itemprop="datePublished">Mar 14 2019</time>)</span></span> <span class="column is-narrow article-category"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-folder"></use></svg><a class="article-category-link" href="/categories/Sec/">Sec</a></span> <span class="column is-narrow"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-shalou"></use></svg> <span class="article-category-link">34 minutes read (About 5130 words)</span></span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Defend"><span class="post-toc-number">1.</span> <span class="post-toc-text">Defend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Seven-Principles"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Seven Principles</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML-Entity编码"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML Entity编码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则6：在将不可信数据插入到HTML-URL里时，对这些数据进行URL编码"><span class="post-toc-number">1.1.5.</span> <span class="post-toc-text">原则6：在将不可信数据插入到HTML URL里时，对这些数据进行URL编码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#原则7：使用富文本时，使用XSS规则引擎进行编码过滤"><span class="post-toc-number">1.1.6.</span> <span class="post-toc-text">原则7：使用富文本时，使用XSS规则引擎进行编码过滤</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Summary"><span class="post-toc-number">1.1.7.</span> <span class="post-toc-text">Summary</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Escape"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Escape</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#htmlspecialchars-php"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">htmlspecialchars - php</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#htmlentities-php"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">htmlentities - php</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Front-end"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">Front end</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#HTTP-Header"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">HTTP Header</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#X-XSS-Protection"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">X-XSS-Protection</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Content-Security-Policy"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">Content Security Policy</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#X-Frame-Options"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">X-Frame-Options</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#HttpOnly"><span class="post-toc-number">1.3.4.</span> <span class="post-toc-text">HttpOnly</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#X-Content-Type-Options"><span class="post-toc-number">1.3.5.</span> <span class="post-toc-text">X-Content-Type-Options</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Reference"><span class="post-toc-number">2.</span> <span class="post-toc-text">Reference</span></a></li></ol><html><head></head><body><p>这是自己写的 Web 安全从零开始系列之 XSS 篇。第四篇讲 XSS 防御。</p><a id="more"></a><p>[TOC]</p><h2 id="Defend"><a href="#Defend" class="headerlink" title="Defend"></a>Defend</h2><p>无论是服务端型还是客户端型xss，攻击达成都需要两个条件</p><ul><li>代码被注入</li><li>代码被执行</li></ul><p>其实只要做好无论任何情况下保证代码不被执行就能完全杜绝 xss 攻击.</p><p>总之, 任何时候都不要把不受信任的数据直接插入到 dom 中的任何位置, 一定要做转义。</p><p><strong>对于某些位置,不受信任的数据做转义就可以保证安全</strong></p><ul><li>一般的标签属性值(非事件属性)</li><li>div body 的内部html</li></ul><p><strong>对于某些位置，即使做了转义依然不安全</strong></p><ul><li>script标签中</li><li>注释中</li><li>表签的属性名名</li><li>标签名</li><li>css标签中</li></ul><p>使用 JSON.parse 而不是eval, request 的content-type要指定是Content-Type: application/json;</p><p>如果链接的URL中部分是动态生成的，一定要做转义。</p><h3 id="Seven-Principles"><a href="#Seven-Principles" class="headerlink" title="Seven Principles"></a>Seven Principles</h3><h4 id="原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码"><a href="#原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码" class="headerlink" title="原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码"></a>原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码</h4><p>第一条原则其实是“Secure By Default”原则：不要往HTML页面中插入任何不可信数据，除非这些数据已经根据下面几条原则进行了编码。</p><p>之所以有这样一条原则存在，是因为 HTML 里有太多的地方容易形成XSS漏洞，而且形成漏洞的原因又有差别，比如有些漏洞发生在HTML标签里，有些发生在HTML标签的属性里，还有的发生在页面的<code>&lt;Script&gt;</code>里，甚至有些还出现在CSS里，再加上不同的浏览器对页面的解析或多或少有些不同，使得有些漏洞只在特定浏览器里才会产生。如果想要通过XSS过滤器（XSS Filter）对不可信数据进行转义或替换，那么XSS过滤器的过滤规则将会变得异常复杂，难以维护而且会有被绕过的风险。</p><p>所以实在想不出有什么理由要直接往HTML页面里插入不可信数据，就算是有XSS过滤器帮你做过滤，产生XSS漏洞的风险还是很高</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>…不要在这里直接插入不可信数据…<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>直接插入到SCRIPT标签里 </span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">!–</span> …不要在这里直接插入不可信数据… –&gt;</span></span><br><span class="line">插入到HTML注释里</span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> 不要在这里直接插入不可信数据=<span class="hljs-string">”…”</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">插入到HTML标签的属性名里</span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">name</span>=<span class="hljs-string">”…不要在这里直接插入不可信数据…”</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">插入到HTML标签的属性值里</span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">不要在这里直接插入不可信数据</span> <span class="hljs-attr">href</span>=<span class="hljs-string">”…”</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">作为HTML标签的名字</span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>…不要在这里直接插入不可信数据…<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line">直接插入到CSS里</span><br></pre></td></tr></tbody></table></figure><p></p><p>最重要的是，千万不要引入任何不可信的第三方 JavaScript 到页面里，一旦引入了，这些脚本就能够操纵你的HTML页面，窃取敏感信息或者发起钓鱼攻击等等。</p><h4 id="原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML-Entity编码"><a href="#原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML-Entity编码" class="headerlink" title="原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML Entity编码"></a>原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML Entity编码</h4><p>在这里相当强调是往HTML标签之间插入不可信数据，以区别于往HTML标签属性部分插入不可信数据，因为这两者需要进行不同类型的编码。当你确实需要往HTML标签之间插入不可信数据的时候，首先要做的就是对不可信数据进行HTML Entity编码。比如，我们经常需要往DIV，P，TD这些标签里放入一些用户提交的数据，这些数据是不可信的，需要对它们进行HTML Entity编码。很多Web框架都提供了HTML Entity编码的函数，我们只需要调用这些函数就好，而有些Web框架似乎更“智能”，比如Rails，它能在默认情况下对所有插入到HTML页面的数据进行HTML Entity编码，尽管不能完全防御XSS，但着实减轻了开发人员的负担。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>…插入不可信数据前，对其进行HTML Entity编码…<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>…插入不可信数据前，对其进行HTML Entity编码…<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>…插入不可信数据前，对其进行HTML Entity编码…<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">以此类推，往其他HTML标签之间插入不可信数据前，对其进行HTML Entity编码</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>[编码规则]</strong><br>那么HTML Entity编码具体应该做哪些事情呢？它需要对下面这6个特殊字符进行编码：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;     –&gt;     <span class="hljs-symbol">&amp;amp;</span></span><br><span class="line"><span class="hljs-tag">&lt;     –&gt;</span>     <span class="hljs-symbol">&amp;lt;</span></span><br><span class="line">&gt;     –&gt;     <span class="hljs-symbol">&amp;gt;</span></span><br><span class="line">”     –&gt;     <span class="hljs-symbol">&amp;quot;</span></span><br><span class="line">‘     –&gt;     <span class="hljs-symbol">&amp;#x27;</span></span><br><span class="line">/     –&gt;     <span class="hljs-symbol">&amp;#x2f;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>有两点需要特别说明的是:</p><ul><li>不推荐将单引号( ‘ )编码为 ' 因为它并不是标准的HTML标签</li><li>需要对斜杠号( / )编码，因为在进行XSS攻击时，斜杠号对于关闭当前HTML标签非常有用</li></ul><p>推荐使用OWASP提供的<a href="https://www.owasp.org/index.php/ESAPI" target="_blank" rel="noopener">ESAPI</a>函数库，它提供了一系列非常严格的用于进行各种安全编码的函数。在当前这个例子里，你可以使用:</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String encodedContent = ESAPI.encoder().encodeForHTML(request.getParameter(“input”));</span><br></pre></td></tr></tbody></table></figure><p></p><p>这条原则是指，当你要往HTML属性（例如width、name、value属性）的值部分(data value)插入不可信数据的时候，应该对数据进行HTML属性编码。不过需要注意的是，当要往HTML标签的事件处理属性（例如onmouseover）里插入数据的时候，本条原则不适用，应该用下面介绍的原则4对其进行JavaScript编码。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">attr</span>=<span class="hljs-string">…插入不可信数据前，进行HTML属性编码…</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>属性值部分没有使用引号，不推荐 </span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">attr</span>=<span class="hljs-string">’…插入不可信数据前，进行HTML属性编码…’</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">属性值部分使用了单引号</span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">attr</span>=<span class="hljs-string">”…插入不可信数据前，进行HTML属性编码…”</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">属性值部分使用了双引号</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>[编码规则]</strong></p><p>除了空格符可以闭合当前属性外，这些符号也可以：</p><p>% * + , – / ; &lt; = &gt; ^ | `(反单引号，IE会认为它是单引号)</p><p>可以使用ESAPI提供的函数进行HTML属性编码：</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String encodedContent = ESAPI.encoder().encodeForHTMLAttribute(request.getParameter(“input”));</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码"><a href="#原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码" class="headerlink" title="原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码"></a>原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码</h4><p>这条原则主要针对动态生成的JavaScript代码，这包括脚本部分以及HTML标签的事件处理属性（Event Handler，如onmouseover, onload等）。在往JavaScript代码里插入数据的时候，只有一种情况是安全的，那就是对不可信数据进行JavaScript编码，并且只把这些数据放到使用引号包围起来的值部分（data value）之中，例如：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> message = “&lt;%= encodeJavaScript(@INPUT) %&gt;”;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>除此之外，往JavaScript代码里其他任何地方插入不可信数据都是相当危险的，攻击者可以很容易地插入攻击代码。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(‘…插入不可信数据前，进行JavaScript编码…’)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>值部分使用了单引号 </span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>x = “…插入不可信数据前，进行JavaScript编码…”<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">值部分使用了双引号</span><br><span class="line">&lt;div onmouseover=”x=’…插入不可信数据前，进行JavaScript编码…’ “&lt;/div&gt;</span><br><span class="line">值部分使用了引号，且事件处理属性的值部分也使用了引号</span><br><span class="line">特别需要注意的是，在XSS防御中，有些JavaScript函数是极度危险的，就算对不可信数据进行JavaScript编码，也依然会产生XSS漏洞，例如：</span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">window</span>.setInterval(‘…就算对不可信数据进行了JavaScript编码，这里依然会有XSS漏洞…’);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>[编码规则]</strong></p><p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 \xHH （以 \x 开头，HH则是指该字符对应的十六进制数字）</p><p>在对不可信数据做编码的时候，千万不能图方便使用反斜杠（ \ ）对特殊字符进行简单转义，比如将双引号 ” 转义成 \” ，这样做是不可靠的，因为浏览器在对页面做解析的时候，会先进行HTML解析，然后才是JavaScript解析，所以双引号很可能会被当做HTML字符进行HTML解析，这时双引号就可以突破代码的值部分，使得攻击者可以继续进行XSS攻击。</p><p>可以使用ESAPI提供的函数进行JavaScript编码：</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String encodedContent = ESAPI.encoder().encodeForJavaScript(request.getParameter(“input”));</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码"><a href="#原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码" class="headerlink" title="原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码"></a>原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码</h4><p>当需要往Stylesheet，Style标签或者Style属性里插入不可信数据的时候，需要对这些数据进行CSS编码。传统印象里CSS不过是负责页面样式的，但是实际上它比我们想象的要强大许多，而且还可以用来进行各种攻击。因此，不要对CSS里存放不可信数据掉以轻心，应该只允许把不可信数据放入到CSS属性的值部分，并进行适当的编码。除此以外，最好不要把不可信数据放到一些复杂属性里，比如url, behavior等，只能被IE认识的Expression属性允许执行JavaScript脚本，因此也不推荐把不可信数据放到这里。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-selector-tag">selector</span> { <span class="hljs-attribute">property </span>: …插入不可信数据前，进行CSS编码…} </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-selector-tag">selector</span> { <span class="hljs-attribute">property </span>: ” …插入不可信数据前，进行CSS编码… “} </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">”</span> <span class="hljs-attr">property</span> <span class="hljs-attr">:</span> …插入不可信数据前，进行<span class="hljs-attr">CSS</span>编码… ”&gt;</span> … <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>[编码规则]</strong></p><p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 \HH （以 \ 开头，HH则是指该字符对应的十六进制数字）</p><p>同原则2，原则3，在对不可信数据进行编码的时候，切忌投机取巧对双引号等特殊字符进行简单转义，攻击者可以想办法绕开这类限制。</p><p>可以使用ESAPI提供的函数进行CSS编码：</p><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String encodedContent = ESAPI.encoder().encodeForCSS(request.getParameter(“input”));</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="原则6：在将不可信数据插入到HTML-URL里时，对这些数据进行URL编码"><a href="#原则6：在将不可信数据插入到HTML-URL里时，对这些数据进行URL编码" class="headerlink" title="原则6：在将不可信数据插入到HTML URL里时，对这些数据进行URL编码"></a>原则6：在将不可信数据插入到HTML URL里时，对这些数据进行URL编码</h4><p>当需要往HTML页面中的URL里插入不可信数据的时候，需要对其进行URL编码，如下：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">”http://www.abcd.com?param</span>=<span class="hljs-string">…插入不可信数据前，进行URL编码…”</span>&gt;</span> Link Content <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>[编码规则]</strong></p><p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 %HH （以 % 开头，HH则是指该字符对应的十六进制数字）</p><p>在对URL进行编码的时候，有两点是需要特别注意的：</p><p>1) URL属性应该使用引号将值部分包围起来，否则攻击者可以很容易突破当前属性区域，插入后续攻击代码<br>2) 不要对整个URL进行编码，因为不可信数据可能会被插入到href, src或者其他以URL为基础的属性里，这时需要对数据的起始部分的协议字段进行验证，否则攻击者可以改变URL的协议，例如从HTTP协议改为DATA伪协议，或者javascript伪协议。</p><p>可以使用ESAPI提供的函数进行URL编码：</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String encodedContent = ESAPI.encoder().encodeForURL(request.getParameter(“input”));</span><br></pre></td></tr></tbody></table></figure><p></p><p>ESAPI还提供了一些用于检测不可信数据的函数，在这里我们可以使用其来检测不可信数据是否真的是一个URL：</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String userProvidedURL = request.getParameter(“userProvidedURL”);<span class="hljs-keyword">boolean</span> isValidURL = ESAPI.validator().isValidInput(“URLContext”, userProvidedURL, “URL”, <span class="hljs-number">255</span>, <span class="hljs-keyword">false</span>); </span><br><span class="line"><span class="hljs-keyword">if</span> (isValidURL) {</span><br><span class="line">&lt;a href=”&lt;%= encoder.encodeForHTMLAttribute(userProvidedURL) %&gt;”&gt;&lt;/a&gt;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="原则7：使用富文本时，使用XSS规则引擎进行编码过滤"><a href="#原则7：使用富文本时，使用XSS规则引擎进行编码过滤" class="headerlink" title="原则7：使用富文本时，使用XSS规则引擎进行编码过滤"></a>原则7：使用富文本时，使用XSS规则引擎进行编码过滤</h4><p>Web应用一般都会提供用户输入富文本信息的功能，比如BBS发帖，写博客文章等，用户提交的富文本信息里往往包含了HTML标签，甚至是JavaScript脚本，如果不对其进行适当的编码过滤的话，则会形成XSS漏洞。但我们又不能因为害怕产生XSS漏洞，所以就不允许用户输入富文本，这样对用户体验伤害很大。</p><p>针对富文本的特殊性，我们可以使用XSS规则引擎对用户输入进行编码过滤，只允许用户输入安全的HTML标签，如<code>&lt;b&gt;</code>,<code>&lt;i&gt;</code>,<code>&lt;p&gt;</code>等，对其他数据进行HTML编码。需要注意的是，经过规则引擎编码过滤后的内容只能放在<code>&lt;div&gt;</code>,<code>&lt;p&gt;</code>等安全的HTML标签里，不要放到HTML标签的属性值里，更不要放到HTML事件处理属性里，或者放到<code>&lt;SCRIPT&gt;</code>标签里。</p><p>推荐XSS规则过滤引擎：<strong>OWASP AntiSamp</strong>或者<strong>Java HTML Sanitizer</strong></p><h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><ul><li>当输出点出现在HTML标签属性：</li></ul><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt; <span class="hljs-attr">-</span>&gt;</span> <span class="hljs-symbol">&amp;lt;</span></span><br><span class="line">&gt; -&gt; <span class="hljs-symbol">&amp;gt;</span></span><br><span class="line">&amp; -&gt; <span class="hljs-symbol">&amp;amp;</span></span><br><span class="line">" -&gt; <span class="hljs-symbol">&amp;quot;</span></span><br><span class="line">' -&gt; &amp;#39</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>当输出点出现在<code>&lt;script&gt;</code>标签中。这种情况相当危险，不需要考虑xss触发，只需要考虑编写js即可</li></ul><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">' -&gt; <span class="hljs-symbol">\'</span>;</span><br><span class="line">" -&gt; <span class="hljs-symbol">\"</span>;</span><br><span class="line"><span class="hljs-symbol">\ </span>-&gt; <span class="hljs-symbol">\\</span>;</span><br><span class="line">/ -&gt; <span class="hljs-symbol">\/</span>;</span><br><span class="line">(换行符) -&gt; <span class="hljs-symbol">\n</span>;</span><br><span class="line">(回车符) -&gt; <span class="hljs-symbol">\r</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>当输出点出现在body中</li></ul><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt; <span class="hljs-attr">-</span>&gt;</span> <span class="hljs-symbol">&amp;lt;</span></span><br><span class="line">&gt; -&gt; <span class="hljs-symbol">&amp;gt;</span></span><br><span class="line">&amp; -&gt; <span class="hljs-symbol">&amp;amp;</span></span><br><span class="line">" -&gt; <span class="hljs-symbol">&amp;quot;</span></span><br><span class="line">' -&gt; &amp;#39</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>当输出点出现在js事件中(onClick=”你的代码”)</li></ul><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt; <span class="hljs-attr">-</span>&gt;</span> <span class="hljs-symbol">&amp;lt;</span></span><br><span class="line">&gt; -&gt; <span class="hljs-symbol">&amp;gt;</span></span><br><span class="line">&amp; -&gt; <span class="hljs-symbol">&amp;amp;</span></span><br><span class="line">" -&gt; <span class="hljs-symbol">&amp;quot;</span></span><br><span class="line">' -&gt; &amp;#39</span><br><span class="line">\ -&gt; \\;</span><br><span class="line">/ -&gt; \/;</span><br><span class="line">(换行符) -&gt; \n;</span><br><span class="line">(回车符) -&gt; \r;</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>输出在URL属性中<code>&lt;script src="你的代码"&gt;</code><ul><li>URL编码</li></ul></li></ul><h3 id="Escape"><a href="#Escape" class="headerlink" title="Escape"></a>Escape</h3><h4 id="htmlspecialchars-php"><a href="#htmlspecialchars-php" class="headerlink" title="htmlspecialchars - php"></a>htmlspecialchars - php</h4><blockquote><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htmlspecialchars ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(<span class="hljs-string">"default_charset"</span>) [, bool $double_encode = <span class="hljs-keyword">TRUE</span> ]]] ) : string</span><br></pre></td></tr></tbody></table></figure><p></p><p>将特殊字符转换为 HTML 实体</p><p><code>string</code> 待转换的 <a href="http://php.net/manual/zh/language.types.string.php" target="_blank" rel="noopener">string</a>。</p><p><code>flags</code> 位掩码，由以下某个或多个标记组成，设置转义处理细节、无效单元序列、文档类型。 默认是 <em>ENT_COMPAT | ENT_HTML401</em>。</p><p><code>double_encode</code> 关闭 <code>double_encode</code> 时，PHP 不会转换现有的 HTML 实体， 默认是全部转换。</p><p><code>encoding</code> An optional argument defining the encoding used when converting characters.</p></blockquote><table><thead><tr><th>字符</th><th>替换后</th></tr></thead><tbody><tr><td><em>&amp;</em> (&amp; 符号)</td><td><code>&amp;amp;</code></td></tr><tr><td><em>“</em> (双引号)</td><td><code>&amp;quot</code>，除非设置了 <strong>ENT_NOQUOTES</strong></td></tr><tr><td><em>‘</em> (单引号)</td><td>设置了 <strong>ENT_QUOTES</strong> 后， <code>&amp;#039;</code> (如果是 <strong>ENT_HTML401</strong>) ，或者 <code>&amp;apos;</code> (如果是 <strong>ENT_XML1</strong>、 <strong>ENT_XHTML</strong>或 <strong>ENT_HTML5</strong>)。</td></tr><tr><td>*&lt;* (小于)</td><td><code>&amp;lt;</code></td></tr><tr><td><em>&gt;</em> (大于)</td><td><code>&amp;gt;</code></td></tr></tbody></table><h4 id="htmlentities-php"><a href="#htmlentities-php" class="headerlink" title="htmlentities - php"></a>htmlentities - php</h4><blockquote><p>​ 本函数各方面都和 <a href="http://php.net/manual/zh/function.htmlspecialchars.php" target="_blank" rel="noopener">htmlspecialchars()</a> 一样， 除了 <strong>htmlentities()</strong> 会转换所有具有 HTML 实体的字符。</p></blockquote><h4 id="Front-end"><a href="#Front-end" class="headerlink" title="Front end"></a>Front end</h4><p>前端过滤</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xssCheck</span>(<span class="hljs-params">str,reg</span>)</span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> str ? str.replace(reg || <span class="hljs-regexp">/[&amp;&lt;"&gt;'](?:(amp|lt|quot|gt|#39|nbsp|#\d+);)?/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(b){</span><br><span class="line">      <span class="hljs-keyword">return</span> a;</span><br><span class="line">    }<span class="hljs-keyword">else</span>{</span><br><span class="line">      <span class="hljs-keyword">return</span> {</span><br><span class="line">        <span class="hljs-string">'&lt;'</span>:<span class="hljs-string">'&amp;lt;'</span>,</span><br><span class="line">        <span class="hljs-string">'&amp;'</span>:<span class="hljs-string">'&amp;amp;'</span>,</span><br><span class="line">        <span class="hljs-string">'"'</span>:<span class="hljs-string">'&amp;quot;'</span>,</span><br><span class="line">        <span class="hljs-string">'&gt;'</span>:<span class="hljs-string">'&amp;gt;'</span>,</span><br><span class="line">        <span class="hljs-string">"'"</span>:<span class="hljs-string">'&amp;#39;'</span>,</span><br><span class="line">      }[a]</span><br><span class="line">    }</span><br><span class="line">  }) : <span class="hljs-string">''</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="HTTP-Header"><a href="#HTTP-Header" class="headerlink" title="HTTP Header"></a>HTTP Header</h3><h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a>X-XSS-Protection</h4><p>可以通过 http 头控制是否打开 xss-filter，默认为开启。</p><p>通常情况下, 在http header中加入以下字段表示启用 xss-filter。除了 Firefox ，连 IE 8 以上均支持 X-XSS-Protection</p><p></p><figure class="highlight yaml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">X-XSS-Protection:</span> <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-attr">X-XSS-Protection:</span> <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-attr">X-XSS-Protection:</span> <span class="hljs-number">1</span><span class="hljs-string">;</span> <span class="hljs-string">mode=block</span></span><br><span class="line"><span class="hljs-attr">X-XSS-Protection:</span> <span class="hljs-number">1</span><span class="hljs-string">;</span> <span class="hljs-string">report=&lt;reporting-uri&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><ul><li><p>0</p><p>禁止XSS过滤。</p></li><li><p>1</p><p>启用XSS过滤（通常浏览器是默认的）。 如果检测到跨站脚本攻击，浏览器将清除页面（删除不安全的部分）。</p></li><li><p>1;mode=block</p><p>启用XSS过滤。 如果检测到攻击，浏览器将不会清除页面，而是阻止页面加载。</p></li><li><p>1; report=<reporting-uri> (Chromium only)</reporting-uri></p><p>启用XSS过滤。 如果检测到跨站脚本攻击，浏览器将清除页面并使用CSP <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/report-uri" target="_blank" rel="noopener"><code>report-uri</code></a>指令的功能发送违规报告。</p></li></ul><p>如上, 现代浏览器都对反射型 xss 有一定的防御力，其原理是检查 url 和 dom 中元素的相关性，但这并不能完全防止反射型 xss</p><p>另外, 浏览器对于存储型 xss 并没有抵抗力, 原因很简单, 用户的需求是多种多样的. 所以, 抵御xss这件事情不能指望浏览器。</p><h4 id="Content-Security-Policy"><a href="#Content-Security-Policy" class="headerlink" title="Content Security Policy"></a>Content Security Policy</h4><p>还有就是我们之前介绍的 CSP 策略了。</p><p>为了缓解很大一部分潜在的跨站脚本问题，浏览器的扩展程序系统引入了 CSP。CSP 管理网站允许加载的内容, 并且使用白名单的机制对网站加载或执行的资源起作用。在网页中, 这样的策略通过 HTTP 头信息或者 meta 元素定义。</p><p>CSP 并不是用来防止 xss 攻击的，而是最小化 xss 发生后所造成的伤害。实际上, 除了开发者自己做好 xss 转义, 并没有别的方法可以防止 xss 的发生. CSP 可以说是 HTML5 给web安全带来的最实惠的东西。那么如何引入 CSP 呢？</p><ol><li><p>通过响应头</p><p>只允许脚本从本源加载<code>Content-Security-Policy: script-src 'self'</code></p></li><li><p>通过 HTML 的 META 标签</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"script-src 'self'"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></li></ol><p>那么 CSP 除了限制 script-src 之外还能限制什么呢？</p><ul><li>base-uri : 限制这篇文档的uri</li><li>child-src ：限制子窗口的源(iframe,弹窗等),取代 frame-src</li><li>connect-src ：限制脚本可以访问的源</li><li>font-src : 限制字体的源</li><li>form-action : 限制表单能够提交到的源</li><li>frame-ancestors : 限制了当前页面可以被哪些页面以iframe,frame,object等方式加载</li><li>frame-src ：deprecated with child-src,限制了当前页面可以加载哪些源，与frame-ancestors对应</li><li>img-src : 限制图片可以从哪些源加载</li><li>media-src : 限制video, audio, source, track 能够从哪些源加载</li><li>object-src ：限制插件可以从哪些源加载</li><li>sandbox ：强制打开沙盒模式</li></ul><p>另外，CSP 还提供一个报告的头域 <code>Content-Security-Policy-Report-Only</code>，使用这个头域，浏览器会向服务器报告 csp 状态。</p><p></p><figure class="highlight csp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Content-Security-Policy-Report-Only</span>: <span class="hljs-keyword">script-src</span> <span class="hljs-string">'self'</span>; <span class="hljs-keyword">report-uri</span> http://cspReport/</span><br></pre></td></tr></tbody></table></figure><p></p><p>使用了上面的设置, 若页面上存在内联的 js，它依然会执行，不过浏览器会向发送一个 post 请求，包含如下信息：</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{ </span><br><span class="line">  <span class="hljs-attr">"csp-report"</span>:{</span><br><span class="line">      <span class="hljs-attr">"document-uri"</span>: <span class="hljs-string">"http://cspReport/test.php"</span>,</span><br><span class="line">      <span class="hljs-attr">"referrer"</span>: <span class="hljs-string">""</span>,</span><br><span class="line">      <span class="hljs-attr">"violated-directive"</span>: <span class="hljs-string">"script-src 'self'"</span>,</span><br><span class="line">      <span class="hljs-attr">"original-policy"</span>: <span class="hljs-string">"script-src 'self'; report-uri http://cspReport/"</span>,</span><br><span class="line">      <span class="hljs-attr">"blocked-uri"</span>: <span class="hljs-string">""</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>CSP 目前有两版, [CSP1][] 和 [CSP2][]. 两版的支持状态可以在 <a href="http://caniuse.com/#search=csp" target="_blank" rel="noopener">http://caniuse.com/#search=csp</a> 中查到. 如下:</p><p>CSP 1.0:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007189.jpg" alt=""></p><p>CSP 2.0:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610001204.jpg" alt=""></p><h4 id="X-Frame-Options"><a href="#X-Frame-Options" class="headerlink" title="X-Frame-Options"></a>X-Frame-Options</h4><blockquote><p>​ X-Frame-Options 有三个值:</p><ul><li><p><code>DENY</code></p><p>表示该页面不允许在 frame 中展示，即便是在相同域名的页面中嵌套也不允许。</p></li><li><p><code>SAMEORIGIN</code></p><p>表示该页面可以在相同域名页面的 frame 中展示。</p></li><li><p><code>ALLOW-FROM *uri*</code></p><p>表示该页面可以在指定来源的 frame 中展示。</p></li></ul></blockquote><p>X-Frame-Options 响应头是用来给浏览器指示允许一个页面可否在 <code>frame</code>, <code>iframe</code> 或者 <code>object</code> 等标签中展现的标记. 网站可以使用此功能, 来确保自己网站的内容没有被嵌到别人的网站中去, 也从而避免了点击劫持 (clickjacking) 的攻击. 但以后可能被CSP的 frame-ancestors取代。目前支持的状态比起 CSP frame-ancestors要好。</p><h4 id="HttpOnly"><a href="#HttpOnly" class="headerlink" title="HttpOnly"></a>HttpOnly</h4><p>当 Cookie 在消息头中被设置为 HttpOnly 时，这样支持 Cookie 的浏览器将阻止客户端 Javascript 直接访问浏览器中的 cookies ，从而达到保护敏感数据的作用。</p><h4 id="X-Content-Type-Options"><a href="#X-Content-Type-Options" class="headerlink" title="X-Content-Type-Options"></a>X-Content-Type-Options</h4><blockquote><p>​ X-Content-Type-Options: nosniff</p><p>nosniff</p><p>​ 假如请求类型为以下两种，那么阻止请求的发生：</p><ul><li>“<code>style</code>“ 但是 MIME 类型不是 “<code>text/css</code>“，</li><li>“<code>script</code>“ 但是 MIME 类型不是 <a href="https://html.spec.whatwg.org/multipage/scripting.html#javascript-mime-type" target="_blank" rel="noopener">JavaScript MIME 类型</a>。</li></ul></blockquote><p>X-Content-Type-Options 响应首部相当于一个提示标志，被服务器用来提示客户端一定要遵循在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type" target="_blank" rel="noopener"><code>Content-Type</code></a> 首部中对 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="_blank" rel="noopener">MIME 类型</a> 的设定，而不能对其进行修改。这就禁用了客户端的 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types#MIME_sniffing" target="_blank" rel="noopener">MIME 类型嗅探</a>行为，换句话说，也就是意味着网站管理员确定自己的设置没有问题。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.freebuf.com/articles/web/9977.html" target="_blank" rel="noopener">防御XSS的七条原则</a></p><p><a href="http://louiszhai.github.io/2016/03/05/xss/" target="_blank" rel="noopener">xss攻防浅谈</a></p><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html></div><div class="columns is-variable is-1 is-multiline is-mobile"> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Sec/">#Sec</a></span> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/xss/">#xss</a></span></div><hr><blockquote class="colorquote info"><p>Article Author: Zeddy</p><p>Article Link: https://blog.zeddyu.info/2019/03/14/Web%E5%AE%89%E5%85%A8%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B-XSS-IV/index.html</p><p>Copyright Notice: With the exception of the special statement at the beginning of the article, all articles can be reprinted in accordance with the CC BY 4.0 agreement with the author&#39;s permission.</p></blockquote><blockquote class="colorquote success"><p>Ad: I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: https://blog.zeddyu.info/advertisement/</p><p>Ad: 想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a href="https://blog.zeddyu.info/advertisement/#知识星球" target="_blank" rel="noopener">知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a href="https://blog.zeddyu.info/advertisement/#International-CTF-Team" target="_blank" rel="noopener">International CTF Team</a> 查看详情</p></blockquote><div class="columns is-mobile is-multiline article-nav"> <span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/2019/03/14/%E9%9D%A2%E8%AF%95%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">面试经验分享</a></span> <span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/2019/03/14/Web%E5%AE%89%E5%85%A8%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B-XSS-III/">Web安全从零开始 XSS III</a></span></div></article><div class="comments"><h3 class="title is-4">Comments</h3><script>function loadDisqus(){var e=document,n=e.createElement("script");n.src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js",l=e.createElement("link"),l.href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css",l.setAttribute("rel","stylesheet"),(e.head||e.body).appendChild(n),e.head.appendChild(l),n.onload=function(){new DisqusJS({shortname:"zeddyu",siteName:"blog.zeddyu.info",identifier:document.location.origin+document.location.pathname+document.location.search,url:document.location.origin+document.location.pathname+document.location.search,title:document.title,api:"https://blog.zeddyu.info/api/",apikey:"57m1j10pU1WfesAhs8Ri3OcmPEaRmoyIuNCPcYaUu6mqWu6Ek4qvRiQf9CXl2JoH",admin:"ZeddYu",adminLabel:""})}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);setTimeout(function(){isBot||loadDisqus()},1)</script><div id="disqus_thread"></div></div></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered"> &copy; 2021 Zedd&nbsp; Powered by <a href="http://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a></div><div class="column is-hidden-mobile"></div><div class="column is-narrow"><div class="columns is-mobile is-multiline is-centered"> <a class="column is-narrow has-text-black" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener">GitHub</a> <a class="column is-narrow has-text-black" title="RSS" href="https://blog.zeddyu.info/atom.xml">RSS</a> <a class="column is-narrow has-text-black" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener">Twitter</a></div></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script><script>moment.locale("en-AU")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><style>.hljs{position:relative}.hljs .clipboard-btn{float:right;color:#9a9a9a;background:0 0;border:none;cursor:pointer}.hljs .clipboard-btn:hover{color:#8a8a8a}.hljs>.clipboard-btn{display:none;position:absolute;right:4px;top:4px}.hljs:hover>.clipboard-btn{display:inline}.hljs>figcaption>.clipboard-btn{margin-right:4px}</style><script>$(document).ready(function(){$("figure.hljs").each(function(t,e){var a="code-"+t,r=e.querySelector(".code"),c=$('<button>Copy <i class="far fa-clipboard"></i></button>');r.id=a,c.addClass("clipboard-btn"),c.attr("data-clipboard-target-id",a);var n=e.querySelector("figcaption");n?n.append(c[0]):e.prepend(c[0])}),new ClipboardJS(".clipboard-btn",{target:function(t){return document.getElementById(t.getAttribute("data-clipboard-target-id"))}}).on("success",function(t){t.clearSelection()})})</script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/script.js"></script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/insight.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1740444562387978" crossorigin="anonymous"></script><div class="searchbox ins-search"><div class="searchbox-mask"></div><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"> <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},CONTENT_URL:"/content.json"}</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>